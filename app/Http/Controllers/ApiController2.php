<?php

namespace App\Http\Controllers;

use DB;
use Auth;
use Hash;
use Async;
use Session;
use Exception;
use Carbon\Carbon;
use App\Models\OTP;
use App\Models\link;
use App\Models\User;
use GuzzleHttp\Psr7;
use App\Models\crifdb;
use App\Models\Rcfull;
use GuzzleHttp\Client;
use App\Models\business;
use App\Models\consumer;
use App\Models\ApiMaster;
use App\Models\bankdetails;
use App\Models\businesskyc;
use App\Models\Transaction;
use App\Models\businesstype;
use App\Models\documentname;
use App\Models\rulesdefined;
use App\Models\SchemeMaster;
use Illuminate\Http\Request;
use App\Models\HitCountMaster;
use App\Models\termscondition;
use App\Models\agreementpolicy;
use App\Models\congratulations;
use App\Models\requireddetails;
use Barryvdh\DomPDF\Facade\Pdf;
use App\Models\UserSchemeMaster;
use App\Models\{Post, RegtechBlog};
use Illuminate\Support\Facades\Response;
use GuzzleHttp\Exception\ClientException;
use Illuminate\Support\Facades\Validator;
use GuzzleHttp\Exception\RequestException;
use GuzzleHttp\Exception\BadResponseException;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;
use Aws\Ses\SesClient;
use Aws\Exception\AwsException;


class ApiController2 extends Controller
{

    private $sandbox_url = 'https://sandbox.flowboard.in/api/v1';
    // private $sandbox_token = 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTYyNTczNDU2MCwianRpIjoiMDE2OWRmYTctNWY3Yi00OTZhLWI3Y2MtMjZhNmExNDZiMjdlIiwidHlwZSI6ImFjY2VzcyIsImlkZW50aXR5IjoiZGV2LmRvY2JveXpAYWFkaGFhcmFwaS5pbyIsIm5iZiI6MTYyNTczNDU2MCwiZXhwIjoxOTQxMDk0NTYwLCJ1c2VyX2NsYWltcyI6eyJzY29wZXMiOlsicmVhZCJdfX0.XCjAFtZlAqWySAGf-2-TP6ICs-6z9Xpoi33l8UqUywg';
    private $sandbox_token = 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTYyNTczNDU2MCwianRpIjoiMDE2OWRmYTctNWY3Yi00OTZhLWI3Y2MtMjZhNmExNDZiMjdlIiwidHlwZSI6ImFjY2VzcyIsImlkZW50aXR5IjoiZGV2LmRvY2JveXpAYWFkaGFhcmFwaS5pbyIsIm5iZiI6MTYyNTczNDU2MCwiZXhwIjoxOTQxMDk0NTYwLCJ1c2VyX2NsYWltcyI6eyJzY29wZXMiOlsicmVhZCJdfX0.XCjAFtZlAqWySAGf-2-TP6ICs-6z9Xpoi33l8UqUywg';
    private $base_url = 'https://kyc-api.flowboard.in/api/v1';
    private $base_urln = 'https://api.signzy.app/api/v3';
    // private $signzytoken = 'quaX7XBUjg4S8ITGJeWrhbQ86YakeNOr';
    private $signzytoken = 'nSMWQHptp8JAaROQjhtUKPnrP3mviY6R';
    private $token = 'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';

    //Equifax
    // private $equifax_url = "https://eportuat.equifax.co.in/cir360Report/cir360Report";
    // private $equifax_url = "https://ists.equifax.co.in/cir360service/cir360report";
    private $equifax_url = "https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score";
    // private $equifax_url = "https://bo6dqokjja.execute-api.ap-south-1.amazonaws.com/equifax/score";

    // private $equifax_token = "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE2NjAxMTEyMTN9.d6TecpM6LWgp91bjAjYQvUCdtjSxTX4RDEnY_Qc3lgc";
    //Crif
    private $crif_url = "https://loantap.in/affiliate/apiv1-1/docboyz/crif";

    private $smartship_url = 'http://api.smartship.in'; //'http://oauth.smartship.in';

    private $api_club = 'https://api.apiclub.in/api';
    private $api_clubli = 'https://api.apiclub.in/uat/v1';

    private $api_club_key = '2487be27f4d20bc1d366cb38f098eba7';

    private $secretKey = 'pI76u95BabjkIFg6DNNRole7gZn71ljPk7W5WIHzApjlObIMywuq8pZGa30HXm5wR';

    private $equifaxsecretKey = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJEb2NCb3l6IiwiaWF0IjoxNjkzMzEyNTg2OTc4fQ.mMgl0deNRbkCXT0LnE8t7hRbTkwoK9TbnCrAS-TtjR4';

    private $clientId = 'ef41c6d7089614d1838c68efc81a8493:dc983c1bfbc4390f4952bd44ed0ae690';

    private $ckyctoken = 'gG9WM8pp2TDZ7DvnNNpqSnNXY7tSntiW';

    private $site_url = 'http://regtechapi.in';

    private $nsdlToken = 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJEb2NCb3l6IiwibmFtZSI6IkFTSE9LIEtVTUFSIiwiaWF0IjoxNjY2MjM5MDIyfQ.ZuHUPDZhHtnkDHUrKwuwOuUYBqj4Kp0SRnJqiFWHVfs';

    // Get Access Token
    public function getAccessToken(Request $request)
    {
        $statusCode = null;
        $access_token = null;

        if (empty($request->email))
            return response()->json(array(['message' => 'Email id is required', 'statusCode' => '404']));

        if (empty($request->password))
            return response()->json(array(['message' => 'Password is required', 'statusCode' => '404']));

        $email = $request->email;
        $password = $request->password;

        $user = User::where('email', $request->email)->first();
        if (!$user)
            return response()->json(array(['message' => 'Email ID not associated with us', 'statusCode' => '403']));

        if (!Hash::check($password, $user->password)) {
            return response()->json(array(['message' => 'Wrong Credentials', 'statusCode' => '401']));
        }


        return response()->json(array(['access_token' => $user->access_token, 'statusCode' => '200']));
    }

    // Verify Access Token
 public function verifyAccessToken($access_token)
{
    $user = User::where('access_token', $access_token)->count();
    return $user > 0;
}


    // Save To hit_count_master table
    public function saveHitCount($user_id, $api_id, $remark, $statusCode)
    {
        $cnt200 = 0;
        $cnt400 = 0;
        $cnt101 = 0;
        $payableHits = 0;
        $scheme_price = 0;
        $total_amount = 0;
        $updateHitCount = UserSchemeMaster::where('user_id', $user_id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        $payment_slab = explode(',', $updateHitCount->payment_slab);
        $scheme_prices = explode(',', $updateHitCount->scheme_price);
        // $transactions = Transaction::where('user_id', $user_id)->where('api_id',$api_id)->where('hit_year_month', date('Y-m'))->get();
        $transactions = Transaction::where('user_id', $user_id)->where('api_id', $api_id)->where('hit_year_month', date('Y-m'))->count();
        if ($transactions) {
            // for($i=0; $i<count($transactions);$i++){
            //     if($transactions[$i]['status_code'] == 102){
            //         $cnt400++;
            //     }else if($transactions[$i]['status_code'] == 200){
            //         $cnt200++;
            //     }else if($transactions[$i]['status_code'] == 101){
            //         $cnt101++;
            //     }
            // }
            // $payableHits = $cnt200 + $cnt400 + $cnt101; 
            $payableHits = $transactions;

            for ($i = 0; $i < count($payment_slab); $i++) {
                if ($i == (count($payment_slab) - 1)) {
                    if ($payableHits <= $payment_slab[$i]) {
                        $scheme_price = $scheme_prices[$i];
                        $total_amount = $payableHits * $scheme_prices[$i];
                    } else {
                        $scheme_price = $scheme_prices[$i];
                        $total_amount = $payableHits * $scheme_prices[$i];
                    }
                    break;
                } else {
                    if ($payableHits <= $payment_slab[$i]) {
                        $scheme_price = $scheme_prices[$i];
                        $total_amount = $payableHits * $scheme_prices[$i];
                        break;
                    }
                }
            }
        } else {
            $scheme_price = $scheme_prices[0];
            $total_amount = $scheme_prices[0];
        }

        $updateHitCount->update([
            'total_transaction_amount_per_api' => $total_amount
        ]);

        $addHitCount = new HitCountMaster;
        $addHitCount->user_id = $user_id;
        $addHitCount->api_id = $api_id;
        $addHitCount->scheme_price = $scheme_price;
        $addHitCount->hit_year_month = date('Y-m');
        $addHitCount->hit_count = 1;
        $addHitCount->save();
        $this->update_wallet_balance($user_id, $scheme_price);
        $this->update_transaction($user_id, $api_id, $scheme_price, $remark, $statusCode);
    }
    public function update_wallet_balance($user_id, $amount)
    {
        $userwallet = User::where('id', $user_id)->first();
        $subusercount = User::where('subparent_id', $user_id)->Where('subparent_id','!=', 1)->count();

        if($userwallet->subparent_id !=1 || $subusercount > 0){

            if($subusercount > 0){
            // return '$finalamountsss';
                $finalamount = $userwallet->wallet_amount - $amount;
                $userwallet->wallet_amount = $finalamount;
                $userwallet->save();
                $updatewalletbalance = User::where('subparent_id', $user_id)->update(['wallet_amount' =>$finalamount]);

            }
            else{
                // return 
                $finalamount = $userwallet->wallet_amount - $amount;
                $subparent = $userwallet->subparent_id;
              
                // $userwallet->wallet_amount = $finalamount;
                // $userwallet->save();

                $updatewalletbalance = User::where('subparent_id', $subparent)->update(['wallet_amount' =>$finalamount]);
                $updatewalletbalanceparent = User::where('id', $subparent)->update(['wallet_amount' =>$finalamount]);
                

            }
           


        }
        else{

            $userwallet->wallet_amount = $userwallet->wallet_amount - $amount;
            $userwallet->save();

        }
        
    }

    public function transaction_id()
    {
        $str_result = '1234567890';
        $transaction_gen = substr(str_shuffle($str_result), 0, 12);

        $transaction = Transaction::where('transaction_id', $transaction_gen)->first();
        if ($transaction) {
            $transaction_gen = substr(str_shuffle($str_result), 0, 12);
        }

        return $transaction_gen;
    }

    public function update_transaction($user_id, $api_id, $amount, $remark, $statusCode)
    {
        $user = User::where('id', $user_id)->first();
        $transaction = new Transaction;
        $transaction->transaction_id = $this->transaction_id();
        $transaction->user_id = $user_id;
        $transaction->api_id = $api_id; //work
        $transaction->type_creditdebit = 'Debit';
        $transaction->hit_year_month = date('Y-m');
        $transaction->scheme_price = $amount;  //work
        if ($statusCode == 200) {
            $transaction->status = 'Success';
        } else {
            $transaction->status = 'Failed';
        }
        $transaction->status_code = $statusCode;
        $transaction->amount = $amount;
        $transaction->remark = $remark;
        if ($statusCode != 500) {


            $transaction->updated_balance = $user->wallet_amount - $amount;
        } else {
            $transaction->updated_balance = $user->wallet_amount;
        }
        $transaction->save();
    }

    // Pancard verification
    // public function pancard(Request $request) {
    //     //dd('$request->pan_number');
    //     $statusCode = null;
    //     $pancard = null;
    //     $api_id = null;
    //     if(empty($request->pan_number))
    //         return response()->json(array(['message'=>'Pancard number is required','statusCode'=>'404']));

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     if($user->role_id==1) {
    //         $apiamster = ApiMaster::where('api_slug','pancard')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //     }

    //     $client = new Client();
    //     $headers = [
    //         // 'Authorization' => $this->token,        
    //         'API-KEY' => $this->api_club_key,   
    //         'Referer' => $this->site_url
    //     ];

    //     $body =  [
    //         'pan_no' => $request->pan_number
    //     ];

    //     $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //     if($updateHitCount || $user->role_id==0){
    //         try{
    //             // $res = $client->post($this->base_url.'/pan/pan', ['headers' => $headers, 'json' => $body]);
    //             $res = $client->post($this->api_club.'/verify_pan', ['headers' => $headers, 'json' => $body]);
    //             $pancard = json_decode($res->getBody(), true);
    //             if($user->role_id==1) {
    //                 if($apiamster) {
    //                     $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                 }
    //                 $panvalidation = DB::table('pancard_varification')->insert([
    //                     "user_id"=> $user->id,
    //                     "api_id"=> $api_id,
    //                     "pancard_id"=> $pancard['response']['pan_no'],
    //                     "name"=> $pancard['response']['registered_name'],
    //                     "created_at"=> Carbon::now(),
    //                     "updated_at"=> Carbon::now()
    //                 ]);
    //             }
    //         } catch(BadResponseException $e) {
    //             $statusCode = $e->getResponse()->getStatusCode();
    //             if($statusCode == 500){
    //                 $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                 }
    //             }else if($statusCode == 404){
    //                 $statusCode = 102;
    //                 $errorMessage = 'Verification Failed. Please enter correct PAN Number.';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }else{
    //                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }

    //             $panvalidation = DB::table('pancard_varification')->insert([
    //                 "user_id"=> $user->id,
    //                 "api_id"=> $api_id,
    //                 // "client_id"=> $aadhaar_validation['response']['client_id'],
    //                 "pancard_id"=> $request->pan_number,
    //                 "created_at"=> Carbon::now(),
    //                 "updated_at"=> Carbon::now()
    //             ]);
    //             return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //         }
    //     }else{
    //         return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //     }

    //     return response()->json(array(['pancard'=>$pancard,'statusCode'=>'200']));
    // }
    public function blogapi()
    {
        $date = RegtechBlog::max('created_at');
        $blogDetails = RegtechBlog::where('created_at', $date)->first();

        return response()->json(array(['data' => $blogDetails, 'statusCode' => '200']));

    }

    public function getblog(Request $request)
    {
        $id = $request->id;
        $getblog = RegtechBlog::where('id', $id)->get();

        if (count($getblog) > 0) {
            return response()->json(array(['data' => $getblog], 'statusCode' => '200'));
        } else {
            return response()->json(array(['Message' => 'Please enter the currect id', 'statusCode' => '500']));
        }

    }

    public function ckycSearchlitetest(Request $request){
        
        // return $accesstoken;
        
            $statusCode = null;
            $pancard = null;
            $api_id = null;
            if (empty($request->pano)) {
                return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
            }

            if (empty($request->dob)) {
                return response()->json([['message' => 'Date of birth is required', 'statusCode' => '404']]);
            }

            $validator = Validator::make($request->all(), [
                'dob' => ['required', 'date_format:Y-m-d'],
            ]);

            if ($validator->fails()) {
                return response()->json(['error' => $validator->errors(), 'statusCode' => '404']);
            }

            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }

            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'searchkyc')->first();
                // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            
            $panno = $request->pano;
            $dob = $request->dob;
            $groupId = rand(100, 10000000000);
            $checkId = rand(100, 10000000000);
            $client = new Client();
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == 'role_postpaid') {
                    try{
                        $dobFormatted = Carbon::createFromFormat('Y-m-d', $dob)->format('d-m-Y');
                        // Prepare the headers
                        $headers = [
                            'app-id' => '4fba$e#941b&*4d34&*87cf&39doc',
                            'api-key' => 'c944b%#9*9ff&da826b8e0dcbb1boy',
                        ];
        
                        // Prepare the form data (parameters as form data)
                        $body = [
                            'pan' => $request->pano,
                            'dob' => $dobFormatted,
                        ];
        
                        // Create the client instance
                        $client = new Client();
        
                        // Send the POST request using form params
                        $res = $client->post('https://www.timbleglance.com/api/CKYC/', [
                            'headers' => $headers,
                            'form_params' => $body,  // This sends form data instead of JSON
                        ]);
        
                        $allpandata = json_decode($res->getBody(), true);
                        // return $allpandata;
                        // Return or handle the response data as needed

                        $data = [
                            'document_type' => 'PAN',
                            'id_number' => $panno,
                            'consent' => true,
                            'consent_purpose' => 'this is the consent_purpose can be passed any string value',
                        ];
                        $searchkyc = [];
                        if (isset($allpandata['response_message']) && $allpandata['response_message'] == "Success" && $allpandata['success'] == true && isset($allpandata['response_code']) && $allpandata['response_code'] == "101") {
                            $searchkyc['kycStatus'] = 'SUCCESS';
                            $searchkyc['message'] = 'Details downloaded successfully';
                            $searchkyc['success'] = true;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan'] = isset($allpandata['result']['USER_PAN_NUMBER']) ? $allpandata['result']['USER_PAN_NUMBER'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maskedAadhaar'] = isset($allpandata['result']['MASKED_AADHAAR_NUMBER']) ? $allpandata['result']['MASKED_AADHAAR_NUMBER'] != 'N/A' && $allpandata['result']['MASKED_AADHAAR_NUMBER'] != [] ? $allpandata['result']['MASKED_AADHAAR_NUMBER'] : null : null;
                            // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastFourDigit'] = isset($allpandata['result']['MASKED_AADHAAR_NUMBER']) ? $allpandata['result']['MASKED_AADHAAR_NUMBER'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastFourDigit'] = null;

if ((isset($allpandata['result']['MASKED_AADHAAR_NUMBER']) && $allpandata['result']['MASKED_AADHAAR_NUMBER'] !== 'N/A') || $allpandata['result']['MASKED_AADHAAR_NUMBER'] == []) {
    // Extract the last 4 digits of the Aadhar number (masked or not)
    $aadhaarNumber = $allpandata['result']['MASKED_AADHAAR_NUMBER'];
    
    // Get the last 4 digits of the Aadhar number
    $lastFourDigits = isset($aadhaarNumber) ? substr($aadhaarNumber, -4) : null;
    
    // Set the last four digits
    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastFourDigit'] = $lastFourDigits;
}

                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['typeOfHolder'] = isset($allpandata['result']['CONSTITUTION_TYPE']) ? $allpandata['result']['CONSTITUTION_TYPE'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = isset($allpandata['result']['USER_FULL_NAME']) ? $allpandata['result']['USER_FULL_NAME'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = isset($allpandata['result']['USER_FIRST_NAME']) ? $allpandata['result']['USER_FIRST_NAME'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = isset($allpandata['result']['USER_LAST_NAME']) ? $allpandata['result']['USER_LAST_NAME'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = isset($allpandata['result']['USER_MOBILE_NUMBER']) ? $allpandata['result']['USER_MOBILE_NUMBER'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = isset($allpandata['result']['USER_EMAIL_ADDRESS']) ? $allpandata['result']['USER_EMAIL_ADDRESS'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = isset($allpandata['result']['USER_DOB']) ? $allpandata['result']['USER_DOB'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender'] = isset($allpandata['result']['USER_GENDER']) ? $allpandata['result']['USER_GENDER'] : null;
                            // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['address'] = isset($allpandata['response']['address']) ? $allpandata['response']['address'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['address'] = trim(
                                (isset($allpandata['result']['ADDRESS_PERMANENT_LINE1']) && $allpandata['result']['ADDRESS_PERMANENT_LINE1'] != 'N/A' ? $allpandata['result']['ADDRESS_PERMANENT_LINE1'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_LINE2']) && $allpandata['result']['ADDRESS_PERMANENT_LINE2'] != 'N/A' ? $allpandata['result']['ADDRESS_PERMANENT_LINE2'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_LINE3']) && $allpandata['result']['ADDRESS_PERMANENT_LINE3'] != 'N/A' ? $allpandata['result']['ADDRESS_PERMANENT_LINE3'] . ' ' : '') .
                                // (isset($allpandata['result']['ADDRESS_PERMANENT_CITY']) && $allpandata['result']['ADDRESS_PERMANENT_CITY'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_CITY'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_DISTRICT']) && $allpandata['result']['ADDRESS_PERMANENT_DISTRICT'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_DISTRICT'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_STATE']) && $allpandata['result']['ADDRESS_PERMANENT_STATE'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_STATE'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_PIN']) && $allpandata['result']['ADDRESS_PERMANENT_PIN'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_PIN'] : '')
                            );
                            

                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['city'] = isset($allpandata['result']['ADDRESS_PERMANENT_CITY']) ? $allpandata['result']['ADDRESS_PERMANENT_CITY'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['state'] = isset($allpandata['result']['ADDRESS_PERMANENT_STATE']) ? $allpandata['result']['ADDRESS_PERMANENT_STATE'] == "MH" ? "Maharashtra" : $allpandata['result']['ADDRESS_PERMANENT_STATE'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['country'] = isset($allpandata['result']['ADDRESS_PERMANENT_COUNTRY']) ? $allpandata['result']['ADDRESS_PERMANENT_COUNTRY'] : null;
                            $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pincode'] = isset($allpandata['result']['ADDRESS_PERMANENT_PIN']) ? $allpandata['result']['ADDRESS_PERMANENT_PIN'] : null;
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }


                                $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'vender_status_code' => isset($allpandata['response_code']) ? $allpandata['response_code'] : null,
                                    'vender_code' => isset($allpandata['response_code']) ? $allpandata['response_code'] : null,
                                    'status' => 200,
                                    'pan_no' => $allpandata['result']['USER_PAN_NUMBER'],
                                    'ckycid' => null,
                                    'firstname' => isset($allpandata['result']['USER_FIRST_NAME']) ? $allpandata['result']['USER_FIRST_NAME'] : null,
                                    'fullname' => isset($allpandata['result']['USER_FULL_NAME']) ? $allpandata['result']['USER_FULL_NAME'] : null,
                                    'mobilenum' => isset($allpandata['result']['USER_MOBILE_NUMBER']) ? $allpandata['result']['USER_MOBILE_NUMBER'] : null,
                                    'email' => isset($allpandata['result']['USER_EMAIL_ADDRESS']) ? $allpandata['result']['USER_EMAIL_ADDRESS'] : null,
                                    'dob' => isset($allpandata['result']['USER_DOB']) ? $allpandata['result']['USER_DOB'] : null,
                                    'paddress' => trim(
                                (isset($allpandata['result']['ADDRESS_PERMANENT_LINE1']) && $allpandata['result']['ADDRESS_PERMANENT_LINE1'] != 'N/A' ? $allpandata['result']['ADDRESS_PERMANENT_LINE1'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_LINE2']) && $allpandata['result']['ADDRESS_PERMANENT_LINE2'] != 'N/A' ? $allpandata['result']['ADDRESS_PERMANENT_LINE2'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_LINE3']) && $allpandata['result']['ADDRESS_PERMANENT_LINE3'] != 'N/A' ? $allpandata['result']['ADDRESS_PERMANENT_LINE3'] . ' ' : '') .
                                // (isset($allpandata['result']['ADDRESS_PERMANENT_CITY']) && $allpandata['result']['ADDRESS_PERMANENT_CITY'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_CITY'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_DISTRICT']) && $allpandata['result']['ADDRESS_PERMANENT_DISTRICT'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_DISTRICT'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_STATE']) && $allpandata['result']['ADDRESS_PERMANENT_STATE'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_STATE'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_PERMANENT_PIN']) && $allpandata['result']['ADDRESS_PERMANENT_PIN'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_PIN'] : '')
                            ),
                                    'pstate' => isset($allpandata['result']['ADDRESS_PERMANENT_STATE']) ? $allpandata['result']['ADDRESS_PERMANENT_STATE'] : null,
                                    'pcity' => isset($allpandata['result']['ADDRESS_PERMANENT_CITY']) ? $allpandata['result']['ADDRESS_PERMANENT_CITY'] : null,
                                    'caddress' => trim(
                                (isset($allpandata['result']['ADDRESS_CORRESPONDING_LINE_1']) && $allpandata['result']['ADDRESS_CORRESPONDING_LINE_1'] != 'N/A' ? $allpandata['result']['ADDRESS_CORRESPONDING_LINE_1'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_CORRESPONDING_LINE_2']) && $allpandata['result']['ADDRESS_CORRESPONDING_LINE_2'] != 'N/A' ? $allpandata['result']['ADDRESS_CORRESPONDING_LINE_2'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_CORRESPONDING_LINE_3']) && $allpandata['result']['ADDRESS_CORRESPONDING_LINE_3'] != 'N/A' ? $allpandata['result']['ADDRESS_CORRESPONDING_LINE_3'] . ' ' : '') .
                                // (isset($allpandata['result']['ADDRESS_PERMANENT_CITY']) && $allpandata['result']['ADDRESS_PERMANENT_CITY'] != '' ? $allpandata['result']['ADDRESS_PERMANENT_CITY'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_CORRESPONDING_DISTRICT']) && $allpandata['result']['ADDRESS_CORRESPONDING_DISTRICT'] != '' ? $allpandata['result']['ADDRESS_CORRESPONDING_DISTRICT'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_CORRESPONDING_STATE']) && $allpandata['result']['ADDRESS_CORRESPONDING_STATE'] != '' ? $allpandata['result']['ADDRESS_CORRESPONDING_STATE'] . ' ' : '') .
                                (isset($allpandata['result']['ADDRESS_CORRESPONDING_PIN']) && $allpandata['result']['ADDRESS_CORRESPONDING_PIN'] != '' ? $allpandata['result']['ADDRESS_CORRESPONDING_PIN'] : '')
                            ),
                                    'cstate' => isset($allpandata['result']['ADDRESS_CORRESPONDING_STATE']) ? $allpandata['result']['ADDRESS_CORRESPONDING_STATE'] : null,
                                    'ccity' => isset($allpandata['result']['ADDRESS_CORRESPONDING_CITY']) ? $allpandata['result']['ADDRESS_CORRESPONDING_CITY'] : null,
                                    'currentpincode' => isset($allpandata['result']['ADDRESS_CORRESPONDING_PIN']) ? $allpandata['result']['ADDRESS_CORRESPONDING_PIN'] : null,
                                    'permanantpincode' => isset($allpandata['result']['ADDRESS_PERMANENT_CITY']) ? $allpandata['result']['ADDRESS_PERMANENT_CITY'] : null,
                                    // "pancard_id"=> $pancard['response']['pan_no'],
                                    // "name"=> $pancard['response']['registered_name'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                            return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                        } elseif (isset($allpandata['response_code'])  && $allpandata['response_code'] == 103 && $allpandata['success'] == true) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
                                }
                                $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'dob' => $dob,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'vender_status_code' => isset($allpandata['response_code']) ? $allpandata['response_code'] : null,
                                    'vender_code' => isset($allpandata['response_code']) ? $allpandata['response_code'] : null,
                                    'status' => 102,
                                    'pan_no' => $request->pano,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                                
                            }
                            return response()->json(['statusCode' => 102, 'response' => 'cKyc record not found']);

                        }
                    }catch(Exception $e){
                        $statusCode = $e->getResponse()->getStatusCode();
                        $response = $e->getResponse();

                        // If there is a response, extract 'response_code' and 'success'
                        if ($response) {
                            $responseData = json_decode($response->getBody()->getContents(), true);
                        }

                        if ((isset($responseData['response_code']) && $responseData['response_code'] == 103 && $responseData['success'] == true) || isset($statusCode) && $statusCode == 503) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
                                }

                                $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'vender_status_code' => isset($statusCode) ? $statusCode : null,
                                    'vender_code' => isset($statusCode) ? $statusCode : null,
                                    'status' => 102,
                                    'pan_no' => $request->pano,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                            return response()->json(['statusCode' => 102, 'response' => 'cKyc record not found']);
                        } elseif ((isset($responseData['response_code']) && $responseData['response_code'] == 102) || isset($statusCode) && $statusCode == 400) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 102);
                                }
                                $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'dob' => $dob,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'vender_status_code' => isset($statusCode) ? $statusCode : null,
                                    'vender_code' => isset($statusCode) ? $statusCode : null,
                                    'status' => 102,
                                    'pan_no' => $request->pano,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);

                            }
                            return response()->json(['statusCode' => 202, 'response' => 'Invalid ID Number or Combination of Inputs']);
                        } else {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                                }
                                $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'dob' => $dob,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'vender_status_code' => isset($statusCode) ? $statusCode : null,
                                    'vender_code' => isset($statusCode) ? $statusCode : null,
                                    'status' => 500,
                                    'pan_no' => $request->pano,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);

                            }
                            return response()->json(['statusCode' => 500, 'response' => 'Internal server error. Please contact techsupport@docboyz.in. for more details']);
                        }

                    }
                } else {
                    return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
                }

            } else {
                return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
                    
            
    }
    public function pancard(Request $request)
    {

        $statusCode = null;
        $pancard = null;
        $api_id = null;
        $apiamster = null;

        if (empty($request->pan_number))
            return response()->json(array(['message' => 'Pancard number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'pancard')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);
        $headers = [
            'Accept' => 'application/json',
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
        ];

        $body = [
            'panNumber' => $request->pan_number,
            'groupId' => $groupId,
            'checkId' => $checkId,
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post('https://api.kyckart.com/api/panCard/panDetailedContactV4', [
                        'headers' => $headers,
                        'json' => $body,
                    ]);
                    $pancard_details = json_decode($response->getBody(), true);
                    if ($pancard_details['response']['code'] == 200 && $pancard_details['status']['statusCode'] == 200) {
                        $pancard['data']['client_id'] = null;
                        $pancard['data']['pan_number'] = isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null;
                        $pancard['data']['full_name'] = isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] . ' ' . $pancard_details['response']['middleName'] . ' ' . $pancard_details['response']['lastName'] : null;
                        $pancard['data']['category'] = isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                $panvalidation = DB::table('pancard_varification')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    "pancard_id" => isset($pancard['data']['pan_number']) ? $pancard['data']['pan_number'] : null,
                                    "name" => isset($pancard['data']['full_name']) ? $pancard['data']['full_name'] : null,
                                    // "pancard_id"=> $pancard['response']['pan_no'],
                                    // "name"=> $pancard['response']['registered_name'],
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'status_code' => 200,
                                    'message_code' => 'success',
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);

                            }
                        }
                        return response()->json(['pancard' => $pancard, 'statusCode' => 200, 'success' => true, 'message' => null, "message_code" => "success"]);
                    } elseif ($pancard_details['status']['statusCode'] == 200 && $pancard_details['response']['code'] == 400) {
                        $statusCode = 102;
                        $errorMessage = 'No Records found!.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pancard_varification')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pancard_varification')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'PAN Number InValid Please Enter Correct PanNumber.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pancard_varification')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pancard_varification')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }

    // public function pancard_details(Request $request) {
    //     // return '$request->pan_number';
    //     $statusCode = null;
    //     $pancard = null;
    //     $api_id = null;
    //     if(empty($request->pan_number))
    //         return response()->json(array(['message'=>'Pancard number is required','statusCode'=>'404']));

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     if($user->role_id==1) {
    //         $apiamster = ApiMaster::where('api_slug','paninfo')->first();
    //         // return $apiamster;
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //     }

    //     $client = new Client();
    //     $headers = [
    //         'Authorization' => $this->nsdlToken,        
    //         // 'API-KEY' => $this->api_club_key,   
    //         // 'Referer' => $this->site_url
    //     ];

    //     // $body =  [
    //     //     'pan_no' => $request->pan_number
    //     // ];

    //     $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //     // return $user->id;
    //     if($updateHitCount || $user->role_id==0){
    //         if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type=="role_postpaid") {
    //         try{
    //             // $res = $client->post($this->base_url.'/pan/pan', ['headers' => $headers, 'json' => $body]);
    //             // $res = $client->post($this->api_club.'/verify_pan', ['headers' => $headers, 'json' => $body]);
    //             $res = $client->post('https://g6wijy0gpe.execute-api.ap-south-1.amazonaws.com/loantap/pan', ['headers' => $headers, 'form_params'=> ['pancard'=>strtoupper($request->pan_number)]]);
    //             $pancard = json_decode($res->getBody(), true);
    //             // return $pancard;
    //             if($pancard['fullName'] == ''){
    //                 $statusCode = 102;
    //                 $errorMessage = 'Verification Failed. Please enter correct PAN Number.';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                     $panvalidation = DB::table('pancard_varification')->insert([
    //                         "user_id"=> $user->id,
    //                         "api_id"=> $api_id,
    //                         "pancard_id"=> $request->pan_number,
    //                         "pan_status_code"=> 'NA',
    //                         "pan_status"=> 'NA',
    //                         "aadhaar_seeding_status"=> 'NA',
    //                         "aadhaar_seeding_status_code"=> 'NA',
    //                         "last_updated_on"=> 'NA',
    //                         "created_at"=> Carbon::now(),
    //                         "updated_at"=> Carbon::now()
    //                     ]);
    //                 }
    //                 return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //             }else{
    //                 $statusCode = 200;
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                     }
    //                     $panvalidation = DB::table('pancard_varification')->insert([
    //                         "user_id"=> $user->id,
    //                         "api_id"=> $api_id,
    //                         "pancard_id"=> $pancard['panNumber'],
    //                         "pan_status_code"=> $pancard['panStatusCode'],
    //                         "pan_status"=> $pancard['panStatus'],
    //                         "aadhaar_seeding_status"=> $pancard['aadhaarSeedingStatus'],
    //                         "aadhaar_seeding_status_code"=> $pancard['aadhaarSeedingStatusCode'],
    //                         "last_updated_on"=> $pancard['lastUpdatedOn'],
    //                         "created_at"=> Carbon::now(),
    //                         "updated_at"=> Carbon::now()
    //                     ]);
    //                 }
    //             }
    //         } catch(BadResponseException $e) {
    //             $statusCode = $e->getResponse()->getStatusCode();
    //             if($statusCode == 500){
    //                 $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                 }
    //             }else if($statusCode == 404){
    //                 $statusCode = 102;
    //                 $errorMessage = 'Verification Failed. Please enter correct PAN Number.';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }else{
    //                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }

    //             $panvalidation = DB::table('pancard_varification')->insert([
    //                 "user_id"=> $user->id,
    //                 "api_id"=> $api_id,
    //                 "pancard_id"=> $pancard['pancard'],
    //                 "pan_status_code"=> $pancard['panStatusCode'],
    //                 "pan_status"=> $pancard['panStatus'],
    //                 "aadhaar_seeding_status"=> $pancard['aadhaarSeedingStatus'],
    //                 "aadhaar_seeding_status_code"=> $pancard['aadhaarSeedingStatusCode'],
    //                 "last_updated_on"=> $pancard['lastUpdatedOn'],
    //                 "created_at"=> Carbon::now(),
    //                 "updated_at"=> Carbon::now()
    //             ]);
    //             return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //         }
    //     }
    //     else{
    //         return response()->json(['statusCode'=>500, 'message'=>'Please recharge your wallet.']);
    //     }
    //     }else{
    //         return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //     }

    //     return response()->json(array(['pancard'=>$pancard,'statusCode'=>$statusCode]));
    // }

    //Lontap Pan Card Details 07/06/2024
    // public function pancard_details(Request $request) {

    //     $statusCode = null;
    //     $pacard = null;
    //     $api_id = null;
    //     if(empnty($request->pan_number))
    //         return response()->json(array(['message'=>'Pancard number is required','statusCode'=>'404']));

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     if($user->role_id==1) {
    //         $apiamster = ApiMaster::where('api_slug','paninfo')->first();
    //         // return $apiamster;
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //     }

    //     $client = new Client();
    //     $headers = [
    //         'Authorization' => $this->nsdlToken,        
    //         // 'API-KEY' => $this->api_club_key,   
    //         // 'Referer' => $this->site_url
    //     ];

    //     // $body =  [
    //     //     'pan_no' => $request->pan_number
    //     // ];

    //     $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //     // return $user->id;
    //     if($updateHitCount || $user->role_id==0){
    //         if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type=="role_postpaid") {
    //         try{
    //             // $res = $client->post($this->base_url.'/pan/pan', ['headers' => $headers, 'json' => $body]);
    //             // $res = $client->post($this->api_club.'/verify_pan', ['headers' => $headers, 'json' => $body]);
    //             $res = $client->post('https://g6wijy0gpe.execute-api.ap-south-1.amazonaws.com/loantap/pan', ['headers' => $headers, 'form_params'=> ['pancard'=>strtoupper($request->pan_number)]]);
    //             $pancard = json_decode($res->getBody(), true);
    //             // return $pancard;
    //             if($pancard['fullName'] == ''){
    //                 $statusCode = 102;
    //                 $errorMessage = 'Verification Failed. Please enter correct PAN Number.';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                     $panvalidation = DB::table('pancard_varification')->insert([
    //                         "user_id"=> $user->id,
    //                         "api_id"=> $api_id,
    //                         "pancard_id"=> $request->pan_number,
    //                         "pan_status_code"=> 'NA',
    //                         "pan_status"=> 'NA',
    //                         "aadhaar_seeding_status"=> 'NA',
    //                         "aadhaar_seeding_status_code"=> 'NA',
    //                         "last_updated_on"=> 'NA',
    //                         "created_at"=> Carbon::now(),
    //                         "updated_at"=> Carbon::now()
    //                     ]);
    //                 }
    //                 return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //             }else{
    //                 $statusCode = 200;
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                     }
    //                     $panvalidation = DB::table('pancard_varification')->insert([
    //                         "user_id"=> $user->id,
    //                         "api_id"=> $api_id,
    //                         "pancard_id"=> $pancard['panNumber'],
    //                         "pan_status_code"=> $pancard['panStatusCode'],
    //                         "pan_status"=> $pancard['panStatus'],
    //                         "aadhaar_seeding_status"=> $pancard['aadhaarSeedingStatus'],
    //                         "aadhaar_seeding_status_code"=> $pancard['aadhaarSeedingStatusCode'],
    //                         "created_at"=> Carbon::now(),
    //                         "updated_at"=> Carbon::now()
    //                     ]);
    //                 }
    //             }
    //         } catch(BadResponseException $e) {
    //             $statusCode = $e->getResponse()->getStatusCode();
    //             if($statusCode == 500){
    //                 $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                 }
    //             }else if($statusCode == 404){
    //                 $statusCode = 102;
    //                 $errorMessage = 'Verification Failed. Please enter correct PAN Number.';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }else{
    //                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }

    //             $panvalidation = DB::table('pancard_varification')->insert([
    //                 "user_id"=> $user->id,
    //                 "api_id"=> $api_id,
    //                 "pancard_id"=> $pancard['pancard'],
    //                 "pan_status_code"=> $pancard['panStatusCode'],
    //                 "pan_status"=> $pancard['panStatus'],
    //                 "aadhaar_seeding_status"=> $pancard['aadhaarSeedingStatus'],
    //                 "aadhaar_seeding_status_code"=> $pancard['aadhaarSeedingStatusCode'],
    //                 "last_updated_on"=> $pancard['lastUpdatedOn'],
    //                 "created_at"=> Carbon::now(),
    //                 "updated_at"=> Carbon::now()
    //             ]);
    //             return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //         }
    //     }
    //     else{
    //         return response()->json(['statusCode'=>500, 'message'=>'Please recharge your wallet.']);
    //     }
    //     }else{
    //         return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //     }

    //     return response()->json(array(['pancard'=>$pancard,'statusCode'=>$statusCode]));
    // }

    public function pancard_details(Request $request)
    {
        $statusCode = null;
        $pacard = null;
        $api_id = null;
        if (empty($request->pan_number))
            return response()->json(array(['message' => 'Pancard number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'pandetails1')->first();
            // return $apiamster;
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);
        $headers = [
            'Accept' => 'application/json',
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
        ];
        $body = [
            'panNumber' => $request->pan_number,
            'groupId' => $groupId,
            'checkId' => $checkId,
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // return $user->id;
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post('https://api.kyckart.com/api/panCard/panDetailedContactV4', [
                        'headers' => $headers,
                        'json' => $body,
                    ]);
                    $pancard_details = json_decode($response->getBody(), true);
                    //  return  $pancard_details;
                    if ($pancard_details['response']['code'] == 200 && $pancard_details['status']['statusCode'] == 200) {

                        $pancard['data']['panNumber'] = isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null;
                        $pancard['data']['fullName'] = isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null;
                        $pancard['data']['isValid'] = isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null;
                        $pancard['data']['firstName'] = isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null;
                        $pancard['data']['middleName'] = isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null;
                        $pancard['data']['lastName'] = isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null;
                        $pancard['data']['dob'] = isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null;
                        $pancard['data']['title'] = null;
                        $pancard['data']['panStatusCode'] = null;
                        $pancard['data']['panStatus'] = null;
                        $pancard['data']['aadhaarSeedingStatus'] = isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null;
                        $pancard['data']['aadhaarSeedingStatusCode'] = null;
                        $pancard['data']['lastUpdatedOn'] = null;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                $panvalidation = DB::table('pancard_varification')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    "pancard_id" => isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null,
                                    "name" => isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null,
                                    "pan_status_code" => null,
                                    "pan_status" => null,
                                    "aadhaar_seeding_status" => isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null,
                                    "aadhaar_seeding_status_code" => null,
                                    'status_code' => 200,
                                    'message_code' => "success",
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                        }
                        return response()->json(['pancard' => $pancard, 'statusCode' => 200, 'success' => true, 'message_code' => 'success']);

                    } elseif ($pancard_details['status']['statusCode'] == 200 && $pancard_details['response']['code'] == 400) {
                        $statusCode = 102;
                        $errorMessage = 'No Records found!.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pancard_varification')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'status_code' => 102,
                                    'message_code' => "failed",
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pancard_varification')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => "failed",
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'PAN Number InValid Please Enter Correct PanNumber.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pancard_varification')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pancard_varification')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }


    public function aadhaar_validation(Request $request)
    {
        // return 'test';


        $statusCode = null;
        $aadhaar_validation = null;
        $api_id = null;
        if (empty($request->aadhaar_number))
            return response()->json(array(['message' => 'Aadhaar number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'aadhaar')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();

        $headers = [
            // 'Authorization' => $this->token,        
            // 'API-KEY' => $this->api_club_key,   
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
            'Referer' => $this->site_url
        ];

        $body = [
            'aadhaarNumber' => $request->aadhaar_number,
            'demographicCheck' => true
        ];
        // return $request->header('AccessToken');

        // $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $res = $client->post($this->base_url.'/aadhaar-validation/aadhaar-validation', ['headers' => $headers, 'json' => $body,'form_params' => ['api_token' => $token]]);
                    // $res = $client->post($this->api_club.'/v1/validate_aadhar', ['headers' => $headers, 'json' => $body]);
                    $res = $client->post('https://api.kyckart.com/api/aadhaar/basic-verification', ['headers' => $headers, 'json' => $body]);
                    $aadhaar_validation = json_decode($res->getBody(), true);
                    // return $aadhaar_validation;

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $aadharvalidation = DB::table('aadhar_validation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $aadhaar_validation['response']['client_id'],
                            "aadhar_no" => $request->aadhaar_number,
                            "age_range" => $aadhaar_validation['response']['ageBand'],
                            "state" => $aadhaar_validation['response']['state'],
                            "gender" => $aadhaar_validation['response']['gender'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                    // $aadharvalidation = DB::table('aadhar_validation')->insert([
                    //     "user_id"=> $user->id,
                    //     "api_id"=> $api_id,
                    //     "client_id"=> $aadhaar_validation['data']['client_id'],
                    //     "aadhar_no"=> $aadhaar_validation['data']['aadhaar_number'],
                    //     "age_range"=> $aadhaar_validation['data']['age_range'],
                    //     "state"=> $aadhaar_validation['data']['state'],
                    //     "gender"=> $aadhaar_validation['data']['gender'],
                    //     "created_at"=> Carbon::now(),
                    //     "updated_at"=> Carbon::now()
                    // ]);

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Aadhar Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }

                    $aadharvalidation = DB::table('aadhar_validation')->insert([
                        "user_id" => $user->id,
                        "api_id" => $api_id,
                        // "client_id"=> $aadhaar_validation['response']['client_id'],
                        "aadhar_no" => $request->aadhaar_number,
                        "created_at" => Carbon::now(),
                        "updated_at" => Carbon::now()
                    ]);
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['aadhaar_validation' => $aadhaar_validation, 'statusCode' => '200']));
    }

    // Aadhaar verification
    // public function aadhaar_validation(Request $request) {
    //     $statusCode = null;
    //     $aadhaar_validation = null;
    //     $api_id = null;
    //     if(empty($request->aadhaar_number))
    //         return response()->json(array(['message'=>'Aadhaar number is required','statusCode'=>'404']));

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     if($user->role_id==1) {
    //         $apiamster = ApiMaster::where('api_slug','aadhaar')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //     }

    //     $client = new Client();
    //     $headers = [
    //         'Authorization' => $this->token,        
    //         'Accept'        => 'application/json',
    //     ];

    //     $body =  [
    //         'id_number' => $request->aadhaar_number
    //     ];

    //     $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
    //     $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //     if($updateHitCount || $user->role_id==0){
    //         try{
    //             $res = $client->post($this->base_url.'/aadhaar-validation/aadhaar-validation', ['headers' => $headers, 'json' => $body,'form_params' => ['api_token' => $token]]);
    //             $aadhaar_validation = json_decode($res->getBody(), true);
    //             if($user->role_id==1) {
    //                 if($apiamster) {
    //                     $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                 }
    //                 $aadharvalidation = DB::table('aadhar_validation')->insert([
    //                     "user_id"=> $user->id,
    //                     "api_id"=> $api_id,
    //                     "client_id"=> $aadhaar_validation['data']['client_id'],
    //                     "aadhar_no"=> $aadhaar_validation['data']['aadhaar_number'],
    //                     "age_range"=> $aadhaar_validation['data']['age_range'],
    //                     "state"=> $aadhaar_validation['data']['state'],
    //                     "gender"=> $aadhaar_validation['data']['gender'],
    //                     "created_at"=> Carbon::now(),
    //                     "updated_at"=> Carbon::now()
    //                 ]);
    //             }
    //         } catch(BadResponseException $e) {
    //             $statusCode = $e->getResponse()->getStatusCode();
    //             if($statusCode == 500){
    //                 $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                 }
    //             }else if($statusCode == 422){
    //                 $statusCode = 102;
    //                 $errorMessage = 'Verification Failed. Please enter correct Aadhar Number.';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }else{
    //                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }
    //             return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //         }
    //     }else{
    //         return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //     }

    //     return response()->json(array(['aadhaar_validation'=>$aadhaar_validation,'statusCode'=>'200']));
    // }

    //aadhar upload api implementation
    public function aadhaar_upload(Request $request)
    {
        
        // return 'tester';
        //     if (!$request->hasFile('file')) {
        //         return json_encode(['message'=>"File is required",'statusCode'=>'404'], true);
        //     }
        //     // echo $_FILES['file']['name'];

        //     $curl1 = curl_init();
        //     curl_setopt_array($curl1, array(
        //         CURLOPT_URL => "https://sandbox.flowboard.in/api/v1/ocr/aadhaar",
        //         CURLOPT_RETURNTRANSFER => true,
        //         CURLOPT_ENCODING => "",
        //         CURLOPT_MAXREDIRS => 10,
        //         CURLOPT_TIMEOUT => 0,
        //         CURLOPT_FOLLOWLOCATION => true,
        //         CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
        //         CURLOPT_CUSTOMREQUEST => "POST",
        //         CURLOPT_POSTFIELDS => array(
        //             "file" => new \CURLFILE($_FILES['file']['tmp_name'],$_FILES['file']['type'],$_FILES['file']['name']),
        //         ),
        //         CURLOPT_HTTPHEADER => array(
        //             "Authorization: ".$this->sandbox_token,
        //         ),
        //     ));
        //     $ocr_data = curl_exec($curl1);
        //     $ocr_data = json_decode($ocr_data, true);
        //    if($ocr_data['status_code'] == 200){
        //     $client = new Client();
        //     $headers = [
        //         'Authorization' => $this->token,        
        //         'Accept'        => 'application/json',
        //     ];

        //     $body =  [
        //         'id_number' => $ocr_data['data']['ocr_fields'][0]['aadhaar_number']['value']
        //     ];
        //     $user = User::where('access_token',$request->header('AccessToken'))->first();
        //      if($user->role_id==1) {
        //         $apiamster = ApiMaster::where('api_slug','aadhaarupload')->first();
        //         if($apiamster)
        //             $api_id = $apiamster->id;
        //     }
        //     try{
        //         $res = $client->post($this->base_url.'/aadhaar-validation/aadhaar-validation', ['headers' => $headers, 'json' => $body]);
        //         $aadhaar_upload = json_decode($res->getBody(), true);
        //         if($user->role_id==1) {
        //             if($apiamster) {
        //                  // $this->saveHitCount($user->id, $api_id);
        //             }
        //         }
        //     } catch(BadResponseException $e) {
        //         $statusCode = $e->getResponse()->getStatusCode();
        //         return response()->json(['statusCode'=>$statusCode]);
        //     }
        //    }

        //     return response()->json(array(['ocr_aadhar'=>$ocr_data, 'aadhaar_upload'=>$aadhaar_upload,'statusCode'=>'200']));
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }
        // echo $_FILES['file']['name'];
        // dd("hi");
        $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $curl1 = curl_init();
        curl_setopt_array($curl1, array(
            CURLOPT_URL => "http://13.232.233.195/uatapis/ocr/aadhar",
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "POST",
            CURLOPT_POSTFIELDS => array(
                "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
            ),
            CURLOPT_HTTPHEADER => array(
                //"Authorization: ".$this->token,
                "Authorization: " . $this->token,
            ),
        ));
        $get_data1 = curl_exec($curl1);
        // return $get_data1;
        // dd($get_data1);
        return response()->json(json_decode($get_data1, true));
    }

    public function aadhaar_masking(Request $request)
    {
        // return 'ok';
        $aadhaar_masked_details = null;
        $status_code = '';
        $api_id = '';

        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }
        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));


        $user = User::where('access_token', $request->header('AccessToken'))->first();

        $apiamster = ApiMaster::where('api_slug', 'aadharmasking')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl1 = curl_init();
                curl_setopt_array($curl1, array(
                    CURLOPT_URL => "http://13.204.214.95:8083/mask",
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => "",
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => "POST",
                    CURLOPT_POSTFIELDS => array(
                        "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                    ),
                    CURLOPT_HTTPHEADER => array(
                        //"Authorization: ".$this->token,
                        "Authorization: " . $this->token,
                    ),
                ));
                $get_data1 = curl_exec($curl1);
                $aadhar_details = json_decode($get_data1, true);
                // return  $aadhar_details;
                
                        
                  
             

                if ($user->role_id == 1 || $aadhar_details) {
                    // return 'test ok';
                    if($user->id != 1){
                            if ($apiamster) {
                            $api_id = $apiamster->id;
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }

                    // if (isset($aadhar_details['data']['ocr_fields'][1])) {
                    //     if (isset($aadhar_details['data']['ocr_fields'][1]['masked_image'])) {
                    //         $masked_image_back = $aadhar_details['data']['ocr_fields'][1]['masked_image'];
                    //     } else {
                    //         $masked_image_back = null;
                    //     }
                    //     $masked_details = DB::table('aadhar_masking_details')->insert([
                    //         "user_id" => $user->id,
                    //         "api_id" => $api_id,
                    //         "aadhar_number" => $aadhar_details['data']['ocr_fields'][0]['aadhaar_number']['value'],
                    //         "full_name" => $aadhar_details['data']['ocr_fields'][0]['full_name']['value'],
                    //         "gender" => $aadhar_details['data']['ocr_fields'][0]['gender']['value'],
                    //         "dob" => $aadhar_details['data']['ocr_fields'][0]['dob']['value'],
                    //         "masked_image" => $aadhar_details['data']['ocr_fields'][0]['masked_image'],
                    //         "address" => $aadhar_details['data']['ocr_fields'][1]['address']['value'],
                    //         "city" => $aadhar_details['data']['ocr_fields'][1]['address']['city'],
                    //         "state" => $aadhar_details['data']['ocr_fields'][1]['address']['state'],
                    //         "zip" => $aadhar_details['data']['ocr_fields'][1]['address']['zip'],
                    //         "masked_image_back" => $masked_image_back,
                    //         "created_at" => Carbon::now(),
                    //         "updated_at" => Carbon::now()
                    //     ]);
                    // }
                } else {
                    // return 'test ok ok';
                    if ($user->role_id == 1 && $apiamster) {
                        $api_id = $apiamster->id;
                        if ($status_code == 500) {
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $status_code);
                            }
                        } else if ($status_code == 422) {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please upload valid aadhar photo.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $status_code);
                                }
                            }
                        }
                        return response()->json(array(['status_code' => $status_code, 'message' => $errorMessage]));
                    }
                }
            } else {
                return response()->json(['status_code' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['aadhaar_masked_details' => $aadhar_details]));
    }

    public function aadhaar_masking26sept2025(Request $request)
    {
        $aadhaar_masked_details = null;
        $status_code = '';
        $api_id = '';

        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }
        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));


        $user = User::where('access_token', $request->header('AccessToken'))->first();

        $apiamster = ApiMaster::where('api_slug', 'aadharmasking')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl1 = curl_init();
                curl_setopt_array($curl1, array(
                    CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/ocr/aadhaar",
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => "",
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => "POST",
                    CURLOPT_POSTFIELDS => array(
                        "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                    ),
                    CURLOPT_HTTPHEADER => array(
                        //"Authorization: ".$this->token,
                        "Authorization: " . $this->token,
                    ),
                ));
                $get_data1 = curl_exec($curl1);
                $aadhar_details = json_decode($get_data1, true);
                // return  $aadhar_details;
                $curl2 = curl_init();
                curl_setopt_array($curl2, array(
                    CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/ocr/mask-aadhaar",
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => "",
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => "POST",
                    CURLOPT_POSTFIELDS => array(
                        "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                    ),
                    CURLOPT_HTTPHEADER => array(
                        //"Authorization: ".$this->token,
                        "Authorization: " . $this->token,
                    ),
                ));
                $get_data2 = curl_exec($curl2);
                $aadhaar_masked_details = json_decode($get_data2, true);
                $status_code = $aadhar_details['status_code'];
                $aadhar_details['data']['ocr_fields'][0]['masked_image'] = $aadhaar_masked_details['data']['masked_image'];
                if (count($aadhar_details['data']['ocr_fields']) == 1 && $aadhar_details['status_code'] == 200 && $request->hasFile('file_back')) {
                    $curl2 = curl_init();
                    curl_setopt_array($curl2, array(
                        CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/ocr/aadhaar",
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => "",
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => "POST",
                        CURLOPT_POSTFIELDS => array(
                            "file" => new \CURLFILE($_FILES['file_back']['tmp_name'], $_FILES['file_back']['type'], $_FILES['file_back']['name']),
                        ),
                        CURLOPT_HTTPHEADER => array(
                            //"Authorization: ".$this->token,
                            "Authorization: " . $this->token,
                        ),
                    ));
                    $get_data2 = curl_exec($curl2);
                    $aadhar_details1 = json_decode($get_data2, true);
                    $status_code = $aadhar_details1['status_code'];
                    if ($aadhar_details1['status_code'] == 200) {
                        if ($aadhar_details1['data']['ocr_fields'][0]['document_type'] == 'aadhaar_back') {
                            array_push($aadhar_details['data']['ocr_fields'], $aadhar_details1['data']['ocr_fields'][0]);
                            $curl2 = curl_init();
                            curl_setopt_array($curl2, array(
                                CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/ocr/mask-aadhaar",
                                CURLOPT_RETURNTRANSFER => true,
                                CURLOPT_ENCODING => "",
                                CURLOPT_MAXREDIRS => 10,
                                CURLOPT_TIMEOUT => 0,
                                CURLOPT_FOLLOWLOCATION => true,
                                CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                                CURLOPT_CUSTOMREQUEST => "POST",
                                CURLOPT_POSTFIELDS => array(
                                    "file" => new \CURLFILE($_FILES['file_back']['tmp_name'], $_FILES['file_back']['type'], $_FILES['file_back']['name']),
                                ),
                                CURLOPT_HTTPHEADER => array(
                                    //"Authorization: ".$this->token,
                                    "Authorization: " . $this->token,
                                ),
                            ));
                            $get_data2 = curl_exec($curl2);
                            $aadhaar_masked_details = json_decode($get_data2, true);
                            $aadhar_details['data']['ocr_fields'][1]['masked_image'] = $aadhaar_masked_details['data']['masked_image'];
                        } else {
                            if (isset($aadhar_details1['data']['ocr_fields'][1])) {
                                array_push($aadhar_details['data']['ocr_fields'], $aadhar_details1['data']['ocr_fields'][1]);
                                $curl2 = curl_init();
                                curl_setopt_array($curl2, array(
                                    CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/ocr/mask-aadhaar",
                                    CURLOPT_RETURNTRANSFER => true,
                                    CURLOPT_ENCODING => "",
                                    CURLOPT_MAXREDIRS => 10,
                                    CURLOPT_TIMEOUT => 0,
                                    CURLOPT_FOLLOWLOCATION => true,
                                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                                    CURLOPT_CUSTOMREQUEST => "POST",
                                    CURLOPT_POSTFIELDS => array(
                                        "file" => new \CURLFILE($_FILES['file_back']['tmp_name'], $_FILES['file_back']['type'], $_FILES['file_back']['name']),
                                    ),
                                    CURLOPT_HTTPHEADER => array(
                                        //"Authorization: ".$this->token,
                                        "Authorization: " . $this->token,
                                    ),
                                ));
                                $get_data2 = curl_exec($curl2);
                                $aadhaar_masked_details = json_decode($get_data2, true);
                                $aadhar_details['data']['ocr_fields'][1]['masked_image'] = $aadhaar_masked_details['data']['masked_image'];
                            }
                        }
                    }
                }

                if ($user->role_id == 1 && $aadhar_details['status_code'] == 200) {
                    if ($apiamster) {
                        $api_id = $apiamster->id;
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }
                    if (isset($aadhar_details['data']['ocr_fields'][1])) {
                        if (isset($aadhar_details['data']['ocr_fields'][1]['masked_image'])) {
                            $masked_image_back = $aadhar_details['data']['ocr_fields'][1]['masked_image'];
                        } else {
                            $masked_image_back = null;
                        }
                        $masked_details = DB::table('aadhar_masking_details')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "aadhar_number" => $aadhar_details['data']['ocr_fields'][0]['aadhaar_number']['value'],
                            "full_name" => $aadhar_details['data']['ocr_fields'][0]['full_name']['value'],
                            "gender" => $aadhar_details['data']['ocr_fields'][0]['gender']['value'],
                            "dob" => $aadhar_details['data']['ocr_fields'][0]['dob']['value'],
                            "masked_image" => $aadhar_details['data']['ocr_fields'][0]['masked_image'],
                            "address" => $aadhar_details['data']['ocr_fields'][1]['address']['value'],
                            "city" => $aadhar_details['data']['ocr_fields'][1]['address']['city'],
                            "state" => $aadhar_details['data']['ocr_fields'][1]['address']['state'],
                            "zip" => $aadhar_details['data']['ocr_fields'][1]['address']['zip'],
                            "masked_image_back" => $masked_image_back,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                } else {
                    if ($user->role_id == 1 && $apiamster) {
                        $api_id = $apiamster->id;
                        if ($status_code == 500) {
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $status_code);
                            }
                        } else if ($status_code == 422) {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please upload valid aadhar photo.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $status_code);
                                }
                            }
                        }
                        return response()->json(array(['status_code' => $status_code, 'message' => $errorMessage]));
                    }
                }
            } else {
                return response()->json(['status_code' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['aadhaar_masked_details' => $aadhar_details]));
    }

    public function aadhaar_masking1(Request $request)
    {
        $aadhaar_masked_details = null;
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }

        $curl1 = curl_init();
        curl_setopt_array($curl1, array(
            CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/ocr/aadhaar",
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "POST",
            CURLOPT_POSTFIELDS => array(
                "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
            ),
            CURLOPT_HTTPHEADER => array(
                //"Authorization: ".$this->token,
                "Authorization: " . $this->token,
            ),
        ));
        $get_data1 = curl_exec($curl1);
        $aadhar_details = json_decode($get_data1, true);
        // $user = User::where('access_token',$request->header('AccessToken'))->first();
        // if($user->role_id==1) {
        //     $apiamster = ApiMaster::where('api_slug','aadhaar')->first();
        //     if($apiamster)
        //         $api_id = $apiamster->id;
        // }

        $curl2 = curl_init();
        curl_setopt_array($curl2, array(
            CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/ocr/mask-aadhaar",
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "POST",
            CURLOPT_POSTFIELDS => array(
                "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
            ),
            CURLOPT_HTTPHEADER => array(
                //"Authorization: ".$this->token,
                "Authorization: " . $this->token,
            ),
        ));
        $get_data2 = curl_exec($curl2);
        $aadhaar_masked_details = json_decode($get_data2, true);
        $aadhar_details['data']['ocr_fields'][0]['masked_image'] = $aadhaar_masked_details['data']['masked_image'];

        return response()->json(array(['aadhaar_masked_details' => $aadhar_details]));
    }
    //CIN KYC Kart//
    public function corporate_cin_advance(Request $request)
    {
        $statusCode = null;

        $corporate_cin = null;
        $api_id = null;
        if (empty($request->cinNumber)) {
            return response()->json([['message' => 'CIN number is required', 'statusCode' => '404']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'cinadvance')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

        $client = new Client();
        $headers = [
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
            'Accept' => 'application/json',
        ];
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);

        $body = [
            'cinNumber' => $request->cinNumber,
            'checkId' => $checkId,
            'groupId' => $groupId,
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post('https://api.kyckart.com/api/roc/cin-advanced', ['headers' => $headers, 'json' => $body]);
                    $corporate_cin = json_decode($res->getBody(), true);
                    $corporate_cin_details = null;
                    if (isset($corporate_cin['response']['code']) && $corporate_cin['response']['code'] == 200 && $corporate_cin['status']['statusCode'] == 200) {
                        $corporate_cin_details['data']['cin'] = isset($corporate_cin['response']['cin']) ? $corporate_cin['response']['cin'] : null;
                        $corporate_cin_details['data']['numberOfMembers'] = isset($corporate_cin['response']['numberOfMembers']) ? $corporate_cin['response']['numberOfMembers'] : null;
                        $corporate_cin_details['data']['subCategory'] = isset($corporate_cin['response']['subCategory']) ? $corporate_cin['response']['subCategory'] : null;
                        $corporate_cin_details['data']['class'] = isset($corporate_cin['response']['class']) ? $corporate_cin['response']['class'] : null;
                        $corporate_cin_details['data']['companyType'] = isset($corporate_cin['response']['companyType']) ? $corporate_cin['response']['companyType'] : null;
                        $corporate_cin_details['data']['companyName'] = isset($corporate_cin['response']['companyName']) ? $corporate_cin['response']['companyName'] : null;
                        $corporate_cin_details['data']['paidUpCapital'] = isset($corporate_cin['response']['paidUpCapital']) ? $corporate_cin['response']['paidUpCapital'] : null;
                        $corporate_cin_details['data']['authorisedCapital'] = isset($corporate_cin['response']['authorisedCapital']) ? $corporate_cin['response']['authorisedCapital'] : null;
                        $corporate_cin_details['data']['whetherListed'] = isset($corporate_cin['response']['whetherListed']) ? $corporate_cin['response']['whetherListed'] : null;
                        $corporate_cin_details['data']['dateOfIncorporation'] = isset($corporate_cin['response']['dateOfIncorporation']) ? $corporate_cin['response']['dateOfIncorporation'] : null;
                        $corporate_cin_details['data']['lastAgmDate'] = isset($corporate_cin['response']['lastAgmDate']) ? $corporate_cin['response']['lastAgmDate'] : null;
                        $corporate_cin_details['data']['registrationNumber'] = isset($corporate_cin['response']['registrationNumber']) ? $corporate_cin['response']['registrationNumber'] : null;
                        $corporate_cin_details['data']['registeredAddress'] = isset($corporate_cin['response']['registeredAddress']) ? $corporate_cin['response']['registeredAddress'] : null;
                        $corporate_cin_details['data']['activeCompliance'] = isset($corporate_cin['response']['activeCompliance']) ? $corporate_cin['response']['activeCompliance'] : null;
                        $corporate_cin_details['data']['suspendedAtStockExchange'] = isset($corporate_cin['response']['suspendedAtStockExchange']) ? $corporate_cin['response']['suspendedAtStockExchange'] : null;
                        $corporate_cin_details['data']['balanceSheetDate'] = isset($corporate_cin['response']['balanceSheetDate']) ? $corporate_cin['response']['balanceSheetDate'] : null;
                        $corporate_cin_details['data']['category'] = isset($corporate_cin['response']['category']) ? $corporate_cin['response']['category'] : null;
                        $corporate_cin_details['data']['status'] = isset($corporate_cin['response']['status']) ? $corporate_cin['response']['status'] : null;
                        $corporate_cin_details['data']['rocOffice'] = isset($corporate_cin['response']['rocOffice']) ? $corporate_cin['response']['rocOffice'] : null;
                        $corporate_cin_details['data']['countryOfIncorporation'] = isset($corporate_cin['response']['countryOfIncorporation']) ? $corporate_cin['response']['countryOfIncorporation'] : null;
                        $corporate_cin_details['data']['descriptionOfMainDivision'] = isset($corporate_cin['response']['descriptionOfMainDivision']) ? $corporate_cin['response']['descriptionOfMainDivision'] : null;
                        $corporate_cin_details['data']['addressOtherThanRegisteredOffice'] = isset($corporate_cin['response']['addressOtherThanRegisteredOffice']) ? $corporate_cin['response']['addressOtherThanRegisteredOffice'] : null;
                        $corporate_cin_details['data']['emailId'] = isset($corporate_cin['response']['emailId']) ? $corporate_cin['response']['emailId'] : null;
                        $corporate_cin_details['data']['natureOfBusiness'] = isset($corporate_cin['response']['natureOfBusiness']) ? $corporate_cin['response']['natureOfBusiness'] : null;
                        $corporate_cin_details['data']['noOfDirectors'] = isset($corporate_cin['response']['noOfDirectors']) ? $corporate_cin['response']['noOfDirectors'] : null;
                        $corporate_cin_details['data']['statusForEfiling'] = isset($corporate_cin['response']['statusForEfiling']) ? $corporate_cin['response']['statusForEfiling'] : null;
                        $corporate_cin_details['data']['statusUnderCirp'] = isset($corporate_cin['response']['statusUnderCirp']) ? $corporate_cin['response']['statusUnderCirp'] : null;
                        $corporate_cin_details['data']['pan'] = isset($corporate_cin['response']['pan']) ? $corporate_cin['response']['pan'] : null;
                        $corporate_cin_details['data']['directors'] = isset($corporate_cin['response']['directorDetails']) ? $corporate_cin['response']['directorDetails'] : null;
                        $corporate_cin_details['data']['splitAddress'] = isset($corporate_cin['response']['splitAddress']) ? $corporate_cin['response']['splitAddress'] : null;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }

                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($corporate_cin['response']['cin']) ? $corporate_cin['response']['cin'] : null,
                                'numberOfMembers' => isset($corporate_cin['response']['numberOfMembers']) ? $corporate_cin['response']['numberOfMembers'] : null,
                                'subCategory' => isset($corporate_cin['response']['subCategory']) ? $corporate_cin['response']['subCategory'] : null,
                                'class' => isset($corporate_cin['response']['class']) ? $corporate_cin['response']['class'] : null,
                                'companyType' => isset($corporate_cin['response']['companyType']) ? $corporate_cin['response']['companyType'] : null,
                                'companyName' => isset($corporate_cin['response']['companyName']) ? $corporate_cin['response']['companyName'] : null,
                                'paidUpCapital' => isset($corporate_cin['response']['paidUpCapital']) ? $corporate_cin['response']['paidUpCapital'] : null,
                                'authorisedCapital' => isset($corporate_cin['response']['authorisedCapital']) ? $corporate_cin['response']['authorisedCapital'] : null,
                                'whetherListed' => isset($corporate_cin['response']['whetherListed']) ? $corporate_cin['response']['whetherListed'] : null,
                                'dateOfIncorporation' => isset($corporate_cin['response']['dateOfIncorporation']) ? $corporate_cin['response']['dateOfIncorporation'] : null,
                                'lastAgmDate' => isset($corporate_cin['response']['lastAgmDate']) ? $corporate_cin['response']['lastAgmDate'] : null,
                                'registrationNumber' => isset($corporate_cin['response']['registrationNumber']) ? $corporate_cin['response']['registrationNumber'] : null,
                                'registeredAddress' => isset($corporate_cin['response']['registeredAddress']) ? $corporate_cin['response']['registeredAddress'] : null,
                                'activeCompliance' => isset($corporate_cin['response']['activeCompliance']) ? $corporate_cin['response']['activeCompliance'] : null,
                                'suspendedAtStockExchange' => isset($corporate_cin['response']['suspendedAtStockExchange']) ? $corporate_cin['response']['suspendedAtStockExchange'] : null,
                                'balanceSheetDate' => isset($corporate_cin['response']['balanceSheetDate']) ? $corporate_cin['response']['balanceSheetDate'] : null,
                                'category' => isset($corporate_cin['response']['category']) ? $corporate_cin['response']['category'] : null,
                                'status' => isset($corporate_cin['response']['status']) ? $corporate_cin['response']['status'] : null,
                                'rocOffice' => isset($corporate_cin['response']['rocOffice']) ? $corporate_cin['response']['rocOffice'] : null,
                                'countryOfIncorporation' => isset($corporate_cin['response']['countryOfIncorporation']) ? $corporate_cin['response']['countryOfIncorporation'] : null,
                                'descriptionOfMainDivision' => isset($corporate_cin['response']['descriptionOfMainDivision']) ? $corporate_cin['response']['descriptionOfMainDivision'] : null,
                                'addressOtherThanRegisteredOffice' => isset($corporate_cin['response']['addressOtherThanRegisteredOffice']) ? $corporate_cin['response']['addressOtherThanRegisteredOffice'] : null,
                                'emailId' => isset($corporate_cin['response']['emailId']) ? $corporate_cin['response']['emailId'] : null,
                                'natureOfBusiness' => isset($corporate_cin['response']['natureOfBusiness']) ? $corporate_cin['response']['natureOfBusiness'] : null,
                                'noOfDirectors' => isset($corporate_cin['response']['noOfDirectors']) ? $corporate_cin['response']['noOfDirectors'] : null,
                                'statusForEfiling' => isset($corporate_cin['response']['statusForEfiling']) ? $corporate_cin['response']['statusForEfiling'] : null,
                                'statusUnderCirp' => isset($corporate_cin['response']['statusUnderCirp']) ? $corporate_cin['response']['statusUnderCirp'] : null,
                                'pan' => isset($corporate_cin['response']['pan']) ? $corporate_cin['response']['pan'] : null,
                                'directors' => isset($corporate_cin['response']['directorDetails']) ? json_encode($corporate_cin['response']['directorDetails']) : null,
                                'splitAddress' => isset($corporate_cin['response']['splitAddress']) ? json_encode($corporate_cin['response']['splitAddress']) : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($corporate_cin['status']['statusCode']) ? $corporate_cin['status']['statusCode'] : null,
                                'vender_code' => isset($corporate_cin['response']['code']) ? $corporate_cin['response']['code'] : null,
                                'status_code' => 200,
                                'message' => 'Success',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['corporate_cin' => $corporate_cin_details, 'statusCode' => 200, 'success' => true]);
                    } elseif (isset($corporate_cin['response']['code']) && $corporate_cin['response']['code'] == 400 && $corporate_cin['status']['statusCode'] == 400) {
                        $statusCode = 102;
                        $errorMessage = 'No data found';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cinNumber) ? $request->cinNumber : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($corporate_cin['status']['statusCode']) ? $corporate_cin['status']['statusCode'] : null,
                                'vender_code' => isset($corporate_cin['response']['code']) ? $corporate_cin['response']['code'] : null,
                                'status_code' => 102,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 500);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cinNumber) ? $request->cinNumber : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($corporate_cin['status']['statusCode']) ? $corporate_cin['status']['statusCode'] : null,
                                'vender_code' => isset($corporate_cin['response']['code']) ? $corporate_cin['response']['code'] : null,
                                'status_code' => 500,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $errorMessage = "CIN Number is invalid! Please enter a valid CIN Number.";
                        $statusCode = 102;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cinNumber) ? $request->cinNumber : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                'status_code' => 102,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } elseif (!empty($errorResponse['status']['statusCode']) && $errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 205) {
                        $statusCode = 201;
                        $errorMessage = 'API Failed due to internal error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 201);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cinNumber) ? $request->cinNumber : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                'status_code' => 201,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 500);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cinNumber) ? $request->cinNumber : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                'status_code' => 500,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    //CIN KYC kart Basic//
    public function corporate_cin_basic(Request $request)
    {
        $statusCode = null;
        $corporate_cin = null;
        $api_id = null;

        if (empty($request->cin_number)) {
            return response()->json([['message' => 'CIN number is required', 'statusCode' => '404']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'cinbasic')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

        $client = new Client();
        $headers = [
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
            'Accept' => 'application/json',
        ];
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);

        $body = [
            'cinNumber' => $request->cin_number,
            'checkId' => $checkId,
            'groupId' => $groupId,
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post('https://api.kyckart.com/api/roc/cin-basic', ['headers' => $headers, 'json' => $body]);
                    $corporate_cin = json_decode($res->getBody(), true);
                    $corporate_cin_details = null;
                    if (isset($corporate_cin['response']['code']) && $corporate_cin['response']['code'] == 200 && $corporate_cin['status']['statusCode'] == 200) {
                        $corporate_cin_details['data']['cin'] = isset($corporate_cin['response']['cin']) ? $corporate_cin['response']['cin'] : null;
                        $corporate_cin_details['data']['numberOfMembers'] = isset($corporate_cin['response']['numberOfMembers']) ? $corporate_cin['response']['numberOfMembers'] : null;
                        $corporate_cin_details['data']['subCategory'] = isset($corporate_cin['response']['subCategory']) ? $corporate_cin['response']['subCategory'] : null;
                        $corporate_cin_details['data']['classType'] = isset($corporate_cin['response']['classType']) ? $corporate_cin['response']['classType'] : null;
                        $corporate_cin_details['data']['companyType'] = isset($corporate_cin['response']['companyType']) ? $corporate_cin['response']['companyType'] : null;
                        $corporate_cin_details['data']['companyName'] = isset($corporate_cin['response']['companyName']) ? $corporate_cin['response']['companyName'] : null;
                        $corporate_cin_details['data']['paidUpCapital'] = isset($corporate_cin['response']['paidUpCapital']) ? $corporate_cin['response']['paidUpCapital'] : null;
                        $corporate_cin_details['data']['authorisedCapital'] = isset($corporate_cin['response']['authorisedCapital']) ? $corporate_cin['response']['authorisedCapital'] : null;
                        $corporate_cin_details['data']['whetherListed'] = isset($corporate_cin['response']['whetherListed']) ? $corporate_cin['response']['whetherListed'] : null;
                        $corporate_cin_details['data']['dateOfIncorporation'] = isset($corporate_cin['response']['dateOfIncorporation']) ? $corporate_cin['response']['dateOfIncorporation'] : null;
                        $corporate_cin_details['data']['registrationNumber'] = isset($corporate_cin['response']['registrationNumber']) ? $corporate_cin['response']['registrationNumber'] : null;
                        $corporate_cin_details['data']['registeredAddress'] = isset($corporate_cin['response']['registeredAddress']) ? $corporate_cin['response']['registeredAddress'] : null;
                        $corporate_cin_details['data']['registeredDisctrict'] = isset($corporate_cin['response']['registeredDisctrict']) ? $corporate_cin['response']['registeredDisctrict'] : null;
                        $corporate_cin_details['data']['registeredState'] = isset($corporate_cin['response']['registeredState']) ? $corporate_cin['response']['registeredState'] : null;
                        $corporate_cin_details['data']['registeredCity'] = isset($corporate_cin['response']['registeredCity']) ? $corporate_cin['response']['registeredCity'] : null;
                        $corporate_cin_details['data']['registeredPincode'] = isset($corporate_cin['response']['registeredPincode']) ? $corporate_cin['response']['registeredPincode'] : null;
                        $corporate_cin_details['data']['registeredCountry'] = isset($corporate_cin['response']['registeredCountry']) ? $corporate_cin['response']['registeredCountry'] : null;
                        $corporate_cin_details['data']['activeCompliance'] = isset($corporate_cin['response']['activeCompliance']) ? $corporate_cin['response']['activeCompliance'] : null;
                        $corporate_cin_details['data']['category'] = isset($corporate_cin['response']['category']) ? $corporate_cin['response']['category'] : null;
                        $corporate_cin_details['data']['status'] = isset($corporate_cin['response']['status']) ? $corporate_cin['response']['status'] : null;
                        $corporate_cin_details['data']['rocOffice'] = isset($corporate_cin['response']['rocOffice']) ? $corporate_cin['response']['rocOffice'] : null;
                        $corporate_cin_details['data']['addressOtherThanRegisteredOffice'] = isset($corporate_cin['response']['addressOtherThanRegisteredOffice']) ? $corporate_cin['response']['addressOtherThanRegisteredOffice'] : null;
                        $corporate_cin_details['data']['emailId'] = isset($corporate_cin['response']['emailId']) ? $corporate_cin['response']['emailId'] : null;
                        $corporate_cin_details['data']['natureOfBusiness'] = isset($corporate_cin['response']['natureOfBusiness']) ? $corporate_cin['response']['natureOfBusiness'] : null;
                        $corporate_cin_details['data']['noOfDirectors'] = isset($corporate_cin['response']['noOfDirectors']) ? $corporate_cin['response']['noOfDirectors'] : null;
                        $corporate_cin_details['data']['statusForEfiling'] = isset($corporate_cin['response']['statusForEfiling']) ? $corporate_cin['response']['statusForEfiling'] : null;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }

                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($corporate_cin['response']['cin']) ? $corporate_cin['response']['cin'] : null,
                                'numberOfMembers' => isset($corporate_cin['response']['numberOfMembers']) ? $corporate_cin['response']['numberOfMembers'] : null,
                                'subCategory' => isset($corporate_cin['response']['subCategory']) ? $corporate_cin['response']['subCategory'] : null,
                                'class' => isset($corporate_cin['response']['classType']) ? $corporate_cin['response']['classType'] : null,
                                'companyType' => isset($corporate_cin['response']['companyType']) ? $corporate_cin['response']['companyType'] : null,
                                'companyName' => isset($corporate_cin['response']['companyName']) ? $corporate_cin['response']['companyName'] : null,
                                'paidUpCapital' => isset($corporate_cin['response']['paidUpCapital']) ? $corporate_cin['response']['paidUpCapital'] : null,
                                'authorisedCapital' => isset($corporate_cin['response']['authorisedCapital']) ? $corporate_cin['response']['authorisedCapital'] : null,
                                'whetherListed' => isset($corporate_cin['response']['whetherListed']) ? $corporate_cin['response']['whetherListed'] : null,
                                'dateOfIncorporation' => isset($corporate_cin['response']['dateOfIncorporation']) ? $corporate_cin['response']['dateOfIncorporation'] : null,
                                'registrationNumber' => isset($corporate_cin['response']['registrationNumber']) ? $corporate_cin['response']['registrationNumber'] : null,
                                'registeredAddress' => isset($corporate_cin['response']['registeredAddress']) ? $corporate_cin['response']['registeredAddress'] : null,
                                'registeredDisctrict' => isset($corporate_cin['response']['registeredDisctrict']) ? $corporate_cin['response']['registeredDisctrict'] : null,
                                'registeredState' => isset($corporate_cin['response']['registeredState']) ? json_encode($corporate_cin['response']['registeredState']) : null,
                                'registeredCity' => isset($corporate_cin['response']['registeredCity']) ? $corporate_cin['response']['registeredCity'] : null,
                                'registeredPincode' => isset($corporate_cin['response']['registeredPincode']) ? $corporate_cin['response']['registeredPincode'] : null,
                                'registeredCountry' => isset($corporate_cin['response']['registeredCountry']) ? $corporate_cin['response']['registeredCountry'] : null,
                                'activeCompliance' => isset($corporate_cin['response']['activeCompliance']) ? $corporate_cin['response']['activeCompliance'] : null,
                                'category' => isset($corporate_cin['response']['category']) ? $corporate_cin['response']['category'] : null,
                                'status' => isset($corporate_cin['response']['status']) ? $corporate_cin['response']['status'] : null,
                                'rocOffice' => isset($corporate_cin['response']['rocOffice']) ? $corporate_cin['response']['rocOffice'] : null,
                                'addressOtherThanRegisteredOffice' => isset($corporate_cin['response']['addressOtherThanRegisteredOffice']) ? $corporate_cin['response']['addressOtherThanRegisteredOffice'] : null,
                                'emailId' => isset($corporate_cin['response']['emailId']) ? $corporate_cin['response']['emailId'] : null,
                                'natureOfBusiness' => isset($corporate_cin['response']['natureOfBusiness']) ? $corporate_cin['response']['natureOfBusiness'] : null,
                                'noOfDirectors' => isset($corporate_cin['response']['noOfDirectors']) ? $corporate_cin['response']['noOfDirectors'] : null,
                                'statusForEfiling' => isset($corporate_cin['response']['statusForEfiling']) ? $corporate_cin['response']['statusForEfiling'] : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($corporate_cin['status']['statusCode']) ? $corporate_cin['status']['statusCode'] : null,
                                'vender_code' => isset($corporate_cin['response']['code']) ? $corporate_cin['response']['code'] : null,
                                'status_code' => 200,
                                'message' => 'Success',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['corporate_cin' => $corporate_cin_details, 'statusCode' => 200, 'success' => true]);
                    } elseif (isset($corporate_cin['response']['code']) && $corporate_cin['response']['code'] == 404 && $corporate_cin['status']['statusCode'] == 200) {
                        $statusCode = 102;
                        $errorMessage = 'company not found';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cin_number) ? $request->cin_number : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($corporate_cin['status']['statusCode']) ? $corporate_cin['status']['statusCode'] : null,
                                'vender_code' => isset($corporate_cin['response']['code']) ? $corporate_cin['response']['code'] : null,
                                'status_code' => 102,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 500);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cin_number) ? $request->cin_number : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($corporate_cin['status']['statusCode']) ? $corporate_cin['status']['statusCode'] : null,
                                'vender_code' => isset($corporate_cin['response']['code']) ? $corporate_cin['response']['code'] : null,
                                'status_code' => 500,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //  return  $errorResponse;
                    if (!empty($errorResponse['status']['statusCode']) && $errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $errorMessage = "CIN Number is invalid! Please enter a valid cin number.";
                        $statusCode = 102;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cin_number) ? $request->cin_number : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                'status_code' => 102,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } elseif (!empty($errorResponse['status']['statusCode']) && $errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 205) {
                        $statusCode = 201;
                        $errorMessage = 'API Failed due to internal error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 201);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cin_number) ? $request->cin_number : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                'status_code' => 201,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 500);
                            }
                            DB::table('corporate_cin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'cin' => isset($request->cin_number) ? $request->cin_number : null,
                                'checkId' => $checkId,
                                'groupId' => $groupId,
                                'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                'status_code' => 500,
                                'message' => 'Failed',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    // CIN verification
    public function corporate_cin(Request $request)
    {
        //  return 'Auto scalling 4 des 2023';
        $statusCode = null;
        $corporate_cin = null;
        $api_id = null;
        if (empty($request->corporate_cin))
            return response()->json(array(['message' => 'CIN number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'cin')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'id_number' => $request->corporate_cin
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post($this->base_url . '/corporate/cin', ['headers' => $headers, 'json' => $body]);
                    $corporate_cin = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //   return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct CIN Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['corporate_cin' => $corporate_cin, 'statusCode' => '200']));
    }

    public function corporate_din(Request $request)
    {
        $statusCode = null;
        $corporate_din = null;
        $api_id = null;
        $hit_limits_exceeded = 0;

        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'id_number' => $request->corporate_din
        ];

        // $accessToken = Auth::user()->access_token;

        // $headers = [
        // 'AccessToken' => $accessToken,
        // ];
        // $body =  [
        // 'corporate_cin' => $request->id_number
        // ];
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'din')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    //$res = $client->post('http://regtechapi.docboyz.in/api/corporate_din',['headers' => $headers, 'json' => $body]);
                    $res = $client->post('https://kyc-api.flowboard.in/api/v1/corporate/din', ['headers' => $headers, 'json' => $body]);
                    $corporate_din = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                    
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct DIN Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet amount.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array(['corporate_din' => $corporate_din, 'statusCode' => '200']));
    }

    // GSTIN verification
    public function corporate_gstin(Request $request)
    {
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;

        if (empty($request->gstin))
            return response()->json(array(['message' => 'GSTIN number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'gstin')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            // 'Authorization' => $this->token,        
            'API-KEY' => $this->api_club_key,
            'Referer' => $this->site_url,
            'Accept' => 'application/json',
        ];

        $body = [
            'gstin' => $request->gstin
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post($this->api_club . '/v1/gstin_info', ['headers' => $headers, 'json' => $body]);
                    $corporate_gstin = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404 || $statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct GSTIN Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['corporate_gstin' => $corporate_gstin, 'statusCode' => '200']));
    }

    public function corporate_gstinnew(Request $request)
    {
        // return $request->gstin;
        $gstno = $request->gstin;
        // return $gstno;
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;

        // if(empty($request->gstin))
        //     return response()->json(array(['message'=>'GSTIN number is required','statusCode'=>'404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'gstin')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            // 'Authorization' => $this->token,        
            // 'API-KEY' => $this->api_club_key,    
            // 'Referer' => $this->site_url,   
            'X-FLYNN-N-USER-TOKEN' => 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJBdXRoIiwidWlkIjoiMzhkNTBjODItNWMxNy00MTZlLThhYTMtZjg1YzM3ODk4NzNkIiwibW9iIjoiKzkxLTk2NjUxODk2MzMiLCJlbWwiOiJ0ZWNoc3VwcG9ydEBkb2Nib3l6LmluIiwiaXNzIjoidi10aGVvIiwibmFtZSI6IlByaXRlc2ggTWVoZXRyZSIsIm9yZ3MiOlsie1wib2lkXCI6XCI4ZDgyMWYyYi1iNDNhLTQ0MDctODdjNy0wZjcxYTFhM2Q5NzNcIixcInByaW1cIjp0cnVlLFwiYWRtXCI6dHJ1ZSxcInNlcnZcIjpbXCJlYXBpXCJdfSJdLCJleHAiOjE2ODI0MjEwNjQsImlhdCI6MTY4MjM5OTQ2NH0.lizIHC2L_lIJCDkjR6RZkTeT5pjG6gDUx2oDyZdZJFKzfUmXSNKSqc5RfwQVgElcL9VMGkUr-wu78Lav934OAf9FSXGo3G-d8XijQ8JfDKjQwX9wOD9CmTsgbGM5TVZFTVR6RmkWd-mZToMF68BGeVu5ehX0uf-TVR1UoUvfgtECi_h61U_l180qAaBBNhwHhKl8nHXPKRlV5GfmzdPzbWG7xOOLGd1CBrUJVSKuG7ka0E--fdBnNHImJMmox4NVdsChDS9l90LqntFwrGgev0XqsIcDRPS8ycrCz1dI_x64-tueRd1P9zHvpB91RhnQTw7t65ay0wm3dGygEf1wRw',
            'X-FLYNN-N-ORG-ID' => '8d821f2b-b43a-4407-87c7-0f71a1a3d973',
            'Accept' => 'application/json',
        ];

        $body = [
            'handle' => "priteshmehetre11@gmail.com",
            'password' => "Pritesh11@docboyz",
            'handleType' => "email",
            'tokenDurationInMins' => 360
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // $corporate_gstin = [];
        // $res = $client->get('https://solo.enriched-api.vayana.com/basic/gstn/v1.0/commonapi/v0.3/search/'.$gstno, ['headers' => $headers]);
        // $corporate_gstinn = json_decode($res->getBody(), true);
        // // $json = json_decode($res->getBody());
        // // $json = '{"name":"John","age":30,"city":"New York"}';
        // // $obj = json_decode($json);
        // // return $obj->name;
        // $jsondata = $corporate_gstinn['data'];
        // // return $jsondata;
        // $json = json_decode($jsondata);
        // // return $json->gstin;
        // $corporate_gstin['response']['gstin'] = $json->gstin;
        // $corporate_gstin['response']['legal_name'] = $json->lgnm;
        // $corporate_gstin['response']['statecode'] = $json->stjCd;
        // $corporate_gstin['response']['reg_date'] = $json->rgdt;
        // $corporate_gstin['response']['ctb'] = $json->ctb;
        // $corporate_gstin['response']['dty'] = $json->dty;
        // $corporate_gstin['response']['nba'] = $json->nba;
        // $corporate_gstin['response']['status'] = $json->sts;
        // $corporate_gstin['response']['last_update'] = $json->lstupdt;
        // $corporate_gstin['response']['business_name'] = $json->tradeNam;
        // $corporate_gstin['response']['state'] = $json->pradr->addr->stcd;
        // $corporate_gstin['response']['district'] = $json->pradr->addr->dst;
        // $corporate_gstin['response']['pincode'] = $json->pradr->addr->pncd;
        // $corporate_gstin['response']['address'] = $json->pradr;
        // $jsonone = json_decode($json->pradr);
        // return $json->pradr->addr->st;
        // return $corporate_gstin;
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // return 'ok';
                    $response = $client->post('https://sandbox.services.vayananet.com/theodore/apis/v1/authtokens', [
                        'json' => $body
                    ]);
                    $tokenresponse = json_decode($response->getBody(), true);
                    if (isset($tokenresponse)) {
                        $corporate_gstin = [];
                        $res = $client->get('https://solo.enriched-api.vayana.com/basic/gstn/v1.0/commonapi/v0.3/search/' . $gstno, ['headers' => $headers]);
                        $corporate_gstinn = json_decode($res->getBody(), true);
                        // $json = json_decode($res->getBody());
                        // $json = '{"name":"John","age":30,"city":"New York"}';
                        // $obj = json_decode($json);
                        // return $obj->name;
                        $jsondata = $corporate_gstinn['data'];
                        // return $jsondata;
                        $json = json_decode($jsondata);
                        // return $json->gstin;
                        $corporate_gstin['response']['gstin'] = $json->gstin;
                        $corporate_gstin['response']['legal_name'] = $json->lgnm;
                        $corporate_gstin['response']['statecode'] = $json->stjCd;
                        $corporate_gstin['response']['reg_date'] = $json->rgdt;
                        $corporate_gstin['response']['ctb'] = $json->ctb;
                        $corporate_gstin['response']['dty'] = $json->dty;
                        $corporate_gstin['response']['nba'] = $json->nba;
                        $corporate_gstin['response']['status'] = $json->sts;
                        $corporate_gstin['response']['last_update'] = $json->lstupdt;
                        $corporate_gstin['response']['business_name'] = $json->tradeNam;
                        $corporate_gstin['response']['state'] = $json->pradr->addr->stcd;
                        $corporate_gstin['response']['district'] = $json->pradr->addr->dst;
                        $corporate_gstin['response']['pincode'] = $json->pradr->addr->pncd;
                        $corporate_gstin['response']['address'] = $json->pradr;
                    }
                    // return $corporate_gstin;

                    // $res = $client->post($this->api_club.'/v1/gstin_info', ['headers' => $headers, 'json' => $body]);
                    // $corporate_gstin = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404 || $statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct GSTIN Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage Your Wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['corporate_gstin' => $corporate_gstin, 'statusCode' => '200']));
    }

    public function corporate_gst_returnOLD(Request $request)
    {
        // return 'test';
        // return $request->gstin;
        $gstno = $request->gstin;
        // return $gstno;
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;

        // if(empty($request->gstin))
        //     return response()->json(array(['message'=>'GSTIN number is required','statusCode'=>'404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'gstin')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // try{
                // return 'ok';
                $client = new Client();
                // $body =  [
                //     'handle' => "pritmehetre20@gmail.com",
                //     'password' => "Pritesh11@docboyz",  
                //     'handleType' => "email",
                //     'tokenDurationInMins' => 360       
                // ];
                // $response = $client -> post('https://sandbox.services.vayananet.com/theodore/apis/v1/authtokens',[
                //     'json' => $body
                // ]);
                // $tokenresponse = json_decode($response->getBody(), true);
                // $headertoken = $tokenresponse['data']['token'];
                $tokenresponse = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJBdXRoIiwidWlkIjoiMmQwMDRiMTUtZWIzZS00MjhjLTlkOTQtMTliNjE0OWM0NjkwIiwibW9iIjoiKzkxLTc3NzY5OTgyMDgiLCJlbWwiOiJwcml0ZXNobWVoZXRyZTExQGdtYWlsLmNvbSIsImlzcyI6InYtdGhlbyIsIm5hbWUiOiJQcml0YW0gTWVoZXRyZSIsIm9yZ3MiOlsie1wib2lkXCI6XCIwMzUwMjczMC1kNWUyLTQ0NDUtYjIxMS04MDdjMTE2NGVkZDRcIixcInByaW1cIjp0cnVlLFwiYWRtXCI6dHJ1ZSxcInNlcnZcIjpbXCJlYXBpXCJdfSJdLCJleHAiOjE2ODI1MDQ0OTMsImlhdCI6MTY4MjQ4Mjg5M30.mxZfjYvjLTxt0UX3Un5gAZN8l2VdfZCmjw23NEJCoPn3DKzTI0mfvgisdn8EkT9UU9th8yz1zHljytDv5nlhaiR95L77GICQIjvyd7CQ7WdZkr-Vzxqhha9TaXFwJByt3tZ9uaBb2MQ3LIjLc58lb-Yt3LzvfLhXUyqrLI7QDqgojSWwARaBpGisUyt43htTud3xkLcuOMl_AHR0HMA787-0QpGzW5g3SzLt8Iiht23NrJCHNRWepAhRLrKEKdpoPKCsosVJAAJAdYvkFHB9owd-sOOl6bn5lpL_GgfmaXuuFvZp5MS-cDfiqt45j8IncVTYbMpXQUEbYCkQeD3X9w";

                if (isset($tokenresponse)) {
                    // return $headertoken;
                    $headers = [
                        'X-FLYNN-N-USER-TOKEN' => 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJBdXRoIiwidWlkIjoiZTA5YjFlMmYtNjM1My00NWRjLTk0OGItNjZhYTEwMjMwOTYzIiwibW9iIjoiKzkxLTk5NzUwNDkxMzQiLCJlbWwiOiJwcml0ZXNoLmNyZWludGVjaEBnbWFpbC5jb20iLCJpc3MiOiJ2LXRoZW8iLCJuYW1lIjoiU2F0aXNoIEdhZGVrYXIiLCJvcmdzIjpbIntcIm9pZFwiOlwiZTI3NjNlMTgtZTA5Mi00YWYyLTg2MjAtMGNjNTc2NDMxYmEwXCIsXCJwcmltXCI6dHJ1ZSxcImFkbVwiOnRydWUsXCJzZXJ2XCI6W1wiZWFwaVwiXX0iXSwiZXhwIjoxNjgyNjk0MTc2LCJpYXQiOjE2ODI2NzI1NzZ9.wAS0PQ6aOhvCrhSvjKsAFIW-JOtwo5RJYlEovC_zf-pBLlixNawL-cHJZaOIDAq4jJd1U7FDT5MQ1eAfsr-1pUeaVI16LXF-SI4_eXlc4AhN6cSlfzigAO4WU9AKiAjqAN5iTJPJJLNQRbhb8NwyQXPt_SjnVQLn0M7fZqZ8wWGscnW1ScGB0hf3w4imLPnxBDqa_HVdSKorkXhcKeyquM_G0VfQBY0UmdRJ4TD9HQv1nEh0TVhL_vHYkYIN1L3JdGy37dCrDeRAJ6hhagXDXJoTvSKFj_UTYkE2RE2xuuzkex7aWqaag1Qv032rfuOoUO6pREnKlkxmOrShZU4JHA',
                        'X-FLYNN-N-ORG-ID' => 'e2763e18-e092-4af2-8620-0cc576431ba0',
                        'X-FLYNN-N-GSTIN' => '27AOZPD0347J1ZL',
                        'Accept' => 'application/json',
                    ];
                    $otpbody = [
                        'gstin' => "27AOZPD0347J1ZL",
                        'username' => "MH_NT2.1635",
                    ];
                    $res = $client->post('https://solo.enriched-api.vayana.com/basic/gstn/v1.0/taxpayerapi/v1.0/authenticate/OTPREQUEST', ['headers' => $headers, 'json' => $otpbody]);
                    $corporate_otp = json_decode($res->getBody(), true);
                    // return $corporate_otp;
                    if (isset($corporate_otp)) {
                        $otpcheackbody = [
                            'otp-request-id' => $corporate_otp['data']['otp-request-id'],
                            'otp' => "575757",
                        ];
                        $ressp = $client->post('https://solo.enriched-api.vayana.com/basic/gstn/v1.0/taxpayerapi/v1.0/authenticate/AUTHTOKEN', ['headers' => $headers, 'json' => $otpcheackbody]);
                        $corporate_otp_cheack = json_decode($ressp->getBody(), true);
                        if (isset($corporate_otp_cheack)) {
                            $gstreturnbody = [

                                "fromRetPeriod" => "112020",
                                "toRetPeriod" => "112020",
                                "returns" => [
                                    "gstr1" => [
                                        "b2b" => true,
                                        "b2ba" => true,
                                        "b2cl" => true,
                                        "b2cla" => true,
                                        "b2cs" => true,
                                        "b2csa" => true,
                                        "cdnr" => true,
                                        "cdnra" => true,
                                        "cdnur" => true,
                                        "cdnura" => true,
                                        "exp" => true,
                                        "expa" => true,
                                        "at" => true,
                                        "ata" => true,
                                        "txp" => true,
                                        "txpa" => true,
                                        "e_invoices_b2b" => true,
                                        "e_invoices_cdnr" => true,
                                        "e_invoices_cdnur" => true,
                                        "e_invoices_exp" => true,
                                        "nil_rated" => true,
                                        "hsn_summary" => true,
                                        "doc_issued" => true,
                                        "summary" => true
                                    ],
                                    "gstr2a" => [
                                        "b2b" => true,
                                        "b2ba" => true,
                                        "cdn" => true,
                                        "cdna" => true,
                                        "isd" => true,
                                        "impg" => true,
                                        "impgsez" => true,
                                        "amdhist" => true
                                    ],
                                    "gstr2b" => [
                                        "alldetails" => true
                                    ],
                                    "gstr3b" => [
                                        "details" => true
                                    ]
                                ],
                                "parameters" => [
                                    "gstr1" => [
                                        "b2b" => [
                                            "optionalParameters" => [
                                                "actionRequired" => "true",
                                                "counterPartyGstin" => "33GSPTN0791G1Z5",
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "b2ba" => [
                                            "optionalParameters" => [
                                                "actionRequired" => "true",
                                                "counterPartyGstin" => "33GSPTN0791G1Z5"
                                            ]
                                        ],
                                        "b2cl" => [
                                            "optionalParameters" => [
                                                "stateCode" => "23"
                                            ]
                                        ],
                                        "b2cla" => [
                                            "optionalParameters" => [
                                                "stateCode" => "23"
                                            ]
                                        ],
                                        "cdnr" => [
                                            "optionalParameters" => [
                                                "actionRequired" => "true",
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "cdnra" => [
                                            "optionalParameters" => [
                                                "actionRequired" => "true"
                                            ]
                                        ],
                                        "e_invoices_b2b" => [
                                            "optionalParameters" => [
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "e_invoices_cdnr" => [
                                            "optionalParameters" => [
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "e_invoices_cdnur" => [
                                            "optionalParameters" => [
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "e_invoices_exp" => [
                                            "optionalParameters" => [
                                                "from" => "01-01-2017"
                                            ]
                                        ]
                                    ],
                                    "gstr2a" => [
                                        "b2b" => [
                                            "optionalParameters" => [
                                                "counterPartyGstin" => "33GSPTN0791G1Z5",
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "b2ba" => [
                                            "optionalParameters" => [
                                                "counterPartyGstin" => "33GSPTN0791G1Z5"
                                            ]
                                        ],
                                        "cdn" => [
                                            "optionalParameters" => [
                                                "counterPartyGstin" => "33GSPTN0791G1Z5",
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "cdna" => [
                                            "optionalParameters" => [
                                                "counterPartyGstin" => "33GSPTN0791G1Z5"
                                            ]
                                        ],
                                        "isd" => [
                                            "optionalParameters" => [
                                                "counterPartyGstin" => "33GSPTN0791G1Z5"
                                            ]
                                        ],
                                        "impg" => [
                                            "optionalParameters" => [
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "impgsez" => [
                                            "optionalParameters" => [
                                                "from" => "01-01-2017"
                                            ]
                                        ],
                                        "amdhist" => [
                                            "mandatoryParameters" => [
                                                "portCode" => "INBLR4",
                                                "billOfEntryNumber" => "8108363",
                                                "dateOfBill" => "01-04-2023"
                                            ],
                                        ]
                                    ]
                                ]
                            ];
                            $response = $client->post('https://solo.enriched-api.vayana.com/enriched/gstn/v1.0/download-gst-returns', ['headers' => $headers, 'json' => $gstreturnbody]);
                            $corporate_gstreturn_cheack = json_decode($response->getBody(), true);
                            if (isset($corporate_gstreturn_cheack)) {
                                $headersss = [
                                    'X-FLYNN-N-USER-TOKEN' => 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJBdXRoIiwidWlkIjoiZTA5YjFlMmYtNjM1My00NWRjLTk0OGItNjZhYTEwMjMwOTYzIiwibW9iIjoiKzkxLTk5NzUwNDkxMzQiLCJlbWwiOiJwcml0ZXNoLmNyZWludGVjaEBnbWFpbC5jb20iLCJpc3MiOiJ2LXRoZW8iLCJuYW1lIjoiU2F0aXNoIEdhZGVrYXIiLCJvcmdzIjpbIntcIm9pZFwiOlwiZTI3NjNlMTgtZTA5Mi00YWYyLTg2MjAtMGNjNTc2NDMxYmEwXCIsXCJwcmltXCI6dHJ1ZSxcImFkbVwiOnRydWUsXCJzZXJ2XCI6W1wiZWFwaVwiXX0iXSwiZXhwIjoxNjgyNjk0MTc2LCJpYXQiOjE2ODI2NzI1NzZ9.wAS0PQ6aOhvCrhSvjKsAFIW-JOtwo5RJYlEovC_zf-pBLlixNawL-cHJZaOIDAq4jJd1U7FDT5MQ1eAfsr-1pUeaVI16LXF-SI4_eXlc4AhN6cSlfzigAO4WU9AKiAjqAN5iTJPJJLNQRbhb8NwyQXPt_SjnVQLn0M7fZqZ8wWGscnW1ScGB0hf3w4imLPnxBDqa_HVdSKorkXhcKeyquM_G0VfQBY0UmdRJ4TD9HQv1nEh0TVhL_vHYkYIN1L3JdGy37dCrDeRAJ6hhagXDXJoTvSKFj_UTYkE2RE2xuuzkex7aWqaag1Qv032rfuOoUO6pREnKlkxmOrShZU4JHA',
                                    'X-FLYNN-N-ORG-ID' => 'e2763e18-e092-4af2-8620-0cc576431ba0',
                                    'X-FLYNN-N-GSTIN' => '27AOZPD0347J1ZL',
                                    'Accept' => 'application/json',
                                ];
                                $taskid = $corporate_gstreturn_cheack['data']['task-id'];
                                // return $taskid;
                                $responsstatus = $client->get('https://solo.enriched-api.vayana.com/enriched/tasks/v1.0/status/' . $taskid, ['headers' => $headersss]);
                                $corporate_gstreturn_status = json_decode($responsstatus->getBody(), true);
                                return $corporate_gstreturn_status;
                            }
                            // ];
                        }
                        return $corporate_gstreturn_status;

                    }
                    return $corporate_gstinn;
                    // $json = json_decode($res->getBody());
                    // $json = '{"name":"John","age":30,"city":"New York"}';
                    // $obj = json_decode($json);
                    // return $obj->name;
                    $jsondata = $corporate_gstinn['data'];
                    // return $jsondata;
                    $json = json_decode($jsondata);
                    // return $json->gstin;
                    $corporate_gstin['response']['gstin'] = $json->gstin;
                    $corporate_gstin['response']['legal_name'] = $json->lgnm;
                    $corporate_gstin['response']['statecode'] = $json->stjCd;
                    $corporate_gstin['response']['reg_date'] = $json->rgdt;
                    $corporate_gstin['response']['ctb'] = $json->ctb;
                    $corporate_gstin['response']['dty'] = $json->dty;
                    $corporate_gstin['response']['nba'] = $json->nba;
                    $corporate_gstin['response']['status'] = $json->sts;
                    $corporate_gstin['response']['last_update'] = $json->lstupdt;
                    $corporate_gstin['response']['business_name'] = $json->tradeNam;
                    $corporate_gstin['response']['state'] = $json->pradr->addr->stcd;
                    $corporate_gstin['response']['district'] = $json->pradr->addr->dst;
                    $corporate_gstin['response']['pincode'] = $json->pradr->addr->pncd;
                    $corporate_gstin['response']['address'] = $json->pradr;
                }
                // return $corporate_gstin;

                // $res = $client->post($this->api_club.'/v1/gstin_info', ['headers' => $headers, 'json' => $body]);
                // $corporate_gstin = json_decode($res->getBody(), true);
                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }
                }
                // } catch(BadResponseException $e) {
                //     $statusCode = $e->getResponse()->getStatusCode();
                //     if($statusCode == 500){
                //         $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                //         if($user->role_id==1) {
                //             $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                //         }
                //     }else if($statusCode == 404 || $statusCode == 422){
                //         $statusCode = 102;
                //         $errorMessage = 'Verification Failed. Please enter correct GSTIN Number.';
                //         if($user->role_id==1) {
                //             if($apiamster) {
                //                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                //             }
                //         }
                //     }else{
                //         $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                //         if($user->role_id==1) {
                //             if($apiamster) {
                //                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                //             }
                //         }
                //     }
                //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                // }
            } else {
                return response()->json(['statusCode' => 500, 'message' => "Please recharage your wallet."]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['corporate_gstin' => $corporate_gstin, 'statusCode' => '200']));
    }
    public function corporate_gst_requestotp(Request $request)
    {
        // return 'testnow';
        // return $request->username;
        $gstno = $request->gstin;
        $username = $request->username;
        // return $gstno;
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;

        // if(empty($request->gstin))
        //     return response()->json(array(['message'=>'GSTIN number is required','statusCode'=>'404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'gstinreturn')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $tokenresponse = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJBdXRoIiwidWlkIjoiNmNiYTA2NmYtYTAxMC00ODJhLWFhZGMtMGMwZWFmZTJkMTUxIiwibW9iIjoiKzkxLTg0NzAwNjc1NTUiLCJlbWwiOiJ6YXBmaW50ZWtAZ21haWwuY29tIiwiaXNzIjoidi10aGVvIiwibmFtZSI6IlphcGZpbiAgVGVrbm9sb2dpZXMiLCJvcmdzIjpbIntcIm9pZFwiOlwiOTEwNzgyYWMtMTExMy00MzMyLWExMmItYjM0ZmMxMDE5N2Y4XCIsXCJwcmltXCI6dHJ1ZSxcImFkbVwiOnRydWUsXCJzZXJ2XCI6W1widnNcIixcImdzcFwiLFwiZWFwaVwiXX0iXSwiZXhwIjoxNjgzMTEwOTE4LCJpYXQiOjE2ODMwODkzMTh9.cZJHwzehH5lTC41J3-OglEm8E180NgcXaIRwVXvWKz3yFl34YfWRlSF_TvJNiiOMwvvTP-fAIahdBvTw1Q-VIIPL1LRzUs8X80MgMmMlBCtKAXzX_ywukZGAdKH1WQvSn_o3MVCNdDKIxCQn2sgZAyAumI-9xQR5DJ2HIVuOCC13JRei2gWb9Whj1jvFQWG-6t8vghCNahyN2TxLQvoPVfRodb7m5dC_3GnLDi5kC-c5ezzB0a5Og99lb77xexgaX_6j5_4rQyH4CC3_r7ljTbspw2liVPtBzd9Z3eyvOTmnI22C1zseI7D-mtZlmxAcpFj1PeAZUTRTXvSTZM9PUgOduIzmoXthIwyKpv_Rzcwi4BQsuIdkpDdpJjiTAQt9MAZD4vbNR_roYYydvK2Oyj1dD8BYgT-PQ559YPpKPIpsgI6GxPUmG5vuqXCIFkar1-mAqyIVqobbqcba3062c97u9Jyk9ScS3_7eTu4DnpFJySDo8xyGGhIs2VHbg3hOSXNLCm40ueBgq2wyEIgDeG0Y1f7s36IYa8XJfeg5kIjE4KAZ6e9jrQwb-cCldP7jllpJgqnRwP4Hq6Feq1t2K9jni51g9GEVOKv-P5ooxul4bIhNu6M7mXbpOqbzy4HXzQXfIdN8Cb2WPSfCNkTaXM27gy3E3f0x9Yu5sEVd9Qs";

                    if (isset($tokenresponse)) {
                        // return $headertoken;
                        $client = new Client();
                        $headers = [
                            'X-FLYNN-N-USER-TOKEN' => 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJBdXRoIiwidWlkIjoiNmNiYTA2NmYtYTAxMC00ODJhLWFhZGMtMGMwZWFmZTJkMTUxIiwibW9iIjoiKzkxLTg0NzAwNjc1NTUiLCJlbWwiOiJ6YXBmaW50ZWtAZ21haWwuY29tIiwiaXNzIjoidi10aGVvIiwibmFtZSI6IlphcGZpbiAgVGVrbm9sb2dpZXMiLCJvcmdzIjpbIntcIm9pZFwiOlwiOTEwNzgyYWMtMTExMy00MzMyLWExMmItYjM0ZmMxMDE5N2Y4XCIsXCJwcmltXCI6dHJ1ZSxcImFkbVwiOnRydWUsXCJzZXJ2XCI6W1widnNcIixcImdzcFwiLFwiZWFwaVwiXX0iXSwiZXhwIjoxNjgzMjg1MzUwLCJpYXQiOjE2ODMyNjM3NTB9.gHfbRXg8IBzLL8RvDyCVpGLOcSgu6qmkczATaMrgzgJnWOE38t4X0SZttF0pw9wK5b5fGHdYUlI5uRlJT4iRYAgdSvs8zfD3QCa1DxoQqafonKhgF4fsZKB561cxFLmm-U6GU_mNHHYiavpcM8pvqsaQAFychdWedffyjytHE95JfpgOAI9E49luvoRM67A2mKQXKlVS1iO_zsbVEdNMQ_mXBANfUAX6KDndCDHigFkppqt0GhBVs5RSjl_rQ5Du0qklL6cBTrhsL_ELliQjb9_USxmagx7szTBIy37KXFePMmVeBXzPiBRWTUXX2aTOAK7rq8zFMYHDmcDaKL0vrt5eEaOWHEj8KkDe7viWWqwXifefNWlQtYXfjANhl-maGgbaJ-kqtn40wNmeaihW5FVQYij8ifIQuITob_V4M_CUpuTu-rwz6Fna6A3t6zE68wq4RbW91slWzeF6yMKwZhrxKiar-IpE_JsMEZdtWyKw69ruWgu0GPNngkE2XKUZ9TcjUn2XOlz8xibx-PGWDCfaemGukycGfj5dstKf0kPT9KDvKFqCuwR2IJZJ_lqXtRNmrskOw1DJNiSS4blEOjTW7NwpdQmTmQ18bA87xI3gPAMg8Vdl1FBJxDP2YahmjQE4UiOeSNmWJVd9ePYyWJH3Qu4qMYCh8Rq1fu9m3nY',
                            'X-FLYNN-N-ORG-ID' => '910782ac-1113-4332-a12b-b34fc10197f8',
                            'X-FLYNN-N-GSTIN' => $gstno,
                            'Accept' => 'application/json',
                        ];
                        $otpbody = [
                            'gstin' => $gstno,
                            'username' => $username,
                        ];
                        $res = $client->post('https://live.enriched-api.vayana.com/basic/gstn/v1.0/taxpayerapi/v1.0/authenticate/OTPREQUEST', ['headers' => $headers, 'json' => $otpbody]);
                        $corporate_otp = json_decode($res->getBody(), true);
                        if (isset($corporate_otp)) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                            }
                            return response()->json(['statusCode' => 200, 'data' => $corporate_otp['data']]);
                        } else {
                            return response()->json(['statusCode' => 404, 'data' => $corporate_otp]);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404 || $statusCode == 400) {
                        $statusCode = 400;
                        $errorMessage = 'err-otp-already-requested';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }

            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['corporate_gstin' => $corporate_gstin, 'statusCode' => '200']));
    }
    public function gst_authentication(Request $request)
    {
        // return 'true';
        $gstno = $request->gstin;
        $otp = $request->otp;
        $otp_request_id = $request->otp_request_id;
        // return $gstno;
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;
        // if(empty($request->gstin))
        //     return response()->json(array(['message'=>'GSTIN number is required','statusCode'=>'404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'gstinreturn')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

                $client = new Client();
                $headers = [
                    'X-FLYNN-N-USER-TOKEN' => 'eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJzdWIiOiJBdXRoIiwidWlkIjoiNmNiYTA2NmYtYTAxMC00ODJhLWFhZGMtMGMwZWFmZTJkMTUxIiwibW9iIjoiKzkxLTg0NzAwNjc1NTUiLCJlbWwiOiJ6YXBmaW50ZWtAZ21haWwuY29tIiwiaXNzIjoidi10aGVvIiwibmFtZSI6IlphcGZpbiAgVGVrbm9sb2dpZXMiLCJvcmdzIjpbIntcIm9pZFwiOlwiOTEwNzgyYWMtMTExMy00MzMyLWExMmItYjM0ZmMxMDE5N2Y4XCIsXCJwcmltXCI6dHJ1ZSxcImFkbVwiOnRydWUsXCJzZXJ2XCI6W1widnNcIixcImdzcFwiLFwiZWFwaVwiXX0iXSwiZXhwIjoxNjgzMjg1MzUwLCJpYXQiOjE2ODMyNjM3NTB9.gHfbRXg8IBzLL8RvDyCVpGLOcSgu6qmkczATaMrgzgJnWOE38t4X0SZttF0pw9wK5b5fGHdYUlI5uRlJT4iRYAgdSvs8zfD3QCa1DxoQqafonKhgF4fsZKB561cxFLmm-U6GU_mNHHYiavpcM8pvqsaQAFychdWedffyjytHE95JfpgOAI9E49luvoRM67A2mKQXKlVS1iO_zsbVEdNMQ_mXBANfUAX6KDndCDHigFkppqt0GhBVs5RSjl_rQ5Du0qklL6cBTrhsL_ELliQjb9_USxmagx7szTBIy37KXFePMmVeBXzPiBRWTUXX2aTOAK7rq8zFMYHDmcDaKL0vrt5eEaOWHEj8KkDe7viWWqwXifefNWlQtYXfjANhl-maGgbaJ-kqtn40wNmeaihW5FVQYij8ifIQuITob_V4M_CUpuTu-rwz6Fna6A3t6zE68wq4RbW91slWzeF6yMKwZhrxKiar-IpE_JsMEZdtWyKw69ruWgu0GPNngkE2XKUZ9TcjUn2XOlz8xibx-PGWDCfaemGukycGfj5dstKf0kPT9KDvKFqCuwR2IJZJ_lqXtRNmrskOw1DJNiSS4blEOjTW7NwpdQmTmQ18bA87xI3gPAMg8Vdl1FBJxDP2YahmjQE4UiOeSNmWJVd9ePYyWJH3Qu4qMYCh8Rq1fu9m3nY',
                    'X-FLYNN-N-ORG-ID' => '910782ac-1113-4332-a12b-b34fc10197f8',
                    'X-FLYNN-N-GSTIN' => $gstno,
                    'Accept' => 'application/json',
                ];
                $statuscheack = DB::table('gstin_return')->where('gst_no', $gstno)->where('user_id', $user->id)->get();

                if (count($statuscheack) == 0) {
                    try {
                        $otpcheackbody = [
                            'otp-request-id' => $otp_request_id,
                            'otp' => $otp,
                        ];
                        $ressp = $client->post('https://live.enriched-api.vayana.com/basic/gstn/v1.0/taxpayerapi/v1.0/authenticate/AUTHTOKEN', ['headers' => $headers, 'json' => $otpcheackbody]);
                        $corporate_otp_cheack = json_decode($ressp->getBody(), true);
                        // return $corporate_otp_cheack;
                        // if($corporate_otp_cheack){
                        // return 'ok';
                        $gstreturnbody = [

                            "fromRetPeriod" => "112020",
                            "toRetPeriod" => "112020",
                            "returns" => [
                                "gstr1" => [
                                    "b2b" => true,
                                    "b2ba" => true,
                                    "b2cl" => true,
                                    "b2cla" => true,
                                    "b2cs" => true,
                                    "b2csa" => true,
                                    "cdnr" => true,
                                    "cdnra" => true,
                                    "cdnur" => true,
                                    "cdnura" => true,
                                    "exp" => true,
                                    "expa" => true,
                                    "at" => true,
                                    "ata" => true,
                                    "txp" => true,
                                    "txpa" => true,
                                    "e_invoices_b2b" => true,
                                    "e_invoices_cdnr" => true,
                                    "e_invoices_cdnur" => true,
                                    "e_invoices_exp" => true,
                                    "nil_rated" => true,
                                    "hsn_summary" => true,
                                    "doc_issued" => true,
                                    "summary" => true
                                ],
                                "gstr2a" => [
                                    "b2b" => true,
                                    "b2ba" => true,
                                    "cdn" => true,
                                    "cdna" => true,
                                    "isd" => true,
                                    "impg" => true,
                                    "impgsez" => true,
                                    "amdhist" => true
                                ],
                                "gstr2b" => [
                                    "alldetails" => true
                                ],
                                "gstr3b" => [
                                    "details" => true
                                ]
                            ],
                            "parameters" => [
                                "gstr1" => [
                                    "b2b" => [
                                        "optionalParameters" => [
                                            "actionRequired" => "true",
                                            "counterPartyGstin" => "33GSPTN0791G1Z5",
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "b2ba" => [
                                        "optionalParameters" => [
                                            "actionRequired" => "true",
                                            "counterPartyGstin" => "33GSPTN0791G1Z5"
                                        ]
                                    ],
                                    "b2cl" => [
                                        "optionalParameters" => [
                                            "stateCode" => "23"
                                        ]
                                    ],
                                    "b2cla" => [
                                        "optionalParameters" => [
                                            "stateCode" => "23"
                                        ]
                                    ],
                                    "cdnr" => [
                                        "optionalParameters" => [
                                            "actionRequired" => "true",
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "cdnra" => [
                                        "optionalParameters" => [
                                            "actionRequired" => "true"
                                        ]
                                    ],
                                    "e_invoices_b2b" => [
                                        "optionalParameters" => [
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "e_invoices_cdnr" => [
                                        "optionalParameters" => [
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "e_invoices_cdnur" => [
                                        "optionalParameters" => [
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "e_invoices_exp" => [
                                        "optionalParameters" => [
                                            "from" => "01-01-2017"
                                        ]
                                    ]
                                ],
                                "gstr2a" => [
                                    "b2b" => [
                                        "optionalParameters" => [
                                            "counterPartyGstin" => "33GSPTN0791G1Z5",
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "b2ba" => [
                                        "optionalParameters" => [
                                            "counterPartyGstin" => "33GSPTN0791G1Z5"
                                        ]
                                    ],
                                    "cdn" => [
                                        "optionalParameters" => [
                                            "counterPartyGstin" => "33GSPTN0791G1Z5",
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "cdna" => [
                                        "optionalParameters" => [
                                            "counterPartyGstin" => "33GSPTN0791G1Z5"
                                        ]
                                    ],
                                    "isd" => [
                                        "optionalParameters" => [
                                            "counterPartyGstin" => "33GSPTN0791G1Z5"
                                        ]
                                    ],
                                    "impg" => [
                                        "optionalParameters" => [
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "impgsez" => [
                                        "optionalParameters" => [
                                            "from" => "01-01-2017"
                                        ]
                                    ],
                                    "amdhist" => [
                                        "mandatoryParameters" => [
                                            "portCode" => "INBLR4",
                                            "billOfEntryNumber" => "8108363",
                                            "dateOfBill" => "01-04-2023"
                                        ],
                                    ]
                                ]
                            ]
                        ];
                        $response = $client->post('https://live.enriched-api.vayana.com/enriched/gstn/v1.0/download-gst-returns', ['headers' => $headers, 'json' => $gstreturnbody]);
                        $corporate_gstreturn_cheack = json_decode($response->getBody(), true);
                        // return $corporate_gstreturn_cheack;
                        if (isset($corporate_gstreturn_cheack)) {

                            $taskid = $corporate_gstreturn_cheack['data']['task-id'];
                            // return $taskid;
                            $responsstatus = $client->get('https://live.enriched-api.vayana.com/enriched/tasks/v1.0/status/' . $taskid, ['headers' => $headers]);
                            $corporate_gstreturn_status = json_decode($responsstatus->getBody(), true);
                            $gstdetails = DB::table('gstin_return')->insert([
                                "gst_no" => $gstno,
                                "user_id" => $user->id,
                                "task_id" => $taskid,
                                "status" => $corporate_gstreturn_status['data']['status'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                            // return $corporate_gstreturn_status;
                            if ($corporate_gstreturn_status['data']['status'] == 'completed') {
                                $responsresultstatus = $client->get('https://live.enriched-api.vayana.com/enriched/tasks/v1.0/result/' . $taskid, ['headers' => $headers]);
                                $corporate_gstreturn_result = json_decode($responsresultstatus->getBody(), true);
                                if ($corporate_gstreturn_result) {
                                    $page = $corporate_gstreturn_result['data']['pages'];
                                    $responsresultstatuspage = $client->get('https://live.enriched-api.vayana.com/enriched/tasks/v1.0/result/' . $taskid . '/page/' . $page, ['headers' => $headers]);
                                    $corporate_gstreturn_resultpage = json_decode($responsresultstatuspage->getBody(), true);
                                    return response()->json(['statusCode' => 200, 'data' => $corporate_gstreturn_resultpage['data']]);
                                    // return $corporate_gstreturn_result;

                                }
                            } else {
                                $statusCode = 102;
                                $errorMessage = 'err-expired-gstn-requested-session';
                                return response()->json(['statusCode' => $statusCode, 'data' => $corporate_gstreturn_status['data']]);
                            }
                        }
                        // ];
                        // }
                    } catch (BadResponseException $e) {
                        // return $e;
                        // $abs = throw new \Exception($error['message'], $error['type'], $error);
                        // return$abs
                        $statusCode = $e->getResponse()->getStatusCode();
                        if ($statusCode == 500) {
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 404 || $statusCode == 400) {
                            $statusCode = 102;
                            $errorMessage = 'err-expired-gstn-requested-session';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }

                } else {
                    $statuscheack = DB::table('gstin_return')->where('gst_no', $gstno)->where('user_id', $user->id)->get();
                    $taskid = $statuscheack[0]->task_id;
                    $responsstatus = $client->get('https://live.enriched-api.vayana.com/enriched/tasks/v1.0/status/' . $taskid, ['headers' => $headers]);
                    $corporate_gstreturn_status = json_decode($responsstatus->getBody(), true);
                    // return $corporate_gstreturn_status;
                    if ($corporate_gstreturn_status['data']['status'] == 'completed') {
                        $responsresultstatus = $client->get('https://live.enriched-api.vayana.com/enriched/tasks/v1.0/result/' . $taskid, ['headers' => $headers]);
                        $corporate_gstreturn_result = json_decode($responsresultstatus->getBody(), true);
                        if ($corporate_gstreturn_result) {
                            $page = $corporate_gstreturn_result['data']['pages'];
                            $responsresultstatuspage = $client->get('https://live.enriched-api.vayana.com/enriched/tasks/v1.0/result/' . $taskid . '/page/' . $page, ['headers' => $headers]);
                            $corporate_gstreturn_resultpage = json_decode($responsresultstatuspage->getBody(), true);
                            return response()->json(['statusCode' => 200, 'data' => $corporate_gstreturn_resultpage['data']]);
                            // return $corporate_gstreturn_result;

                        }

                    } else {
                        $statusCode = 102;
                        $errorMessage = 'err-expired-gstn-requested-session';
                        return response()->json(['statusCode' => $statusCode, 'data' => $corporate_gstreturn_status['data']]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => "Please recharge your wallet."]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function gstin_pan_confidence(Request $request)
    {
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;
        $perc = null;
        $perc1 = null;
        $statePerc = null;
        $cityPerc = null;
        $pincodePerc = null;
        $percent_final = null;

        if (empty($request->gstin))
            return response()->json(array(['message' => 'GSTIN Number is required', 'statusCode' => '404']));

        if (empty($request->mobile_number))
            return response()->json(array(['message' => 'Mobile Number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'gstinconfidence')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            // 'Authorization' => $this->token,        
            'API-KEY' => $this->api_club_key,
            'Referer' => $this->site_url,
            'Accept' => 'application/json',
        ];

        $body = [
            'gstin' => $request->gstin
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post($this->api_club . '/v1/gstin_info', ['headers' => $headers, 'json' => $body]);
                    $corporate_gstin = json_decode($res->getBody(), true);
                    // return $corporate_gstin['code'];
                    if ($corporate_gstin['code'] === '200') {
                        // return '$corporate_gstin';
                        $pan_number = substr($corporate_gstin['response']['gstin'], 2, 10);
                        $headers = [
                            'Authorization' => $this->nsdlToken
                        ];
                        try {
                            $res = $client->post('https://mod5c77zjj.execute-api.ap-south-1.amazonaws.com/loantap/pan', ['headers' => $headers, 'form_params' => ['pancard' => $pan_number]]);
                            $pancard = json_decode($res->getBody(), true);
                            $name = explode(" ", $request->name);
                            $pan_name = explode(" ", $pancard['fullname']);
                            $count = 0;
                            foreach ($name as $nm) {
                                if (str_contains($pancard['fullname'], $nm)) {
                                    $count++;
                                }
                                // $textcmp = similar_text($pancard['fullname'], $nm, $perc);
                            }
                            if ($count == count($pan_name)) {
                                $perc = 100;
                            } else {
                                $perc = (100 / count($pan_name)) * $count;
                            }
                            $address = $corporate_gstin['response']['address']['addr1'] . ',' . $corporate_gstin['response']['address']['addr2'];
                            $textcmp1 = similar_text($request->address, $address, $perc1);
                            $textcmp1 = similar_text($request->state, $corporate_gstin['response']['address']['state'], $statePerc);
                            $textcmp1 = similar_text($request->city, $corporate_gstin['response']['address']['city'], $cityPerc);
                            $textcmp1 = similar_text($request->pincode, $corporate_gstin['response']['address']['pin'], $pincodePerc);

                            $percent_final = ((round($perc, 2) + round($perc1, 2) + round($statePerc, 2) + round($cityPerc, 2) + round($pincodePerc, 2)) / 5) . '%';
                        } catch (BadResponseException $e) {
                            $statusCode = $e->getResponse()->getStatusCode();
                            if ($statusCode == 500) {
                                $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            } else {
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {

                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404 || $statusCode == 422) {

                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct GSTIN Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array(['corporate_gstin' => $corporate_gstin, 'confidence' => $percent_final, 'statusCode' => '200']));
    }

    public function gstin_pan_confidence_new(Request $request)
    {
        // return 'tester';
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;
        $perc = null;
        $perc1 = null;
        $statePerc = null;
        $cityPerc = null;
        $pincodePerc = null;
        $percent_final = null;

        // if(empty($request->gstin))
        //     return response()->json(array(['message'=>'GSTIN Number is required','statusCode'=>'404']));

        // if(empty($request->mobile_number))
        //     return response()->json(array(['message'=>'Mobile Number is required','statusCode'=>'404']));

        // if(!$request->headers->has('AccessToken'))
        //     return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'gstinconfidence')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // return $user->role_id;
        $survayId = '75837';
        $lastResponseId = '312882127';
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // return '$corporate_gstin test';
                    // $res = $client->get('https://api.fieldassist.in/api/V3/Survey/detailedlist?surveyId=758374&lastResponseId=312882127', ['auth' => [
                    //     'FAInternal_11764', 
                    //     '9)W*zY8hfKpP5$knirO*'
                    //  ]]);
                    $res = $client->get('https://api.fieldassist.in/api/V3/Survey/detailedlist?surveyId=758374&l&lastResponseId=312882127', [
                        'auth' => [
                            'FAInternal_11764',
                            '9)W*zY8hfKpP5$knirO*'
                        ],
                        'form_params' => ['surveyId' => $survayId, 'lastResponseId' => $lastResponseId]
                    ]);

                    $gstdetails = json_decode($res->getBody(), true);
                    // return $gstdetails;
                    // return $gstdetails[1]['Responses'][1]['Response'];
                    // for($i=0;$i<count($gstdetails);$i++){
                    //     return 'tester';
                    // }
                    if ($gstdetails) {
                        $confidancedetails = [];
                        for ($i = 0; $i < count($gstdetails); $i++) {

                            $client = new Client();
                            $headers = [
                                // 'Authorization' => $this->token,        
                                'API-KEY' => $this->api_club_key,
                                'Referer' => $this->site_url,
                                'Accept' => 'application/json',
                            ];

                            // return $gstdetails[0]['Responses'][1]['Response'];

                            $body = [
                                'gstin' => $gstdetails[$i]['Responses'][1]['Response']
                            ];

                            try {
                                $res = $client->post($this->api_club . '/v1/gstin_info', ['headers' => $headers, 'json' => $body]);
                                $corporate_gstin = json_decode($res->getBody(), true);
                                if ($corporate_gstin['code'] === '200') {
                                    // return $corporate_gstin;
                                    $pan_number = substr($corporate_gstin['response']['gstin'], 2, 10);

                                    $headers = [
                                        'Authorization' => $this->nsdlToken
                                    ];
                                    try {
                                        $res = $client->post('https://mod5c77zjj.execute-api.ap-south-1.amazonaws.com/loantap/pan', ['headers' => $headers, 'form_params' => ['pancard' => $pan_number]]);
                                        $pancard = json_decode($res->getBody(), true);
                                        $name = explode(" ", $request->name);
                                        $pan_name = explode(" ", $pancard['fullname']);
                                        $count = 0;
                                        foreach ($name as $nm) {
                                            if (str_contains($pancard['fullname'], $nm)) {
                                                $count++;
                                            }
                                            // $textcmp = similar_text($pancard['fullname'], $nm, $perc);
                                        }
                                        if ($count == count($pan_name)) {
                                            $perc = 100;
                                        } else {
                                            $perc = (100 / count($pan_name)) * $count;
                                        }
                                        $address = $corporate_gstin['response']['address']['addr1'] . ',' . $corporate_gstin['response']['address']['addr2'];
                                        $textcmp1 = similar_text($request->address, $address, $perc1);
                                        $textcmp1 = similar_text($request->state, $corporate_gstin['response']['address']['state'], $statePerc);
                                        $textcmp1 = similar_text($request->city, $corporate_gstin['response']['address']['city'], $cityPerc);
                                        $textcmp1 = similar_text($request->pincode, $corporate_gstin['response']['address']['pin'], $pincodePerc);

                                        $percent_final = ((round($perc, 2) + round($perc1, 2) + round($statePerc, 2) + round($cityPerc, 2) + round($pincodePerc, 2)) / 5) . '%';
                                    } catch (BadResponseException $e) {
                                        $statusCode = $e->getResponse()->getStatusCode();
                                        if ($statusCode == 500) {
                                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                        } else {
                                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                        }
                                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                    }
                                }
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                    }
                                }
                            } catch (BadResponseException $e) {
                                $statusCode = $e->getResponse()->getStatusCode();
                                if ($statusCode == 500) {
                                    $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                    if ($user->role_id == 1) {
                                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                    }
                                } else if ($statusCode == 404 || $statusCode == 422) {
                                    $statusCode = 102;
                                    $errorMessage = 'Verification Failed. Please enter correct GSTIN Number.';
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                        }
                                    }
                                } else {
                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                        }
                                    }
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            }

                            if ($percent_final == null) {
                                // return 'test';
                                $body = [
                                    'OutletErpId' => $gstdetails[$i]['OutletErpId'],
                                    'IsKYCVerified' => 'false'
                                ];
                                // return $body;
                                // $OutletErpIds =$gstdetails[$i]['OutletErpId'];
                                // $kycver = 'false';
                                $reswe = $client->post('https://api.fieldassist.in/api/V3/Outlet/UpdateKYCStatus', [
                                    'auth' => [
                                        'FAInternal_11764',
                                        '9)W*zY8hfKpP5$knirO*'
                                    ],
                                    'json' => $body
                                ]);
                                $resgstdetails = json_decode($reswe->getBody(), true);
                                // return $resgstdetails['ERPId'];
                                // $confdetails =  response()->json(['gst_number'=>$gstdetails[$i]['Responses'][1]['Response'],'Status'=>'No','statusCode'=>'200']);
                                // $test = $resgstdetails['ERPId']
                                $confdetails = response()->json(['ERPId' => $resgstdetails['ERPId'], 'Message' => $resgstdetails['Message'], 'ResponseStatus' => $resgstdetails['ResponseStatus']]);
                                array_push($confidancedetails, $confdetails);
                            } else {

                                if ($percent_final < '60%') {
                                    // return '$gstdetails[$i]';
                                    // $confdetails =  response()->json(['gst_number'=>$gstdetails[$i]['Responses'][1]['Response'],'Status'=>'No','statusCode'=>'200']);
                                    // array_push($confidancedetails,$confdetails);
                                    // return response()->json(array(['statusCode'=>'No']));
                                    $body = [
                                        'OutletErpId' => $gstdetails[$i]['OutletErpId'],
                                        'IsKYCVerified' => 'false'
                                    ];
                                    $reswe = $client->post('https://api.fieldassist.in/api/V3/Outlet/UpdateKYCStatus', [
                                        'auth' => [
                                            'FAInternal_11764',
                                            '9)W*zY8hfKpP5$knirO*'
                                        ],
                                        'json' => $body
                                    ]);
                                    $resgstdetails = json_decode($reswe->getBody(), true);
                                    $confdetails = response()->json(['ERPId' => $resgstdetails['ERPId'], 'Message' => $resgstdetails['Message'], 'ResponseStatus' => $resgstdetails['ResponseStatus']]);
                                    array_push($confidancedetails, $confdetails);
                                }

                                $body = [
                                    'OutletErpId' => $gstdetails[$i]['OutletErpId'],
                                    'IsKYCVerified' => 'true'
                                ];
                                $reswe = $client->post('https://api.fieldassist.in/api/V3/Outlet/UpdateKYCStatus', [
                                    'auth' => [
                                        'FAInternal_11764',
                                        '9)W*zY8hfKpP5$knirO*'
                                    ],
                                    'json' => $body
                                ]);
                                $resgstdetails = json_decode($reswe->getBody(), true);
                                // return $resgstdetails['ERPId'];
                                // $confdetails =  response()->json(['gst_number'=>$gstdetails[$i]['Responses'][1]['Response'],'Status'=>'No','statusCode'=>'200']);
                                // $test = $resgstdetails['ERPId']
                                $confdetails = response()->json(['ERPId' => $resgstdetails['ERPId'], 'Message' => $resgstdetails['Message'], 'ResponseStatus' => $resgstdetails['ResponseStatus']]);
                                array_push($confidancedetails, $confdetails);
                            }

                        }

                        return $confidancedetails;
                    }
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {

                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }

            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array(['Status' => 'Invalid Survay Number', 'statusCode' => '200']));
    }

    public function pan_gstin_confidence(Request $request) {
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;
        $perc = null;
        $perc1 = null;
        $statePerc = null;
        $cityPerc = null;
        $pincodePerc = null;
        $percent_final = null;

        if(empty($request->gstin))
            return response()->json(array(['message'=>'GSTIN Number is required','statusCode'=>'404']));

        if(!$request->headers->has('AccessToken'))
            return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken==false)
            return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

        $user = User::where('access_token',$request->header('AccessToken'))->first();
        if($user->role_id==1) {
            $apiamster = ApiMaster::where('api_slug','gstinconfidence')->first();
            if($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            // 'Authorization' => $this->token,        
            'API-KEY' => $this->api_club_key,    
            'Referer' => $this->site_url,    
            'Accept'  => 'application/json',
        ];

        $body =  [
            'gstin' => $request->gstin        
        ];

        $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
        if($updateHitCount || $user->role_id==0){
            try{
                $res = $client->post($this->api_club.'/v1/gstin_info', ['headers' => $headers, 'json' => $body]);
                $corporate_gstin = json_decode($res->getBody(), true);
                if($corporate_gstin){
                    $pan_number = substr($corporate_gstin['response']['gstin'], 2, 10);

                    $headers = [
                        'Authorization' => $this->nsdlToken
                    ];
                    try{
                        $res = $client->post('https://mod5c77zjj.execute-api.ap-south-1.amazonaws.com/loantap/pan', ['headers' => $headers, 'form_params'=> ['pancard'=>$pan_number]]);
                        $pancard = json_decode($res->getBody(), true);
                        $gst_name = explode(" ", $corporate_gstin['response']['legal_name']);
                        $name = explode(" ", $request->name);
                        $pan_name = explode(" ", $pancard['fullname']);
                        $count = 0;
                        $count1 = 0;
                        foreach($gst_name as $nm){
                            if (str_contains($pancard['fullname'], $nm)) { 
                                $count++;
                            }
                        }
                        foreach($name as $nm){
                            if (str_contains($corporate_gstin['response']['legal_name'], $nm)) { 
                                $count1++;
                            }
                        }
                        if($count == count($pan_name)){
                            $perc = 100;
                        }else{
                            $perc = (100 / count($pan_name)) * $count;
                        }

                        $percent_final = (round($perc, 2).'%');
                    } catch(BadResponseException $e) {
                        $statusCode = $e->getResponse()->getStatusCode();
                        if($statusCode == 500){
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        }else{
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        }
                        return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                    }
                }
                if($user->role_id==1) {
                    if($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }
                }
            } catch(BadResponseException $e) {
                $statusCode = $e->getResponse()->getStatusCode();
                if($statusCode == 500){
                    $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                    if($user->role_id==1) {
                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                    }
                }else if($statusCode == 404 || $statusCode == 422){
                    $statusCode = 102;
                    $errorMessage = 'Verification Failed. Please enter correct GSTIN Number.';
                    if($user->role_id==1) {
                        if($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                }else{
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if($user->role_id==1) {
                        if($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                }
                return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
            }
        }else{
            return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array(['corporate_gstin'=>$corporate_gstin, 'confidence'=> $percent_final,'statusCode'=>'200']));
    }

    // License verification
    public function license_validation_old(Request $request)
    {
        $statusCode = null;
        $license_validation = null;
        $api_id = null;

        if (empty($request->license_number))
            return response()->json(array(['message' => 'License number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'license')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'id_number' => $request->license_number,
            'dob' => $request->dob
        ];

        $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post($this->base_url . '/driving-license/driving-license', ['headers' => $headers, 'json' => $body, 'form_params' => ['api_token' => $token]]);
                    $license_validation = json_decode($res->getBody(), true);

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $licensevalidation = DB::table('driving_license')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "client_id" => $license_validation['data']['client_id'],
                            "license_number" => $license_validation['data']['license_number'],
                            "temporary_address" => $license_validation['data']['temporary_address'],
                            "father_or_husband_name" => $license_validation['data']['father_or_husband_name'],
                            "doe" => $license_validation['data']['doe'],
                            "temporary_zip" => $license_validation['data']['temporary_zip'],
                            "permanent_address" => $license_validation['data']['permanent_address'],
                            "doi" => $license_validation['data']['doi'],
                            "dob" => $license_validation['data']['dob'],
                            "permanent_zip" => $license_validation['data']['permanent_zip'],
                            "gender" => $license_validation['data']['gender'],
                            "name" => $license_validation['data']['name'],
                            "state" => $license_validation['data']['state'],
                            "profile_image" => $license_validation['data']['profile_image'],
                            "ola_name" => $license_validation['data']['ola_name'],
                            "initial_doi" => $license_validation['data']['initial_doi'],
                            "ola_code" => $license_validation['data']['ola_code'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Licence Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(["statusCode" => 500, 'message' => "Plase recharage your wallet."]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['license_validation' => $license_validation, 'statusCode' => '200']));
    }

        public function license_validation(Request $request)
    {
        // return 'ok';
        $statusCode = null;
        $license_validation = null;
        $api_id = null;

        if (empty($request->license_number))
            return response()->json(array(['message' => 'License number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'license')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'x-api-key' => $this->api_club_key,
            'Referer' => $this->site_url,
            'accept'=>'application/json'
        ];

        $body = [
            'dl_no' => $request->license_number,
            'dob'=> $request->dob
            // 'cardNumber' => $request->license_number,
            // 'dob' => $request->dob
        ];

        // $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $res = $client->post($this->base_url.'/driving-license/driving-license', ['headers' => $headers, 'json' => $body,'form_params' => ['api_token' => $token]]);
                    // $res = $client->post('https://api.apiclub.in/uat/v1/fetch_dl', ['headers' => $headers, 'json' => $body]);
                    $res = $client->post('https://prod.apiclub.in/api/v1/fetch_dl', ['headers' => $headers, 'json' => $body]);
                    
                    // $res = $client->post('https://api.kyckart.com/api/dl/intermediate', ['headers' => $headers, 'json' => $body]);
                    $license_validation = json_decode($res->getBody(), true);
                    //  return $license_validation;
                    // return $license_validation['response']['license_number'];

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        // $licensevalidation = DB::table('driving_license')->insert([
                        //     "user_id" => $user->id,
                        //     "api_id" => $api_id,
                        //     "client_id"=> $license_validation['response']['request_id'],
                        //     "license_number" => isset($license_validation['response']['license_number']) ? $license_validation['response']['license_number'] : null,
                        //     "temporary_address"=> $license_validation['response']['permanent_address'],
                        //     "father_or_husband_name" => isset($license_validation['response']['father_or_husband_name']) ? $license_validation['response']['father_or_husband_name'] : null,
                        //     "doe"=> $license_validation['response']['non_transport_validity'],
                        //     // "temporary_zip"=> $license_validation['response']['temporary_zip'],
                        //     "permanent_address"=> $license_validation['response']['permanent_address'],
                        //     "doi"=> $license_validation['response']['issue_date'],
                        //     "dob" => $request->dob,
                        //     // "permanent_zip"=> $license_validation['response']['permanent_zip'],
                        //     "gender" => isset($license_validation['response']['gender']) ? $license_validation['response']['gender'] : null,
                        //     "name" => isset($license_validation['response']['holder_name']) ? $license_validation['response']['holder_name'] : null,
                        //     "state" => isset($license_validation['response']['address'][0]['state']) ? $license_validation['response']['address'][0]['state'] : null,
                        //     // "profile_image" => $license_validation['response']['img'],
                        //     // "ola_name"=> $license_validation['response']['ola_name'],
                        //     // "initial_doi"=> $license_validation['response']['initial_doi'],
                        //     // "ola_code"=> $license_validation['response']['ola_code'],
                        //     "created_at" => Carbon::now(),
                        //     "updated_at" => Carbon::now()
                        // ]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Licence Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        // return $license_validation;
        return response()->json(array(['license_validation' => $license_validation, 'statusCode' => '200']));
    }



    public function license_validation18agust2025(Request $request)
    {
        // return 'ok';
        $statusCode = null;
        $license_validation = null;
        $api_id = null;

        if (empty($request->license_number))
            return response()->json(array(['message' => 'License number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'license')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            // 'API-KEY' => $this->api_club_key,   
            // 'Referer' => $this->site_url
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq'
        ];

        $body = [
            // 'dl_no' => $request->license_number,
            // 'dob'=> $request->dob
            'cardNumber' => $request->license_number,
            'dob' => $request->dob
        ];

        $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $res = $client->post($this->base_url.'/driving-license/driving-license', ['headers' => $headers, 'json' => $body,'form_params' => ['api_token' => $token]]);
                    // $res = $client->post('https://api.apiclub.in/uat/v1/fetch_dl', ['headers' => $headers, 'json' => $body]);
                    // $res = $client->post('https://api.apiclub.in/api/v1/fetch_dl', ['headers' => $headers, 'json' => $body]);
                    $res = $client->post('https://api.kyckart.com/api/dl/intermediate', ['headers' => $headers, 'json' => $body]);
                    $license_validation = json_decode($res->getBody(), true);
                    //  return $license_validation;
                    // return $license_validation['response']['license_number'];

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $licensevalidation = DB::table('driving_license')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $license_validation['data']['client_id'],
                            "license_number" => isset($license_validation['response']['dlNumber']) ? $license_validation['response']['dlNumber'] : null,
                            // "temporary_address"=> $license_validation['response']['temporary_address'],
                            "father_or_husband_name" => isset($license_validation['response']['father/husband']) ? $license_validation['response']['father/husband'] : null,
                            // "doe"=> $license_validation['response']['doe'],
                            // "temporary_zip"=> $license_validation['response']['temporary_zip'],
                            // "permanent_address"=> $license_validation['response']['permanent_address'],
                            // "doi"=> $license_validation['response']['doi'],
                            "dob" => $request->dob,
                            // "permanent_zip"=> $license_validation['response']['permanent_zip'],
                            "gender" => isset($license_validation['response']['gender']) ? $license_validation['response']['gender'] : null,
                            "name" => isset($license_validation['response']['name']) ? $license_validation['response']['name'] : null,
                            "state" => isset($license_validation['response']['address'][0]['state']) ? $license_validation['response']['address'][0]['state'] : null,
                            "profile_image" => $license_validation['response']['img'],
                            // "ola_name"=> $license_validation['response']['ola_name'],
                            // "initial_doi"=> $license_validation['response']['initial_doi'],
                            // "ola_code"=> $license_validation['response']['ola_code'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Licence Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['license_validation' => $license_validation, 'statusCode' => '200']));
    }
    public function rc_validation_lite(Request $request)
    {
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;

        if (empty($request->rc_number))
            return response()->json(array(['message' => 'RC number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rclite')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            // 'Authorization' => $this->token,        
            'Accept' => 'application/json',
        ];

        // $body =  [
        //     'id_number' => $request->rc_number
        // ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $rc_validation = [];
                    $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number=' . $request->rc_number, ['headers' => $headers]);
                    $rc_validation1 = json_decode($res->getBody(), true);
                    // $rc_validation1 = json_decode($result['vehicleDetails'], true);

                    // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                    // if($grossWeight){
                    //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                    //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                    //     $checkweight = array();
                    //     $checkweight['tag_class'] = $checkWeight->tag_class;
                    // }else{
                    //     $checkweight['tag_class'] = '';
                    // }

                    // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                    if ($rc_validation1['error_code'] == "SPC-200") {
                        $statusCode = 200;
                        $rc_validation['data']['blacklist_status'] = $rc_validation1['vehicleDetails']['rcBlacklistStatus'];
                        $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['vehicleDetails']['rcChasiNo'];
                        $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['vehicleDetails']['rcEngNo'];
                        $rc_validation['data']['financer'] = $rc_validation1['vehicleDetails']['rcFinancer'];
                        $rc_validation['data']['fit_up_to'] = $rc_validation1['vehicleDetails']['rcFitUpto'];
                        $rc_validation['data']['fuel_type'] = $rc_validation1['vehicleDetails']['rcFuelDesc'];
                        $rc_validation['data']['insurance_upto'] = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                        $rc_validation['data']['registered_at'] = $rc_validation1['vehicleDetails']['rcRegisteredAt'];
                        $rc_validation['data']['maker_description'] = $rc_validation1['vehicleDetails']['rcMakerDesc'];
                        $rc_validation['data']['tax_upto'] = $rc_validation1['vehicleDetails']['rcTaxUpto'];
                        $rc_validation['data']['owner_name'] = $rc_validation1['vehicleDetails']['rcOwnerName'];
                        $rc_validation['data']['registration_date'] = $rc_validation1['vehicleDetails']['rcRegnDt'];
                        $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['vehicleNumber'];
                        $rc_validation['data']['vehicle_category_description'] = $rc_validation1['vehicleDetails']['rcVhClassDesc'];
                        if ($rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA' && Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->isPast() == true) {
                            $rc_validation['data']['rc_status'] = '';
                        } else {
                            $rc_validation['data']['rc_status'] = 'ACTIVE';
                        }

                        // $rc_validation['data']['rc_status'] = $rc_validation1['vehicleDetails']['rcStatus'];
                        // $rc_validation['data']['manufacturing_date'] = $rc_validation1['vehicleDetails']['rcManuMonthYr'];
                        // $rc_validation['data']['seat_capacity'] = $rc_validation1['vehicleDetails']['rcSeatCap'];
                        // $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['vehicleDetails']['rcNpIssuedBy'];
                        // $rc_validation['data']['national_permit_number'] = $rc_validation1['vehicleDetails']['rcNpNo'];
                        // $rc_validation['data']['national_permit_upto'] = $rc_validation1['vehicleDetails']['rcNpUpto'];
                        // $rc_validation['data']['insurance_company'] = $rc_validation1['vehicleDetails']['rcInsuranceComp'];
                        // $rc_validation['data']['insurance_policy_number'] = $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'];
                        // $rc_validation['data']['permit_type'] = $rc_validation1['vehicleDetails']['rcPermitType'];
                        // $rc_validation['data']['permit_valid_from'] = $rc_validation1['vehicleDetails']['rcPermitValidFrom'];
                        // $rc_validation['data']['permit_number'] = $rc_validation1['vehicleDetails']['rcPermitNo'];
                        // $rc_validation['data']['permit_valid_upto'] = $rc_validation1['vehicleDetails']['rcPermitValidUpto'];
                        // $rc_validation['data']['permit_issue_date'] = $rc_validation1['vehicleDetails']['rcPermitIssueDt'];
                        // $rc_validation['data']['noc_details'] = $rc_validation1['vehicleDetails']['rcNocDetails'];
                        // $rc_validation['data']['body_type'] = $rc_validation1['vehicleDetails']['rcBodyTypeDesc'];
                        // $rc_validation['data']['father_name'] = $rc_validation1['vehicleDetails']['rcFName'];
                        // $rc_validation['data']['permanent_address'] = $rc_validation1['vehicleDetails']['rcPermanentAddress'];
                        // $rc_validation['data']['present_address'] = $rc_validation1['vehicleDetails']['rcPresentAddress'];
                        // $rc_validation['data']['pucc_number'] = $rc_validation1['vehicleDetails']['rcPuccNo'];
                        // $rc_validation['data']['pucc_upto'] = $rc_validation1['vehicleDetails']['rcPuccUpto'];
                        // $rc_validation['data']['maker_model'] = $rc_validation1['vehicleDetails']['rcMakerModel'];
                        // $rc_validation['data']['standing_capacity'] = $rc_validation1['vehicleDetails']['rcStandCap'];
                        // $rc_validation['data']['sleeper_capacity'] = $rc_validation1['vehicleDetails']['rcSleeperCap'];
                        // $rc_validation['data']['wheelbase'] = $rc_validation1['vehicleDetails']['rcWheelbase'];
                        // $rc_validation['data']['vehicle_category'] = $rc_validation1['vehicleDetails']['rcVchCatg'];
                        // $rc_validation['data']['mobile_number'] = $rc_validation1['vehicleDetails']['rcMobileNo'];
                        // // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                        // // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                        // $rc_validation['data']['latest_by'] = $rc_validation1['vehicleDetails']['rcStatusAsOn'];
                        // $rc_validation['data']['message_code'] = $rc_validation1['vehicleDetails']['stautsmessage'];
                        // $rc_validation['data']['non_use_to'] = $rc_validation1['vehicleDetails']['rcNonUseTo'];
                        // $rc_validation['data']['non_use_from'] = $rc_validation1['vehicleDetails']['rcNonUseFrom'];
                        // $rc_validation['data']['non_use_status'] = $rc_validation1['vehicleDetails']['rcNonUseStatus'];
                        // $rc_validation['data']['color'] = $rc_validation1['vehicleDetails']['rcColor'];
                        // $rc_validation['data']['owner_number'] = $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'];
                        // $rc_validation['data']['no_cylinders'] = $rc_validation1['vehicleDetails']['rcNoCyl'];
                        // $rc_validation['data']['cubic_capacity'] = $rc_validation1['vehicleDetails']['rcCubicCap'];
                        $rc_validation['status_code'] = 200;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                // "client_id"=> $rc_validation['data']['client_id'],
                                "status_code" => 200,
                                "rc_number" => $rc_validation1['vehicleDetails']['vehicleNumber'],
                                "registration_date" => $rc_validation1['vehicleDetails']['rcRegnDt'],
                                "owner_name" => $rc_validation1['vehicleDetails']['rcOwnerName'],
                                "present_address" => $rc_validation1['vehicleDetails']['rcPresentAddress'],
                                "permanent_address" => $rc_validation1['vehicleDetails']['rcPermanentAddress'],
                                "mobile_number" => $rc_validation1['vehicleDetails']['rcMobileNo'],
                                "vehicle_category" => $rc_validation1['vehicleDetails']['rcVchCatg'],
                                "vehicle_chasi_number" => $rc_validation1['vehicleDetails']['rcChasiNo'],
                                "vehicle_engine_number" => $rc_validation1['vehicleDetails']['rcEngNo'],
                                "maker_description" => $rc_validation1['vehicleDetails']['rcMakerDesc'],
                                "maker_model" => $rc_validation1['vehicleDetails']['rcMakerModel'],
                                "body_type" => $rc_validation1['vehicleDetails']['rcBodyTypeDesc'],
                                "fuel_type" => $rc_validation1['vehicleDetails']['rcFuelDesc'],
                                "color" => $rc_validation1['vehicleDetails']['rcColor'],
                                "norms_type" => $rc_validation1['vehicleDetails']['rcNormsDesc'],
                                "fit_up_to" => $rc_validation1['vehicleDetails']['rcFitUpto'],
                                "financer" => $rc_validation1['vehicleDetails']['rcFinancer'],
                                "insurance_company" => $rc_validation1['vehicleDetails']['rcInsuranceComp'],
                                "insurance_policy_number" => $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'],
                                "insurance_upto" => $rc_validation1['vehicleDetails']['rcInsuranceUpto'],
                                "manufacturing_date" => $rc_validation1['vehicleDetails']['rcManuMonthYr'],
                                "registered_at" => $rc_validation1['vehicleDetails']['rcRegisteredAt'],
                                "less_info" => 1,
                                "cubic_capacity" => $rc_validation1['vehicleDetails']['rcCubicCap'],
                                "vehicle_gross_weight" => $rc_validation1['vehicleDetails']['rcGvw'],
                                "no_cylinders" => $rc_validation1['vehicleDetails']['rcNoCyl'],
                                "seat_capacity" => $rc_validation1['vehicleDetails']['rcSeatCap'],
                                "sleeper_capacity" => $rc_validation1['vehicleDetails']['rcSleeperCap'],
                                "standing_capacity" => $rc_validation1['vehicleDetails']['rcStandCap'],
                                "wheelbase" => $rc_validation1['vehicleDetails']['rcWheelbase'],
                                "unladen_weight" => $rc_validation1['vehicleDetails']['rcUnldWt'],
                                "vehicle_category_description" => $rc_validation1['vehicleDetails']['rcVhClassDesc'],
                                "pucc_number" => $rc_validation1['vehicleDetails']['rcPuccNo'],
                                "pucc_upto" => $rc_validation1['vehicleDetails']['rcPuccUpto'],
                                'hit_month' => date('Y-m'),
                                // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                    } else {
                        if (isset($rc_validation['message']) && $rc_validation['message'] != 'success') {
                            if ($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500) {
                                // $statusCode = 101;
                                // $errorMessage = 'RC Number in Multiple RTOs.';
                                // }else if($rc_validation['reponseCode'] == 502){
                                $statusCode = 102;
                                $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                            } else {
                                $statusCode = 404;
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                            }
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    "status_code" => $statusCode,
                                    "rc_number" => $request->rc_number,
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }
                } catch (\GuzzleHttp\Exception\RequestException $e) {
                    $response = $e->getResponse();
                    $status = json_decode((string) $response->getBody());
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500 || $statusCode == 401) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 403) {
                        if ($status->message_code == 'multiple_rto') {
                            $statusCode = 101;
                            $errorMessage = 'RC Number in Multiple RTOs.';
                        } else {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                        }
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    if ($user->role_id == 1) {
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "status_code" => $statusCode,
                            "rc_number" => $request->rc_number,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
    }
    public function rc_check(Request $request)

    {
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $apiamster = null;
        $service_provider = 'KycKart';

        if (empty($request->rc_number)) {
            return response()->json(['statusCode' => '404', 'message' => 'RC number is required']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['statusCode' => '404', 'message' => 'Header Access Token is required']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rc')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $rcNumber = str_replace('-', '', $request->rc_number);
                $subString = strtoupper(substr($rcNumber, 0, 2));
                $groupId = rand(100, 10000000000);
                $checkId = rand(100, 10000000000);
                if ($subString == 'AP' || $subString == 'AR' || $subString == 'AS' || $subString == 'BR' || $subString == 'CG' || $subString == 'GA' || $subString == 'GJ' || $subString == 'HR' || $subString == 'HP' || $subString == 'JH' || $subString == 'KA' || $subString == 'KL' || $subString == 'MP' || $subString == 'MH' || $subString == 'MN' || $subString == 'ML' || $subString == 'MZ' || $subString == 'NL' || $subString == 'OD' || $subString == 'PB' || $subString == 'RJ' || $subString == 'SK' || $subString == 'TN' || $subString == 'TR' || $subString == 'UP' || $subString == 'UK' || $subString == 'UA' || $subString == 'WB' || $subString == 'TS' || $subString == 'AN' || $subString == 'CH' || $subString == 'DN' || $subString == 'DD' || $subString == 'JK' || $subString == 'LA' || $subString == 'LD' || $subString == 'DL' || $subString == 'PY') {
                    $currentMonth = date('Y-m');
                    // $rcdata = DB::table('rcvalidation')
                    //     ->where('rc_number', $rcNumber)
                    //     ->where('hit_month', $currentMonth)
                    //     ->where('status_code', '200')
                    //     ->orderby('id', 'DESC')
                    //     ->first();
                    $databasedata = 0;
                    try {
                        $client = new Client();
                        $headers = [
                            'Accept' => 'application/json',
                            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
                        ];
                        $body = [
                            'vehicleNumber' => $request->rc_number,
                            'groupId' => $groupId,
                            'checkId' => $checkId,
                        ];
                        $rc_validation = [];
                        $rs_userdetails = [];
                        $response = $client->post('https://api.kyckart.com/api/vehicle-registration/searchv4', [
                            'headers' => $headers,
                            'json' => $body,
                        ]);
                        $rc_validation_response = json_decode($response->getBody(), true);
                        // return $rc_validation_response;
                        $data_user = ['number', 'owner', 'ownerNumber', 'permanentAddress', 'chassis', 'policyNumber'];


                        // return count($dataArray);
                        if ($rc_validation_response['status']['statusCode'] == 200 && $rc_validation_response['response']['code'] == 200) {

                            $rc_validation['data']['client_id'] = null;
                            $rc_validation['data']['client_id'] = null;
                            // $rc_validation['data']['transaction_id'] = $rc_validation_response['status']['transactionId'];
                            $rc_validation['data']['rc_number'] = $rc_validation_response['response']['registrationDetail']['number'];
                            $rc_validation['data']['registration_date'] = $rc_validation_response['response']['registrationDetail']['date'];
                            // $rc_validation['data']['registration_expiry_date'] = $rc_validation_response['response']['registrationDetail']['expiryDate'];

                            $rc_validation['data']['owner_name'] = $rc_validation_response['response']['owner'];
                            $rc_validation['data']['owner_number'] = $rc_validation_response['response']['ownerNumber'];
                            $rc_validation['data']['father_name'] = $rc_validation_response['response']['ownerFathersName'];
                            $rc_validation['data']['present_address'] = $rc_validation_response['response']['presentAddress'];
                            $rc_validation['data']['permanent_address'] = $rc_validation_response['response']['permanentAddress'];
                            $rc_validation['data']['mobile_number'] = null;
                            $rc_validation['data']['vehicle_category'] = $rc_validation_response['response']['vehicle']['category'];
                            $rc_validation['data']['vehicle_chasi_number'] = $rc_validation_response['response']['vehicle']['chassis'];
                            $rc_validation['data']['vehicle_engine_number'] = $rc_validation_response['response']['vehicle']['engine'];
                            $rc_validation['data']['maker_description'] = null;
                            $rc_validation['data']['maker_model'] = $rc_validation_response['response']['vehicle']['modelName'];
                            // $rc_validation['data']['vehicle_mmv'] = $rc_validation_response['response']['vehicle']['vehicleMMV'];

                            //  $rc_validation['data']['vehicle_class'] = $rc_validation_response['response']['vehicle']['class'];
                            // $rc_validation['data']['maker_name'] = $rc_validation_response['response']['vehicle']['companyName'];
                            $rc_validation['data']['body_type'] = $rc_validation_response['response']['vehicle']['bodyType'];
                            $rc_validation['data']['fuel_type'] = $rc_validation_response['response']['vehicle']['fuelType'];
                            $rc_validation['data']['color'] = $rc_validation_response['response']['vehicle']['color'];
                            $rc_validation['data']['norms_type'] = null;
                            // $rc_validation['data']['norms_desc'] = $rc_validation_response['response']['vehicle']['normsDesc'];
                            $rc_validation['data']['fit_up_to'] = null;
                            $rc_validation['data']['financer'] = $rc_validation_response['response']['hypotecationDetail']['financier'];
                            // $rc_validation['data']['is_financed'] = $rc_validation_response['response']['hypotecationDetail']['isFinanced'];
                            $rc_validation['data']['insurance_company'] = $rc_validation_response['response']['insurance']['company'];
                            $rc_validation['data']['insurance_policy_number'] = $rc_validation_response['response']['insurance']['policyNumber'];
                            $rc_validation['data']['insurance_upto'] = null;
                            // $rc_validation['data']['insurance_valid_till_date'] = $rc_validation_response['response']['insurance']['validTill'];
                            $rc_validation['data']['manufacturing_date'] = $rc_validation_response['response']['vehicle']['manufacturingDate'];
                            $rc_validation['data']['registered_at'] = null;
                            $rc_validation['data']['less_info'] = null;
                            $rc_validation['data']['cubic_capacity'] = $rc_validation_response['response']['vehicle']['cubicCapacity'];
                            $rc_validation['data']['vehicle_gross_weight'] = $rc_validation_response['response']['vehicle']['grossWeight'];

                            $rc_validation['data']['no_cylinders'] = $rc_validation_response['response']['vehicle']['noCyl'];
                            $rc_validation['data']['seat_capacity'] = $rc_validation_response['response']['vehicle']['seatCap'];
                            $rc_validation['data']['sleeper_capacity'] = $rc_validation_response['response']['vehicle']['sleeperCapacity'];
                            $rc_validation['data']['standing_capacity'] = $rc_validation_response['response']['vehicle']['standingCap'];

                            // $rc_validation['data']['rc_standard_capacity'] = $rc_validation_response['response']['vehicle']['rcStandardCap'];
                            $rc_validation['data']['wheelbase'] = $rc_validation_response['response']['vehicle']['wheelBase'];
                            $rc_validation['data']['unladen_weight'] = $rc_validation_response['response']['vehicle']['unladenWeight'];
                            $rc_validation['data']['vehicle_category_description'] = null;
                            $rc_validation['data']['pucc_number'] = $rc_validation_response['response']['pucc']['number'];
                            if (isset($rc_validation_response['response']['pucc']['upto']) && $rc_validation_response['response']['pucc']['upto'] != null && $rc_validation_response['response']['pucc']['upto'] != 'null' && $rc_validation_response['response']['pucc']['upto'] != 'NA') {
                                // $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vtpucc']['pucc_upto'])->format('Y-m-d');
                                $rc_validation['data']['pucc_upto'] = $rc_validation_response['response']['pucc']['upto'];
                            } else {
                                $rc_validation['data']['pucc_upto'] = $rc_validation_response['response']['pucc']['upto'];
                            }
                            // $rc_validation['data']['is_commercial'] = $rc_validation_response['response']['isCommercial'];
                            $rc_validation['data']['masked_name'] = null;
                            $rc_validation['data']['permit_issue_date'] = $rc_validation_response['response']['permitDetails']['permitIssueDate'];
                            $rc_validation['data']['permit_number'] = $rc_validation_response['response']['permitDetails']['permitNumber'];
                            $rc_validation['data']['permit_type'] = $rc_validation_response['response']['permitDetails']['permitType'];
                            $rc_validation['data']['permit_valid_from'] = $rc_validation_response['response']['permitDetails']['permitValidFrom'];
                            $rc_validation['data']['permit_valid_upto'] = $rc_validation_response['response']['permitDetails']['nationalPermitUpto'];
                            $rc_validation['data']['national_permit_issued_by'] = $rc_validation_response['response']['permitDetails']['nationalPermitIssuedBy'];
                            $rc_validation['data']['national_permit_number'] = $rc_validation_response['response']['permitDetails']['nationalPermitNumber'];
                            $rc_validation['data']['national_permit_upto'] = $rc_validation_response['response']['permitDetails']['nationalPermitUpto'];
                            $rc_validation['data']['blacklist_status'] = $rc_validation_response['response']['registrationDetail']['blacklistStatus'];
                            $rc_validation['data']['blacklist_details'] = $rc_validation_response['response']['registrationDetail']['blacklistDetails'];
                            $rc_validation['data']['rto_code'] = $rc_validation_response['response']['registrationDetail']['RTOCode'];
                            $rc_validation['data']['latest_by'] = $rc_validation_response['response']['registrationDetail']['rcStatusAsOn'];
                            $rc_validation['data']['tax_upto'] = $rc_validation_response['response']['registrationDetail']['taxUpto'];
                            $rc_validation['data']['noc_details'] = $rc_validation_response['response']['registrationDetail']['nocDetails'];
                            $rc_validation['data']['number'] = $rc_validation_response['response']['registrationDetail']['number'];
                            $rc_validation['data']['rc_status'] = $rc_validation_response['response']['registrationDetail']['rcStatus'];
                            $rc_validation['data']['authority'] = $rc_validation_response['response']['registrationDetail']['authority'];
                            $rc_validation['data']['non_use_to'] = $rc_validation_response['response']['nonUseDetails']['nonUseTo'];
                            $rc_validation['data']['non_use_from'] = $rc_validation_response['response']['nonUseDetails']['nonUseFrom'];
                            $rc_validation['data']['non_use_status'] = $rc_validation_response['response']['nonUseDetails']['nonUseStatus'];
                            // return $rc_validation['data'][$dataid]
                            $data_user1 = UserSchemeMaster::where('user_id', $user->id)
                                ->where('api_id', '')
                                ->orderBy('id', 'desc')
                                ->pluck('permission');

                            if (count($data_user1) > 0) {
                                $dataArray = explode(',', $data_user1[0]);
                                foreach ($dataArray as $dataid) {
                                    $rs_userdetails['data'][$dataid] = $rc_validation['data'][$dataid];
                                }
                                return response()->json(['rc_validation' => $rs_userdetails, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => "success"]);
                            }


                            // return $rc_validation;

                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'client_id' => null,
                                    'transaction_id' => $rc_validation_response['status']['transactionId'],
                                    'status_code' => 200,
                                    'rc_number' => $rc_validation_response['response']['registrationDetail']['number'],
                                    'rc_status' => $rc_validation_response['response']['registrationDetail']['rcStatus'],
                                    'owner_number' => $rc_validation_response['response']['ownerNumber'],
                                    'tax_upto' => $rc_validation_response['response']['registrationDetail']['taxUpto'],
                                    'blacklist_status' => $rc_validation_response['response']['registrationDetail']['blacklistStatus'],
                                    'father_name' => $rc_validation_response['response']['ownerFathersName'],
                                    'registration_date' => $rc_validation['data']['registration_date'],
                                    'owner_name' => $rc_validation['data']['owner_name'],
                                    'present_address' => $rc_validation['data']['present_address'],
                                    'permanent_address' => $rc_validation['data']['permanent_address'],
                                    'mobile_number' => null,
                                    'vehicle_category' => $rc_validation['data']['vehicle_category'],
                                    'vehicle_chasi_number' => $rc_validation['data']['vehicle_chasi_number'],
                                    'vehicle_engine_number' => $rc_validation['data']['vehicle_engine_number'],
                                    'maker_description' => null,
                                    'maker_model' => $rc_validation['data']['maker_model'],
                                    'body_type' => $rc_validation['data']['body_type'],
                                    'fuel_type' => $rc_validation['data']['fuel_type'],
                                    'color' => $rc_validation['data']['color'],
                                    'norms_type' => $rc_validation['data']['norms_type'],
                                    'fit_up_to' => $rc_validation['data']['fit_up_to'],
                                    'financer' => $rc_validation['data']['financer'],
                                    'insurance_company' => $rc_validation['data']['insurance_company'],
                                    'insurance_policy_number' => $rc_validation['data']['insurance_policy_number'],
                                    'insurance_upto' => $rc_validation['data']['insurance_upto'],
                                    'manufacturing_date' => $rc_validation['data']['manufacturing_date'],
                                    'registered_at' => null,
                                    'less_info' => 1,
                                    'cubic_capacity' => $rc_validation['data']['cubic_capacity'],
                                    'vehicle_gross_weight' => $rc_validation['data']['vehicle_gross_weight'],
                                    'no_cylinders' => $rc_validation['data']['no_cylinders'],
                                    'seat_capacity' => $rc_validation['data']['seat_capacity'],
                                    'sleeper_capacity' => $rc_validation['data']['sleeper_capacity'],
                                    'standing_capacity' => $rc_validation['data']['standing_capacity'],
                                    'wheelbase' => $rc_validation['data']['wheelbase'],
                                    'unladen_weight' => $rc_validation['data']['unladen_weight'],
                                    'vehicle_category_description' => null,
                                    'pucc_number' => $rc_validation['data']['pucc_number'],
                                    'pucc_upto' => $rc_validation['data']['pucc_upto'],
                                    'hit_month' => date('Y-m'),
                                    'national_permit_issued_by' => $rc_validation_response['response']['permitDetails']['nationalPermitIssuedBy'],
                                    'national_permit_number' => $rc_validation_response['response']['permitDetails']['nationalPermitNumber'],
                                    'national_permit_upto' => $rc_validation_response['response']['permitDetails']['nationalPermitUpto'],
                                    'permit_type' => $rc_validation_response['response']['permitDetails']['permitType'],
                                    'permit_valid_from' => $rc_validation_response['response']['permitDetails']['permitValidFrom'],
                                    'permit_number' => $rc_validation_response['response']['permitDetails']['permitNumber'],
                                    'permit_valid_upto' => $rc_validation_response['response']['permitDetails']['permitValidUpto'],
                                    'permit_issue_date' => $rc_validation_response['response']['permitDetails']['permitIssueDate'],
                                    'noc_details' => $rc_validation_response['response']['registrationDetail']['nocDetails'],
                                    'latest_by' => $rc_validation_response['response']['registrationDetail']['rcStatusAsOn'],
                                    'message_code' => null,
                                    'non_use_to' => $rc_validation_response['response']['nonUseDetails']['nonUseTo'],
                                    'non_use_from' => $rc_validation_response['response']['nonUseDetails']['nonUseFrom'],
                                    'non_use_status' => $rc_validation_response['response']['nonUseDetails']['nonUseStatus'],
                                    // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['rc_validation' => $rc_validation, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => "success"]);
                        } elseif ($rc_validation_response['status']['statusCode'] == 200 && $rc_validation_response['response']['code'] == 1003) {
                            $statusCode = 102;
                            $errorMessage = 'Record not found';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($rc_validation_response['status']['statusCode'] == 200 && $rc_validation_response['response']['code'] == 1007) {
                            $statusCode = 200;
                            $errorMessage = 'RC Number in Multiple RTOs';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($rc_validation_response['status']['statusCode'] == 200 && $rc_validation_response['response']['code'] == 404) {
                            $statusCode = 102;
                            $errorMessage = 'Record does not exist in records';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } else {
                            $statusCode = 500;
                            $errorMessage = 'Internal server error.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    } catch (RequestException $e) {
                        $response = $e->getResponse();
                        $errorResponse = json_decode($response->getBody(), true);
                        $statusCode = $e->getResponse()->getStatusCode();
                        //return   $errorResponse;
                        if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                            $statusCode = 102;
                            $errorMessage = 'Invalid Vehicle Number Please Enter Correct Vehicle Number.';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }

                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 400) {
                            $statusCode = 102;
                            $errorMessage = 'Invalid Vehicle Number Please Enter Correct Vehicle Number.';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 205) {
                            $statusCode = 201;
                            $errorMessage = 'API Failed due to internal error.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 201);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 1004) {
                            $statusCode = 401;
                            $errorMessage = 'Sorry, RTO website is down for maintenance, we will inform you once it is back.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 401);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 1006) {
                            $statusCode = 102;
                            $errorMessage = 'Invalid Vehicle Number. Please enter valid vehicle number.';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful.', $statusCode);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 1008) {
                            $statusCode = 201;
                            $errorMessage = 'Record Not Found/Invalid Rc Number.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 201);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } else {
                            $statusCode = 500;
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['response']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }
                } else {
                    return response()->json(['statusCode' => 102, 'message' => 'Verification Failed. Please enter correct State Code.']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function rc_validationwithemptra(Request $request)
    {
        // return 'test';
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $service_provider = "emptraV2";

        if (empty($request->rc_number))
            return response()->json(array(['statusCode' => '404', 'message' => 'RC number is required']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['statusCode' => '404', 'message' => 'Header Access Token is required']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rc')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return 'false';
                $rcNumber = str_replace('-', '', $request->rc_number);
                $subString = strtoupper(substr($rcNumber, 0, 2));

                if ($subString == "AP" || $subString == "AR" || $subString == "AS" || $subString == "BR" || $subString == "CG" || $subString == "GA" || $subString == "GJ" || $subString == "HR" || $subString == "HP" || $subString == "JH" || $subString == "KA" || $subString == "KL" || $subString == "MP" || $subString == "MH" || $subString == "MN" || $subString == "ML" || $subString == "MZ" || $subString == "NL" || $subString == "OD" || $subString == "PB" || $subString == "RJ" || $subString == "SK" || $subString == "TN" || $subString == "TR" || $subString == "UP" || $subString == "UK" || $subString == "UA" || $subString == "WB" || $subString == "TS" || $subString == "AN" || $subString == "CH" || $subString == "DN" || $subString == "DD" || $subString == "JK" || $subString == "LA" || $subString == "LD" || $subString == "DL" || $subString == "PY") {
                    // return 'true';
                    $currentMonth = date('Y-m');
                    $rcdata = DB::table('rcvalidation')->where('rc_number', $rcNumber)->where('hit_month', $currentMonth)->where('status_code', '200')->orderby('id', 'DESC')->first();
                    // return $rcdata;
                    if (!empty($rcdata) && ($rcdata->rc_status != '' || $rcdata->rc_status != null)) {
                        // return 'ok not test';

                        $insuransespace = "-";
                        $updatedate = "2023";
                        $rcinsurance = $rcdata->insurance_upto;
                        $newrcinsurance = (explode("-", $rcinsurance));
                        // return $rcinsurance;
                        // return $rcinsurance->count();
                        if ($rcinsurance != 'NA') {
                            // return 'tester';
                            $allinsurance = $updatedate . $insuransespace . $newrcinsurance[1] . $insuransespace . $newrcinsurance[2];
                        } else {
                            $allinsurance = '2023-12-12';
                        }
                        $statusCode = 200;


                        $rc_validation['data']['rc_number'] = $rcdata->rc_number;
                        $rc_validation['data']['norms_type'] = $rcdata->norms_type;
                        $rc_validation['data']['rc_status'] = $rcdata->rc_status;
                        $rc_validation['data']['vehicle_gross_weight'] = $rcdata->vehicle_gross_weight;
                        $rc_validation['data']['unladen_weight'] = $rcdata->unladen_weight;
                        $rc_validation['data']['manufacturing_date'] = $rcdata->manufacturing_date;
                        $rc_validation['data']['seat_capacity'] = $rcdata->seat_capacity;
                        $rc_validation['data']['national_permit_issued_by'] = $rcdata->national_permit_issued_by;
                        $rc_validation['data']['national_permit_number'] = $rcdata->national_permit_number;
                        $rc_validation['data']['national_permit_upto'] = $rcdata->national_permit_upto;
                        $rc_validation['data']['insurance_company'] = $rcdata->insurance_company;
                        $rc_validation['data']['insurance_policy_number'] = $rcdata->insurance_policy_number;
                        // $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                        if ($newrcinsurance[0] < 2022) {
                            $rc_validation['data']['insurance_upto'] = $allinsurance;
                        } else {
                            $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                        }
                        $rc_validation['data']['permit_type'] = $rcdata->permit_type;
                        $rc_validation['data']['permit_valid_from'] = $rcdata->permit_valid_from;
                        $rc_validation['data']['permit_number'] = $rcdata->permit_number;
                        $rc_validation['data']['permit_valid_upto'] = $rcdata->permit_valid_upto;
                        $rc_validation['data']['permit_issue_date'] = $rcdata->permit_issue_date;
                        $rc_validation['data']['noc_details'] = $rcdata->noc_details;
                        $rc_validation['data']['body_type'] = $rcdata->body_type;
                        $rc_validation['data']['father_name'] = $rcdata->father_name;
                        $rc_validation['data']['owner_name'] = $rcdata->owner_name;
                        $rc_validation['data']['permanent_address'] = $rcdata->permanent_address;
                        $rc_validation['data']['present_address'] = $rcdata->present_address;
                        $rc_validation['data']['pucc_number'] = $rcdata->pucc_number;
                        $rc_validation['data']['pucc_upto'] = $rcdata->pucc_upto;
                        $rc_validation['data']['blacklist_status'] = $rcdata->blacklist_status;
                        $rc_validation['data']['maker_model'] = $rcdata->maker_model;
                        $rc_validation['data']['maker_description'] = $rcdata->maker_description;
                        $rc_validation['data']['fit_up_to'] = $rcdata->fit_up_to;
                        $rc_validation['data']['standing_capacity'] = $rcdata->standing_capacity;
                        $rc_validation['data']['sleeper_capacity'] = $rcdata->sleeper_capacity;
                        $rc_validation['data']['wheelbase'] = $rcdata->wheelbase;
                        $rc_validation['data']['vehicle_category_description'] = $rcdata->vehicle_category_description;
                        $rc_validation['data']['vehicle_category'] = $rcdata->vehicle_category;
                        $rc_validation['data']['vehicle_chasi_number'] = $rcdata->vehicle_chasi_number;
                        $rc_validation['data']['vehicle_engine_number'] = $rcdata->vehicle_engine_number;
                        $rc_validation['data']['mobile_number'] = $rcdata->mobile_number;
                        $rc_validation['data']['financer'] = $rcdata->financer;
                        // $rc_validation['data']['rc_number'] = $rcdata->['code'];
                        // $rc_validation['data']['rc_number'] = $rcdata->['stateCd'];
                        $rc_validation['data']['latest_by'] = $rcdata->latest_by;
                        $rc_validation['data']['tax_upto'] = $rcdata->tax_upto;
                        $rc_validation['data']['message_code'] = $rcdata->message_code;
                        $rc_validation['data']['non_use_to'] = $rcdata->non_use_to;
                        $rc_validation['data']['non_use_from'] = $rcdata->non_use_from;
                        $rc_validation['data']['non_use_status'] = $rcdata->non_use_status;
                        $rc_validation['data']['fuel_type'] = $rcdata->fuel_type;
                        $rc_validation['data']['registered_at'] = $rcdata->registered_at;
                        $rc_validation['data']['registration_date'] = $rcdata->registration_date;
                        $rc_validation['data']['color'] = $rcdata->color;
                        $rc_validation['data']['owner_number'] = $rcdata->owner_number;
                        $rc_validation['data']['no_cylinders'] = $rcdata->no_cylinders;
                        $rc_validation['data']['cubic_capacity'] = $rcdata->cubic_capacity;
                        $rc_validation['status_code'] = 200;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                // "client_id"=> $rc_validation['data']['client_id'],
                                "status_code" => 200,
                                "rc_number" => $rcdata->rc_number,
                                "rc_status" => $rcdata->rc_status,
                                "owner_number" => $rcdata->owner_number,
                                "tax_upto" => $rcdata->tax_upto,
                                "blacklist_status" => $rcdata->blacklist_status,
                                "father_name" => $rcdata->father_name,
                                "registration_date" => $rcdata->registration_date,
                                "owner_name" => $rcdata->owner_name,
                                "present_address" => $rcdata->present_address,
                                "permanent_address" => $rcdata->permanent_address,
                                "mobile_number" => $rcdata->mobile_number,
                                "vehicle_category" => $rcdata->vehicle_category,
                                "vehicle_chasi_number" => $rcdata->vehicle_chasi_number,
                                "vehicle_engine_number" => $rcdata->vehicle_engine_number,
                                "maker_description" => $rcdata->maker_description,
                                "maker_model" => $rcdata->maker_model,
                                "body_type" => $rcdata->body_type,
                                "fuel_type" => $rcdata->fuel_type,
                                "color" => $rcdata->color,
                                "norms_type" => $rcdata->norms_type,
                                "fit_up_to" => $rcdata->fit_up_to,
                                "financer" => $rcdata->financer,
                                "insurance_company" => $rcdata->insurance_company,
                                "insurance_policy_number" => $rcdata->insurance_policy_number,
                                "insurance_upto" => $rcdata->insurance_upto,
                                "manufacturing_date" => $rcdata->manufacturing_date,
                                "registered_at" => $rcdata->registered_at,
                                "less_info" => 1,
                                "cubic_capacity" => $rcdata->cubic_capacity,
                                "vehicle_gross_weight" => $rcdata->vehicle_gross_weight,
                                "no_cylinders" => $rcdata->no_cylinders,
                                "seat_capacity" => $rcdata->seat_capacity,
                                "sleeper_capacity" => $rcdata->sleeper_capacity,
                                "standing_capacity" => $rcdata->standing_capacity,
                                "wheelbase" => $rcdata->wheelbase,
                                "unladen_weight" => $rcdata->unladen_weight,
                                "vehicle_category_description" => $rcdata->vehicle_category_description,
                                "pucc_number" => $rcdata->pucc_number,
                                "pucc_upto" => $rcdata->pucc_upto,
                                'hit_month' => date('Y-m'),
                                'national_permit_issued_by' => $rcdata->national_permit_issued_by,
                                'national_permit_number' => $rcdata->national_permit_number,
                                'national_permit_upto' => $rcdata->national_permit_upto,
                                'permit_type' => $rcdata->permit_type,
                                'permit_valid_from' => $rcdata->permit_valid_from,
                                'permit_number' => $rcdata->permit_number,
                                'permit_valid_upto' => $rcdata->permit_valid_upto,
                                'permit_issue_date' => $rcdata->permit_issue_date,
                                'noc_details' => $rcdata->noc_details,
                                'latest_by' => $rcdata->latest_by,
                                'message_code' => $rcdata->message_code,
                                'non_use_to' => $rcdata->non_use_to,
                                'non_use_from' => $rcdata->non_use_from,
                                'non_use_status' => $rcdata->non_use_status,
                                // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now(),
                                'service_provider' => 'database'
                            ]);
                        }
                    } else {

                        try {


                            $rc_validation = [];
                            $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number=' . $rcNumber, ['headers' => $headers]);
                            $rc_validation1 = json_decode($res->getBody(), true);
                            // return  $rc_validation1;


                            // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                            // if(isset($rc_validation1['error_code'])){
                            //     $statusCode = 200;
                            // }
                            // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                            // if($grossWeight){
                            //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                            //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                            //     $checkweight = array();
                            //     $checkweight['tag_class'] = $checkWeight->tag_class;
                            // }else{
                            //     $checkweight['tag_class'] = '';
                            // }
                            if ($rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA' && Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->isPast() == true) {
                                $rc_validation['data']['rc_status'] = '';
                            } else {
                                $rc_validation['data']['rc_status'] = 'ACTIVE';
                            }

                            // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                            if ($rc_validation1['error_code'] == "SPC-200") {

                                $insuransespace = "-";
                                $updatedate = "2023";
                                $rcinsurance = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                                $newrcinsurance = (explode("-", $rcinsurance));
                                // $allinsurance = $newrcinsurance[0].$insuransespace.$newrcinsurance[1].$insuransespace. $updatedate;
                                if (!empty($rcinsurance)) {
                                    // return 'tester';
                                    $allinsurance = $updatedate . $insuransespace . $newrcinsurance[1] . $insuransespace . $newrcinsurance[2];
                                } else {
                                    $allinsurance = '2023-12-12';
                                }

                                $statusCode = 200;
                                $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['vehicleNumber'];
                                $rc_validation['data']['norms_type'] = $rc_validation1['vehicleDetails']['rcNormsDesc'];
                                // $rc_validation['data']['rc_status'] = $rc_validation1['vehicleDetails']['rcStatus'];
                                $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['vehicleDetails']['rcGvw'];
                                $rc_validation['data']['unladen_weight'] = $rc_validation1['vehicleDetails']['rcUnldWt'];
                                $rc_validation['data']['manufacturing_date'] = $rc_validation1['vehicleDetails']['rcManuMonthYr'];
                                $rc_validation['data']['seat_capacity'] = $rc_validation1['vehicleDetails']['rcSeatCap'];
                                $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['vehicleDetails']['rcNpIssuedBy'];
                                $rc_validation['data']['national_permit_number'] = $rc_validation1['vehicleDetails']['rcNpNo'];
                                $rc_validation['data']['national_permit_upto'] = $rc_validation1['vehicleDetails']['rcNpUpto'];
                                $rc_validation['data']['insurance_company'] = $rc_validation1['vehicleDetails']['rcInsuranceComp'];
                                $rc_validation['data']['insurance_policy_number'] = $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'];
                                if (isset($rc_validation1['vehicleDetails']['rcInsuranceUpto']) && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != null && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != "null" && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != 'NA') {
                                    // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                    if ($newrcinsurance[2] < 2022) {
                                        $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                    } else {
                                        $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                    }
                                } else {
                                    $rc_validation['data']['insurance_upto'] = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                                }

                                $rc_validation['data']['permit_type'] = $rc_validation1['vehicleDetails']['rcPermitType'];
                                $rc_validation['data']['permit_valid_from'] = $rc_validation1['vehicleDetails']['rcPermitValidFrom'];
                                $rc_validation['data']['permit_number'] = $rc_validation1['vehicleDetails']['rcPermitNo'];
                                $rc_validation['data']['permit_valid_upto'] = $rc_validation1['vehicleDetails']['rcPermitValidUpto'];
                                $rc_validation['data']['permit_issue_date'] = $rc_validation1['vehicleDetails']['rcPermitIssueDt'];
                                $rc_validation['data']['noc_details'] = $rc_validation1['vehicleDetails']['rcNocDetails'];
                                $rc_validation['data']['body_type'] = $rc_validation1['vehicleDetails']['rcBodyTypeDesc'];
                                $rc_validation['data']['father_name'] = $rc_validation1['vehicleDetails']['rcFName'];
                                $rc_validation['data']['owner_name'] = $rc_validation1['vehicleDetails']['rcOwnerName'];
                                $rc_validation['data']['permanent_address'] = $rc_validation1['vehicleDetails']['rcPermanentAddress'];
                                $rc_validation['data']['present_address'] = $rc_validation1['vehicleDetails']['rcPresentAddress'];
                                $rc_validation['data']['pucc_number'] = $rc_validation1['vehicleDetails']['rcPuccNo'];
                                if (isset($rc_validation1['vehicleDetails']['rcPuccUpto']) && $rc_validation1['vehicleDetails']['rcPuccUpto'] != null && $rc_validation1['vehicleDetails']['rcPuccUpto'] != "null" && $rc_validation1['vehicleDetails']['rcPuccUpto'] != 'NA') {
                                    $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcPuccUpto'])->format('Y-m-d');
                                } else {
                                    $rc_validation['data']['pucc_upto'] = $rc_validation1['vehicleDetails']['rcPuccUpto'];
                                }
                                $rc_validation['data']['blacklist_status'] = $rc_validation1['vehicleDetails']['rcBlacklistStatus'];
                                $rc_validation['data']['maker_model'] = $rc_validation1['vehicleDetails']['rcMakerModel'];
                                $rc_validation['data']['maker_description'] = $rc_validation1['vehicleDetails']['rcMakerDesc'];
                                if (isset($rc_validation1['vehicleDetails']['rcFitUpto']) && $rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != "null" && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA') {
                                    $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->format('Y-m-d');
                                } else {
                                    $rc_validation['data']['fit_up_to'] = $rc_validation1['vehicleDetails']['rcFitUpto'];
                                }
                                $rc_validation['data']['standing_capacity'] = $rc_validation1['vehicleDetails']['rcStandCap'];
                                $rc_validation['data']['sleeper_capacity'] = $rc_validation1['vehicleDetails']['rcSleeperCap'];
                                $rc_validation['data']['wheelbase'] = $rc_validation1['vehicleDetails']['rcWheelbase'];
                                $rc_validation['data']['vehicle_category_description'] = $rc_validation1['vehicleDetails']['rcVhClassDesc'];
                                $rc_validation['data']['vehicle_category'] = $rc_validation1['vehicleDetails']['rcVchCatg'];
                                $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['vehicleDetails']['rcChasiNo'];
                                $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['vehicleDetails']['rcEngNo'];
                                $rc_validation['data']['mobile_number'] = $rc_validation1['vehicleDetails']['rcMobileNo'];
                                $rc_validation['data']['financer'] = $rc_validation1['vehicleDetails']['rcFinancer'];
                                // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                                // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                                $rc_validation['data']['latest_by'] = $rc_validation1['vehicleDetails']['rcStatusAsOn'];
                                $rc_validation['data']['tax_upto'] = $rc_validation1['vehicleDetails']['rcTaxUpto'];
                                $rc_validation['data']['message_code'] = $rc_validation1['vehicleDetails']['stautsmessage'];
                                $rc_validation['data']['non_use_to'] = $rc_validation1['vehicleDetails']['rcNonUseTo'];
                                $rc_validation['data']['non_use_from'] = $rc_validation1['vehicleDetails']['rcNonUseFrom'];
                                $rc_validation['data']['non_use_status'] = $rc_validation1['vehicleDetails']['rcNonUseStatus'];
                                $rc_validation['data']['fuel_type'] = $rc_validation1['vehicleDetails']['rcFuelDesc'];
                                $rc_validation['data']['registered_at'] = $rc_validation1['vehicleDetails']['rcRegisteredAt'];
                                if (isset($rc_validation1['vehicleDetails']['rcRegnDt']) && $rc_validation1['vehicleDetails']['rcRegnDt'] != null && $rc_validation1['vehicleDetails']['rcRegnDt'] != "null" && $rc_validation1['vehicleDetails']['rcRegnDt'] != 'NA') {
                                    $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['vehicleDetails']['rcRegnDt'])->format('Y-m-d');
                                } else {
                                    $rc_validation['data']['registration_date'] = $rc_validation1['vehicleDetails']['rcRegnDt'];
                                }

                                $rc_validation['data']['color'] = $rc_validation1['vehicleDetails']['rcColor'];
                                $rc_validation['data']['owner_number'] = $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'];
                                $rc_validation['data']['no_cylinders'] = $rc_validation1['vehicleDetails']['rcNoCyl'];
                                $rc_validation['data']['cubic_capacity'] = $rc_validation1['vehicleDetails']['rcCubicCap'];
                                $rc_validation['status_code'] = 200;
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                    }
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        // "client_id"=> $rc_validation['data']['client_id'],
                                        "status_code" => 200,
                                        "rc_number" => $rc_validation1['vehicleDetails']['vehicleNumber'],
                                        "rc_status" => $rc_validation1['vehicleDetails']['rcStatus'],
                                        "owner_number" => $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'],
                                        "tax_upto" => $rc_validation1['vehicleDetails']['rcTaxUpto'],
                                        "blacklist_status" => $rc_validation1['vehicleDetails']['rcBlacklistStatus'],
                                        "father_name" => $rc_validation1['vehicleDetails']['rcFName'],
                                        "registration_date" => $rc_validation['data']['registration_date'],
                                        "owner_name" => $rc_validation1['vehicleDetails']['rcOwnerName'],
                                        "present_address" => $rc_validation1['vehicleDetails']['rcPresentAddress'],
                                        "permanent_address" => $rc_validation1['vehicleDetails']['rcPermanentAddress'],
                                        "mobile_number" => $rc_validation1['vehicleDetails']['rcMobileNo'],
                                        "vehicle_category" => $rc_validation1['vehicleDetails']['rcVchCatg'],
                                        "vehicle_chasi_number" => $rc_validation1['vehicleDetails']['rcChasiNo'],
                                        "vehicle_engine_number" => $rc_validation1['vehicleDetails']['rcEngNo'],
                                        "maker_description" => $rc_validation1['vehicleDetails']['rcMakerDesc'],
                                        "maker_model" => $rc_validation1['vehicleDetails']['rcMakerModel'],
                                        "body_type" => $rc_validation1['vehicleDetails']['rcBodyTypeDesc'],
                                        "fuel_type" => $rc_validation1['vehicleDetails']['rcFuelDesc'],
                                        "color" => $rc_validation1['vehicleDetails']['rcColor'],
                                        "norms_type" => $rc_validation1['vehicleDetails']['rcNormsDesc'],
                                        "fit_up_to" => $rc_validation['data']['fit_up_to'],
                                        "financer" => $rc_validation1['vehicleDetails']['rcFinancer'],
                                        "insurance_company" => $rc_validation1['vehicleDetails']['rcInsuranceComp'],
                                        "insurance_policy_number" => $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'],
                                        "insurance_upto" => $rc_validation['data']['insurance_upto'],
                                        "manufacturing_date" => $rc_validation1['vehicleDetails']['rcManuMonthYr'],
                                        "registered_at" => $rc_validation1['vehicleDetails']['rcRegisteredAt'],
                                        "less_info" => 1,
                                        "cubic_capacity" => $rc_validation1['vehicleDetails']['rcCubicCap'],
                                        "vehicle_gross_weight" => $rc_validation1['vehicleDetails']['rcGvw'],
                                        "no_cylinders" => $rc_validation1['vehicleDetails']['rcNoCyl'],
                                        "seat_capacity" => $rc_validation1['vehicleDetails']['rcSeatCap'],
                                        "sleeper_capacity" => $rc_validation1['vehicleDetails']['rcSleeperCap'],
                                        "standing_capacity" => $rc_validation1['vehicleDetails']['rcStandCap'],
                                        "wheelbase" => $rc_validation1['vehicleDetails']['rcWheelbase'],
                                        "unladen_weight" => $rc_validation1['vehicleDetails']['rcUnldWt'],
                                        "vehicle_category_description" => $rc_validation1['vehicleDetails']['rcVhClassDesc'],
                                        "pucc_number" => $rc_validation1['vehicleDetails']['rcPuccNo'],
                                        "pucc_upto" => $rc_validation['data']['pucc_upto'],
                                        'hit_month' => date('Y-m'),
                                        'national_permit_issued_by' => $rc_validation1['vehicleDetails']['rcNpIssuedBy'],
                                        'national_permit_number' => $rc_validation1['vehicleDetails']['rcNpNo'],
                                        'national_permit_upto' => $rc_validation1['vehicleDetails']['rcNpUpto'],
                                        'permit_type' => $rc_validation1['vehicleDetails']['rcPermitType'],
                                        'permit_valid_from' => $rc_validation1['vehicleDetails']['rcPermitValidFrom'],
                                        'permit_number' => $rc_validation1['vehicleDetails']['rcPermitNo'],
                                        'permit_valid_upto' => $rc_validation1['vehicleDetails']['rcPermitValidUpto'],
                                        'permit_issue_date' => $rc_validation1['vehicleDetails']['rcPermitIssueDt'],
                                        'noc_details' => $rc_validation1['vehicleDetails']['rcNocDetails'],
                                        'latest_by' => $rc_validation1['vehicleDetails']['rcStatusAsOn'],
                                        'message_code' => $rc_validation1['vehicleDetails']['stautsmessage'],
                                        'non_use_to' => $rc_validation1['vehicleDetails']['rcNonUseTo'],
                                        'non_use_from' => $rc_validation1['vehicleDetails']['rcNonUseFrom'],
                                        'non_use_status' => $rc_validation1['vehicleDetails']['rcNonUseStatus'],
                                        // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),
                                        'service_provider' => $service_provider
                                    ]);
                                }
                            }
                            // else if($rc_validation1['error_code'] == "SPC-201"){
                            //     return 'test';
                            //     $statusCode = 500;
                            //     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            //     if($user->role_id==1) {
                            //         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            //         $rcvalidation = DB::table('rcvalidation')->insert([
                            //             "user_id"=> $user->id,
                            //             "api_id"=> $api_id,
                            //             "status_code"=> $statusCode,
                            //             "rc_number"=> $rcNumber,
                            //             "created_at"=> Carbon::now(),
                            //             "updated_at"=> Carbon::now(),
                            //             'service_provider'=> $service_provider
                            //         ]);
                            //     }
                            //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                            // }
                            else if ($rc_validation1['error_code'] == "SPC-203" || $rc_validation1['error_code'] == "SPC-206" || $rc_validation1['error_code'] == "SPC-201") {
                                // return 'tester';
                                $statusCode = 102;
                                if ($rc_validation1['error_code'] == "SPC-203" && $rc_validation1['message'] != 'Record not found') {
                                    $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                    if ($user->role_id == 1) {
                                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            "user_id" => $user->id,
                                            "api_id" => $api_id,
                                            "status_code" => $statusCode,
                                            "rc_number" => $rcNumber,
                                            "created_at" => Carbon::now(),
                                            "updated_at" => Carbon::now(),
                                            'service_provider' => $service_provider
                                        ]);
                                    }
                                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                } else {

                                    try {
                                        // return 'try';
                                        $client = new Client();
                                        // $rcnomber = 'MH16AJ1013';
                                        $blacklistcheck = 'true';
                                        // $headerss = [
                                        //     // 'Authorization' => $this->nsdlToken,        
                                        //     'secretKey' => 'pI76u95BabjkIFg6DNNRole7gZn71ljPk7W5WIHzApjlObIMywuq8pZGa30HXm5wR',   
                                        //     'clientId' => 'ef41c6d7089614d1838c68efc81a8493:dc983c1bfbc4390f4952bd44ed0ae690'
                                        // ];

                                        // // return 'test the try in try';
                                        // $rc_validation = [];
                                        // $res = $client->post('https://api.emptra.com/vehicleRegistrationsV3', ['headers' => $headerss, 'form_params'=> ['vehicleNumber'=>$request->rc_number,'blacklistCheck'=>$blacklistcheck]]);
                                        // $rc_validation1 = json_decode($res->getBody(), true);


                                        // $url = 'https://api.emptra.com/vehicleRegistrationsV3';

                                        // $data = array(
                                        //     "vehicleNumber" => $request->rc_number,
                                        // );

                                        // $body = json_encode($data);

                                        // $ch = curl_init($url);

                                        // curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                                        // curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: ".$this->secretKey,"clientId: ".$this->clientId,'Content-Type:application/json'));
                                        // curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                                        // $get_data1 = curl_exec($ch);
                                        // $rc_validation1 = json_decode($get_data1, true);
                                        $url = 'https://api.emptra.com/vehicleRegistrationsV2';

                                        $data = array(
                                            "vehicleNumber" => $request->rc_number,
                                            "blacklistCheck" => false
                                        );

                                        $body = json_encode($data);
                                        // return $data;

                                        $ch = curl_init($url);

                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                                        curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: " . $this->secretKey, "clientId: " . $this->clientId, 'Content-Type:application/json'));
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                                        $get_data1 = curl_exec($ch);
                                        $rc_validation1 = json_decode($get_data1, true);
                                        // return $rc_validation1;
                                        // return $rc_validation1;


                                        // return $rc_validation1['result']['rcExpiryDate'];
                                        // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                                        // if(isset($rc_validation1['error_code'])){
                                        //     $statusCode = 200;
                                        // }
                                        // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                                        // if($grossWeight){
                                        //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                                        //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                                        //     $checkweight = array();
                                        //     $checkweight['tag_class'] = $checkWeight->tag_class;
                                        // }else{
                                        //     $checkweight['tag_class'] = '';
                                        // }
                                        // if($rc_validation1['result']['rcExpiryDate'] != null && $rc_validation1['result']['rcExpiryDate'] != 'NA'){
                                        //     $rc_validation['data']['rc_status'] = '';
                                        // }else{
                                        //     $rc_validation['data']['rc_status'] = 'ACTIVE';
                                        // }

                                        // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                                        if ($rc_validation1['code'] == "100" || $rc_validation1['code'] == "200") {

                                            // return $rc_validation1['result'];

                                            $insuransespace = "/";
                                            $updatedate = "2023";
                                            $rcinsurance = $rc_validation1['result']['vehicleInsuranceUpto'];
                                            // return $rcinsurance;
                                            $newrcinsurance = (explode("/", $rcinsurance));
                                            // return $newrcinsurance;
                                            // $allinsurance = $newrcinsurance[0].$insuransespace.$newrcinsurance[1].$insuransespace. $updatedate;
                                            if ($rcinsurance != 'NA') {
                                                // return 'tester';
                                                $allinsurance = $newrcinsurance[0] . $insuransespace . $newrcinsurance[1] . $insuransespace . $updatedate;
                                            } else {
                                                $allinsurance = '2023-12-12';
                                            }
                                            // return $allinsurance;

                                            $statusCode = 200;
                                            // $rc_validation['data']['rc_number'] = $rc_validation1['result']['rc_number'];
                                            // $rc_validation['data']['norms_type'] = $rc_validation1['result']['norms_type'];
                                            // $rc_validation['data']['rc_status'] = $rc_validation1['result']['rc_status'];
                                            // $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['result']['vehicle_gross_weight'];
                                            // $rc_validation['data']['unladen_weight'] = $rc_validation1['result']['unladen_weight'];
                                            // $rc_validation['data']['manufacturing_date'] = $rc_validation1['result']['manufacturing_date'];
                                            // $rc_validation['data']['seat_capacity'] = $rc_validation1['result']['seat_capacity'];
                                            // $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['result']['national_permit_issued_by'];
                                            // $rc_validation['data']['national_permit_number'] = $rc_validation1['result']['national_permit_number'];
                                            // $rc_validation['data']['national_permit_upto'] = $rc_validation1['result']['national_permit_upto'];
                                            // $rc_validation['data']['insurance_company'] = $rc_validation1['result']['insurance_company'];
                                            // $rc_validation['data']['insurance_policy_number'] = $rc_validation1['result']['insurance_policy_number'];
                                            // if(isset($rc_validation1['result']['insurance_upto']) && $rc_validation1['result']['insurance_upto'] != null && $rc_validation1['result']['insurance_upto'] != "null" && $rc_validation1['result']['insurance_upto'] != 'NA'){
                                            //     // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                            //     if($newrcinsurance[0] < 2022){
                                            //         $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                            //         // $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $allinsurance)->format('Y-m-d');
                                            //     }else{
                                            //         $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['result']['insurance_upto'])->format('Y-m-d');
                                            //         // $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['insurance_upto'])->format('Y-m-d');
                                            //     }
                                            // }else{
                                            //     $rc_validation['data']['insurance_upto'] = $rc_validation1['result']['insurance_upto'];
                                            // }

                                            // $rc_validation['data']['permit_type'] = $rc_validation1['result']['permit_type'];
                                            // $rc_validation['data']['permit_valid_from'] = $rc_validation1['result']['permit_valid_from'];
                                            // $rc_validation['data']['permit_number'] = $rc_validation1['result']['permit_number'];
                                            // $rc_validation['data']['permit_valid_upto'] = $rc_validation1['result']['permit_valid_upto'];
                                            // $rc_validation['data']['permit_issue_date'] = $rc_validation1['result']['permit_issue_date'];;
                                            // $rc_validation['data']['noc_details'] = $rc_validation1['result']['noc_details'];
                                            // $rc_validation['data']['body_type'] = $rc_validation1['result']['body_type'];
                                            // $rc_validation['data']['father_name'] = $rc_validation1['result']['father_name'];
                                            // $rc_validation['data']['owner_name'] = $rc_validation1['result']['owner_name'];
                                            // $rc_validation['data']['permanent_address'] = $rc_validation1['result']['permanent_address'];
                                            // $rc_validation['data']['present_address'] = $rc_validation1['result']['present_address'];
                                            // $rc_validation['data']['pucc_number'] = $rc_validation1['result']['pucc_number'];
                                            // if(isset($rc_validation1['result']['pucc_upto']) && $rc_validation1['result']['pucc_upto'] != null && $rc_validation1['result']['pucc_upto'] != "null" && $rc_validation1['result']['pucc_upto'] != 'NA'){
                                            //     // return 'testdate';
                                            //     $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['result']['pucc_upto'])->format('Y-m-d');
                                            //     // $rc_validation['data']['pucc_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['pucc_upto'])->format('Y-m-d');
                                            // }else{
                                            //     $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['pucc_upto'];
                                            // }
                                            // $rc_validation['data']['blacklist_status'] = $rc_validation1['result']['blacklist_status'];
                                            // $rc_validation['data']['maker_model'] = $rc_validation1['result']['maker_model'];
                                            // $rc_validation['data']['maker_description'] = $rc_validation1['result']['maker_description'];
                                            // if(isset($rc_validation1['result']['fit_up_to']) && $rc_validation1['result']['fit_up_to'] != null && $rc_validation1['result']['fit_up_to'] != "null" && $rc_validation1['result']['fit_up_to'] != 'NA'){
                                            //     // return 'testdate';
                                            //     $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                            //     // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                            //     // $rc_validation['data']['fit_up_to'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['fit_up_to'])->format('Y-m-d');

                                            // }else{
                                            //     $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['fit_up_to'];;
                                            // }
                                            // $rc_validation['data']['standing_capacity'] = $rc_validation1['result']['standing_capacity'];
                                            // $rc_validation['data']['sleeper_capacity'] = $rc_validation1['result']['sleeper_capacity'];
                                            // $rc_validation['data']['wheelbase'] = $rc_validation1['result']['wheelbase'];
                                            // $rc_validation['data']['vehicle_category_description'] = $rc_validation1['result']['vehicle_category_description'];
                                            // $rc_validation['data']['vehicle_category'] = $rc_validation1['result']['vehicle_category'];
                                            // $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['result']['vehicle_chasi_number'];
                                            // $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['result']['vehicle_engine_number'];
                                            // $rc_validation['data']['mobile_number'] = $rc_validation1['result']['mobile_number'];
                                            // $rc_validation['data']['financer'] = $rc_validation1['result']['financer'];
                                            // // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                                            // // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                                            // $rc_validation['data']['latest_by'] = $rc_validation1['result']['latest_by'];
                                            // $rc_validation['data']['tax_upto'] = $rc_validation1['result']['tax_upto'];
                                            // $rc_validation['data']['message_code'] = 'NA';
                                            // $rc_validation['data']['non_use_to'] = $rc_validation1['result']['non_use_to'];
                                            // $rc_validation['data']['non_use_from'] = $rc_validation1['result']['non_use_from'];
                                            // $rc_validation['data']['non_use_status'] = $rc_validation1['result']['non_use_status'];
                                            // $rc_validation['data']['fuel_type'] = $rc_validation1['result']['fuel_type'];
                                            // $rc_validation['data']['registered_at'] = $rc_validation1['result']['registered_at'];
                                            // if(isset($rc_validation1['result']['registration_date']) && $rc_validation1['result']['registration_date'] != null && $rc_validation1['result']['registration_date'] != "null" && $rc_validation1['result']['registration_date'] != 'NA'){
                                            //     $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['result']['registration_date'])->format('Y-m-d');
                                            //         // $rc_validation['data']['registration_date'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['registration_date'])->format('Y-m-d');
                                            // }else{
                                            //     $rc_validation['data']['registration_date'] = $rc_validation1['result']['registration_date'];
                                            // }

                                            // $rc_validation['data']['color'] = $rc_validation1['result']['color'];
                                            // $rc_validation['data']['owner_number'] = $rc_validation1['result']['owner_number'];
                                            // $rc_validation['data']['no_cylinders'] = $rc_validation1['result']['no_cylinders'];
                                            // $rc_validation['data']['cubic_capacity'] = $rc_validation1['result']['cubic_capacity'];
                                            // $rc_validation['status_code'] = 200;

                                            //********************************emptra V2 start********************************** */
                                            $rc_validation['data']['rc_number'] = $rc_validation1['result']['regNo'];
                                            $rc_validation['data']['norms_type'] = $rc_validation1['result']['normsType'];
                                            $rc_validation['data']['rc_status'] = $rc_validation1['result']['status'];
                                            $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['result']['grossVehicleWeight'];
                                            $rc_validation['data']['unladen_weight'] = $rc_validation1['result']['unladenWeight'];
                                            $rc_validation['data']['manufacturing_date'] = $rc_validation1['result']['vehicleManufacturingMonthYear'];
                                            $rc_validation['data']['seat_capacity'] = $rc_validation1['result']['vehicleSeatCapacity'];
                                            $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['result']['nationalPermitIssuedBy'];
                                            $rc_validation['data']['national_permit_number'] = $rc_validation1['result']['nationalPermitNumber'];
                                            $rc_validation['data']['national_permit_upto'] = $rc_validation1['result']['nationalPermitUpto'];
                                            $rc_validation['data']['insurance_company'] = $rc_validation1['result']['vehicleInsuranceCompanyName'];
                                            $rc_validation['data']['insurance_policy_number'] = $rc_validation1['result']['vehicleInsurancePolicyNumber'];
                                            if (isset($rc_validation1['result']['vehicleInsuranceUpto']) && $rc_validation1['result']['vehicleInsuranceUpto'] != null && $rc_validation1['result']['vehicleInsuranceUpto'] != "null" && $rc_validation1['result']['vehicleInsuranceUpto'] != 'NA') {
                                                // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                                if ($newrcinsurance[2] < 2022) {
                                                    // $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                                    // return $allinsurance;
                                                    $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $allinsurance)->format('Y-m-d');
                                                } else {
                                                    // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['result']['vehicleInsuranceUpto'])->format('Y-m-d');
                                                    $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['vehicleInsuranceUpto'])->format('Y-m-d');
                                                }
                                            } else {
                                                $rc_validation['data']['insurance_upto'] = $rc_validation1['result']['vehicleInsuranceUpto'];
                                            }

                                            $rc_validation['data']['permit_type'] = $rc_validation1['result']['permitType'];
                                            $rc_validation['data']['permit_valid_from'] = $rc_validation1['result']['permitValidFrom'];
                                            $rc_validation['data']['permit_number'] = $rc_validation1['result']['permitNumber'];
                                            $rc_validation['data']['permit_valid_upto'] = $rc_validation1['result']['permitValidUpto'];
                                            $rc_validation['data']['permit_issue_date'] = $rc_validation1['result']['permitIssueDate'];
                                            ;
                                            $rc_validation['data']['noc_details'] = $rc_validation1['result']['nocDetails'];
                                            $rc_validation['data']['body_type'] = $rc_validation1['result']['bodyType'];
                                            $rc_validation['data']['father_name'] = $rc_validation1['result']['ownerFatherName'];
                                            $rc_validation['data']['owner_name'] = $rc_validation1['result']['owner'];
                                            $rc_validation['data']['permanent_address'] = $rc_validation1['result']['permanentAddress'];
                                            $rc_validation['data']['present_address'] = $rc_validation1['result']['presentAddress'];
                                            $rc_validation['data']['pucc_number'] = $rc_validation1['result']['puccNumber'];
                                            if (isset($rc_validation1['result']['puccUpto']) && $rc_validation1['result']['puccUpto'] != null && $rc_validation1['result']['puccUpto'] != "null" && $rc_validation1['result']['puccUpto'] != 'NA') {
                                                // return 'testdate';
                                                // $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['result']['puccUpto'])->format('Y-m-d');
                                                $rc_validation['data']['pucc_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['puccUpto'])->format('Y-m-d');
                                            } else {
                                                $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['puccUpto'];
                                            }
                                            $rc_validation['data']['blacklist_status'] = $rc_validation1['result']['blacklistStatus'];
                                            $rc_validation['data']['maker_model'] = $rc_validation1['result']['model'];
                                            $rc_validation['data']['maker_description'] = $rc_validation1['result']['vehicleManufacturerName'];
                                            if (isset($rc_validation1['result']['rcExpiryDate']) && $rc_validation1['result']['rcExpiryDate'] != null && $rc_validation1['result']['rcExpiryDate'] != "null" && $rc_validation1['result']['rcExpiryDate'] != 'NA') {
                                                // return 'testdate';
                                                // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                                // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                                if ($rc_validation1['result']['rcExpiryDate'] != 'NA' || $rc_validation1['result']['rcExpiryDate'] != 'NA/0/undefined') {
                                                    // $rc_validation['data']['fit_up_to'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['rcExpiryDate'])->format('Y-m-d');
                                                    $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['rcExpiryDate'];
                                                }


                                            } else {
                                                $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['rcExpiryDate'];
                                                ;
                                            }
                                            $rc_validation['data']['standing_capacity'] = $rc_validation1['result']['vehicleStandingCapacity'];
                                            $rc_validation['data']['sleeper_capacity'] = $rc_validation1['result']['vehicleSleeperCapacity'];
                                            $rc_validation['data']['wheelbase'] = $rc_validation1['result']['wheelbase'];
                                            $rc_validation['data']['vehicle_category_description'] = $rc_validation1['result']['vehicleCategory'];
                                            $rc_validation['data']['vehicle_category'] = $rc_validation1['result']['vehicleCategory'];
                                            $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['result']['chassis'];
                                            $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['result']['engine'];
                                            $rc_validation['data']['mobile_number'] = $rc_validation1['result']['mobileNumber'];
                                            $rc_validation['data']['financer'] = $rc_validation1['result']['rcFinancer'];
                                            // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                                            // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                                            $rc_validation['data']['latest_by'] = $rc_validation1['result']['statusAsOn'];
                                            ;
                                            $rc_validation['data']['tax_upto'] = $rc_validation1['result']['vehicleTaxUpto'];
                                            $rc_validation['data']['message_code'] = 'NA';
                                            $rc_validation['data']['non_use_to'] = $rc_validation1['result']['nonUseTo'];
                                            $rc_validation['data']['non_use_from'] = $rc_validation1['result']['nonUseFrom'];
                                            $rc_validation['data']['non_use_status'] = $rc_validation1['result']['nonUseStatus'];
                                            $rc_validation['data']['fuel_type'] = $rc_validation1['result']['type'];
                                            $rc_validation['data']['registered_at'] = $rc_validation1['result']['regAuthority'];
                                            if (isset($rc_validation1['result']['regDate']) && $rc_validation1['result']['regDate'] != null && $rc_validation1['result']['regDate'] != "null" && $rc_validation1['result']['regDate'] != 'NA') {
                                                // $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['result']['registration_date'])->format('Y-m-d');
                                                $rc_validation['data']['registration_date'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['regDate'])->format('Y-m-d');
                                            } else {
                                                $rc_validation['data']['registration_date'] = $rc_validation1['result']['regDate'];
                                            }

                                            $rc_validation['data']['color'] = $rc_validation1['result']['vehicleColour'];
                                            $rc_validation['data']['owner_number'] = $rc_validation1['result']['ownerCount'];
                                            $rc_validation['data']['no_cylinders'] = $rc_validation1['result']['vehicleCylindersNo'];
                                            $rc_validation['data']['cubic_capacity'] = $rc_validation1['result']['vehicleCubicCapacity'];
                                            $rc_validation['status_code'] = 200;
                                            if ($user->role_id == 1) {
                                                if ($apiamster) {
                                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                                }
                                                // return  $rc_validation['result'];
                                                $rcvalidation = DB::table('rcvalidation')->insert([
                                                    "user_id" => $user->id,
                                                    "api_id" => $api_id,
                                                    // "client_id"=> $rc_validation['data']['client_id'],
                                                    "status_code" => 200,
                                                    "rc_number" => $rc_validation1['result']['regNo'],
                                                    "rc_status" => $rc_validation1['result']['status'],
                                                    "owner_number" => $rc_validation1['result']['ownerCount'],
                                                    "tax_upto" => $rc_validation1['result']['vehicleTaxUpto'],
                                                    "blacklist_status" => $rc_validation1['result']['blacklistStatus'],
                                                    "father_name" => $rc_validation1['result']['ownerFatherName'],
                                                    "registration_date" => $rc_validation['data']['registration_date'],
                                                    "owner_name" => $rc_validation1['result']['owner'],
                                                    "present_address" => $rc_validation1['result']['presentAddress'],
                                                    "permanent_address" => $rc_validation1['result']['permanentAddress'],
                                                    "mobile_number" => $rc_validation1['result']['mobileNumber'],
                                                    "vehicle_category" => $rc_validation1['result']['vehicleCategory'],
                                                    "vehicle_chasi_number" => $rc_validation1['result']['chassis'],
                                                    "vehicle_engine_number" => $rc_validation1['result']['engine'],
                                                    "maker_description" => $rc_validation1['result']['vehicleManufacturerName'],
                                                    "maker_model" => $rc_validation1['result']['model'],
                                                    "body_type" => $rc_validation1['result']['bodyType'],
                                                    "fuel_type" => $rc_validation1['result']['type'],
                                                    "color" => $rc_validation1['result']['vehicleColour'],
                                                    "norms_type" => $rc_validation1['result']['normsType'],
                                                    "fit_up_to" => $rc_validation['data']['fit_up_to'],
                                                    "financer" => $rc_validation1['result']['rcFinancer'],
                                                    "insurance_company" => $rc_validation1['result']['vehicleInsuranceCompanyName'],
                                                    "insurance_policy_number" => $rc_validation1['result']['vehicleInsurancePolicyNumber'],
                                                    "insurance_upto" => $rc_validation['data']['insurance_upto'],
                                                    "manufacturing_date" => $rc_validation1['result']['vehicleManufacturingMonthYear'],
                                                    "registered_at" => $rc_validation1['result']['regAuthority'],
                                                    "less_info" => 1,
                                                    "cubic_capacity" => $rc_validation1['result']['vehicleCubicCapacity'],
                                                    "vehicle_gross_weight" => $rc_validation1['result']['grossVehicleWeight'],
                                                    "no_cylinders" => $rc_validation1['result']['vehicleCylindersNo'],
                                                    "seat_capacity" => $rc_validation1['result']['vehicleSeatCapacity'],
                                                    "sleeper_capacity" => $rc_validation1['result']['vehicleSleeperCapacity'],
                                                    "standing_capacity" => $rc_validation1['result']['vehicleStandingCapacity'],
                                                    "wheelbase" => $rc_validation1['result']['wheelbase'],
                                                    "unladen_weight" => $rc_validation1['result']['unladenWeight'],
                                                    "vehicle_category_description" => $rc_validation1['result']['vehicleCategory'],
                                                    "pucc_number" => $rc_validation1['result']['puccNumber'],
                                                    "pucc_upto" => $rc_validation['data']['pucc_upto'],
                                                    'hit_month' => date('Y-m'),
                                                    'national_permit_issued_by' => $rc_validation1['result']['nationalPermitIssuedBy'],
                                                    'national_permit_number' => $rc_validation1['result']['nationalPermitNumber'],
                                                    'national_permit_upto' => $rc_validation1['result']['nationalPermitUpto'],
                                                    'permit_type' => $rc_validation1['result']['permitType'],
                                                    'permit_valid_from' => $rc_validation1['result']['permitValidFrom'],
                                                    'permit_number' => $rc_validation1['result']['permitNumber'],
                                                    'permit_valid_upto' => $rc_validation1['result']['permitValidUpto'],
                                                    'permit_issue_date' => $rc_validation1['result']['permitIssueDate'],
                                                    'noc_details' => $rc_validation1['result']['nocDetails'],
                                                    'latest_by' => $rc_validation1['result']['statusAsOn'],
                                                    'message_code' => 'NA',
                                                    'non_use_to' => $rc_validation1['result']['nonUseTo'],
                                                    'non_use_from' => $rc_validation1['result']['nonUseFrom'],
                                                    'non_use_status' => $rc_validation1['result']['nonUseStatus'],
                                                    // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                                    "created_at" => Carbon::now(),
                                                    "updated_at" => Carbon::now(),
                                                    'service_provider' => 'emptraV2'
                                                ]);
                                            }
                                        } else if ($rc_validation1['code'] == "200" || $rc_validation1['code'] == "103") {
                                            $statusCode = 102;
                                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                            if ($user->role_id == 1) {
                                                if ($apiamster) {
                                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
                                                }
                                                // $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                                $rcvalidation = DB::table('rcvalidation')->insert([
                                                    "user_id" => $user->id,
                                                    "api_id" => $api_id,
                                                    "status_code" => $statusCode,
                                                    "rc_number" => $rcNumber,
                                                    "created_at" => Carbon::now(),
                                                    "updated_at" => Carbon::now(),
                                                    'service_provider' => 'emptraV2'
                                                ]);
                                            }
                                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                        } else if ($rc_validation1['code'] == "400") {
                                            $statusCode = 102;
                                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                            if ($user->role_id == 1) {
                                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                                $rcvalidation = DB::table('rcvalidation')->insert([
                                                    "user_id" => $user->id,
                                                    "api_id" => $api_id,
                                                    "status_code" => $statusCode,
                                                    "rc_number" => $rcNumber,
                                                    "created_at" => Carbon::now(),
                                                    "updated_at" => Carbon::now(),
                                                    'service_provider' => 'emptraV2'
                                                ]);
                                            }
                                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                        } else {
                                            // if(isset($rc_validation['message']) && $rc_validation['message'] != 'success')
                                            if ($rc_validation1['code'] != '100') {
                                                if ($rc_validation1['code'] == 404 || $rc_validation1['code'] == 502 || $rc_validation1['code'] == 500) {
                                                    // $statusCode = 101;
                                                    // $errorMessage = 'RC Number in Multiple RTOs.';
                                                    // }else if($rc_validation['reponseCode'] == 502){
                                                    $statusCode = 102;
                                                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                                } else if ($rc_validation1['code'] == '104') {
                                                    $statusCode = 500;
                                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                                } else {
                                                    $statusCode = 404;
                                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                                }
                                                if ($user->role_id == 1) {
                                                    if ($apiamster) {
                                                        // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                                    }
                                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                                        "user_id" => $user->id,
                                                        "api_id" => $api_id,
                                                        "status_code" => $statusCode,
                                                        "rc_number" => $rcNumber,
                                                        "created_at" => Carbon::now(),
                                                        "updated_at" => Carbon::now(),
                                                        'service_provider' => 'emptraV2'
                                                    ]);
                                                }
                                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                            }
                                        }
                                    } catch (\GuzzleHttp\Exception\RequestException $e) {
                                        $response = $e->getResponse();
                                        $status = json_decode((string) $response->getBody());
                                        $statusCode = $e->getResponse()->getStatusCode();
                                        if ($statusCode == 500 || $statusCode == 401) {
                                            $statusCode = 102;
                                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                            // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                            if ($user->role_id == 1) {
                                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                            }
                                        } else if ($statusCode == 403) {
                                            if ($status->message_code == 'multiple_rto') {
                                                $statusCode = 101;
                                                $errorMessage = 'RC Number in Multiple RTOs.';
                                            } else {
                                                $statusCode = 102;
                                                $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                            }
                                            if ($user->role_id == 1) {
                                                if ($apiamster) {
                                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                                }
                                            }
                                        } else {
                                            $statusCode = 500;
                                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                            if ($user->role_id == 1) {
                                                if ($apiamster) {
                                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                                }
                                            }
                                        }
                                        if ($user->role_id == 1) {
                                            $rcvalidation = DB::table('rcvalidation')->insert([
                                                "user_id" => $user->id,
                                                "api_id" => $api_id,
                                                "status_code" => $statusCode,
                                                "rc_number" => $rcNumber,
                                                "created_at" => Carbon::now(),
                                                "updated_at" => Carbon::now(),
                                                'service_provider' => 'emptraV2'
                                            ]);
                                        }
                                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                    }
                                }
                            } else {
                                if (isset($rc_validation['message']) && $rc_validation['message'] != 'success') {
                                    if ($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500) {
                                        // $statusCode = 101;
                                        // $errorMessage = 'RC Number in Multiple RTOs.';
                                        // }else if($rc_validation['reponseCode'] == 502){
                                        $statusCode = 102;
                                        $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                    } else if ($rc_validation['error_code'] == 'SPC-201') {
                                        $statusCode = 500;
                                        $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                    } else {
                                        $statusCode = 404;
                                        $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                    }
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                        }
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            "user_id" => $user->id,
                                            "api_id" => $api_id,
                                            "status_code" => $statusCode,
                                            "rc_number" => $rcNumber,
                                            "created_at" => Carbon::now(),
                                            "updated_at" => Carbon::now(),
                                            'service_provider' => $service_provider
                                        ]);
                                    }
                                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                }
                            }
                        } catch (\GuzzleHttp\Exception\RequestException $e) {
                            $response = $e->getResponse();
                            $status = json_decode((string) $response->getBody());
                            $statusCode = $e->getResponse()->getStatusCode();
                            if ($statusCode == 500 || $statusCode == 401) {
                                $statusCode = 102;
                                $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                            } else if ($statusCode == 403) {
                                if ($status->message_code == 'multiple_rto') {
                                    $statusCode = 101;
                                    $errorMessage = 'RC Number in Multiple RTOs.';
                                } else {
                                    $statusCode = 102;
                                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                }
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            } else {
                                $statusCode = 500;
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            }
                            if ($user->role_id == 1) {
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    "status_code" => $statusCode,
                                    "rc_number" => $rcNumber,
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),
                                    'service_provider' => $service_provider
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }
                } else {
                    return response()->json(['statusCode' => 102, 'message' => 'Verification Failed. Please enter correct State Code.']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
    }

    // public function rc_validationwithemptranew(Request $request) {
    //     // return 'testnewemptra';
    //     $statusCode = null;
    //     $rc_validation = null;
    //     $api_id = null;
    //     $service_provider = "emptraV2";

    //     if(empty($request->rc_number))
    //         return response()->json(array(['statusCode'=>'404', 'message'=>'RC number is required']));

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['statusCode'=>'404', 'message'=>'Header Access Token is required']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     if($user->role_id==1) {
    //         $apiamster = ApiMaster::where('api_slug','rc')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //     }

    //     $client = new Client();
    //     $headers = [
    //         'Accept'        => 'application/json',
    //     ];

    //     $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //     if($updateHitCount || $user->role_id==0){
    //         // return 'false';
    //         $rcNumber = str_replace('-', '', $request->rc_number);
    //         $subString = strtoupper(substr($rcNumber, 0, 2));

    //         if($subString == "AP" || $subString == "AR" || $subString == "AS"|| $subString == "BR" || $subString == "CG" || $subString == "GA" || $subString == "GJ" || $subString == "HR" || $subString == "HP" || $subString == "JH" || $subString == "KA" || $subString == "KL" || $subString == "MP" || $subString == "MH" || $subString == "MN" || $subString == "ML" || $subString == "MZ" || $subString == "NL" || $subString == "OD" || $subString == "PB" || $subString == "RJ" || $subString == "SK" || $subString == "TN" || $subString == "TR" || $subString == "UP" || $subString == "UK" || $subString == "UA" || $subString == "WB" || $subString == "TS" || $subString == "AN" || $subString == "CH" || $subString == "DN" || $subString == "DD" || $subString == "JK" || $subString == "LA" || $subString == "LD" || $subString == "DL" || $subString == "PY"){
    //             // return 'true';
    //             $currentMonth = date('Y-m');
    //             $rcdata = DB::table('rcvalidation')->where('rc_number', $rcNumber)->where('hit_month', $currentMonth)->where('status_code', '200')->orderby('id', 'DESC')->first();
    //             // return $rcdata;
    //             if(!empty($rcdata) && ($rcdata->rc_status != '' || $rcdata->rc_status != null)){
    //                 // return 'ok not test';

    //                 $insuransespace = "-";
    //                 $updatedate = "2023";
    //                 $rcinsurance = $rcdata->insurance_upto;
    //                 $newrcinsurance =  (explode("-",$rcinsurance));
    //                 // return $rcinsurance;
    //                 // return $rcinsurance->count();
    //                 if($rcinsurance != 'NA'){
    //                     // return 'tester';
    //                     $allinsurance = $updatedate.$insuransespace.$newrcinsurance[1].$insuransespace. $newrcinsurance[2];
    //                 }
    //                     else{
    //                         $allinsurance = '2023-12-12';
    //                     }
    //                 $statusCode = 200;

    //                 $rc_validation['data']['rc_number'] = $rcdata->rc_number;
    //                 $rc_validation['data']['norms_type'] = $rcdata->norms_type;
    //                 $rc_validation['data']['rc_status'] = $rcdata->rc_status;
    //                 $rc_validation['data']['vehicle_gross_weight'] = $rcdata->vehicle_gross_weight;
    //                 $rc_validation['data']['unladen_weight'] = $rcdata->unladen_weight;
    //                 $rc_validation['data']['manufacturing_date'] = $rcdata->manufacturing_date;
    //                 $rc_validation['data']['seat_capacity'] = $rcdata->seat_capacity;
    //                 $rc_validation['data']['national_permit_issued_by'] = $rcdata->national_permit_issued_by;
    //                 $rc_validation['data']['national_permit_number'] = $rcdata->national_permit_number;
    //                 $rc_validation['data']['national_permit_upto'] = $rcdata->national_permit_upto;
    //                 $rc_validation['data']['insurance_company'] = $rcdata->insurance_company;
    //                 $rc_validation['data']['insurance_policy_number'] = $rcdata->insurance_policy_number;
    //                 // $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
    //                 if($newrcinsurance[0] <2022){
    //                     $rc_validation['data']['insurance_upto'] = $allinsurance;
    //                 }
    //                     else{
    //                     $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;   
    //                 }
    //                 $rc_validation['data']['permit_type'] = $rcdata->permit_type;
    //                 $rc_validation['data']['permit_valid_from'] = $rcdata->permit_valid_from;
    //                 $rc_validation['data']['permit_number'] = $rcdata->permit_number;
    //                 $rc_validation['data']['permit_valid_upto'] = $rcdata->permit_valid_upto;
    //                 $rc_validation['data']['permit_issue_date'] = $rcdata->permit_issue_date;
    //                 $rc_validation['data']['noc_details'] = $rcdata->noc_details;
    //                 $rc_validation['data']['body_type'] = $rcdata->body_type;
    //                 $rc_validation['data']['father_name'] = $rcdata->father_name;
    //                 $rc_validation['data']['owner_name'] = $rcdata->owner_name;
    //                 $rc_validation['data']['permanent_address'] = $rcdata->permanent_address;
    //                 $rc_validation['data']['present_address'] = $rcdata->present_address;
    //                 $rc_validation['data']['pucc_number'] = $rcdata->pucc_number;
    //                 $rc_validation['data']['pucc_upto'] = $rcdata->pucc_upto;
    //                 $rc_validation['data']['blacklist_status'] = $rcdata->blacklist_status;
    //                 $rc_validation['data']['maker_model'] = $rcdata->maker_model;
    //                 $rc_validation['data']['maker_description'] = $rcdata->maker_description;
    //                 $rc_validation['data']['fit_up_to'] = $rcdata->fit_up_to;
    //                 $rc_validation['data']['standing_capacity'] = $rcdata->standing_capacity;
    //                 $rc_validation['data']['sleeper_capacity'] = $rcdata->sleeper_capacity;
    //                 $rc_validation['data']['wheelbase'] = $rcdata->wheelbase;
    //                 $rc_validation['data']['vehicle_category_description'] = $rcdata->vehicle_category_description;
    //                 $rc_validation['data']['vehicle_category'] = $rcdata->vehicle_category;
    //                 $rc_validation['data']['vehicle_chasi_number'] = $rcdata->vehicle_chasi_number;
    //                 $rc_validation['data']['vehicle_engine_number'] = $rcdata->vehicle_engine_number;
    //                 $rc_validation['data']['mobile_number'] = $rcdata->mobile_number;
    //                 $rc_validation['data']['financer'] = $rcdata->financer;
    //                 // $rc_validation['data']['rc_number'] = $rcdata->['code'];
    //                 // $rc_validation['data']['rc_number'] = $rcdata->['stateCd'];
    //                 $rc_validation['data']['latest_by'] = $rcdata->latest_by;
    //                 $rc_validation['data']['tax_upto'] = $rcdata->tax_upto;
    //                 $rc_validation['data']['message_code'] = $rcdata->message_code;
    //                 $rc_validation['data']['non_use_to'] = $rcdata->non_use_to;
    //                 $rc_validation['data']['non_use_from'] = $rcdata->non_use_from;
    //                 $rc_validation['data']['non_use_status'] = $rcdata->non_use_status;
    //                 $rc_validation['data']['fuel_type'] = $rcdata->fuel_type;
    //                 $rc_validation['data']['registered_at'] = $rcdata->registered_at;
    //                 $rc_validation['data']['registration_date'] = $rcdata->registration_date;
    //                 $rc_validation['data']['color'] = $rcdata->color;
    //                 $rc_validation['data']['owner_number'] = $rcdata->owner_number;
    //                 $rc_validation['data']['no_cylinders'] = $rcdata->no_cylinders;
    //                 $rc_validation['data']['cubic_capacity'] = $rcdata->cubic_capacity;
    //                 $rc_validation['status_code'] = 200;
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                     }
    //                     $rcvalidation = DB::table('rcvalidation')->insert([
    //                         "user_id"=> $user->id,
    //                         "api_id"=> $api_id,
    //                         // "client_id"=> $rc_validation['data']['client_id'],
    //                         "status_code"=> 200,
    //                         "rc_number"=> $rcdata->rc_number,
    //                         "rc_status"=> $rcdata->rc_status,
    //                         "owner_number"=> $rcdata->owner_number,
    //                         "tax_upto"=> $rcdata->tax_upto,
    //                         "blacklist_status"=> $rcdata->blacklist_status,
    //                         "father_name"=> $rcdata->father_name,
    //                         "registration_date"=> $rcdata->registration_date,
    //                         "owner_name"=> $rcdata->owner_name,
    //                         "present_address"=> $rcdata->present_address,
    //                         "permanent_address"=> $rcdata->permanent_address,
    //                         "mobile_number"=> $rcdata->mobile_number,
    //                         "vehicle_category"=> $rcdata->vehicle_category,
    //                         "vehicle_chasi_number"=> $rcdata->vehicle_chasi_number,
    //                         "vehicle_engine_number"=> $rcdata->vehicle_engine_number,
    //                         "maker_description"=> $rcdata->maker_description,
    //                         "maker_model"=> $rcdata->maker_model,
    //                         "body_type"=> $rcdata->body_type,
    //                         "fuel_type"=> $rcdata->fuel_type,
    //                         "color"=> $rcdata->color,
    //                         "norms_type"=> $rcdata->norms_type,
    //                         "fit_up_to"=> $rcdata->fit_up_to,
    //                         "financer"=> $rcdata->financer,
    //                         "insurance_company"=> $rcdata->insurance_company,
    //                         "insurance_policy_number"=> $rcdata->insurance_policy_number,
    //                         "insurance_upto"=> $rcdata->insurance_upto,
    //                         "manufacturing_date"=> $rcdata->manufacturing_date,
    //                         "registered_at"=> $rcdata->registered_at,
    //                         "less_info"=> 1,
    //                         "cubic_capacity"=> $rcdata->cubic_capacity,
    //                         "vehicle_gross_weight"=> $rcdata->vehicle_gross_weight,
    //                         "no_cylinders"=> $rcdata->no_cylinders,
    //                         "seat_capacity"=> $rcdata->seat_capacity,
    //                         "sleeper_capacity"=> $rcdata->sleeper_capacity,
    //                         "standing_capacity"=> $rcdata->standing_capacity,
    //                         "wheelbase"=> $rcdata->wheelbase,
    //                         "unladen_weight"=> $rcdata->unladen_weight,
    //                         "vehicle_category_description"=> $rcdata->vehicle_category_description,
    //                         "pucc_number"=> $rcdata->pucc_number,
    //                         "pucc_upto"=> $rcdata->pucc_upto,
    //                         'hit_month'=> date('Y-m'),
    //                         'national_permit_issued_by'=> $rcdata->national_permit_issued_by,
    //                         'national_permit_number'=> $rcdata->national_permit_number,
    //                         'national_permit_upto'=> $rcdata->national_permit_upto,
    //                         'permit_type'=> $rcdata->permit_type,
    //                         'permit_valid_from'=> $rcdata->permit_valid_from,
    //                         'permit_number'=> $rcdata->permit_number,
    //                         'permit_valid_upto'=> $rcdata->permit_valid_upto,
    //                         'permit_issue_date'=> $rcdata->permit_issue_date,
    //                         'noc_details'=> $rcdata->noc_details,
    //                         'latest_by'=> $rcdata->latest_by,
    //                         'message_code'=> $rcdata->message_code,
    //                         'non_use_to'=> $rcdata->non_use_to,
    //                         'non_use_from'=> $rcdata->non_use_from,
    //                         'non_use_status'=> $rcdata->non_use_status,
    //                         // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
    //                         "created_at"=> Carbon::now(),
    //                         "updated_at"=> Carbon::now(),
    //                         'service_provider'=> 'database'
    //                     ]);
    //                 }
    //             }else{

    //                 try{


    //                     $rc_validation = [];
    //                     // $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number='.$rcNumber, ['headers' => $headers]);
    //                     $res = $client->get('https://softpayapi.com/api/rc.aspx?Api_Key=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&vehicalno='.$rcNumber, ['headers' => $headers]);
    //                     $rc_validation1 = json_decode($res->getBody(), true);
    //                     return  $rc_validation1;


    //                     // $rc_validation1 = json_decode($result['vehicleDetails'], true);
    //                     // if(isset($rc_validation1['error_code'])){
    //                     //     $statusCode = 200;
    //                     // }
    //                     // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
    //                     // if($grossWeight){
    //                     //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
    //                     //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
    //                     //     $checkweight = array();
    //                     //     $checkweight['tag_class'] = $checkWeight->tag_class;
    //                     // }else{
    //                     //     $checkweight['tag_class'] = '';
    //                     // }
    //                     if( $rc_validation1['fitness_upto'] != null &&  $rc_validation1['fitness_upto'] != 'NA' && Carbon::parse( $rc_validation1['fitness_upto'])->isPast() == true){
    //                         $rc_validation['data']['rc_status'] = '';
    //                     }else{
    //                         $rc_validation['data']['rc_status'] = 'ACTIVE';
    //                     }

    //                     // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
    //                     if($rc_validation1['error_code'] == "SPC-200"){

    //                         $insuransespace = "-";
    //                         $updatedate = "2023";
    //                         $rcinsurance = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
    //                         $newrcinsurance =  (explode("-",$rcinsurance));
    //                         // $allinsurance = $newrcinsurance[0].$insuransespace.$newrcinsurance[1].$insuransespace. $updatedate;
    //                         if(!empty($rcinsurance)){
    //                             // return 'tester';
    //                             $allinsurance = $updatedate.$insuransespace.$newrcinsurance[1].$insuransespace. $newrcinsurance[2];
    //                         }
    //                         else{
    //                             $allinsurance = '2023-12-12';
    //                         }

    //                         $statusCode = 200;
    //                         $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['vehicleNumber'];
    //                         $rc_validation['data']['norms_type'] = $rc_validation1['vehicleDetails']['rcNormsDesc'];
    //                         // $rc_validation['data']['rc_status'] = $rc_validation1['vehicleDetails']['rcStatus'];
    //                         $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['vehicleDetails']['rcGvw'];
    //                         $rc_validation['data']['unladen_weight'] = $rc_validation1['vehicleDetails']['rcUnldWt'];
    //                         $rc_validation['data']['manufacturing_date'] = $rc_validation1['vehicleDetails']['rcManuMonthYr'];
    //                         $rc_validation['data']['seat_capacity'] = $rc_validation1['vehicleDetails']['rcSeatCap'];
    //                         $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['vehicleDetails']['rcNpIssuedBy'];
    //                         $rc_validation['data']['national_permit_number'] = $rc_validation1['vehicleDetails']['rcNpNo'];
    //                         $rc_validation['data']['national_permit_upto'] = $rc_validation1['vehicleDetails']['rcNpUpto'];
    //                         $rc_validation['data']['insurance_company'] = $rc_validation1['vehicleDetails']['rcInsuranceComp'];
    //                         $rc_validation['data']['insurance_policy_number'] = $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'];
    //                         if(isset($rc_validation1['vehicleDetails']['rcInsuranceUpto']) && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != null && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != "null" && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != 'NA'){
    //                             // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
    //                             if($newrcinsurance[2] < 2022){
    //                                 $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
    //                             }else{
    //                                 $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
    //                             }
    //                         }else{
    //                             $rc_validation['data']['insurance_upto'] = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
    //                         }

    //                         $rc_validation['data']['permit_type'] = $rc_validation1['vehicleDetails']['rcPermitType'];
    //                         $rc_validation['data']['permit_valid_from'] = $rc_validation1['vehicleDetails']['rcPermitValidFrom'];
    //                         $rc_validation['data']['permit_number'] = $rc_validation1['vehicleDetails']['rcPermitNo'];
    //                         $rc_validation['data']['permit_valid_upto'] = $rc_validation1['vehicleDetails']['rcPermitValidUpto'];
    //                         $rc_validation['data']['permit_issue_date'] = $rc_validation1['vehicleDetails']['rcPermitIssueDt'];
    //                         $rc_validation['data']['noc_details'] = $rc_validation1['vehicleDetails']['rcNocDetails'];
    //                         $rc_validation['data']['body_type'] = $rc_validation1['vehicleDetails']['rcBodyTypeDesc'];
    //                         $rc_validation['data']['father_name'] = $rc_validation1['vehicleDetails']['rcFName'];
    //                         $rc_validation['data']['owner_name'] = $rc_validation1['vehicleDetails']['rcOwnerName'];
    //                         $rc_validation['data']['permanent_address'] = $rc_validation1['vehicleDetails']['rcPermanentAddress'];
    //                         $rc_validation['data']['present_address'] = $rc_validation1['vehicleDetails']['rcPresentAddress'];
    //                         $rc_validation['data']['pucc_number'] = $rc_validation1['vehicleDetails']['rcPuccNo'];
    //                         if(isset($rc_validation1['vehicleDetails']['rcPuccUpto']) && $rc_validation1['vehicleDetails']['rcPuccUpto'] != null && $rc_validation1['vehicleDetails']['rcPuccUpto'] != "null" && $rc_validation1['vehicleDetails']['rcPuccUpto'] != 'NA'){
    //                             $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcPuccUpto'])->format('Y-m-d');
    //                         }else{
    //                             $rc_validation['data']['pucc_upto'] = $rc_validation1['vehicleDetails']['rcPuccUpto'];
    //                         }
    //                         $rc_validation['data']['blacklist_status'] = $rc_validation1['vehicleDetails']['rcBlacklistStatus'];
    //                         $rc_validation['data']['maker_model'] = $rc_validation1['vehicleDetails']['rcMakerModel'];
    //                         $rc_validation['data']['maker_description'] = $rc_validation1['vehicleDetails']['rcMakerDesc'];
    //                         if(isset($rc_validation1['vehicleDetails']['rcFitUpto']) && $rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != "null" && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA'){
    //                             $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->format('Y-m-d');
    //                         }else{
    //                             $rc_validation['data']['fit_up_to'] = $rc_validation1['vehicleDetails']['rcFitUpto'];
    //                         }
    //                         $rc_validation['data']['standing_capacity'] = $rc_validation1['vehicleDetails']['rcStandCap'];
    //                         $rc_validation['data']['sleeper_capacity'] = $rc_validation1['vehicleDetails']['rcSleeperCap'];
    //                         $rc_validation['data']['wheelbase'] = $rc_validation1['vehicleDetails']['rcWheelbase'];
    //                         $rc_validation['data']['vehicle_category_description'] = $rc_validation1['vehicleDetails']['rcVhClassDesc'];
    //                         $rc_validation['data']['vehicle_category'] = $rc_validation1['vehicleDetails']['rcVchCatg'];
    //                         $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['vehicleDetails']['rcChasiNo'];
    //                         $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['vehicleDetails']['rcEngNo'];
    //                         $rc_validation['data']['mobile_number'] = $rc_validation1['vehicleDetails']['rcMobileNo'];
    //                         $rc_validation['data']['financer'] = $rc_validation1['vehicleDetails']['rcFinancer'];
    //                         // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
    //                         // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
    //                         $rc_validation['data']['latest_by'] = $rc_validation1['vehicleDetails']['rcStatusAsOn'];
    //                         $rc_validation['data']['tax_upto'] = $rc_validation1['vehicleDetails']['rcTaxUpto'];
    //                         $rc_validation['data']['message_code'] = $rc_validation1['vehicleDetails']['stautsmessage'];
    //                         $rc_validation['data']['non_use_to'] = $rc_validation1['vehicleDetails']['rcNonUseTo'];
    //                         $rc_validation['data']['non_use_from'] = $rc_validation1['vehicleDetails']['rcNonUseFrom'];
    //                         $rc_validation['data']['non_use_status'] = $rc_validation1['vehicleDetails']['rcNonUseStatus'];
    //                         $rc_validation['data']['fuel_type'] = $rc_validation1['vehicleDetails']['rcFuelDesc'];
    //                         $rc_validation['data']['registered_at'] = $rc_validation1['vehicleDetails']['rcRegisteredAt'];
    //                         if(isset($rc_validation1['vehicleDetails']['rcRegnDt']) && $rc_validation1['vehicleDetails']['rcRegnDt'] != null && $rc_validation1['vehicleDetails']['rcRegnDt'] != "null" && $rc_validation1['vehicleDetails']['rcRegnDt'] != 'NA'){
    //                             $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['vehicleDetails']['rcRegnDt'])->format('Y-m-d');
    //                         }else{
    //                             $rc_validation['data']['registration_date'] = $rc_validation1['vehicleDetails']['rcRegnDt'];
    //                         }

    //                         $rc_validation['data']['color'] = $rc_validation1['vehicleDetails']['rcColor'];
    //                         $rc_validation['data']['owner_number'] = $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'];
    //                         $rc_validation['data']['no_cylinders'] = $rc_validation1['vehicleDetails']['rcNoCyl'];
    //                         $rc_validation['data']['cubic_capacity'] = $rc_validation1['vehicleDetails']['rcCubicCap'];
    //                         $rc_validation['status_code'] = 200;
    //                         if($user->role_id==1) {
    //                             if($apiamster) {
    //                                 $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                             }
    //                             $rcvalidation = DB::table('rcvalidation')->insert([
    //                                 "user_id"=> $user->id,
    //                                 "api_id"=> $api_id,
    //                                 // "client_id"=> $rc_validation['data']['client_id'],
    //                                 "status_code"=> 200,
    //                                 "rc_number"=> $rc_validation1['vehicleDetails']['vehicleNumber'],
    //                                 "rc_status"=> $rc_validation1['vehicleDetails']['rcStatus'],
    //                                 "owner_number"=> $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'],
    //                                 "tax_upto"=> $rc_validation1['vehicleDetails']['rcTaxUpto'],
    //                                 "blacklist_status"=> $rc_validation1['vehicleDetails']['rcBlacklistStatus'],
    //                                 "father_name"=> $rc_validation1['vehicleDetails']['rcFName'],
    //                                 "registration_date"=> $rc_validation['data']['registration_date'],
    //                                 "owner_name"=> $rc_validation1['vehicleDetails']['rcOwnerName'],
    //                                 "present_address"=> $rc_validation1['vehicleDetails']['rcPresentAddress'],
    //                                 "permanent_address"=> $rc_validation1['vehicleDetails']['rcPermanentAddress'],
    //                                 "mobile_number"=> $rc_validation1['vehicleDetails']['rcMobileNo'],
    //                                 "vehicle_category"=> $rc_validation1['vehicleDetails']['rcVchCatg'],
    //                                 "vehicle_chasi_number"=> $rc_validation1['vehicleDetails']['rcChasiNo'],
    //                                 "vehicle_engine_number"=> $rc_validation1['vehicleDetails']['rcEngNo'],
    //                                 "maker_description"=> $rc_validation1['vehicleDetails']['rcMakerDesc'],
    //                                 "maker_model"=> $rc_validation1['vehicleDetails']['rcMakerModel'],
    //                                 "body_type"=> $rc_validation1['vehicleDetails']['rcBodyTypeDesc'],
    //                                 "fuel_type"=> $rc_validation1['vehicleDetails']['rcFuelDesc'],
    //                                 "color"=> $rc_validation1['vehicleDetails']['rcColor'],
    //                                 "norms_type"=> $rc_validation1['vehicleDetails']['rcNormsDesc'],
    //                                 "fit_up_to"=> $rc_validation['data']['fit_up_to'],
    //                                 "financer"=> $rc_validation1['vehicleDetails']['rcFinancer'],
    //                                 "insurance_company"=> $rc_validation1['vehicleDetails']['rcInsuranceComp'],
    //                                 "insurance_policy_number"=> $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'],
    //                                 "insurance_upto"=> $rc_validation['data']['insurance_upto'],
    //                                 "manufacturing_date"=> $rc_validation1['vehicleDetails']['rcManuMonthYr'],
    //                                 "registered_at"=> $rc_validation1['vehicleDetails']['rcRegisteredAt'],
    //                                 "less_info"=> 1,
    //                                 "cubic_capacity"=> $rc_validation1['vehicleDetails']['rcCubicCap'],
    //                                 "vehicle_gross_weight"=> $rc_validation1['vehicleDetails']['rcGvw'],
    //                                 "no_cylinders"=> $rc_validation1['vehicleDetails']['rcNoCyl'],
    //                                 "seat_capacity"=> $rc_validation1['vehicleDetails']['rcSeatCap'],
    //                                 "sleeper_capacity"=> $rc_validation1['vehicleDetails']['rcSleeperCap'],
    //                                 "standing_capacity"=> $rc_validation1['vehicleDetails']['rcStandCap'],
    //                                 "wheelbase"=> $rc_validation1['vehicleDetails']['rcWheelbase'],
    //                                 "unladen_weight"=> $rc_validation1['vehicleDetails']['rcUnldWt'],
    //                                 "vehicle_category_description"=> $rc_validation1['vehicleDetails']['rcVhClassDesc'],
    //                                 "pucc_number"=> $rc_validation1['vehicleDetails']['rcPuccNo'],
    //                                 "pucc_upto"=> $rc_validation['data']['pucc_upto'],
    //                                 'hit_month'=> date('Y-m'),
    //                                 'national_permit_issued_by'=> $rc_validation1['vehicleDetails']['rcNpIssuedBy'],
    //                                 'national_permit_number'=> $rc_validation1['vehicleDetails']['rcNpNo'],
    //                                 'national_permit_upto'=> $rc_validation1['vehicleDetails']['rcNpUpto'],
    //                                 'permit_type'=> $rc_validation1['vehicleDetails']['rcPermitType'],
    //                                 'permit_valid_from'=> $rc_validation1['vehicleDetails']['rcPermitValidFrom'],
    //                                 'permit_number'=> $rc_validation1['vehicleDetails']['rcPermitNo'],
    //                                 'permit_valid_upto'=> $rc_validation1['vehicleDetails']['rcPermitValidUpto'],
    //                                 'permit_issue_date'=> $rc_validation1['vehicleDetails']['rcPermitIssueDt'],
    //                                 'noc_details'=> $rc_validation1['vehicleDetails']['rcNocDetails'],
    //                                 'latest_by'=> $rc_validation1['vehicleDetails']['rcStatusAsOn'],
    //                                 'message_code'=> $rc_validation1['vehicleDetails']['stautsmessage'],
    //                                 'non_use_to'=> $rc_validation1['vehicleDetails']['rcNonUseTo'],
    //                                 'non_use_from'=> $rc_validation1['vehicleDetails']['rcNonUseFrom'],
    //                                 'non_use_status'=> $rc_validation1['vehicleDetails']['rcNonUseStatus'],
    //                                 // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
    //                                 "created_at"=> Carbon::now(),
    //                                 "updated_at"=> Carbon::now(),
    //                                 'service_provider'=> $service_provider
    //                             ]);
    //                         }
    //                     }
    //                     // else if($rc_validation1['error_code'] == "SPC-201"){
    //                     //     return 'test';
    //                     //     $statusCode = 500;
    //                     //     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                     //     if($user->role_id==1) {
    //                     //         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                     //         $rcvalidation = DB::table('rcvalidation')->insert([
    //                     //             "user_id"=> $user->id,
    //                     //             "api_id"=> $api_id,
    //                     //             "status_code"=> $statusCode,
    //                     //             "rc_number"=> $rcNumber,
    //                     //             "created_at"=> Carbon::now(),
    //                     //             "updated_at"=> Carbon::now(),
    //                     //             'service_provider'=> $service_provider
    //                     //         ]);
    //                     //     }
    //                     //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                     // }
    //                     else if($rc_validation1['error_code'] == "SPC-203" || $rc_validation1['error_code'] == "SPC-206" || $rc_validation1['error_code'] == "SPC-201"){
    //                         // return 'tester';
    //                         $statusCode = 102;
    //                         if($rc_validation1['error_code'] == "SPC-203" && $rc_validation1['message'] != 'Record not found')
    //                        {
    //                         $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
    //                         if($user->role_id==1) {
    //                             $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                             $rcvalidation = DB::table('rcvalidation')->insert([
    //                                 "user_id"=> $user->id,
    //                                 "api_id"=> $api_id,
    //                                 "status_code"=> $statusCode,
    //                                 "rc_number"=> $rcNumber,
    //                                 "created_at"=> Carbon::now(),
    //                                 "updated_at"=> Carbon::now(),
    //                                 'service_provider'=> $service_provider
    //                             ]);
    //                         }
    //                         return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                         }
    //                         else{

    //                             try{
    //                                 // return 'try';
    //                                 $client = new Client();
    //                                 // $rcnomber = 'MH16AJ1013';
    //                                 $blacklistcheck = 'true';
    //                                 // $headerss = [
    //                                 //     // 'Authorization' => $this->nsdlToken,        
    //                                 //     'secretKey' => 'pI76u95BabjkIFg6DNNRole7gZn71ljPk7W5WIHzApjlObIMywuq8pZGa30HXm5wR',   
    //                                 //     'clientId' => 'ef41c6d7089614d1838c68efc81a8493:dc983c1bfbc4390f4952bd44ed0ae690'
    //                                 // ];

    //                                 // // return 'test the try in try';
    //                                 // $rc_validation = [];
    //                                 // $res = $client->post('https://api.emptra.com/vehicleRegistrationsV3', ['headers' => $headerss, 'form_params'=> ['vehicleNumber'=>$request->rc_number,'blacklistCheck'=>$blacklistcheck]]);
    //                                 // $rc_validation1 = json_decode($res->getBody(), true);


    //                                 // $url = 'https://api.emptra.com/vehicleRegistrationsV3';

    //                                 // $data = array(
    //                                 //     "vehicleNumber" => $request->rc_number,
    //                                 // );

    //                                 // $body = json_encode($data);

    //                                 // $ch = curl_init($url);

    //                                 // curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
    //                                 // curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: ".$this->secretKey,"clientId: ".$this->clientId,'Content-Type:application/json'));
    //                                 // curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    //                                 // $get_data1 = curl_exec($ch);
    //                                 // $rc_validation1 = json_decode($get_data1, true);
    //                                 $url = 'https://api.emptra.com/vehicleRegistrationsV2';

    //                                 $data = array(
    //                                     "vehicleNumber" => $request->rc_number,
    //                                     "blacklistCheck" => false
    //                                 );

    //                                 $body = json_encode($data);
    //                                 // return $data;

    //                                 $ch = curl_init($url);

    //                                 curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
    //                                 curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: ".$this->secretKey,"clientId: ".$this->clientId,'Content-Type:application/json'));
    //                                 curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

    //                                 $get_data1 = curl_exec($ch);
    //                                 $rc_validation1 = json_decode($get_data1, true);
    //                                 // return $rc_validation1;
    //                                 // return $rc_validation1;


    //                                 // return $rc_validation1['result']['rcExpiryDate'];
    //                                 // $rc_validation1 = json_decode($result['vehicleDetails'], true);
    //                                 // if(isset($rc_validation1['error_code'])){
    //                                 //     $statusCode = 200;
    //                                 // }
    //                                 // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
    //                                 // if($grossWeight){
    //                                 //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
    //                                 //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
    //                                 //     $checkweight = array();
    //                                 //     $checkweight['tag_class'] = $checkWeight->tag_class;
    //                                 // }else{
    //                                 //     $checkweight['tag_class'] = '';
    //                                 // }
    //                                 // if($rc_validation1['result']['rcExpiryDate'] != null && $rc_validation1['result']['rcExpiryDate'] != 'NA'){
    //                                 //     $rc_validation['data']['rc_status'] = '';
    //                                 // }else{
    //                                 //     $rc_validation['data']['rc_status'] = 'ACTIVE';
    //                                 // }

    //                                 // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
    //                                 if($rc_validation1['code'] == "100" || $rc_validation1['code'] == "200"){

    //                                     // return $rc_validation1['result'];

    //                                     $insuransespace = "/";
    //                                     $updatedate = "2023";
    //                                     $rcinsurance = $rc_validation1['result']['vehicleInsuranceUpto'];
    //                                     // return $rcinsurance;
    //                                     $newrcinsurance =  (explode("/",$rcinsurance));
    //                                     // return $newrcinsurance;
    //                                     // $allinsurance = $newrcinsurance[0].$insuransespace.$newrcinsurance[1].$insuransespace. $updatedate;
    //                                     if($rcinsurance != 'NA'){
    //                                         // return 'tester';
    //                                         $allinsurance = $newrcinsurance[0].$insuransespace. $newrcinsurance[1].$insuransespace.$updatedate;
    //                                     }
    //                                     else{
    //                                         $allinsurance = '2023-12-12';
    //                                     }
    //                                     // return $allinsurance;

    //                                     $statusCode = 200;
    //                                     // $rc_validation['data']['rc_number'] = $rc_validation1['result']['rc_number'];
    //                                     // $rc_validation['data']['norms_type'] = $rc_validation1['result']['norms_type'];
    //                                     // $rc_validation['data']['rc_status'] = $rc_validation1['result']['rc_status'];
    //                                     // $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['result']['vehicle_gross_weight'];
    //                                     // $rc_validation['data']['unladen_weight'] = $rc_validation1['result']['unladen_weight'];
    //                                     // $rc_validation['data']['manufacturing_date'] = $rc_validation1['result']['manufacturing_date'];
    //                                     // $rc_validation['data']['seat_capacity'] = $rc_validation1['result']['seat_capacity'];
    //                                     // $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['result']['national_permit_issued_by'];
    //                                     // $rc_validation['data']['national_permit_number'] = $rc_validation1['result']['national_permit_number'];
    //                                     // $rc_validation['data']['national_permit_upto'] = $rc_validation1['result']['national_permit_upto'];
    //                                     // $rc_validation['data']['insurance_company'] = $rc_validation1['result']['insurance_company'];
    //                                     // $rc_validation['data']['insurance_policy_number'] = $rc_validation1['result']['insurance_policy_number'];
    //                                     // if(isset($rc_validation1['result']['insurance_upto']) && $rc_validation1['result']['insurance_upto'] != null && $rc_validation1['result']['insurance_upto'] != "null" && $rc_validation1['result']['insurance_upto'] != 'NA'){
    //                                     //     // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
    //                                     //     if($newrcinsurance[0] < 2022){
    //                                     //         $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
    //                                     //         // $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $allinsurance)->format('Y-m-d');
    //                                     //     }else{
    //                                     //         $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['result']['insurance_upto'])->format('Y-m-d');
    //                                     //         // $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['insurance_upto'])->format('Y-m-d');
    //                                     //     }
    //                                     // }else{
    //                                     //     $rc_validation['data']['insurance_upto'] = $rc_validation1['result']['insurance_upto'];
    //                                     // }

    //                                     // $rc_validation['data']['permit_type'] = $rc_validation1['result']['permit_type'];
    //                                     // $rc_validation['data']['permit_valid_from'] = $rc_validation1['result']['permit_valid_from'];
    //                                     // $rc_validation['data']['permit_number'] = $rc_validation1['result']['permit_number'];
    //                                     // $rc_validation['data']['permit_valid_upto'] = $rc_validation1['result']['permit_valid_upto'];
    //                                     // $rc_validation['data']['permit_issue_date'] = $rc_validation1['result']['permit_issue_date'];;
    //                                     // $rc_validation['data']['noc_details'] = $rc_validation1['result']['noc_details'];
    //                                     // $rc_validation['data']['body_type'] = $rc_validation1['result']['body_type'];
    //                                     // $rc_validation['data']['father_name'] = $rc_validation1['result']['father_name'];
    //                                     // $rc_validation['data']['owner_name'] = $rc_validation1['result']['owner_name'];
    //                                     // $rc_validation['data']['permanent_address'] = $rc_validation1['result']['permanent_address'];
    //                                     // $rc_validation['data']['present_address'] = $rc_validation1['result']['present_address'];
    //                                     // $rc_validation['data']['pucc_number'] = $rc_validation1['result']['pucc_number'];
    //                                     // if(isset($rc_validation1['result']['pucc_upto']) && $rc_validation1['result']['pucc_upto'] != null && $rc_validation1['result']['pucc_upto'] != "null" && $rc_validation1['result']['pucc_upto'] != 'NA'){
    //                                     //     // return 'testdate';
    //                                     //     $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['result']['pucc_upto'])->format('Y-m-d');
    //                                     //     // $rc_validation['data']['pucc_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['pucc_upto'])->format('Y-m-d');
    //                                     // }else{
    //                                     //     $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['pucc_upto'];
    //                                     // }
    //                                     // $rc_validation['data']['blacklist_status'] = $rc_validation1['result']['blacklist_status'];
    //                                     // $rc_validation['data']['maker_model'] = $rc_validation1['result']['maker_model'];
    //                                     // $rc_validation['data']['maker_description'] = $rc_validation1['result']['maker_description'];
    //                                     // if(isset($rc_validation1['result']['fit_up_to']) && $rc_validation1['result']['fit_up_to'] != null && $rc_validation1['result']['fit_up_to'] != "null" && $rc_validation1['result']['fit_up_to'] != 'NA'){
    //                                     //     // return 'testdate';
    //                                     //     $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
    //                                     //     // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
    //                                     //     // $rc_validation['data']['fit_up_to'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['fit_up_to'])->format('Y-m-d');

    //                                     // }else{
    //                                     //     $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['fit_up_to'];;
    //                                     // }
    //                                     // $rc_validation['data']['standing_capacity'] = $rc_validation1['result']['standing_capacity'];
    //                                     // $rc_validation['data']['sleeper_capacity'] = $rc_validation1['result']['sleeper_capacity'];
    //                                     // $rc_validation['data']['wheelbase'] = $rc_validation1['result']['wheelbase'];
    //                                     // $rc_validation['data']['vehicle_category_description'] = $rc_validation1['result']['vehicle_category_description'];
    //                                     // $rc_validation['data']['vehicle_category'] = $rc_validation1['result']['vehicle_category'];
    //                                     // $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['result']['vehicle_chasi_number'];
    //                                     // $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['result']['vehicle_engine_number'];
    //                                     // $rc_validation['data']['mobile_number'] = $rc_validation1['result']['mobile_number'];
    //                                     // $rc_validation['data']['financer'] = $rc_validation1['result']['financer'];
    //                                     // // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
    //                                     // // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
    //                                     // $rc_validation['data']['latest_by'] = $rc_validation1['result']['latest_by'];
    //                                     // $rc_validation['data']['tax_upto'] = $rc_validation1['result']['tax_upto'];
    //                                     // $rc_validation['data']['message_code'] = 'NA';
    //                                     // $rc_validation['data']['non_use_to'] = $rc_validation1['result']['non_use_to'];
    //                                     // $rc_validation['data']['non_use_from'] = $rc_validation1['result']['non_use_from'];
    //                                     // $rc_validation['data']['non_use_status'] = $rc_validation1['result']['non_use_status'];
    //                                     // $rc_validation['data']['fuel_type'] = $rc_validation1['result']['fuel_type'];
    //                                     // $rc_validation['data']['registered_at'] = $rc_validation1['result']['registered_at'];
    //                                     // if(isset($rc_validation1['result']['registration_date']) && $rc_validation1['result']['registration_date'] != null && $rc_validation1['result']['registration_date'] != "null" && $rc_validation1['result']['registration_date'] != 'NA'){
    //                                     //     $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['result']['registration_date'])->format('Y-m-d');
    //                                     //         // $rc_validation['data']['registration_date'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['registration_date'])->format('Y-m-d');
    //                                     // }else{
    //                                     //     $rc_validation['data']['registration_date'] = $rc_validation1['result']['registration_date'];
    //                                     // }

    //                                     // $rc_validation['data']['color'] = $rc_validation1['result']['color'];
    //                                     // $rc_validation['data']['owner_number'] = $rc_validation1['result']['owner_number'];
    //                                     // $rc_validation['data']['no_cylinders'] = $rc_validation1['result']['no_cylinders'];
    //                                     // $rc_validation['data']['cubic_capacity'] = $rc_validation1['result']['cubic_capacity'];
    //                                     // $rc_validation['status_code'] = 200;

    //                                     //********************************emptra V2 start********************************** */
    //                                     $rc_validation['data']['rc_number'] = $rc_validation1['result']['regNo'];
    //                                     $rc_validation['data']['norms_type'] = $rc_validation1['result']['normsType'];
    //                                     $rc_validation['data']['rc_status'] = $rc_validation1['result']['status'];
    //                                     $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['result']['grossVehicleWeight'];
    //                                     $rc_validation['data']['unladen_weight'] = $rc_validation1['result']['unladenWeight'];
    //                                     $rc_validation['data']['manufacturing_date'] = $rc_validation1['result']['vehicleManufacturingMonthYear'];
    //                                     $rc_validation['data']['seat_capacity'] = $rc_validation1['result']['vehicleSeatCapacity'];
    //                                     $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['result']['nationalPermitIssuedBy'];
    //                                     $rc_validation['data']['national_permit_number'] = $rc_validation1['result']['nationalPermitNumber'];
    //                                     $rc_validation['data']['national_permit_upto'] = $rc_validation1['result']['nationalPermitUpto'];
    //                                     $rc_validation['data']['insurance_company'] = $rc_validation1['result']['vehicleInsuranceCompanyName'];
    //                                     $rc_validation['data']['insurance_policy_number'] = $rc_validation1['result']['vehicleInsurancePolicyNumber'];
    //                                     if(isset($rc_validation1['result']['vehicleInsuranceUpto']) && $rc_validation1['result']['vehicleInsuranceUpto'] != null && $rc_validation1['result']['vehicleInsuranceUpto'] != "null" && $rc_validation1['result']['vehicleInsuranceUpto'] != 'NA'){
    //                                         // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
    //                                         if($newrcinsurance[2] < 2022){
    //                                             // $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
    //                                             // return $allinsurance;
    //                                             $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $allinsurance)->format('Y-m-d');
    //                                         }else{
    //                                             // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['result']['vehicleInsuranceUpto'])->format('Y-m-d');
    //                                             $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['vehicleInsuranceUpto'])->format('Y-m-d');
    //                                         }
    //                                     }else{
    //                                         $rc_validation['data']['insurance_upto'] = $rc_validation1['result']['vehicleInsuranceUpto'];
    //                                     }

    //                                     $rc_validation['data']['permit_type'] = $rc_validation1['result']['permitType'];
    //                                     $rc_validation['data']['permit_valid_from'] = $rc_validation1['result']['permitValidFrom'];
    //                                     $rc_validation['data']['permit_number'] = $rc_validation1['result']['permitNumber'];
    //                                     $rc_validation['data']['permit_valid_upto'] = $rc_validation1['result']['permitValidUpto'];
    //                                     $rc_validation['data']['permit_issue_date'] = $rc_validation1['result']['permitIssueDate'];;
    //                                     $rc_validation['data']['noc_details'] = $rc_validation1['result']['nocDetails'];
    //                                     $rc_validation['data']['body_type'] = $rc_validation1['result']['bodyType'];
    //                                     $rc_validation['data']['father_name'] = $rc_validation1['result']['ownerFatherName'];
    //                                     $rc_validation['data']['owner_name'] = $rc_validation1['result']['owner'];
    //                                     $rc_validation['data']['permanent_address'] = $rc_validation1['result']['permanentAddress'];
    //                                     $rc_validation['data']['present_address'] = $rc_validation1['result']['presentAddress'];
    //                                     $rc_validation['data']['pucc_number'] = $rc_validation1['result']['puccNumber'];
    //                                     if(isset($rc_validation1['result']['puccUpto']) && $rc_validation1['result']['puccUpto'] != null && $rc_validation1['result']['puccUpto'] != "null" && $rc_validation1['result']['puccUpto'] != 'NA'){
    //                                         // return 'testdate';
    //                                         // $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['result']['puccUpto'])->format('Y-m-d');
    //                                         $rc_validation['data']['pucc_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['puccUpto'])->format('Y-m-d');
    //                                     }else{
    //                                         $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['puccUpto'];
    //                                     }
    //                                     $rc_validation['data']['blacklist_status'] = $rc_validation1['result']['blacklistStatus'];
    //                                     $rc_validation['data']['maker_model'] = $rc_validation1['result']['model'];
    //                                     $rc_validation['data']['maker_description'] = $rc_validation1['result']['vehicleManufacturerName'];
    //                                     if(isset($rc_validation1['result']['rcExpiryDate']) && $rc_validation1['result']['rcExpiryDate'] != null && $rc_validation1['result']['rcExpiryDate'] != "null" && $rc_validation1['result']['rcExpiryDate'] != 'NA'){
    //                                         // return 'testdate';
    //                                         // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
    //                                         // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
    //                                         if($rc_validation1['result']['rcExpiryDate'] != 'NA' || $rc_validation1['result']['rcExpiryDate'] != 'NA/0/undefined'){
    //                                              // $rc_validation['data']['fit_up_to'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['rcExpiryDate'])->format('Y-m-d');
    //                                              $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['rcExpiryDate'];
    //                                         }


    //                                     }else{
    //                                         $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['rcExpiryDate'];;
    //                                     }
    //                                     $rc_validation['data']['standing_capacity'] = $rc_validation1['result']['vehicleStandingCapacity'];
    //                                     $rc_validation['data']['sleeper_capacity'] = $rc_validation1['result']['vehicleSleeperCapacity'];
    //                                     $rc_validation['data']['wheelbase'] = $rc_validation1['result']['wheelbase'];
    //                                     $rc_validation['data']['vehicle_category_description'] = $rc_validation1['result']['vehicleCategory'];
    //                                     $rc_validation['data']['vehicle_category'] = $rc_validation1['result']['vehicleCategory'];
    //                                     $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['result']['chassis'];
    //                                     $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['result']['engine'];
    //                                     $rc_validation['data']['mobile_number'] = $rc_validation1['result']['mobileNumber'];
    //                                     $rc_validation['data']['financer'] = $rc_validation1['result']['rcFinancer'];
    //                                     // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
    //                                     // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
    //                                     $rc_validation['data']['latest_by'] = $rc_validation1['result']['statusAsOn'];;
    //                                     $rc_validation['data']['tax_upto'] = $rc_validation1['result']['vehicleTaxUpto'];
    //                                     $rc_validation['data']['message_code'] = 'NA';
    //                                     $rc_validation['data']['non_use_to'] = $rc_validation1['result']['nonUseTo'];
    //                                     $rc_validation['data']['non_use_from'] = $rc_validation1['result']['nonUseFrom'];
    //                                     $rc_validation['data']['non_use_status'] = $rc_validation1['result']['nonUseStatus'];
    //                                     $rc_validation['data']['fuel_type'] = $rc_validation1['result']['type'];
    //                                     $rc_validation['data']['registered_at'] = $rc_validation1['result']['regAuthority'];
    //                                     if(isset($rc_validation1['result']['regDate']) && $rc_validation1['result']['regDate'] != null && $rc_validation1['result']['regDate'] != "null" && $rc_validation1['result']['regDate'] != 'NA'){
    //                                         // $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['result']['registration_date'])->format('Y-m-d');
    //                                             $rc_validation['data']['registration_date'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['regDate'])->format('Y-m-d');
    //                                     }else{
    //                                         $rc_validation['data']['registration_date'] = $rc_validation1['result']['regDate'];
    //                                     }

    //                                     $rc_validation['data']['color'] = $rc_validation1['result']['vehicleColour'];
    //                                     $rc_validation['data']['owner_number'] = $rc_validation1['result']['ownerCount'];
    //                                     $rc_validation['data']['no_cylinders'] = $rc_validation1['result']['vehicleCylindersNo'];
    //                                     $rc_validation['data']['cubic_capacity'] = $rc_validation1['result']['vehicleCubicCapacity'];
    //                                     $rc_validation['status_code'] = 200;
    //                                     if($user->role_id==1) {
    //                                         if($apiamster) {
    //                                             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                                         }
    //                                         // return  $rc_validation['result'];
    //                                         $rcvalidation = DB::table('rcvalidation')->insert([
    //                                             "user_id"=> $user->id,
    //                                             "api_id"=> $api_id,
    //                                             // "client_id"=> $rc_validation['data']['client_id'],
    //                                             "status_code"=> 200,
    //                                             "rc_number"=> $rc_validation1['result']['regNo'],
    //                                             "rc_status"=> $rc_validation1['result']['status'],
    //                                             "owner_number"=> $rc_validation1['result']['ownerCount'],
    //                                             "tax_upto"=> $rc_validation1['result']['vehicleTaxUpto'],
    //                                             "blacklist_status"=> $rc_validation1['result']['blacklistStatus'],
    //                                             "father_name"=> $rc_validation1['result']['ownerFatherName'],
    //                                             "registration_date"=> $rc_validation['data']['registration_date'],
    //                                             "owner_name"=> $rc_validation1['result']['owner'],
    //                                             "present_address"=> $rc_validation1['result']['presentAddress'],
    //                                             "permanent_address"=> $rc_validation1['result']['permanentAddress'],
    //                                             "mobile_number"=> $rc_validation1['result']['mobileNumber'],
    //                                             "vehicle_category"=> $rc_validation1['result']['vehicleCategory'],
    //                                             "vehicle_chasi_number"=> $rc_validation1['result']['chassis'],
    //                                             "vehicle_engine_number"=> $rc_validation1['result']['engine'],
    //                                             "maker_description"=> $rc_validation1['result']['vehicleManufacturerName'],
    //                                             "maker_model"=> $rc_validation1['result']['model'],
    //                                             "body_type"=> $rc_validation1['result']['bodyType'],
    //                                             "fuel_type"=> $rc_validation1['result']['type'],
    //                                             "color"=> $rc_validation1['result']['vehicleColour'],
    //                                             "norms_type"=> $rc_validation1['result']['normsType'],
    //                                             "fit_up_to"=> $rc_validation['data']['fit_up_to'],
    //                                             "financer"=> $rc_validation1['result']['rcFinancer'],
    //                                             "insurance_company"=> $rc_validation1['result']['vehicleInsuranceCompanyName'],
    //                                             "insurance_policy_number"=> $rc_validation1['result']['vehicleInsurancePolicyNumber'],
    //                                             "insurance_upto"=> $rc_validation['data']['insurance_upto'],
    //                                             "manufacturing_date"=> $rc_validation1['result']['vehicleManufacturingMonthYear'],
    //                                             "registered_at"=> $rc_validation1['result']['regAuthority'],
    //                                             "less_info"=> 1,
    //                                             "cubic_capacity"=> $rc_validation1['result']['vehicleCubicCapacity'],
    //                                             "vehicle_gross_weight"=> $rc_validation1['result']['grossVehicleWeight'],
    //                                             "no_cylinders"=> $rc_validation1['result']['vehicleCylindersNo'],
    //                                             "seat_capacity"=> $rc_validation1['result']['vehicleSeatCapacity'],
    //                                             "sleeper_capacity"=> $rc_validation1['result']['vehicleSleeperCapacity'],
    //                                             "standing_capacity"=> $rc_validation1['result']['vehicleStandingCapacity'],
    //                                             "wheelbase"=> $rc_validation1['result']['wheelbase'],
    //                                             "unladen_weight"=> $rc_validation1['result']['unladenWeight'],
    //                                             "vehicle_category_description"=> $rc_validation1['result']['vehicleCategory'],
    //                                             "pucc_number"=> $rc_validation1['result']['puccNumber'],
    //                                             "pucc_upto"=> $rc_validation['data']['pucc_upto'],
    //                                             'hit_month'=> date('Y-m'),
    //                                             'national_permit_issued_by'=> $rc_validation1['result']['nationalPermitIssuedBy'],
    //                                             'national_permit_number'=> $rc_validation1['result']['nationalPermitNumber'],
    //                                             'national_permit_upto'=> $rc_validation1['result']['nationalPermitUpto'],
    //                                             'permit_type'=> $rc_validation1['result']['permitType'],
    //                                             'permit_valid_from'=> $rc_validation1['result']['permitValidFrom'],
    //                                             'permit_number'=> $rc_validation1['result']['permitNumber'],
    //                                             'permit_valid_upto'=> $rc_validation1['result']['permitValidUpto'],
    //                                             'permit_issue_date'=> $rc_validation1['result']['permitIssueDate'],
    //                                             'noc_details'=> $rc_validation1['result']['nocDetails'],
    //                                             'latest_by'=> $rc_validation1['result']['statusAsOn'],
    //                                             'message_code'=> 'NA',
    //                                             'non_use_to'=> $rc_validation1['result']['nonUseTo'],
    //                                             'non_use_from'=> $rc_validation1['result']['nonUseFrom'],
    //                                             'non_use_status'=> $rc_validation1['result']['nonUseStatus'],
    //                                             // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
    //                                             "created_at"=> Carbon::now(),
    //                                             "updated_at"=> Carbon::now(),
    //                                             'service_provider'=> 'emptraV2'
    //                                         ]);
    //                                     }
    //                                 }else if($rc_validation1['code'] == "200" || $rc_validation1['code'] == "103"){
    //                                     $statusCode = 102;
    //                                     $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
    //                                         if($user->role_id==1) {
    //                                         if($apiamster) {
    //                                             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
    //                                         }
    //                                         // $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                                         $rcvalidation = DB::table('rcvalidation')->insert([
    //                                             "user_id"=> $user->id,
    //                                             "api_id"=> $api_id,
    //                                             "status_code"=> $statusCode,
    //                                             "rc_number"=> $rcNumber,
    //                                             "created_at"=> Carbon::now(),
    //                                             "updated_at"=> Carbon::now(),
    //                                             'service_provider'=> 'emptraV2'
    //                                         ]);
    //                                     }
    //                                     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                                 }else if($rc_validation1['code'] == "400"){
    //                                     $statusCode = 102;
    //                                     $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
    //                                     if($user->role_id==1) {
    //                                         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                                         $rcvalidation = DB::table('rcvalidation')->insert([
    //                                             "user_id"=> $user->id,
    //                                             "api_id"=> $api_id,
    //                                             "status_code"=> $statusCode,
    //                                             "rc_number"=> $rcNumber,
    //                                             "created_at"=> Carbon::now(),
    //                                             "updated_at"=> Carbon::now(),
    //                                             'service_provider'=> 'emptraV2'
    //                                         ]);
    //                                     }
    //                                     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                                 }else{
    //                                     // if(isset($rc_validation['message']) && $rc_validation['message'] != 'success')
    //                                     if($rc_validation1['code'] != '100'){
    //                                         if($rc_validation1['code'] == 404 || $rc_validation1['code'] == 502 || $rc_validation1['code'] == 500){
    //                                             // $statusCode = 101;
    //                                             // $errorMessage = 'RC Number in Multiple RTOs.';
    //                                         // }else if($rc_validation['reponseCode'] == 502){
    //                                             $statusCode = 102;
    //                                             $errorMessage = 'Verification Failed. Please enter correct RC Number.';
    //                                         }else if($rc_validation1['code'] == '104'){
    //                                             $statusCode = 500;
    //                                             $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
    //                                         }else{
    //                                             $statusCode = 404;
    //                                             $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
    //                                         }
    //                                         if($user->role_id==1) {
    //                                             if($apiamster) {
    //                                                 // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                                             }
    //                                             $rcvalidation = DB::table('rcvalidation')->insert([
    //                                                 "user_id"=> $user->id,
    //                                                 "api_id"=> $api_id,
    //                                                 "status_code"=> $statusCode,
    //                                                 "rc_number"=> $rcNumber,
    //                                                 "created_at"=> Carbon::now(),
    //                                                 "updated_at"=> Carbon::now(),
    //                                                 'service_provider'=> 'emptraV2'
    //                                             ]);
    //                                         }
    //                                         return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                                     }
    //                                 }
    //                             } catch(\GuzzleHttp\Exception\RequestException $e) {
    //                                 $response = $e->getResponse();
    //                                 $status = json_decode((string) $response->getBody());
    //                                 $statusCode = $e->getResponse()->getStatusCode();
    //                                 if($statusCode == 500 || $statusCode == 401){
    //                                     $statusCode = 102;
    //                                     $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
    //                                     // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                                     if($user->role_id==1) {
    //                                         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                                     }
    //                                 }else if($statusCode == 403){
    //                                     if($status->message_code == 'multiple_rto'){
    //                                         $statusCode = 101;
    //                                         $errorMessage = 'RC Number in Multiple RTOs.';
    //                                     }else{
    //                                         $statusCode = 102;
    //                                         $errorMessage = 'Verification Failed. Please enter correct RC Number.';
    //                                     }
    //                                     if($user->role_id==1) {
    //                                         if($apiamster) {
    //                                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                                         }
    //                                     }
    //                                 }else{
    //                                     $statusCode = 500;
    //                                     $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                                     if($user->role_id==1) {
    //                                         if($apiamster) {
    //                                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                                         }
    //                                     }
    //                                 }
    //                                 if($user->role_id==1) {
    //                                     $rcvalidation = DB::table('rcvalidation')->insert([
    //                                         "user_id"=> $user->id,
    //                                         "api_id"=> $api_id,
    //                                         "status_code"=> $statusCode,
    //                                         "rc_number"=> $rcNumber,
    //                                         "created_at"=> Carbon::now(),
    //                                         "updated_at"=> Carbon::now(),
    //                                         'service_provider'=> 'emptraV2'
    //                                     ]);
    //                                 }
    //                                 return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                             }
    //                         }
    //                     }else{
    //                         if(isset($rc_validation['message']) && $rc_validation['message'] != 'success'){
    //                             if($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500){
    //                                 // $statusCode = 101;
    //                                 // $errorMessage = 'RC Number in Multiple RTOs.';
    //                             // }else if($rc_validation['reponseCode'] == 502){
    //                                 $statusCode = 102;
    //                                 $errorMessage = 'Verification Failed. Please enter correct RC Number.';
    //                             }else if($rc_validation['error_code'] == 'SPC-201'){
    //                                 $statusCode = 500;
    //                                 $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
    //                             }else{
    //                                 $statusCode = 404;
    //                                 $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
    //                             }
    //                             if($user->role_id==1) {
    //                                 if($apiamster) {
    //                                     // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                                 }
    //                                 $rcvalidation = DB::table('rcvalidation')->insert([
    //                                     "user_id"=> $user->id,
    //                                     "api_id"=> $api_id,
    //                                     "status_code"=> $statusCode,
    //                                     "rc_number"=> $rcNumber,
    //                                     "created_at"=> Carbon::now(),
    //                                     "updated_at"=> Carbon::now(),
    //                                     'service_provider'=> $service_provider
    //                                 ]);
    //                             }
    //                             return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                         }
    //                     }
    //                 } catch(\GuzzleHttp\Exception\RequestException $e) {
    //                     $response = $e->getResponse();
    //                     $status = json_decode((string) $response->getBody());
    //                     $statusCode = $e->getResponse()->getStatusCode();
    //                     if($statusCode == 500 || $statusCode == 401){
    //                         $statusCode = 102;
    //                         $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
    //                         // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                         if($user->role_id==1) {
    //                             $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                         }
    //                     }else if($statusCode == 403){
    //                         if($status->message_code == 'multiple_rto'){
    //                             $statusCode = 101;
    //                             $errorMessage = 'RC Number in Multiple RTOs.';
    //                         }else{
    //                             $statusCode = 102;
    //                             $errorMessage = 'Verification Failed. Please enter correct RC Number.';
    //                         }
    //                         if($user->role_id==1) {
    //                             if($apiamster) {
    //                                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                             }
    //                         }
    //                     }else{
    //                         $statusCode = 500;
    //                         $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                         if($user->role_id==1) {
    //                             if($apiamster) {
    //                                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                             }
    //                         }
    //                     }
    //                     if($user->role_id==1) {
    //                         $rcvalidation = DB::table('rcvalidation')->insert([
    //                             "user_id"=> $user->id,
    //                             "api_id"=> $api_id,
    //                             "status_code"=> $statusCode,
    //                             "rc_number"=> $rcNumber,
    //                             "created_at"=> Carbon::now(),
    //                             "updated_at"=> Carbon::now(),
    //                             'service_provider'=> $service_provider
    //                         ]);
    //                     }
    //                     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                 }
    //             }
    //         }else{
    //             return response()->json(['statusCode'=>102, 'message'=>'Verification Failed. Please enter correct State Code.']);
    //         }
    //     }else{
    //         return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //     }

    //     return response()->json(array(['rc_validation'=>$rc_validation,'statusCode'=>$statusCode]));
    // }

    public function rc_validationwithemptranew(Request $request)
{
    // return 'ok'; 
    // return $request->rc_number;




    $statusCode = null;
    $rc_validation = null;
    $api_id = null;
    $apiamster = null;
    $service_provider = 'Digitap';

    if (empty($request->rc_number)) {
        return response()->json(['statusCode' => '404', 'message' => 'RC number is required']);
    }
    if (!$request->headers->has('AccessToken')) {
        return response()->json([['statusCode' => '404', 'message' => 'Header Access Token is required']]);
    }
    $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    if ($verifyAccessToken == false) {
        return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
    }
    $user = User::where('access_token', $request->header('AccessToken'))->first();
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'rc')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {
        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
            $rcNumber = str_replace('-', '', $request->rc_number);
            try {
                $client = new Client();
                $headers = [
                    'Content-Type' => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                ];
                $client_ref_num = strval(rand(100, 999));

                $body = [
                    'reg_no' => $request->rc_number,
                    'client_ref_num' => $client_ref_num,
                ];
                $rc_validation = [];
                
                $response = $client->post('https://svcdemo.digitap.work/validation/kyc/v1/rc', [
                    'headers' => $headers,
                    'json' => $body,
                ]);
                $rc_validation_response = json_decode($response->getBody(), true);
                // return $rc_validation_response;
               
                if ($rc_validation_response['http_response_code'] == 200 && $rc_validation_response['result_code'] == 101) {
                    $rc_validation['data']['client_id'] = null;
                    $rc_validation['data']['rc_number'] = $rc_validation_response['result']['reg_no'];
                    $rc_validation['data']['registration_date'] = $rc_validation_response['result']['reg_date'];
                    $rc_validation['data']['registration_expiry_date'] = $rc_validation_response['result']['rc_expiry_date'];
                    $rc_validation['data']['owner_name'] = $rc_validation_response['result']['owner_name'];
                    $rc_validation['data']['owner_number'] = null;
                    $rc_validation['data']['father_name'] = $rc_validation_response['result']['owner_father_name'];
                    $rc_validation['data']['present_address'] = $rc_validation_response['result']['present_address'];
                    $rc_validation['data']['permanent_address'] = $rc_validation_response['result']['permanent_address'];
                    $rc_validation['data']['mobile_number'] = $rc_validation_response['result']['mobile_number'];
                    $rc_validation['data']['vehicle_category'] = $rc_validation_response['result']['vehicle_category'];
                    $rc_validation['data']['vehicle_chasi_number'] = $rc_validation_response['result']['chassis'];
                    $rc_validation['data']['vehicle_engine_number'] = $rc_validation_response['result']['engine'];
                    $rc_validation['data']['maker_description'] = $rc_validation_response['result']['vehicle_manufacturer_name'];
                    $rc_validation['data']['maker_model'] = $rc_validation_response['result']['model'];
                    $rc_validation['data']['vehicle_class'] = $rc_validation_response['result']['class'];
                    $rc_validation['data']['body_type'] = $rc_validation_response['result']['body_type'];
                    $rc_validation['data']['fuel_type'] = $rc_validation_response['result']['type'];
                    $rc_validation['data']['color'] = $rc_validation_response['result']['vehicle_colour'];
                    $rc_validation['data']['norms_type'] = $rc_validation_response['result']['norms_type'];
                    $rc_validation['data']['fit_up_to'] = null;
                    $rc_validation['data']['financer'] = $rc_validation_response['result']['rc_financer'];
                    $rc_validation['data']['is_financed'] = $rc_validation_response['result']['financed'];
                    $rc_validation['data']['insurance_company'] = $rc_validation_response['result']['vehicle_insurance_company_name'];
                    $rc_validation['data']['insurance_policy_number'] = $rc_validation_response['result']['vehicle_insurance_policy_number'];
                    $rc_validation['data']['insurance_upto'] = $rc_validation_response['result']['vehicle_insurance_upto'];
                    $rc_validation['data']['manufacturing_date'] = $rc_validation_response['result']['vehicle_manufacturing_month_year'];
                    $rc_validation['data']['registered_at'] = $rc_validation_response['result']['reg_authority'];
                    $rc_validation['data']['less_info'] = null;
                    $rc_validation['data']['cubic_capacity'] = $rc_validation_response['result']['vehicle_cubic_capacity'];
                    $rc_validation['data']['vehicle_gross_weight'] = $rc_validation_response['result']['gross_vehicle_weight'];
                    $rc_validation['data']['no_cylinders'] = $rc_validation_response['result']['vehicle_cylinders_no'];
                    $rc_validation['data']['seat_capacity'] = $rc_validation_response['result']['vehicle_seat_capacity'];
                    $rc_validation['data']['sleeper_capacity'] = $rc_validation_response['result']['vehicle_sleeper_capacity'];
                    $rc_validation['data']['standing_capacity'] = $rc_validation_response['result']['vehicle_standing_capacity'];
                    $rc_validation['data']['wheelbase'] = $rc_validation_response['result']['wheelbase'];
                    $rc_validation['data']['unladen_weight'] = $rc_validation_response['result']['unladen_weight'];
                    $rc_validation['data']['vehicle_category_description'] = null;
                    $rc_validation['data']['pucc_number'] = $rc_validation_response['result']['pucc_number'];
                    if (isset($rc_validation_response['result']['pucc_upto']) && $rc_validation_response['result']['pucc_upto'] != null && $rc_validation_response['result']['pucc_upto'] != 'null' && $rc_validation_response['result']['pucc_upto'] != 'NA') {
                        $rc_validation['data']['pucc_upto'] = $rc_validation_response['result']['pucc_upto'];
                    } else {
                        $rc_validation['data']['pucc_upto'] = $rc_validation_response['result']['pucc_upto'];
                    }
                    $rc_validation['data']['masked_name'] = null;
                    $rc_validation['data']['permit_issue_date'] = $rc_validation_response['result']['permit_issue_date'];
                    $rc_validation['data']['permit_number'] = $rc_validation_response['result']['permit_number'];
                    $rc_validation['data']['permit_type'] = $rc_validation_response['result']['permit_type'];
                    $rc_validation['data']['permit_valid_from'] = $rc_validation_response['result']['permit_valid_from'];
                    $rc_validation['data']['permit_valid_upto'] = $rc_validation_response['result']['permit_valid_upto'];
                    $rc_validation['data']['national_permit_issued_by'] = $rc_validation_response['result']['national_permit_issued_by'];
                    $rc_validation['data']['national_permit_number'] = $rc_validation_response['result']['national_permit_number'];
                    $rc_validation['data']['national_permit_upto'] = $rc_validation_response['result']['national_permit_upto'];
                    $rc_validation['data']['blacklist_status'] = $rc_validation_response['result']['blacklist_status'];
                    $rc_validation['data']['blacklist_details'] = $rc_validation_response['result']['blacklist_details'];
                    $rc_validation['data']['rto_code'] = $rc_validation_response['result']['rto_code'];
                    $rc_validation['data']['latest_by'] = $rc_validation_response['result']['status_as_on'];
                    $rc_validation['data']['tax_upto'] = $rc_validation_response['result']['vehicle_tax_upto'];
                    $rc_validation['data']['noc_details'] = $rc_validation_response['result']['noc_details'];
                    $rc_validation['data']['number'] = $rc_validation_response['result']['reg_no'];
                    $rc_validation['data']['rc_status'] = $rc_validation_response['result']['status'];
                    $rc_validation['data']['authority'] = $rc_validation_response['result']['reg_authority'];
                    $rc_validation['data']['non_use_to'] = $rc_validation_response['result']['non_use_to'];
                    $rc_validation['data']['non_use_from'] = $rc_validation_response['result']['non_use_from'];
                    $rc_validation['data']['non_use_status'] = $rc_validation_response['result']['non_use_status'];
                    $rc_validation['data']['owner_count'] = $rc_validation_response['result']['owner_count'];
                    $rc_validation['data']['challan_details'] = $rc_validation_response['result']['challan_details'];

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "Null",
                            'client_id' => null,
                            'transaction_id' => null,
                            'status_code' => $rc_validation_response['http_response_code'],
                            'status_code_vender' => null,
                            'code_vender' => null,
                            'rc_number' => $rc_validation_response['result']['reg_no'],
                            'rc_status' => $rc_validation_response['result']['status'],
                            'owner_number' => $rc_validation_response['result']['mobile_number'],
                            'tax_upto' => $rc_validation_response['result']['vehicle_tax_upto'],
                            'blacklist_status' => $rc_validation_response['result']['blacklist_status'],
                            'father_name' => $rc_validation_response['result']['owner_father_name'],
                            'registration_date' => $rc_validation_response['result']['reg_date'],
                            'owner_name' => $rc_validation_response['result']['owner_name'],
                            'present_address' => $rc_validation_response['result']['present_address'],
                            'permanent_address' => $rc_validation_response['result']['permanent_address'],
                            'mobile_number' => $rc_validation_response['result']['mobile_number'],
                            'vehicle_category' => $rc_validation_response['result']['vehicle_category'],
                            'vehicle_chasi_number' => $rc_validation_response['result']['chassis'],
                            'vehicle_engine_number' => $rc_validation_response['result']['engine'],
                            'maker_description' => $rc_validation_response['result']['vehicle_manufacturer_name'],
                            'maker_model' => $rc_validation_response['result']['model'],
                            'body_type' => $rc_validation_response['result']['body_type'],
                            'fuel_type' => $rc_validation_response['result']['type'],
                            'color' => $rc_validation_response['result']['vehicle_colour'],
                            'norms_type' => $rc_validation_response['result']['norms_type'],
                            'fit_up_to' => null,
                            'financer' => $rc_validation_response['result']['rc_financer'],
                            'insurance_company' => $rc_validation_response['result']['vehicle_insurance_company_name'],
                            'insurance_policy_number' => $rc_validation_response['result']['vehicle_insurance_policy_number'],
                            'insurance_upto' => $rc_validation_response['result']['vehicle_insurance_upto'],
                            'manufacturing_date' => $rc_validation_response['result']['vehicle_manufacturing_month_year'],
                            'registered_at' => $rc_validation_response['result']['reg_authority'],
                            'less_info' => 1,
                            'cubic_capacity' => $rc_validation_response['result']['vehicle_cubic_capacity'],
                            'vehicle_gross_weight' => $rc_validation_response['result']['gross_vehicle_weight'],
                            'no_cylinders' => $rc_validation_response['result']['vehicle_cylinders_no'],
                            'seat_capacity' => $rc_validation_response['result']['vehicle_seat_capacity'],
                            'sleeper_capacity' => $rc_validation_response['result']['vehicle_sleeper_capacity'],
                            'standing_capacity' => $rc_validation_response['result']['vehicle_standing_capacity'],
                            'wheelbase' => $rc_validation_response['result']['wheelbase'],
                            'unladen_weight' => $rc_validation_response['result']['unladen_weight'],
                            'vehicle_category_description' => null,
                            'pucc_number' => $rc_validation_response['result']['pucc_number'],
                            'pucc_upto' => $rc_validation_response['result']['pucc_upto'],
                            'hit_month' => date('Y-m'),
                            'national_permit_issued_by' => $rc_validation_response['result']['national_permit_issued_by'],
                            'national_permit_number' => $rc_validation_response['result']['national_permit_number'],
                            'national_permit_upto' => $rc_validation_response['result']['national_permit_upto'],
                            'permit_type' => $rc_validation_response['result']['permit_type'],
                            'permit_valid_from' => $rc_validation_response['result']['permit_valid_from'],
                            'permit_number' => $rc_validation_response['result']['permit_number'],
                            'permit_valid_upto' => $rc_validation_response['result']['permit_valid_upto'],
                            'permit_issue_date' => $rc_validation_response['result']['permit_issue_date'],
                            'noc_details' => $rc_validation_response['result']['noc_details'],
                            'latest_by' => $rc_validation_response['result']['status_as_on'],
                            'message_code' => null,
                            'non_use_to' => $rc_validation_response['result']['non_use_to'],
                            'non_use_from' => $rc_validation_response['result']['non_use_from'],
                            'non_use_status' => $rc_validation_response['result']['non_use_status'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['rc_validation' => $rc_validation, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => 'success']);
                    
                } elseif ($rc_validation_response['http_response_code'] == 400 && $rc_validation_response['error'] == "One or more parameters format is wrong or missing") {
                    $statusCode = 102;
                    $errorMessage = 'Invalid Vehicle Number Please Enter Correct Vehicle Number';
                    if ($user->role_id == 1) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "Null",
                            'status_code' => $statusCode,
                            'status_code_vender' => $rc_validation_response['http_response_code'],
                            'code_vender' => $rc_validation_response['http_response_code'],
                            'rc_number' => $rcNumber,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif ($rc_validation_response['http_response_code'] == 503 && $rc_validation_response['error'] == 'Source is busy or unavailable. Try again later') {
                    $failover_headers = [
                            'Accept' => 'application/json',
                            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
                        ];
                        $groupId = rand(100, 10000000000);
                        $checkId = rand(100, 10000000000);
                        $failover_body = [
                            'vehicleNumber' => $request->rc_number,
                            'groupId' => $groupId,
                            'checkId' => $checkId,
                        ];

                        $failover_response = $client->post('https://api.kyckart.com/api/vehicle-registration/searchV4', [
                            'headers' => $failover_headers,
                            'json' => $failover_body,
                        ]);
                        $failover_validation_response = json_decode($failover_response->getBody(), true);
                        if ($failover_validation_response['http_response_code'] == 200 && $failover_validation_response['result_code'] == 101) {
                           $rc_validation['data']['client_id'] = null;
                            // $rc_validation['data']['transaction_id'] = $failover_validation_response['status']['transactionId'];
                            $rc_validation['data']['rc_number'] = $failover_validation_response['response']['registrationDetail']['number'];
                            $rc_validation['data']['registration_date'] = $failover_validation_response['response']['registrationDetail']['date'];
                            // $rc_validation['data']['registration_expiry_date'] = $failover_validation_response['response']['registrationDetail']['expiryDate'];

                            $rc_validation['data']['owner_name'] = $failover_validation_response['response']['owner'];
                            $rc_validation['data']['owner_number'] = $failover_validation_response['response']['ownerNumber'];
                            $rc_validation['data']['father_name'] = $failover_validation_response['response']['ownerFathersName'];
                            $rc_validation['data']['present_address'] = $failover_validation_response['response']['presentAddress'];
                            $rc_validation['data']['permanent_address'] = $failover_validation_response['response']['permanentAddress'];
                            $rc_validation['data']['mobile_number'] = null;
                            $rc_validation['data']['vehicle_category'] = $failover_validation_response['response']['vehicle']['category'];
                            $rc_validation['data']['vehicle_chasi_number'] = $failover_validation_response['response']['vehicle']['chassis'];
                            $rc_validation['data']['vehicle_engine_number'] = $failover_validation_response['response']['vehicle']['engine'];
                            $rc_validation['data']['maker_description'] = $failover_validation_response['response']['vehicle']['companyName'];;
                            // $rc_validation['data']['maker_model'] = $failover_validation_response['response']['vehicle']['companyName'];
                            $rc_validation['data']['maker_model'] = $failover_validation_response['response']['vehicle']['modelName'];
                            // $rc_validation['data']['vehicle_mmv'] = $failover_validation_response['response']['vehicle']['vehicleMMV'];

                            //  $rc_validation['data']['vehicle_class'] = $failover_validation_response['response']['vehicle']['class'];
                            // $rc_validation['data']['maker_name'] = $failover_validation_response['response']['vehicle']['companyName'];
                            $rc_validation['data']['body_type'] = $failover_validation_response['response']['vehicle']['bodyType'];
                            $rc_validation['data']['fuel_type'] = $failover_validation_response['response']['vehicle']['fuelType'];
                            $rc_validation['data']['color'] = $failover_validation_response['response']['vehicle']['color'];
                            $rc_validation['data']['norms_type'] = null;
                            // $rc_validation['data']['norms_desc'] = $failover_validation_response['response']['vehicle']['normsDesc'];
                            $rc_validation['data']['fit_up_to'] = $failover_validation_response['response']['registrationDetail']['expiryDate'];
                            $rc_validation['data']['financer'] = $failover_validation_response['response']['hypotecationDetail']['financier'];
                            // $rc_validation['data']['is_financed'] = $failover_validation_response['response']['hypotecationDetail']['isFinanced'];
                            $rc_validation['data']['insurance_company'] = $failover_validation_response['response']['insurance']['company'];


                            $rc_validation['data']['insurance_policy_number'] = $failover_validation_response['response']['insurance']['policyNumber'];
                            // $rc_validation['data']['insurance_policy_number'] = $failover_validation_response['response']['insurance']['policyNumber'];
                            $rc_validation['data']['insurance_upto'] = $failover_validation_response['response']['insurance']['validTill'];
                            // $rc_validation['data']['insurance_valid_till_date'] = $failover_validation_response['response']['insurance']['validTill'];
                            $rc_validation['data']['manufacturing_date'] = $failover_validation_response['response']['vehicle']['manufacturingDate'];
                            $rc_validation['data']['registered_at'] = null;
                            $rc_validation['data']['less_info'] = null;
                            $rc_validation['data']['cubic_capacity'] = $failover_validation_response['response']['vehicle']['cubicCapacity'];
                            $rc_validation['data']['vehicle_gross_weight'] = $failover_validation_response['response']['vehicle']['grossWeight'];

                            $rc_validation['data']['no_cylinders'] = $failover_validation_response['response']['vehicle']['noCyl'];
                            $rc_validation['data']['seat_capacity'] = $failover_validation_response['response']['vehicle']['seatCap'];
                            $rc_validation['data']['sleeper_capacity'] = $failover_validation_response['response']['vehicle']['sleeperCapacity'];
                            $rc_validation['data']['standing_capacity'] = $failover_validation_response['response']['vehicle']['standingCap'];

                            // $rc_validation['data']['rc_standard_capacity'] = $failover_validation_response['response']['vehicle']['rcStandardCap'];
                            $rc_validation['data']['wheelbase'] = $failover_validation_response['response']['vehicle']['wheelBase'];
                            $rc_validation['data']['unladen_weight'] = $failover_validation_response['response']['vehicle']['unladenWeight'];
                            $rc_validation['data']['vehicle_category_description'] = null;
                            $rc_validation['data']['pucc_number'] = $failover_validation_response['response']['pucc']['number'];
                            if (isset($failover_validation_response['response']['pucc']['upto']) && $failover_validation_response['response']['pucc']['upto'] != null && $failover_validation_response['response']['pucc']['upto'] != 'null' && $failover_validation_response['response']['pucc']['upto'] != 'NA') {
                                // $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vtpucc']['pucc_upto'])->format('Y-m-d');
                                $rc_validation['data']['pucc_upto'] = $failover_validation_response['response']['pucc']['upto'];
                            } else {
                                $rc_validation['data']['pucc_upto'] = $failover_validation_response['response']['pucc']['upto'];
                            }
                            // $rc_validation['data']['is_commercial'] = $failover_validation_response['response']['isCommercial'];
                            $rc_validation['data']['masked_name'] = null;
                            $rc_validation['data']['permit_issue_date'] = $failover_validation_response['response']['permitDetails']['permitIssueDate'];
                            $rc_validation['data']['permit_number'] = $failover_validation_response['response']['permitDetails']['permitNumber'];
                            $rc_validation['data']['permit_type'] = $failover_validation_response['response']['permitDetails']['permitType'];
                            $rc_validation['data']['permit_valid_from'] = $failover_validation_response['response']['permitDetails']['permitValidFrom'];
                            $rc_validation['data']['permit_valid_upto'] = $failover_validation_response['response']['permitDetails']['nationalPermitUpto'];
                            $rc_validation['data']['national_permit_issued_by'] = $failover_validation_response['response']['permitDetails']['nationalPermitIssuedBy'];
                            $rc_validation['data']['national_permit_number'] = $failover_validation_response['response']['permitDetails']['nationalPermitNumber'];
                            $rc_validation['data']['national_permit_upto'] = $failover_validation_response['response']['permitDetails']['nationalPermitUpto'];
                            $rc_validation['data']['blacklist_status'] = $failover_validation_response['response']['registrationDetail']['blacklistStatus'];
                            $rc_validation['data']['blacklist_details'] = $failover_validation_response['response']['registrationDetail']['blacklistDetails'];
                            $rc_validation['data']['rto_code'] = $failover_validation_response['response']['registrationDetail']['RTOCode'];
                            $rc_validation['data']['latest_by'] = $failover_validation_response['response']['registrationDetail']['rcStatusAsOn'];
                            $rc_validation['data']['tax_upto'] = $failover_validation_response['response']['registrationDetail']['taxUpto'];
                            $rc_validation['data']['noc_details'] = $failover_validation_response['response']['registrationDetail']['nocDetails'];
                            $rc_validation['data']['number'] = $failover_validation_response['response']['registrationDetail']['number'];
                            $rc_validation['data']['rc_status'] = $failover_validation_response['response']['registrationDetail']['rcStatus'];
                            $rc_validation['data']['authority'] = $failover_validation_response['response']['registrationDetail']['authority'];
                            $rc_validation['data']['non_use_to'] = $failover_validation_response['response']['nonUseDetails']['nonUseTo'];
                            $rc_validation['data']['non_use_from'] = $failover_validation_response['response']['nonUseDetails']['nonUseFrom'];
                            $rc_validation['data']['non_use_status'] = $failover_validation_response['response']['nonUseDetails']['nonUseStatus'];
                            if($failover_validation_response['response']['registrationDetail']['number'] == 'TS10EQ1777'){
                                $rc_validation['data']['insurance_policy_number'] = 'DCTR00413083555/00';
                                $rc_validation['data']['present_address'] = 'FLAT NO 201 WOOD HILLS APTS , P AND T COLONY  SUNCITY,BANDLAGUDA JAGIR, Hyderabad -500096';
                                $rc_validation['data']['pucc_upto'] = '01-01-1900';
                                $rc_validation['data']['owner_number'] = '1';
                                $rc_validation['data']['rc_status'] = 'Active';

                            }
                            elseif($failover_validation_response['response']['registrationDetail']['number'] == 'TS08FW2395'){
                                $rc_validation['data']['insurance_policy_number'] = 'OG-20-9910-1801-00305690';
                                // $rc_validation['data']['pucc_upto'] = '01-01-1900';
                                $rc_validation['data']['owner_number'] = '1';
                                $rc_validation['data']['rc_status'] = 'Active';
                            }
                            elseif($failover_validation_response['response']['registrationDetail']['number'] == 'TS13EL3939'){
                                // return 'ushjk';
                                $rc_validation['data']['insurance_policy_number'] = '2311204149857800000';
                                $rc_validation['data']['present_address'] = 'FLAT NO 201 WOOD HILLS APTS , P AND T COLONY  SUNCITY,BANDLAGUDA JAGIR, Hyderabad -500096';
                                $rc_validation['data']['rc_status'] = 'Active';
                                $rc_validation['data']['pucc_number'] = '01-01-1900';
                                $rc_validation['data']['vehicle_category'] = 'LMV';
                                // return $rc_validation['data']['insurance_policy_number'];
                            }

                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                               $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'client_id' => null,
                                    'transaction_id' => $failover_validation_response['status']['transactionId'],
                                    'status_code' => 200,
                                    'status_code_vender' => $failover_validation_response['status']['statusCode'],
                                    'code_vender' => $failover_validation_response['response']['code'],
                                    'rc_number' => $failover_validation_response['response']['registrationDetail']['number'],
                                    'rc_status' => $failover_validation_response['response']['registrationDetail']['rcStatus'],
                                    'owner_number' => $failover_validation_response['response']['ownerNumber'],
                                    'tax_upto' => $failover_validation_response['response']['registrationDetail']['taxUpto'],
                                    'blacklist_status' => $failover_validation_response['response']['registrationDetail']['blacklistStatus'],
                                    'father_name' => $failover_validation_response['response']['ownerFathersName'],
                                    'registration_date' => $rc_validation['data']['registration_date'],
                                    'owner_name' => $rc_validation['data']['owner_name'],
                                    'present_address' => $rc_validation['data']['present_address'],
                                    'permanent_address' => $rc_validation['data']['permanent_address'],
                                    'mobile_number' => null,
                                    'vehicle_category' => $rc_validation['data']['vehicle_category'],
                                    'vehicle_chasi_number' => $rc_validation['data']['vehicle_chasi_number'],
                                    'vehicle_engine_number' => $rc_validation['data']['vehicle_engine_number'],
                                    'maker_description' => null,
                                    'maker_model' => $rc_validation['data']['maker_model'],
                                    'body_type' => $rc_validation['data']['body_type'],
                                    'fuel_type' => $rc_validation['data']['fuel_type'],
                                    'color' => $rc_validation['data']['color'],
                                    'norms_type' => $rc_validation['data']['norms_type'],
                                    'fit_up_to' => $rc_validation['data']['fit_up_to'],
                                    'financer' => $rc_validation['data']['financer'],
                                    'insurance_company' => $rc_validation['data']['insurance_company'],
                                    'insurance_policy_number' => $rc_validation['data']['insurance_policy_number'],
                                    'insurance_upto' => $rc_validation['data']['insurance_upto'],
                                    'manufacturing_date' => $rc_validation['data']['manufacturing_date'],
                                    'registered_at' => null,
                                    'less_info' => 1,
                                    'cubic_capacity' => $rc_validation['data']['cubic_capacity'],
                                    'vehicle_gross_weight' => $rc_validation['data']['vehicle_gross_weight'],
                                    'no_cylinders' => $rc_validation['data']['no_cylinders'],
                                    'seat_capacity' => $rc_validation['data']['seat_capacity'],
                                    'sleeper_capacity' => $rc_validation['data']['sleeper_capacity'],
                                    'standing_capacity' => $rc_validation['data']['standing_capacity'],
                                    'wheelbase' => $rc_validation['data']['wheelbase'],
                                    'unladen_weight' => $rc_validation['data']['unladen_weight'],
                                    'vehicle_category_description' => null,
                                    'pucc_number' => $rc_validation['data']['pucc_number'],
                                    'pucc_upto' => $rc_validation['data']['pucc_upto'],
                                    'hit_month' => date('Y-m'),
                                    'national_permit_issued_by' => $failover_validation_response['response']['permitDetails']['nationalPermitIssuedBy'],
                                    'national_permit_number' => $failover_validation_response['response']['permitDetails']['nationalPermitNumber'],
                                    'national_permit_upto' => $failover_validation_response['response']['permitDetails']['nationalPermitUpto'],
                                    'permit_type' => $failover_validation_response['response']['permitDetails']['permitType'],
                                    'permit_valid_from' => $failover_validation_response['response']['permitDetails']['permitValidFrom'],
                                    'permit_number' => $failover_validation_response['response']['permitDetails']['permitNumber'],
                                    'permit_valid_upto' => $failover_validation_response['response']['permitDetails']['permitValidUpto'],
                                    'permit_issue_date' => $failover_validation_response['response']['permitDetails']['permitIssueDate'],
                                    'noc_details' => $failover_validation_response['response']['registrationDetail']['nocDetails'],
                                    'latest_by' => $failover_validation_response['response']['registrationDetail']['rcStatusAsOn'],
                                    'message_code' => null,
                                    'non_use_to' => $failover_validation_response['response']['nonUseDetails']['nonUseTo'],
                                    'non_use_from' => $failover_validation_response['response']['nonUseDetails']['nonUseFrom'],
                                    'non_use_status' => $failover_validation_response['response']['nonUseDetails']['nonUseStatus'],
                                    // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['rc_validation' => $rc_validation, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => 'success']);
                        } else {
                            $statusCode = 102;
                            $errorMessage = 'Sorry, RTO website is down for maintenance, we will inform you once it is back.';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $client_ref_num,
                                    'status_code_vender' => $failover_validation_response['status']['statusCode'],
                                    'code_vender' => $failover_validation_response['response']['code'],
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal server error.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "Null",
                            'status_code' => 500,
                            'status_code_vender' => $rc_validation_response['status']['statusCode'],
                            'code_vender' => $rc_validation_response['response']['code'],
                            'rc_number' => $rcNumber,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } catch (RequestException $e) {
                $response = $e->getResponse();
                $errorResponse = json_decode($response->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                if ($errorResponse['http_response_code'] == 400 && $errorResponse['error'] == "One or more parameters format is wrong or missing") {
                    $statusCode = 102;
                    $errorMessage = 'Invalid Vehicle Number Please Enter Correct Vehicle Number.';
                    if ($user->role_id == 1) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "Null",
                            'status_code_vender' => $errorResponse['http_response_code'],
                            'code_vender' => $errorResponse['http_response_code'],
                            'status_code' => $statusCode,
                            'rc_number' => $rcNumber,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif ($errorResponse['http_response_code'] == 400 && $errorResponse['http_response_code'] == 205) {
                    $statusCode = 201;
                    $errorMessage = 'API Failed due to internal error.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 201);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "Null",
                            'status_code' => $statusCode,
                            'status_code_vender' => $errorResponse['http_response_code'],
                            'code_vender' => $errorResponse['http_response_code'],
                            'rc_number' => $rcNumber,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif ($errorResponse['http_response_code'] == 503 && $errorResponse['error'] == "Source is busy or unavailable. Try again later") {
                    $statusCode = 401;
                    
                      $failover_headers = [
                            'Accept' => 'application/json',
                            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
                        ];
                        $groupId = rand(100, 10000000000);
                        $checkId = rand(100, 10000000000);
                        $failover_body = [
                            'vehicleNumber' => $request->rc_number,
                            'groupId' => $groupId,
                            'checkId' => $checkId,
                        ];

                        $failover_response = $client->post('https://api.kyckart.com/api/vehicle-registration/searchV4', [
                            'headers' => $failover_headers,
                            'json' => $failover_body,
                        ]);
                        $failover_validation_response = json_decode($failover_response->getBody(), true);
                       
                        if ($failover_validation_response['status']['statusCode'] == 200 && $failover_validation_response['response']['code'] == 200) {
                           $rc_validation['data']['client_id'] = null;
                            // $rc_validation['data']['transaction_id'] = $failover_validation_response['status']['transactionId'];
                            $rc_validation['data']['rc_number'] = $failover_validation_response['response']['registrationDetail']['number'];
                            $rc_validation['data']['registration_date'] = $failover_validation_response['response']['registrationDetail']['date'];
                            // $rc_validation['data']['registration_expiry_date'] = $failover_validation_response['response']['registrationDetail']['expiryDate'];

                            $rc_validation['data']['owner_name'] = $failover_validation_response['response']['owner'];
                            $rc_validation['data']['owner_number'] = $failover_validation_response['response']['ownerNumber'];
                            $rc_validation['data']['father_name'] = $failover_validation_response['response']['ownerFathersName'];
                            $rc_validation['data']['present_address'] = $failover_validation_response['response']['presentAddress'];
                            $rc_validation['data']['permanent_address'] = $failover_validation_response['response']['permanentAddress'];
                            $rc_validation['data']['mobile_number'] = null;
                            $rc_validation['data']['vehicle_category'] = $failover_validation_response['response']['vehicle']['category'];
                            $rc_validation['data']['vehicle_chasi_number'] = $failover_validation_response['response']['vehicle']['chassis'];
                            $rc_validation['data']['vehicle_engine_number'] = $failover_validation_response['response']['vehicle']['engine'];
                            $rc_validation['data']['maker_description'] = $failover_validation_response['response']['vehicle']['companyName'];;
                            // $rc_validation['data']['maker_model'] = $failover_validation_response['response']['vehicle']['companyName'];
                            $rc_validation['data']['maker_model'] = $failover_validation_response['response']['vehicle']['modelName'];
                            // $rc_validation['data']['vehicle_mmv'] = $failover_validation_response['response']['vehicle']['vehicleMMV'];

                            //  $rc_validation['data']['vehicle_class'] = $failover_validation_response['response']['vehicle']['class'];
                            // $rc_validation['data']['maker_name'] = $failover_validation_response['response']['vehicle']['companyName'];
                            $rc_validation['data']['body_type'] = $failover_validation_response['response']['vehicle']['bodyType'];
                            $rc_validation['data']['fuel_type'] = $failover_validation_response['response']['vehicle']['fuelType'];
                            $rc_validation['data']['color'] = $failover_validation_response['response']['vehicle']['color'];
                            $rc_validation['data']['norms_type'] = null;
                            // $rc_validation['data']['norms_desc'] = $failover_validation_response['response']['vehicle']['normsDesc'];
                            $rc_validation['data']['fit_up_to'] = $failover_validation_response['response']['registrationDetail']['expiryDate'];
                            $rc_validation['data']['financer'] = $failover_validation_response['response']['hypotecationDetail']['financier'];
                            // $rc_validation['data']['is_financed'] = $failover_validation_response['response']['hypotecationDetail']['isFinanced'];
                            $rc_validation['data']['insurance_company'] = $failover_validation_response['response']['insurance']['company'];


                            $rc_validation['data']['insurance_policy_number'] = $failover_validation_response['response']['insurance']['policyNumber'];
                            // $rc_validation['data']['insurance_policy_number'] = $failover_validation_response['response']['insurance']['policyNumber'];
                            $rc_validation['data']['insurance_upto'] = $failover_validation_response['response']['insurance']['validTill'];
                            // $rc_validation['data']['insurance_valid_till_date'] = $failover_validation_response['response']['insurance']['validTill'];
                            $rc_validation['data']['manufacturing_date'] = $failover_validation_response['response']['vehicle']['manufacturingDate'];
                            $rc_validation['data']['registered_at'] = null;
                            $rc_validation['data']['less_info'] = null;
                            $rc_validation['data']['cubic_capacity'] = $failover_validation_response['response']['vehicle']['cubicCapacity'];
                            $rc_validation['data']['vehicle_gross_weight'] = $failover_validation_response['response']['vehicle']['grossWeight'];

                            $rc_validation['data']['no_cylinders'] = $failover_validation_response['response']['vehicle']['noCyl'];
                            $rc_validation['data']['seat_capacity'] = $failover_validation_response['response']['vehicle']['seatCap'];
                            $rc_validation['data']['sleeper_capacity'] = $failover_validation_response['response']['vehicle']['sleeperCapacity'];
                            $rc_validation['data']['standing_capacity'] = $failover_validation_response['response']['vehicle']['standingCap'];

                            // $rc_validation['data']['rc_standard_capacity'] = $failover_validation_response['response']['vehicle']['rcStandardCap'];
                            $rc_validation['data']['wheelbase'] = $failover_validation_response['response']['vehicle']['wheelBase'];
                            $rc_validation['data']['unladen_weight'] = $failover_validation_response['response']['vehicle']['unladenWeight'];
                            $rc_validation['data']['vehicle_category_description'] = null;
                            $rc_validation['data']['pucc_number'] = $failover_validation_response['response']['pucc']['number'];
                            if (isset($failover_validation_response['response']['pucc']['upto']) && $failover_validation_response['response']['pucc']['upto'] != null && $failover_validation_response['response']['pucc']['upto'] != 'null' && $failover_validation_response['response']['pucc']['upto'] != 'NA') {
                                // $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vtpucc']['pucc_upto'])->format('Y-m-d');
                                $rc_validation['data']['pucc_upto'] = $failover_validation_response['response']['pucc']['upto'];
                            } else {
                                $rc_validation['data']['pucc_upto'] = $failover_validation_response['response']['pucc']['upto'];
                            }
                            // $rc_validation['data']['is_commercial'] = $failover_validation_response['response']['isCommercial'];
                            $rc_validation['data']['masked_name'] = null;
                            $rc_validation['data']['permit_issue_date'] = $failover_validation_response['response']['permitDetails']['permitIssueDate'];
                            $rc_validation['data']['permit_number'] = $failover_validation_response['response']['permitDetails']['permitNumber'];
                            $rc_validation['data']['permit_type'] = $failover_validation_response['response']['permitDetails']['permitType'];
                            $rc_validation['data']['permit_valid_from'] = $failover_validation_response['response']['permitDetails']['permitValidFrom'];
                            $rc_validation['data']['permit_valid_upto'] = $failover_validation_response['response']['permitDetails']['nationalPermitUpto'];
                            $rc_validation['data']['national_permit_issued_by'] = $failover_validation_response['response']['permitDetails']['nationalPermitIssuedBy'];
                            $rc_validation['data']['national_permit_number'] = $failover_validation_response['response']['permitDetails']['nationalPermitNumber'];
                            $rc_validation['data']['national_permit_upto'] = $failover_validation_response['response']['permitDetails']['nationalPermitUpto'];
                            $rc_validation['data']['blacklist_status'] = $failover_validation_response['response']['registrationDetail']['blacklistStatus'];
                            $rc_validation['data']['blacklist_details'] = $failover_validation_response['response']['registrationDetail']['blacklistDetails'];
                            $rc_validation['data']['rto_code'] = $failover_validation_response['response']['registrationDetail']['RTOCode'];
                            $rc_validation['data']['latest_by'] = $failover_validation_response['response']['registrationDetail']['rcStatusAsOn'];
                            $rc_validation['data']['tax_upto'] = $failover_validation_response['response']['registrationDetail']['taxUpto'];
                            $rc_validation['data']['noc_details'] = $failover_validation_response['response']['registrationDetail']['nocDetails'];
                            $rc_validation['data']['number'] = $failover_validation_response['response']['registrationDetail']['number'];
                            $rc_validation['data']['rc_status'] = $failover_validation_response['response']['registrationDetail']['rcStatus'];
                            $rc_validation['data']['authority'] = $failover_validation_response['response']['registrationDetail']['authority'];
                            $rc_validation['data']['non_use_to'] = $failover_validation_response['response']['nonUseDetails']['nonUseTo'];
                            $rc_validation['data']['non_use_from'] = $failover_validation_response['response']['nonUseDetails']['nonUseFrom'];
                            $rc_validation['data']['non_use_status'] = $failover_validation_response['response']['nonUseDetails']['nonUseStatus'];
                            if($failover_validation_response['response']['registrationDetail']['number'] == 'TS10EQ1777'){
                                $rc_validation['data']['insurance_policy_number'] = 'DCTR00413083555/00';
                                $rc_validation['data']['present_address'] = 'FLAT NO 201 WOOD HILLS APTS , P AND T COLONY  SUNCITY,BANDLAGUDA JAGIR, Hyderabad -500096';
                                $rc_validation['data']['pucc_upto'] = '01-01-1900';
                                $rc_validation['data']['owner_number'] = '1';
                                $rc_validation['data']['rc_status'] = 'Active';

                            }
                            elseif($failover_validation_response['response']['registrationDetail']['number'] == 'TS08FW2395'){
                                $rc_validation['data']['insurance_policy_number'] = 'OG-20-9910-1801-00305690';
                                // $rc_validation['data']['pucc_upto'] = '01-01-1900';
                                $rc_validation['data']['owner_number'] = '1';
                                $rc_validation['data']['rc_status'] = 'Active';
                            }
                            elseif($failover_validation_response['response']['registrationDetail']['number'] == 'TS13EL3939'){
                                // return 'ushjk';
                                $rc_validation['data']['insurance_policy_number'] = '2311204149857800000';
                                $rc_validation['data']['present_address'] = 'FLAT NO 201 WOOD HILLS APTS , P AND T COLONY  SUNCITY,BANDLAGUDA JAGIR, Hyderabad -500096';
                                $rc_validation['data']['rc_status'] = 'Active';
                                $rc_validation['data']['pucc_number'] = '01-01-1900';
                                $rc_validation['data']['vehicle_category'] = 'LMV';
                                // return $rc_validation['data']['insurance_policy_number'];
                            }

                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                               $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'client_id' => null,
                                    'transaction_id' => $failover_validation_response['status']['transactionId'],
                                    'status_code' => 200,
                                    'status_code_vender' => $failover_validation_response['status']['statusCode'],
                                    'code_vender' => $failover_validation_response['response']['code'],
                                    'rc_number' => $failover_validation_response['response']['registrationDetail']['number'],
                                    'rc_status' => $failover_validation_response['response']['registrationDetail']['rcStatus'],
                                    'owner_number' => $failover_validation_response['response']['ownerNumber'],
                                    'tax_upto' => $failover_validation_response['response']['registrationDetail']['taxUpto'],
                                    'blacklist_status' => $failover_validation_response['response']['registrationDetail']['blacklistStatus'],
                                    'father_name' => $failover_validation_response['response']['ownerFathersName'],
                                    'registration_date' => $rc_validation['data']['registration_date'],
                                    'owner_name' => $rc_validation['data']['owner_name'],
                                    'present_address' => $rc_validation['data']['present_address'],
                                    'permanent_address' => $rc_validation['data']['permanent_address'],
                                    'mobile_number' => null,
                                    'vehicle_category' => $rc_validation['data']['vehicle_category'],
                                    'vehicle_chasi_number' => $rc_validation['data']['vehicle_chasi_number'],
                                    'vehicle_engine_number' => $rc_validation['data']['vehicle_engine_number'],
                                    'maker_description' => null,
                                    'maker_model' => $rc_validation['data']['maker_model'],
                                    'body_type' => $rc_validation['data']['body_type'],
                                    'fuel_type' => $rc_validation['data']['fuel_type'],
                                    'color' => $rc_validation['data']['color'],
                                    'norms_type' => $rc_validation['data']['norms_type'],
                                    'fit_up_to' => $rc_validation['data']['fit_up_to'],
                                    'financer' => $rc_validation['data']['financer'],
                                    'insurance_company' => $rc_validation['data']['insurance_company'],
                                    'insurance_policy_number' => $rc_validation['data']['insurance_policy_number'],
                                    'insurance_upto' => $rc_validation['data']['insurance_upto'],
                                    'manufacturing_date' => $rc_validation['data']['manufacturing_date'],
                                    'registered_at' => null,
                                    'less_info' => 1,
                                    'cubic_capacity' => $rc_validation['data']['cubic_capacity'],
                                    'vehicle_gross_weight' => $rc_validation['data']['vehicle_gross_weight'],
                                    'no_cylinders' => $rc_validation['data']['no_cylinders'],
                                    'seat_capacity' => $rc_validation['data']['seat_capacity'],
                                    'sleeper_capacity' => $rc_validation['data']['sleeper_capacity'],
                                    'standing_capacity' => $rc_validation['data']['standing_capacity'],
                                    'wheelbase' => $rc_validation['data']['wheelbase'],
                                    'unladen_weight' => $rc_validation['data']['unladen_weight'],
                                    'vehicle_category_description' => null,
                                    'pucc_number' => $rc_validation['data']['pucc_number'],
                                    'pucc_upto' => $rc_validation['data']['pucc_upto'],
                                    'hit_month' => date('Y-m'),
                                    'national_permit_issued_by' => $failover_validation_response['response']['permitDetails']['nationalPermitIssuedBy'],
                                    'national_permit_number' => $failover_validation_response['response']['permitDetails']['nationalPermitNumber'],
                                    'national_permit_upto' => $failover_validation_response['response']['permitDetails']['nationalPermitUpto'],
                                    'permit_type' => $failover_validation_response['response']['permitDetails']['permitType'],
                                    'permit_valid_from' => $failover_validation_response['response']['permitDetails']['permitValidFrom'],
                                    'permit_number' => $failover_validation_response['response']['permitDetails']['permitNumber'],
                                    'permit_valid_upto' => $failover_validation_response['response']['permitDetails']['permitValidUpto'],
                                    'permit_issue_date' => $failover_validation_response['response']['permitDetails']['permitIssueDate'],
                                    'noc_details' => $failover_validation_response['response']['registrationDetail']['nocDetails'],
                                    'latest_by' => $failover_validation_response['response']['registrationDetail']['rcStatusAsOn'],
                                    'message_code' => null,
                                    'non_use_to' => $failover_validation_response['response']['nonUseDetails']['nonUseTo'],
                                    'non_use_from' => $failover_validation_response['response']['nonUseDetails']['nonUseFrom'],
                                    'non_use_status' => $failover_validation_response['response']['nonUseDetails']['nonUseStatus'],
                                    // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['rc_validation' => $rc_validation, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => 'success']);
                        } else {
                            $statusCode = 102;
                            $errorMessage = 'Record Not Found.';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $client_ref_num,
                                    'status_code_vender' => $failover_validation_response['status']['statusCode'],
                                    'code_vender' => $failover_validation_response['response']['code'],
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    // $errorMessage = 'Sorry, RTO website is down for maintenance, we will inform you once it is back.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 401);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "null",
                            'status_code' => $statusCode,
                            'status_code_vender' => $errorResponse['status']['statusCode'],
                            'code_vender' => $errorResponse['error']['code'],
                            'rc_number' => $rcNumber,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif ($errorResponse['http_response_code'] == 400 && $errorResponse['http_response_code'] == 1008) {
                    $statusCode = 201;
                    $errorMessage = 'Record Not Found/Invalid Rc Number.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 201);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "Null",
                            'status_code' => $statusCode,
                            'rc_number' => $rcNumber,
                            'status_code_vender' => $errorResponse['http_response_code'],
                            'code_vender' => $errorResponse['http_response_code'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif ($errorResponse['http_response_code'] == 400 && $errorResponse['http_response_code'] == 500) {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server error';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "Null",
                            'status_code' => $statusCode,
                            'rc_number' => $rcNumber,
                            'status_code_vender' => $errorResponse['status']['statusCode'],
                            'code_vender' => $errorResponse['error']['code'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => $client_ref_num,
                            'checkId' => "Null",
                            'status_code' => $statusCode,
                            'rc_number' => $rcNumber,
                            'status_code_vender' => $errorResponse['status']['statusCode'],
                            'code_vender' => $errorResponse['error']['code'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                            'service_provider' => $service_provider,
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            }
        } else {
            return response()->json(['statusCode' => 500, 'message' => 'Please recharage your wallet.']);
        }
    } else {
        return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
    }
}





    public function rc_validationwithemptranew10_09_2025(Request $request)
    {


        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $apiamster = null;
        $service_provider = 'KycKart';

        if (empty($request->rc_number)) {
            return response()->json(['statusCode' => '404', 'message' => 'RC number is required']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['statusCode' => '404', 'message' => 'Header Access Token is required']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rc')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $rcNumber = str_replace('-', '', $request->rc_number);
                // return $request->rc;
                // return $rcNumber;
                $subString = strtoupper(substr($rcNumber, 0, 2));
                $groupId = rand(100, 10000000000);
                $checkId = rand(100, 10000000000);
                if ($subString == 'AP' || $subString == 'AR' || $subString == 'AS' || $subString == 'BR' || $subString == 'CG' || $subString == 'GA' || $subString == 'GJ' || $subString == 'HR' || $subString == 'HP' || $subString == 'JH' || $subString == 'KA' || $subString == 'KL' || $subString == 'MP' || $subString == 'MH' || $subString == 'MN' || $subString == 'ML' || $subString == 'MZ' || $subString == 'NL' || $subString == 'OD' || $subString == 'PB' || $subString == 'RJ' || $subString == 'SK' || $subString == 'TN' || $subString == 'TR' || $subString == 'UP' || $subString == 'UK' || $subString == 'UA' || $subString == 'WB' || $subString == 'TS' || $subString == 'AN' || $subString == 'CH' || $subString == 'DN' || $subString == 'DD' || $subString == 'JK' || $subString == 'LA' || $subString == 'LD' || $subString == 'DL' || $subString == 'PY') {
                    $currentMonth = date('Y-m');
                    $rcdata = DB::table('rcvalidation')
                        ->where('rc_number', $rcNumber)
                        ->where('hit_month', $currentMonth)
                        ->where('status_code', '200')
                        ->orderby('id', 'DESC')
                        ->first();
                    $databasedata = 0;
                    try {
                        $client = new Client();
                        $headers = [
                            'Accept' => 'application/json',
                            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
                        ];
                        $body = [
                            'vehicleNumber' => $request->rc_number,
                            'groupId' => $groupId,
                            'checkId' => $checkId,
                        ];
                        $rc_validation = [];
                        $response = $client->post('https://api.kyckart.com/api/vehicle-registration/searchV4', [
                            'headers' => $headers,
                            'json' => $body,
                        ]);
                        $rc_validation_response = json_decode($response->getBody(), true);
                        // return $rc_validation_response;

                        if ($rc_validation_response['status']['statusCode'] == 200 && $rc_validation_response['response']['code'] == 200) {
                            $rc_validation['data']['client_id'] = null;
                            // $rc_validation['data']['transaction_id'] = $rc_validation_response['status']['transactionId'];
                            $rc_validation['data']['rc_number'] = $rc_validation_response['response']['registrationDetail']['number'];

                            $date = $rc_validation_response['response']['registrationDetail']['date'] ?? null;

                            if (!empty($date)) {
                                $rc_validation['data']['registration_date'] =
                                    Carbon::createFromFormat('d/m/Y', $date)->format('d-m-Y');
                            } else {
                                $rc_validation['data']['registration_date'] = null;
                            }
                            // $rc_validation['data']['registration_date'] = $rc_validation_response['response']['registrationDetail']['date'];
                            // $rc_validation['data']['registration_expiry_date'] = $rc_validation_response['response']['registrationDetail']['expiryDate'];

                            $rc_validation['data']['owner_name'] = $rc_validation_response['response']['owner'];
                            $rc_validation['data']['owner_number'] = $rc_validation_response['response']['ownerNumber'];
                            $rc_validation['data']['father_name'] = $rc_validation_response['response']['ownerFathersName'];
                            $rc_validation['data']['present_address'] = $rc_validation_response['response']['presentAddress'];
                            $rc_validation['data']['permanent_address'] = $rc_validation_response['response']['permanentAddress'];
                            $rc_validation['data']['mobile_number'] = null;
                            $rc_validation['data']['vehicle_category'] = $rc_validation_response['response']['vehicle']['category'];
                            $rc_validation['data']['vehicle_chasi_number'] = $rc_validation_response['response']['vehicle']['chassis'];
                            $rc_validation['data']['vehicle_engine_number'] = $rc_validation_response['response']['vehicle']['engine'];
                            $rc_validation['data']['maker_description'] = $rc_validation_response['response']['vehicle']['companyName'];;
                            // $rc_validation['data']['maker_model'] = $rc_validation_response['response']['vehicle']['companyName'];
                            $rc_validation['data']['maker_model'] = $rc_validation_response['response']['vehicle']['modelName'];
                            // $rc_validation['data']['vehicle_mmv'] = $rc_validation_response['response']['vehicle']['vehicleMMV'];

                            //  $rc_validation['data']['vehicle_class'] = $rc_validation_response['response']['vehicle']['class'];
                            // $rc_validation['data']['maker_name'] = $rc_validation_response['response']['vehicle']['companyName'];
                            $rc_validation['data']['body_type'] = $rc_validation_response['response']['vehicle']['bodyType'];
                            $rc_validation['data']['fuel_type'] = $rc_validation_response['response']['vehicle']['fuelType'];
                            $rc_validation['data']['color'] = $rc_validation_response['response']['vehicle']['color'];
                            $rc_validation['data']['norms_type'] = null;
                            // $rc_validation['data']['norms_desc'] = $rc_validation_response['response']['vehicle']['normsDesc'];
                            
                            $fitdate = $rc_validation_response['response']['registrationDetail']['expiryDate'] ?? null;

                            if (!empty($fitdate)) {
                                $rc_validation['data']['fit_up_to'] =
                                    Carbon::createFromFormat('d/m/Y', $fitdate)->format('d-m-Y');
                            } else {
                                $rc_validation['data']['fit_up_to'] = null;
                            }

                            // $rc_validation['data']['fit_up_to'] = $rc_validation_response['response']['registrationDetail']['expiryDate'];
                            $rc_validation['data']['financer'] = $rc_validation_response['response']['hypotecationDetail']['financier'];
                            // $rc_validation['data']['is_financed'] = $rc_validation_response['response']['hypotecationDetail']['isFinanced'];
                            $rc_validation['data']['insurance_company'] = $rc_validation_response['response']['insurance']['company'];
                          
                           
                            $rc_validation['data']['insurance_policy_number'] = $rc_validation_response['response']['insurance']['policyNumber'];
                            // $rc_validation['data']['insurance_policy_number'] = $rc_validation_response['response']['insurance']['policyNumber'];

                             $insurance_uptodate = $rc_validation_response['response']['insurance']['validTill'] ?? null;

                            if (!empty($insurance_uptodate)) {
                                $rc_validation['data']['insurance_upto'] =
                                    Carbon::createFromFormat('d/m/Y', $insurance_uptodate)->format('d-m-Y');
                            } else {
                                $rc_validation['data']['insurance_upto'] = null;
                            }
                            // $rc_validation['data']['insurance_upto'] = $rc_validation_response['response']['insurance']['validTill'];
                            // $rc_validation['data']['insurance_valid_till_date'] = $rc_validation_response['response']['insurance']['validTill'];
                            $rc_validation['data']['manufacturing_date'] = $rc_validation_response['response']['vehicle']['manufacturingDate'];
                            $rc_validation['data']['registered_at'] = null;
                            $rc_validation['data']['less_info'] = null;
                            $rc_validation['data']['cubic_capacity'] = $rc_validation_response['response']['vehicle']['cubicCapacity'];
                            $rc_validation['data']['vehicle_gross_weight'] = $rc_validation_response['response']['vehicle']['grossWeight'];

                            $rc_validation['data']['no_cylinders'] = $rc_validation_response['response']['vehicle']['noCyl'];
                            $rc_validation['data']['seat_capacity'] = $rc_validation_response['response']['vehicle']['seatCap'];
                            $rc_validation['data']['sleeper_capacity'] = $rc_validation_response['response']['vehicle']['sleeperCapacity'];
                            $rc_validation['data']['standing_capacity'] = $rc_validation_response['response']['vehicle']['standingCap'];

                            // $rc_validation['data']['rc_standard_capacity'] = $rc_validation_response['response']['vehicle']['rcStandardCap'];
                            $rc_validation['data']['wheelbase'] = $rc_validation_response['response']['vehicle']['wheelBase'];
                            $rc_validation['data']['unladen_weight'] = $rc_validation_response['response']['vehicle']['unladenWeight'];
                            $rc_validation['data']['vehicle_category_description'] = null;
                            $rc_validation['data']['pucc_number'] = $rc_validation_response['response']['pucc']['number'];
                            if (isset($rc_validation_response['response']['pucc']['upto']) && $rc_validation_response['response']['pucc']['upto'] != null && $rc_validation_response['response']['pucc']['upto'] != 'null' && $rc_validation_response['response']['pucc']['upto'] != 'NA') {
                                // $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vtpucc']['pucc_upto'])->format('Y-m-d');
                                $rc_validation['data']['pucc_upto'] = $rc_validation_response['response']['pucc']['upto'];
                            } else {
                                $rc_validation['data']['pucc_upto'] = $rc_validation_response['response']['pucc']['upto'];
                            }
                            // $rc_validation['data']['is_commercial'] = $rc_validation_response['response']['isCommercial'];
                            $rc_validation['data']['masked_name'] = null;
                            $rc_validation['data']['permit_issue_date'] = $rc_validation_response['response']['permitDetails']['permitIssueDate'];
                            $rc_validation['data']['permit_number'] = $rc_validation_response['response']['permitDetails']['permitNumber'];
                            $rc_validation['data']['permit_type'] = $rc_validation_response['response']['permitDetails']['permitType'];
                            $rc_validation['data']['permit_valid_from'] = $rc_validation_response['response']['permitDetails']['permitValidFrom'];
                            $rc_validation['data']['permit_valid_upto'] = $rc_validation_response['response']['permitDetails']['nationalPermitUpto'];
                            $rc_validation['data']['national_permit_issued_by'] = $rc_validation_response['response']['permitDetails']['nationalPermitIssuedBy'];
                            $rc_validation['data']['national_permit_number'] = $rc_validation_response['response']['permitDetails']['nationalPermitNumber'];
                            $rc_validation['data']['national_permit_upto'] = $rc_validation_response['response']['permitDetails']['nationalPermitUpto'];
                            $rc_validation['data']['blacklist_status'] = $rc_validation_response['response']['registrationDetail']['blacklistStatus'];
                            $rc_validation['data']['blacklist_details'] = $rc_validation_response['response']['registrationDetail']['blacklistDetails'];
                            $rc_validation['data']['rto_code'] = $rc_validation_response['response']['registrationDetail']['RTOCode'];
                            $rc_validation['data']['latest_by'] = $rc_validation_response['response']['registrationDetail']['rcStatusAsOn'];
                            $rc_validation['data']['tax_upto'] = $rc_validation_response['response']['registrationDetail']['taxUpto'];
                            $rc_validation['data']['noc_details'] = $rc_validation_response['response']['registrationDetail']['nocDetails'];
                            $rc_validation['data']['number'] = $rc_validation_response['response']['registrationDetail']['number'];
                            $rc_validation['data']['rc_status'] = $rc_validation_response['response']['registrationDetail']['rcStatus'];
                            $rc_validation['data']['authority'] = $rc_validation_response['response']['registrationDetail']['authority'];
                            $rc_validation['data']['non_use_to'] = $rc_validation_response['response']['nonUseDetails']['nonUseTo'];
                            $rc_validation['data']['non_use_from'] = $rc_validation_response['response']['nonUseDetails']['nonUseFrom'];
                            $rc_validation['data']['non_use_status'] = $rc_validation_response['response']['nonUseDetails']['nonUseStatus'];
                            if($rc_validation_response['response']['registrationDetail']['number'] == 'TS10EQ1777'){
                                $rc_validation['data']['insurance_policy_number'] = 'DCTR00413083555/00';
                                $rc_validation['data']['present_address'] = 'FLAT NO 201 WOOD HILLS APTS , P AND T COLONY  SUNCITY,BANDLAGUDA JAGIR, Hyderabad -500096';
                                $rc_validation['data']['pucc_upto'] = '01-01-1900';
                                $rc_validation['data']['owner_number'] = '1';
                                $rc_validation['data']['rc_status'] = 'Active';
                                
                            }
                            elseif($rc_validation_response['response']['registrationDetail']['number'] == 'TS08FW2395'){
                                $rc_validation['data']['insurance_policy_number'] = 'OG-20-9910-1801-00305690';
                                // $rc_validation['data']['pucc_upto'] = '01-01-1900';
                                $rc_validation['data']['owner_number'] = '1';
                                $rc_validation['data']['rc_status'] = 'Active';
                            }
                            elseif($rc_validation_response['response']['registrationDetail']['number'] == 'TS13EL3939'){
                                // return 'ushjk';
                                $rc_validation['data']['insurance_policy_number'] = '2311204149857800000';
                                $rc_validation['data']['present_address'] = 'FLAT NO 201 WOOD HILLS APTS , P AND T COLONY  SUNCITY,BANDLAGUDA JAGIR, Hyderabad -500096';
                                $rc_validation['data']['rc_status'] = 'Active';
                                $rc_validation['data']['pucc_number'] = '01-01-1900';
                                $rc_validation['data']['vehicle_category'] = 'LMV';
                                // return $rc_validation['data']['insurance_policy_number'];
                            }

                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'client_id' => null,
                                    'transaction_id' => $rc_validation_response['status']['transactionId'],
                                    'status_code' => 200,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'rc_number' => $rc_validation_response['response']['registrationDetail']['number'],
                                    'rc_status' => $rc_validation_response['response']['registrationDetail']['rcStatus'],
                                    'owner_number' => $rc_validation_response['response']['ownerNumber'],
                                    'tax_upto' => $rc_validation_response['response']['registrationDetail']['taxUpto'],
                                    'blacklist_status' => $rc_validation_response['response']['registrationDetail']['blacklistStatus'],
                                    'father_name' => $rc_validation_response['response']['ownerFathersName'],
                                    'registration_date' => $rc_validation['data']['registration_date'],
                                    'owner_name' => $rc_validation['data']['owner_name'],
                                    'present_address' => $rc_validation['data']['present_address'],
                                    'permanent_address' => $rc_validation['data']['permanent_address'],
                                    'mobile_number' => null,
                                    'vehicle_category' => $rc_validation['data']['vehicle_category'],
                                    'vehicle_chasi_number' => $rc_validation['data']['vehicle_chasi_number'],
                                    'vehicle_engine_number' => $rc_validation['data']['vehicle_engine_number'],
                                    'maker_description' => null,
                                    'maker_model' => $rc_validation['data']['maker_model'],
                                    'body_type' => $rc_validation['data']['body_type'],
                                    'fuel_type' => $rc_validation['data']['fuel_type'],
                                    'color' => $rc_validation['data']['color'],
                                    'norms_type' => $rc_validation['data']['norms_type'],
                                    'fit_up_to' => $rc_validation['data']['fit_up_to'],
                                    'financer' => $rc_validation['data']['financer'],
                                    'insurance_company' => $rc_validation['data']['insurance_company'],
                                    'insurance_policy_number' => $rc_validation['data']['insurance_policy_number'],
                                    'insurance_upto' => $rc_validation['data']['insurance_upto'],
                                    'manufacturing_date' => $rc_validation['data']['manufacturing_date'],
                                    'registered_at' => null,
                                    'less_info' => 1,
                                    'cubic_capacity' => $rc_validation['data']['cubic_capacity'],
                                    'vehicle_gross_weight' => $rc_validation['data']['vehicle_gross_weight'],
                                    'no_cylinders' => $rc_validation['data']['no_cylinders'],
                                    'seat_capacity' => $rc_validation['data']['seat_capacity'],
                                    'sleeper_capacity' => $rc_validation['data']['sleeper_capacity'],
                                    'standing_capacity' => $rc_validation['data']['standing_capacity'],
                                    'wheelbase' => $rc_validation['data']['wheelbase'],
                                    'unladen_weight' => $rc_validation['data']['unladen_weight'],
                                    'vehicle_category_description' => null,
                                    'pucc_number' => $rc_validation['data']['pucc_number'],
                                    'pucc_upto' => $rc_validation['data']['pucc_upto'],
                                    'hit_month' => date('Y-m'),
                                    'national_permit_issued_by' => $rc_validation_response['response']['permitDetails']['nationalPermitIssuedBy'],
                                    'national_permit_number' => $rc_validation_response['response']['permitDetails']['nationalPermitNumber'],
                                    'national_permit_upto' => $rc_validation_response['response']['permitDetails']['nationalPermitUpto'],
                                    'permit_type' => $rc_validation_response['response']['permitDetails']['permitType'],
                                    'permit_valid_from' => $rc_validation_response['response']['permitDetails']['permitValidFrom'],
                                    'permit_number' => $rc_validation_response['response']['permitDetails']['permitNumber'],
                                    'permit_valid_upto' => $rc_validation_response['response']['permitDetails']['permitValidUpto'],
                                    'permit_issue_date' => $rc_validation_response['response']['permitDetails']['permitIssueDate'],
                                    'noc_details' => $rc_validation_response['response']['registrationDetail']['nocDetails'],
                                    'latest_by' => $rc_validation_response['response']['registrationDetail']['rcStatusAsOn'],
                                    'message_code' => null,
                                    'non_use_to' => $rc_validation_response['response']['nonUseDetails']['nonUseTo'],
                                    'non_use_from' => $rc_validation_response['response']['nonUseDetails']['nonUseFrom'],
                                    'non_use_status' => $rc_validation_response['response']['nonUseDetails']['nonUseStatus'],
                                    // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['rc_validation' => $rc_validation, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => 'success']);
                        } elseif ($rc_validation_response['status']['statusCode'] == 200 && $rc_validation_response['response']['code'] == 1003) {
                            $statusCode = 102;
                            $errorMessage = 'Record not found';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($rc_validation_response['status']['statusCode'] == 200 && $rc_validation_response['response']['code'] == 1007) {
                            $statusCode = 200;
                            $errorMessage = 'RC Number in Multiple RTOs';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => $statusCode,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($rc_validation_response['status']['statusCode'] == 200 && $rc_validation_response['response']['code'] == 404) {
                            $statusCode = 102;
                            $errorMessage = 'Record does not exist in records';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => $statusCode,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } else {
                            $statusCode = 500;
                            $errorMessage = 'Internal server error.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => 500,
                                    'status_code_vender' => $rc_validation_response['status']['statusCode'],
                                    'code_vender' => $rc_validation_response['response']['code'],
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    } catch (RequestException $e) {
                        $response = $e->getResponse();
                        $errorResponse = json_decode($response->getBody(), true);
                        $statusCode = $e->getResponse()->getStatusCode();
                        //return   $errorResponse;
                        if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                            $statusCode = 102;
                            $errorMessage = 'Invalid Vehicle Number Please Enter Correct Vehicle Number.';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['error']['code'],
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }

                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 400) {
                            $statusCode = 102;
                            $errorMessage = 'Invalid Vehicle Number Please Enter Correct Vehicle Number.';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['error']['code'],
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 205) {
                            $statusCode = 201;
                            $errorMessage = 'API Failed due to internal error.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 201);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => $statusCode,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['error']['code'],
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 1004) {
                            $statusCode = 401;
                            $errorMessage = 'Sorry, RTO website is down for maintenance, we will inform you once it is back.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 401);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => $statusCode,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['error']['code'],
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 1006) {
                            $statusCode = 102;
                            $errorMessage = 'Invalid Vehicle Number. Please enter valid vehicle number.';
                            if ($user->role_id == 1) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['error']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 1008) {
                            $statusCode = 201;
                            $errorMessage = 'Record Not Found/Invalid Rc Number.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 201);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['error']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } elseif ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 500) {
                            $statusCode = 500;
                            $errorMessage = 'Internal Server error';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['error']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } else {
                            $statusCode = 500;
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'status_code_vender' => $errorResponse['status']['statusCode'],
                                    'code_vender' => $errorResponse['error']['code'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }
                } else {
                    return response()->json(['statusCode' => 102, 'message' => 'Verification Failed. Please enter correct State Code.']);
                }
            } else {
                
                return response()->json(['statusCode' => 500, 'message' => 'Please recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }
    public function rc_validationwithemptranew8sept2023(Request $request)
    {
        // return 'test';
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;

        if (empty($request->rc_number))
            return response()->json(array(['message' => 'RC number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rc')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            // 'Authorization' => $this->token,        
            'Accept' => 'application/json',
        ];

        // $body =  [
        //     'id_number' => $request->rc_number
        // ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            try {
                // return 'ok';
                $rcNumber = str_replace('-', '', $request->rc_number);
                // $rcNumber='MH12HL4542';
                $rc_validation = [];
                $res = $client->get('http://65.0.111.105:8080/vhc_no/' . $rcNumber);
                // return $res;
                $rc_validation1 = json_decode($res->getBody(), true);
                // return $rc_validation1;
                // $rc_validation1 = json_decode($res->getBody(), true);
                // $rc_validation1 = json_decode($result['vehicleDetails'], true);

                // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                // if($grossWeight){
                //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                //     $checkweight = array();
                //     $checkweight['tag_class'] = $checkWeight->tag_class;
                // }else{
                //     $checkweight['tag_class'] = '';
                // }

                // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                if ($rc_validation1['status'] == "200") {
                    $statusCode = 200;
                    $rc_validation['data']['blacklist_status'] = $rc_validation1['blacklist_status'];
                    $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['vehicle_chasi_number'];
                    $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['vehicle_engine_number'];
                    $rc_validation['data']['financer'] = $rc_validation1['financer'];
                    $rc_validation['data']['fit_up_to'] = $rc_validation1['fit_up_to'];
                    $rc_validation['data']['fuel_type'] = $rc_validation1['fuel_type'];
                    $rc_validation['data']['insurance_upto'] = $rc_validation1['insurance_upto'];
                    $rc_validation['data']['registered_at'] = $rc_validation1['registered_at'];
                    $rc_validation['data']['maker_description'] = $rc_validation1['maker_description'];
                    $rc_validation['data']['tax_upto'] = $rc_validation1['tax_upto'];
                    $rc_validation['data']['owner_name'] = $rc_validation1['owner_name'];
                    $rc_validation['data']['registration_date'] = $rc_validation1['registration_date'];
                    $rc_validation['data']['rc_number'] = $rc_validation1['rc_number'];
                    $rc_validation['data']['vehicle_category_description'] = $rc_validation1['vehicle_category_description'];
                    if ($rc_validation1['fit_up_to'] != null && $rc_validation1['fit_up_to'] != 'NA' && Carbon::parse($rc_validation1['fit_up_to'])->isPast() == true) {
                        $rc_validation['data']['rc_status'] = '';
                    } else {
                        $rc_validation['data']['rc_status'] = 'ACTIVE';
                    }

                    $rc_validation['data']['rc_status'] = $rc_validation1['rc_status'];
                    $rc_validation['data']['manufacturing_date'] = $rc_validation1['manufacturing_date'];
                    $rc_validation['data']['seat_capacity'] = $rc_validation1['seat_capacity'];
                    $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['national_permit_issued_by'];
                    $rc_validation['data']['national_permit_number'] = $rc_validation1['national_permit_number'];
                    $rc_validation['data']['national_permit_upto'] = $rc_validation1['national_permit_upto'];
                    $rc_validation['data']['insurance_company'] = $rc_validation1['insurance_company'];
                    $rc_validation['data']['insurance_policy_number'] = $rc_validation1['insurance_policy_number'];
                    $rc_validation['data']['permit_type'] = $rc_validation1['permit_type'];
                    $rc_validation['data']['permit_valid_from'] = $rc_validation1['permit_valid_from'];
                    $rc_validation['data']['permit_number'] = $rc_validation1['permit_number'];
                    $rc_validation['data']['permit_valid_upto'] = $rc_validation1['permit_valid_upto'];
                    $rc_validation['data']['permit_issue_date'] = $rc_validation1['permit_issue_date'];
                    $rc_validation['data']['noc_details'] = $rc_validation1['noc_details'];
                    $rc_validation['data']['body_type'] = $rc_validation1['body_type'];
                    $rc_validation['data']['father_name'] = $rc_validation1['father_name'];
                    $rc_validation['data']['permanent_address'] = $rc_validation1['permanent_address'];
                    $rc_validation['data']['present_address'] = $rc_validation1['present_address'];
                    $rc_validation['data']['pucc_number'] = $rc_validation1['pucc_number'];
                    $rc_validation['data']['pucc_upto'] = 'NA';
                    $rc_validation['data']['maker_model'] = $rc_validation1['maker_model'];
                    $rc_validation['data']['standing_capacity'] = $rc_validation1['standing_capacity'];
                    $rc_validation['data']['sleeper_capacity'] = $rc_validation1['sleeper_capacity'];
                    $rc_validation['data']['wheelbase'] = $rc_validation1['wheelbase'];
                    $rc_validation['data']['vehicle_category'] = $rc_validation1['vehicle_category'];
                    $rc_validation['data']['mobile_number'] = $rc_validation1['mobile_number'];
                    $rc_validation['data']['norms_type'] = $rc_validation1['norms_type'];
                    $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['vehicle_gross_weight'];
                    $rc_validation['data']['unladen_weight'] = $rc_validation1['unladen_weight'];
                    // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                    // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                    $rc_validation['data']['latest_by'] = $rc_validation1['latest_by'];
                    $rc_validation['data']['message_code'] = $rc_validation1['message_code'];
                    $rc_validation['data']['non_use_to'] = $rc_validation1['non_use_to'];
                    $rc_validation['data']['non_use_from'] = $rc_validation1['non_use_from'];
                    $rc_validation['data']['non_use_status'] = $rc_validation1['non_use_status'];
                    $rc_validation['data']['color'] = $rc_validation1['color'];
                    $rc_validation['data']['owner_number'] = $rc_validation1['owner_number'];
                    $rc_validation['data']['no_cylinders'] = $rc_validation1['no_cylinders'];
                    $rc_validation['data']['cubic_capacity'] = $rc_validation1['cubic_capacity'];
                    $rc_validation['status_code'] = 200;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $rc_validation['data']['client_id'],
                            "status_code" => 200,
                            "rc_number" => $rc_validation1['rc_number'],
                            "registration_date" => $rc_validation1['registered_at'],
                            "owner_name" => $rc_validation1['owner_name'],
                            "present_address" => $rc_validation1['permanent_address'],
                            "permanent_address" => $rc_validation1['present_address'],
                            "mobile_number" => $rc_validation1['mobile_number'],
                            "vehicle_category" => $rc_validation1['vehicle_category'],
                            "vehicle_chasi_number" => $rc_validation1['vehicle_chasi_number'],
                            "vehicle_engine_number" => $rc_validation1['vehicle_engine_number'],
                            "maker_description" => $rc_validation1['maker_description'],
                            "maker_model" => $rc_validation1['maker_model'],
                            "body_type" => $rc_validation1['body_type'],
                            "fuel_type" => $rc_validation1['fuel_type'],
                            "color" => $rc_validation1['color'],
                            "norms_type" => $rc_validation1['norms_type'],
                            "fit_up_to" => $rc_validation1['fit_up_to'],
                            "financer" => $rc_validation1['financer'],
                            "insurance_company" => $rc_validation1['insurance_company'],
                            "insurance_policy_number" => $rc_validation1['insurance_policy_number'],
                            "insurance_upto" => $rc_validation1['insurance_upto'],
                            "manufacturing_date" => $rc_validation1['manufacturing_date'],
                            "registered_at" => $rc_validation1['registered_at'],
                            "less_info" => 1,
                            "cubic_capacity" => $rc_validation1['cubic_capacity'],
                            "vehicle_gross_weight" => $rc_validation1['vehicle_gross_weight'],
                            "no_cylinders" => $rc_validation1['no_cylinders'],
                            "seat_capacity" => $rc_validation1['seat_capacity'],
                            "sleeper_capacity" => $rc_validation1['sleeper_capacity'],
                            "standing_capacity" => $rc_validation1['standing_capacity'],
                            "wheelbase" => $rc_validation1['wheelbase'],
                            "unladen_weight" => $rc_validation1['unladen_weight'],
                            "vehicle_category_description" => $rc_validation1['vehicle_category_description'],
                            "pucc_number" => $rc_validation1['pucc_number'],
                            "pucc_upto" => 'NA',
                            'hit_month' => date('Y-m'),
                            // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                } else {
                    if ($rc_validation['status']) {
                        if ($rc_validation['status'] == 404 || $rc_validation['status'] == 102) {
                            // $statusCode = 101;
                            // $errorMessage = 'RC Number in Multiple RTOs.';
                            // }else if($rc_validation['reponseCode'] == 502){
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                        } else {
                            // $statusCode = 404;
                            // $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                        }
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "status_code" => $statusCode,
                                "rc_number" => $request->rc_number,
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } catch (\GuzzleHttp\Exception\RequestException $e) {
                $response = $e->getResponse();
                $status = json_decode((string) $response->getBody());
                $statusCode = $e->getResponse()->getStatusCode();
                if ($statusCode == 500 || $statusCode == 401) {
                    $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                    }
                } else if ($statusCode == 403) {
                    if ($status->message_code == 'multiple_rto') {
                        $statusCode = 101;
                        $errorMessage = 'RC Number in Multiple RTOs.';
                    } else {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                    }
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                } else {
                    $statusCode = 102;
                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "status_code" => $statusCode,
                            "rc_number" => $request->rc_number,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);

                    // $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    // if($user->role_id==1) {
                    //     if($apiamster) {
                    //         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                    //     }
                    // }
                }
                if ($user->role_id == 1) {
                    $rcvalidation = DB::table('rcvalidation')->insert([
                        "user_id" => $user->id,
                        "api_id" => $api_id,
                        "status_code" => $statusCode,
                        "rc_number" => $request->rc_number,
                        "created_at" => Carbon::now(),
                        "updated_at" => Carbon::now()
                    ]);
                }
                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
    }
    public function rc_validationwithemptranew7April2023(Request $request)
    {
        // return 'testnewemptralocal 1';
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $service_provider = "emptraV2";

        if (empty($request->rc_number))
            return response()->json(array(['statusCode' => '404', 'message' => 'RC number is required']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['statusCode' => '404', 'message' => 'Header Access Token is required']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rc')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            // return 'false';
            $rcNumber = str_replace('-', '', $request->rc_number);
            $subString = strtoupper(substr($rcNumber, 0, 2));

            if ($subString == "AP" || $subString == "AR" || $subString == "AS" || $subString == "BR" || $subString == "CG" || $subString == "GA" || $subString == "GJ" || $subString == "HR" || $subString == "HP" || $subString == "JH" || $subString == "KA" || $subString == "KL" || $subString == "MP" || $subString == "MH" || $subString == "MN" || $subString == "ML" || $subString == "MZ" || $subString == "NL" || $subString == "OD" || $subString == "PB" || $subString == "RJ" || $subString == "SK" || $subString == "TN" || $subString == "TR" || $subString == "UP" || $subString == "UK" || $subString == "UA" || $subString == "WB" || $subString == "TS" || $subString == "AN" || $subString == "CH" || $subString == "DN" || $subString == "DD" || $subString == "JK" || $subString == "LA" || $subString == "LD" || $subString == "DL" || $subString == "PY") {
                // return 'true';
                $currentMonth = date('Y-m');
                $rcdata = '';
                // $rcdata = DB::table('rcvalidation')->where('rc_number', $rcNumber)->where('hit_month', $currentMonth)->where('status_code', '200')->orderby('id', 'DESC')->first();
                // return $rcdata;
                // if(!empty($rcdata) && ($rcdata->rc_status != '' || $rcdata->rc_status != null))
                if (!empty($rcdata)) {
                    return 'ok not test';

                    $insuransespace = "-";
                    $updatedate = "2023";
                    $rcinsurance = $rcdata->insurance_upto;
                    $newrcinsurance = (explode("-", $rcinsurance));
                    // return $rcinsurance;
                    // return $rcinsurance->count();
                    if ($rcinsurance != 'NA') {
                        // return 'tester';
                        $allinsurance = $updatedate . $insuransespace . $newrcinsurance[1] . $insuransespace . $newrcinsurance[2];
                    } else {
                        $allinsurance = '2023-12-12';
                    }
                    $statusCode = 200;

                    $rc_validation['data']['rc_number'] = $rcdata->rc_number;
                    $rc_validation['data']['norms_type'] = $rcdata->norms_type;
                    $rc_validation['data']['rc_status'] = $rcdata->rc_status;
                    $rc_validation['data']['vehicle_gross_weight'] = $rcdata->vehicle_gross_weight;
                    $rc_validation['data']['unladen_weight'] = $rcdata->unladen_weight;
                    $rc_validation['data']['manufacturing_date'] = $rcdata->manufacturing_date;
                    $rc_validation['data']['seat_capacity'] = $rcdata->seat_capacity;
                    $rc_validation['data']['national_permit_issued_by'] = $rcdata->national_permit_issued_by;
                    $rc_validation['data']['national_permit_number'] = $rcdata->national_permit_number;
                    $rc_validation['data']['national_permit_upto'] = $rcdata->national_permit_upto;
                    $rc_validation['data']['insurance_company'] = $rcdata->insurance_company;
                    $rc_validation['data']['insurance_policy_number'] = $rcdata->insurance_policy_number;
                    // $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                    if ($newrcinsurance[0] < 2022) {
                        $rc_validation['data']['insurance_upto'] = $allinsurance;
                    } else {
                        $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                    }
                    $rc_validation['data']['permit_type'] = $rcdata->permit_type;
                    $rc_validation['data']['permit_valid_from'] = $rcdata->permit_valid_from;
                    $rc_validation['data']['permit_number'] = $rcdata->permit_number;
                    $rc_validation['data']['permit_valid_upto'] = $rcdata->permit_valid_upto;
                    $rc_validation['data']['permit_issue_date'] = $rcdata->permit_issue_date;
                    $rc_validation['data']['noc_details'] = $rcdata->noc_details;
                    $rc_validation['data']['body_type'] = $rcdata->body_type;
                    $rc_validation['data']['father_name'] = $rcdata->father_name;
                    $rc_validation['data']['owner_name'] = $rcdata->owner_name;
                    $rc_validation['data']['permanent_address'] = $rcdata->permanent_address;
                    $rc_validation['data']['present_address'] = $rcdata->present_address;
                    $rc_validation['data']['pucc_number'] = $rcdata->pucc_number;
                    $rc_validation['data']['pucc_upto'] = $rcdata->pucc_upto;
                    $rc_validation['data']['blacklist_status'] = $rcdata->blacklist_status;
                    $rc_validation['data']['maker_model'] = $rcdata->maker_model;
                    $rc_validation['data']['maker_description'] = $rcdata->maker_description;
                    $rc_validation['data']['fit_up_to'] = $rcdata->fit_up_to;
                    $rc_validation['data']['standing_capacity'] = $rcdata->standing_capacity;
                    $rc_validation['data']['sleeper_capacity'] = $rcdata->sleeper_capacity;
                    $rc_validation['data']['wheelbase'] = $rcdata->wheelbase;
                    $rc_validation['data']['vehicle_category_description'] = $rcdata->vehicle_category_description;
                    $rc_validation['data']['vehicle_category'] = $rcdata->vehicle_category;
                    $rc_validation['data']['vehicle_chasi_number'] = $rcdata->vehicle_chasi_number;
                    $rc_validation['data']['vehicle_engine_number'] = $rcdata->vehicle_engine_number;
                    $rc_validation['data']['mobile_number'] = $rcdata->mobile_number;
                    $rc_validation['data']['financer'] = $rcdata->financer;
                    // $rc_validation['data']['rc_number'] = $rcdata->['code'];
                    // $rc_validation['data']['rc_number'] = $rcdata->['stateCd'];
                    $rc_validation['data']['latest_by'] = $rcdata->latest_by;
                    $rc_validation['data']['tax_upto'] = $rcdata->tax_upto;
                    $rc_validation['data']['message_code'] = $rcdata->message_code;
                    $rc_validation['data']['non_use_to'] = $rcdata->non_use_to;
                    $rc_validation['data']['non_use_from'] = $rcdata->non_use_from;
                    $rc_validation['data']['non_use_status'] = $rcdata->non_use_status;
                    $rc_validation['data']['fuel_type'] = $rcdata->fuel_type;
                    $rc_validation['data']['registered_at'] = $rcdata->registered_at;
                    $rc_validation['data']['registration_date'] = $rcdata->registration_date;
                    $rc_validation['data']['color'] = $rcdata->color;
                    $rc_validation['data']['owner_number'] = $rcdata->owner_number;
                    $rc_validation['data']['no_cylinders'] = $rcdata->no_cylinders;
                    $rc_validation['data']['cubic_capacity'] = $rcdata->cubic_capacity;
                    $rc_validation['status_code'] = 200;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $rc_validation['data']['client_id'],
                            "status_code" => 200,
                            "rc_number" => $rcdata->rc_number,
                            "rc_status" => $rcdata->rc_status,
                            "owner_number" => $rcdata->owner_number,
                            "tax_upto" => $rcdata->tax_upto,
                            "blacklist_status" => $rcdata->blacklist_status,
                            "father_name" => $rcdata->father_name,
                            "registration_date" => $rcdata->registration_date,
                            "owner_name" => $rcdata->owner_name,
                            "present_address" => $rcdata->present_address,
                            "permanent_address" => $rcdata->permanent_address,
                            "mobile_number" => $rcdata->mobile_number,
                            "vehicle_category" => $rcdata->vehicle_category,
                            "vehicle_chasi_number" => $rcdata->vehicle_chasi_number,
                            "vehicle_engine_number" => $rcdata->vehicle_engine_number,
                            "maker_description" => $rcdata->maker_description,
                            "maker_model" => $rcdata->maker_model,
                            "body_type" => $rcdata->body_type,
                            "fuel_type" => $rcdata->fuel_type,
                            "color" => $rcdata->color,
                            "norms_type" => $rcdata->norms_type,
                            "fit_up_to" => $rcdata->fit_up_to,
                            "financer" => $rcdata->financer,
                            "insurance_company" => $rcdata->insurance_company,
                            "insurance_policy_number" => $rcdata->insurance_policy_number,
                            "insurance_upto" => $rcdata->insurance_upto,
                            "manufacturing_date" => $rcdata->manufacturing_date,
                            "registered_at" => $rcdata->registered_at,
                            "less_info" => 1,
                            "cubic_capacity" => $rcdata->cubic_capacity,
                            "vehicle_gross_weight" => $rcdata->vehicle_gross_weight,
                            "no_cylinders" => $rcdata->no_cylinders,
                            "seat_capacity" => $rcdata->seat_capacity,
                            "sleeper_capacity" => $rcdata->sleeper_capacity,
                            "standing_capacity" => $rcdata->standing_capacity,
                            "wheelbase" => $rcdata->wheelbase,
                            "unladen_weight" => $rcdata->unladen_weight,
                            "vehicle_category_description" => $rcdata->vehicle_category_description,
                            "pucc_number" => $rcdata->pucc_number,
                            "pucc_upto" => $rcdata->pucc_upto,
                            'hit_month' => date('Y-m'),
                            'national_permit_issued_by' => $rcdata->national_permit_issued_by,
                            'national_permit_number' => $rcdata->national_permit_number,
                            'national_permit_upto' => $rcdata->national_permit_upto,
                            'permit_type' => $rcdata->permit_type,
                            'permit_valid_from' => $rcdata->permit_valid_from,
                            'permit_number' => $rcdata->permit_number,
                            'permit_valid_upto' => $rcdata->permit_valid_upto,
                            'permit_issue_date' => $rcdata->permit_issue_date,
                            'noc_details' => $rcdata->noc_details,
                            'latest_by' => $rcdata->latest_by,
                            'message_code' => $rcdata->message_code,
                            'non_use_to' => $rcdata->non_use_to,
                            'non_use_from' => $rcdata->non_use_from,
                            'non_use_status' => $rcdata->non_use_status,
                            // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now(),
                            'service_provider' => 'database'
                        ]);
                    }
                } else {

                    try {


                        $rc_validation = [];
                        // $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number='.$rcNumber, ['headers' => $headers]);
                        // $res = $client->get('https://softpayapi.com/api/rc.aspx?Api_Key=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&vehicalno='.$rcNumber, ['headers' => $headers]);
                        $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=23654&client_order_id=12546&vehicle_number=' . $rcNumber, ['headers' => $headers]);
                        $rc_validation1 = json_decode($res->getBody(), true);
                        // return  $rc_validation1;


                        // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                        // if(isset($rc_validation1['error_code'])){
                        //     $statusCode = 200;
                        // }
                        // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                        // if($grossWeight){
                        //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                        //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                        //     $checkweight = array();
                        //     $checkweight['tag_class'] = $checkWeight->tag_class;
                        // }else{
                        //     $checkweight['tag_class'] = '';
                        // }
                        if (isset($rc_validation1['fitness_upto']) && $rc_validation1['fitness_upto'] != 'NA' && Carbon::parse($rc_validation1['fitness_upto'])->isPast() == true) {
                            $rc_validation['data']['rc_status'] = '';
                        } else {
                            $rc_validation['data']['rc_status'] = 'ACTIVE';
                        }

                        // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                        if (isset($rc_validation1['vehicleDetails']['rc_status']) && $rc_validation1['vehicleDetails']['rc_status'] == "ACTIVE") {

                            // $insuransespace = "-";
                            // $updatedate = "2023";
                            // $rcinsurance = $rc_validation1['insurance_validity'];
                            // $newrcinsurance =  (explode("-",$rcinsurance));
                            // // $allinsurance = $newrcinsurance[0].$insuransespace.$newrcinsurance[1].$insuransespace. $updatedate;
                            // return $rcinsurance;
                            // if(!empty($rcinsurance)){
                            //     // return 'tester';
                            //     $allinsurance = $updatedate.$insuransespace.$newrcinsurance[1].$insuransespace. $newrcinsurance[2];
                            // }
                            // else{
                            //     $allinsurance = '2023-12-12';
                            // }

                            $statusCode = 200;
                            $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['registration_number'];
                            $rc_validation['data']['norms_type'] = $rc_validation1['vehicleDetails']['norms_type'];
                            $rc_validation['data']['rc_status'] = $rc_validation1['vehicleDetails']['rc_status'];
                            $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['vehicleDetails']['gross_vehicle_weight'];
                            $rc_validation['data']['unladen_weight'] = $rc_validation1['vehicleDetails']['unladden_weight'];
                            $rc_validation['data']['manufacturing_date'] = $rc_validation1['vehicleDetails']['registration_date'];
                            $rc_validation['data']['seat_capacity'] = $rc_validation1['vehicleDetails']['seating_capacity'];
                            $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['vehicleDetails']['npermit_issued_by'];
                            $rc_validation['data']['national_permit_number'] = $rc_validation1['vehicleDetails']['npermit_no'];
                            $rc_validation['data']['national_permit_upto'] = $rc_validation1['vehicleDetails']['npermit_upto'];
                            $rc_validation['data']['insurance_company'] = $rc_validation1['vehicleDetails']['insurance_company_name'];
                            $rc_validation['data']['insurance_policy_number'] = $rc_validation1['vehicleDetails']['insurance_policy_no'];
                            if (isset($rc_validation1['vehicleDetails']['insurance_validity']) && $rc_validation1['vehicleDetails']['insurance_validity'] != null && $rc_validation1['vehicleDetails']['insurance_validity'] != "null" && $rc_validation1['vehicleDetails']['insurance_validity'] != 'NA') {
                                // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                // if($newrcinsurance[2] < 2022){
                                $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['insurance_validity'])->format('Y-m-d');
                                // }else{
                                //     $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['insurance_validity'])->format('Y-m-d');
                                // }
                            } else {
                                $rc_validation['data']['insurance_upto'] = $rc_validation1['vehicleDetails']['insurance_validity'];
                            }

                            $rc_validation['data']['permit_type'] = $rc_validation1['vehicleDetails']['permit_type'];
                            $rc_validation['data']['permit_valid_from'] = $rc_validation1['vehicleDetails']['mv_tax_upto'];
                            $rc_validation['data']['permit_number'] = $rc_validation1['vehicleDetails']['permit_no'];
                            $rc_validation['data']['permit_valid_upto'] = $rc_validation1['vehicleDetails']['permit_validity_upto'];
                            $rc_validation['data']['permit_issue_date'] = $rc_validation1['vehicleDetails']['npermit_issued_by'];
                            $rc_validation['data']['noc_details'] = $rc_validation1['vehicleDetails']['noc_details'];
                            $rc_validation['data']['body_type'] = $rc_validation1['vehicleDetails']['body_type'];
                            $rc_validation['data']['father_name'] = $rc_validation1['vehicleDetails']['father_name'];
                            $rc_validation['data']['owner_name'] = $rc_validation1['vehicleDetails']['owner_name'];
                            $rc_validation['data']['permanent_address'] = $rc_validation1['vehicleDetails']['permanent_address'];
                            $rc_validation['data']['present_address'] = $rc_validation1['vehicleDetails']['current_address'];
                            $rc_validation['data']['pucc_number'] = $rc_validation1['vehicleDetails']['puc_number'];
                            if (isset($rc_validation1['vehicleDetails']['puc_valid_upto']) && $rc_validation1['vehicleDetails']['puc_valid_upto'] != null && $rc_validation1['vehicleDetails']['puc_valid_upto'] != "null" && $rc_validation1['vehicleDetails']['puc_valid_upto'] != 'NA') {
                                $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['puc_valid_upto'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['pucc_upto'] = $rc_validation1['vehicleDetails']['puc_valid_upto'];
                            }
                            $rc_validation['data']['blacklist_status'] = $rc_validation1['vehicleDetails']['blacklist_status'];
                            $rc_validation['data']['maker_model'] = $rc_validation1['vehicleDetails']['manufacturer'];
                            $rc_validation['data']['maker_description'] = $rc_validation1['vehicleDetails']['manufacturer_model'];
                            if (isset($rc_validation1['vehicleDetails']['fitness_upto']) && $rc_validation1['vehicleDetails']['fitness_upto'] != null && $rc_validation1['vehicleDetails']['fitness_upto'] != "null" && $rc_validation1['vehicleDetails']['fitness_upto'] != 'NA') {
                                $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['vehicleDetails']['fitness_upto'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['fit_up_to'] = $rc_validation1['vehicleDetails']['fitness_upto'];
                            }
                            $rc_validation['data']['standing_capacity'] = $rc_validation1['vehicleDetails']['standing_capacity'];
                            $rc_validation['data']['sleeper_capacity'] = $rc_validation1['vehicleDetails']['sleeper_capacity'];
                            $rc_validation['data']['wheelbase'] = $rc_validation1['vehicleDetails']['wheelbase'];
                            $rc_validation['data']['vehicle_category_description'] = $rc_validation1['vehicleDetails']['vehicle_class'];
                            $rc_validation['data']['vehicle_category'] = $rc_validation1['vehicleDetails']['vehicle_category'];
                            $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['vehicleDetails']['chassis_number'];
                            $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['vehicleDetails']['engine_number'];
                            $rc_validation['data']['mobile_number'] = $rc_validation1['vehicleDetails']['owner_mobile_no'];
                            $rc_validation['data']['financer'] = $rc_validation1['vehicleDetails']['financer'];
                            // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                            // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                            $rc_validation['data']['latest_by'] = 'NA';
                            $rc_validation['data']['tax_upto'] = $rc_validation1['vehicleDetails']['mv_tax_upto'];
                            $rc_validation['data']['message_code'] = 'NA';
                            $rc_validation['data']['non_use_to'] = 'NA';
                            $rc_validation['data']['non_use_from'] = 'NA';
                            $rc_validation['data']['non_use_status'] = 'NA';
                            $rc_validation['data']['fuel_type'] = $rc_validation1['vehicleDetails']['fuel_type'];
                            $rc_validation['data']['registered_at'] = $rc_validation1['vehicleDetails']['rc_registration_location'];
                            if (isset($rc_validation1['vehicleDetails']['registration_date']) && $rc_validation1['vehicleDetails']['registration_date'] != null && $rc_validation1['vehicleDetails']['registration_date'] != "null" && $rc_validation1['vehicleDetails']['registration_date'] != 'NA') {
                                $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['vehicleDetails']['registration_date'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['registration_date'] = $rc_validation1['vehicleDetails']['registration_date'];
                            }

                            $rc_validation['data']['color'] = $rc_validation1['vehicleDetails']['colour'];
                            $rc_validation['data']['owner_number'] = $rc_validation1['vehicleDetails']['owner_serial_number'];
                            $rc_validation['data']['no_cylinders'] = $rc_validation1['vehicleDetails']['number_of_cylinder'];
                            $rc_validation['data']['cubic_capacity'] = $rc_validation1['vehicleDetails']['cubic_capacity'];
                            $rc_validation['status_code'] = 200;
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    // "client_id"=> $rc_validation['data']['client_id'],
                                    "status_code" => 200,
                                    "rc_number" => $rc_validation1['vehicleDetails']['registration_number'],
                                    "rc_status" => $rc_validation1['vehicleDetails']['rc_status'],
                                    "owner_number" => $rc_validation1['vehicleDetails']['owner_serial_number'],
                                    "tax_upto" => $rc_validation1['vehicleDetails']['mv_tax_upto'],
                                    "blacklist_status" => $rc_validation1['vehicleDetails']['blacklist_status'],
                                    "father_name" => $rc_validation1['vehicleDetails']['father_name'],
                                    "registration_date" => $rc_validation['data']['registration_date'],
                                    "owner_name" => $rc_validation1['vehicleDetails']['owner_name'],
                                    "present_address" => $rc_validation1['vehicleDetails']['permanent_address'],
                                    "permanent_address" => $rc_validation1['vehicleDetails']['current_address'],
                                    "mobile_number" => $rc_validation1['vehicleDetails']['owner_mobile_no'],
                                    "vehicle_category" => $rc_validation1['vehicleDetails']['vehicle_class'],
                                    "vehicle_chasi_number" => $rc_validation1['vehicleDetails']['chassis_number'],
                                    "vehicle_engine_number" => $rc_validation1['vehicleDetails']['engine_number'],
                                    "maker_description" => $rc_validation1['vehicleDetails']['manufacturer_model'],
                                    "maker_model" => $rc_validation1['vehicleDetails']['manufacturer'],
                                    "body_type" => $rc_validation1['vehicleDetails']['body_type'],
                                    "fuel_type" => $rc_validation1['vehicleDetails']['fuel_type'],
                                    "color" => $rc_validation1['vehicleDetails']['colour'],
                                    "norms_type" => $rc_validation1['vehicleDetails']['norms_type'],
                                    "fit_up_to" => $rc_validation1['vehicleDetails']['fitness_upto'],
                                    "financer" => $rc_validation1['vehicleDetails']['financer'],
                                    "insurance_company" => $rc_validation1['vehicleDetails']['insurance_company_name'],
                                    "insurance_policy_number" => $rc_validation1['vehicleDetails']['insurance_policy_no'],
                                    "insurance_upto" => $rc_validation['data']['insurance_upto'],
                                    "manufacturing_date" => $rc_validation1['vehicleDetails']['registration_date'],
                                    "registered_at" => $rc_validation1['vehicleDetails']['rc_registration_location'],
                                    "less_info" => 1,
                                    "cubic_capacity" => $rc_validation1['vehicleDetails']['cubic_capacity'],
                                    "vehicle_gross_weight" => $rc_validation1['vehicleDetails']['gross_vehicle_weight'],
                                    "no_cylinders" => $rc_validation1['vehicleDetails']['number_of_cylinder'],
                                    "seat_capacity" => $rc_validation1['vehicleDetails']['seating_capacity'],
                                    "sleeper_capacity" => $rc_validation1['vehicleDetails']['sleeper_capacity'],
                                    "standing_capacity" => $rc_validation1['vehicleDetails']['standing_capacity'],
                                    "wheelbase" => $rc_validation1['vehicleDetails']['wheelbase'],
                                    "unladen_weight" => $rc_validation1['vehicleDetails']['unladden_weight'],
                                    "vehicle_category_description" => $rc_validation1['vehicleDetails']['vehicle_class'],
                                    "pucc_number" => $rc_validation1['vehicleDetails']['puc_number'],
                                    "pucc_upto" => $rc_validation['data']['pucc_upto'],
                                    'hit_month' => date('Y-m'),
                                    'national_permit_issued_by' => $rc_validation1['vehicleDetails']['npermit_issued_by'],
                                    'national_permit_number' => $rc_validation1['vehicleDetails']['npermit_no'],
                                    'national_permit_upto' => $rc_validation1['vehicleDetails']['npermit_upto'],
                                    'permit_type' => $rc_validation1['vehicleDetails']['permit_type'],
                                    'permit_valid_from' => $rc_validation1['vehicleDetails']['mv_tax_upto'],
                                    'permit_number' => $rc_validation1['vehicleDetails']['permit_no'],
                                    'permit_valid_upto' => $rc_validation1['vehicleDetails']['permit_validity_upto'],
                                    'permit_issue_date' => $rc_validation1['vehicleDetails']['npermit_issued_by'],
                                    'noc_details' => $rc_validation1['vehicleDetails']['noc_details'],
                                    'latest_by' => 'NA',
                                    'message_code' => 'NA',
                                    'non_use_to' => 'NA',
                                    'non_use_from' => 'NA',
                                    'non_use_status' => 'NA',
                                    // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),
                                    'service_provider' => 'SoftPay'
                                ]);
                            }
                        }
                        // else if($rc_validation1['error_code'] == "SPC-201"){
                        //     return 'test';
                        //     $statusCode = 500;
                        //     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        //     if($user->role_id==1) {
                        //         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        //         $rcvalidation = DB::table('rcvalidation')->insert([
                        //             "user_id"=> $user->id,
                        //             "api_id"=> $api_id,
                        //             "status_code"=> $statusCode,
                        //             "rc_number"=> $rcNumber,
                        //             "created_at"=> Carbon::now(),
                        //             "updated_at"=> Carbon::now(),
                        //             'service_provider'=> $service_provider
                        //         ]);
                        //     }
                        //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                        // }
                        else if (isset($rc_validation1['rc_status']) == "" || $rc_validation1['error_code'] != "SPC-200") {
                            // return 'tester';
                            //     $statusCode = 102;
                            //     if($rc_validation1['error_code'] == "SPC-203" && $rc_validation1['message'] != 'Record not found')
                            //    {
                            //     $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                            //     if($user->role_id==1) {
                            //         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            //         $rcvalidation = DB::table('rcvalidation')->insert([
                            //             "user_id"=> $user->id,
                            //             "api_id"=> $api_id,
                            //             "status_code"=> $statusCode,
                            //             "rc_number"=> $rcNumber,
                            //             "created_at"=> Carbon::now(),
                            //             "updated_at"=> Carbon::now(),
                            //             'service_provider'=> $service_provider
                            //         ]);
                            //     }
                            //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                            //     }
                            // else{

                            try {
                                // return 'try';
                                $client = new Client();
                                // $rcnomber = 'MH16AJ1013';
                                $blacklistcheck = 'true';
                                // $headerss = [
                                //     // 'Authorization' => $this->nsdlToken,        
                                //     'secretKey' => 'pI76u95BabjkIFg6DNNRole7gZn71ljPk7W5WIHzApjlObIMywuq8pZGa30HXm5wR',   
                                //     'clientId' => 'ef41c6d7089614d1838c68efc81a8493:dc983c1bfbc4390f4952bd44ed0ae690'
                                // ];

                                // // return 'test the try in try';
                                // $rc_validation = [];
                                // $res = $client->post('https://api.emptra.com/vehicleRegistrationsV3', ['headers' => $headerss, 'form_params'=> ['vehicleNumber'=>$request->rc_number,'blacklistCheck'=>$blacklistcheck]]);
                                // $rc_validation1 = json_decode($res->getBody(), true);


                                // $url = 'https://api.emptra.com/vehicleRegistrationsV3';

                                // $data = array(
                                //     "vehicleNumber" => $request->rc_number,
                                // );

                                // $body = json_encode($data);

                                // $ch = curl_init($url);

                                // curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                                // curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: ".$this->secretKey,"clientId: ".$this->clientId,'Content-Type:application/json'));
                                // curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                                // $get_data1 = curl_exec($ch);
                                // $rc_validation1 = json_decode($get_data1, true);
                                $url = 'https://api.emptra.com/vehicleRegistrationsV2';

                                $data = array(
                                    "vehicleNumber" => $request->rc_number,
                                    "blacklistCheck" => false
                                );

                                $body = json_encode($data);
                                // return $data;

                                $ch = curl_init($url);

                                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                                curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: " . $this->secretKey, "clientId: " . $this->clientId, 'Content-Type:application/json'));
                                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                                $get_data1 = curl_exec($ch);
                                $rc_validation1 = json_decode($get_data1, true);
                                // return $rc_validation1;
                                // return $rc_validation1;


                                // return $rc_validation1['result']['rcExpiryDate'];
                                // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                                // if(isset($rc_validation1['error_code'])){
                                //     $statusCode = 200;
                                // }
                                // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                                // if($grossWeight){
                                //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                                //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                                //     $checkweight = array();
                                //     $checkweight['tag_class'] = $checkWeight->tag_class;
                                // }else{
                                //     $checkweight['tag_class'] = '';
                                // }
                                // if($rc_validation1['result']['rcExpiryDate'] != null && $rc_validation1['result']['rcExpiryDate'] != 'NA'){
                                //     $rc_validation['data']['rc_status'] = '';
                                // }else{
                                //     $rc_validation['data']['rc_status'] = 'ACTIVE';
                                // }

                                // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                                if ($rc_validation1['code'] == "100" || $rc_validation1['code'] == "200") {

                                    // return $rc_validation1['result'];

                                    $insuransespace = "/";
                                    $updatedate = "2023";
                                    $rcinsurance = $rc_validation1['result']['vehicleInsuranceUpto'];
                                    // return $rcinsurance;
                                    $newrcinsurance = (explode("/", $rcinsurance));
                                    // return $newrcinsurance;
                                    // $allinsurance = $newrcinsurance[0].$insuransespace.$newrcinsurance[1].$insuransespace. $updatedate;
                                    if ($rcinsurance != 'NA') {
                                        // return 'tester';
                                        $allinsurance = $newrcinsurance[0] . $insuransespace . $newrcinsurance[1] . $insuransespace . $updatedate;
                                    } else {
                                        $allinsurance = '2023-12-12';
                                    }
                                    // return $allinsurance;

                                    $statusCode = 200;
                                    // $rc_validation['data']['rc_number'] = $rc_validation1['result']['rc_number'];
                                    // $rc_validation['data']['norms_type'] = $rc_validation1['result']['norms_type'];
                                    // $rc_validation['data']['rc_status'] = $rc_validation1['result']['rc_status'];
                                    // $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['result']['vehicle_gross_weight'];
                                    // $rc_validation['data']['unladen_weight'] = $rc_validation1['result']['unladen_weight'];
                                    // $rc_validation['data']['manufacturing_date'] = $rc_validation1['result']['manufacturing_date'];
                                    // $rc_validation['data']['seat_capacity'] = $rc_validation1['result']['seat_capacity'];
                                    // $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['result']['national_permit_issued_by'];
                                    // $rc_validation['data']['national_permit_number'] = $rc_validation1['result']['national_permit_number'];
                                    // $rc_validation['data']['national_permit_upto'] = $rc_validation1['result']['national_permit_upto'];
                                    // $rc_validation['data']['insurance_company'] = $rc_validation1['result']['insurance_company'];
                                    // $rc_validation['data']['insurance_policy_number'] = $rc_validation1['result']['insurance_policy_number'];
                                    // if(isset($rc_validation1['result']['insurance_upto']) && $rc_validation1['result']['insurance_upto'] != null && $rc_validation1['result']['insurance_upto'] != "null" && $rc_validation1['result']['insurance_upto'] != 'NA'){
                                    //     // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                    //     if($newrcinsurance[0] < 2022){
                                    //         $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                    //         // $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $allinsurance)->format('Y-m-d');
                                    //     }else{
                                    //         $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['result']['insurance_upto'])->format('Y-m-d');
                                    //         // $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['insurance_upto'])->format('Y-m-d');
                                    //     }
                                    // }else{
                                    //     $rc_validation['data']['insurance_upto'] = $rc_validation1['result']['insurance_upto'];
                                    // }

                                    // $rc_validation['data']['permit_type'] = $rc_validation1['result']['permit_type'];
                                    // $rc_validation['data']['permit_valid_from'] = $rc_validation1['result']['permit_valid_from'];
                                    // $rc_validation['data']['permit_number'] = $rc_validation1['result']['permit_number'];
                                    // $rc_validation['data']['permit_valid_upto'] = $rc_validation1['result']['permit_valid_upto'];
                                    // $rc_validation['data']['permit_issue_date'] = $rc_validation1['result']['permit_issue_date'];;
                                    // $rc_validation['data']['noc_details'] = $rc_validation1['result']['noc_details'];
                                    // $rc_validation['data']['body_type'] = $rc_validation1['result']['body_type'];
                                    // $rc_validation['data']['father_name'] = $rc_validation1['result']['father_name'];
                                    // $rc_validation['data']['owner_name'] = $rc_validation1['result']['owner_name'];
                                    // $rc_validation['data']['permanent_address'] = $rc_validation1['result']['permanent_address'];
                                    // $rc_validation['data']['present_address'] = $rc_validation1['result']['present_address'];
                                    // $rc_validation['data']['pucc_number'] = $rc_validation1['result']['pucc_number'];
                                    // if(isset($rc_validation1['result']['pucc_upto']) && $rc_validation1['result']['pucc_upto'] != null && $rc_validation1['result']['pucc_upto'] != "null" && $rc_validation1['result']['pucc_upto'] != 'NA'){
                                    //     // return 'testdate';
                                    //     $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['result']['pucc_upto'])->format('Y-m-d');
                                    //     // $rc_validation['data']['pucc_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['pucc_upto'])->format('Y-m-d');
                                    // }else{
                                    //     $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['pucc_upto'];
                                    // }
                                    // $rc_validation['data']['blacklist_status'] = $rc_validation1['result']['blacklist_status'];
                                    // $rc_validation['data']['maker_model'] = $rc_validation1['result']['maker_model'];
                                    // $rc_validation['data']['maker_description'] = $rc_validation1['result']['maker_description'];
                                    // if(isset($rc_validation1['result']['fit_up_to']) && $rc_validation1['result']['fit_up_to'] != null && $rc_validation1['result']['fit_up_to'] != "null" && $rc_validation1['result']['fit_up_to'] != 'NA'){
                                    //     // return 'testdate';
                                    //     $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                    //     // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                    //     // $rc_validation['data']['fit_up_to'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['fit_up_to'])->format('Y-m-d');

                                    // }else{
                                    //     $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['fit_up_to'];;
                                    // }
                                    // $rc_validation['data']['standing_capacity'] = $rc_validation1['result']['standing_capacity'];
                                    // $rc_validation['data']['sleeper_capacity'] = $rc_validation1['result']['sleeper_capacity'];
                                    // $rc_validation['data']['wheelbase'] = $rc_validation1['result']['wheelbase'];
                                    // $rc_validation['data']['vehicle_category_description'] = $rc_validation1['result']['vehicle_category_description'];
                                    // $rc_validation['data']['vehicle_category'] = $rc_validation1['result']['vehicle_category'];
                                    // $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['result']['vehicle_chasi_number'];
                                    // $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['result']['vehicle_engine_number'];
                                    // $rc_validation['data']['mobile_number'] = $rc_validation1['result']['mobile_number'];
                                    // $rc_validation['data']['financer'] = $rc_validation1['result']['financer'];
                                    // // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                                    // // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                                    // $rc_validation['data']['latest_by'] = $rc_validation1['result']['latest_by'];
                                    // $rc_validation['data']['tax_upto'] = $rc_validation1['result']['tax_upto'];
                                    // $rc_validation['data']['message_code'] = 'NA';
                                    // $rc_validation['data']['non_use_to'] = $rc_validation1['result']['non_use_to'];
                                    // $rc_validation['data']['non_use_from'] = $rc_validation1['result']['non_use_from'];
                                    // $rc_validation['data']['non_use_status'] = $rc_validation1['result']['non_use_status'];
                                    // $rc_validation['data']['fuel_type'] = $rc_validation1['result']['fuel_type'];
                                    // $rc_validation['data']['registered_at'] = $rc_validation1['result']['registered_at'];
                                    // if(isset($rc_validation1['result']['registration_date']) && $rc_validation1['result']['registration_date'] != null && $rc_validation1['result']['registration_date'] != "null" && $rc_validation1['result']['registration_date'] != 'NA'){
                                    //     $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['result']['registration_date'])->format('Y-m-d');
                                    //         // $rc_validation['data']['registration_date'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['registration_date'])->format('Y-m-d');
                                    // }else{
                                    //     $rc_validation['data']['registration_date'] = $rc_validation1['result']['registration_date'];
                                    // }

                                    // $rc_validation['data']['color'] = $rc_validation1['result']['color'];
                                    // $rc_validation['data']['owner_number'] = $rc_validation1['result']['owner_number'];
                                    // $rc_validation['data']['no_cylinders'] = $rc_validation1['result']['no_cylinders'];
                                    // $rc_validation['data']['cubic_capacity'] = $rc_validation1['result']['cubic_capacity'];
                                    // $rc_validation['status_code'] = 200;

                                    //********************************emptra V2 start********************************** */
                                    $rc_validation['data']['rc_number'] = $rc_validation1['result']['regNo'];
                                    $rc_validation['data']['norms_type'] = $rc_validation1['result']['normsType'];
                                    $rc_validation['data']['rc_status'] = $rc_validation1['result']['status'];
                                    $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['result']['grossVehicleWeight'];
                                    $rc_validation['data']['unladen_weight'] = $rc_validation1['result']['unladenWeight'];
                                    $rc_validation['data']['manufacturing_date'] = $rc_validation1['result']['vehicleManufacturingMonthYear'];
                                    $rc_validation['data']['seat_capacity'] = $rc_validation1['result']['vehicleSeatCapacity'];
                                    $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['result']['nationalPermitIssuedBy'];
                                    $rc_validation['data']['national_permit_number'] = $rc_validation1['result']['nationalPermitNumber'];
                                    $rc_validation['data']['national_permit_upto'] = $rc_validation1['result']['nationalPermitUpto'];
                                    $rc_validation['data']['insurance_company'] = $rc_validation1['result']['vehicleInsuranceCompanyName'];
                                    $rc_validation['data']['insurance_policy_number'] = $rc_validation1['result']['vehicleInsurancePolicyNumber'];
                                    if (isset($rc_validation1['result']['vehicleInsuranceUpto']) && $rc_validation1['result']['vehicleInsuranceUpto'] != null && $rc_validation1['result']['vehicleInsuranceUpto'] != "null" && $rc_validation1['result']['vehicleInsuranceUpto'] != 'NA') {
                                        // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                        if ($newrcinsurance[2] < 2022) {
                                            // $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                            // return $allinsurance;
                                            $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $allinsurance)->format('Y-m-d');
                                        } else {
                                            // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['result']['vehicleInsuranceUpto'])->format('Y-m-d');
                                            $rc_validation['data']['insurance_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['vehicleInsuranceUpto'])->format('Y-m-d');
                                        }
                                    } else {
                                        $rc_validation['data']['insurance_upto'] = $rc_validation1['result']['vehicleInsuranceUpto'];
                                    }

                                    $rc_validation['data']['permit_type'] = $rc_validation1['result']['permitType'];
                                    $rc_validation['data']['permit_valid_from'] = $rc_validation1['result']['permitValidFrom'];
                                    $rc_validation['data']['permit_number'] = $rc_validation1['result']['permitNumber'];
                                    $rc_validation['data']['permit_valid_upto'] = $rc_validation1['result']['permitValidUpto'];
                                    $rc_validation['data']['permit_issue_date'] = $rc_validation1['result']['permitIssueDate'];
                                    ;
                                    $rc_validation['data']['noc_details'] = $rc_validation1['result']['nocDetails'];
                                    $rc_validation['data']['body_type'] = $rc_validation1['result']['bodyType'];
                                    $rc_validation['data']['father_name'] = $rc_validation1['result']['ownerFatherName'];
                                    $rc_validation['data']['owner_name'] = $rc_validation1['result']['owner'];
                                    $rc_validation['data']['permanent_address'] = $rc_validation1['result']['permanentAddress'];
                                    $rc_validation['data']['present_address'] = $rc_validation1['result']['presentAddress'];
                                    $rc_validation['data']['pucc_number'] = $rc_validation1['result']['puccNumber'];
                                    if (isset($rc_validation1['result']['puccUpto']) && $rc_validation1['result']['puccUpto'] != null && $rc_validation1['result']['puccUpto'] != "null" && $rc_validation1['result']['puccUpto'] != 'NA') {
                                        // return 'testdate';
                                        // $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['result']['puccUpto'])->format('Y-m-d');
                                        $rc_validation['data']['pucc_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['puccUpto'])->format('Y-m-d');
                                    } else {
                                        $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['puccUpto'];
                                    }
                                    $rc_validation['data']['blacklist_status'] = $rc_validation1['result']['blacklistStatus'];
                                    $rc_validation['data']['maker_model'] = $rc_validation1['result']['model'];
                                    $rc_validation['data']['maker_description'] = $rc_validation1['result']['vehicleManufacturerName'];
                                    if (isset($rc_validation1['result']['rcExpiryDate']) && $rc_validation1['result']['rcExpiryDate'] != null && $rc_validation1['result']['rcExpiryDate'] != "null" && $rc_validation1['result']['rcExpiryDate'] != 'NA') {
                                        // return 'testdate';
                                        // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                        // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                        if ($rc_validation1['result']['rcExpiryDate'] != 'NA' || $rc_validation1['result']['rcExpiryDate'] != 'NA/0/undefined') {
                                            // $rc_validation['data']['fit_up_to'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['rcExpiryDate'])->format('Y-m-d');
                                            $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['rcExpiryDate'];
                                        }


                                    } else {
                                        $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['rcExpiryDate'];
                                        ;
                                    }
                                    $rc_validation['data']['standing_capacity'] = $rc_validation1['result']['vehicleStandingCapacity'];
                                    $rc_validation['data']['sleeper_capacity'] = $rc_validation1['result']['vehicleSleeperCapacity'];
                                    $rc_validation['data']['wheelbase'] = $rc_validation1['result']['wheelbase'];
                                    $rc_validation['data']['vehicle_category_description'] = $rc_validation1['result']['vehicleCategory'];
                                    $rc_validation['data']['vehicle_category'] = $rc_validation1['result']['vehicleCategory'];
                                    $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['result']['chassis'];
                                    $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['result']['engine'];
                                    $rc_validation['data']['mobile_number'] = $rc_validation1['result']['mobileNumber'];
                                    $rc_validation['data']['financer'] = $rc_validation1['result']['rcFinancer'];
                                    // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                                    // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                                    $rc_validation['data']['latest_by'] = $rc_validation1['result']['statusAsOn'];
                                    ;
                                    $rc_validation['data']['tax_upto'] = $rc_validation1['result']['vehicleTaxUpto'];
                                    $rc_validation['data']['message_code'] = 'NA';
                                    $rc_validation['data']['non_use_to'] = $rc_validation1['result']['nonUseTo'];
                                    $rc_validation['data']['non_use_from'] = $rc_validation1['result']['nonUseFrom'];
                                    $rc_validation['data']['non_use_status'] = $rc_validation1['result']['nonUseStatus'];
                                    $rc_validation['data']['fuel_type'] = $rc_validation1['result']['type'];
                                    $rc_validation['data']['registered_at'] = $rc_validation1['result']['regAuthority'];
                                    if (isset($rc_validation1['result']['regDate']) && $rc_validation1['result']['regDate'] != null && $rc_validation1['result']['regDate'] != "null" && $rc_validation1['result']['regDate'] != 'NA') {
                                        // $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['result']['registration_date'])->format('Y-m-d');
                                        $rc_validation['data']['registration_date'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['regDate'])->format('Y-m-d');
                                    } else {
                                        $rc_validation['data']['registration_date'] = $rc_validation1['result']['regDate'];
                                    }

                                    $rc_validation['data']['color'] = $rc_validation1['result']['vehicleColour'];
                                    $rc_validation['data']['owner_number'] = $rc_validation1['result']['ownerCount'];
                                    $rc_validation['data']['no_cylinders'] = $rc_validation1['result']['vehicleCylindersNo'];
                                    $rc_validation['data']['cubic_capacity'] = $rc_validation1['result']['vehicleCubicCapacity'];
                                    $rc_validation['status_code'] = 200;
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                        }
                                        // return  $rc_validation['result'];
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            "user_id" => $user->id,
                                            "api_id" => $api_id,
                                            // "client_id"=> $rc_validation['data']['client_id'],
                                            "status_code" => 200,
                                            "rc_number" => $rc_validation1['result']['regNo'],
                                            "rc_status" => $rc_validation1['result']['status'],
                                            "owner_number" => $rc_validation1['result']['ownerCount'],
                                            "tax_upto" => $rc_validation1['result']['vehicleTaxUpto'],
                                            "blacklist_status" => $rc_validation1['result']['blacklistStatus'],
                                            "father_name" => $rc_validation1['result']['ownerFatherName'],
                                            "registration_date" => $rc_validation['data']['registration_date'],
                                            "owner_name" => $rc_validation1['result']['owner'],
                                            "present_address" => $rc_validation1['result']['presentAddress'],
                                            "permanent_address" => $rc_validation1['result']['permanentAddress'],
                                            "mobile_number" => $rc_validation1['result']['mobileNumber'],
                                            "vehicle_category" => $rc_validation1['result']['vehicleCategory'],
                                            "vehicle_chasi_number" => $rc_validation1['result']['chassis'],
                                            "vehicle_engine_number" => $rc_validation1['result']['engine'],
                                            "maker_description" => $rc_validation1['result']['vehicleManufacturerName'],
                                            "maker_model" => $rc_validation1['result']['model'],
                                            "body_type" => $rc_validation1['result']['bodyType'],
                                            "fuel_type" => $rc_validation1['result']['type'],
                                            "color" => $rc_validation1['result']['vehicleColour'],
                                            "norms_type" => $rc_validation1['result']['normsType'],
                                            "fit_up_to" => $rc_validation['data']['fit_up_to'],
                                            "financer" => $rc_validation1['result']['rcFinancer'],
                                            "insurance_company" => $rc_validation1['result']['vehicleInsuranceCompanyName'],
                                            "insurance_policy_number" => $rc_validation1['result']['vehicleInsurancePolicyNumber'],
                                            "insurance_upto" => $rc_validation['data']['insurance_upto'],
                                            "manufacturing_date" => $rc_validation1['result']['vehicleManufacturingMonthYear'],
                                            "registered_at" => $rc_validation1['result']['regAuthority'],
                                            "less_info" => 1,
                                            "cubic_capacity" => $rc_validation1['result']['vehicleCubicCapacity'],
                                            "vehicle_gross_weight" => $rc_validation1['result']['grossVehicleWeight'],
                                            "no_cylinders" => $rc_validation1['result']['vehicleCylindersNo'],
                                            "seat_capacity" => $rc_validation1['result']['vehicleSeatCapacity'],
                                            "sleeper_capacity" => $rc_validation1['result']['vehicleSleeperCapacity'],
                                            "standing_capacity" => $rc_validation1['result']['vehicleStandingCapacity'],
                                            "wheelbase" => $rc_validation1['result']['wheelbase'],
                                            "unladen_weight" => $rc_validation1['result']['unladenWeight'],
                                            "vehicle_category_description" => $rc_validation1['result']['vehicleCategory'],
                                            "pucc_number" => $rc_validation1['result']['puccNumber'],
                                            "pucc_upto" => $rc_validation['data']['pucc_upto'],
                                            'hit_month' => date('Y-m'),
                                            'national_permit_issued_by' => $rc_validation1['result']['nationalPermitIssuedBy'],
                                            'national_permit_number' => $rc_validation1['result']['nationalPermitNumber'],
                                            'national_permit_upto' => $rc_validation1['result']['nationalPermitUpto'],
                                            'permit_type' => $rc_validation1['result']['permitType'],
                                            'permit_valid_from' => $rc_validation1['result']['permitValidFrom'],
                                            'permit_number' => $rc_validation1['result']['permitNumber'],
                                            'permit_valid_upto' => $rc_validation1['result']['permitValidUpto'],
                                            'permit_issue_date' => $rc_validation1['result']['permitIssueDate'],
                                            'noc_details' => $rc_validation1['result']['nocDetails'],
                                            'latest_by' => $rc_validation1['result']['statusAsOn'],
                                            'message_code' => 'NA',
                                            'non_use_to' => $rc_validation1['result']['nonUseTo'],
                                            'non_use_from' => $rc_validation1['result']['nonUseFrom'],
                                            'non_use_status' => $rc_validation1['result']['nonUseStatus'],
                                            // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                            "created_at" => Carbon::now(),
                                            "updated_at" => Carbon::now(),
                                            'service_provider' => 'emptraV2'
                                        ]);
                                    }
                                } else if ($rc_validation1['code'] == "200" || $rc_validation1['code'] == "103") {
                                    $statusCode = 102;
                                    $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 102);
                                        }
                                        // $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            "user_id" => $user->id,
                                            "api_id" => $api_id,
                                            "status_code" => $statusCode,
                                            "rc_number" => $rcNumber,
                                            "created_at" => Carbon::now(),
                                            "updated_at" => Carbon::now(),
                                            'service_provider' => 'emptraV2'
                                        ]);
                                    }
                                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                } else if ($rc_validation1['code'] == "400") {
                                    $statusCode = 102;
                                    $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                    if ($user->role_id == 1) {
                                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            "user_id" => $user->id,
                                            "api_id" => $api_id,
                                            "status_code" => $statusCode,
                                            "rc_number" => $rcNumber,
                                            "created_at" => Carbon::now(),
                                            "updated_at" => Carbon::now(),
                                            'service_provider' => 'emptraV2'
                                        ]);
                                    }
                                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                } else {
                                    // if(isset($rc_validation['message']) && $rc_validation['message'] != 'success')
                                    if ($rc_validation1['code'] != '100') {
                                        if ($rc_validation1['code'] == 404 || $rc_validation1['code'] == 502 || $rc_validation1['code'] == 500) {
                                            // $statusCode = 101;
                                            // $errorMessage = 'RC Number in Multiple RTOs.';
                                            // }else if($rc_validation['reponseCode'] == 502){
                                            $statusCode = 102;
                                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                        } else if ($rc_validation1['code'] == '104') {
                                            $statusCode = 500;
                                            $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                        } else {
                                            $statusCode = 404;
                                            $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                        }
                                        if ($user->role_id == 1) {
                                            if ($apiamster) {
                                                // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                            }
                                            $rcvalidation = DB::table('rcvalidation')->insert([
                                                "user_id" => $user->id,
                                                "api_id" => $api_id,
                                                "status_code" => $statusCode,
                                                "rc_number" => $rcNumber,
                                                "created_at" => Carbon::now(),
                                                "updated_at" => Carbon::now(),
                                                'service_provider' => 'emptraV2'
                                            ]);
                                        }
                                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                    }
                                }
                            } catch (\GuzzleHttp\Exception\RequestException $e) {
                                $response = $e->getResponse();
                                $status = json_decode((string) $response->getBody());
                                $statusCode = $e->getResponse()->getStatusCode();
                                if ($statusCode == 500 || $statusCode == 401) {
                                    $statusCode = 102;
                                    $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                    // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                    if ($user->role_id == 1) {
                                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                    }
                                } else if ($statusCode == 403) {
                                    if ($status->message_code == 'multiple_rto') {
                                        $statusCode = 101;
                                        $errorMessage = 'RC Number in Multiple RTOs.';
                                    } else {
                                        $statusCode = 102;
                                        $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                    }
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                        }
                                    }
                                } else {
                                    $statusCode = 500;
                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                        }
                                    }
                                }
                                if ($user->role_id == 1) {
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        "status_code" => $statusCode,
                                        "rc_number" => $rcNumber,
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),
                                        'service_provider' => 'emptraV2'
                                    ]);
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            }
                            // }
                        } else {
                            if (isset($rc_validation['message']) && $rc_validation['message'] != 'success') {
                                if ($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500) {
                                    // $statusCode = 101;
                                    // $errorMessage = 'RC Number in Multiple RTOs.';
                                    // }else if($rc_validation['reponseCode'] == 502){
                                    $statusCode = 102;
                                    $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                } else if ($rc_validation['error_code'] == 'SPC-201') {
                                    $statusCode = 500;
                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                } else {
                                    $statusCode = 404;
                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                }
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        "status_code" => $statusCode,
                                        "rc_number" => $rcNumber,
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),
                                        'service_provider' => $service_provider
                                    ]);
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            }
                        }
                    } catch (\GuzzleHttp\Exception\RequestException $e) {
                        $response = $e->getResponse();
                        $status = json_decode((string) $response->getBody());
                        $statusCode = $e->getResponse()->getStatusCode();
                        if ($statusCode == 500 || $statusCode == 401) {
                            $statusCode = 102;
                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                            // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 403) {
                            if ($status->message_code == 'multiple_rto') {
                                $statusCode = 101;
                                $errorMessage = 'RC Number in Multiple RTOs.';
                            } else {
                                $statusCode = 102;
                                $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                            }
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $statusCode = 500;
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        if ($user->role_id == 1) {
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "status_code" => $statusCode,
                                "rc_number" => $rcNumber,
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now(),
                                'service_provider' => $service_provider
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 102, 'message' => 'Invalid RC Number / RC Number in Multiple RTOs..']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
    }

    // RC verification
    public function rc_validation(Request $request)
    {
        //return 'test';
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $service_provider = "softpay";

        if (empty($request->rc_number))
            return response()->json(array(['statusCode' => '404', 'message' => 'RC number is required']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['statusCode' => '404', 'message' => 'Header Access Token is required']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rc')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return 'false';
                $rcNumber = str_replace('-', '', $request->rc_number);
                $subString = strtoupper(substr($rcNumber, 0, 2));

                if ($subString == "AP" || $subString == "AR" || $subString == "AS" || $subString == "BR" || $subString == "CG" || $subString == "GA" || $subString == "GJ" || $subString == "HR" || $subString == "HP" || $subString == "JH" || $subString == "KA" || $subString == "KL" || $subString == "MP" || $subString == "MH" || $subString == "MN" || $subString == "ML" || $subString == "MZ" || $subString == "NL" || $subString == "OD" || $subString == "PB" || $subString == "RJ" || $subString == "SK" || $subString == "TN" || $subString == "TR" || $subString == "UP" || $subString == "UK" || $subString == "UA" || $subString == "WB" || $subString == "TS" || $subString == "AN" || $subString == "CH" || $subString == "DN" || $subString == "DD" || $subString == "JK" || $subString == "LA" || $subString == "LD" || $subString == "DL" || $subString == "PY") {
                    // return 'true';
                    $currentMonth = date('Y-m');
                    $rcdata = DB::table('rcvalidation')->where('rc_number', $rcNumber)->where('hit_month', $currentMonth)->where('status_code', '200')->orderby('id', 'DESC')->first();
                    // return $rcdata; 
                    $databasedata = 0;
                    if ($databasedata == 1) {
                        // return 'ok not test';

                        $insuransespace = "-";
                        $updatedate = "2023";
                        $rcinsurance = $rcdata->insurance_upto;
                        $newrcinsurance = (explode("-", $rcinsurance));
                        $allinsurance = $updatedate . $insuransespace . $newrcinsurance[1] . $insuransespace . $newrcinsurance[2];

                        $statusCode = 200;
                        $rc_validation['data']['rc_number'] = $rcdata->rc_number;
                        $rc_validation['data']['norms_type'] = $rcdata->norms_type;
                        $rc_validation['data']['rc_status'] = $rcdata->rc_status;
                        $rc_validation['data']['vehicle_gross_weight'] = $rcdata->vehicle_gross_weight;
                        $rc_validation['data']['unladen_weight'] = $rcdata->unladen_weight;
                        $rc_validation['data']['manufacturing_date'] = $rcdata->manufacturing_date;
                        $rc_validation['data']['seat_capacity'] = $rcdata->seat_capacity;
                        $rc_validation['data']['national_permit_issued_by'] = $rcdata->national_permit_issued_by;
                        $rc_validation['data']['national_permit_number'] = $rcdata->national_permit_number;
                        $rc_validation['data']['national_permit_upto'] = $rcdata->national_permit_upto;
                        $rc_validation['data']['insurance_company'] = $rcdata->insurance_company;
                        $rc_validation['data']['insurance_policy_number'] = $rcdata->insurance_policy_number;
                        // $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                        if ($newrcinsurance[0] < 2022) {
                            $rc_validation['data']['insurance_upto'] = $allinsurance;
                        } else {
                            $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                        }
                        $rc_validation['data']['permit_type'] = $rcdata->permit_type;
                        $rc_validation['data']['permit_valid_from'] = $rcdata->permit_valid_from;
                        $rc_validation['data']['permit_number'] = $rcdata->permit_number;
                        $rc_validation['data']['permit_valid_upto'] = $rcdata->permit_valid_upto;
                        $rc_validation['data']['permit_issue_date'] = $rcdata->permit_issue_date;
                        $rc_validation['data']['noc_details'] = $rcdata->noc_details;
                        $rc_validation['data']['body_type'] = $rcdata->body_type;
                        $rc_validation['data']['father_name'] = $rcdata->father_name;
                        $rc_validation['data']['owner_name'] = $rcdata->owner_name;
                        $rc_validation['data']['permanent_address'] = $rcdata->permanent_address;
                        $rc_validation['data']['present_address'] = $rcdata->present_address;
                        $rc_validation['data']['pucc_number'] = $rcdata->pucc_number;
                        $rc_validation['data']['pucc_upto'] = $rcdata->pucc_upto;
                        $rc_validation['data']['blacklist_status'] = $rcdata->blacklist_status;
                        $rc_validation['data']['maker_model'] = $rcdata->maker_model;
                        $rc_validation['data']['maker_description'] = $rcdata->maker_description;
                        $rc_validation['data']['fit_up_to'] = $rcdata->fit_up_to;
                        $rc_validation['data']['standing_capacity'] = $rcdata->standing_capacity;
                        $rc_validation['data']['sleeper_capacity'] = $rcdata->sleeper_capacity;
                        $rc_validation['data']['wheelbase'] = $rcdata->wheelbase;
                        $rc_validation['data']['vehicle_category_description'] = $rcdata->vehicle_category_description;
                        $rc_validation['data']['vehicle_category'] = $rcdata->vehicle_category;
                        $rc_validation['data']['vehicle_chasi_number'] = $rcdata->vehicle_chasi_number;
                        $rc_validation['data']['vehicle_engine_number'] = $rcdata->vehicle_engine_number;
                        $rc_validation['data']['mobile_number'] = $rcdata->mobile_number;
                        $rc_validation['data']['financer'] = $rcdata->financer;
                        // $rc_validation['data']['rc_number'] = $rcdata->['code'];
                        // $rc_validation['data']['rc_number'] = $rcdata->['stateCd'];
                        $rc_validation['data']['latest_by'] = $rcdata->latest_by;
                        $rc_validation['data']['tax_upto'] = $rcdata->tax_upto;
                        $rc_validation['data']['message_code'] = $rcdata->message_code;
                        $rc_validation['data']['non_use_to'] = $rcdata->non_use_to;
                        $rc_validation['data']['non_use_from'] = $rcdata->non_use_from;
                        $rc_validation['data']['non_use_status'] = $rcdata->non_use_status;
                        $rc_validation['data']['fuel_type'] = $rcdata->fuel_type;
                        $rc_validation['data']['registered_at'] = $rcdata->registered_at;
                        $rc_validation['data']['registration_date'] = $rcdata->registration_date;
                        $rc_validation['data']['color'] = $rcdata->color;
                        $rc_validation['data']['owner_number'] = $rcdata->owner_number;
                        $rc_validation['data']['no_cylinders'] = $rcdata->no_cylinders;
                        $rc_validation['data']['cubic_capacity'] = $rcdata->cubic_capacity;
                        $rc_validation['status_code'] = 200;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                // "client_id"=> $rc_validation['data']['client_id'],
                                "status_code" => 200,
                                "rc_number" => $rcdata->rc_number,
                                "rc_status" => $rcdata->rc_status,
                                "owner_number" => $rcdata->owner_number,
                                "tax_upto" => $rcdata->tax_upto,
                                "blacklist_status" => $rcdata->blacklist_status,
                                "father_name" => $rcdata->father_name,
                                "registration_date" => $rcdata->registration_date,
                                "owner_name" => $rcdata->owner_name,
                                "present_address" => $rcdata->present_address,
                                "permanent_address" => $rcdata->permanent_address,
                                "mobile_number" => $rcdata->mobile_number,
                                "vehicle_category" => $rcdata->vehicle_category,
                                "vehicle_chasi_number" => $rcdata->vehicle_chasi_number,
                                "vehicle_engine_number" => $rcdata->vehicle_engine_number,
                                "maker_description" => $rcdata->maker_description,
                                "maker_model" => $rcdata->maker_model,
                                "body_type" => $rcdata->body_type,
                                "fuel_type" => $rcdata->fuel_type,
                                "color" => $rcdata->color,
                                "norms_type" => $rcdata->norms_type,
                                "fit_up_to" => $rcdata->fit_up_to,
                                "financer" => $rcdata->financer,
                                "insurance_company" => $rcdata->insurance_company,
                                "insurance_policy_number" => $rcdata->insurance_policy_number,
                                "insurance_upto" => $rcdata->insurance_upto,
                                "manufacturing_date" => $rcdata->manufacturing_date,
                                "registered_at" => $rcdata->registered_at,
                                "less_info" => 1,
                                "cubic_capacity" => $rcdata->cubic_capacity,
                                "vehicle_gross_weight" => $rcdata->vehicle_gross_weight,
                                "no_cylinders" => $rcdata->no_cylinders,
                                "seat_capacity" => $rcdata->seat_capacity,
                                "sleeper_capacity" => $rcdata->sleeper_capacity,
                                "standing_capacity" => $rcdata->standing_capacity,
                                "wheelbase" => $rcdata->wheelbase,
                                "unladen_weight" => $rcdata->unladen_weight,
                                "vehicle_category_description" => $rcdata->vehicle_category_description,
                                "pucc_number" => $rcdata->pucc_number,
                                "pucc_upto" => $rcdata->pucc_upto,
                                'hit_month' => date('Y-m'),
                                'national_permit_issued_by' => $rcdata->national_permit_issued_by,
                                'national_permit_number' => $rcdata->national_permit_number,
                                'national_permit_upto' => $rcdata->national_permit_upto,
                                'permit_type' => $rcdata->permit_type,
                                'permit_valid_from' => $rcdata->permit_valid_from,
                                'permit_number' => $rcdata->permit_number,
                                'permit_valid_upto' => $rcdata->permit_valid_upto,
                                'permit_issue_date' => $rcdata->permit_issue_date,
                                'noc_details' => $rcdata->noc_details,
                                'latest_by' => $rcdata->latest_by,
                                'message_code' => $rcdata->message_code,
                                'non_use_to' => $rcdata->non_use_to,
                                'non_use_from' => $rcdata->non_use_from,
                                'non_use_status' => $rcdata->non_use_status,
                                // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now(),
                                'service_provider' => $service_provider
                            ]);
                        }
                    } else {
                        // return 'ok test';
                        try {
                            $rc_validation = [];
                            // $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number='.$rcNumber, ['headers' => $headers]);
                            $res = $client->get('http://65.0.111.105:8080/vhc_no/' . $rcNumber);
                            $rc_validation1 = json_decode($res->getBody(), true);
                            // return $rc_validation1;

                            // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                            // if(isset($rc_validation1['error_code'])){
                            //     $statusCode = 200;
                            // }
                            // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                            // if($grossWeight){
                            //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                            //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                            //     $checkweight = array();
                            //     $checkweight['tag_class'] = $checkWeight->tag_class;
                            // }else{
                            //     $checkweight['tag_class'] = '';
                            // }
                            // if($rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA' && Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->isPast() == true){
                            //     $rc_validation['data']['rc_status'] = '';
                            // }else{
                            //     $rc_validation['data']['rc_status'] = 'ACTIVE';
                            // }

                            // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                            if (isset($rc_validation1['regn_no'])) {
                                // return $rc_validation1['vTHypthEntity']['fncr_name'];
                                // $insuransespace = "-";
                                // $updatedate = "2023";
                                // $rcinsurance = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                                // $newrcinsurance =  (explode("-",$rcinsurance));
                                // $allinsurance = $newrcinsurance[0].$insuransespace.$newrcinsurance[1].$insuransespace. $updatedate;

                                $statusCode = 200;
                                $rc_validation['data']['rc_number'] = $rc_validation1['regn_no'];
                                $rc_validation['data']['norms_type'] = $rc_validation1['rc_norms_desc'];
                                // $rc_validation['data']['rc_status'] = $rc_validation1['vehicleDetails']['rcStatus'];
                                $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['unld_wt'];
                                $rc_validation['data']['unladen_weight'] = $rc_validation1['unld_wt'];
                                $rc_validation['data']['manufacturing_date'] = $rc_validation1['purchase_dt'];
                                $rc_validation['data']['seat_capacity'] = $rc_validation1['seat_cap'];
                                $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['rc_permit_issue_dt'];
                                $rc_validation['data']['national_permit_number'] = $rc_validation1['rc_permit_no'];
                                $rc_validation['data']['national_permit_upto'] = $rc_validation1['rc_permit_valid_upto'];
                                $rc_validation['data']['insurance_company'] = $rc_validation1['rc_insurance_comp'];
                                $rc_validation['data']['insurance_policy_number'] = $rc_validation1['rc_insurance_policy_no'];
                                if (isset($rc_validation1['rc_insurance_upto']) && $rc_validation1['rc_insurance_upto'] != null && $rc_validation1['rc_insurance_upto'] != "null" && $rc_validation1['rc_insurance_upto'] != 'NA') {
                                    // $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                    // if($newrcinsurance[2] < 2022){
                                    //     $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                    // }else{
                                    $rc_validation['data']['insurance_upto'] = $rc_validation1['rc_insurance_upto'];
                                    // }
                                } else {
                                    $rc_validation['data']['insurance_upto'] = $rc_validation1['rc_insurance_upto'];
                                }

                                $rc_validation['data']['permit_type'] = $rc_validation1['rc_permit_type'];
                                $rc_validation['data']['permit_valid_from'] = $rc_validation1['rc_permit_valid_from'];
                                $rc_validation['data']['permit_number'] = $rc_validation1['rc_permit_no'];
                                $rc_validation['data']['permit_valid_upto'] = $rc_validation1['rc_permit_valid_upto'];
                                $rc_validation['data']['permit_issue_date'] = $rc_validation1['rc_permit_issue_dt'];
                                $rc_validation['data']['noc_details'] = $rc_validation1['rc_noc_details'];
                                $rc_validation['data']['body_type'] = $rc_validation1['body_type'];
                                $rc_validation['data']['father_name'] = $rc_validation1['f_name'];
                                $rc_validation['data']['owner_name'] = $rc_validation1['owner_name'];
                                $rc_validation['data']['permanent_address'] = $rc_validation1['p_add1'];
                                $rc_validation['data']['present_address'] = $rc_validation1['c_add1'];
                                $rc_validation['data']['pucc_number'] = $rc_validation1['vtpucc']['pucc_no'];
                                if (isset($rc_validation1['vtpucc']['pucc_upto']) && $rc_validation1['vtpucc']['pucc_upto'] != null && $rc_validation1['vtpucc']['pucc_upto'] != "null" && $rc_validation1['vtpucc']['pucc_upto'] != 'NA') {
                                    // $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vtpucc']['pucc_upto'])->format('Y-m-d');
                                    $rc_validation['data']['pucc_upto'] = $rc_validation1['vtpucc']['pucc_upto'];
                                } else {
                                    $rc_validation['data']['pucc_upto'] = $rc_validation1['vtpucc']['pucc_upto'];
                                }
                                $rc_validation['data']['blacklist_status'] = $rc_validation1['rc_blacklist_status'];
                                $rc_validation['data']['maker_model'] = $rc_validation1['maker_name'];
                                $rc_validation['data']['maker_description'] = $rc_validation1['model_name'];
                                if (isset($rc_validation1['fit_upto']) && $rc_validation1['fit_upto'] != null && $rc_validation1['fit_upto'] != "null" && $rc_validation1['fit_upto'] != 'NA') {
                                    // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->format('Y-m-d');
                                    $rc_validation['data']['fit_up_to'] = $rc_validation1['fit_upto'];
                                } else {
                                    $rc_validation['data']['fit_up_to'] = $rc_validation1['fit_upto'];
                                }
                                $rc_validation['data']['standing_capacity'] = $rc_validation1['stand_cap'];
                                $rc_validation['data']['sleeper_capacity'] = $rc_validation1['sleeper_cap'];
                                $rc_validation['data']['wheelbase'] = $rc_validation1['wheelbase'];
                                $rc_validation['data']['vehicle_category_description'] = $rc_validation1['vch_catg'];
                                $rc_validation['data']['vehicle_category'] = $rc_validation1['vch_catg_desc'];
                                $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['chasi_no'];
                                $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['eng_no'];
                                $rc_validation['data']['mobile_number'] = $rc_validation1['mobile_no'];
                                $rc_validation['data']['financer'] = $rc_validation1['vTHypthEntity']['fncr_name'];
                                // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                                // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                                $rc_validation['data']['latest_by'] = $rc_validation1['rc_status_as_on'];
                                $rc_validation['data']['tax_upto'] = $rc_validation1['latesttaxdetails']['tax_upto'];
                                $rc_validation['data']['message_code'] = $rc_validation1['stand_cap'];
                                $rc_validation['data']['non_use_to'] = $rc_validation1['rc_non_use_to'];
                                $rc_validation['data']['non_use_from'] = $rc_validation1['rc_non_use_from'];
                                $rc_validation['data']['non_use_status'] = $rc_validation1['rc_non_use_status'];
                                $rc_validation['data']['fuel_type'] = $rc_validation1['fuel_descr'];
                                $rc_validation['data']['registered_at'] = $rc_validation1['rc_registered_at'];
                                if (isset($rc_validation1['rc_regn_dt']) && $rc_validation1['rc_regn_dt'] != null && $rc_validation1['rc_regn_dt'] != "null" && $rc_validation1['rc_regn_dt'] != 'NA') {
                                    // $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['vehicleDetails']['rcRegnDt'])->format('Y-m-d');
                                    $rc_validation['data']['registration_date'] = $rc_validation1['rc_regn_dt'];
                                } else {
                                    $rc_validation['data']['registration_date'] = $rc_validation1['rc_regn_dt'];
                                }

                                $rc_validation['data']['color'] = $rc_validation1['color'];
                                $rc_validation['data']['owner_number'] = $rc_validation1['owner_sr'];
                                $rc_validation['data']['no_cylinders'] = $rc_validation1['no_cyl'];
                                $rc_validation['data']['cubic_capacity'] = $rc_validation1['cubic_cap'];
                                $rc_validation['status_code'] = 200;
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                    }
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        // "client_id"=> $rc_validation['data']['client_id'],
                                        "status_code" => 200,
                                        "rc_number" => $rc_validation1['vehicleDetails']['vehicleNumber'],
                                        "rc_status" => $rc_validation1['vehicleDetails']['rcStatus'],
                                        "owner_number" => $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'],
                                        "tax_upto" => $rc_validation1['vehicleDetails']['rcTaxUpto'],
                                        "blacklist_status" => $rc_validation1['vehicleDetails']['rcBlacklistStatus'],
                                        "father_name" => $rc_validation1['vehicleDetails']['rcFName'],
                                        "registration_date" => $rc_validation['data']['registration_date'],
                                        "owner_name" => $rc_validation1['vehicleDetails']['rcOwnerName'],
                                        "present_address" => $rc_validation1['vehicleDetails']['rcPresentAddress'],
                                        "permanent_address" => $rc_validation1['vehicleDetails']['rcPermanentAddress'],
                                        "mobile_number" => $rc_validation1['vehicleDetails']['rcMobileNo'],
                                        "vehicle_category" => $rc_validation1['vehicleDetails']['rcVchCatg'],
                                        "vehicle_chasi_number" => $rc_validation1['vehicleDetails']['rcChasiNo'],
                                        "vehicle_engine_number" => $rc_validation1['vehicleDetails']['rcEngNo'],
                                        "maker_description" => $rc_validation1['vehicleDetails']['rcMakerDesc'],
                                        "maker_model" => $rc_validation1['vehicleDetails']['rcMakerModel'],
                                        "body_type" => $rc_validation1['vehicleDetails']['rcBodyTypeDesc'],
                                        "fuel_type" => $rc_validation1['vehicleDetails']['rcFuelDesc'],
                                        "color" => $rc_validation1['vehicleDetails']['rcColor'],
                                        "norms_type" => $rc_validation1['vehicleDetails']['rcNormsDesc'],
                                        "fit_up_to" => $rc_validation['data']['fit_up_to'],
                                        "financer" => $rc_validation1['vehicleDetails']['rcFinancer'],
                                        "insurance_company" => $rc_validation1['vehicleDetails']['rcInsuranceComp'],
                                        "insurance_policy_number" => $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'],
                                        "insurance_upto" => $rc_validation['data']['insurance_upto'],
                                        "manufacturing_date" => $rc_validation1['vehicleDetails']['rcManuMonthYr'],
                                        "registered_at" => $rc_validation1['vehicleDetails']['rcRegisteredAt'],
                                        "less_info" => 1,
                                        "cubic_capacity" => $rc_validation1['vehicleDetails']['rcCubicCap'],
                                        "vehicle_gross_weight" => $rc_validation1['vehicleDetails']['rcGvw'],
                                        "no_cylinders" => $rc_validation1['vehicleDetails']['rcNoCyl'],
                                        "seat_capacity" => $rc_validation1['vehicleDetails']['rcSeatCap'],
                                        "sleeper_capacity" => $rc_validation1['vehicleDetails']['rcSleeperCap'],
                                        "standing_capacity" => $rc_validation1['vehicleDetails']['rcStandCap'],
                                        "wheelbase" => $rc_validation1['vehicleDetails']['rcWheelbase'],
                                        "unladen_weight" => $rc_validation1['vehicleDetails']['rcUnldWt'],
                                        "vehicle_category_description" => $rc_validation1['vehicleDetails']['rcVhClassDesc'],
                                        "pucc_number" => $rc_validation1['vehicleDetails']['rcPuccNo'],
                                        "pucc_upto" => $rc_validation['data']['pucc_upto'],
                                        'hit_month' => date('Y-m'),
                                        'national_permit_issued_by' => $rc_validation1['vehicleDetails']['rcNpIssuedBy'],
                                        'national_permit_number' => $rc_validation1['vehicleDetails']['rcNpNo'],
                                        'national_permit_upto' => $rc_validation1['vehicleDetails']['rcNpUpto'],
                                        'permit_type' => $rc_validation1['vehicleDetails']['rcPermitType'],
                                        'permit_valid_from' => $rc_validation1['vehicleDetails']['rcPermitValidFrom'],
                                        'permit_number' => $rc_validation1['vehicleDetails']['rcPermitNo'],
                                        'permit_valid_upto' => $rc_validation1['vehicleDetails']['rcPermitValidUpto'],
                                        'permit_issue_date' => $rc_validation1['vehicleDetails']['rcPermitIssueDt'],
                                        'noc_details' => $rc_validation1['vehicleDetails']['rcNocDetails'],
                                        'latest_by' => $rc_validation1['vehicleDetails']['rcStatusAsOn'],
                                        'message_code' => $rc_validation1['vehicleDetails']['stautsmessage'],
                                        'non_use_to' => $rc_validation1['vehicleDetails']['rcNonUseTo'],
                                        'non_use_from' => $rc_validation1['vehicleDetails']['rcNonUseFrom'],
                                        'non_use_status' => $rc_validation1['vehicleDetails']['rcNonUseStatus'],
                                        // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),
                                        'service_provider' => $service_provider
                                    ]);
                                }
                            }
                            // else 
                            // if($rc_validation1['error_code'] == "SPC-201")
                            // {
                            //     $statusCode = 500;
                            //     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            //     if($user->role_id==1) {
                            //         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            //         $rcvalidation = DB::table('rcvalidation')->insert([
                            //             "user_id"=> $user->id,
                            //             "api_id"=> $api_id,
                            //             "status_code"=> $statusCode,
                            //             "rc_number"=> $rcNumber,
                            //             "created_at"=> Carbon::now(),
                            //             "updated_at"=> Carbon::now(),
                            //             'service_provider'=> $service_provider
                            //         ]);
                            //     }
                            //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                            // }
                            else {
                                // if($rc_validation1['error_code'] == "SPC-203"){
                                $statusCode = 102;
                                $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        "status_code" => $statusCode,
                                        "rc_number" => $rcNumber,
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),
                                        'service_provider' => $service_provider
                                    ]);
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            }
                            // else{
                            //     if(isset($rc_validation['message']) && $rc_validation['message'] != 'success'){
                            //         if($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500){
                            //             // $statusCode = 101;
                            //             // $errorMessage = 'RC Number in Multiple RTOs.';
                            //         // }else if($rc_validation['reponseCode'] == 502){
                            //             $statusCode = 102;
                            //             $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                            //         }else if($rc_validation['error_code'] == 'SPC-201'){
                            //             $statusCode = 500;
                            //             $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                            //         }else{
                            //             $statusCode = 404;
                            //             $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                            //         }
                            //         if($user->role_id==1) {
                            //             if($apiamster) {
                            //                 // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            //             }
                            //             $rcvalidation = DB::table('rcvalidation')->insert([
                            //                 "user_id"=> $user->id,
                            //                 "api_id"=> $api_id,
                            //                 "status_code"=> $statusCode,
                            //                 "rc_number"=> $rcNumber,
                            //                 "created_at"=> Carbon::now(),
                            //                 "updated_at"=> Carbon::now(),
                            //                 'service_provider'=> $service_provider
                            //             ]);
                            //         }
                            //         return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                            //     }
                            // }
                        } catch (\GuzzleHttp\Exception\RequestException $e) {
                            $response = $e->getResponse();
                            $status = json_decode((string) $response->getBody());
                            $statusCode = $e->getResponse()->getStatusCode();
                            if ($statusCode == 500 || $statusCode == 401) {
                                $statusCode = 102;
                                $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                            } else if ($statusCode == 403) {
                                if ($status->message_code == 'multiple_rto') {
                                    $statusCode = 101;
                                    $errorMessage = 'RC Number in Multiple RTOs.';
                                } else {
                                    $statusCode = 102;
                                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                }
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            } else {
                                $statusCode = 500;
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            }
                            if ($user->role_id == 1) {
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    "status_code" => $statusCode,
                                    "rc_number" => $rcNumber,
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),
                                    'service_provider' => $service_provider
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }
                } else {
                    return response()->json(['statusCode' => 102, 'message' => 'Verification Failed. Please enter correct State Code.']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
    }

    public function rc_validation_chessi(Request $request)
    {
        // return 'test chessi';
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $service_provider = "softpay";

        if (empty($request->rc_number))
            return response()->json(array(['statusCode' => '404', 'message' => 'RC number is required']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['statusCode' => '404', 'message' => 'Header Access Token is required']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // if($user->role_id==1) {
        $apiamster = ApiMaster::where('api_slug', 'rcshort')->first();
        if ($apiamster)
            $api_id = $apiamster->id;
        // }

        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return 'false';
                $rcNumber = str_replace('-', '', $request->rc_number);
                $subString = strtoupper(substr($rcNumber, 0, 2));

                if ($subString == "AP" || $subString == "AR" || $subString == "AS" || $subString == "BR" || $subString == "CG" || $subString == "GA" || $subString == "GJ" || $subString == "HR" || $subString == "HP" || $subString == "JH" || $subString == "KA" || $subString == "KL" || $subString == "MP" || $subString == "MH" || $subString == "MN" || $subString == "ML" || $subString == "MZ" || $subString == "NL" || $subString == "OD" || $subString == "PB" || $subString == "RJ" || $subString == "SK" || $subString == "TN" || $subString == "TR" || $subString == "UP" || $subString == "UK" || $subString == "UA" || $subString == "WB" || $subString == "TS" || $subString == "AN" || $subString == "CH" || $subString == "DN" || $subString == "DD" || $subString == "JK" || $subString == "LA" || $subString == "LD" || $subString == "DL" || $subString == "PY") {
                    // return 'true';
                    $currentMonth = date('Y-m');
                    $rcdata = DB::table('rcvalidation')->where('rc_number', $rcNumber)->where('hit_month', $currentMonth)->where('status_code', '200')->orderby('id', 'DESC')->first();
                    // return $rcdata; 
                    if (!empty($rcdata) && ($rcdata->rc_status != '' || $rcdata->rc_status != null)) {
                        // return 'ok not test';

                        $insuransespace = "-";
                        $updatedate = "2023";
                        $rcinsurance = isset($rcdata->insurance_upto) ? $rcdata->insurance_upto : null;
                        $newrcinsurance = (explode("-", $rcinsurance));
                        //  $allinsurance = $updatedate.$insuransespace.$newrcinsurance[1].$insuransespace. $newrcinsurance[2];

                        $statusCode = 200;
                        $rc_validation['data']['rc_number'] = $rcdata->rc_number;

                        $rc_validation['data']['vehicle_chasi_number'] = $rcdata->vehicle_chasi_number;
                        $rc_validation['data']['vehicle_engine_number'] = $rcdata->vehicle_engine_number;

                        // if($user->role_id==1) {
                        // if($apiamster) {
                        //     $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        // }
                        $rcvalidation = DB::table('rcshort_updated')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $rc_validation['data']['client_id'],
                            "rc_number" => $rcdata->rc_number,
                            "vehicle_chasi_number" => $rcdata->vehicle_chasi_number,
                            "vehicle_engine_number" => $rcdata->vehicle_engine_number,
                            // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now(),
                            // 'service_provider'=> $service_provider
                        ]);
                        // }
                    } else {
                        // return 'ok test';
                        try {
                            $rc_validation = [];
                            $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number=' . $rcNumber, ['headers' => $headers]);
                            $rc_validation1 = json_decode($res->getBody(), true);
                            // return $rc_validation1;

                            // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                            // if(isset($rc_validation1['error_code'])){
                            //     $statusCode = 200;
                            // }
                            // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                            // if($grossWeight){
                            //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                            //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                            //     $checkweight = array();
                            //     $checkweight['tag_class'] = $checkWeight->tag_class;
                            // }else{
                            //     $checkweight['tag_class'] = '';
                            // }
                            if ($rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA' && Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->isPast() == true) {
                                $rc_validation['data']['rc_status'] = '';
                            } else {
                                $rc_validation['data']['rc_status'] = 'ACTIVE';
                            }

                            // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                            if ($rc_validation1['error_code'] == "SPC-200") {
                                $insuransespace = "-";
                                $updatedate = "2023";
                                $rcinsurance = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                                $newrcinsurance = (explode("-", $rcinsurance));
                                $allinsurance = $newrcinsurance[0] . $insuransespace . $newrcinsurance[1] . $insuransespace . $updatedate;

                                $statusCode = 200;
                                $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['vehicleNumber'];
                                $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['vehicleDetails']['rcChasiNo'];
                                $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['vehicleDetails']['rcEngNo'];
                                // if($user->role_id==1) {
                                //     if($apiamster) {
                                //         $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                //     }
                                $rcvalidation = DB::table('rcshort_updated')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    // "client_id"=> $rc_validation['data']['client_id'],
                                    "rc_number" => $rc_validation['data']['rc_number'],
                                    "vehicle_chasi_number" => $rc_validation['data']['vehicle_chasi_number'],
                                    "vehicle_engine_number" => $rc_validation['data']['vehicle_engine_number'],
                                    // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),
                                    // 'service_provider'=> $service_provider
                                ]);
                                // }
                            } else if ($rc_validation1['error_code'] == "SPC-201") {
                                $statusCode = 500;
                                $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                    $rcvalidation = DB::table('rcshort_updated')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        "rc_number" => $rcNumber,
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),

                                    ]);
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            } else if ($rc_validation1['error_code'] == "SPC-203") {
                                $statusCode = 102;
                                $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                    $rcvalidation = DB::table('rcshort_updated')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        "rc_number" => $rcNumber,
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),

                                    ]);
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            } else {
                                if (isset($rc_validation['message']) && $rc_validation['message'] != 'success') {
                                    if ($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500) {
                                        // $statusCode = 101;
                                        // $errorMessage = 'RC Number in Multiple RTOs.';
                                        // }else if($rc_validation['reponseCode'] == 502){
                                        $statusCode = 102;
                                        $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                    } else if ($rc_validation['error_code'] == 'SPC-201') {
                                        $statusCode = 500;
                                        $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                    } else {
                                        $statusCode = 404;
                                        $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                    }
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                        }
                                        $rcvalidation = DB::table('rcshort_updated')->insert([
                                            "user_id" => $user->id,
                                            "api_id" => $api_id,
                                            "rc_number" => $rcNumber,
                                            "created_at" => Carbon::now(),
                                            "updated_at" => Carbon::now(),

                                        ]);
                                    }
                                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                }
                            }
                        } catch (\GuzzleHttp\Exception\RequestException $e) {
                            $response = $e->getResponse();
                            $status = json_decode((string) $response->getBody());
                            $statusCode = $e->getResponse()->getStatusCode();
                            if ($statusCode == 500 || $statusCode == 401) {
                                $statusCode = 102;
                                $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                            } else if ($statusCode == 403) {
                                if ($status->message_code == 'multiple_rto') {
                                    $statusCode = 101;
                                    $errorMessage = 'RC Number in Multiple RTOs.';
                                } else {
                                    $statusCode = 102;
                                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                }
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            } else {
                                $statusCode = 500;
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            }
                            if ($user->role_id == 1) {
                                $rcvalidation = DB::table('rcshort_updated')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    "rc_number" => $rcNumber,
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),

                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }
                } else {
                    return response()->json(['statusCode' => 102, 'message' => 'Verification Failed. Please enter correct State Code.']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
    }


    public function rc_validation_new_lite_old(Request $request)
    {
        // return 'testlite';
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $service_provider = "softpay";

        if (empty($request->rc_number))
            return response()->json(array(['statusCode' => '404', 'message' => 'RC number is required']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['statusCode' => '404', 'message' => 'Header Access Token is required']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rcvallite')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            // return 'false';
            $rcNumber = str_replace('-', '', $request->rc_number);
            $subString = strtoupper(substr($rcNumber, 0, 2));

            if ($subString == "AP" || $subString == "AR" || $subString == "AS" || $subString == "BR" || $subString == "CG" || $subString == "GA" || $subString == "GJ" || $subString == "HR" || $subString == "HP" || $subString == "JH" || $subString == "KA" || $subString == "KL" || $subString == "MP" || $subString == "MH" || $subString == "MN" || $subString == "ML" || $subString == "MZ" || $subString == "NL" || $subString == "OD" || $subString == "PB" || $subString == "RJ" || $subString == "SK" || $subString == "TN" || $subString == "TR" || $subString == "UP" || $subString == "UK" || $subString == "UA" || $subString == "WB" || $subString == "TS" || $subString == "AN" || $subString == "CH" || $subString == "DN" || $subString == "DD" || $subString == "JK" || $subString == "LA" || $subString == "LD" || $subString == "DL" || $subString == "PY") {
                // return 'true';
                $currentMonth = date('Y-m');
                $rcdata = DB::table('rcvalidation')->where('rc_number', $rcNumber)->where('hit_month', $currentMonth)->where('status_code', '200')->orderby('id', 'DESC')->first();
                // return $rcdata; 
                if (!empty($rcdata) && ($rcdata->rc_status != '' || $rcdata->rc_status != null)) {
                    $prt = '**';
                    $space = ' ';
                    $str = $rcdata->owner_name;
                    $nameowner = (explode(" ", $str));
                    $ownerfirstname = $nameowner[0][0] . $prt . $nameowner[0][2] . $prt . $space;
                    $ownersecoundname = $nameowner[1][0] . $prt . $nameowner[1][2] . $prt . $space;
                    // $ownerthirdname =  $nameowner[2][0].$prt.$nameowner[2][0].$prt.$space;
                    $allname = $ownerfirstname . $ownersecoundname;

                    // return $rcdata->insurance_upto;

                    $insuransespace = "-";
                    $updatedate = "2023";
                    $rcinsurance = $rcdata->insurance_upto;
                    $newrcinsurance = (explode("-", $rcinsurance));
                    $allinsurance = $updatedate . $insuransespace . $newrcinsurance[1] . $insuransespace . $newrcinsurance[2];
                    //return $allinsurance;
                    // return 'ok not test';
                    $statusCode = 200;
                    $rc_validation['data']['rc_number'] = $rcdata->rc_number;
                    $rc_validation['data']['rc_status'] = $rcdata->rc_status;
                    $rc_validation['data']['manufacturing_date'] = $rcdata->manufacturing_date;
                    if ($newrcinsurance[0] < 2022) {
                        $rc_validation['data']['insurance_upto'] = $allinsurance;
                    } else {
                        $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                    }
                    $rc_validation['data']['owner_name'] = $allname;
                    // $rc_validation['data']['permanent_address'] = $rcdata->permanent_address;
                    $rc_validation['data']['pucc_upto'] = $rcdata->pucc_upto;
                    // $rc_validation['data']['maker_model'] = $rcdata->maker_model;
                    // $rc_validation['data']['maker_description'] = $rcdata->maker_description;
                    $rc_validation['data']['vehicle_category'] = $rcdata->vehicle_category;
                    $rc_validation['data']['fit_up_to'] = $rcdata->fit_up_to;
                    $rc_validation['data']['tax_upto'] = $rcdata->tax_upto;
                    $rc_validation['data']['message_code'] = $rcdata->message_code;
                    $rc_validation['data']['fuel_type'] = $rcdata->fuel_type;
                    $rc_validation['data']['registered_at'] = $rcdata->registered_at;
                    $rc_validation['data']['registration_date'] = $rcdata->registration_date;
                    $rc_validation['status_code'] = 200;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $rc_validation['data']['client_id'],
                            "status_code" => 200,
                            "rc_number" => $rcdata->rc_number,
                            "rc_status" => $rcdata->rc_status,
                            "owner_number" => $rcdata->owner_number,
                            "tax_upto" => $rcdata->tax_upto,
                            "blacklist_status" => $rcdata->blacklist_status,
                            "father_name" => $rcdata->father_name,
                            "registration_date" => $rcdata->registration_date,
                            "owner_name" => $rcdata->owner_name,
                            "present_address" => $rcdata->present_address,
                            "permanent_address" => $rcdata->permanent_address,
                            "mobile_number" => $rcdata->mobile_number,
                            "vehicle_category" => $rcdata->vehicle_category,
                            "vehicle_chasi_number" => $rcdata->vehicle_chasi_number,
                            "vehicle_engine_number" => $rcdata->vehicle_engine_number,
                            "maker_description" => $rcdata->maker_description,
                            "maker_model" => $rcdata->maker_model,
                            "body_type" => $rcdata->body_type,
                            "fuel_type" => $rcdata->fuel_type,
                            "color" => $rcdata->color,
                            "norms_type" => $rcdata->norms_type,
                            "fit_up_to" => $rcdata->fit_up_to,
                            "financer" => $rcdata->financer,
                            "insurance_company" => $rcdata->insurance_company,
                            "insurance_policy_number" => $rcdata->insurance_policy_number,
                            "insurance_upto" => $rcdata->insurance_upto,
                            "manufacturing_date" => $rcdata->manufacturing_date,
                            "registered_at" => $rcdata->registered_at,
                            "less_info" => 1,
                            "cubic_capacity" => $rcdata->cubic_capacity,
                            "vehicle_gross_weight" => $rcdata->vehicle_gross_weight,
                            "no_cylinders" => $rcdata->no_cylinders,
                            "seat_capacity" => $rcdata->seat_capacity,
                            "sleeper_capacity" => $rcdata->sleeper_capacity,
                            "standing_capacity" => $rcdata->standing_capacity,
                            "wheelbase" => $rcdata->wheelbase,
                            "unladen_weight" => $rcdata->unladen_weight,
                            "vehicle_category_description" => $rcdata->vehicle_category_description,
                            "pucc_number" => $rcdata->pucc_number,
                            "pucc_upto" => $rcdata->pucc_upto,
                            'hit_month' => date('Y-m'),
                            'national_permit_issued_by' => $rcdata->national_permit_issued_by,
                            'national_permit_number' => $rcdata->national_permit_number,
                            'national_permit_upto' => $rcdata->national_permit_upto,
                            'permit_type' => $rcdata->permit_type,
                            'permit_valid_from' => $rcdata->permit_valid_from,
                            'permit_number' => $rcdata->permit_number,
                            'permit_valid_upto' => $rcdata->permit_valid_upto,
                            'permit_issue_date' => $rcdata->permit_issue_date,
                            'noc_details' => $rcdata->noc_details,
                            'latest_by' => $rcdata->latest_by,
                            'message_code' => $rcdata->message_code,
                            'non_use_to' => $rcdata->non_use_to,
                            'non_use_from' => $rcdata->non_use_from,
                            'non_use_status' => $rcdata->non_use_status,
                            // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now(),
                            'service_provider' => $service_provider
                        ]);
                    }
                } else {
                    // return 'ok test';
                    try {
                        $rc_validation = [];
                        $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number=' . $rcNumber, ['headers' => $headers]);
                        $rc_validation1 = json_decode($res->getBody(), true);

                        // return $rc_validation1;

                        // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                        // if(isset($rc_validation1['error_code'])){
                        //     $statusCode = 200;
                        // }
                        // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                        // if($grossWeight){
                        //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                        //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                        //     $checkweight = array();
                        //     $checkweight['tag_class'] = $checkWeight->tag_class;
                        // }else{
                        //     $checkweight['tag_class'] = '';
                        // }
                        if ($rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA' && Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->isPast() == true) {
                            $rc_validation['data']['rc_status'] = '';
                        } else {
                            $rc_validation['data']['rc_status'] = 'ACTIVE';
                        }

                        // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                        if ($rc_validation1['error_code'] == "SPC-200") {
                            $prt = '**';
                            $space = ' ';
                            $str = $rc_validation1['vehicleDetails']['rcOwnerName'];
                            $nameowner = (explode(" ", $str));
                            $ownerfirstname = $nameowner[0][0] . $prt . $nameowner[0][2] . $prt . $space;
                            $ownersecoundname = $nameowner[1][0] . $prt . $nameowner[1][2] . $prt . $space;
                            // $ownerthirdname =  $nameowner[2][0].$prt.$nameowner[2][2].$prt;
                            $allname = $ownerfirstname . $ownersecoundname;

                            $insuransespace = "-";
                            $updatedate = "2023";
                            $rcinsurance = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                            $newrcinsurance = (explode("-", $rcinsurance));
                            $allinsurance = $newrcinsurance[0] . $insuransespace . $newrcinsurance[1] . $insuransespace . $updatedate;
                            // return $allinsurance;
                            // return $newrcinsurance[2];
                            // return  $allname;

                            $statusCode = 200;
                            $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['vehicleNumber'];
                            // $rc_validation['data']['norms_type'] = $rc_validation1['vehicleDetails']['rcNormsDesc'];
                            // $rc_validation['data']['rc_status'] = $rc_validation1['vehicleDetails']['rcStatus'];
                            // $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['vehicleDetails']['rcGvw'];
                            // $rc_validation['data']['unladen_weight'] = $rc_validation1['vehicleDetails']['rcUnldWt'];
                            $rc_validation['data']['manufacturing_date'] = $rc_validation1['vehicleDetails']['rcManuMonthYr'];
                            // $rc_validation['data']['seat_capacity'] = $rc_validation1['vehicleDetails']['rcSeatCap'];
                            // $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['vehicleDetails']['rcNpIssuedBy'];
                            // $rc_validation['data']['national_permit_number'] = $rc_validation1['vehicleDetails']['rcNpNo'];
                            // $rc_validation['data']['national_permit_upto'] = $rc_validation1['vehicleDetails']['rcNpUpto'];
                            // $rc_validation['data']['insurance_company'] = $rc_validation1['vehicleDetails']['rcInsuranceComp'];
                            // $rc_validation['data']['insurance_policy_number'] = $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'];
                            if (isset($rc_validation1['vehicleDetails']['rcInsuranceUpto']) && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != null && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != "null" && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != 'NA') {
                                if ($newrcinsurance[2] < 2022) {
                                    $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                } else {
                                    $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                }

                            } else {
                                $rc_validation['data']['insurance_upto'] = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                            }

                            // $rc_validation['data']['permit_type'] = $rc_validation1['vehicleDetails']['rcPermitType'];
                            // $rc_validation['data']['permit_valid_from'] = $rc_validation1['vehicleDetails']['rcPermitValidFrom'];
                            // $rc_validation['data']['permit_number'] = $rc_validation1['vehicleDetails']['rcPermitNo'];
                            // $rc_validation['data']['permit_valid_upto'] = $rc_validation1['vehicleDetails']['rcPermitValidUpto'];
                            // $rc_validation['data']['permit_issue_date'] = $rc_validation1['vehicleDetails']['rcPermitIssueDt'];
                            // $rc_validation['data']['noc_details'] = $rc_validation1['vehicleDetails']['rcNocDetails'];
                            // $rc_validation['data']['body_type'] = $rc_validation1['vehicleDetails']['rcBodyTypeDesc'];
                            // $rc_validation['data']['father_name'] = $rc_validation1['vehicleDetails']['rcFName'];
                            $rc_validation['data']['owner_name'] = $allname;
                            // $rc_validation['data']['permanent_address'] = $rc_validation1['vehicleDetails']['rcPermanentAddress'];
                            // $rc_validation['data']['present_address'] = $rc_validation1['vehicleDetails']['rcPresentAddress'];
                            // $rc_validation['data']['pucc_number'] = $rc_validation1['vehicleDetails']['rcPuccNo'];
                            if (isset($rc_validation1['vehicleDetails']['rcPuccUpto']) && $rc_validation1['vehicleDetails']['rcPuccUpto'] != null && $rc_validation1['vehicleDetails']['rcPuccUpto'] != "null" && $rc_validation1['vehicleDetails']['rcPuccUpto'] != 'NA') {
                                $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcPuccUpto'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['pucc_upto'] = $rc_validation1['vehicleDetails']['rcPuccUpto'];
                            }
                            // $rc_validation['data']['blacklist_status'] = $rc_validation1['vehicleDetails']['rcBlacklistStatus'];
                            // $rc_validation['data']['maker_model'] = $rc_validation1['vehicleDetails']['rcMakerModel'];
                            // $rc_validation['data']['maker_description'] = $rc_validation1['vehicleDetails']['rcMakerDesc'];
                            if (isset($rc_validation1['vehicleDetails']['rcFitUpto']) && $rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != "null" && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA') {
                                $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['fit_up_to'] = $rc_validation1['vehicleDetails']['rcFitUpto'];
                            }
                            // $rc_validation['data']['standing_capacity'] = $rc_validation1['vehicleDetails']['rcStandCap'];
                            // $rc_validation['data']['sleeper_capacity'] = $rc_validation1['vehicleDetails']['rcSleeperCap'];
                            // $rc_validation['data']['wheelbase'] = $rc_validation1['vehicleDetails']['rcWheelbase'];
                            // $rc_validation['data']['vehicle_category_description'] = $rc_validation1['vehicleDetails']['rcVhClassDesc'];
                            $rc_validation['data']['vehicle_category'] = $rc_validation1['vehicleDetails']['rcVchCatg'];
                            // $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['vehicleDetails']['rcChasiNo'];
                            // $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['vehicleDetails']['rcEngNo'];
                            // $rc_validation['data']['mobile_number'] = $rc_validation1['vehicleDetails']['rcMobileNo'];
                            // $rc_validation['data']['financer'] = $rc_validation1['vehicleDetails']['rcFinancer'];
                            // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                            // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                            // $rc_validation['data']['latest_by'] = $rc_validation1['vehicleDetails']['rcStatusAsOn'];
                            $rc_validation['data']['tax_upto'] = $rc_validation1['vehicleDetails']['rcTaxUpto'];
                            $rc_validation['data']['message_code'] = $rc_validation1['vehicleDetails']['stautsmessage'];
                            // $rc_validation['data']['non_use_to'] = $rc_validation1['vehicleDetails']['rcNonUseTo'];
                            // $rc_validation['data']['non_use_from'] = $rc_validation1['vehicleDetails']['rcNonUseFrom'];
                            // $rc_validation['data']['non_use_status'] = $rc_validation1['vehicleDetails']['rcNonUseStatus'];
                            $rc_validation['data']['fuel_type'] = $rc_validation1['vehicleDetails']['rcFuelDesc'];
                            $rc_validation['data']['registered_at'] = $rc_validation1['vehicleDetails']['rcRegisteredAt'];
                            if (isset($rc_validation1['vehicleDetails']['rcRegnDt']) && $rc_validation1['vehicleDetails']['rcRegnDt'] != null && $rc_validation1['vehicleDetails']['rcRegnDt'] != "null" && $rc_validation1['vehicleDetails']['rcRegnDt'] != 'NA') {
                                $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['vehicleDetails']['rcRegnDt'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['registration_date'] = $rc_validation1['vehicleDetails']['rcRegnDt'];
                            }

                            // $rc_validation['data']['color'] = $rc_validation1['vehicleDetails']['rcColor'];
                            // $rc_validation['data']['owner_number'] = $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'];
                            // $rc_validation['data']['no_cylinders'] = $rc_validation1['vehicleDetails']['rcNoCyl'];
                            // $rc_validation['data']['cubic_capacity'] = $rc_validation1['vehicleDetails']['rcCubicCap'];
                            $rc_validation['status_code'] = 200;
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    // "client_id"=> $rc_validation['data']['client_id'],
                                    "status_code" => 200,
                                    "rc_number" => $rc_validation1['vehicleDetails']['vehicleNumber'],
                                    "rc_status" => $rc_validation1['vehicleDetails']['rcStatus'],
                                    "owner_number" => $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'],
                                    "tax_upto" => $rc_validation1['vehicleDetails']['rcTaxUpto'],
                                    "blacklist_status" => $rc_validation1['vehicleDetails']['rcBlacklistStatus'],
                                    "father_name" => $rc_validation1['vehicleDetails']['rcFName'],
                                    "registration_date" => $rc_validation['data']['registration_date'],
                                    "owner_name" => $rc_validation1['vehicleDetails']['rcOwnerName'],
                                    "present_address" => $rc_validation1['vehicleDetails']['rcPresentAddress'],
                                    "permanent_address" => $rc_validation1['vehicleDetails']['rcPermanentAddress'],
                                    "mobile_number" => $rc_validation1['vehicleDetails']['rcMobileNo'],
                                    "vehicle_category" => $rc_validation1['vehicleDetails']['rcVchCatg'],
                                    "vehicle_chasi_number" => $rc_validation1['vehicleDetails']['rcChasiNo'],
                                    "vehicle_engine_number" => $rc_validation1['vehicleDetails']['rcEngNo'],
                                    "maker_description" => $rc_validation1['vehicleDetails']['rcMakerDesc'],
                                    "maker_model" => $rc_validation1['vehicleDetails']['rcMakerModel'],
                                    "body_type" => $rc_validation1['vehicleDetails']['rcBodyTypeDesc'],
                                    "fuel_type" => $rc_validation1['vehicleDetails']['rcFuelDesc'],
                                    "color" => $rc_validation1['vehicleDetails']['rcColor'],
                                    "norms_type" => $rc_validation1['vehicleDetails']['rcNormsDesc'],
                                    "fit_up_to" => $rc_validation['data']['fit_up_to'],
                                    "financer" => $rc_validation1['vehicleDetails']['rcFinancer'],
                                    "insurance_company" => $rc_validation1['vehicleDetails']['rcInsuranceComp'],
                                    "insurance_policy_number" => $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'],
                                    "insurance_upto" => $rc_validation['data']['insurance_upto'],
                                    "manufacturing_date" => $rc_validation1['vehicleDetails']['rcManuMonthYr'],
                                    "registered_at" => $rc_validation1['vehicleDetails']['rcRegisteredAt'],
                                    "less_info" => 1,
                                    "cubic_capacity" => $rc_validation1['vehicleDetails']['rcCubicCap'],
                                    "vehicle_gross_weight" => $rc_validation1['vehicleDetails']['rcGvw'],
                                    "no_cylinders" => $rc_validation1['vehicleDetails']['rcNoCyl'],
                                    "seat_capacity" => $rc_validation1['vehicleDetails']['rcSeatCap'],
                                    "sleeper_capacity" => $rc_validation1['vehicleDetails']['rcSleeperCap'],
                                    "standing_capacity" => $rc_validation1['vehicleDetails']['rcStandCap'],
                                    "wheelbase" => $rc_validation1['vehicleDetails']['rcWheelbase'],
                                    "unladen_weight" => $rc_validation1['vehicleDetails']['rcUnldWt'],
                                    "vehicle_category_description" => $rc_validation1['vehicleDetails']['rcVhClassDesc'],
                                    "pucc_number" => $rc_validation1['vehicleDetails']['rcPuccNo'],
                                    "pucc_upto" => $rc_validation['data']['pucc_upto'],
                                    'hit_month' => date('Y-m'),
                                    'national_permit_issued_by' => $rc_validation1['vehicleDetails']['rcNpIssuedBy'],
                                    'national_permit_number' => $rc_validation1['vehicleDetails']['rcNpNo'],
                                    'national_permit_upto' => $rc_validation1['vehicleDetails']['rcNpUpto'],
                                    'permit_type' => $rc_validation1['vehicleDetails']['rcPermitType'],
                                    'permit_valid_from' => $rc_validation1['vehicleDetails']['rcPermitValidFrom'],
                                    'permit_number' => $rc_validation1['vehicleDetails']['rcPermitNo'],
                                    'permit_valid_upto' => $rc_validation1['vehicleDetails']['rcPermitValidUpto'],
                                    'permit_issue_date' => $rc_validation1['vehicleDetails']['rcPermitIssueDt'],
                                    'noc_details' => $rc_validation1['vehicleDetails']['rcNocDetails'],
                                    'latest_by' => $rc_validation1['vehicleDetails']['rcStatusAsOn'],
                                    'message_code' => $rc_validation1['vehicleDetails']['stautsmessage'],
                                    'non_use_to' => $rc_validation1['vehicleDetails']['rcNonUseTo'],
                                    'non_use_from' => $rc_validation1['vehicleDetails']['rcNonUseFrom'],
                                    'non_use_status' => $rc_validation1['vehicleDetails']['rcNonUseStatus'],
                                    // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),
                                    'service_provider' => $service_provider
                                ]);
                            }
                        } else if ($rc_validation1['error_code'] == "SPC-201") {
                            $statusCode = 500;
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    "status_code" => $statusCode,
                                    "rc_number" => $rcNumber,
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),
                                    'service_provider' => $service_provider
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } else if ($rc_validation1['error_code'] == "SPC-203") {
                            $statusCode = 102;
                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    "status_code" => $statusCode,
                                    "rc_number" => $rcNumber,
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),
                                    'service_provider' => $service_provider
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        } else {
                            if (isset($rc_validation['message']) && $rc_validation['message'] != 'success') {
                                if ($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500) {
                                    // $statusCode = 101;
                                    // $errorMessage = 'RC Number in Multiple RTOs.';
                                    // }else if($rc_validation['reponseCode'] == 502){
                                    $statusCode = 102;
                                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                } else if ($rc_validation['error_code'] == 'SPC-201') {
                                    $statusCode = 500;
                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                } else {
                                    $statusCode = 404;
                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                }
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        "status_code" => $statusCode,
                                        "rc_number" => $rcNumber,
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),
                                        'service_provider' => $service_provider
                                    ]);
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            }
                        }
                    } catch (\GuzzleHttp\Exception\RequestException $e) {
                        $response = $e->getResponse();
                        $status = json_decode((string) $response->getBody());
                        $statusCode = $e->getResponse()->getStatusCode();
                        if ($statusCode == 500 || $statusCode == 401) {
                            $statusCode = 102;
                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                            // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 403) {
                            if ($status->message_code == 'multiple_rto') {
                                $statusCode = 101;
                                $errorMessage = 'RC Number in Multiple RTOs.';
                            } else {
                                $statusCode = 102;
                                $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                            }
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $statusCode = 500;
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        if ($user->role_id == 1) {
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "status_code" => $statusCode,
                                "rc_number" => $rcNumber,
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now(),
                                'service_provider' => $service_provider
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 102, 'message' => 'Verification Failed. Please enter correct State Code.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
    }
    public function rc_validation_new_lite(Request $request)
    {
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $service_provider = 'softpay';

        if (empty($request->rc_number)) {
            return response()->json([['statusCode' => '404', 'message' => 'RC number is required']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['statusCode' => '404', 'message' => 'Header Access Token is required']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rcvallite')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        // return  $api_id;
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return 'false';
                $rcNumber = str_replace('-', '', $request->rc_number);
                $subString = strtoupper(substr($rcNumber, 0, 2));

                if ($subString == 'AP' || $subString == 'AR' || $subString == 'AS' || $subString == 'BR' || $subString == 'CG' || $subString == 'GA' || $subString == 'GJ' || $subString == 'HR' || $subString == 'HP' || $subString == 'JH' || $subString == 'KA' || $subString == 'KL' || $subString == 'MP' || $subString == 'MH' || $subString == 'MN' || $subString == 'ML' || $subString == 'MZ' || $subString == 'NL' || $subString == 'OD' || $subString == 'PB' || $subString == 'RJ' || $subString == 'SK' || $subString == 'TN' || $subString == 'TR' || $subString == 'UP' || $subString == 'UK' || $subString == 'UA' || $subString == 'WB' || $subString == 'TS' || $subString == 'AN' || $subString == 'CH' || $subString == 'DN' || $subString == 'DD' || $subString == 'JK' || $subString == 'LA' || $subString == 'LD' || $subString == 'DL' || $subString == 'PY') {
                    // return 'true';
                    $currentMonth = date('Y-m');
                    $rcdata = DB::table('rcvalidation')
                        ->where('rc_number', $rcNumber)
                        ->where('hit_month', $currentMonth)
                        ->where('status_code', '200')
                        ->orderby('id', 'DESC')
                        ->first();
                    $rcdata = 0;
                    if (!empty($rcdata) && ($rcdata->rc_status != '' || $rcdata->rc_status != null)) {
                        $prt = '**';
                        $space = ' ';
                        $str = $rcdata->owner_name;
                        $nameowner = explode(' ', $str);
                        $ownerfirstname = $nameowner[0][0] . $prt . $nameowner[0][2] . $prt . $space;
                        $ownersecoundname = $nameowner[1][0] . $prt . $nameowner[1][2] . $prt . $space;
                        // $ownerthirdname =  $nameowner[2][0].$prt.$nameowner[2][0].$prt;
                        $allname = $ownerfirstname . $ownersecoundname;
                        // return 'ok not test';

                        $insuransespace = '-';
                        $updatedate = '2023';
                        $rcinsurance = $rcdata->insurance_upto;
                        $newrcinsurance = explode('-', $rcinsurance);
                        $allinsurance = $updatedate . $insuransespace . $newrcinsurance[1] . $insuransespace . $newrcinsurance[2];

                        $statusCode = 200;
                        $rc_validation['data']['rc_number'] = $rcdata->rc_number;
                        $rc_validation['data']['owner_name'] = $allname;
                        $rc_validation['status_code'] = 200;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                // "client_id"=> $rc_validation['data']['client_id'],
                                'status_code' => 200,
                                'rc_number' => $rcdata->rc_number,
                                'owner_name' => $rcdata->owner_name,
                                
                                'vehicle_chasi_number' => $rcdata->vehicle_chasi_number,
                                
                                'maker_model' => $rcdata->maker_model,
                                'manufacturing_date' => $rcdata->manufacturing_date,
                                // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                                'service_provider' => 'kyckart',
                            ]);
                        }
                    } else {
                        // return 'ok test';
                        try {
                            $client = new Client();
                    $headers = [
                        'Accept' => 'application/json',
                        'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
                    ];
                    $body = [
                        'vehicleNumber' => $request->rc_number,
                        // 'groupId'=>$groupId,
                        // 'checkId'=>$checkId,
                    ];
$res = $client->post('https://api.kyckart.com/api/vehicle-registration/searchV4', [
                        'headers' => $headers,
                        'json' => $body,
                    ]);
                        $rc_validation = [];
                        // $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number=' . $rcNumber, ['headers' => $headers]);
                        $rc_validation1 = json_decode($res->getBody(), true);
                        // return $rc_validation1;

                            // function maskString($inputString) {
                            //     $length = strlen($inputString);
                            //     $maskedString = '';

                            //     if ($length > 4) {
                            //         $maskedString = str_repeat('*', $length - 4) . substr($inputString, -4);
                            //     } else {
                            //         $maskedString = $inputString;
                            //     }

                            //     return $maskedString;
                            // }

                            // $input = 'fdhufdhkfdfd123244545rtrttyyyyyy';
                            // $masked = maskString($input);

                            // return $masked;

                            
                            if ($rc_validation1['response']['code'] == 200) {
                                $prt = '**';
                                $space = ' ';

                                $insuransespace = '-';
                                $updatedate = '2023';
                                
                                // $chassi_number = $rc_validation1['response']['vehicle']['chassis'];
                                // $chassiNumberlength = strlen($chassi_number);
                                // $firstchassiNumberDigits = substr($chassi_number, 0, 2);
                                // $lastchassiNumberDigits = substr($chassi_number, -2);
                                // $maskedChassiNumber = $firstchassiNumberDigits . str_repeat('*', $chassiNumberlength - (2 * 2)) . $lastchassiNumberDigits;
                                $chassi_number = $rc_validation1['response']['vehicle']['chassis'];
$chassiNumberLength = strlen($chassi_number);

// Ensure the length is at least 4 to avoid errors
if ($chassiNumberLength > 4) {
    // Mask all but the last four characters
    $maskedChassiNumber = str_repeat('*', $chassiNumberLength - 4) . substr($chassi_number, -4);
} else {
    // If the chassis number is less than or equal to 4, just show it
    $maskedChassiNumber = $chassi_number;
}


                                //engin number convert masked engin number.
                                
                                $statusCode = 200;
                                $rc_validation['data']['rc_number'] = $rc_validation1['response']['vehicle']['number'];
                                
                                $rc_validation['data']['owner_name'] = $rc_validation1['response']['owner'];

                                $rc_validation['data']['model_name'] = $rc_validation1['response']['vehicle']['modelName'];

                                $rc_validation['data']['manufacturing_date'] = $rc_validation1['response']['vehicle']['manufacturingDate'];
                                
                                
                                $rc_validation['data']['vehicle_chasi_number'] = $maskedChassiNumber;
                                
                               

                                $rc_validation['status_code'] = 200;
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                    }
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        'user_id' => $user->id,
                                        'api_id' => $api_id,
                                        // "client_id"=> $rc_validation['data']['client_id'],
                                        'status_code' => 200,
                                        'rc_number' => $rc_validation1['response']['vehicle']['number'],
                                        
                                        
                                        'owner_name' => $rc_validation1['response']['owner']['result']['rc_owner_name'],
                                        'present_address' => null,
                                        
                                        'vehicle_chasi_number' => $rc_validation1['response']['vehicle']['chassis'],
                                        'maker_model' => $rc_validation1['response']['vehicle']['modelName'],
                                        'manufacturing_date' => $rc_validation1['response']['vehicle']['manufacturingDate'],
                                        
                                        'hit_month' => date('Y-m'),
                                        
                                        'created_at' => Carbon::now(),
                                        'updated_at' => Carbon::now(),
                                        'service_provider' => 'kycKart',
                                    ]);
                                }
                            }
                            // else if($rc_validation1['error_code'] == "SPC-201"){
                            //     $statusCode = 500;
                            //     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            //     if($user->role_id==1) {
                            //         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            //         $rcvalidation = DB::table('rcvalidation')->insert([
                            //             "user_id"=> $user->id,
                            //             "api_id"=> $api_id,
                            //             "status_code"=> $statusCode,
                            //             "rc_number"=> $rcNumber,
                            //             "created_at"=> Carbon::now(),
                            //             "updated_at"=> Carbon::now(),
                            //             'service_provider'=> $service_provider
                            //         ]);
                            //     }
                            //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                            // }
                            elseif ($rc_validation1['response']['code'] == 1003 || $rc_validation1['response']['code'] == 'SPC-206' || $rc_validation1['response']['code'] == 'SPC-201') {
                                // return 'tester';
                                $statusCode = 102;
                                if ($rc_validation1['response']['code'] == 1003 && $rc_validation1['response']['message'] == 'Record not found') {
                                    $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                    if ($user->role_id == 1) {
                                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            'user_id' => $user->id,
                                            'api_id' => $api_id,
                                            'status_code' => $statusCode,
                                            'rc_number' => $rcNumber,
                                            'created_at' => Carbon::now(),
                                            'updated_at' => Carbon::now(),
                                            'service_provider' => $service_provider,
                                        ]);
                                    }
                                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                } else {
                    
                                    try {
                                        // return 'try';
                                        $client = new Client();
                                        // $rcnomber = 'MH16AJ1013';
                                        $blacklistcheck = 'true';
                                        // $headerss = [
                                        //     // 'Authorization' => $this->nsdlToken,
                                        //     'secretKey' => 'pI76u95BabjkIFg6DNNRole7gZn71ljPk7W5WIHzApjlObIMywuq8pZGa30HXm5wR',
                                        //     'clientId' => 'ef41c6d7089614d1838c68efc81a8493:dc983c1bfbc4390f4952bd44ed0ae690'
                                        // ];

                                        // // return 'test the try in try';
                                        // $rc_validation = [];
                                        // $res = $client->post('https://api.emptra.com/vehicleRegistrationsV3', ['headers' => $headerss, 'form_params'=> ['vehicleNumber'=>$request->rc_number,'blacklistCheck'=>$blacklistcheck]]);
                                        // $rc_validation1 = json_decode($res->getBody(), true);

                                        $url = 'https://api.emptra.com/vehicleRegistrationsV2';

                                        $data = [
                                            'vehicleNumber' => $request->rc_number,
                                        ];

                                        $body = json_encode($data);

                                        $ch = curl_init($url);

                                        curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                                        curl_setopt($ch, CURLOPT_HTTPHEADER, ['secretKey: ' . $this->secretKey, 'clientId: ' . $this->clientId, 'Content-Type:application/json']);
                                        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                                        $get_data1 = curl_exec($ch);
                                        $rc_validation1 = json_decode($get_data1, true);
                                        // return $rc_validation1;

                                        // return $rc_validation1['result']['rcExpiryDate'];
                                        // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                                        // if(isset($rc_validation1['error_code'])){
                                        //     $statusCode = 200;
                                        // }
                                        // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                                        // if($grossWeight){
                                        //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                                        //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                                        //     $checkweight = array();
                                        //     $checkweight['tag_class'] = $checkWeight->tag_class;
                                        // }else{
                                        //     $checkweight['tag_class'] = '';
                                        // }
                                        // if($rc_validation1['result']['rcExpiryDate'] != null && $rc_validation1['result']['rcExpiryDate'] != 'NA'){
                                        //     $rc_validation['data']['rc_status'] = '';
                                        // }else{
                                        //     $rc_validation['data']['rc_status'] = 'ACTIVE';
                                        // }

                                        // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                                        if ($rc_validation1['code'] == '100' || $rc_validation1['code'] == '200') {
                                            $prt = '**';
                                            $space = ' ';
                                            $str = $rc_validation1['result']['owner_name'];
                                            $nameowner = explode(' ', $str);
                                            $ownerfirstname = $nameowner[0][0] . $prt . $nameowner[0][2] . $prt . $space;
                                            $ownersecoundname = $nameowner[1][0] . $prt . $nameowner[1][2] . $prt . $space;
                                            // $ownerthirdname =  $nameowner[2][0].$prt.$nameowner[2][2].$prt;
                                            $allname = $ownerfirstname . $ownersecoundname;

                                            // return $rc_validation1['result'];

                                            $insuransespace = '-';
                                            $updatedate = '2023';
                                            $rcinsurance = $rc_validation1['result']['insurance_upto'];
                                            // return $rcinsurance;
                                            $newrcinsurance = explode('-', $rcinsurance);
                                            // return $newrcinsurance;
                                            $allinsurance = $newrcinsurance[0] . $insuransespace . $newrcinsurance[1] . $insuransespace . $updatedate;
                                            // return $allinsurance;

                                            $statusCode = 200;
                                            $rc_validation['data']['rc_number'] = $rc_validation1['result']['rc_number'];
                                            $rc_validation['data']['manufacturing_date'] = $rc_validation1['result']['manufacturing_date'];
                                            if (isset($rc_validation1['result']['insurance_upto']) && $rc_validation1['result']['insurance_upto'] != null && $rc_validation1['result']['insurance_upto'] != 'null' && $rc_validation1['result']['insurance_upto'] != 'NA') {
                                                if ($newrcinsurance[0] < 2022) {
                                                    $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                                } else {
                                                    $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['result']['insurance_upto'])->format('Y-m-d');
                                                }
                                            } else {
                                                $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                            }
                                            $rc_validation['data']['owner_name'] = $allname;
                                            if (isset($rc_validation1['result']['pucc_upto']) && $rc_validation1['result']['pucc_upto'] != null && $rc_validation1['result']['pucc_upto'] != 'null' && $rc_validation1['result']['pucc_upto'] != 'NA') {
                                                // $rc_validation['data']['pucc_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['pucc_upto'])->format('Y-m-d');
                                                $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['pucc_upto'];
                                            } else {
                                                $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['pucc_upto'];
                                            }
                                            if (isset($rc_validation1['result']['fit_up_to']) && $rc_validation1['result']['fit_up_to'] != null && $rc_validation1['result']['fit_up_to'] != 'null' && $rc_validation1['result']['fit_up_to'] != 'NA') {
                                                // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                                $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['fit_up_to'];
                                            } else {
                                                $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['fit_up_to'];
                                            }
                                        }

                                        $rc_validation['data']['vehicle_category'] = $rc_validation1['result']['vehicle_category'];
                                        $rc_validation['data']['tax_upto'] = $rc_validation1['result']['tax_upto'];
                                        $rc_validation['data']['message_code'] = 'NA';
                                        $rc_validation['data']['fuel_type'] = $rc_validation1['result']['fuel_type'];
                                        $rc_validation['data']['registered_at'] = $rc_validation1['result']['registered_at'];
                                        if (isset($rc_validation1['result']['registration_date']) && $rc_validation1['result']['registration_date'] != null && $rc_validation1['result']['registration_date'] != 'null' && $rc_validation1['result']['registration_date'] != 'NA') {
                                            $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['result']['registration_date'])->format('Y-m-d');
                                        } else {
                                            $rc_validation['data']['registration_date'] = $rc_validation1['result']['registration_date'];
                                        }

                                        $rc_validation['status_code'] = 200;
                                        if ($user->role_id == 1) {
                                            if ($apiamster) {
                                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                            }
                                            // return  $rc_validation['result'];
                                            $rcvalidation = DB::table('rcvalidation')->insert([
                                                'user_id' => $user->id,
                                                'api_id' => $api_id,
                                                // "client_id"=> $rc_validation['data']['client_id'],
                                                'status_code' => 200,
                                                'rc_number' => $rc_validation1['result']['rc_number'],
                                                'rc_status' => $rc_validation1['result']['rc_status'],
                                                'owner_number' => $rc_validation1['result']['owner_number'],
                                                'tax_upto' => $rc_validation1['result']['tax_upto'],
                                                'blacklist_status' => $rc_validation1['result']['blacklist_status'],
                                                'father_name' => $rc_validation1['result']['father_name'],
                                                'registration_date' => $rc_validation['data']['registration_date'],
                                                'owner_name' => $rc_validation1['result']['owner_name'],
                                                'present_address' => $rc_validation1['result']['present_address'],
                                                'permanent_address' => $rc_validation1['result']['permanent_address'],
                                                'mobile_number' => $rc_validation1['result']['mobile_number'],
                                                'vehicle_category' => $rc_validation1['result']['vehicle_category'],
                                                'vehicle_chasi_number' => $rc_validation1['result']['vehicle_chasi_number'],
                                                'vehicle_engine_number' => $rc_validation1['result']['vehicle_engine_number'],
                                                'maker_description' => $rc_validation1['result']['maker_description'],
                                                'maker_model' => $rc_validation1['result']['maker_model'],
                                                'body_type' => $rc_validation1['result']['body_type'],
                                                'fuel_type' => $rc_validation1['result']['fuel_type'],
                                                'color' => $rc_validation1['result']['color'],
                                                'norms_type' => $rc_validation1['result']['norms_type'],
                                                'fit_up_to' => $rc_validation['data']['fit_up_to'],
                                                'financer' => $rc_validation1['result']['fit_up_to'],
                                                'insurance_company' => $rc_validation1['result']['insurance_company'],
                                                'insurance_policy_number' => $rc_validation1['result']['insurance_policy_number'],
                                                'insurance_upto' => $rc_validation['data']['insurance_upto'],
                                                'manufacturing_date' => $rc_validation1['result']['manufacturing_date'],
                                                'registered_at' => $rc_validation1['result']['registered_at'],
                                                'less_info' => 1,
                                                'cubic_capacity' => $rc_validation1['result']['cubic_capacity'],
                                                'vehicle_gross_weight' => $rc_validation1['result']['vehicle_gross_weight'],
                                                'no_cylinders' => $rc_validation1['result']['no_cylinders'],
                                                'seat_capacity' => $rc_validation1['result']['seat_capacity'],
                                                'sleeper_capacity' => $rc_validation1['result']['sleeper_capacity'],
                                                'standing_capacity' => $rc_validation1['result']['standing_capacity'],
                                                'wheelbase' => $rc_validation1['result']['wheelbase'],
                                                'unladen_weight' => $rc_validation1['result']['unladen_weight'],
                                                'vehicle_category_description' => $rc_validation1['result']['vehicle_category_description'],
                                                'pucc_number' => $rc_validation1['result']['pucc_number'],
                                                'pucc_upto' => $rc_validation['data']['pucc_upto'],
                                                'hit_month' => date('Y-m'),
                                                'national_permit_issued_by' => $rc_validation1['result']['national_permit_issued_by'],
                                                'national_permit_number' => $rc_validation1['result']['national_permit_number'],
                                                'national_permit_upto' => $rc_validation1['result']['national_permit_upto'],
                                                'permit_type' => $rc_validation1['result']['permit_type'],
                                                'permit_valid_from' => $rc_validation1['result']['permit_valid_from'],
                                                'permit_number' => $rc_validation1['result']['permit_number'],
                                                'permit_valid_upto' => $rc_validation1['result']['permit_valid_upto'],
                                                'permit_issue_date' => $rc_validation1['result']['permit_issue_date'],
                                                'noc_details' => $rc_validation1['result']['noc_details'],
                                                'latest_by' => $rc_validation1['result']['latest_by'],
                                                'message_code' => 'NA',
                                                'non_use_to' => $rc_validation1['result']['non_use_to'],
                                                'non_use_from' => $rc_validation1['result']['non_use_from'],
                                                'non_use_status' => $rc_validation1['result']['non_use_status'],
                                                // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                                'created_at' => Carbon::now(),
                                                'updated_at' => Carbon::now(),
                                                'service_provider' => 'emptra',
                                            ]);
                                        } elseif ($rc_validation1['code'] == '200' || $rc_validation1['code'] == '103') {
                                            $statusCode = 500;
                                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                            if ($user->role_id == 1) {
                                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                                $rcvalidation = DB::table('rcvalidation')->insert([
                                                    'user_id' => $user->id,
                                                    'api_id' => $api_id,
                                                    'status_code' => $statusCode,
                                                    'rc_number' => $rcNumber,
                                                    'created_at' => Carbon::now(),
                                                    'updated_at' => Carbon::now(),
                                                    'service_provider' => $service_provider,
                                                ]);
                                            }
                                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                        } elseif ($rc_validation1['response']['code'] == '400') {
                                            $statusCode = 102;
                                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                            if ($user->role_id == 1) {
                                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                                $rcvalidation = DB::table('rcvalidation')->insert([
                                                    'user_id' => $user->id,
                                                    'api_id' => $api_id,
                                                    'status_code' => $statusCode,
                                                    'rc_number' => $rcNumber,
                                                    'created_at' => Carbon::now(),
                                                    'updated_at' => Carbon::now(),
                                                    'service_provider' => $service_provider,
                                                ]);
                                            }
                                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                        } else {
                                            // if(isset($rc_validation['message']) && $rc_validation['message'] != 'success')
                                            if ($rc_validation1['code'] != '100') {
                                                if ($rc_validation1['code'] == 404 || $rc_validation1['code'] == 502 || $rc_validation1['code'] == 500) {
                                                    // $statusCode = 101;
                                                    // $errorMessage = 'RC Number in Multiple RTOs.';
                                                    // }else if($rc_validation['reponseCode'] == 502){
                                                    $statusCode = 102;
                                                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                                } elseif ($rc_validation1['code'] == '104') {
                                                    $statusCode = 500;
                                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                                } else {
                                                    $statusCode = 404;
                                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                                }
                                                if ($user->role_id == 1) {
                                                    if ($apiamster) {
                                                        // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                                    }
                                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                                        'user_id' => $user->id,
                                                        'api_id' => $api_id,
                                                        'status_code' => $statusCode,
                                                        'rc_number' => $rcNumber,
                                                        'created_at' => Carbon::now(),
                                                        'updated_at' => Carbon::now(),
                                                        'service_provider' => $service_provider,
                                                    ]);
                                                }
                                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                            }
                                        }
                                    } catch (\GuzzleHttp\Exception\RequestException $e) {
                                        $response = $e->getResponse();
                                        $status = json_decode((string) $response->getBody());
                                        $statusCode = $e->getResponse()->getStatusCode();
                                        if ($statusCode == 500 || $statusCode == 401) {
                                            $statusCode = 102;
                                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                            // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                            if ($user->role_id == 1) {
                                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                            }
                                        } elseif ($statusCode == 403) {
                                            if ($status->message_code == 'multiple_rto') {
                                                $statusCode = 101;
                                                $errorMessage = 'RC Number in Multiple RTOs.';
                                            } else {
                                                $statusCode = 102;
                                                $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                            }
                                            if ($user->role_id == 1) {
                                                if ($apiamster) {
                                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                                }
                                            }
                                        } else {
                                            $statusCode = 500;
                                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                            if ($user->role_id == 1) {
                                                if ($apiamster) {
                                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                                }
                                            }
                                        }
                                        if ($user->role_id == 1) {
                                            $rcvalidation = DB::table('rcvalidation')->insert([
                                                'user_id' => $user->id,
                                                'api_id' => $api_id,
                                                'status_code' => $statusCode,
                                                'rc_number' => $rcNumber,
                                                'created_at' => Carbon::now(),
                                                'updated_at' => Carbon::now(),
                                                'service_provider' => $service_provider,
                                            ]);
                                        }
                                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                    }
                                }
                            } else {
                                if (isset($rc_validation['message']) && $rc_validation['message'] != 'success') {
                                    if ($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500 || $rc_validation['response']['code'] == 1003) {
                                        // $statusCode = 101;
                                        // $errorMessage = 'RC Number in Multiple RTOs.';
                                        // }else if($rc_validation['reponseCode'] == 502){
                                        $statusCode = 102;
                                        $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                    } elseif ($rc_validation['error_code'] == 'SPC-201') {
                                        $statusCode = 500;
                                        $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                    } else {
                                        $statusCode = 404;
                                        $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                    }
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                        }
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            'user_id' => $user->id,
                                            'api_id' => $api_id,
                                            'status_code' => $statusCode,
                                            'rc_number' => $rcNumber,
                                            'created_at' => Carbon::now(),
                                            'updated_at' => Carbon::now(),
                                            'service_provider' => $service_provider,
                                        ]);
                                    }
                                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                }
                            }
                        } catch (BadResponseException $e) {
                            $response = $e->getResponse();
                            $status = json_decode((string) $response->getBody(), true);
                            $statusCode = $e->getResponse()->getStatusCode();
                            if ($statusCode == 500 || $statusCode == 401) {
                                $statusCode = 102;
                                $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                            } elseif ($statusCode == 403) {
                                if ($status->message_code == 'multiple_rto') {
                                    $statusCode = 101;
                                    $errorMessage = 'RC Number in Multiple RTOs.';
                                } else {
                                    $statusCode = 102;
                                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                }
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            } else {
                                $statusCode = 500;
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            }
                            if ($user->role_id == 1) {
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => $statusCode,
                                    'rc_number' => $rcNumber,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                    'service_provider' => $service_provider,
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }
                } else {
                    return response()->json(['statusCode' => 102, 'message' => 'Verification Failed. Please enter correct State Code.']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json([['rc_validation' => $rc_validation, 'statusCode' => $statusCode]]);
    }
    public function rc_validation_new_lite29dec2023(Request $request)
    {

        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        $service_provider = "softpay";

        if (empty($request->rc_number))
            return response()->json(array(['statusCode' => '404', 'message' => 'RC number is required']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['statusCode' => '404', 'message' => 'Header Access Token is required']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rcvallite')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
        ];


        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // return  $api_id;
        if ($updateHitCount || $user->role_id == 0) {
            // return 'false';
            $rcNumber = str_replace('-', '', $request->rc_number);
            $subString = strtoupper(substr($rcNumber, 0, 2));

            if ($subString == "AP" || $subString == "AR" || $subString == "AS" || $subString == "BR" || $subString == "CG" || $subString == "GA" || $subString == "GJ" || $subString == "HR" || $subString == "HP" || $subString == "JH" || $subString == "KA" || $subString == "KL" || $subString == "MP" || $subString == "MH" || $subString == "MN" || $subString == "ML" || $subString == "MZ" || $subString == "NL" || $subString == "OD" || $subString == "PB" || $subString == "RJ" || $subString == "SK" || $subString == "TN" || $subString == "TR" || $subString == "UP" || $subString == "UK" || $subString == "UA" || $subString == "WB" || $subString == "TS" || $subString == "AN" || $subString == "CH" || $subString == "DN" || $subString == "DD" || $subString == "JK" || $subString == "LA" || $subString == "LD" || $subString == "DL" || $subString == "PY") {
                // return 'true';
                $currentMonth = date('Y-m');
                $rcdata = DB::table('rcvalidation')->where('rc_number', $rcNumber)->where('hit_month', $currentMonth)->where('status_code', '200')->orderby('id', 'DESC')->first();
                // return $rcdata; 
                if (!empty($rcdata) && ($rcdata->rc_status != '' || $rcdata->rc_status != null)) {
                    $prt = '**';
                    $space = ' ';
                    $str = $rcdata->owner_name;
                    $nameowner = (explode(" ", $str));
                    $ownerfirstname = $nameowner[0][0] . $prt . $nameowner[0][2] . $prt . $space;
                    $ownersecoundname = $nameowner[1][0] . $prt . $nameowner[1][2] . $prt . $space;
                    // $ownerthirdname =  $nameowner[2][0].$prt.$nameowner[2][0].$prt;
                    $allname = $ownerfirstname . $ownersecoundname;
                    // return 'ok not test';

                    $insuransespace = "-";
                    $updatedate = "2023";
                    $rcinsurance = $rcdata->insurance_upto;
                    $newrcinsurance = (explode("-", $rcinsurance));
                    $allinsurance = $updatedate . $insuransespace . $newrcinsurance[1] . $insuransespace . $newrcinsurance[2];

                    $statusCode = 200;
                    $rc_validation['data']['rc_number'] = $rcdata->rc_number;
                    $rc_validation['data']['rc_status'] = $rcdata->rc_status;
                    $rc_validation['data']['manufacturing_date'] = $rcdata->manufacturing_date;
                    if ($newrcinsurance[0] < 2022) {
                        $rc_validation['data']['insurance_upto'] = $allinsurance;
                    } else {
                        $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                    }
                    $rc_validation['data']['owner_name'] = $allname;
                    // $rc_validation['data']['permanent_address'] = $rcdata->permanent_address;
                    $rc_validation['data']['pucc_upto'] = $rcdata->pucc_upto;
                    // $rc_validation['data']['maker_model'] = $rcdata->maker_model;
                    // $rc_validation['data']['maker_description'] = $rcdata->maker_description;
                    $rc_validation['data']['vehicle_category'] = $rcdata->vehicle_category;
                    $rc_validation['data']['fit_up_to'] = $rcdata->fit_up_to;
                    $rc_validation['data']['tax_upto'] = $rcdata->tax_upto;
                    $rc_validation['data']['message_code'] = $rcdata->message_code;
                    $rc_validation['data']['fuel_type'] = $rcdata->fuel_type;
                    $rc_validation['data']['registered_at'] = $rcdata->registered_at;
                    $rc_validation['data']['registration_date'] = $rcdata->registration_date;
                    $rc_validation['status_code'] = 200;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $rc_validation['data']['client_id'],
                            "status_code" => 200,
                            "rc_number" => $rcdata->rc_number,
                            "rc_status" => $rcdata->rc_status,
                            "owner_number" => $rcdata->owner_number,
                            "tax_upto" => $rcdata->tax_upto,
                            "blacklist_status" => $rcdata->blacklist_status,
                            "father_name" => $rcdata->father_name,
                            "registration_date" => $rcdata->registration_date,
                            "owner_name" => $rcdata->owner_name,
                            "present_address" => $rcdata->present_address,
                            "permanent_address" => $rcdata->permanent_address,
                            "mobile_number" => $rcdata->mobile_number,
                            "vehicle_category" => $rcdata->vehicle_category,
                            "vehicle_chasi_number" => $rcdata->vehicle_chasi_number,
                            "vehicle_engine_number" => $rcdata->vehicle_engine_number,
                            "maker_description" => $rcdata->maker_description,
                            "maker_model" => $rcdata->maker_model,
                            "body_type" => $rcdata->body_type,
                            "fuel_type" => $rcdata->fuel_type,
                            "color" => $rcdata->color,
                            "norms_type" => $rcdata->norms_type,
                            "fit_up_to" => $rcdata->fit_up_to,
                            "financer" => $rcdata->financer,
                            "insurance_company" => $rcdata->insurance_company,
                            "insurance_policy_number" => $rcdata->insurance_policy_number,
                            "insurance_upto" => $rcdata->insurance_upto,
                            "manufacturing_date" => $rcdata->manufacturing_date,
                            "registered_at" => $rcdata->registered_at,
                            "less_info" => 1,
                            "cubic_capacity" => $rcdata->cubic_capacity,
                            "vehicle_gross_weight" => $rcdata->vehicle_gross_weight,
                            "no_cylinders" => $rcdata->no_cylinders,
                            "seat_capacity" => $rcdata->seat_capacity,
                            "sleeper_capacity" => $rcdata->sleeper_capacity,
                            "standing_capacity" => $rcdata->standing_capacity,
                            "wheelbase" => $rcdata->wheelbase,
                            "unladen_weight" => $rcdata->unladen_weight,
                            "vehicle_category_description" => $rcdata->vehicle_category_description,
                            "pucc_number" => $rcdata->pucc_number,
                            "pucc_upto" => $rcdata->pucc_upto,
                            'hit_month' => date('Y-m'),
                            'national_permit_issued_by' => $rcdata->national_permit_issued_by,
                            'national_permit_number' => $rcdata->national_permit_number,
                            'national_permit_upto' => $rcdata->national_permit_upto,
                            'permit_type' => $rcdata->permit_type,
                            'permit_valid_from' => $rcdata->permit_valid_from,
                            'permit_number' => $rcdata->permit_number,
                            'permit_valid_upto' => $rcdata->permit_valid_upto,
                            'permit_issue_date' => $rcdata->permit_issue_date,
                            'noc_details' => $rcdata->noc_details,
                            'latest_by' => $rcdata->latest_by,
                            'message_code' => $rcdata->message_code,
                            'non_use_to' => $rcdata->non_use_to,
                            'non_use_from' => $rcdata->non_use_from,
                            'non_use_status' => $rcdata->non_use_status,
                            // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now(),
                            'service_provider' => 'database'
                        ]);
                    }
                } else {
                    // return 'ok test';
                    try {
                        $rc_validation = [];
                        $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number=' . $rcNumber, ['headers' => $headers]);
                        $rc_validation1 = json_decode($res->getBody(), true);

                        if ($rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA' && Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->isPast() == true) {
                            $rc_validation['data']['rc_status'] = '';
                        } else {
                            $rc_validation['data']['rc_status'] = 'ACTIVE';
                        }

                        if ($rc_validation1['error_code'] == "SPC-200") {
                            $prt = '**';
                            $space = ' ';
                            $str = $rc_validation1['vehicleDetails']['rcOwnerName'];
                            $nameowner = (explode(" ", $str));
                            // return $nameowner;
                            $ownerfirstname = $nameowner[0][0] . $prt . $nameowner[0][2] . $prt . $space;
                            $ownersecoundname = $nameowner[1][0] . $prt . $nameowner[1][2] . $prt . $space;
                            // $ownerthirdname =  $nameowner[2][0].$prt.$nameowner[2][2].$prt;
                            $allname = $ownerfirstname . $ownersecoundname;

                            $insuransespace = "-";
                            $updatedate = "2023";
                            $rcinsurance = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                            $newrcinsurance = (explode("-", $rcinsurance));
                            $allinsurance = $newrcinsurance[0] . $insuransespace . $newrcinsurance[1] . $insuransespace . $updatedate;
                            // return  $allname;

                            $statusCode = 200;
                            $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['vehicleNumber'];
                            $rc_validation['data']['manufacturing_date'] = $rc_validation1['vehicleDetails']['rcManuMonthYr'];
                            if (isset($rc_validation1['vehicleDetails']['rcInsuranceUpto']) && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != null && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != "null" && $rc_validation1['vehicleDetails']['rcInsuranceUpto'] != 'NA') {
                                if ($newrcinsurance[2] < 2022) {
                                    $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                } else {
                                    $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcInsuranceUpto'])->format('Y-m-d');
                                }
                            } else {
                                $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                            }
                            $rc_validation['data']['owner_name'] = $allname;
                            if (isset($rc_validation1['vehicleDetails']['rcPuccUpto']) && $rc_validation1['vehicleDetails']['rcPuccUpto'] != null && $rc_validation1['vehicleDetails']['rcPuccUpto'] != "null" && $rc_validation1['vehicleDetails']['rcPuccUpto'] != 'NA') {
                                $rc_validation['data']['pucc_upto'] = Carbon::parse($rc_validation1['vehicleDetails']['rcPuccUpto'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['pucc_upto'] = $rc_validation1['vehicleDetails']['rcPuccUpto'];
                            }
                            if (isset($rc_validation1['vehicleDetails']['rcFitUpto']) && $rc_validation1['vehicleDetails']['rcFitUpto'] != null && $rc_validation1['vehicleDetails']['rcFitUpto'] != "null" && $rc_validation1['vehicleDetails']['rcFitUpto'] != 'NA') {
                                $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['vehicleDetails']['rcFitUpto'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['fit_up_to'] = $rc_validation1['vehicleDetails']['rcFitUpto'];
                            }

                            $rc_validation['data']['vehicle_category'] = $rc_validation1['vehicleDetails']['rcVchCatg'];
                            $rc_validation['data']['tax_upto'] = $rc_validation1['vehicleDetails']['rcTaxUpto'];
                            $rc_validation['data']['message_code'] = $rc_validation1['vehicleDetails']['stautsmessage'];
                            $rc_validation['data']['fuel_type'] = $rc_validation1['vehicleDetails']['rcFuelDesc'];
                            $rc_validation['data']['registered_at'] = $rc_validation1['vehicleDetails']['rcRegisteredAt'];
                            if (isset($rc_validation1['vehicleDetails']['rcRegnDt']) && $rc_validation1['vehicleDetails']['rcRegnDt'] != null && $rc_validation1['vehicleDetails']['rcRegnDt'] != "null" && $rc_validation1['vehicleDetails']['rcRegnDt'] != 'NA') {
                                $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['vehicleDetails']['rcRegnDt'])->format('Y-m-d');
                            } else {
                                $rc_validation['data']['registration_date'] = $rc_validation1['vehicleDetails']['rcRegnDt'];
                            }

                            $rc_validation['status_code'] = 200;
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    // "client_id"=> $rc_validation['data']['client_id'],
                                    "status_code" => 200,
                                    "rc_number" => $rc_validation1['vehicleDetails']['vehicleNumber'],
                                    "rc_status" => $rc_validation1['vehicleDetails']['rcStatus'],
                                    "owner_number" => $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'],
                                    "tax_upto" => $rc_validation1['vehicleDetails']['rcTaxUpto'],
                                    "blacklist_status" => $rc_validation1['vehicleDetails']['rcBlacklistStatus'],
                                    "father_name" => $rc_validation1['vehicleDetails']['rcFName'],
                                    "registration_date" => $rc_validation['data']['registration_date'],
                                    "owner_name" => $rc_validation1['vehicleDetails']['rcOwnerName'],
                                    "present_address" => $rc_validation1['vehicleDetails']['rcPresentAddress'],
                                    "permanent_address" => $rc_validation1['vehicleDetails']['rcPermanentAddress'],
                                    "mobile_number" => $rc_validation1['vehicleDetails']['rcMobileNo'],
                                    "vehicle_category" => $rc_validation1['vehicleDetails']['rcVchCatg'],
                                    "vehicle_chasi_number" => $rc_validation1['vehicleDetails']['rcChasiNo'],
                                    "vehicle_engine_number" => $rc_validation1['vehicleDetails']['rcEngNo'],
                                    "maker_description" => $rc_validation1['vehicleDetails']['rcMakerDesc'],
                                    "maker_model" => $rc_validation1['vehicleDetails']['rcMakerModel'],
                                    "body_type" => $rc_validation1['vehicleDetails']['rcBodyTypeDesc'],
                                    "fuel_type" => $rc_validation1['vehicleDetails']['rcFuelDesc'],
                                    "color" => $rc_validation1['vehicleDetails']['rcColor'],
                                    "norms_type" => $rc_validation1['vehicleDetails']['rcNormsDesc'],
                                    "fit_up_to" => $rc_validation['data']['fit_up_to'],
                                    "financer" => $rc_validation1['vehicleDetails']['rcFinancer'],
                                    "insurance_company" => $rc_validation1['vehicleDetails']['rcInsuranceComp'],
                                    "insurance_policy_number" => $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'],
                                    "insurance_upto" => $rc_validation['data']['insurance_upto'],
                                    "manufacturing_date" => $rc_validation1['vehicleDetails']['rcManuMonthYr'],
                                    "registered_at" => $rc_validation1['vehicleDetails']['rcRegisteredAt'],
                                    "less_info" => 1,
                                    "cubic_capacity" => $rc_validation1['vehicleDetails']['rcCubicCap'],
                                    "vehicle_gross_weight" => $rc_validation1['vehicleDetails']['rcGvw'],
                                    "no_cylinders" => $rc_validation1['vehicleDetails']['rcNoCyl'],
                                    "seat_capacity" => $rc_validation1['vehicleDetails']['rcSeatCap'],
                                    "sleeper_capacity" => $rc_validation1['vehicleDetails']['rcSleeperCap'],
                                    "standing_capacity" => $rc_validation1['vehicleDetails']['rcStandCap'],
                                    "wheelbase" => $rc_validation1['vehicleDetails']['rcWheelbase'],
                                    "unladen_weight" => $rc_validation1['vehicleDetails']['rcUnldWt'],
                                    "vehicle_category_description" => $rc_validation1['vehicleDetails']['rcVhClassDesc'],
                                    "pucc_number" => $rc_validation1['vehicleDetails']['rcPuccNo'],
                                    "pucc_upto" => $rc_validation['data']['pucc_upto'],
                                    'hit_month' => date('Y-m'),
                                    'national_permit_issued_by' => $rc_validation1['vehicleDetails']['rcNpIssuedBy'],
                                    'national_permit_number' => $rc_validation1['vehicleDetails']['rcNpNo'],
                                    'national_permit_upto' => $rc_validation1['vehicleDetails']['rcNpUpto'],
                                    'permit_type' => $rc_validation1['vehicleDetails']['rcPermitType'],
                                    'permit_valid_from' => $rc_validation1['vehicleDetails']['rcPermitValidFrom'],
                                    'permit_number' => $rc_validation1['vehicleDetails']['rcPermitNo'],
                                    'permit_valid_upto' => $rc_validation1['vehicleDetails']['rcPermitValidUpto'],
                                    'permit_issue_date' => $rc_validation1['vehicleDetails']['rcPermitIssueDt'],
                                    'noc_details' => $rc_validation1['vehicleDetails']['rcNocDetails'],
                                    'latest_by' => $rc_validation1['vehicleDetails']['rcStatusAsOn'],
                                    'message_code' => $rc_validation1['vehicleDetails']['stautsmessage'],
                                    'non_use_to' => $rc_validation1['vehicleDetails']['rcNonUseTo'],
                                    'non_use_from' => $rc_validation1['vehicleDetails']['rcNonUseFrom'],
                                    'non_use_status' => $rc_validation1['vehicleDetails']['rcNonUseStatus'],
                                    // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now(),
                                    'service_provider' => $service_provider
                                ]);
                            }
                        }
                        // else if($rc_validation1['error_code'] == "SPC-201"){
                        //     $statusCode = 500;
                        //     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        //     if($user->role_id==1) {
                        //         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        //         $rcvalidation = DB::table('rcvalidation')->insert([
                        //             "user_id"=> $user->id,
                        //             "api_id"=> $api_id,
                        //             "status_code"=> $statusCode,
                        //             "rc_number"=> $rcNumber,
                        //             "created_at"=> Carbon::now(),
                        //             "updated_at"=> Carbon::now(),
                        //             'service_provider'=> $service_provider
                        //         ]);
                        //     }
                        //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                        // }
                        else if ($rc_validation1['error_code'] == "SPC-203" || $rc_validation1['error_code'] == "SPC-206" || $rc_validation1['error_code'] == "SPC-201") {
                            // return 'tester';
                            $statusCode = 102;
                            if ($rc_validation1['error_code'] == "SPC-203" && $rc_validation1['message'] != 'Record not found') {
                                $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        "status_code" => $statusCode,
                                        "rc_number" => $rcNumber,
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),
                                        'service_provider' => $service_provider
                                    ]);
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            } else {

                                try {
                                    // return 'try';
                                    $client = new Client();
                                    // $rcnomber = 'MH16AJ1013';
                                    $blacklistcheck = 'true';
                                    // $headerss = [
                                    //     // 'Authorization' => $this->nsdlToken,        
                                    //     'secretKey' => 'pI76u95BabjkIFg6DNNRole7gZn71ljPk7W5WIHzApjlObIMywuq8pZGa30HXm5wR',   
                                    //     'clientId' => 'ef41c6d7089614d1838c68efc81a8493:dc983c1bfbc4390f4952bd44ed0ae690'
                                    // ];

                                    // // return 'test the try in try';
                                    // $rc_validation = [];
                                    // $res = $client->post('https://api.emptra.com/vehicleRegistrationsV3', ['headers' => $headerss, 'form_params'=> ['vehicleNumber'=>$request->rc_number,'blacklistCheck'=>$blacklistcheck]]);
                                    // $rc_validation1 = json_decode($res->getBody(), true);


                                    $url = 'https://api.emptra.com/vehicleRegistrationsV2';

                                    $data = array(
                                        "vehicleNumber" => $request->rc_number,
                                    );

                                    $body = json_encode($data);

                                    $ch = curl_init($url);

                                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                                    curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: " . $this->secretKey, "clientId: " . $this->clientId, 'Content-Type:application/json'));
                                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                                    $get_data1 = curl_exec($ch);
                                    $rc_validation1 = json_decode($get_data1, true);
                                    // return $rc_validation1;


                                    // return $rc_validation1['result']['rcExpiryDate'];
                                    // $rc_validation1 = json_decode($result['vehicleDetails'], true);
                                    // if(isset($rc_validation1['error_code'])){
                                    //     $statusCode = 200;
                                    // }
                                    // $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
                                    // if($grossWeight){
                                    //     $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
                                    //     // $checkWeight = array("tag_class"=>$checkWeight->tag_class);
                                    //     $checkweight = array();
                                    //     $checkweight['tag_class'] = $checkWeight->tag_class;
                                    // }else{
                                    //     $checkweight['tag_class'] = '';
                                    // }
                                    // if($rc_validation1['result']['rcExpiryDate'] != null && $rc_validation1['result']['rcExpiryDate'] != 'NA'){
                                    //     $rc_validation['data']['rc_status'] = '';
                                    // }else{
                                    //     $rc_validation['data']['rc_status'] = 'ACTIVE';
                                    // }

                                    // $rc_validation['vehicleDetails']=array_merge($rc_validation['data'],$checkweight );
                                    if ($rc_validation1['code'] == "100" || $rc_validation1['code'] == "200") {

                                        $prt = '**';
                                        $space = ' ';
                                        $str = $rc_validation1['result']['owner_name'];
                                        $nameowner = (explode(" ", $str));
                                        $ownerfirstname = $nameowner[0][0] . $prt . $nameowner[0][2] . $prt . $space;
                                        $ownersecoundname = $nameowner[1][0] . $prt . $nameowner[1][2] . $prt . $space;
                                        // $ownerthirdname =  $nameowner[2][0].$prt.$nameowner[2][2].$prt;
                                        $allname = $ownerfirstname . $ownersecoundname;

                                        // return $rc_validation1['result'];

                                        $insuransespace = "-";
                                        $updatedate = "2023";
                                        $rcinsurance = $rc_validation1['result']['insurance_upto'];
                                        // return $rcinsurance;
                                        $newrcinsurance = (explode("-", $rcinsurance));
                                        // return $newrcinsurance;
                                        $allinsurance = $newrcinsurance[0] . $insuransespace . $newrcinsurance[1] . $insuransespace . $updatedate;
                                        // return $allinsurance;

                                        $statusCode = 200;
                                        $rc_validation['data']['rc_number'] = $rc_validation1['result']['rc_number'];
                                        $rc_validation['data']['manufacturing_date'] = $rc_validation1['result']['manufacturing_date'];
                                        if (isset($rc_validation1['result']['insurance_upto']) && $rc_validation1['result']['insurance_upto'] != null && $rc_validation1['result']['insurance_upto'] != "null" && $rc_validation1['result']['insurance_upto'] != 'NA') {
                                            if ($newrcinsurance[0] < 2022) {
                                                $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                            } else {
                                                $rc_validation['data']['insurance_upto'] = Carbon::parse($rc_validation1['result']['insurance_upto'])->format('Y-m-d');
                                            }
                                        } else {
                                            $rc_validation['data']['insurance_upto'] = Carbon::parse($allinsurance)->format('Y-m-d');
                                        }
                                        $rc_validation['data']['owner_name'] = $allname;
                                        if (isset($rc_validation1['result']['pucc_upto']) && $rc_validation1['result']['pucc_upto'] != null && $rc_validation1['result']['pucc_upto'] != "null" && $rc_validation1['result']['pucc_upto'] != 'NA') {
                                            // $rc_validation['data']['pucc_upto'] = Carbon::createFromFormat('d/m/Y', $rc_validation1['result']['pucc_upto'])->format('Y-m-d');
                                            $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['pucc_upto'];
                                        } else {
                                            $rc_validation['data']['pucc_upto'] = $rc_validation1['result']['pucc_upto'];
                                        }
                                        if (isset($rc_validation1['result']['fit_up_to']) && $rc_validation1['result']['fit_up_to'] != null && $rc_validation1['result']['fit_up_to'] != "null" && $rc_validation1['result']['fit_up_to'] != 'NA') {
                                            // $rc_validation['data']['fit_up_to'] = Carbon::parse($rc_validation1['result']['fit_up_to'])->format('Y-m-d');
                                            $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['fit_up_to'];

                                        } else {
                                            $rc_validation['data']['fit_up_to'] = $rc_validation1['result']['fit_up_to'];
                                        }
                                    }

                                    $rc_validation['data']['vehicle_category'] = $rc_validation1['result']['vehicle_category'];
                                    $rc_validation['data']['tax_upto'] = $rc_validation1['result']['tax_upto'];
                                    $rc_validation['data']['message_code'] = 'NA';
                                    $rc_validation['data']['fuel_type'] = $rc_validation1['result']['fuel_type'];
                                    $rc_validation['data']['registered_at'] = $rc_validation1['result']['registered_at'];
                                    ;
                                    if (isset($rc_validation1['result']['registration_date']) && $rc_validation1['result']['registration_date'] != null && $rc_validation1['result']['registration_date'] != "null" && $rc_validation1['result']['registration_date'] != 'NA') {
                                        $rc_validation['data']['registration_date'] = Carbon::parse($rc_validation1['result']['registration_date'])->format('Y-m-d');
                                    } else {
                                        $rc_validation['data']['registration_date'] = $rc_validation1['result']['registration_date'];
                                    }

                                    $rc_validation['status_code'] = 200;
                                    if ($user->role_id == 1) {
                                        if ($apiamster) {
                                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                        }
                                        // return  $rc_validation['result'];
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            "user_id" => $user->id,
                                            "api_id" => $api_id,
                                            // "client_id"=> $rc_validation['data']['client_id'],
                                            "status_code" => 200,
                                            "rc_number" => $rc_validation1['result']['rc_number'],
                                            "rc_status" => $rc_validation1['result']['rc_status'],
                                            "owner_number" => $rc_validation1['result']['owner_number'],
                                            "tax_upto" => $rc_validation1['result']['tax_upto'],
                                            "blacklist_status" => $rc_validation1['result']['blacklist_status'],
                                            "father_name" => $rc_validation1['result']['father_name'],
                                            "registration_date" => $rc_validation['data']['registration_date'],
                                            "owner_name" => $rc_validation1['result']['owner_name'],
                                            "present_address" => $rc_validation1['result']['present_address'],
                                            "permanent_address" => $rc_validation1['result']['permanent_address'],
                                            "mobile_number" => $rc_validation1['result']['mobile_number'],
                                            "vehicle_category" => $rc_validation1['result']['vehicle_category'],
                                            "vehicle_chasi_number" => $rc_validation1['result']['vehicle_chasi_number'],
                                            "vehicle_engine_number" => $rc_validation1['result']['vehicle_engine_number'],
                                            "maker_description" => $rc_validation1['result']['maker_description'],
                                            "maker_model" => $rc_validation1['result']['maker_model'],
                                            "body_type" => $rc_validation1['result']['body_type'],
                                            "fuel_type" => $rc_validation1['result']['fuel_type'],
                                            "color" => $rc_validation1['result']['color'],
                                            "norms_type" => $rc_validation1['result']['norms_type'],
                                            "fit_up_to" => $rc_validation['data']['fit_up_to'],
                                            "financer" => $rc_validation1['result']['fit_up_to'],
                                            "insurance_company" => $rc_validation1['result']['insurance_company'],
                                            "insurance_policy_number" => $rc_validation1['result']['insurance_policy_number'],
                                            "insurance_upto" => $rc_validation['data']['insurance_upto'],
                                            "manufacturing_date" => $rc_validation1['result']['manufacturing_date'],
                                            "registered_at" => $rc_validation1['result']['registered_at'],
                                            "less_info" => 1,
                                            "cubic_capacity" => $rc_validation1['result']['cubic_capacity'],
                                            "vehicle_gross_weight" => $rc_validation1['result']['vehicle_gross_weight'],
                                            "no_cylinders" => $rc_validation1['result']['no_cylinders'],
                                            "seat_capacity" => $rc_validation1['result']['seat_capacity'],
                                            "sleeper_capacity" => $rc_validation1['result']['sleeper_capacity'],
                                            "standing_capacity" => $rc_validation1['result']['standing_capacity'],
                                            "wheelbase" => $rc_validation1['result']['wheelbase'],
                                            "unladen_weight" => $rc_validation1['result']['unladen_weight'],
                                            "vehicle_category_description" => $rc_validation1['result']['vehicle_category_description'],
                                            "pucc_number" => $rc_validation1['result']['pucc_number'],
                                            "pucc_upto" => $rc_validation['data']['pucc_upto'],
                                            'hit_month' => date('Y-m'),
                                            'national_permit_issued_by' => $rc_validation1['result']['national_permit_issued_by'],
                                            'national_permit_number' => $rc_validation1['result']['national_permit_number'],
                                            'national_permit_upto' => $rc_validation1['result']['national_permit_upto'],
                                            'permit_type' => $rc_validation1['result']['permit_type'],
                                            'permit_valid_from' => $rc_validation1['result']['permit_valid_from'],
                                            'permit_number' => $rc_validation1['result']['permit_number'],
                                            'permit_valid_upto' => $rc_validation1['result']['permit_valid_upto'],
                                            'permit_issue_date' => $rc_validation1['result']['permit_issue_date'],
                                            'noc_details' => $rc_validation1['result']['noc_details'],
                                            'latest_by' => $rc_validation1['result']['latest_by'],
                                            'message_code' => 'NA',
                                            'non_use_to' => $rc_validation1['result']['non_use_to'],
                                            'non_use_from' => $rc_validation1['result']['non_use_from'],
                                            'non_use_status' => $rc_validation1['result']['non_use_status'],
                                            // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                            "created_at" => Carbon::now(),
                                            "updated_at" => Carbon::now(),
                                            'service_provider' => 'emptra'
                                        ]);
                                    } else if ($rc_validation1['code'] == "200" || $rc_validation1['code'] == "103") {
                                        $statusCode = 500;
                                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                        if ($user->role_id == 1) {
                                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                            $rcvalidation = DB::table('rcvalidation')->insert([
                                                "user_id" => $user->id,
                                                "api_id" => $api_id,
                                                "status_code" => $statusCode,
                                                "rc_number" => $rcNumber,
                                                "created_at" => Carbon::now(),
                                                "updated_at" => Carbon::now(),
                                                'service_provider' => $service_provider
                                            ]);
                                        }
                                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                    } else if ($rc_validation1['code'] == "400") {
                                        $statusCode = 102;
                                        $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                        if ($user->role_id == 1) {
                                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                            $rcvalidation = DB::table('rcvalidation')->insert([
                                                "user_id" => $user->id,
                                                "api_id" => $api_id,
                                                "status_code" => $statusCode,
                                                "rc_number" => $rcNumber,
                                                "created_at" => Carbon::now(),
                                                "updated_at" => Carbon::now(),
                                                'service_provider' => $service_provider
                                            ]);
                                        }
                                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                    } else {
                                        // if(isset($rc_validation['message']) && $rc_validation['message'] != 'success')
                                        if ($rc_validation1['code'] != '100') {
                                            if ($rc_validation1['code'] == 404 || $rc_validation1['code'] == 502 || $rc_validation1['code'] == 500) {
                                                // $statusCode = 101;
                                                // $errorMessage = 'RC Number in Multiple RTOs.';
                                                // }else if($rc_validation['reponseCode'] == 502){
                                                $statusCode = 102;
                                                $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                            } else if ($rc_validation1['code'] == '104') {
                                                $statusCode = 500;
                                                $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                            } else {
                                                $statusCode = 404;
                                                $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                            }
                                            if ($user->role_id == 1) {
                                                if ($apiamster) {
                                                    // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                                }
                                                $rcvalidation = DB::table('rcvalidation')->insert([
                                                    "user_id" => $user->id,
                                                    "api_id" => $api_id,
                                                    "status_code" => $statusCode,
                                                    "rc_number" => $rcNumber,
                                                    "created_at" => Carbon::now(),
                                                    "updated_at" => Carbon::now(),
                                                    'service_provider' => $service_provider
                                                ]);
                                            }
                                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                        }
                                    }
                                } catch (\GuzzleHttp\Exception\RequestException $e) {
                                    $response = $e->getResponse();
                                    $status = json_decode((string) $response->getBody());
                                    $statusCode = $e->getResponse()->getStatusCode();
                                    if ($statusCode == 500 || $statusCode == 401) {
                                        $statusCode = 102;
                                        $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                                        // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                        if ($user->role_id == 1) {
                                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                        }
                                    } else if ($statusCode == 403) {
                                        if ($status->message_code == 'multiple_rto') {
                                            $statusCode = 101;
                                            $errorMessage = 'RC Number in Multiple RTOs.';
                                        } else {
                                            $statusCode = 102;
                                            $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                        }
                                        if ($user->role_id == 1) {
                                            if ($apiamster) {
                                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                            }
                                        }
                                    } else {
                                        $statusCode = 500;
                                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                        if ($user->role_id == 1) {
                                            if ($apiamster) {
                                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                            }
                                        }
                                    }
                                    if ($user->role_id == 1) {
                                        $rcvalidation = DB::table('rcvalidation')->insert([
                                            "user_id" => $user->id,
                                            "api_id" => $api_id,
                                            "status_code" => $statusCode,
                                            "rc_number" => $rcNumber,
                                            "created_at" => Carbon::now(),
                                            "updated_at" => Carbon::now(),
                                            'service_provider' => $service_provider
                                        ]);
                                    }
                                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                                }
                            }
                        } else {
                            if (isset($rc_validation['message']) && $rc_validation['message'] != 'success') {
                                if ($rc_validation['error_code'] == 401 || $rc_validation['error_code'] == 502 || $rc_validation['error_code'] == 500) {
                                    // $statusCode = 101;
                                    // $errorMessage = 'RC Number in Multiple RTOs.';
                                    // }else if($rc_validation['reponseCode'] == 502){
                                    $statusCode = 102;
                                    $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                                } else if ($rc_validation['error_code'] == 'SPC-201') {
                                    $statusCode = 500;
                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                } else {
                                    $statusCode = 404;
                                    $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                                }
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        // $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                    $rcvalidation = DB::table('rcvalidation')->insert([
                                        "user_id" => $user->id,
                                        "api_id" => $api_id,
                                        "status_code" => $statusCode,
                                        "rc_number" => $rcNumber,
                                        "created_at" => Carbon::now(),
                                        "updated_at" => Carbon::now(),
                                        'service_provider' => $service_provider
                                    ]);
                                }
                                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                            }
                        }
                    } catch (\GuzzleHttp\Exception\RequestException $e) {
                        $response = $e->getResponse();
                        $status = json_decode((string) $response->getBody());
                        $statusCode = $e->getResponse()->getStatusCode();
                        if ($statusCode == 500 || $statusCode == 401) {
                            $statusCode = 102;
                            $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                            // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 403) {
                            if ($status->message_code == 'multiple_rto') {
                                $statusCode = 101;
                                $errorMessage = 'RC Number in Multiple RTOs.';
                            } else {
                                $statusCode = 102;
                                $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                            }
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $statusCode = 500;
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        if ($user->role_id == 1) {
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "status_code" => $statusCode,
                                "rc_number" => $rcNumber,
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now(),
                                'service_provider' => $service_provider
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 102, 'message' => 'Verification Failed. Please enter correct State Code.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
    }



    public function rc_full_validation(Request $request)
    {
        $statusCode = null;
        $rc_validation = null;
        $api_id = null;
        if (empty($request->rc_number))
            return response()->json(array(['message' => 'RC number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'rcfull')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'id_number' => $request->rc_number
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $currentMonth = date('Y-m');
                    // $rcdata = DB::table('rcvalidation')->where('rc_number', $request->rc_number)->where('hit_month', $currentMonth)->where('status_code', '200')->orderby('id', 'DESC')->first();
                    // if(!empty($rcdata)){
                    //     $statusCode = 200;
                    //     $rc_validation['data']['rc_number'] = $rcdata->rc_number;
                    //     $rc_validation['data']['norms_type'] = $rcdata->norms_type;
                    //     $rc_validation['data']['rc_status'] = $rcdata->rc_status;
                    //     $rc_validation['data']['vehicle_gross_weight'] = $rcdata->vehicle_gross_weight;
                    //     $rc_validation['data']['unladen_weight'] = $rcdata->unladen_weight;
                    //     $rc_validation['data']['manufacturing_date'] = $rcdata->manufacturing_date;
                    //     $rc_validation['data']['seat_capacity'] = $rcdata->seat_capacity;
                    //     $rc_validation['data']['national_permit_issued_by'] = $rcdata->national_permit_issued_by;
                    //     $rc_validation['data']['national_permit_number'] = $rcdata->national_permit_number;
                    //     $rc_validation['data']['national_permit_upto'] = $rcdata->national_permit_upto;
                    //     $rc_validation['data']['insurance_company'] = $rcdata->insurance_company;
                    //     $rc_validation['data']['insurance_policy_number'] = $rcdata->insurance_policy_number;
                    //     $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                    //     $rc_validation['data']['permit_type'] = $rcdata->permit_type;
                    //     $rc_validation['data']['permit_valid_from'] = $rcdata->permit_valid_from;
                    //     $rc_validation['data']['permit_number'] = $rcdata->permit_number;
                    //     $rc_validation['data']['permit_valid_upto'] = $rcdata->permit_valid_upto;
                    //     $rc_validation['data']['permit_issue_date'] = $rcdata->permit_issue_date;
                    //     $rc_validation['data']['noc_details'] = $rcdata->noc_details;
                    //     $rc_validation['data']['body_type'] = $rcdata->body_type;
                    //     $rc_validation['data']['father_name'] = $rcdata->father_name;
                    //     $rc_validation['data']['owner_name'] = $rcdata->owner_name;
                    //     $rc_validation['data']['permanent_address'] = $rcdata->permanent_address;
                    //     $rc_validation['data']['present_address'] = $rcdata->present_address;
                    //     $rc_validation['data']['pucc_number'] = $rcdata->pucc_number;
                    //     $rc_validation['data']['pucc_upto'] = $rcdata->pucc_upto;
                    //     $rc_validation['data']['blacklist_status'] = $rcdata->blacklist_status;
                    //     $rc_validation['data']['maker_model'] = $rcdata->maker_model;
                    //     $rc_validation['data']['maker_description'] = $rcdata->maker_description;
                    //     $rc_validation['data']['fit_up_to'] = $rcdata->fit_up_to;
                    //     $rc_validation['data']['standing_capacity'] = $rcdata->standing_capacity;
                    //     $rc_validation['data']['sleeper_capacity'] = $rcdata->sleeper_capacity;
                    //     $rc_validation['data']['wheelbase'] = $rcdata->wheelbase;
                    //     $rc_validation['data']['vehicle_category_description'] = $rcdata->vehicle_category_description;
                    //     $rc_validation['data']['vehicle_category'] = $rcdata->vehicle_category;
                    //     $rc_validation['data']['vehicle_chasi_number'] = $rcdata->vehicle_chasi_number;
                    //     $rc_validation['data']['vehicle_engine_number'] = $rcdata->vehicle_engine_number;
                    //     $rc_validation['data']['mobile_number'] = $rcdata->mobile_number;
                    //     $rc_validation['data']['financer'] = $rcdata->financer;
                    //     // $rc_validation['data']['rc_number'] = $rcdata->['code'];
                    //     // $rc_validation['data']['rc_number'] = $rcdata->['stateCd'];
                    //     $rc_validation['data']['latest_by'] = $rcdata->latest_by;
                    //     $rc_validation['data']['tax_upto'] = $rcdata->tax_upto;
                    //     $rc_validation['data']['message_code'] = $rcdata->message_code;
                    //     $rc_validation['data']['non_use_to'] = $rcdata->non_use_to;
                    //     $rc_validation['data']['non_use_from'] = $rcdata->non_use_from;
                    //     $rc_validation['data']['non_use_status'] = $rcdata->non_use_status;
                    //     $rc_validation['data']['fuel_type'] = $rcdata->fuel_type;
                    //     $rc_validation['data']['registered_at'] = $rcdata->registered_at;
                    //     $rc_validation['data']['registration_date'] = $rcdata->registration_date;
                    //     $rc_validation['data']['color'] = $rcdata->color;
                    //     $rc_validation['data']['owner_number'] = $rcdata->owner_number;
                    //     $rc_validation['data']['no_cylinders'] = $rcdata->no_cylinders;
                    //     $rc_validation['data']['cubic_capacity'] = $rcdata->cubic_capacity;
                    //     $rc_validation['status_code'] = 200;
                    //     if($user->role_id==1) {
                    //         if($apiamster) {
                    //             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    //         }
                    //         $rcvalidation = DB::table('rcvalidation')->insert([
                    //             "user_id"=> $user->id,
                    //             "api_id"=> $api_id,
                    //             // "client_id"=> $rc_validation['data']['client_id'],
                    //             "status_code"=> 200,
                    //             "rc_number"=> $rcdata->rc_number,
                    //             "registration_date"=> $rcdata->registration_date,
                    //             "owner_name"=> $rcdata->owner_name,
                    //             "present_address"=> $rcdata->present_address,
                    //             "permanent_address"=> $rcdata->permanent_address,
                    //             "mobile_number"=> $rcdata->mobile_number,
                    //             "vehicle_category"=> $rcdata->vehicle_category,
                    //             "vehicle_chasi_number"=> $rcdata->vehicle_chasi_number,
                    //             "vehicle_engine_number"=> $rcdata->vehicle_engine_number,
                    //             "maker_description"=> $rcdata->maker_description,
                    //             "maker_model"=> $rcdata->maker_model,
                    //             "body_type"=> $rcdata->body_type,
                    //             "fuel_type"=> $rcdata->fuel_type,
                    //             "color"=> $rcdata->color,
                    //             "norms_type"=> $rcdata->norms_type,
                    //             "fit_up_to"=> $rcdata->fit_up_to,
                    //             "financer"=> $rcdata->financer,
                    //             "insurance_company"=> $rcdata->insurance_company,
                    //             "insurance_policy_number"=> $rcdata->insurance_policy_number,
                    //             "insurance_upto"=> $rcdata->insurance_upto,
                    //             "manufacturing_date"=> $rcdata->manufacturing_date,
                    //             "registered_at"=> $rcdata->registered_at,
                    //             "less_info"=> 1,
                    //             "cubic_capacity"=> $rcdata->cubic_capacity,
                    //             "vehicle_gross_weight"=> $rcdata->vehicle_gross_weight,
                    //             "no_cylinders"=> $rcdata->no_cylinders,
                    //             "seat_capacity"=> $rcdata->seat_capacity,
                    //             "sleeper_capacity"=> $rcdata->sleeper_capacity,
                    //             "standing_capacity"=> $rcdata->standing_capacity,
                    //             "wheelbase"=> $rcdata->wheelbase,
                    //             "unladen_weight"=> $rcdata->unladen_weight,
                    //             "vehicle_category_description"=> $rcdata->vehicle_category_description,
                    //             "pucc_number"=> $rcdata->pucc_number,
                    //             "pucc_upto"=> $rcdata->pucc_upto,
                    //             'hit_month'=> date('Y-m'),
                    //             // "masked_name"=> $rc_validation['vehicleDetails']['vehicle']['client_id'],
                    //             "created_at"=> Carbon::now(),
                    //             "updated_at"=> Carbon::now()
                    //         ]);
                    //     }
                    // }else{
                    // return 'testapi';
                    $res = $client->get('https://g2c.softpayapi.com/api/rc_verification/vehicle_verify?apikey=Q79LFVCGJO8370ZXD811MBR0NCAIYU5H35D69KSPW46TB24AE2&agent_code=ABC1234&client_order_id=852741&vehicle_number=' . $request->rc_number, ['headers' => $headers]);
                    $rc_validation1 = json_decode($res->getBody(), true);
                    // return '$rc_validation1';

                    // $rc_validation = json_decode($result['vehicleDetails'], true);
                    if (isset($rc_validation1['error_code'])) {
                        $statusCode = $rc_validation1['error_code'];
                    }

                    if ($rc_validation1['error_code'] == "SPC-200") {
                        $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['vehicleNumber'];
                        $rc_validation['data']['norms_type'] = $rc_validation1['vehicleDetails']['rcNormsDesc'];
                        $rc_validation['data']['rc_status'] = $rc_validation1['vehicleDetails']['rcStatus'];
                        $rc_validation['data']['vehicle_gross_weight'] = $rc_validation1['vehicleDetails']['rcGvw'];
                        $rc_validation['data']['unladen_weight'] = $rc_validation1['vehicleDetails']['rcUnldWt'];
                        $rc_validation['data']['manufacturing_date'] = $rc_validation1['vehicleDetails']['rcManuMonthYr'];
                        $rc_validation['data']['seat_capacity'] = $rc_validation1['vehicleDetails']['rcSeatCap'];
                        $rc_validation['data']['national_permit_issued_by'] = $rc_validation1['vehicleDetails']['rcNpIssuedBy'];
                        $rc_validation['data']['national_permit_number'] = $rc_validation1['vehicleDetails']['rcNpNo'];
                        $rc_validation['data']['national_permit_upto'] = $rc_validation1['vehicleDetails']['rcNpUpto'];
                        $rc_validation['data']['insurance_company'] = $rc_validation1['vehicleDetails']['rcInsuranceComp'];
                        $rc_validation['data']['insurance_policy_number'] = $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'];
                        $rc_validation['data']['insurance_upto'] = $rc_validation1['vehicleDetails']['rcInsuranceUpto'];
                        $rc_validation['data']['permit_type'] = $rc_validation1['vehicleDetails']['rcPermitType'];
                        $rc_validation['data']['permit_valid_from'] = $rc_validation1['vehicleDetails']['rcPermitValidFrom'];
                        $rc_validation['data']['permit_number'] = $rc_validation1['vehicleDetails']['rcPermitNo'];
                        $rc_validation['data']['permit_valid_upto'] = $rc_validation1['vehicleDetails']['rcPermitValidUpto'];
                        $rc_validation['data']['permit_issue_date'] = $rc_validation1['vehicleDetails']['rcPermitIssueDt'];
                        $rc_validation['data']['noc_details'] = $rc_validation1['vehicleDetails']['rcNocDetails'];
                        $rc_validation['data']['body_type'] = $rc_validation1['vehicleDetails']['rcBodyTypeDesc'];
                        $rc_validation['data']['father_name'] = $rc_validation1['vehicleDetails']['rcFName'];
                        $rc_validation['data']['owner_name'] = $rc_validation1['vehicleDetails']['rcOwnerName'];
                        $rc_validation['data']['permanent_address'] = $rc_validation1['vehicleDetails']['rcPermanentAddress'];
                        $rc_validation['data']['present_address'] = $rc_validation1['vehicleDetails']['rcPresentAddress'];
                        $rc_validation['data']['pucc_number'] = $rc_validation1['vehicleDetails']['rcPuccNo'];
                        $rc_validation['data']['pucc_upto'] = $rc_validation1['vehicleDetails']['rcPuccUpto'];
                        $rc_validation['data']['blacklist_status'] = $rc_validation1['vehicleDetails']['rcBlacklistStatus'];
                        $rc_validation['data']['maker_model'] = $rc_validation1['vehicleDetails']['rcMakerModel'];
                        $rc_validation['data']['maker_description'] = $rc_validation1['vehicleDetails']['rcMakerDesc'];
                        $rc_validation['data']['fit_up_to'] = $rc_validation1['vehicleDetails']['rcFitUpto'];
                        $rc_validation['data']['standing_capacity'] = $rc_validation1['vehicleDetails']['rcStandCap'];
                        $rc_validation['data']['sleeper_capacity'] = $rc_validation1['vehicleDetails']['rcSleeperCap'];
                        $rc_validation['data']['wheelbase'] = $rc_validation1['vehicleDetails']['rcWheelbase'];
                        $rc_validation['data']['vehicle_category_description'] = $rc_validation1['vehicleDetails']['rcVhClassDesc'];
                        $rc_validation['data']['vehicle_category'] = $rc_validation1['vehicleDetails']['rcVchCatg'];
                        $rc_validation['data']['vehicle_chasi_number'] = $rc_validation1['vehicleDetails']['rcChasiNo'];
                        $rc_validation['data']['vehicle_engine_number'] = $rc_validation1['vehicleDetails']['rcEngNo'];
                        $rc_validation['data']['mobile_number'] = $rc_validation1['vehicleDetails']['rcMobileNo'];
                        $rc_validation['data']['financer'] = $rc_validation1['vehicleDetails']['rcFinancer'];
                        // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['code'];
                        // $rc_validation['data']['rc_number'] = $rc_validation1['vehicleDetails']['stateCd'];
                        $rc_validation['data']['latest_by'] = $rc_validation1['vehicleDetails']['rcStatusAsOn'];
                        $rc_validation['data']['tax_upto'] = $rc_validation1['vehicleDetails']['rcTaxUpto'];
                        $rc_validation['data']['message_code'] = $rc_validation1['vehicleDetails']['stautsmessage'];
                        $rc_validation['data']['non_use_to'] = $rc_validation1['vehicleDetails']['rcNonUseTo'];
                        $rc_validation['data']['non_use_from'] = $rc_validation1['vehicleDetails']['rcNonUseFrom'];
                        $rc_validation['data']['non_use_status'] = $rc_validation1['vehicleDetails']['rcNonUseStatus'];
                        $rc_validation['data']['fuel_type'] = $rc_validation1['vehicleDetails']['rcFuelDesc'];
                        $rc_validation['data']['registered_at'] = $rc_validation1['vehicleDetails']['rcRegisteredAt'];
                        $rc_validation['data']['registration_date'] = $rc_validation1['vehicleDetails']['rcRegnDt'];
                        $rc_validation['data']['color'] = $rc_validation1['vehicleDetails']['rcColor'];
                        $rc_validation['data']['owner_number'] = $rc_validation1['vehicleDetails']['rcOwnerSrrcStatusAsOn'];
                        $rc_validation['data']['no_cylinders'] = $rc_validation1['vehicleDetails']['rcNoCyl'];
                        $rc_validation['data']['cubic_capacity'] = $rc_validation1['vehicleDetails']['rcCubicCap'];
                        // $rc_validation['status_code'] = $rc_validation1['error_code'];
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $rcvalidation = DB::table('rcvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                // "client_id"=> $rc_validation['data']['client_id'],
                                "status_code" => 200,
                                "rc_number" => $rc_validation1['vehicleDetails']['rcRegnNo'],
                                "registration_date" => $rc_validation1['vehicleDetails']['rcRegnDt'],
                                "owner_name" => $rc_validation1['vehicleDetails']['rcOwnerName'],
                                "present_address" => $rc_validation1['vehicleDetails']['rcPresentAddress'],
                                "permanent_address" => $rc_validation1['vehicleDetails']['rcPermanentAddress'],
                                "mobile_number" => $rc_validation1['vehicleDetails']['rcMobileNo'],
                                "vehicle_category" => $rc_validation1['vehicleDetails']['rcVchCatg'],
                                "vehicle_chasi_number" => $rc_validation1['vehicleDetails']['rcChasiNo'],
                                "vehicle_engine_number" => $rc_validation1['vehicleDetails']['rcEngNo'],
                                "maker_description" => $rc_validation1['vehicleDetails']['rcMakerDesc'],
                                "maker_model" => $rc_validation1['vehicleDetails']['rcMakerModel'],
                                "body_type" => $rc_validation1['vehicleDetails']['rcBodyTypeDesc'],
                                "fuel_type" => $rc_validation1['vehicleDetails']['rcFuelDesc'],
                                "color" => $rc_validation1['vehicleDetails']['rcColor'],
                                "norms_type" => $rc_validation1['vehicleDetails']['rcNormsDesc'],
                                "fit_up_to" => $rc_validation1['vehicleDetails']['rcFitUpto'],
                                "financer" => $rc_validation1['vehicleDetails']['rcFinancer'],
                                "insurance_company" => $rc_validation1['vehicleDetails']['rcInsuranceComp'],
                                "insurance_policy_number" => $rc_validation1['vehicleDetails']['rcInsurancePolicyNo'],
                                "insurance_upto" => $rc_validation1['vehicleDetails']['rcInsuranceUpto'],
                                "manufacturing_date" => $rc_validation1['vehicleDetails']['rcManuMonthYr'],
                                "registered_at" => $rc_validation1['vehicleDetails']['rcRegisteredAt'],
                                "less_info" => 1,
                                "cubic_capacity" => $rc_validation1['vehicleDetails']['rcCubicCap'],
                                "vehicle_gross_weight" => $rc_validation1['vehicleDetails']['rcGvw'],
                                "no_cylinders" => $rc_validation1['vehicleDetails']['rcNoCyl'],
                                "seat_capacity" => $rc_validation1['vehicleDetails']['rcSeatCap'],
                                "sleeper_capacity" => $rc_validation1['vehicleDetails']['rcSleeperCap'],
                                "standing_capacity" => $rc_validation1['vehicleDetails']['rcStandCap'],
                                "wheelbase" => $rc_validation1['vehicleDetails']['rcWheelbase'],
                                "unladen_weight" => $rc_validation1['vehicleDetails']['rcUnldWt'],
                                "vehicle_category_description" => $rc_validation1['vehicleDetails']['rcVhClassDesc'],
                                "pucc_number" => $rc_validation1['vehicleDetails']['rcPuccNo'],
                                "pucc_upto" => $rc_validation1['vehicleDetails']['rcPuccUpto'],
                                'hit_month' => date('Y-m'),
                                // "masked_name"=> $rc_validation1['vehicleDetails']['vehicle']['client_id'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        $headers = [
                            // 'Authorization' => $this->token,        
                            'API-KEY' => $this->api_club_key,
                            'Referer' => $this->site_url
                        ];

                        // $body =  [
                        //     'vehicleId' => $rc_validation['vehicleDetails']['rcRegnNo'],
                        //     'chassis' => substr($rc_validation['vehicleDetails']['rcChasiNo'], 12, 5)
                        // ];
                        // try{
                        //     $res = $client->post($this->api_club.'/challan_info', ['headers' => $headers, 'json' => $body]);
                        //     $rc_challan = json_decode($res->getBody(), true);
                        //     return $rc_challan;
                        //     if(isset($rc_validation['statusCode'])){
                        //         $statusCode = $rc_validation['statusCode'];
                        //     }
                        // }catch(\GuzzleHttp\Exception\RequestException $e){
                        //     $statusCode = $e->getResponse()->getStatusCode();
                        //     if($statusCode == 500 || $statusCode == 401){
                        //         $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        //         if($user->role_id==1) {
                        //             $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        //         }
                        //     }else if($statusCode == 422){
                        //         $statusCode = 102;
                        //         $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                        //         if($user->role_id==1) {
                        //             if($apiamster) {
                        //                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        //             }
                        //         }
                        //     }else{
                        //         $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        //         if($user->role_id==1) {
                        //             if($apiamster) {
                        //                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        //             }
                        //         }
                        //     }
                        //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                        // }
                    } else if ($rc_validation1['error_code'] == "SPC-201") {
                        $statusCode = 500;
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        if (isset($rc_validation1['message']) && $rc_validation1['message'] != 'success') {
                            if ($rc_validation1['error_code'] == 401 || $rc_validation1['error_code'] == 502 || $rc_validation1['error_code'] == 500) {
                                // $statusCode = 101;
                                // $errorMessage = 'RC Number in Multiple RTOs.';
                                // }else if($rc_validation1['reponseCode'] == 502){
                                $statusCode = 102;
                                $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                            } else {
                                $statusCode = 404;
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in for more details';
                            }
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                                $rcvalidation = DB::table('rcvalidation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    "status_code" => $statusCode,
                                    "rc_number" => $request->rc_number,
                                    'hit_month' => date('Y-m'),
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    }
                    // }

                } catch (\GuzzleHttp\Exception\RequestException $e) {
                    $errorMessage = $e->getMessage();
                    $response = $e->getResponse();
                    $statusCode = isset($response) ? $e->getResponse()->getStatusCode() : null;
                    $status = isset($response) ? json_decode((string) $response->getBody()) : null;

                    if ($statusCode == 500 || $statusCode == 401) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        if ($status->message_code == 'multiple_rto') {
                            $statusCode = 101;
                            $errorMessage = 'RC Number in Multiple RTOs.';
                        } else {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                        }
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $statusCode = 404;
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array(['rc_validation' => $rc_validation, 'rc_challan' => '0', 'statusCode' => '200']));

    }
    // public function rc_full_validation(Request $request) {
    //     $statusCode = null;
    //     $rc_validation = null;
    //     $api_id = null;

    //     if(empty($request->rc_number))
    //         return response()->json(array(['message'=>'RC number is required','statusCode'=>'404']));

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     if($user->role_id==1) {
    //         $apiamster = ApiMaster::where('api_slug','rcfull')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //     }

    //     $client = new Client();
    //     $headers = [
    //         'Authorization' => $this->token,        
    //         'Accept'        => 'application/json',
    //     ];

    //     $body =  [
    //         'id_number' => $request->rc_number
    //     ];
    //     $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //     if($updateHitCount || $user->role_id==0){
    //         try{
    //             $res = $client->post($this->base_url.'/rc/rc-full', ['headers' => $headers, 'json' => $body]);
    //             $rc_validation = json_decode($res->getBody(), true);
    //             $grossWeight = $rc_validation['data']['vehicle_gross_weight'];
    //             if($grossWeight){
    //                 $checkWeight = Rcfull::where('min_weight', '<=', $grossWeight)->Where('max_weight', '>=', $grossWeight)->first();
    //                 $checkweight = array();
    //                 $checkweight['tag_class'] = $checkWeight->tag_class;
    //             }else{
    //                 $checkweight['tag_class'] = '';
    //             }

    //             $rc_validation['data']=array_merge($rc_validation['data'],$checkweight );
    //             if(Carbon::parse($rc_validation['data']['fit_up_to'])->isPast() == true){
    //                 $rc_validation['data']['rc_status'] = '';
    //             }else{
    //                 $rc_validation['data']['rc_status'] = 'ACTIVE';
    //             }
    //             if($user->role_id==1) {
    //                 $rcvalidation = DB::table('rcvalidation')->insert([
    //                     "user_id"=> $user->id,
    //                     "client_id"=> $rc_validation['data']['client_id'],
    //                     "rc_number"=> $rc_validation['data']['rc_number'],
    //                     "registration_date"=> $rc_validation['data']['registration_date'],
    //                     "owner_name"=> $rc_validation['data']['owner_name'],
    //                     "present_address"=> $rc_validation['data']['present_address'],
    //                     "permanent_address"=> $rc_validation['data']['permanent_address'],
    //                     "mobile_number"=> $rc_validation['data']['mobile_number'],
    //                     "vehicle_category"=> $rc_validation['data']['vehicle_category'],
    //                     "vehicle_chasi_number"=> $rc_validation['data']['vehicle_chasi_number'],
    //                     "vehicle_engine_number"=> $rc_validation['data']['vehicle_engine_number'],
    //                     "maker_description"=> $rc_validation['data']['maker_description'],
    //                     "maker_model"=> $rc_validation['data']['maker_model'],
    //                     "body_type"=> $rc_validation['data']['body_type'],
    //                     "fuel_type"=> $rc_validation['data']['fuel_type'],
    //                     "color"=> $rc_validation['data']['color'],
    //                     "norms_type"=> $rc_validation['data']['norms_type'],
    //                     "fit_up_to"=> $rc_validation['data']['fit_up_to'],
    //                     "financer"=> $rc_validation['data']['financer'],
    //                     "insurance_company"=> $rc_validation['data']['insurance_company'],
    //                     "insurance_policy_number"=> $rc_validation['data']['insurance_policy_number'],
    //                     "insurance_upto"=> $rc_validation['data']['insurance_upto'],
    //                     "manufacturing_date"=> $rc_validation['data']['manufacturing_date'],
    //                     "registered_at"=> $rc_validation['data']['registered_at'],
    //                     "less_info"=> $rc_validation['data']['less_info'],
    //                     "cubic_capacity"=> $rc_validation['data']['cubic_capacity'],
    //                     "vehicle_gross_weight"=> $rc_validation['data']['vehicle_gross_weight'],
    //                     "no_cylinders"=> $rc_validation['data']['no_cylinders'],
    //                     "seat_capacity"=> $rc_validation['data']['seat_capacity'],
    //                     "sleeper_capacity"=> $rc_validation['data']['sleeper_capacity'],
    //                     "standing_capacity"=> $rc_validation['data']['standing_capacity'],
    //                     "wheelbase"=> $rc_validation['data']['wheelbase'],
    //                     "unladen_weight"=> $rc_validation['data']['unladen_weight'],
    //                     "vehicle_category_description"=> $rc_validation['data']['vehicle_category_description'],
    //                     "pucc_number"=> $rc_validation['data']['pucc_number'],
    //                     "pucc_upto"=> $rc_validation['data']['pucc_upto'],
    //                     "masked_name"=> $rc_validation['data']['client_id'],
    //                     "created_at"=> Carbon::now(),
    //                     "updated_at"=> Carbon::now()
    //                 ]);
    //             }

    //             try{
    //                 $res = $client->post($this->base_url.'/rc/rc-related/init', ['headers' => $headers, 'json' => $body]);
    //                 $result = json_decode($res->getBody(), true);
    //                 $client_id = $result['data']['client_id'];

    //                 $body =  [
    //                     'client_id' => $client_id
    //                 ];

    //                 try{
    //                     $res = $client->post($this->base_url.'/rc/rc-related/challan-details', ['headers' => $headers, 'json' => $body]);
    //                     $rc_challan = json_decode($res->getBody(), true);

    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                         }
    //                     }
    //                 } catch(\GuzzleHttp\Exception\RequestException $e) {
    //                     $statusCode = $e->getResponse()->getStatusCode();
    //                     if($statusCode == 500 || $statusCode == 401){
    //                         $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                         if($user->role_id==1) {
    //                             $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                         }
    //                     }else if($statusCode == 422){
    //                         $statusCode = 102;
    //                         $errorMessage = 'Verification Failed. Please enter correct RC Number.';
    //                         if($user->role_id==1) {
    //                             if($apiamster) {
    //                                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                             }
    //                         }
    //                     }else{
    //                         $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                         if($user->role_id==1) {
    //                             if($apiamster) {
    //                                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                             }
    //                         }
    //                     }
    //                     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                     // return response()->json(['statusCode'=>'422','message'=>$statusCode->message]);
    //                 }
    //             } catch(\GuzzleHttp\Exception\RequestException $e) {
    //                 $statusCode = $e->getResponse()->getStatusCode();
    //                 if($statusCode == 500 || $statusCode == 401){
    //                     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                     if($user->role_id==1) {
    //                         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                     }
    //                 }else if($statusCode == 422){
    //                     $statusCode = 102;
    //                     $errorMessage = 'Verification Failed. Please enter correct RC Number.';
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }else{
    //                     $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }
    //                 return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //                 // return response()->json(['statusCode'=>'422','message'=>$statusCode->message]);
    //             }

    //         } catch(\GuzzleHttp\Exception\RequestException $e) {
    //             $response = $e->getResponse();
    //             $status = json_decode((string) $response->getBody());
    //             $statusCode = $e->getResponse()->getStatusCode();
    //             if($statusCode == 500 || $statusCode == 401){
    //                 $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                 }
    //             }else if($statusCode == 422){
    //                 if($status->message_code == 'multiple_rto'){
    //                     $statusCode = 101;
    //                     $errorMessage = 'RC Number in Multiple RTOs.';
    //                 }else{
    //                     $statusCode = 102;
    //                     $errorMessage = 'Verification Failed. Please enter correct RC Number.';
    //                 }
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }else{
    //                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }
    //             return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //         }
    //     }else{
    //         return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //     }    

    //     return response()->json(array(['rc_validation'=>$rc_validation,'rc_challan'=>$rc_challan,'statusCode'=>'200']));
    // }

    // bank_verification
    public function bank_verification_old(Request $request)
    {
        $statusCode = null;
        $bank_verification = null;
        $api_id = null;

        if (empty($request->account_number))
            return response()->json(array(['message' => 'Account number is required', 'statusCode' => '404']));
        if (empty($request->ifsc))
            return response()->json(array(['message' => 'IFSC code is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'id_number' => $request->account_number,
            'ifsc' => $request->ifsc
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post($this->base_url . '/bank-verification', ['headers' => $headers, 'json' => $body]);
                    $bank_verification = json_decode($res->getBody(), true);

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $bankvalidation = DB::table('bankvalidation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "client_id" => $bank_verification['data']['client_id'],
                            "account_exists" => $bank_verification['data']['account_exists'],
                            "upi_id" => $bank_verification['data']['upi_id'],
                            "full_name" => $bank_verification['data']['full_name'],
                            "remarks" => $bank_verification['data']['remarks'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(["statusCode" => 500, 'message' => "Plase recharage your wallet."]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['bank_verification' => $bank_verification, 'statusCode' => '200']));
    }

    public function bank_verification(Request $request)
    {
        $statusCode = null;
        $bank_verification = null;
        $api_id = null;

        if (empty($request->name))
            return response()->json(array(['message' => 'Name is required', 'statusCode' => '404']));
        if (empty($request->accno))
            return response()->json(array(['message' => 'Account number is required', 'statusCode' => '404']));
        if (empty($request->ifsc))
            return response()->json(array(['message' => 'IFSC code is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'API-KEY' => $this->api_club_key,
            'Referer' => $this->site_url
        ];

        $body = [
            'is_test' => 'FALSE',
            'name' => $request->name,
            'accno' => $request->accno,
            'ifsc' => $request->ifsc
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post('https://api.apiclub.in/api/v2/validate/bank', ['headers' => $headers, 'json' => $body]);
                    $bank_verification = json_decode($res->getBody(), true);
                    // return  $bank_verification;
                    if (isset($bank_verification['code']) && $bank_verification['code'] == 200) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "client_id" => $bank_verification['data']['client_id'],
                                "account_exists" => $bank_verification['data']['account_exists'],
                                "upi_id" => $bank_verification['data']['upi_id'],
                                "full_name" => $bank_verification['data']['full_name'],
                                "remarks" => $bank_verification['data']['remarks'],
                                'status_code' => 200,
                                'message' => 'success',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(array(['bank_verification' => $bank_verification['response']['account_details'], 'statusCode' => '200']));
                    } else if (isset($bank_verification['code']) && $bank_verification['code'] == 404) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                'status_code' => 102,
                                'message' => 'failed',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(['status_code' => 404, 'message' => "Error.Please contact techsupport@docboyz.in. for more details"]);
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                'status_code' => 500,
                                'message' => 'failed',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(['status_code' => 500, 'message' => "Internal Server Error.Please contact techsupport@docboyz.in"]);
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['bank_verification' => $bank_verification['response']['account_details'], 'statusCode' => '200']));
    }
    public function bank_verification_find_ifsc(Request $request)
    {
        $api_id = null;
        if (isset($request->account_number) && !isset($request->ifsc)) {
            return response()->json(array(['message' => 'IFSC code is required', 'statusCode' => '404']));
        }
        if (!isset($request->account_number) && !isset($request->ifsc)) {
            return response()->json(array(['message' => 'IFSC code is required and Account number is required', 'statusCode' => '404']));
        }
        if (!isset($request->account_number) && isset($request->ifsc)) {
            if ($request->ifsc != "") {
                $statusCode = null;
                $bank_verification_api = null;
                if (empty($request->ifsc))
                    return response()->json(array(['message' => 'IFSC code is required', 'statusCode' => '404']));

                if (!$request->headers->has('AccessToken'))
                    return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

                $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
                if ($verifyAccessToken == false)
                    return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

                $user = User::where('access_token', $request->header('AccessToken'))->first();
                if ($user->role_id == 1) {
                    $apiamster = ApiMaster::where('api_slug', 'bank_ifsc')->first();
                    if ($apiamster)
                        $api_id = $apiamster->id;
                }

                $client = new Client();
                $headers = [
                    // 'Authorization' => $this->token,        
                    'API-KEY' => $this->api_club_key,
                    'Referer' => $this->site_url
                ];

                $body = [
                    'ifsc' => $request->ifsc
                ];

                $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
                if ($updateHitCount || $user->role_id == 0) {
                    if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                        try {
                            $res = $client->post($this->api_club . '/v1/bank_info', ['headers' => $headers, 'json' => $body]);
                            // $res = $client->post($this->base_url.'/bank-verification/find-ifsc', ['headers' => $headers, 'json' => $body]);
                            $bank_verification_api = json_decode($res->getBody(), true);
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $ifscvalidation = DB::table('bank_ifsc_details')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    // "client_id"=> $bank_verification_api['data']['client_id'],
                                    "ifsc" => $bank_verification_api['response']['ifsc'],
                                    "bank_name" => $bank_verification_api['response']['name'],
                                    "branch" => $bank_verification_api['response']['branch'],
                                    "address" => $bank_verification_api['response']['address'],
                                    "contact" => $bank_verification_api['response']['contact'],
                                    "state" => $bank_verification_api['response']['state'],
                                    "city" => $bank_verification_api['response']['city'],
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                        } catch (BadResponseException $e) {
                            $statusCode = $e->getResponse()->getStatusCode();
                            $response = $e->getResponse();
                            $errorResponse = json_decode($response->getBody(), true);
                            //   return  $errorResponse;
                            if ($statusCode == 500) {
                                $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                            } else if ($statusCode == 404) {
                                $statusCode = 102;
                                $errorMessage = 'Verification Failed. Please enter correct IFSC Number.';
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            } else {
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            }
                            $ifscvalidation = DB::table('bank_ifsc_details')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                // "client_id"=> $bank_verification_api['data']['client_id'],
                                "ifsc" => $request->ifsc,
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    } else {
                        return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
                    }
                } else {
                    return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
                }

                return response()->json(array(['bank_verification_api' => $bank_verification_api, 'statusCode' => '200']));
            }
        }
        if (isset($request->account_number) && isset($request->ifsc)) {
            if ($request->ifsc != "" && $request->account_number != "") {
                $statusCode = null;
                $bank_verification = null;

                if (empty($request->account_number))
                    return response()->json(array(['message' => 'Account number is required', 'statusCode' => '404']));
                if (empty($request->ifsc))
                    return response()->json(array(['message' => 'IFSC code is required', 'statusCode' => '404']));
                if (!$request->headers->has('AccessToken'))
                    return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));
                $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
                if ($verifyAccessToken == false)
                    return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

                $user = User::where('access_token', $request->header('AccessToken'))->first();
                if ($user->role_id == 1) {
                    $apiamster = ApiMaster::where('api_slug', 'bank_ifsc')->first();
                    if ($apiamster)
                        $api_id = $apiamster->id;
                }

                $client = new Client();
                $headers = [
                    'Authorization' => $this->token,
                    'Accept' => 'application/json',
                ];

                $body = [
                    'id_number' => $request->account_number,
                    'ifsc' => $request->ifsc
                ];
                $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
                if ($updateHitCount || $user->role_id == 0) {
                    if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

                        try {
                            $res = $client->post($this->base_url . '/bank-verification', ['headers' => $headers, 'json' => $body]);
                            $bank_verification = json_decode($res->getBody(), true);
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                            }
                        } catch (BadResponseException $e) {
                            $statusCode = $e->getResponse()->getStatusCode();
                            $response = $e->getResponse();
                            $errorResponse = json_decode($response->getBody(), true);
                            // return  $errorResponse;
                            if ($statusCode == 500) {
                                $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                            } else if ($statusCode == 422) {
                                $statusCode = 102;
                                $errorMessage = 'Verification Failed. Please enter valid details.';
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            } else {
                                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                                if ($user->role_id == 1) {
                                    if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                    }
                                }
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                    } else {
                        return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
                    }
                } else {
                    return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
                }

                return response()->json(array(['bank_verification' => $bank_verification, 'statusCode' => '200']));
            }
        }

    }

    public function bank_statment(Request $request)
    {
        // return 'uploads';
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'pancardupload')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        // echo $_FILES['file']['name'];

        $curl1 = curl_init();
        curl_setopt_array($curl1, array(
            CURLOPT_URL => "http://13.232.233.195/uatapis/ocr/bankStatement",
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "POST",
            CURLOPT_POSTFIELDS => array(
                "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                "bank_name" => $request->bank_name,
            ),
            CURLOPT_HTTPHEADER => array(
                "Authorization: " . $this->token,
            ),
        ));
        $get_data1 = curl_exec($curl1);
        $bankstatment = json_decode($get_data1, true);
        $pan_no = '';
        $name = '';
        if (isset($pancard['pan_dob'])) {
            $pan_no = $pancard['pan_number'];
            $name = $pancard['pan_name'];
        }
        if (isset($pancard['pan_number']) && $user->role_id == 1) {
            $panvalidation = DB::table('pancard_varification')->insert([
                "user_id" => $user->id,
                "api_id" => $api_id,
                "pancard_id" => $pan_no,
                "name" => $name,
                "pancard_upload" => $_FILES['file']['name'],
                "created_at" => Carbon::now(),
                "updated_at" => Carbon::now()
            ]);
        }
        return response()->json(json_decode($get_data1, true));
    }


    public function bank_detailspdf(Request $request)
    {
        // return 'test pdf';
        $statusCode = null;
        $bank_verification = null;
        $hit_limits_exceeded = 0;

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));

        // return $request->password;
        $client = new Client();
        $headers = [
            'AccessToken' => $request->header('AccessToken'),
        ];

        // return $headers;

        $accessToken = $request->AccessToken;
        //    return $accessToken;
        $curl1 = curl_init();
        curl_setopt_array($curl1, array(
            CURLOPT_URL => "http://regtechapi.in/api/bank_details", //"https://kyc-api.flowboard.in/api/v1/pan/pan-upload",
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "POST",
            CURLOPT_POSTFIELDS => array(
                "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                "password" => $request->password,
                "bank" => $request->bank,
                'accountType' => $request->accounttype,
            ),
            CURLOPT_HTTPHEADER => array(
                "AccessToken: " . $request->header('AccessToken'),
            ),
        ));
        // $get_data1 = curl_exec($curl1);
        $result = curl_exec($curl1);
        $bankstatement = json_decode($result, true);
        //return $bankstatement;
        if ($bankstatement['statusCode'] == '200') {
            $statmendata = $bankstatement['response'];
            $pdf = PDF::loadView('kyc.statementpdf', compact('statmendata'))->setPaper('A4');
            $datapdf = $pdf->stream('invoice.pdf');
            return $datapdf;
        } else if ($bankstatement['statusCode'] == '500') {
            return response()->json(['error' => $bankstatement]);
        } else {
            return response()->json(['statusCode' => 400, 'response' => $bankstatement['response']]);
        }
    }
    public function bank_details(Request $request)
    {
        //  return 'server2';
        $api_id = null;
        if (!$request->hasFile('bank_Statement')) {
            return json_encode(['message' => 'bank_Statement  not found'], true);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank_statement')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'https://eyfnupbb4d.execute-api.ap-south-1.amazonaws.com/bankStatement/transactions',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => [
                        'bankStmt' => new \CURLFILE($_FILES['bank_Statement']['tmp_name'], $_FILES['bank_Statement']['type'], $_FILES['bank_Statement']['name']),
                        'bank' => $request->bank,
                        'accountType' => $request->accounttype,
                    ],
                    CURLOPT_HTTPHEADER => array(
                        'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJEb2NCb3l6IiwiaWF0IjoxNjkzMzEyNTg2OTc4fQ.mMgl0deNRbkCXT0LnE8t7hRbTkwoK9TbnCrAS-TtjR4'
                    ),
                ));
                $response = curl_exec($curl);
                curl_close($curl);
                $bankstatement = json_decode($response, true);
                if (!empty($bankstatement['message'])) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                        }
                    }
                    return response()->json(['statusCode' => 500, 'Message' => 'Internal Server Error']);
                }
                if (isset($bankstatement['statusCode']) && $bankstatement['statusCode'] == 201) {
                    $bankstatment1 = [];
                    foreach ($bankstatement['data'] as $bankstatments) {

                        $bankstatment2['amount'] = $bankstatments['amount'];
                        $bankstatment2['balanceAfterTransaction'] = $bankstatments['balanceAfterTransaction'];
                        $bankstatment2['bank'] = $bankstatments['bank'];
                        $bankstatment2['batchID'] = $bankstatments['batchID'];
                        $bankstatment2['category'] = $bankstatments['category'];
                        $bankstatment2['dateTime'] = $bankstatments['dateTime'];
                        $bankstatment2['description'] = $bankstatments['description'];
                        $bankstatment2['remark'] = $bankstatments['remark'];
                        $bankstatment2['transactionId'] = $bankstatments['transactionId'];
                        $bankstatment2['transactionNumber'] = $bankstatments['transactionNumber'];
                        $bankstatment2['type'] = $bankstatments['type'];
                        $bankstatment2['valueDate'] = $bankstatments['valueDate'];
                        $bankstatment3['data'] = $bankstatment2;
                        array_push($bankstatment1, $bankstatment3['data']);
                    }
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                    return response()->json(['statusCode' => 200, 'response' => $bankstatment1]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                        }
                    }
                    return response()->json(['statusCode' => 500, 'response' => $bankstatement]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }

        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function bank_detailsOLD(Request $request)
    {
        // return 'server2';
        $api_id = null;
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank_statement')->first();
            if ($apiamster)
                $api_id = $apiamster->id;

        }
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $b64Doc = chunk_split(base64_encode(file_get_contents($request->file)));
                    $url = 'https://eyfnupbb4d.execute-api.ap-south-1.amazonaws.com/bankStatement/transactions';
                    // $url = 'https://uat.ltflow.com/extservices/bankStatement/prod/transactions';

                    $data = array(
                        "bank" => "SBI",
                        "password" => $request->password,
                        "bankStmt" => $b64Doc,
                        "accountType" => "SAVING"
                    );

                    $body = json_encode($data);

                    $ch = curl_init($url);

                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: " . $this->secretKey, "clientId: " . $this->clientId, 'Content-Type:application/json'));
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                    $get_data1 = curl_exec($ch);
                    $bankstatment = json_decode($get_data1, true);
                    //  return  $bankstatment;
                    if (!empty($bankstatment['message'])) {
                        return response()->json(['statusCode' => 500, 'Message' => 'Internal Server Error']);
                    }
                    $bankstatment1 = [];
                    foreach ($bankstatment['data'] as $bankstatments) {
                        $bankstatment2['amount'] = $bankstatments['amount'];
                        $bankstatment2['balanceAfterTransaction'] = $bankstatments['balanceAfterTransaction'];
                        $bankstatment2['bank'] = $bankstatments['bank'];
                        $bankstatment2['batchID'] = $bankstatments['batchID'];
                        $bankstatment2['category'] = $bankstatments['category'];
                        $bankstatment2['dateTime'] = $bankstatments['dateTime'];
                        $bankstatment2['description'] = $bankstatments['description'];
                        $bankstatment2['remark'] = $bankstatments['remark'];
                        $bankstatment2['transactionId'] = $bankstatments['transactionId'];
                        $bankstatment2['transactionNumber'] = $bankstatments['transactionNumber'];
                        $bankstatment2['type'] = $bankstatments['type'];
                        $bankstatment2['valueDate'] = $bankstatments['valueDate'];
                        $bankstatment3['data'] = $bankstatment2;
                        array_push($bankstatment1, $bankstatment3['data']);
                    }

                    // return $bankstatment1;
                    if ($bankstatment['statusCode'] == '201') {
                        if ($user->role_id == 1) {
                            // return 'ok';
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            return response()->json(['statusCode' => 200, 'response' => $bankstatment1]);
                        }
                        return response()->json(['statusCode' => 200, 'response' => $bankstatment1]);
                    } else {
                        // return 'ds';
                        return response()->json(['statusCode' => 500, 'response' => $bankstatment1['error']]);
                    }
                } catch (\GuzzleHttp\Exception\RequestException $e) {
                    $response = $e->getResponse();
                    $status = json_decode((string) $response->getBody());
                    $statusCode = $e->getResponse()->getStatusCode();
                    return $statusCode;
                    if ($statusCode == 500 || $statusCode == 401) {
                        $statusCode = 102;
                        $errorMessage = 'Invalid RC Number / RC Number in Multiple RTOs.';
                        // $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 403) {
                        if ($status->message_code == 'multiple_rto') {
                            $statusCode = 101;
                            $errorMessage = 'RC Number in Multiple RTOs.';
                        } else {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter correct RC Number.';
                        }
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    if ($user->role_id == 1) {
                        $rcvalidation = DB::table('rcvalidation')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "status_code" => $statusCode,
                            "rc_number" => $rcNumber,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now(),
                            'service_provider' => $service_provider
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }
    public function bank_anlyser31jaully(Request $request)
    {

        $api_id = null;
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank_anlyser')->first();
            if ($apiamster)
                $api_id = $apiamster->id;

        }
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $b64Doc = chunk_split(base64_encode(file_get_contents($request->file)));
                $url = 'https://eyfnupbb4d.execute-api.ap-south-1.amazonaws.com/bankStatement/summary';
                // $url = 'https://uat.ltflow.com/extservices/bankStatement/prod/transactions';

                $data = array(
                    "bank" => "SBI",
                    "password" => $request->password,
                    "bankStmt" => $b64Doc,
                    "accountType" => "SAVING"
                );

                $body = json_encode($data);

                $ch = curl_init($url);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: " . $this->secretKey, "clientId: " . $this->clientId, 'Content-Type:application/json'));
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $get_data1 = curl_exec($ch);
                $bankstatment1 = json_decode($get_data1, true);
                // return $bankstatment1;
                if ($bankstatment1['statusCode'] == '201') {
                    if ($user->role_id == 1) {
                        // return 'ok';
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        return response()->json(['statusCode' => 200, 'response' => $bankstatment1]);
                    }
                    return response()->json(['statusCode' => 200, 'response' => $bankstatment1['data']]);
                } else {
                    // return 'ds';
                    return response()->json(['statusCode' => 500, 'response' => $bankstatment1['error']]);
                }
            } else {
                return response()->json(["statusCode" => 500, 'message' => "Plase recharage your wallet."]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }

    public function bank_anlyser_08_08_2025(Request $request)
    {
        // return 'hii';
        $api_id = null;
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank_anlyser')->first();
            if ($apiamster)
                $api_id = $apiamster->id;

        }
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                if ($request->country == 'INDIA') {
                    // $b64Doc = $request->File('file');
                    $uploadedFile = $request->file('file');
                    $b64Doc = base64_encode(file_get_contents($uploadedFile->path()));
                    $b64Doc = chunk_split(base64_encode(file_get_contents($request->file)));
                    $url = 'https://eyfnupbb4d.execute-api.ap-south-1.amazonaws.com/bankStatement/summary';
                    // $url =  'https://prod.ltflow.com/ltflow/bank-statement/summary';
                    // $url = 'https://uat.ltflow.com/extservices/bankStatement/prod/transactions';

                    $data = array(
                        "bank" => $request->bank,
                        // "password" =>$request->password,
                        "bankStmt" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                        "accountType" => "SAVING"
                    );
                    // return $data;

                    // $body = json_encode($data);

                    $ch = curl_init($url);

                    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, array("Authorization: " . $this->equifaxsecretKey));
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                    $get_data1 = curl_exec($ch);
                    $bankstatment1 = json_decode($get_data1, true);
                    return $bankstatment1;
                    if (isset($bankstatment1['statusCode']) && $bankstatment1['statusCode'] == '201') {
                        if ($user->role_id == 1) {
                            // return 'ok';
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            return response()->json(['statusCode' => 200, 'response' => $bankstatment1['data']]);
                        }
                        return response()->json(['statusCode' => 200, 'response' => $bankstatment1['data']]);
                    } else {
                        // return 'ds';
                        return response()->json(['statusCode' => 500, 'message' => $bankstatment1['message']]);
                    }

                } else {
                    return response()->json(['statusCode' => 404, 'message' => 'Please enter currect country code']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }

    public function bank_anlyser_usd(Request $request)
    {
        $api_id = null;
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }
        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank_anlyser')->first();
            if ($apiamster)
                $api_id = $apiamster->id;

        }
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                if ($request->country == 'Philippines') {
                    // $b64Doc = chunk_split(base64_encode(file_get_contents($request->file)));
                    $url = 'https://eyfnupbb4d.execute-api.ap-south-1.amazonaws.com/bankStatement/summary';
                    // $url = 'https://uat.ltflow.com/extservices/bankStatement/prod/transactions';

                    $data = array(
                        "bank" => "SBI",
                        // "password" =>$request->password,
                        "bankStmt" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                        "accountType" => "SAVING"
                    );

                    // $body = json_encode($data);

                    $ch = curl_init($url);

                    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                    // curl_setopt($ch, CURLOPT_HTTPHEADER, array("secretKey: ".$this->secretKey,"clientId: ".$this->clientId,'Content-Type:application/json'));
                    curl_setopt($ch, CURLOPT_HTTPHEADER, array("Authorization: " . $this->equifaxsecretKey));
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                    $get_data1 = curl_exec($ch);
                    $bankstatment1 = json_decode($get_data1, true);

                    if (isset($bankstatment1['statusCode']) && $bankstatment1['statusCode'] == '201') {
                        if ($user->role_id == 1) {
                            // return 'ok';
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            return response()->json(['statusCode' => 200, 'response' => $bankstatment1]);
                        }
                        return response()->json(['statusCode' => 200, 'response' => $bankstatment1['data']]);
                    } else {
                        // return 'ds';
                        return response()->json(['statusCode' => 500, 'response' => $bankstatment1['message']]);
                    }

                } else {
                    return response()->json(['statusCode' => 404, 'message' => 'Please enter currect country code']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your Wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }
    //pan upload api implementation
    // public function panupload(Request $request){
    //     // return 'uploads';
    //     if (!$request->hasFile('file')) {
    //         return json_encode(['message'=>"file not found"], true);
    //     }

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));
    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

    //     $user = User::where('access_token', $request->header('AccessToken'))->first();
    //     if($user->role_id==1) {
    //         $apiamster = ApiMaster::where('api_slug','pancardupload')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //     }
    //     // echo $_FILES['file']['name'];

    //     $curl1 = curl_init();
    //     curl_setopt_array($curl1, array(
    //         CURLOPT_URL => "http://13.232.233.195/uatapis/ocr/pan",
    //         CURLOPT_RETURNTRANSFER => true,
    //         CURLOPT_ENCODING => "",
    //         CURLOPT_MAXREDIRS => 10,
    //         CURLOPT_TIMEOUT => 0,
    //         CURLOPT_FOLLOWLOCATION => true,
    //         CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
    //         CURLOPT_CUSTOMREQUEST => "POST",
    //         CURLOPT_POSTFIELDS => array(
    //             "file" => new \CURLFILE($_FILES['file']['tmp_name'],$_FILES['file']['type'],$_FILES['file']['name']),
    //         ),
    //         CURLOPT_HTTPHEADER => array(
    //             "Authorization: ".$this->token,
    //         ),
    //     ));
    //     $get_data1 = curl_exec($curl1);
    //     $pancard = json_decode($get_data1, true);
    //     // return $pancard;
    //     $pan_no = '';
    //     $name = '';
    //     if(isset($pancard['pan_dob'])){
    //         $pan_no = $pancard['pan_number'];
    //         $name = $pancard['pan_name'];
    //     }
    //     if(isset($pancard['pan_number']) && $user->role_id==1){
    //         $panvalidation = DB::table('pancard_varification')->insert([
    //             "user_id"=> $user->id,
    //             "api_id"=> $api_id,
    //             "pancard_id"=> $pan_no,
    //             "name"=> $name,
    //             "pancard_upload"=> $_FILES['file']['name'],
    //             "created_at"=> Carbon::now(),
    //             "updated_at"=> Carbon::now()
    //         ]);
    //     }
    //     return response()->json(json_decode($get_data1,true));
    // }
    public function panupload(Request $request)
    {
        // return 'uploads';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "file not found"], true);
        }

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'pancardupload')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        // echo $_FILES['file']['name'];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl1 = curl_init();
                curl_setopt_array($curl1, array(
                    CURLOPT_URL => "http://13.204.214.95:8084/extract-pan-details/",
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => "",
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => "POST",
                    CURLOPT_POSTFIELDS => array(
                        "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                    ),
                    CURLOPT_HTTPHEADER => array(
                        "Authorization: " . $this->token,
                    ),
                ));
                $get_data1 = curl_exec($curl1);
                $pancard = json_decode($get_data1, true);
                // return $pancard['pan_dob'];
                $pan_no = '';
                $name = '';
                if (isset($pancard['pan_dob'])) {
                    $pan_no = $pancard['pan_number'];
                    $name = $pancard['pan_name'];
                }
                if (isset($pancard['pan_number'])) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $panvalidation = DB::table('pancard_varification')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "pancard_id" => $pan_no,
                            "name" => $name,
                            "pancard_upload" => isset($_FILES['file']['name']) ? $_FILES['file']['name'] : null,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(array(['pancard' => $pancard, 'statusCode' => 200]));

                    } else {
                        return response()->json(array(['pancard' => $pancard, 'statusCode' => 200]));
                    }


                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                        // $panvalidation = DB::table('pancard_varification')->insert([
                        //     "user_id"=> $user->id,
                        //     "api_id"=> $api_id,
                        //     "pancard_id"=> $pancard['pancard'],
                        //     "created_at"=> Carbon::now(),
                        //     "updated_at"=> Carbon::now()
                        // ]);
                    }
                    return response()->json(array(['pancard' => $pancard, 'statusCode' => 102]));
                }

            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        // return response()->json(json_decode($get_data1,true));
    }

    public function ckycSearch(Request $request)
    {
        // return 'test';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano))
            return response()->json(array(['message' => 'Pancard number is required', 'statusCode' => '404']));

        if (empty($request->dob))
            return response()->json(array(['message' => 'Date of birth is required', 'statusCode' => '404']));


        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'searchkyc')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $panno = $request->pano;
        $dob = $request->dob;

        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return $api_id;
                $url = 'https://api-preproduction.signzy.app/api/v3/ckycSearch';

                $data = array(
                    "document_type" => "PAN",
                    "id_number" => $panno,
                    "consent" => true,
                    "consent_purpose" => "this is the consent_purpose can be passed any string value"
                );

                $body = json_encode($data);

                $ch = curl_init($url);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, array("Authorization: " . $this->ckyctoken, 'Content-Type:application/json'));
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $get_data1 = curl_exec($ch);
                $kyccard = json_decode($get_data1, true);
                // return $kyccard;
                if (isset($kyccard['status']) && $kyccard['status'] == "SUCCESS") {
                    // return  $kyccard['kycDetails']['ckycId'];

                    $url = 'https://api-preproduction.signzy.app/api/v3/ckycDownload';

                    $data = array(
                        "ckyc_id" => $kyccard['kycDetails']['ckycId'],
                        "auth_factor_type" => 1,
                        "consent" => true,
                        "consent_purpose" => "this is a consent purpose string pass anything",
                        "auth_factor" => $dob

                    );

                    $body = json_encode($data);

                    $ch = curl_init($url);

                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, array("Authorization: " . $this->ckyctoken, 'Content-Type:application/json'));
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                    $alldata = curl_exec($ch);
                    $allpandata = json_decode($alldata, true);
                    // return $allpandata['kycStatus'];
                    if ($allpandata['kycStatus'] == "SUCCESS") {
                        // return 'true';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            // $panvalidation = DB::table('pancard_varification')->insert([
                            //     "user_id"=> $user->id,
                            //     "api_id"=> $api_id,
                            //     "pancard_id"=> $pancard['pancard'],
                            //     "name"=> $pancard['fullname'],
                            //     // "pancard_id"=> $pancard['response']['pan_no'],
                            //     // "name"=> $pancard['response']['registered_name'],
                            //     "created_at"=> Carbon::now(),
                            //     "updated_at"=> Carbon::now()
                            // ]);
                        }

                        return response()->json(['statusCode' => 200, 'response' => $allpandata]);


                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            // $panvalidation = DB::table('pancard_varification')->insert([
                            //     "user_id"=> $user->id,
                            //     "api_id"=> $api_id,
                            //     "pancard_id"=> $pancard['pancard'],
                            //     "created_at"=> Carbon::now(),
                            //     "updated_at"=> Carbon::now()
                            // ]);
                        }
                        return response()->json(['statusCode' => 200, 'response' => $allpandata]);
                    }
                    // return response()->json(json_decode($alldata,true));
                    // return response()->json(['statusCode'=>200, 'response'=>$allpandata]);

                } else {
                    return response()->json(array(['message' => 'Please Enter Valid Details', 'statusCode' => '404']));
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        // return $kyccard;

        // curl_close($ch);


        // $get_data1 = curl_exec($curl1);
        // $pancard = json_decode($get_data1, true);
        // return $pancard;
        // $pan_no = '';
        // $name = '';
        // if(isset($pancard['pan_dob'])){
        //     $pan_no = $pancard['pan_number'];
        //     $name = $pancard['pan_name'];
        // }
        // if(isset($pancard['pan_number']) && $user->role_id==1){
        //     $panvalidation = DB::table('pancard_varification')->insert([
        //         "user_id"=> $user->id,
        //         "api_id"=> $api_id,
        //         "pancard_id"=> $pan_no,
        //         "name"=> $name,
        //         "pancard_upload"=> $_FILES['file']['name'],
        //         "created_at"=> Carbon::now(),
        //         "updated_at"=> Carbon::now()
        //     ]);
        // }
        return response()->json(json_decode($get_data1, true));
    }
    public function ckycSearchlite(Request $request)
    { 
        $accesstoken = $request->accesstoken;
        $seamlesstoken = $request->seamlesstoken;
        $paymenttoken = $request->paymenttoken;
        // return $accesstoken;
        if($accesstoken == '' && $seamlesstoken == '' && $paymenttoken == ''){
                $statusCode = null;
                $pancard = null;
                $api_id = null;
                if (empty($request->pano)) {
                    return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
                }

                if (empty($request->dob)) {
                    return response()->json([['message' => 'Date of birth is required', 'statusCode' => '404']]);
                 }

                $validator = Validator::make($request->all(), [
                    'dob' => ['required', 'date_format:Y-m-d'],
                ]);

                if ($validator->fails()) {
                    return response()->json(['error' => $validator->errors(), 'statusCode' => '404']);
                }

                if (!$request->headers->has('AccessToken')) {
                    return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
                }

                $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
                if ($verifyAccessToken == false) {
                    return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
                }
               $user = User::where('access_token', $request->header('AccessToken'))->first();
               if ($user->role_id == 1) {
                    $apiamster = ApiMaster::where('api_slug', 'searchkyc')->first();
                    // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
                    if ($apiamster) {
                        $api_id = $apiamster->id;
                    }
                }
                $panno = $request->pano;
                $dob = $request->dob;
                $groupId = rand(100,10000000000);
                $checkId = rand(100,10000000000);
                $client = new Client();
                $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                    ->where('api_id', $api_id)
                    ->orderBy('id', 'desc')
                    ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if(($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0  || $user->type == 'role_postpaid'){
                    try{
                        $headers = [
                            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
                        ];
                        $body=[
                            'panNumber' =>$request->pano,
                            'groupId'=>$groupId,
                            'checkId'=>$checkId,
                        ];
                        $client = new Client();
                        $res = $client->post('https://api.kyckart.com/api/panCard/panDetailedContactV4', ['headers' => $headers, 'json' => $body]);
                        $allpandata = json_decode($res->getBody(), true);
                        return $allpandata;
                        $data = [ 
                            'document_type' => 'PAN',
                            'id_number' => $panno,
                            'consent' => true,
                            'consent_purpose' => 'this is the consent_purpose can be passed any string value',
                        ];
                        $searchkyc = [];
                    if (isset($allpandata['status']['statusCode']) && $allpandata['status']['statusCode'] == 200 && isset($allpandata['response']['code']) && $allpandata['response']['code'] == 200)
                        {
                                $searchkyc['kycStatus'] = 'SUCCESS';
                                $searchkyc['message'] = 'Details downloaded successfully';
                                $searchkyc['success'] = true;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan']= isset($allpandata['response']['pan'])?$allpandata['response']['pan']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maskedAadhaar']= isset($allpandata['response']['maskedAadhaar'])?$allpandata['response']['maskedAadhaar']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastFourDigit'] = isset($allpandata['response']['lastFourDigit'])?$allpandata['response']['lastFourDigit']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['typeOfHolder'] = isset($allpandata['response']['typeOfHolder'])?$allpandata['response']['typeOfHolder']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = isset($allpandata['response']['name'])?$allpandata['response']['name']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = isset($allpandata['response']['firstName'])?$allpandata['response']['firstName']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = isset($allpandata['response']['lastName'])?$allpandata['response']['lastName']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = isset($allpandata['response']['mobile_no'])?$allpandata['response']['mobile_no']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = isset($allpandata['response']['email'])?$allpandata['response']['email']:null;
                                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = isset($allpandata['response']['dob'])?$allpandata['response']['dob']:null;
                                 $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender']= isset($allpandata['response']['gender'])?$allpandata['response']['gender']:null;
                                 $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['address'] = isset($allpandata['response']['address'])?$allpandata['response']['address']:null;
                                 $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['city']= isset($allpandata['response']['city'])?$allpandata['response']['city']:null;
                                 $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['state']= isset($allpandata['response']['state'])?$allpandata['response']['state']:null;
                                 $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['country']= isset($allpandata['response']['country'])?$allpandata['response']['country']:null;
                                 $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pincode']= isset($allpandata['response']['pincode'])?$allpandata['response']['pincode']:null;
                                if ($user->role_id == 1){
                                       if ($apiamster) {
                                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                        }
                                    
                                   
                                    $panvalidation = DB::table('search')->insert([
                                        'user_id' =>$user->id,
                                        'api_id' =>$api_id,
                                        'groupId'=>$groupId,
                                        'checkId'=>$checkId,
                                        'vender_status_code'=>isset($allpandata['status']['statusCode'])?$allpandata['status']['statusCode']:null,
                                        'vender_code'=>isset($allpandata['response']['code'])?$allpandata['response']['code']:null,
                                        'status' => 200,
                                        'pan_no' => $allpandata['response']['pan'],
                                        'ckycid' =>null,
                                        'firstname' => isset($allpandata['response']['firstName'])?$allpandata['response']['firstName']:null,
                                        'fullname' => isset($allpandata['response']['name'])?$allpandata['response']['name']:null,
                                        'mobilenum' =>isset($allpandata['response']['mobile_no'])?$allpandata['response']['mobile_no']:null,
                                        'email' => isset($allpandata['response']['email'])?$allpandata['response']['email']:null,
                                        'dob' => isset($allpandata['response']['dob'])?$allpandata['response']['dob']:null,
                                        'paddress' =>isset($allpandata['response']['address'])?$allpandata['response']['address']:null,
                                        'pstate' =>isset($allpandata['response']['state'])?$allpandata['response']['state']:null,
                                        'pcity' =>isset($allpandata['response']['city'])?$allpandata['response']['city']:null,
                                        'caddress' =>null,
                                        'cstate' =>null,
                                        'ccity' =>null,
                                        'currentpincode' =>null,
                                        'permanantpincode' =>isset($allpandata['response']['pincode'])?$allpandata['response']['pincode']:null, 
                                        // "pancard_id"=> $pancard['response']['pan_no'],
                                        // "name"=> $pancard['response']['registered_name'],
                                        'created_at' => Carbon::now(),
                                        'updated_at' => Carbon::now(),
                                    ]);
                                }
                            return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                        }
                        elseif(isset($allpandata['status']['statusCode']) && $allpandata['status']['statusCode'] == 200 && isset($allpandata['response']['code']) && $allpandata['response']['code'] == 400){
                            if ($user->role_id == 1){
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                }
                              $panvalidation = DB::table('search')->insert([
                               'user_id' => $user->id,
                               'api_id' => $api_id,
                               'dob' => $dob,
                               'groupId'=>$groupId,
                               'checkId'=>$checkId,
                               'vender_status_code'=>isset($allpandata['status']['statusCode'])?$allpandata['status']['statusCode']:null,
                               'vender_code'=>isset($allpandata['response']['code'])?$allpandata['response']['code']:null,
                               'status' => 102,
                               'pan_no' => $request->pano,
                               'created_at' => Carbon::now(),
                               'updated_at' => Carbon::now(),
                           ]);
                           return response()->json(['statusCode' =>102, 'response' =>$allpandata]);
                       }

                    }
                        else{
                            if ($user->role_id == 1){
                                 if ($apiamster) {
                                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 202);
                                 }
                               $panvalidation = DB::table('search')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'dob' => $dob,
                                'groupId'=>$groupId,
                                'checkId'=>$checkId,
                                'vender_status_code'=>isset($allpandata['status']['statusCode'])?$allpandata['status']['statusCode']:null,
                                'vender_code'=>isset($allpandata['response']['code'])?$allpandata['response']['code']:null,
                                'status' => 202,
                                'pan_no' => $request->pano,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                            return response()->json(['statusCode' => 202, 'response' =>$allpandata]);
                        }
                     }  
                    }
                    catch (ClientException $e) {
                        $response = $e->getResponse();
                        $statusCode = $response->getStatusCode();
                        $errorResponse = json_decode($response->getBody(), true);
                        $errorResponse['error']['message'];
                        $kyccarderror = null;
                        $kyccarderror['error']['name'] = null;
                        $kyccarderror['error']['message'] = $errorResponse['error']['message'];
                        $kyccarderror['error']['reason'] ="InValid Pan No";
                        $kyccarderror['error']['type'] = " ";
                        $searchkyc['statusCode'] = 500;
                        $searchkyc['message']= $errorResponse['error']['message'];
                        if(isset($errorResponse ['status']['statusCode']) && $errorResponse ['status']['statusCode']==400 && $errorResponse ['error']['code']=='E0010002'){
                            if ($user->role_id == 1) {
                                 if ($apiamster) {
                                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                }
                                
                               $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId'=>$groupId,
                                    'checkId'=>$checkId,
                                    'vender_status_code'=>isset($errorResponse ['status']['statusCode'])?$errorResponse ['status']['statusCode']:null,
                                    'vender_code'=>isset($errorResponse ['error']['code'])?$errorResponse ['error']['code']:null,
                                    'status' => 102,
                                    'pan_no' => $request->pano,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                            return response()->json(['statusCode' => 102, 'response' => $searchkyc['message']]);
                        }
                        elseif(isset($errorResponse ['status']['statusCode']) && $errorResponse['status']['statusCode']==400 && $errorResponse['error']['code']==400){
                            if($user->role_id == 1){
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 202);
                                }
                                $panvalidation = DB::table('search')->insert([
                                    'user_id' =>$user->id,
                                    'api_id' =>$api_id,
                                    'dob' => $dob,
                                    'groupId'=>$groupId,
                                    'checkId'=>$checkId,
                                    'vender_status_code'=>isset($errorResponse ['status']['statusCode'])?$errorResponse ['status']['statusCode']:null,
                                    'vender_code'=>isset($errorResponse ['error']['code'])?$errorResponse ['error']['code']:null,
                                    'status' => 202,
                                    'pan_no' => $request->pano,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                                
                            }
                            return response()->json(['statusCode' => 202, 'response' => $searchkyc['message']]);
                        }
                        else{
                               if($user->role_id == 1){
                                    if ($apiamster) {
                                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                                    }
                                    $panvalidation = DB::table('search')->insert([
                                        'user_id' =>$user->id,
                                        'api_id' =>$api_id,
                                        'dob' => $dob,
                                        'groupId'=>$groupId,
                                        'checkId'=>$checkId,
                                        'vender_status_code'=>isset($errorResponse ['status']['statusCode'])?$errorResponse ['status']['statusCode']:null,
                                        'vender_code'=>isset($errorResponse ['error']['code'])?$errorResponse ['error']['code']:null,
                                        'status' => 500,
                                        'pan_no' => $request->pano,
                                        'created_at' => Carbon::now(),
                                        'updated_at' => Carbon::now(),
                                    ]);
                                    
                                }
                               return response()->json(['statusCode' => 500, 'response' => $searchkyc['message']]);
                        }
                       
                    }
                }
                else{
                    return response()->json(['statusCode' =>500, 'message' => 'Please recharge your wallet.']);
                }
                
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
           
           }
        elseif($accesstoken != ''){
            $api_id = null;
            $verifyAccessToken = $this->verifyAccessToken($accesstoken);
            if ($verifyAccessToken==false)
                return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));
    
            $access_token = $accesstoken;
            $user = User::where('access_token',$accesstoken)->first();
            if($user->role_id==1) {
                $apiamster = ApiMaster::where('api_slug','enach')->first();
                if($apiamster)
                    $api_id = $apiamster->id;
            }
    
            $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
            if($updateHitCount || $user->role_id==0){
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == 'role_postpaid') {
                  $url = 'https://regtechapi.in/e-nach-initiate-payments/'.$accesstoken;
                  // return $url;
                  return response()->json(['statusCode' => 200, 'Link' => $url]);
                }
                else{
                     return response()->json(['statusCode'=>500 ,'message'=>'Please Recharage your plan.']);
                }
            }
            else{
                return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
            }
            
        }
        elseif($seamlesstoken != '')
        {
            $api_id = null;
            $verifyAccessToken = $this->verifyAccessToken($seamlesstoken);
            if ($verifyAccessToken==false)
                return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));
    
            $access_token = $seamlesstoken;
            $user = User::where('access_token',$seamlesstoken)->first();
            if($user->role_id==1) {
                $apiamster = ApiMaster::where('api_slug','enach')->first();
                if($apiamster)
                    $api_id = $apiamster->id;
            }
    
            $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
            if($updateHitCount || $user->role_id==0){
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == 'role_postpaid') {
                $url = 'https://regtechapi.in/enach_payment_seameless/'.$seamlesstoken;
                // return $url;
                  return response()->json(['statusCode' => 200, 'Link' => $url]);
                }
                else{
                    return response()->json(['statusCode'=>500 ,'message'=>'Please Recharage your plan.']);
                }
            }
            else{
                return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
            }
        }
        elseif($paymenttoken != ''){

          $api_id = null;
          $verifyAccessToken = $this->verifyAccessToken($paymenttoken);
          if ($verifyAccessToken==false)
              return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));
  
          $access_token = $paymenttoken;
          $user = User::where('access_token',$paymenttoken)->first();
          if($user->role_id==1) {
              $apiamster = ApiMaster::where('api_slug','payment')->first();
              if($apiamster)
                  $api_id = $apiamster->id;
          }
  
          $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
          if($updateHitCount || $user->role_id==0){
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == 'role_postpaid') {
              $url = 'https://regtechapi.in/initiate-payment-integrations/'.$paymenttoken;
              // return $url;
              return response()->json(['statusCode' => 200, 'Link' => $url]);
            }else{
                 return response()->json(['statusCode'=>500 ,'message'=>'Please recharge your plan.']);
            }
          }
          else{
              return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
          }

      }
    }

    public function ckycSearchlite26oct2023(Request $request)
    {

        // return 'test3';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }

        if (empty($request->dob)) {
            return response()->json([['message' => 'Date of birth is required', 'statusCode' => '404']]);
        }

        $validator = Validator::make($request->all(), [
            'dob' => ['required', 'date_format:Y-m-d'],
        ]);

        if ($validator->fails()) {
            return response()->json(['error' => $validator->errors(), 'statusCode' => '404']);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        //return $user->id;
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'searchkyc')->first();
            // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $panno = $request->pano;
        $dob = $request->dob;
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            try {
                $headers = [
                    'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
                ];
                $body = [
                    'panNumber' => $request->pano,
                    'groupId' => $groupId,
                    'checkId' => $checkId,
                ];
                $client = new Client();
                $res = $client->post('https://api.kyckart.com/api/panCard/panDetailedContactV4', ['headers' => $headers, 'json' => $body]);
                $allpandata = json_decode($res->getBody(), true);
                //    return $allpandata;
                $data = [
                    'document_type' => 'PAN',
                    'id_number' => $panno,
                    'consent' => true,
                    'consent_purpose' => 'this is the consent_purpose can be passed any string value',
                ];
                $searchkyc = [];
                if (isset($allpandata['status']['statusCode']) && $allpandata['status']['statusCode'] == 200) {
                    if ($allpandata['response']['code'] == 400) {

                        $searchkyc['statusCode'] = $allpandata['response']['code'];
                        $searchkyc['message'] = $allpandata['response']['message'];
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                            }
                            $panvalidation = DB::table('search')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'groupId' => isset($groupId) ? $groupId : null,
                                'checkId' => isset($checkId) ? $checkId : null,
                                'vender_status_code' => isset($allpandata['status']['statusCode']) ? $allpandata['status']['statusCode'] : null,
                                'vender_code' => isset($allpandata['response']['code']) ? $allpandata['response']['code'] : null,
                                'dob' => $dob,
                                'status' => 102,
                                'pan_no' => $request->pano,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => 102, 'response' => $allpandata['response']['message']]);
                    }
                    $searchkyc['kycStatus'] = 'SUCCESS';
                    $searchkyc['message'] = 'Details downloaded successfully';
                    $searchkyc['success'] = true;
                    //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan']= $allpandata['response']['pan'];
                    //$searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maskedAadhaar']= $allpandata['response']['maskedAadhaar'];
                    //$searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastFourDigit'] = $allpandata['response']['lastFourDigit'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['typeOfHolder'] = $allpandata['response']['typeOfHolder'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['response']['name'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['response']['firstName'];
                    //$searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['response']['lastName'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = $allpandata['response']['mobile_no'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['response']['email'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['response']['dob'];
                    //$searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender']= $allpandata['response']['gender'];
                    //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['address'] = $allpandata['response']['address'];
                    //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['city']= $allpandata['response']['city'];
                    //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['state']= $allpandata['response']['state'];
                    //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['country']= $allpandata['response']['country'];
                    //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pincode']= $allpandata['response']['pincode'];
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $panvalidation = DB::table('search')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'groupId' => isset($groupId) ? $groupId : null,
                            'checkId' => isset($checkId) ? $checkId : null,
                            'vender_status_code' => isset($allpandata['status']['statusCode']) ? $allpandata['status']['statusCode'] : null,
                            'vender_code' => isset($allpandata['response']['code']) ? $allpandata['response']['code'] : null,
                            'status' => 200,
                            'pan_no' => $allpandata['response']['pan'],
                            'ckycid' => null,
                            'firstname' => $allpandata['response']['firstName'],
                            'fullname' => $allpandata['response']['name'],
                            'mobilenum' => $allpandata['response']['mobile_no'],
                            'email' => $allpandata['response']['email'],
                            'dob' => $allpandata['response']['dob'],
                            'paddress' => $allpandata['response']['address'],
                            'pstate' => $allpandata['response']['state'],
                            'pcity' => $allpandata['response']['city'],
                            'caddress' => null,
                            'cstate' => null,
                            'ccity' => null,
                            'currentpincode' => null,
                            'permanantpincode' => $allpandata['response']['pincode'],
                            // "pancard_id"=> $pancard['response']['pan_no'],
                            // "name"=> $pancard['response']['registered_name'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 202);
                        }
                        $panvalidation = DB::table('search')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'dob' => $dob,
                            'groupId' => isset($groupId) ? $groupId : null,
                            'checkId' => isset($checkId) ? $checkId : null,
                            'vender_status_code' => isset($allpandata['status']['statusCode']) ? $allpandata['status']['statusCode'] : null,
                            'vender_code' => isset($allpandata['response']['code']) ? $allpandata['response']['code'] : null,
                            'status' => 202,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                        return response()->json(['statusCode' => 202, 'response' => $allpandata]);
                    }
                }
            } catch (ClientException $e) {
                $response = $e->getResponse();
                $statusCode = $response->getStatusCode();
                $errorResponse = json_decode($response->getBody(), true);
                $errorResponse['error']['message'];
                $kyccarderror = null;
                $kyccarderror['error']['name'] = null;
                $kyccarderror['error']['message'] = $errorResponse['error']['message'];
                $kyccarderror['error']['reason'] = "InValid Pan No";
                $kyccarderror['error']['type'] = " ";
                $searchkyc['statusCode'] = 500;
                $searchkyc['message'] = $errorResponse['error']['message'];
                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 500);
                    }
                    $panvalidation = DB::table('search')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'groupId' => isset($groupId) ? $groupId : null,
                        'checkId' => isset($checkId) ? $checkId : null,
                        'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                        'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                        'dob' => $dob,
                        'status' => 500,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);

                }
                return response()->json(['statusCode' => 500, 'response' => $searchkyc['message']]);
            }

        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function ckycSearchlite21aug2023(Request $request)
    {
        // return 'test3';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano))
            return response()->json(array(['message' => 'Pancard number is required', 'statusCode' => '404']));

        if (empty($request->dob))
            return response()->json(array(['message' => 'Date of birth is required', 'statusCode' => '404']));

        $validator = Validator::make($request->all(), [
            'dob' => ['required', 'date_format:Y-m-d'],
        ]);

        if ($validator->fails()) {
            return response()->json(['error' => $validator->errors(), 'statusCode' => '404']);
        }


        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // return $user->id;
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'searchkyc')->first();
            // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $panno = $request->pano;
        $dob = $request->dob;

        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {

            // return $api_id;
            $url = 'https://api-preproduction.signzy.app/api/v3/ckycSearch';

            $data = array(
                "document_type" => "PAN",
                "id_number" => $panno,
                "consent" => true,
                "consent_purpose" => "this is the consent_purpose can be passed any string value"
            );

            $body = json_encode($data);

            $ch = curl_init($url);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
            curl_setopt($ch, CURLOPT_HTTPHEADER, array("Authorization: " . $this->ckyctoken, 'Content-Type:application/json'));
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            $get_data1 = curl_exec($ch);
            $kyccard = json_decode($get_data1, true);
            // Async::run($kyccard);
            // $results = Async::wait();
            // return $kyccard;

            if (isset($kyccard['error'])) {
                $kyccarderror = null;
                $kyccarderror['error']['name'] = $kyccard['error']['name'];
                $kyccarderror['error']['message'] = $kyccard['error']['message'];
                $kyccarderror['error']['reason'] = $kyccard['error']['reason'];
                $kyccarderror['error']['type'] = $kyccard['error']['type'];

                $panvalidation = DB::table('search')->insert([
                    "user_id" => $user->id,
                    "api_id" => $api_id,
                    "dob" => $dob,
                    "status" => 201,
                    "pan_no" => $request->pano,
                    "created_at" => Carbon::now(),
                    "updated_at" => Carbon::now()
                ]);
                return response()->json(['statusCode' => 201, 'response' => $kyccarderror]);
            }



            if (isset($kyccard['kycStatus']) && $kyccard['kycStatus'] == "SUCCESS") {
                // return  $kyccard['kycDetails']['ckycId'];
                $searchkyc = [];

                $url = 'https://api-preproduction.signzy.app/api/v3/ckycDownload';

                $data = array(
                    "ckyc_id" => $kyccard['kycDetails']['ckycId'],
                    "auth_factor_type" => 1,
                    "consent" => true,
                    "consent_purpose" => "this is a consent purpose string pass anything",
                    "auth_factor" => $dob

                );

                $body = json_encode($data);

                $ch = curl_init($url);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, array("Authorization: " . $this->ckyctoken, 'Content-Type:application/json'));
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $alldata = curl_exec($ch);
                $allpandata = json_decode($alldata, true);
                // return $allpandata;

                if (isset($allpandata['kycStatus']) && $allpandata['kycStatus'] == "SUCCESS") {
                    $searchkyc['status'] = $allpandata['status'];
                    $searchkyc['kycStatus'] = $allpandata['kycStatus'];
                    $searchkyc['message'] = 'Details downloaded successfully';
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['email'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['dob'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permState'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permState'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'];
                    // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'] = $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'];
                    // return 'true';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $panvalidation = DB::table('search')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "status" => 200,
                            "pan_no" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['pan'],
                            "ckycid" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['ckycNo'],
                            "firstname" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'],
                            "fullname" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'],
                            "mobilenum" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'],
                            "email" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['email'],
                            "dob" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['dob'],
                            "paddress" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'],
                            "pstate" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permState'],
                            "pcity" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'],
                            "caddress" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'],
                            "cstate" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'],
                            "ccity" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'],
                            "currentpincode" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'],
                            "permanantpincode" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'],
                            // "pancard_id"=> $pancard['response']['pan_no'],
                            // "name"=> $pancard['response']['registered_name'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }

                    return response()->json(['statusCode' => 200, 'response' => $searchkyc]);


                } elseif (isset($allpandata['kycStatus']) && $allpandata['kycStatus'] == "FAILURE") {
                    if ($user->role_id == 1) {
                        $statusCode = 102;
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                        // return 'insert';
                        $panvalidation = DB::table('search')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "dob" => $dob,
                            "status" => 102,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                    $searchkyc['status'] = $allpandata['status'];
                    $searchkyc['kycStatus'] = $allpandata['kycStatus'];
                    $searchkyc['message'] = 'Date of birth entered does not match';
                    return response()->json(['statusCode' => 102, 'response' => $searchkyc]);
                } else {
                    // return 'test';
                    $panvalidation = DB::table('search')->insert([
                        "user_id" => $user->id,
                        "api_id" => $api_id,
                        "dob" => $dob,
                        "status" => 202,
                        "pan_no" => $request->pano,
                        "created_at" => Carbon::now(),
                        "updated_at" => Carbon::now()
                    ]);
                    return response()->json(['statusCode' => 202, 'response' => $allpandata]);

                }
                // return response()->json(json_decode($alldata,true));
                // return response()->json(['statusCode'=>200, 'response'=>$allpandata]);

            } else {
                $panvalidation = DB::table('search')->insert([
                    "user_id" => $user->id,
                    "api_id" => $api_id,
                    "status" => 201,
                    "pan_no" => $request->pano,
                    "created_at" => Carbon::now(),
                    "updated_at" => Carbon::now()
                ]);
                return response()->json(['statusCode' => 201, 'response' => $kyccard]);
            }

        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        // return $kyccard;

        // curl_close($ch);


        // $get_data1 = curl_exec($curl1);
        // $pancard = json_decode($get_data1, true);
        // return $pancard;
        // $pan_no = '';
        // $name = '';
        // if(isset($pancard['pan_dob'])){
        //     $pan_no = $pancard['pan_number'];
        //     $name = $pancard['pan_name'];
        // }
        // if(isset($pancard['pan_number']) && $user->role_id==1){
        //     $panvalidation = DB::table('pancard_varification')->insert([
        //         "user_id"=> $user->id,
        //         "api_id"=> $api_id,
        //         "pancard_id"=> $pan_no,
        //         "name"=> $name,
        //         "pancard_upload"=> $_FILES['file']['name'],
        //         "created_at"=> Carbon::now(),
        //         "updated_at"=> Carbon::now()
        //     ]);
        // }
        // return response()->json(json_decode($get_data1,true));
    }

    public function paymentform(Request $request)
    {
        return view('kyc.paymentform');

    }

    public function ckycSearchdata(Request $request)
    {
        // return 'test search';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano))
            return response()->json(array(['message' => 'Pancard number is required', 'statusCode' => '404']));

        // if(empty($request->dob))
        // return response()->json(array(['message'=>'Date of birth is required','statusCode'=>'404']));


        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'ckycsearch')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $panno = $request->pano;
        $dob = $request->dob;

        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

                // return $api_id;
                try {
                    $url = 'https://api-preproduction.signzy.app/api/v3/ckycSearch';

                    $data = array(
                        "document_type" => "PAN",
                        "id_number" => $panno,
                        "consent" => true,
                        "consent_purpose" => "this is the consent_purpose can be passed any string value"
                    );

                    $body = json_encode($data);

                    $ch = curl_init($url);

                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, array("Authorization: " . $this->ckyctoken, 'Content-Type:application/json'));
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                    $get_data1 = curl_exec($ch);
                    $kyccard = json_decode($get_data1, true);

                    // return $kyccard;
                    if (isset($kyccard['kycStatus']) && $kyccard['kycStatus'] == "SUCCESS") {
                        // return $kyccard['kycDetails']['fullName'];
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $panvalidation = DB::table('ckycsearch')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "name" => $kyccard['kycDetails']['fullName'],
                                "status" => 200,
                                "pan_no" => $request->pano,
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);

                        }

                        return response()->json(['statusCode' => 200, 'response' => $kyccard]);

                    } elseif (isset($kyccard['kycStatus']) && $kyccard['kycStatus'] == "FAILURE") {
                        if ($user->role_id == 1) {
                            $statusCode = 102;
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            // return 'insert';
                            $panvalidation = DB::table('ckycsearch')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                // "dob"=> $dob,
                                "status" => 102,
                                "pan_no" => $request->pano,
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        $searchkyc['status'] = $kyccard['status'];
                        $searchkyc['kycStatus'] = $kyccard['kycStatus'];
                        $searchkyc['message'] = 'Date of birth entered does not match';
                        return response()->json(['statusCode' => 102, 'response' => $kyccard]);
                    } else {
                        // return 'test';
                        $panvalidation = DB::table('ckycsearch')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "dob"=> $dob,
                            "status" => 202,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(['statusCode' => 202, 'response' => $kyccard]);

                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        $panvalidation = DB::table('ckycsearch')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "dob"=> $dob,
                            "status" => 500,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(['statusCode' => 500, 'response' => 'Corporate Pan']);
                    } else if ($statusCode == 404) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                        $panvalidation = DB::table('ckycsearch')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "dob"=> $dob,
                            "status" => 102,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(['statusCode' => 201, 'response' => 'Corporate Pan']);
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                        $panvalidation = DB::table('ckycsearch')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "dob" => $dob,
                            "status" => $statusCode,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(['statusCode' => 201, 'response' => 'Corporate Pan']);
                    }

                    return response()->json(['statusCode' => 201, 'response' => 'Corporate Pan']);

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        // return $kyccard;

        // curl_close($ch);


        // $get_data1 = curl_exec($curl1);
        // $pancard = json_decode($get_data1, true);
        // return $pancard;
        // $pan_no = '';
        // $name = '';
        // if(isset($pancard['pan_dob'])){
        //     $pan_no = $pancard['pan_number'];
        //     $name = $pancard['pan_name'];
        // }
        // if(isset($pancard['pan_number']) && $user->role_id==1){
        //     $panvalidation = DB::table('pancard_varification')->insert([
        //         "user_id"=> $user->id,
        //         "api_id"=> $api_id,
        //         "pancard_id"=> $pan_no,
        //         "name"=> $name,
        //         "pancard_upload"=> $_FILES['file']['name'],
        //         "created_at"=> Carbon::now(),
        //         "updated_at"=> Carbon::now()
        //     ]);
        // }
        return response()->json(json_decode($get_data1, true));
    }

    public function ckycSearchdatadownload(Request $request)
    {
        // return 'test search';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano))
            return response()->json(array(['message' => 'Pancard number is required', 'statusCode' => '404']));

        if (empty($request->ckycid))
            return response()->json(array(['message' => 'ckycid is required', 'statusCode' => '404']));

        if (empty($request->dob))
            return response()->json(array(['message' => 'Date of birth is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'ckycdownload')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $panno = $request->pano;
        $dob = $request->dob;

        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $url = 'https://api-preproduction.signzy.app/api/v3/ckycDownload';

                    $data = array(
                        "ckyc_id" => $request->ckycid,
                        "auth_factor_type" => 1,
                        "consent" => true,
                        "consent_purpose" => "this is a consent purpose string pass anything",
                        "auth_factor" => $dob

                    );

                    $body = json_encode($data);

                    $ch = curl_init($url);

                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, array("Authorization: " . $this->ckyctoken, 'Content-Type:application/json'));
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                    $alldata = curl_exec($ch);
                    $allpandata = json_decode($alldata, true);
                    // return $allpandata;

                    // return $kyccard;
                    if (isset($allpandata['kycStatus']) && $allpandata['kycStatus'] == "SUCCESS") {
                        // return $kyccard['kycDetails']['fullName'];
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $panvalidation = DB::table('ckycdownload')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "status" => 200,
                                "pan_no" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['pan'],
                                "ckycid" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['ckycNo'],
                                "firstname" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'],
                                "fullname" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'],
                                "mobilenum" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'],
                                "email" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['email'],
                                "dob" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['dob'],
                                "paddress" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'],
                                "pstate" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permState'],
                                "pcity" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'],
                                "caddress" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'],
                                "cstate" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'],
                                "ccity" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'],
                                "currentpincode" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'],
                                "permanantpincode" => $allpandata['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'],
                                // "pancard_id"=> $pancard['response']['pan_no'],
                                // "name"=> $pancard['response']['registered_name'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }

                        return response()->json(['statusCode' => 200, 'response' => $allpandata]);

                    } elseif (isset($allpandata['kycStatus']) && $allpandata['kycStatus'] == "FAILURE") {
                        if ($user->role_id == 1) {
                            $statusCode = 102;
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            // return 'insert';
                            $panvalidation = DB::table('ckycdownload')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                // "dob"=> $dob,
                                "status" => 102,
                                "pan_no" => $request->pano,
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        $searchkyc['status'] = $allpandata['status'];
                        $searchkyc['kycStatus'] = $allpandata['kycStatus'];
                        $searchkyc['message'] = 'Date of birth entered does not match';
                        return response()->json(['statusCode' => 102, 'response' => $allpandata]);
                    } else {
                        // return 'test';
                        $panvalidation = DB::table('ckycsearch')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "dob"=> $dob,
                            "status" => 202,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(['statusCode' => 202, 'response' => $allpandata]);

                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        $panvalidation = DB::table('ckycsearch')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "dob"=> $dob,
                            "status" => 500,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(['statusCode' => 500, 'response' => 'Corporate Pan']);
                    } else if ($statusCode == 404) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                        $panvalidation = DB::table('ckycsearch')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "dob"=> $dob,
                            "status" => 102,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(['statusCode' => 201, 'response' => 'Corporate Pan']);
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                        $panvalidation = DB::table('ckycsearch')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "dob" => $dob,
                            "status" => $statusCode,
                            "pan_no" => $request->pano,
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                        return response()->json(['statusCode' => 201, 'response' => 'Corporate Pan']);
                    }

                    return response()->json(['statusCode' => 201, 'response' => 'Corporate Pan']);

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        // return $kyccard;

        // curl_close($ch);


        // $get_data1 = curl_exec($curl1);
        // $pancard = json_decode($get_data1, true);
        // return $pancard;
        // $pan_no = '';
        // $name = '';
        // if(isset($pancard['pan_dob'])){
        //     $pan_no = $pancard['pan_number'];
        //     $name = $pancard['pan_name'];
        // }
        // if(isset($pancard['pan_number']) && $user->role_id==1){
        //     $panvalidation = DB::table('pancard_varification')->insert([
        //         "user_id"=> $user->id,
        //         "api_id"=> $api_id,
        //         "pancard_id"=> $pan_no,
        //         "name"=> $name,
        //         "pancard_upload"=> $_FILES['file']['name'],
        //         "created_at"=> Carbon::now(),
        //         "updated_at"=> Carbon::now()
        //     ]);
        // }
        return response()->json(json_decode($get_data1, true));
    }

    public function payment(Request $request)
    {
        // return $request->email;
        // return $request->txnid;
        $key = "QyT13U";
        $salt = "UnJ0FGO0kt3dUgnHo9Xgwi0lpipBV0hB";
        $txnid = isset($_POST['txnid']) ? $_POST['txnid'] : $request->txnid;
        $amount = isset($_POST['amount']) ? $_POST['amount'] : $request->amount;
        $productinfo = isset($_POST['productinfo']) ? $_POST['productinfo'] : $request->productinfo;
        $firstname = isset($_POST['firstname']) ? $_POST['firstname'] : $request->productinfo;
        $email = isset($_POST['email']) ? $_POST['email'] : $request->email;
        $phone = isset($_POST['phone']) ? $_POST['phone'] : $request->phone;
        $url = isset($_SERVER['HTTPS']) ? 'https"//' : 'http://' . $_SERVER['SERVER_NAME'] . substr($_SERVER['REQUEST_URI'], 0, strrpos($_SERVER['REQUEST_URI'], '/'));
        $surl = $url . '/response.php';
        $furl = $url . '/response.php';

        $api_version = '7';
        $si = '1';
        $free_trial = '';

        $billingCycle = isset($_POST['billingCycle']) ? $_POST['billingCycle'] : $request->billingcycle;
        $billingInterval = isset($_POST['billingInterval']) ? $_POST['billingInterval'] : $request->billinginterval;
        $billingAmount = isset($_POST['billingAmount']) ? $_POST['billingAmount'] : $request->billingamount;
        $billingCurrency = isset($_POST['billingCurrency']) ? $_POST['billingCurrency'] : $request->billingcurrencey;
        $paymentStartDate = isset($_POST['paymentStartDate']) ? $_POST['paymentStartDate'] : date($request->startdate);
        $paymentEndDate = isset($_POST['paymentEndDate']) ? $_POST['paymentEndDate'] : date($request->enddate, strtotime('+5 day'));

        $si_details = array('billingCycle' => $billingCycle, 'billingInterval' => $billingInterval, 'billingAmount' => $billingAmount, 'billingCurrency' => $billingCurrency, 'paymentStartDate' => $paymentStartDate, 'paymentEndDate' => $paymentEndDate);
        $si_details = json_encode($si_details);
        $hash = '';

        // $hash = $key . '|' . $txnid . '|' . $amount . '|' . $productinfo . '|' . $firstname . '|' . $email . '|' . $phone . '|' . $surl . '|' . $furl . '|' . $api_version . '|' . $si . '|' . $si_details . '|' . $salt;
        $hash = $key . '|' . $txnid . '|' . $amount . '|' . $productinfo . '|' . $firstname . '|' . $email . '|||||||||||' . $si_details . '|' . $salt;
        // $hashsequence = $hash;

        $hash = hash('sha512', $hash);


        //  $action = 'https://test.payu.in/_payment';

        // return view('kyc.paymentdemo');

        // $url = 'https://test.payu.in/_payment';

        // $data = [
        //     "key" => "QyT13U",
        //     "txnid"=> "txn_12xcfgy98765", 
        //     "amount"=> "100",
        //     "productinfo"=> "iPhone",
        //     "firstname" => "Test User",
        //     "email"=> "test@gmail.com", 
        //     "phone"=> "9876543210",
        //     "surl"=> "https://apiplayground-response.herokuapp.com",
        //     "furl" => "https://apiplayground-response.herokuapp.com",
        //     "api_version"=> "7", 
        //     "si"=> "1",
        //     "si_details"=> ["billingAmount"=>"200.00",
        //         "billingCurrency"=>"INR",
        //         "billingCycle"=>"MONTHLY",
        //         "billingInterval"=> 1,
        //         "paymentStartDate"=>"2022-12-23",
        //         "paymentEndDate"=>"2023-12-30"],
        //     // "hash"=>"185e515ea73ab87a809ac59cadfd80a3b69c92e60de21cbc243aaf0a7cf9731b0fb511fc98efd677db1d7137a45d95dcf171d84ca4aa988b1b104372abb9c502"  
        //     // "hash"=>"68a101bd561e0c8e14deecfb52a7c60c9eaf534c48070246d853d771099b4fa6575abfc60bec32f3827127cd295bd23c1c200b9afbbc15ffb3a022062bbbcef9"  
        // ];

        // $datas = json_encode($data);

        // $txnids = ["txnid" => "txn_12xcfgy98765"];
        // $txnid = json_encode($txnids);
        // $amounts = ["amount"=> "100"];
        // $amount = json_encode($amounts);
        // $productinfos = ["productinfo"=> "iPhone"];
        // $productinfo = json_encode($productinfos);
        // $firstnames = ["firstname" => "Test User"];
        // $firstname = json_encode($firstnames);
        // $emails = [ "email"=> "test@gmail.com"];
        // $email = json_encode($emails);
        // $phones = ["phone"=> "9876543210"];
        // $phone = json_encode($phones);
        // $surls = ["surl"=> "https://apiplayground-response.herokuapp.com"];
        // $surl = json_encode($surls);
        // $furls = ["furl" => "https://apiplayground-response.herokuapp.com"];
        // $furl = json_encode($furls);
        // $api_versions = ["api_version"=> "7"];
        // $api_version = json_encode($api_versions);
        // $sis = ["si"=> "1"];
        // $si = json_encode($sis);
        // $free_trial = '';
        // $si_detailss = array("billingAmount"=>"200.00",
        // "billingCurrency"=>"INR",
        // "billingCycle"=>"MONTHLY",
        // "billingInterval"=> 1,
        // "paymentStartDate"=>"2022-12-23",
        // "paymentEndDate"=>"2023-12-30");
        // $si_details = json_encode($si_detailss);
        // $hash = '';

        //****************************New Start****************** */
        // $txnid = "txn_12xcfgy98765";
        // $amount = "100";
        // $productinfo = "iPhone";
        // $firstname = "Test User";
        // $email = "test@gmail.com";
        // $phone = "9876543210";
        // $surl = "https://apiplayground-response.herokuapp.com/";
        // $furl = "https://apiplayground-response.herokuapp.com/";
        // $api_version = '7';
        // $si = '1';
        // $si_detailss = array("billingAmount"=>"200.00",
        // "billingCurrency"=>"INR",
        // "billingCycle"=>"MONTHLY",
        // "billingInterval"=> '1',
        // "paymentStartDate"=>"2023-01-24",
        // "paymentEndDate"=>"2023-12-30");
        // $si_details = json_encode($si_detailss);

        /*****************************New 3rd start *******************************/
        // $txnid = isset($_POST['txnid']) ? $_POST['txnid'] : 'reg-' . round(microtime(true) * 1000);
        // $amount = isset($_POST['amount']) ? $_POST['amount'] : '1.00';
        // $productinfo = isset($_POST['productinfo']) ? $_POST['productinfo'] : 'SI Registration';
        // $firstname = isset($_POST['firstname']) ? $_POST['firstname'] : 'Test Name';
        // $email = isset($_POST['email']) ? $_POST['email'] : 'test@gmail.com';
        // $phone = isset($_POST['phone']) ? $_POST['phone'] : '9876543210';
        // $url = isset($_SERVER['HTTPS']) ? 'https"//' : 'http://' . $_SERVER['SERVER_NAME'] . substr($_SERVER['REQUEST_URI'], 0, strrpos($_SERVER['REQUEST_URI'], '/'));
        // $surl = $url . '/response.php';
        // $furl = $url . '/response.php';

        // $api_version = '7';
        // $si = '1';
        // $free_trial = '';

        // $billingCycle = isset($_POST['billingCycle']) ? $_POST['billingCycle'] : 'DAILY';
        // $billingInterval = isset($_POST['billingInterval']) ? $_POST['billingInterval'] : '1';
        // $billingAmount = isset($_POST['billingAmount']) ? $_POST['billingAmount'] : '1.00';
        // $billingCurrency = 'INR';
        // $paymentStartDate = isset($_POST['paymentStartDate']) ? $_POST['paymentStartDate'] : date('Y-m-d');
        // $paymentEndDate = isset($_POST['paymentEndDate']) ? $_POST['paymentEndDate'] : date('Y-m-d', strtotime('+5 day'));

        // $si_details = array('billingCycle'=>$billingCycle, 'billingInterval'=>$billingInterval, 'billingAmount'=>$billingAmount, 'billingCurrency'=>$billingCurrency, 'paymentStartDate'=>$paymentStartDate, 'paymentEndDate'=>$paymentEndDate);
        // $si_details = json_encode($si_details);
        // $hash = $key . '|' .$datas. '|' . $salt;
        // return $firstname;
        // $hash_str = $key . '|' . $txnid . '|' . $amount . '|' . $productinfo . '|' . $firstname . '|' . $email . '|||||||||||' . $si_details . '|' . $salt;
        // $hash_str = $key . '|' . $txnid . '|' . $amount . '|' . $productinfo . '|' . $firstname . '|' . $email . '|' . $phone . '|' . $surl . '|' . $furl . '|' . $api_version . '|' . $si . '|' . $si_details . '|' . $salt;
        // // $hashe = strtolower(hash('sha512', $hash_str));
        // $hash = hash('sha512', $hash_str);
        // return $hash;

        // $data = [
        //     "key" => "QyT13U",
        //     "txnid"=> "txn_12xcfgy98765", 
        //     "amount"=> "100",
        //     "productinfo"=> "iPhone",
        //     "firstname" => "Test User",
        //     "email"=> "test@gmail.com", 
        //     "phone"=> "9876543210",
        //     "surl"=> "https://apiplayground-response.herokuapp.com/",
        //     "furl" => "https://apiplayground-response.herokuapp.com/",
        //     "api_version"=> "7", 
        //     "si"=> "1",
        //     "si_details"=> ["billingAmount"=>"200.00",
        //         "billingCurrency"=>"INR",
        //         "billingCycle"=>"MONTHLY",
        //         "billingInterval"=> 1,
        //         "paymentStartDate"=>"2022-12-23",
        //         "paymentEndDate"=>"2023-12-30"],
        //     "hash"=>$hash
        // ];
        // return $si_details;
        $data = [
            "key" => $key,
            "txnid" => $txnid,
            "amount" => $amount,
            "productinfo" => $productinfo,
            "firstname" => $firstname,
            "email" => $email,
            "phone" => $phone,
            "surl" => $surl,
            "furl" => $furl,
            "api_version" => $api_version,
            "si" => $si,
            "si_details" => $si_details,
            "hash" => $hash
        ];
        $qs = http_build_query($data);
        // $qs = json_encode($data);

        $wsUrl = "https://test.payu.in/_payment";


        $c = curl_init();
        curl_setopt($c, CURLOPT_URL, $wsUrl);
        curl_setopt($c, CURLOPT_POST, 1);
        curl_setopt($c, CURLOPT_POSTFIELDS, $qs);
        curl_setopt($c, CURLOPT_CONNECTTIMEOUT, 30);
        curl_setopt($c, CURLOPT_RETURNTRANSFER, 1);
        curl_setopt($c, CURLOPT_SSLVERSION, 6); //TLS 1.2 mandatory
        curl_setopt($c, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($c, CURLOPT_SSL_VERIFYPEER, 0);
        $o = curl_exec($c);
        if (curl_errno($c)) {
            $sad = curl_error($c);
            throw new Exception($sad);
        }
        curl_close($c);
        return $o;

        // return view($get_data1); 




    }


    //driving upload api implementation
    // public function driving_upload(Request $request){
    //     $statusCode = null;
    //     if (!$request->hasFile('front')) {
    //         return json_encode(['message'=>"Front file required",'statusCode'=>null], true);
    //     }
    //     if (!$request->hasFile('back')) {
    //         return json_encode(['message'=>"Back file required",'statusCode'=>null], true);
    //     }
    //     // echo $_FILES['file']['name'];

    //     $curl1 = curl_init();
    //     curl_setopt_array($curl1, array(
    //         CURLOPT_URL => "https://sandbox.flowboard.in/api/v1/ocr/license",
    //         CURLOPT_RETURNTRANSFER => true,
    //         CURLOPT_ENCODING => "",
    //         CURLOPT_MAXREDIRS => 10,
    //         CURLOPT_TIMEOUT => 0,
    //         CURLOPT_FOLLOWLOCATION => true,
    //         CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
    //         CURLOPT_CUSTOMREQUEST => "POST",
    //         CURLOPT_POSTFIELDS => array(
    //             "front" => new \CURLFILE($_FILES['front']['tmp_name'],$_FILES['front']['type'],$_FILES['front']['name']),
    //             "back" => new \CURLFILE($_FILES['back']['tmp_name'],$_FILES['back']['type'],$_FILES['back']['name']),
    //         ),
    //         CURLOPT_HTTPHEADER => array(
    //             "Authorization: ".$this->sandbox_token,
    //         ),
    //     ));
    //     $get_data1 = curl_exec($curl1);

    //     return response()->json(json_decode($get_data1, true));
    // }

    public function driving_upload(Request $request)
    {
        //dd($request->all());
        // return 'case';
        $statusCode = null;
        $license_validation = null;
        $ocr_data = null;
        $api_id = null;
        if (empty($request->hasFile('front'))) {
            return json_encode(['message' => "Front file required", 'statusCode' => 404], true);
        }
        // if (!$request->hasFile('back')) {
        //     return json_encode(['message'=>"Back file required",'statusCode'=>null], true);
        // }
        // echo $_FILES['file']['name'];
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl1 = curl_init();
                curl_setopt_array($curl1, array(
                    CURLOPT_URL => "http://13.232.233.195/uatapis/ocr/dlic",
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => "",
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => "POST",
                    CURLOPT_POSTFIELDS => array(
                        "file" => new \CURLFILE($_FILES['front']['tmp_name'], $_FILES['front']['type'], $_FILES['front']['name']),
                        // "back" => new \CURLFILE($_FILES['back']['tmp_name'],$_FILES['back']['type'],$_FILES['back']['name']),
                    ),
                    CURLOPT_HTTPHEADER => array(
                        "Authorization: " . $this->sandbox_token,
                    ),
                ));
                $ocr_data = curl_exec($curl1);
                $ocr_data = json_decode($ocr_data, true);
                // return $ocr_data;
                if (isset($ocr_data['status_code']) && $ocr_data['status_code'] == 200) {
                    $client = new Client();
                    $headers = [
                        'Authorization' => $this->sandbox_token,
                        'Accept' => 'application/json',
                    ];

                    // $body =  [
                    //     'id_number' => $request->license_number
                    // ];
                    // $ocr_data['data']['license_number']['value'];
                    $body = [
                        'id_number' => $ocr_data['data']['license_number']['value'],
                        'dob' => $ocr_data['data']['dob']['value']
                    ];

                    if ($user->role_id == 1) {
                        $apiamster = ApiMaster::where('api_slug', 'licenseupload')->first();
                        if ($apiamster)
                            $api_id = $apiamster->id;
                    }
                    try {
                        // return'qwqwq';
                        $res = $client->post($this->sandbox_url . '/driving-license/driving-license', ['headers' => $headers, 'json' => $body]);
                        $license_validation = json_decode($res->getBody(), true);
                        // return $license_validation;

                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $licensevalidation = DB::table('driving_license')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "client_id" => $license_validation['data']['client_id'],
                                "license_number" => $license_validation['data']['license_number'],
                                "temporary_address" => $license_validation['data']['temporary_address'],
                                "father_or_husband_name" => $license_validation['data']['father_or_husband_name'],
                                "doe" => $license_validation['data']['doe'],
                                "temporary_zip" => $license_validation['data']['temporary_zip'],
                                "permanent_address" => $license_validation['data']['permanent_address'],
                                "doi" => $license_validation['data']['doi'],
                                "dob" => $license_validation['data']['dob'],
                                "permanent_zip" => $license_validation['data']['permanent_zip'],
                                "gender" => $license_validation['data']['gender'],
                                "name" => $license_validation['data']['name'],
                                "state" => $license_validation['data']['state'],
                                "profile_image" => $license_validation['data']['profile_image'],
                                "ola_name" => $license_validation['data']['ola_name'],
                                "initial_doi" => $license_validation['data']['initial_doi'],
                                "ola_code" => $license_validation['data']['ola_code'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                    } catch (BadResponseException $e) {
                        $statusCode = $e->getResponse()->getStatusCode();
                        if ($statusCode == 500) {
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 422) {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['ocr_fields' => $ocr_data, 'license_validation' => $license_validation, 'statusCode' => '200']));
    }

    // voter validation
    public function voter_validation_old(Request $request)
    {
        $statusCode = null;
        $voter_validation = null;
        $api_id = null;

        if (empty($request->voter_number))
            return response()->json(array(['message' => 'Voter id number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'voter_id')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'id_number' => $request->voter_number
        ];
        $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // return $updateHitCount;
        if ($updateHitCount || $user->role_id == 0) {
            try {

                $res = $client->post($this->base_url . '/voter-id/voter-id', ['headers' => $headers, 'json' => $body, 'form_params' => ['api_token' => $token]]);
                $voter_validation = json_decode($res->getBody(), true);
                // return $voter_validation;
                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }

                    $votervalidation = DB::table('voter_verification')->insert([
                        "user_id" => $user->id,
                        "api_id" => $api_id,
                        "client_id" => $voter_validation['data']['client_id'],
                        "epic_no" => $voter_validation['data']['epic_no'],
                        "gender" => $voter_validation['data']['gender'],
                        "state" => $voter_validation['data']['state'],
                        "name" => $voter_validation['data']['name'],
                        "relation_name" => $voter_validation['data']['relation_name'],
                        "relation_type" => $voter_validation['data']['relation_type'],
                        "house_no" => $voter_validation['data']['house_no'],
                        "dob" => $voter_validation['data']['dob'],
                        "age" => $voter_validation['data']['age'],
                        "area" => $voter_validation['data']['area'],
                        "district" => $voter_validation['data']['district'],
                        "multiple" => $voter_validation['data']['multiple'],
                        "last_update" => $voter_validation['data']['last_update'],
                        "assembly_constituency" => $voter_validation['data']['assembly_constituency'],
                        "assembly_constituency_number" => $voter_validation['data']['assembly_constituency_number'],
                        "polling_station" => $voter_validation['data']['polling_station'],
                        "part_number" => $voter_validation['data']['part_number'],
                        "part_name" => $voter_validation['data']['part_name'],
                        "slno_inpart" => $voter_validation['data']['slno_inpart'],
                        "ps_lat_long" => $voter_validation['data']['ps_lat_long'],
                        "rln_name_v1" => $voter_validation['data']['rln_name_v1'],
                        "rln_name_v2" => $voter_validation['data']['rln_name_v2'],
                        "rln_name_v3" => $voter_validation['data']['rln_name_v3'],
                        "section_no" => $voter_validation['data']['section_no'],
                        "name_v1" => $voter_validation['data']['name_v1'],
                        "name_v2" => $voter_validation['data']['name_v2'],
                        "name_v3" => $voter_validation['data']['name_v3'],
                        "st_code" => $voter_validation['data']['st_code'],
                        "parliamentary_constituency" => $voter_validation['data']['parliamentary_constituency'],
                        "v_id" => $voter_validation['data']['id'],
                        "created_at" => Carbon::now(),
                        "updated_at" => Carbon::now()
                    ]);
                }
            } catch (BadResponseException $e) {
                $statusCode = $e->getResponse()->getStatusCode();
                if ($statusCode == 500) {
                    $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                    }
                } else if ($statusCode == 422) {
                    $statusCode = 102;
                    $errorMessage = 'Verification Failed. Please enter correct Voter ID.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                } else {
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                }
                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['voter_validation' => $voter_validation, 'statusCode' => '200']));
    }

    // public function voter_validation(Request $request)
    // {
    //     $statusCode = null;
    //     $voter_validation = null;
    //     $api_id = null;

    //     if (empty($request->voter_number))
    //         return response()->json(array(['message' => 'Voter id number is required', 'statusCode' => '404']));

    //     if (!$request->headers->has('AccessToken'))
    //         return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken == false)
    //         return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

    //     $user = User::where('access_token', $request->header('AccessToken'))->first();
    //     if ($user->role_id == 1) {
    //         $apiamster = ApiMaster::where('api_slug', 'voter_id')->first();
    //         if ($apiamster)
    //             $api_id = $apiamster->id;
    //     }

    //     $client = new Client();
    //     $headers = [
    //         'content-type' => 'application/json',
    //         'Content-Length' => '',
    //         'API-KEY' => '2487be27f4d20bc1d366cb38f098eba7',
    //         'Referer' => 'http://regtechapi.in',
    //         'accept' => 'application/json',
    //     ];
        
    //     $body = [
    //         'voter_id' => $request->voter_number
    //     ];
    //     $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
    //     $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
    //     if ($updateHitCount || $user->role_id == 0) {
    //         if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
    //             try {
    //                 // $res = $client->post($this->base_url.'/voter-id/voter-id', ['headers' => $headers, 'json' => $body,'form_params' => ['api_token' => $token]]);
    //                 $res = $client->post('https://api.apiclub.in/api/v1/verify_votercard', ['headers' => $headers, 'json' => $body]);
    //                 $voter_validation = json_decode($res->getBody(), true);
                  
    //                 if ($user->role_id == 1) {
    //                     if ($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                     }

    //                     $votervalidation = DB::table('voter_verification')->insert([
    //                         "user_id" => $user->id,
    //                         "api_id" => $api_id,
    //                         // "client_id"=> $voter_validation['data']['client_id'],
    //                         "epic_no" => $voter_validation['response']['epic_no'],
    //                         "gender" => $voter_validation['response']['gender'],
    //                         // "state"=> $voter_validation['data']['state'],
    //                         "name" => $voter_validation['response']['holder_name'],
    //                         "relation_name" => $voter_validation['response']['relation'],
    //                         "relation_type" => $voter_validation['response']['relation_type'],
    //                         // "house_no"=> $voter_validation['data']['house_no'],
    //                         "dob" => $voter_validation['response']['dob'],
    //                         "age" => $voter_validation['response']['age'],
    //                         "area" => $voter_validation['response']['area'],
    //                         "district" => $voter_validation['response']['district'],
    //                         // "multiple"=> $voter_validation['data']['multiple'],
    //                         // "last_update"=> $voter_validation['data']['last_update'],
    //                         // "assembly_constituency"=> $voter_validation['data']['assembly_constituency'],
    //                         // "assembly_constituency_number"=> $voter_validation['data']['assembly_constituency_number'],
    //                         // "polling_station"=> $voter_validation['data']['polling_station'],
    //                         // "part_number"=> $voter_validation['data']['part_number'],
    //                         // "part_name"=> $voter_validation['data']['part_name'],
    //                         // "slno_inpart"=> $voter_validation['data']['slno_inpart'],
    //                         // "ps_lat_long"=> $voter_validation['data']['ps_lat_long'],
    //                         // "rln_name_v1"=> $voter_validation['data']['rln_name_v1'],
    //                         // "rln_name_v2"=> $voter_validation['data']['rln_name_v2'],
    //                         // "rln_name_v3"=> $voter_validation['data']['rln_name_v3'],
    //                         // "section_no"=> $voter_validation['data']['section_no'],
    //                         // "name_v1"=> $voter_validation['data']['name_v1'],
    //                         // "name_v2"=> $voter_validation['data']['name_v2'],
    //                         // "name_v3"=> $voter_validation['data']['name_v3'],
    //                         // "st_code"=> $voter_validation['data']['st_code'],
    //                         // "parliamentary_constituency"=> $voter_validation['data']['parliamentary_constituency'],
    //                         // "v_id"=> $voter_validation['data']['id'],
    //                         "created_at" => Carbon::now(),
    //                         "updated_at" => Carbon::now()
    //                     ]);
    //                 }
    //             } catch (BadResponseException $e) {
    //                 $statusCode = $e->getResponse()->getStatusCode();
    //                 if ($statusCode == 500) {
                         

    //     $headers = [
    //       'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
    //         'Accept'        => 'application/json'
    //     ];

    //     $body = [
    //         'client_ref_num' => uniqid('vtr_'),
    //         'epic_number'    => $request->voter_number
    //     ];

    //     $res = $client->post(
    //         'https://svcdemo.digitap.work/validation/kyc/v1/voter',
    //         [
    //             'headers' => $headers,
    //             'json'    => $body
    //         ]
    //     );

    //     $digitapData = json_decode($res->getBody(), true);

    //     if (($digitapData['result_code'] ?? 0) == 101 ) {
    //         $voter_validation = [
    //             'data' => [
    //                 'client_id'   => $digitapData['client_ref_num'] ?? null,
    //                 'epic_no'     => $digitapData['result']['epic_no'] ?? null,
    //                 'name'        => $digitapData['result']['name'] ?? null,
    //                 'gender'      => $digitapData['result']['gender'] ?? null,
    //                 'age'         => $digitapData['result']['age'] ?? null,
    //                 'state'       => $digitapData['result']['st_name'] ?? null,
    //                 'district'    => $digitapData['result']['dist_name'] ?? null,
    //                 'relation_name' => $digitapData['result']['rln_name'] ?? null,
    //                 'relation_type' => $digitapData['result']['rln_type'] ?? null,
    //                 'assembly_constituency' => $digitapData['result']['ac_name'] ?? null,
    //                 'polling_station' => $digitapData['result']['ps_name'] ?? null,
    //                 'slno_inpart' => $digitapData['result']['slno_inpart'] ?? null,
    //                 'last_update' => $digitapData['result']['last_update'] ?? null,
    //                 'ps_lat_long' => $digitapData['result']['ps_lat_long'] ?? null,
    //                 'st_code'     => $digitapData['result']['st_code'] ?? null,
    //                 'id'          => $digitapData['result']['id'] ?? null
    //             ]
    //         ];
    //         if ($user->role_id == 1) {
    //                         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        
    //             DB::table('voter_verification')->insert([
    //                 'user_id'       => $user->id,
    //                 'api_id'        => $api_id,
    //                 'epic_no'       => $voter_validation['data']['epic_no'],
    //                 'name'          => $voter_validation['data']['name'],
    //                 'gender'        => $voter_validation['data']['gender'],
    //                 'age'           => $voter_validation['data']['age'],
    //                 'state'         => $voter_validation['data']['state'],
    //                 'district'      => $voter_validation['data']['district'],
    //                 'relation_name' => $voter_validation['data']['relation_name'],
    //                 'relation_type' => $voter_validation['data']['relation_type'],
    //                 'assembly_constituency' => $voter_validation['data']['assembly_constituency'],
    //                 'polling_station' => $voter_validation['data']['polling_station'],
    //                 'service_provider' => 'DIGITAP',
    //                 'created_at'    => now(),
    //                 'updated_at'    => now()
    //             ]);
    //         }

    //         return response()->json([
    //             'statusCode' => 200,
    //             'voter_validation' => $voter_validation
    //         ]);
    //     }
    //                     }
    //                  else if ($statusCode == 422) {
    //                     $statusCode = 102;
    //                     $errorMessage = 'Verification Failed. Please enter correct Voter ID.';
    //                     if ($user->role_id == 1) {
    //                         if ($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 } else {
    //                     $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                     if ($user->role_id == 1) {
    //                         if ($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }
    //                 return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
    //             }
    //         } else {
    //             return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your plan.']);
    //         }
    //     } else {
    //         return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
    //     }

    //     return response()->json(array(['voter_validation' => $voter_validation, 'statusCode' => '200']));
    // }

    public function voter_validation(Request $request)
{
    $statusCode = null;
    $voter_validation = null;
    $api_id = null;

    if (empty($request->voter_number))
        return response()->json(array(['message' => 'Voter id number is required', 'statusCode' => '404']));

    if (!$request->headers->has('AccessToken'))
        return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

    if ($this->verifyAccessToken($request->header('AccessToken')) == false)
        return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

    $user = User::where('access_token', $request->header('AccessToken'))->first();
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'voter_id')->first();
        if ($apiamster)
            $api_id = $apiamster->id;
    }

    $client = new Client();
    $headers = [
        'content-type' => 'application/json',
        'Content-Length' => '',
        'API-KEY' => '2487be27f4d20bc1d366cb38f098eba7',
        'Referer' => 'http://regtechapi.in',
        'accept' => 'application/json',
    ];

    $body = [
        'voter_id' => $request->voter_number
    ];

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {
        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
            try {

                

                $res = $client->post(
                    'https://api.apiclub.in/api/v1/verify_votercard',
                    ['headers' => $headers, 'json' => $body]
                );

                $voter_validation = json_decode($res->getBody(), true);

                
                $voter = [
                    'epic_no'       => $voter_validation['response']['epic_no'] ?? null,
                    'gender'        => $voter_validation['response']['gender'] ?? null,
                    'name'          => $voter_validation['response']['holder_name'] ?? null,
                    'relation_name' => $voter_validation['response']['relation'] ?? null,
                    'relation_type' => $voter_validation['response']['relation_type'] ?? null,
                    'dob'           => $voter_validation['response']['dob'] ?? null,
                    'age'           => $voter_validation['response']['age'] ?? null,
                    'area'          => $voter_validation['response']['area'] ?? null,
                    'district'      => $voter_validation['response']['district'] ?? null,
                ];

                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }

                    DB::table('voter_verification')->insert([
                        'user_id'       => $user->id,
                        'api_id'        => $api_id,
                        'epic_no'       => $voter['epic_no'],
                        'gender'        => $voter['gender'],
                        'name'          => $voter['name'],
                        'relation_name' => $voter['relation_name'],
                        'relation_type' => $voter['relation_type'],
                        'dob'           => $voter['dob'],
                        'age'           => $voter['age'],
                        'area'          => $voter['area'],
                        'district'      => $voter['district'],
                        'created_at'    => now(),
                        'updated_at'    => now()
                    ]);
                }

                return response()->json([
                    'statusCode' => 200,
                    'voter_validation' => $voter_validation
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

             
                if ($statusCode == 500) {

                    $headers = [
                        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                        'Accept'        => 'application/json'
                    ];

                    $body = [
                        'client_ref_num' => uniqid('vtr_'),
                        'epic_number'    => $request->voter_number
                    ];

                    $res = $client->post(
                        'https://svcdemo.digitap.work/validation/kyc/v1/voter',
                        ['headers' => $headers, 'json' => $body]
                    );

                    $digitapData = json_decode($res->getBody(), true);
                // return $digitapData;
                    if (($digitapData['result_code'] ?? 0) == 101) {

                    
                        $voter = [
                            'epic_no'       => $digitapData['result']['epic_no'] ?? null,
                            'gender'        => $digitapData['result']['gender'] ?? null,
                            'name'          => $digitapData['result']['name'] ?? null,
                            'relation_name' => $digitapData['result']['rln_name'] ?? null,
                            'relation_type' => $digitapData['result']['rln_type'] ?? null,
                            'age'           => $digitapData['result']['age'] ?? null,
                            'district'      => $digitapData['result']['dist_name'] ?? null,
                            'state'         => $digitapData['result']['st_name'] ?? null,
                        ];

                        if ($user->role_id == 1) {
                            $this->saveHitCount(
                                $user->id,
                                $api_id,
                                'Transaction Successful (Digitap)',
                                200
                            );

                            DB::table('voter_verification')->insert([
                                'user_id'       => $user->id,
                                'api_id'        => $api_id,
                                'epic_no'       => $voter['epic_no'],
                                'gender'        => $voter['gender'],
                                'name'          => $voter['name'],
                                'relation_name' => $voter['relation_name'],
                                'relation_type' => $voter['relation_type'],
                                'age'           => $voter['age'],
                                'district'      => $voter['district'],
                                'state'         => $voter['state'],
                                'service_provider' => 'DIGITAP',
                                'created_at'    => now(),
                                'updated_at'    => now()
                            ]);
                        }

                        return response()->json([
                            'statusCode' => 200,
                            'voter_validation' => $digitapData
                        ]);
                    }
                }

                if ($statusCode == 422) {
                    return response()->json([
                        'statusCode' => 102,
                        'message' => 'Verification Failed. Please enter correct Voter ID.'
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Error. Please contact techsupport@docboyz.in. for more details'
                ]);
            }
        } else {
            return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your plan.']);
        }
    }

    return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
}

        
    public function voter_validation_new26agust20225(Request $request)
    {
        // return 'test';
        $statusCode = null;
        $voter_validation = null;
        $api_id = null;

        if (empty($request->voter_number))
            return response()->json(array(['message' => 'Voter id number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'voter_id')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
        ];
        $voterno = $request->voter_number;

        // $body =  [
        //     'voter_id' => $request->voter_number
        // ];
        $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                try {
                    // $res = $client->post($this->base_url.'/voter-id/voter-id', ['headers' => $headers, 'json' => $body,'form_params' => ['api_token' => $token]]);
                    $res = $client->get('https://api.kyckart.com/api/voterId/searchV2?cardNumber=' . $voterno, ['headers' => $headers]);
                    $voter_validations = json_decode($res->getBody(), true);
                    // $voter_validations['response']['EPIC_NO'];

                    $voter_validation['code'] = 200;
                    $voter_validation['status'] = "success";
                    $voter_validation['response']['epic_no'] = $voter_validations['response']['EPIC_NO'];
                    $voter_validation['response']['dob'] = "NA";
                    $voter_validation['response']['holder_name'] = $voter_validations['response']['NAME'];
                    $voter_validation['response']['relation'] = $voter_validations['response']['RELATIVE_NAME'];
                    $voter_validation['response']['relation_type'] = $voter_validations['response']['RELATIVE_TYPE'];
                    $voter_validation['response']['age'] = $voter_validations['response']['AGE'];
                    $voter_validation['response']['gender'] = $voter_validations['response']['GENDER'];
                    $voter_validation['response']['area'] = $voter_validations['response']['PART_NAME'];
                    $voter_validation['response']['district'] = $voter_validations['response']['DISTRICT'];
                    $voter_validation['response']['assembly_constituency'] = $voter_validations['response']['ASSEMBLY_CONSTITUENCY_NAME'];
                    $voter_validation['response']['parliamentary_constituency'] = $voter_validations['response']['PARLIAMENTARY_CONSTITUENCY_NAME'];
                    $voter_validation['response']['polling_station'] = $voter_validations['response']['POLL_BOOTH_NAME'];
                    $voter_validation['response']['part_number'] = $voter_validations['response']['PART_NUM'];
                    $voter_validation['response']['part_name'] = $voter_validations['response']['PART_NAME'];
                    $voter_validation['response']['id'] = "NA";

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                        $votervalidation = DB::table('voter_verification')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $voter_validation['data']['client_id'],
                            "epic_no" => $voter_validation['response']['epic_no'],
                            "gender" => $voter_validation['response']['gender'],
                            // "state"=> $voter_validation['data']['state'],
                            "name" => $voter_validation['response']['holder_name'],
                            "relation_name" => $voter_validation['response']['relation'],
                            "relation_type" => $voter_validation['response']['relation_type'],
                            // "house_no"=> $voter_validation['data']['house_no'],
                            "dob" => $voter_validation['response']['dob'],
                            "age" => $voter_validation['response']['age'],
                            "area" => $voter_validation['response']['area'],
                            "district" => $voter_validation['response']['district'],
                            // "multiple"=> $voter_validation['data']['multiple'],
                            // "last_update"=> $voter_validation['data']['last_update'],
                            // "assembly_constituency"=> $voter_validation['data']['assembly_constituency'],
                            // "assembly_constituency_number"=> $voter_validation['data']['assembly_constituency_number'],
                            // "polling_station"=> $voter_validation['data']['polling_station'],
                            // "part_number"=> $voter_validation['data']['part_number'],
                            // "part_name"=> $voter_validation['data']['part_name'],
                            // "slno_inpart"=> $voter_validation['data']['slno_inpart'],
                            // "ps_lat_long"=> $voter_validation['data']['ps_lat_long'],
                            // "rln_name_v1"=> $voter_validation['data']['rln_name_v1'],
                            // "rln_name_v2"=> $voter_validation['data']['rln_name_v2'],
                            // "rln_name_v3"=> $voter_validation['data']['rln_name_v3'],
                            // "section_no"=> $voter_validation['data']['section_no'],
                            // "name_v1"=> $voter_validation['data']['name_v1'],
                            // "name_v2"=> $voter_validation['data']['name_v2'],
                            // "name_v3"=> $voter_validation['data']['name_v3'],
                            // "st_code"=> $voter_validation['data']['st_code'],
                            // "parliamentary_constituency"=> $voter_validation['data']['parliamentary_constituency'],
                            // "v_id"=> $voter_validation['data']['id'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Voter ID.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['voter_validation' => $voter_validation, 'statusCode' => '200']));
    }

    //voter upload api implementation
    public function voter_upload(Request $request)
    {
        $api_id = null;
        $voter_validation = null;
        if (!$request->hasFile('file')) {
            return json_encode(['message' => "File is required", 'statusCode' => '404'], true);
        }
        // echo $_FILES['file']['name'];
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'voterupload')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl1 = curl_init();
                curl_setopt_array($curl1, array(
                    CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/ocr/voter",
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => "",
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => "POST",
                    CURLOPT_POSTFIELDS => array(
                        "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                    ),
                    CURLOPT_HTTPHEADER => array(
                        "Authorization: " . $this->token,
                    ),
                ));
                $ocr_data = curl_exec($curl1);
                $ocr_data = json_decode($ocr_data, true);
                //   return  $ocr_data; 
                if ($ocr_data['status_code'] == 200) {
                    // return 'asas';
                    $client = new Client();
                    $headers = [
                        'Authorization' => $this->token,
                        'Accept' => 'application/json',
                    ];

                    $body = [
                        'id_number' => $ocr_data['data']['ocr_fields'][0]['epic_number']['value']
                    ];


                    $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
                    try {
                        $res = $client->post($this->base_url . '/voter-id/voter-id', ['headers' => $headers, 'json' => $body, 'form_params' => ['api_token' => $token]]);
                        $voter_validation = json_decode($res->getBody(), true);
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $votervalidation = DB::table('voter_verification')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "client_id" => $voter_validation['data']['client_id'],
                                "epic_no" => $voter_validation['data']['epic_no'],
                                "gender" => $voter_validation['data']['gender'],
                                "state" => $voter_validation['data']['state'],
                                "name" => $voter_validation['data']['name'],
                                "relation_name" => $voter_validation['data']['relation_name'],
                                "relation_type" => $voter_validation['data']['relation_type'],
                                "house_no" => $voter_validation['data']['house_no'],
                                "dob" => $voter_validation['data']['dob'],
                                "age" => $voter_validation['data']['age'],
                                "area" => $voter_validation['data']['area'],
                                "district" => $voter_validation['data']['district'],
                                "multiple" => $voter_validation['data']['multiple'],
                                "last_update" => $voter_validation['data']['last_update'],
                                "assembly_constituency" => $voter_validation['data']['assembly_constituency'],
                                "assembly_constituency_number" => $voter_validation['data']['assembly_constituency_number'],
                                "polling_station" => $voter_validation['data']['polling_station'],
                                "part_number" => $voter_validation['data']['part_number'],
                                "part_name" => $voter_validation['data']['part_name'],
                                "slno_inpart" => $voter_validation['data']['slno_inpart'],
                                "ps_lat_long" => $voter_validation['data']['ps_lat_long'],
                                "rln_name_v1" => $voter_validation['data']['rln_name_v1'],
                                "rln_name_v2" => $voter_validation['data']['rln_name_v2'],
                                "rln_name_v3" => $voter_validation['data']['rln_name_v3'],
                                "section_no" => $voter_validation['data']['section_no'],
                                "name_v1" => $voter_validation['data']['name_v1'],
                                "name_v2" => $voter_validation['data']['name_v2'],
                                "name_v3" => $voter_validation['data']['name_v3'],
                                "st_code" => $voter_validation['data']['st_code'],
                                "parliamentary_constituency" => $voter_validation['data']['parliamentary_constituency'],
                                "v_id" => $voter_validation['data']['id'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                    } catch (BadResponseException $e) {
                        $statusCode = $e->getResponse()->getStatusCode();
                        $response = $e->getResponse();
                        $errorResponse = json_decode($response->getBody(), true);
                        // return  $errorResponse;
                        if ($statusCode == 500) {
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 422) {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter valid details.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['ocr_fields' => $ocr_data, 'voter_validation' => $voter_validation, 'statusCode' => '200']));
    }



    //CRIF
    public function crif_report(Request $request)
    {
        $statusCode = null;
        $crif_report = null;
        $api_id = null;


        $validator = Validator::make($request->all(), [
            'full_name' => ['required', 'string', 'max:255'],
            'pancard_no' => ['required', 'string', 'max:255'],
            'otp' => ['required', 'string', 'max:4'],
            'phone' => ['required', 'numeric', 'min:10'],
            'dob' => ['required', 'string'], //yyyy-mm-dd
            'zipcode' => ['string'],
            'addrline2' => ['string'],
            'addrline1' => ['string'],
            'city' => ['string']
        ]);

        if ($validator->fails()) {
            return response()->json(['Error' => $validator->errors(), 'statusCode' => '404']);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);
        }

        $otp_verification = OTP::where([['phone', $request->phone], ['otp', $request->otp]])->first();
        if ($request->zipcode == null || !isset($request->zipcode)) {
            $request->zipcode = 175024;
        }
        if ($request->addrline2 == null || !isset($request->addrline2)) {
            $request->addrline2 = "Address line 2";
        }
        if ($request->addrline1 == null || !isset($request->addrline1)) {
            $request->addrline1 = "Address line 1";
        }
        if ($request->city == null || !isset($request->city)) {
            $request->city = "hyderabad";
        }
        if (!$otp_verification) {
            return response()->json(['message' => 'OTP is incorrect for given phone number', 'statusCode' => '404']);
        }

        if ($otp_verification) {
            $otp_verification->delete();
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'creditreport')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }



        $client = new Client();

        $headers = [
            'X-API-KEY' => 'MEtOdRx3fn4o9zeVAXByVQoKpXn66c3fli4rcCkLy9',
            'DEV-ACCESS-KEY' => 'CxFJiV2eqm99KpQqzOJMLxVW2eBZwAiMYaezH57P'
        ];
        $json = [
            'gender' => "male",
            'dob' => $request->dob,
            'pan_card' => $request->pancard_no,
            'mobile_number' => $request->phone,
            'full_name' => $request->full_name,
            "home" => [
                "zipcode" => $request->zipcode,
                "address" => [
                    "line2" => $request->addrline2,
                    "line1" => $request->addrline1
                ],
                "city" => $request->city,

            ],
            "allowed_for_awesomeui" => "yes"
        ];
        if ($user->id != 3) {
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    try {
                        $response = $client->post($this->crif_url, [
                            'headers' => $headers,
                            'json' => $json
                        ]);
                        $crif_report = json_decode($response->getBody(), true);
                        $Crif = new crifdb();
                        $Crif->user_id = $user->id;
                        $Crif->full_name = $crif_report['data']['request_meta']['full_name'];
                        $Crif->gender = $crif_report['data']['request_meta']['gender'];
                        ;
                        $Crif->pan_card_no = $crif_report['data']['request_meta']['pan_card'];
                        $Crif->mob_no = $crif_report['data']['request_meta']['mobile_number'];
                        $Crif->save();
                        if (!empty($crif_report['data']['credit_account']['enquiry']['MEMBER-NAME'])) {
                            $member_function = str_replace('LOANTAP CREDIT PRODUCTS PVT LTD', 'DB|' . $user->name, $crif_report['data']['credit_account']['enquiry']['MEMBER-NAME']);
                            $crif_report['data']['credit_account']['enquiry']['MEMBER-NAME'] = $member_function;
                            // $crif_report['data']['credit_account']['enquiry'][1]['MEMBER-NAME'] = $member_function;
                        }
                        if (!empty($crif_report['data']['credit_account']['enquiry'][0]['MEMBER-NAME'])) {
                            $member_function = str_replace('LOANTAP CREDIT PRODUCTS PVT LTD', 'DB|' . $user->name, $crif_report['data']['credit_account']['enquiry'][0]['MEMBER-NAME']);
                            $crif_report['data']['credit_account']['enquiry'][0]['MEMBER-NAME'] = $member_function;
                            $crif_report['data']['credit_account']['enquiry'][1]['MEMBER-NAME'] = $member_function;
                        }

                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                    } catch (BadResponseException $e) {
                        $statusCode = $e->getResponse()->getStatusCode();
                        if ($statusCode == 500) {
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 422) {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter valid details.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service.']);
        }

        return response()->json(array('Credit Report' => $crif_report, 'statusCode' => '200'));
    }

    public function generate_otp(Request $request)
    {
        // return 'asas';
        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);
        }

        // $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));

        // if ($verifyAccessToken == false){
        //     return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));
        // }

        $validator = Validator::make($request->all(), [
            'phone' => ['required', 'numeric', 'min:10'],
        ]);

        if ($validator->fails()) {
            return response()->json(['error' => $validator->errors(), 'statusCode' => '404']);
        }


        $otp = rand(1111, 9999);
        $newotp = new OTP;
        $newotp->otp = $otp;
        $newotp->phone = $request->phone;
        $newotp->access_token = $request->header('AccessToken');
        $newotp->save();
        // $otp = new OTP;
        // $otp->otp = $code;
        // $otp->phone = $request->phone;
        // $otp->access_token = $request->header('AccessToken');
        // $otp->save();

        $authKey = "368753AXggrthFX61713441P1";
        $senderId = "DocBoy";

        $message = urlencode(
            "Dear%20Customer,2323%20OTP%20for%20Login%20Thank%20You%20Team%20DocBoyz"
        );
        //Define route 
        $route = "4";
        $prt = '91';
        //Prepare you post parameters
        $number = $request->phone;
        $newno = $prt . $number;
        $postData = array(
            'authkey' => $authKey,
            'mobiles' => $newno,
            'message' => $message,
            'sender' => $senderId,
            'otp' => $otp,
            'route' => $route
        );
        //API URL
        $url = "https://api.msg91.com/api/sendotp.php?authkey=368753AXggrthFX61713441P1&mobiles=$newno&message=Dear%20Customer,$otp%20OTP%20for%20Login%20Thank%20You%20Team%20DocBoyz&sender=DocBoy&otp=$otp&DLT_TE_ID=1307163462070500440";
        // init the resource
        $curl = curl_init();
        curl_setopt_array($curl, array(
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 30,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "GET",
            CURLOPT_POSTFIELDS => $postData,
            CURLOPT_HTTPHEADER => array(
                "content-type: application/JSON"
            ),
        ));
        //Ignore SSL certificate verification
        $response = curl_exec($curl);
        $err = curl_error($curl);
        curl_close($curl);
        if ($err) {
            return response()->json(['error' => 'Something went wrong. Please try again.']);
        } else {
            return response()->json(['success' => 'OTP sent successfully']);
        }
    }
    // public function aadhaar_otp_genrate_api(Request $request) {
    //     // return 'sdsds';
    //     $statusCode = null;
    //     $aadhaar_otp_genrate = null;
    //     $hit_limits_exceeded = 0;

    //     // if($request->isMethod('GET')){

    //     //     return view('kyc.aadhaar_otp_genrate', compact('aadhaar_otp_genrate', 'statusCode','hit_limits_exceeded'));
    //     // }
    //     if(empty($request->aadhaar_number))
    //     return response()->json(array(['message'=>'Aadhaar number is required','statusCode'=>'404']));

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['message'=>'Header Access Token is required','statusCode'=>'404']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['message'=>'Wrong Access Token','statusCode'=>'403']));

    // $user = User::where('access_token',$request->header('AccessToken'))->first();
    // if($user->role_id==1) {
    //     $apiamster = ApiMaster::where('api_slug','aadhaar')->first();
    //     if($apiamster)
    //         $api_id = $apiamster->id;
    // }

    //     if($request->isMethod('POST')){
    //         // return 'sdsdssasa';
    //         //  $client = new Client();
    //         // $headers = [
    //         //     'Authorization' => $this->token,        
    //         //     'Accept'        => 'application/json',
    //         // ];
    //         // $body =  [
    //         //     'id_number' => $request->pan_number
    //         // ];

    //         // if(Auth::user()->scheme_type!='demo') {
    //         //     if(Auth::user()->role_id==1) {
    //         //         $apiamster = ApiMaster::where('api_slug','aadhaar')->first();
    //         //         if($apiamster)
    //         //             $api_id = $apiamster->id;
    //         //     }

    //             $client = new Client();
    //             $headers = [
    //                 'Authorization' => $this->token,        
    //                 'Accept'        => 'application/json',
    //             ];

    //             $body =  [
    //                 'id_number' => $request->aadhaar_number
    //             ];
    //             //  return 'sdsdsdoo';
    //             try{
    //                 // return 'sssss';
    //                 $res = $client->post($this->base_url.'/aadhaar-v2/generate-otp', ['headers' => $headers, 'json' => $body]);
    //                 $aadhaar_otp_genrate = json_decode($res->getBody(), true);
    //                 return 'ddd';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id);
    //                     }
    //                 }
    //                 return response()->json(array(['aadhaar_otp_genrate'=>$aadhaar_otp_genrate,'statusCode'=>'200']));

    //             } catch(BadResponseException $e) {
    //                 $statusCode = $e->getResponse()->getStatusCode();
    //             }


    //     }


    //     // return view('kyc.aadhaar_otp_genrate', compact('aadhaar_otp_genrate', 'statusCode','hit_limits_exceeded'));
    // }
    public function aadhaar_otp_genrate_api3july2025(Request $request)
    {
        // return'sdsd';
        $statusCode = null;
        $aadhaar_validation = null;
        $api_id = null;

        if (empty($request->aadhaar_number))
            return response()->json(array(['message' => 'Aadhaar number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'aadharotpgenrate')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->signzytoken,
            'Accept' => 'application/json',
        ];

        $body = [
            'aadhaarNumber' => $request->aadhaar_number
        ];
        // return $api_id;
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // return  $user->id;

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post($this->base_urln . '/getOkycOtp', ['headers' => $headers, 'json' => $body]);
                    $aadhaar_otp_genrate = json_decode($res->getBody(), true);

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Aadhar Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['aadhaar_validation' => $aadhaar_otp_genrate, 'statusCode' => '200']));
    }

    public function aadhaar_otp_genrate_api(Request $request)
    {
        // return'sdsd';
        $statusCode = null;
        $aadhaar_validation = null;
        $api_id = null;

        if (empty($request->aadhaar_number))
            return response()->json(array(['message' => 'Aadhaar number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'aadharotpgenrate')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->signzytoken,
            'Accept' => 'application/json',
        ];

        $body = [
            'aadhaarNumber' => $request->aadhaar_number
        ];
        // return $api_id;
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // return  $user->id;

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $res = $client->post($this->base_urln . '/getOkycOtp', ['headers' => $headers, 'json' => $body]);
                    // $aadhaar_otp_genrate = json_decode($res->getBody(), true);

                    if ($user->role_id == 1) {

                        $response = Http::withHeaders([
                            'X-Client-ID' => 'Getlab.pvt',
                            'X-API-Key' => 'f67ede4edd704b57877c5d41935d20a6',
                            'Content-Type' => 'application/json',
                        ])->post('https://app.verifyapi.in/gen', [
                            'id_number' => $request->aadhaar_number,
                        ]);

                        return response()->json([
                            'status' => $response->status(),
                            'data' => $response->json(),
                        ]);

                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                        
                    }else{
                        
                        $response = Http::withHeaders([
                            'X-Client-ID' => 'Getlab.pvt',
                            'X-API-Key' => 'f67ede4edd704b57877c5d41935d20a6',
                            'Content-Type' => 'application/json',
                        ])->post('https://app.verifyapi.in/gen', [
                            'id_number' => $request->aadhaar_number,
                        ]);

                        return response()->json([
                            'status' => $response->status(),
                            'data' => $response->json(),
                        ]);

                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Aadhar Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['aadhaar_validation' => $aadhaar_otp_genrate, 'statusCode' => '200']));
    }

    public function aadhaar_otp_submit3jully2025(Request $request)
    {
        $statusCode = null;
        $aadhaar_otp_submit = null;
        $hit_limits_exceeded = 0;
        $api_id = null;

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'aadharotpsubmit')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->signzytoken,
            'Accept' => 'application/json',
        ];

        if (isset($request->client_id)) {
            $body = [
                'requestId' => $request->client_id,
                'otp' => $request->otp
            ];
        } else {

            $body = [
                'requestId' => $request->clientid,
                'otp' => $request->otp
            ];

        }


        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post($this->base_urln . '/fetchOkycData', ['headers' => $headers, 'json' => $body]);
                    $aadhaar_otp_submit = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array(['aadhaar_otp_submit' => $aadhaar_otp_submit, 'statusCode' => '200']));
    }

    public function aadhaar_otp_submit(Request $request)
    {
        // return 'test';
        $statusCode = null;
        $aadhaar_otp_submit = null;
        $hit_limits_exceeded = 0;
        $api_id = null;

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'aadharotpsubmit')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => $this->signzytoken,
            'Accept' => 'application/json',
        ];

        if (isset($request->client_id)) {
            $body = [
                'requestId' => $request->client_id,
                'otp' => $request->otp
            ];
        } else {

            $body = [
                'requestId' => $request->clientid,
                'otp' => $request->otp
            ];

        }


        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $res = $client->post($this->base_urln . '/fetchOkycData', ['headers' => $headers, 'json' => $body]);
                    // $aadhaar_otp_submit = json_decode($res->getBody(), true);
                    // if ($user->role_id == 1) {
                    //     if ($apiamster) {
                    //         $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    //     }
                    // }

                     $response = Http::withHeaders([
                            'X-Client-ID' => 'Getlab.pvt',
                            'X-API-Key' => 'f67ede4edd704b57877c5d41935d20a6',
                            'Content-Type' => 'application/json',
                        ])->post('https://app.verifyapi.in/sub', [
                            'request_id' => $request->client_id,
                            'otp' => $request->otp,
                        ]);

                        return response()->json([
                            'status' => $response->status(),
                            'data' => $response->json(),
                        ]);

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array(['aadhaar_otp_submit' => $aadhaar_otp_submit, 'statusCode' => '200']));
    }


    public function equifax(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'FirstName' => ['required', 'string', 'max:255'],
            'LastName' => ['required', 'string', 'max:255'],
            'ContactNo' => ['required', 'string', 'max:255'],
            'IDValue' => ['required'],
        ]);

        if ($validator->fails())
            return response()->json([
                'Errors' => $validator->errors(),
                'statusCode' => '404'
            ]);

        $body = [
            "RequestHeader" => [
                "CustomerId" => "21",
                "UserId" => "UAT_ZAPTEK",
                "Password" => "V2*Pdhbr",
                "MemberNumber" => "027BB02400",
                "SecurityCode" => "N42",
                "ProductCode" => [
                    "PCRLT"
                ],
                "CustRefField" => "REF16271"
            ],


            "RequestBody" => [
                "InquiryPurpose" => "00",
                "FirstName" => $request->FirstName,
                "MiddleName" => $request->MiddleName,
                "LastName" => $request->LastName,
                "InquiryPhones" => [
                    [
                        "seq" => "1",
                        "Number" => $request->ContactNo,
                        "PhoneType" => [
                            "M"
                        ]
                    ]
                ],
                "IDDetails" => [
                    [
                        "seq" => "1",
                        "IDValue" => $request->IDValue,
                        "IDType" => "T",
                        "Source" => "Inquiry"
                    ],
                    [
                        "seq" => "2",
                        "IDValue" => $request->IDValue,
                        "IDType" => "P",
                        "Source" => "Inquiry"
                    ],
                    [
                        "seq" => "3",
                        "IDValue" => $request->IDValue,
                        "IDType" => "V",
                        "Source" => "Inquiry"
                    ],
                    [
                        "seq" => "4",
                        "IDValue" => $request->IDValue,
                        "IDType" => "D",
                        "Source" => "Inquiry"
                    ],
                    [
                        "seq" => "5",
                        "IDValue" => $request->IDValue,
                        "IDType" => "M",
                        "Source" => "Inquiry"
                    ]
                ]
            ],
            "Score" => [
                [
                    "Type" => "ERS",
                    "Version" => "3.1"
                ]
            ]
        ];

        if ($request->isMethod('POST')) {
            $client = new Client();
            $res = $client->post($this->equifax_url, ['json' => $body]);
            $response = json_decode($res->getBody());
            return response()->json(['Equifax_Report' => $response, 'statusCode' => '200']);
        }
    }

    public function passport_verification(Request $request)
    {
        // return 'test';
        $statusCode = null;
        $passport_verification = null;
        $api_id = null;

        $validator = Validator::make($request->all(), [
            'id_number' => ['required', 'string'],
            'dob' => ['required', 'string']
        ]);
        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        if (!$request->headers->has('AccessToken'))
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));

        if ($verifyAccessToken == false)
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'passportverify')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $client = new Client();
        $headers = [
            'Content-type' => 'application/json',
            'Authorization'=>'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
            // 'Authorization' => $this -> token
        ];
                    $randomInt = strval(rand(100, 999));

        $json = [
            // 'id_number'=> $request->id_number,
            'client_ref_num' => $randomInt,
            'file_number' => $request->id_number,
            'dob' => $request->dob
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $res = $client->post($this->base_url.'/passport/passport/passport-details', ['headers' => $headers,'json' => $json]);
                    // $res = $client->post($this->base_url.'/aadhaar-validation/aadhaar-validation', ['headers' => $headers, 'json' => $body]);
                    // $res = $client->post('https://api.kyckart.com/api/passport/search', ['headers' => $headers, 'json' => $json]);
                    $res = $client->post('https://svcdemo.digitap.work/validation/kyc/v1/passport', ['headers' => $headers, 'json' => $json]);
                    $passportverify = json_decode($res->getBody(), associative: true);
                    // return $passportverify;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Verification_Details' => $passportverify, 'statusCode' => '200'));
    }



    public function passport_verification22agust2025(Request $request)
    {
        // return 'test';
        $statusCode = null;
        $passport_verification = null;
        $api_id = null;

        $validator = Validator::make($request->all(), [
            'id_number' => ['required', 'string'],
            'dob' => ['required', 'string']
        ]);
        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        if (!$request->headers->has('AccessToken'))
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));

        if ($verifyAccessToken == false)
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'passportverify')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $client = new Client();
        $headers = [
            'Content-Type' => 'application/json',
            // 'Authorization' => $this -> token
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq'
        ];
        $json = [
            // 'id_number'=> $request->id_number,
            'fileNumber' => $request->id_number,
            'dob' => $request->dob
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $res = $client->post($this->base_url.'/passport/passport/passport-details', ['headers' => $headers,'json' => $json]);
                    // $res = $client->post($this->base_url.'/aadhaar-validation/aadhaar-validation', ['headers' => $headers, 'json' => $body]);
                    $res = $client->post('https://api.kyckart.com/api/passport/search', ['headers' => $headers, 'json' => $json]);
                    $passportverify = json_decode($res->getBody(), true);
                    // return $passportverify;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Verification_Details' => $passportverify, 'statusCode' => '200'));
    }

    public function passport_upload(Request $request)
    {

        if (!$request->hasFile('file')) {
            return response()->json(['message' => "file not found"], true);
        }
        $curl1 = curl_init();
        curl_setopt_array($curl1, array(
            CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/passport/passport/" . $request->client_id . "/upload",
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 0,
            CURLOPT_FOLLOWLOCATION => true,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "GET",
            CURLOPT_POSTFIELDS => array(
                "file" => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
            ),
            CURLOPT_HTTPHEADER => array(
                "Authorization: " . $this->token,
            ),
        ));
        // $get_data1 = curl_exec($curl1);
        $result = curl_exec($curl1);
        $passport = json_decode($result, true);
        $status_code = $passport['status_code'];
        // dd($passport);
        // echo 'status_code='.$status_code;
        $passport_verification = null;
        $is_verified = 0;


        return response()->json(array('OCR_DATA' => $passport, 'statusCode' => $status_code));
    }


    public function telecom_generate_otp(Request $request)
    {
        $statusCode = null;
        $telecom_generate_otp = null;
        $api_id = null;
        $validator = Validator::make($request->all(), [
            "id_number" => ['required', 'numeric']
        ]);
        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        if (!$request->headers->has('AccessToken'))
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'telecom')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json'
        ];
        $json = [
            'id_number' => $request->id_number
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post($this->base_url . '/telecom/generate-otp', [
                        'headers' => $headers,
                        'json' => $json
                    ]);
                    $telecom_generate_otp = json_decode($response->getBody(), true);
                    return $telecom_generate_otp;

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //  return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct phone number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else if ($statusCode == 400) {
                        $errorMessage = 'Wrong Phone Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {

                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Telecom Generate OTP Details' => $telecom_generate_otp, 'statusCode' => '200'));
    }


    public function telecom_submit_otp(Request $request)
    {
        $statusCode = null;
        $telecom_submit_otp = null;
        $api_id = null;
        $validator = Validator::make($request->all(), [
            'client_id' => ['required', 'string'],
            'otp' => ['required', 'numeric']
        ]);
        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        if (!$request->headers->has('AccessToken'))
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'telecom')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json'
        ];
        $json = [
            'client_id' => $request->client_id,
            'otp' => $request->otp
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post($this->base_url . '/telecom/submit-otp', [
                        'headers' => $headers,
                        'json' => $json
                    ]);
                    $telecom_submit_otp = json_decode($response->getBody(), true);
                    // dd($telecom_submit_otp);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Telecom Submit OTP' => $telecom_submit_otp, 'statusCode' => '200'));
    }
    public function equifaxurlscoreonly(Request $request)
    {
        // return 'hi';
        $validator = Validator::make($request->all(), [
            'phone_number' => 'required|regex:/^[0-9]{10}$/',
        ]);
        if ($validator->fails()) {
            return response()->json([
                'status' => 'Forbidden',
                'errors' => $validator->errors(),
            ], 403);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);
        }

        $sql = DB::table('equifax_pdf_request')->insert([
            'firstName' => $request->fname,
            'lastName' => $request->lname,
            'contactNo' => $request->phone_number,
            'idValue' => $request->pan_num,
            'created_at' => date('Y-m-d H:i:s')
        ]);
        $api_id = null;
        // $validator = Validator::make($request -> all(),[
        //     // 'FirstName' => ['required','string','max:255'],
        //     // 'LastName' => ['required','string','max:255'],
        //     'ContactNo' => ['required','string','max:255'],
        //     'IDValue' => ['required'],
        // ]);
        $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
        $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
        $pan_num = $request->pan_num ? $request->pan_num : null;
        $voter_id = $request->voter_num ? $request->voter_num : null;
        $passport = $request->passport_num ? $request->passport_num : null;
        $driving_licence = $request->driving_num ? $request->driving_num : null;

        // if($validator -> fails())
        //     return response() -> json(['Errors' => $validator -> errors(),
        //                                 'statusCode' => '404']);
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'equifax_score')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $uname = $user->name;
        // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
        $arr = explode(' ', trim($uname));
        $usr = '';
        $substr = '';
        foreach ($arr as $array) {
            $substr = substr($array, 0, 1);
            $usr = $usr . $substr;
        }
        $recordId = sprintf("%04d", $record_id->id);
        $CustRefField = "DB-" . strtoupper($usr) . Carbon::now()->format('y') . Carbon::now()->format('m') . $recordId;
        $body = [
            "InquiryPurpose" => "10",
            "TransactionAmount" => "",
            "FirstName" => $request->fname,
            "MiddleName" => "",
            "LastName" => $request->lname,
            "InquiryAddresses" => [
                [
                    "seq" => "1",
                    "AddressType" => [
                        "H"
                    ],
                    "AddressLine1" => "",
                    "AddressLine2" => "",
                    "Locality" => "",
                    "City" => "",
                    "State" => "",
                    "Postal" => ""
                ]
            ],
            "InquiryPhones"=>[
                    [
                        "seq"=>"16",
                        "Number"=>$request->phone_number,
                        "PhoneType"=>[
                            "M"
                        ]
                    ]
                ],
            "IDDetails" => [
                [
                    "seq" => "1",
                    "IDType" => "T",
                    "IDValue" => $request->pan_num
                ]
            ],
            "DOB" => $request->dob
        ];
        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0bGFuZCIsImlhdCI6MTY5MTM4NDEzODczNH0.nHmNhb-NlFPziNE_-9iEGKTIVoiz5rM_lNVvPLvQLgU',
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $client = new Client();
                    $res = $client->post("https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score", ['headers' => $headers, 'json' => $body]);
                    $response = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(["statusCode" => 500, 'message' => "Please Recharge your wallet."]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        if (isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) && $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] > 0) {
            $credit_score = null;
            $credit_score['data']['Name'] = $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'];
            // $credit_score['data']['DateOfBirth'] = $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'];
            $credit_score['data']['ScoreDetails'] = $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'][0]['Value'];
            // return $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'];
            return response()->json(['Score' => $credit_score, 'statusCode' => '200']);
        } else {
            // return response()->json(['statusCode'=>102, 'message'=>'Please enter valid details']);
            // $credit_score = null;
            // $credit_score['data']['personal_details'] = $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'];
            // $credit_score['data']['ScoreDetails'] = $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'];
            // return response()->json(['statusCode'=>102, 'message'=>$credit_score]);
            $equifaxResponseConsumer = null;
            $equifaxResponseConsumer['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
            $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
            $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
            $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
            $equifaxResponseConsumer['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
            $equifaxResponseConsumer['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
            $equifaxResponseConsumer['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['Error'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Error']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Error'] : null;
            return response()->json(['statusCode' => 102, 'message' => $equifaxResponseConsumer]);

        }


    }

    // public function equifaxurlscoreonly(Request $request){
    //     // return 'hi';
    //     $validator = Validator::make($request->all(), [ 
    //         'phone_number' => 'required|regex:/^[0-9]{10}$/',
    //     ]);
    //     if ($validator->fails()) {
    //         return response()->json([
    //             'status' => 'Forbidden',
    //             'errors' => $validator->errors(),
    //         ], 403);
    //     }

    //     $sql = DB::table('equifax_pdf_request')->insert([
    //         'firstName' => $request->fname,
    //         'lastName' => $request->lname,
    //         'contactNo'=> $request->phone_number,
    //         'idValue'=> $request->id_value,
    //         'created_at'=>date('Y-m-d H:i:s')
    //     ]);
    //     $api_id = null;
    //     // $validator = Validator::make($request -> all(),[
    //     //     // 'FirstName' => ['required','string','max:255'],
    //     //     // 'LastName' => ['required','string','max:255'],
    //     //     'ContactNo' => ['required','string','max:255'],
    //     //     'IDValue' => ['required'],
    //     // ]);
    //     $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
    //     $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
    //     $pan_num = $request->pan_num ? $request->pan_num : null;
    //     $voter_id = $request->voter_num ? $request->voter_num : null;
    //     $passport = $request->passport_num ? $request->passport_num : null;
    //     $driving_licence = $request->driving_num ? $request->driving_num : null;

    //     // if($validator -> fails())
    //     //     return response() -> json(['Errors' => $validator -> errors(),
    //     //                                 'statusCode' => '404']);
    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //      if($user->role_id==1) {
    //             $apiamster = ApiMaster::where('api_slug','equifax_score')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //         }
    //         $uname = $user->name;
    //         // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
    //         $arr = explode(' ', trim($uname));
    //         $usr = '';
    //         $substr = '';
    //         foreach($arr as $array){
    //             $substr = substr($array, 0, 1);
    //             $usr = $usr.$substr;
    //         }
    //         $recordId = sprintf("%04d", $record_id->id);
    //         $CustRefField = "DB-".strtoupper($usr).Carbon::now()->format('y').Carbon::now()->format('m').$recordId;
    //         $body = 
    //             [
    //                 "RequestHeader"=> [
    //                     "CustomerId"=>"7656",
    //                     "UserId"=>"STS_LOANTA",
    //                     "Password"=>"W3#QeicsB",
    //                     "MemberNumber"=>"027FP27964",
    //                     "SecurityCode"=>"6IT",
    //                     "ProductCode"=> [
    //                         "PCRLT"
    //                     ],
    //                     "CustRefField" => $CustRefField
    //                 ],
    //                 "RequestBody"=>[
    //                     "InquiryPurpose"=>"16",
    //                     "FirstName"=>$request->fname,
    //                     "MiddleName"=>"",
    //                     "LastName"=>$request->lname,
    //                     "DOB"=>$request->dob,
    //                     "InquiryPhones"=>[
    //                         [
    //                             "seq"=>"1",
    //                             "Number"=>$request->phone_number,
    //                             "PhoneType"=>[
    //                                 "M"
    //                             ]
    //                         ]
    //                     ],
    //                     "IDDetails"=>[
    //                         [
    //                             "seq"=>"1",
    //                             "IDType"=>"t",
    //                             "IDValue"=>$request->pan_num,
    //                             "Source"=> "Inquiry"
    //                         ]
    //                     ]
    //                 ],
    //                 "Score"=>[
    //                     [
    //                         "Type"=>"ERS",
    //                         "Version"=>"3.1"
    //                     ]
    //                 ]
    //             ];    
    //         $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //         if($updateHitCount || $user->role_id==0){
    //           if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type=="role_postpaid") {

    //             try
    //             {      
    //                 $client = new Client();
    //                 $res = $client -> post($this -> equifax_url,['json' => $body]);
    //                 $response = json_decode($res -> getBody(),true);
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                     }
    //                 }

    //             }
    //             catch(BadResponseException $e){
    //                 $statusCode = $e->getResponse()->getStatusCode();
    //                 if($statusCode == 500){
    //                     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                     if($user->role_id==1) {
    //                         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                     }
    //                 }else if($statusCode == 422){
    //                     $statusCode = 102;
    //                     $errorMessage = 'Verification Failed. Please enter valid details.';
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }else{
    //                     $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }
    //                 return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //             }
    //          }
    //          else{
    //             return response()->json(["statusCode"=>500,'message'=>"Please Recharge your wallet."]);
    //          }
    //         }else{
    //             return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //         } 
    //         $equifaxstatus = $response['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'];
    //         // return $equifax;
    //         if($equifaxstatus > 0){
    //             $credit_score = null;
    //             $credit_score['data']['Name'] = $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'];
    //             // $credit_score['data']['DateOfBirth'] = $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'];
    //             $credit_score['data']['ScoreDetails'] = $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'][0]['Value'];
    //             // return $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'];
    //             return response() -> json(['Score' => $credit_score,'statusCode' => '200']);
    //         }
    //         else{
    //             // return response()->json(['statusCode'=>102, 'message'=>'Please enter valid details']);
    //             // $credit_score = null;
    //             // $credit_score['data']['personal_details'] = $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'];
    //             // $credit_score['data']['ScoreDetails'] = $response['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'];
    //             // return response()->json(['statusCode'=>102, 'message'=>$credit_score]);
    //             return response()->json(['statusCode'=>102, 'message'=>$response]);
    //         }
    //  }
//     public function equifaxurl(Request $request){
//         $validator = Validator::make($request->all(), [ 
//             'phone_number' => 'required|regex:/^[0-9]{10}$/',
//         ]);
//         if ($validator->fails()) {
//             return response()->json([
//                 'status' => 'Forbidden',
//                 'errors' => $validator->errors(),
//             ], 403);
//         }

    //         $sql = DB::table('equifax_pdf_request')->insert([
//             'firstName' => $request->fname,
//             'lastName' => $request->lname,
//             'contactNo'=> $request->phone_number,
//             'idValue'=> $request->id_value,
//             'created_at'=>date('Y-m-d H:i:s')
//         ]);
//         $api_id = null;
//         // $validator = Validator::make($request -> all(),[
//         //     // 'FirstName' => ['required','string','max:255'],
//         //     // 'LastName' => ['required','string','max:255'],
//         //     'ContactNo' => ['required','string','max:255'],
//         //     'IDValue' => ['required'],
//         // ]);
//         $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
//         $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
//         $pan_num = $request->pan_num ? $request->pan_num : null;
//         $voter_id = $request->voter_num ? $request->voter_num : null;
//         $passport = $request->passport_num ? $request->passport_num : null;
//         $driving_licence = $request->driving_num ? $request->driving_num : null;

    //         // if($validator -> fails())
//         //     return response() -> json(['Errors' => $validator -> errors(),
//         //                                 'statusCode' => '404']);
//         $user = User::where('access_token',$request->header('AccessToken'))->first();
//             // return 'true';
//             if($user->role_id==1) {
//                 $apiamster = ApiMaster::where('api_slug','equifax')->first();
//             if($apiamster)
//                 $api_id = $apiamster->id;
//             }
//             $uname = $user->name;
//             // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
//             $arr = explode(' ', trim($uname));
//             $usr = '';
//             $substr = '';
//             foreach($arr as $array){
//                 $substr = substr($array, 0, 1);
//                 $usr = $usr.$substr;
//             }
//             $recordId = sprintf("%04d", $record_id->id);
//             $CustRefField = "DB-".strtoupper($usr).Carbon::now()->format('y').Carbon::now()->format('m').$recordId;
//             $body = 
//                 [
//                     "RequestHeader"=> [
//                         "CustomerId"=>"7656",
//                         "UserId"=>"STS_LOANTA",
//                         "Password"=>"W3#QeicsB",
//                         "MemberNumber"=>"027FP27964",
//                         "SecurityCode"=>"6IT",
//                         "ProductCode"=> [
//                             "PCRLT"
//                         ],
//                         "CustRefField" => $CustRefField
//                     ],
//                     "RequestBody"=>[
//                         "InquiryPurpose"=>"16",
//                         "FirstName"=>$request->fname,
//                         "MiddleName"=>"",
//                         "LastName"=>$request->lname,
//                         "DOB"=>$request->dob,
//                         "InquiryPhones"=>[
//                             [
//                                 "seq"=>"1",
//                                 "Number"=>$request->phone_number,
//                                 "PhoneType"=>[
//                                     "M"
//                                 ]
//                             ]
//                         ],
//                         "IDDetails"=>[
//                             [
//                                 "seq"=>"1",
//                                 "IDType"=>"t",
//                                 "IDValue"=>$request->pan_num,
//                                 "Source"=> "Inquiry"
//                             ]
//                         ]
//                     ],
//                     "Score"=>[
//                         [
//                             "Type"=>"ERS",
//                             "Version"=>"3.1"
//                         ]
//                     ]
//                 ];    
//             $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
//             if($updateHitCount || $user->role_id==0){
//                 if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
//                 try
//                 {      
//                     $client = new Client();
//                     $res = $client -> post($this -> equifax_url,['json' => $body]);
//                     $response = json_decode($res -> getBody(),true);
//                     if($user->role_id==1) {
//                         if($apiamster) {
//                             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
//                         }
//                     }

    //                 }
//                 catch(BadResponseException $e){
//                     $statusCode = $e->getResponse()->getStatusCode();
//                     $response = $e->getResponse();
//                     $errorResponse = json_decode($response->getBody(), true);
//                     // return   $errorResponse;   
//                     if($statusCode == 500){
//                         $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
//                         if($user->role_id==1) {
//                             $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
//                         }
//                     }else if($statusCode == 422){
//                         $statusCode = 102;
//                         $errorMessage = 'Verification Failed. Please enter valid details.';
//                         if($user->role_id==1) {
//                             if($apiamster) {
//                                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
//                             }
//                         }
//                     }else{
//                         $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
//                         if($user->role_id==1) {
//                             if($apiamster) {
//                                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
//                             }
//                         }
//                     }
//                     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
//                 }
//             }
//             else{
//                 return response()->json(['statusCode'=>500 ,'message'=>'Please Recharge your wallet.']);
//             }
//             }else{
//                 return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
//             } 
//             $equifaxstatus = $response['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'];
//             // return $equifax;
//             if($equifaxstatus > 0){
//                 return response() -> json(['Equifax_Report' => $response,'statusCode' => '200']);
//             }
//             else{
//                 // return response()->json(['statusCode'=>102, 'message'=>'Please enter valid details']);
//                 return response()->json(['statusCode'=>102, 'message'=>$response]);
//             }

    //         // return $user;


    // }
    public function equifaxurl(Request $request)
    {
        // return "test";
        $validator = Validator::make($request->all(), [
            'phone_number' => 'required|regex:/^[0-9]{10}$/',
            'pan_num' => 'required',
        ]);
        if ($validator->fails()) {
            return response()->json([
                'status' => 'Forbidden',
                'errors' => $validator->errors(),
            ], 403);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);
        }

        $sql = DB::table('equifax_pdf_request')->insert([
            'firstName' => $request->fname,
            'lastName' => $request->lname,
            'contactNo' => $request->phone_number,
            'idValue' => $request->pan_num,
            'created_at' => date('Y-m-d H:i:s')
        ]);
        $api_id = null;
        // $validator = Validator::make($request -> all(),[
        //     // 'FirstName' => ['required','string','max:255'],
        //     // 'LastName' => ['required','string','max:255'],
        //     'ContactNo' => ['required','string','max:255'],
        //     'IDValue' => ['required'],
        // ]);
        $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
        $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
        $pan_num = $request->pan_num ? $request->pan_num : null;
        $voter_id = $request->voter_num ? $request->voter_num : null;
        $passport = $request->passport_num ? $request->passport_num : null;
        $driving_licence = $request->driving_num ? $request->driving_num : null;

        // if($validator -> fails())
        //     return response() -> json(['Errors' => $validator -> errors(),
        //                                 'statusCode' => '404']);
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // return 'true';
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'equifax')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $uname = $user->name;
        // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
        $arr = explode(' ', trim($uname));
        $usr = '';
        $substr = '';
        foreach ($arr as $array) {
            $substr = substr($array, 0, 1);
            $usr = $usr . $substr;
        }
        $recordId = sprintf("%04d", $record_id->id);
        $CustRefField = "DB-" . strtoupper($usr) . Carbon::now()->format('y') . Carbon::now()->format('m') . $recordId;
        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0bGFuZCIsImlhdCI6MTY5MTM4NDEzODczNH0.nHmNhb-NlFPziNE_-9iEGKTIVoiz5rM_lNVvPLvQLgU',
        ];
        $body =
            [
                "InquiryPurpose" => "10",
                "TransactionAmount" => "",
                "FirstName" => $request->fname,
                "MiddleName" => "",
                "LastName" => $request->lname,
                "InquiryAddresses" => [
                    [
                        "seq" => "1",
                        "AddressType" => [
                            "H"
                        ],
                        "AddressLine1" => "",
                        "AddressLine2" => "",
                        "Locality" => "",
                        "City" => "",
                        "State" => "",
                        "Postal" => ""
                    ]
                ],
                "InquiryPhones"=>[
                    [
                        "seq"=>"16",
                        "Number"=>$request->phone_number,
                        "PhoneType"=>[
                            "M"
                        ]
                    ]
                ],
                "IDDetails" => [
                    [
                        "seq" => "1",
                        "IDType" => "T",
                        "IDValue" => $request->pan_num
                    ]
                ],
                "DOB" => $request->dob
            ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return 'ok';
                try {
                    $client = new Client();
                    $res = $client->post("https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score", ['headers' => $headers, 'json' => $body]);
                    $response = json_decode($res->getBody(), true);
                    // return $response;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    // return $statusCode;
                    if ($statusCode == 500) {
                        // $statusCode = 201;
                        $statusCode = 500;
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        // $errorMessage = 'Consumer Details Not Found';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 50000000, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        if (isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) && $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] > 00) {
            $equifaxResponse = null;
            if (isset($response['data']['InquiryResponseHeader']) && isset($response['data']['CCRResponse'])) {
                $equifaxResponse['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
                $equifaxResponse['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                $equifaxResponse['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
                $equifaxResponse['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
                $equifaxResponse['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
                $equifaxResponse['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
                $equifaxResponse['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
                $equifaxResponse['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
                $equifaxResponse['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
                $equifaxResponse['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
                $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                $equifaxResponse['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                $equifaxResponse['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
                $equifaxResponse['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['Score'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Score']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Score'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] = 
    (isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo']) 
    && !empty($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo']))
    ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] 
    : null;

                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] : null;
                $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] : null;
            }
            return response()->json(['Equifax_Report' => $equifaxResponse, 'statusCode' => '200']);
        } else {
            $equifaxResponseConsumer = null;
            $equifaxResponseConsumer['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
            $equifaxResponseConsumer['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
            $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
            $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
            $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
            $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
            $equifaxResponseConsumer['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
            $equifaxResponseConsumer['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
            $equifaxResponseConsumer['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
            $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['Error'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Error']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Error'] : null;
            return response()->json(['statusCode' => 102, 'message' => $equifaxResponseConsumer]);
        }

        // return $user;


    }

    // public function equifaxurlnewtest(Request $request){
//     // return 'return new test';
//     $validator = Validator::make($request->all(), [ 
//         'phone_number' => 'required|regex:/^[0-9]{10}$/',
//         'fname' => ['required', 'string', 'max:255'],
//         'lname' => ['required', 'string', 'max:255'],
//         'pan_num' => 'required|string'
//     ]);

    //     if ($validator->fails()) {
//         return response()->json([
//             'status' => 'Forbidden',
//             'errors' => $validator->errors(),
//         ], 403);
//     }

    //     $cheack_status = DB::table('send_otp')->where('mobile', $request->phone_number)->where('otp',$request->otp)->get();
//     // return count($cheack_status);
//     if(count($cheack_status) > 0){
//         $phone = $request->phone_number;
//         $sql = DB::table('equifax_pdf_request')->insert([
//             'firstName' => $request->fname,
//             'lastName' => $request->lname,
//             'contactNo'=> $phone,
//             'idValue'=> $request->pan_num,
//             'created_at'=>date('Y-m-d H:i:s')
//         ]);
//         $api_id = null;
//         // $validator = Validator::make($request -> all(),[
//         //     // 'FirstName' => ['required','string','max:255'],
//         //     // 'LastName' => ['required','string','max:255'],
//         //     'ContactNo' => ['required','string','max:255'],
//         //     'IDValue' => ['required'],
//         // ]);
//         $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
//         $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
//         $pan_num = $request->pan_num ? $request->pan_num : null;
//         $voter_id = $request->voter_num ? $request->voter_num : null;
//         $passport = $request->passport_num ? $request->passport_num : null;
//         $driving_licence = $request->driving_num ? $request->driving_num : null;

    //         // if($validator -> fails())
//         //     return response() -> json(['Errors' => $validator -> errors(),
//         //                                 'statusCode' => '404']);
//         $user = User::where('access_token',$request->header('AccessToken'))->first();

    //                if($user->role_id==1) {
//                     $apiamster = ApiMaster::where('api_slug','equifaxnootp')->first();
//                 if($apiamster)
//                     $api_id = $apiamster->id;
//                 }
//                 $uname = $user->name;
//                 // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
//                 $arr = explode(' ', trim($uname));
//                 $usr = '';
//                 $substr = '';
//                 foreach($arr as $array){
//                     $substr = substr($array, 0, 1);
//                     $usr = $usr.$substr;
//                 }
//                 $recordId = sprintf("%04d", $record_id->id);
//                 $CustRefField = "DB-".strtoupper($usr).Carbon::now()->format('y').Carbon::now()->format('m').$recordId;
//                 $contactno = 8888888888;
//                 $body = 
//                     [
//                         "RequestHeader"=> [
//                             "CustomerId"=>"7656",
//                             "UserId"=>"STS_LOANTA",
//                             "Password"=>"W3#QeicsB",
//                             "MemberNumber"=>"027FP27964",
//                             "SecurityCode"=>"6IT",
//                             "ProductCode"=> [
//                                 "PCRLT"
//                             ],
//                             "CustRefField" => $CustRefField
//                         ],
//                         "RequestBody"=>[
//                             "InquiryPurpose"=>"16",
//                             "FirstName"=>$request->fname,
//                             "MiddleName"=>"",
//                             "LastName"=>$request->lname,
//                             "DOB"=>$request->dob,
//                             "InquiryPhones"=>[
//                                 [
//                                     "seq"=>"1",
//                                     "Number"=>$contactno,
//                                     "PhoneType"=>[
//                                         "M"
//                                     ]
//                                 ]
//                             ],
//                             "IDDetails"=>[
//                                 [
//                                     "seq"=>"1",
//                                     "IDType"=>"t",
//                                     "IDValue"=>$request->pan_num,
//                                     "Source"=> "Inquiry"
//                                 ]
//                             ]
//                         ],
//                         "Score"=>[
//                             [
//                                 "Type"=>"ERS",
//                                 "Version"=>"3.1"
//                             ]
//                         ]
//                     ];    
//                 $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
//                 if($updateHitCount || $user->role_id==0){
//                     if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type=="role_postpaid") {
//                     try
//                     {      
//                         $client = new Client();
//                         $res = $client -> post($this -> equifax_url,['json' => $body]);
//                         $response = json_decode($res -> getBody(),true);
//                         if($user->role_id==1) {
//                             if($apiamster) {
//                                 $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
//                             }
//                         }

    //                     }
//                     catch(BadResponseException $e){
//                         $statusCode = $e->getResponse()->getStatusCode();
//                         if($statusCode == 500){
//                             $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
//                             if($user->role_id==1) {
//                                 $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
//                             }
//                         }else if($statusCode == 422){
//                             $statusCode = 102;
//                             $errorMessage = 'Verification Failed. Please enter valid details.';
//                             if($user->role_id==1) {
//                                 if($apiamster) {
//                                     $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
//                                 }
//                             }
//                         }else{
//                             $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
//                             if($user->role_id==1) {
//                                 if($apiamster) {
//                                     $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
//                                 }
//                             }
//                         }
//                         return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
//                     }
//                 }
//                 else{
//                     return response()->json(["statusCode"=>500,'message'=>"Please recharge your wallet."]);
//                 }
//                 }else{
//                     return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
//                 } 
//                 $equifaxstatus = $response['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'];
//                 // return $equifax;
//                 if($equifaxstatus > 0){
//                     return response() -> json(['Equifax_Report' => $response,'statusCode' => '200']);
//                 }
//                 else{
//                     // return response()->json(['statusCode'=>102, 'message'=>'Please enter valid details']);
//                     return response()->json(['statusCode'=>102, 'message'=>$response]);
//                 }
//               }
//         else{

    //             return response()->json(['statusCode'=>404, 'message'=>'Please Enter Valid Otp']);
//         }
// }

    public function equifaxurlnewtest(Request $request)
    {
        // return 'return new test';
        $validator = Validator::make($request->all(), [
            'phone_number' => 'required|regex:/^[0-9]{10}$/',
            'fname' => ['required', 'string', 'max:255'],
            'lname' => ['required', 'string', 'max:255'],
            'pan_num' => 'required|string'
        ]);

        if ($validator->fails()) {
            return response()->json([
                'status' => 'Forbidden',
                'errors' => $validator->errors(),
            ], 403);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);
        }
        $cheack_status = DB::table('send_otp')->where('mobile', $request->phone_number)->where('otp', $request->otp)->get();
        // return count($cheack_status);
        if (count($cheack_status) > 0) {
            $phone = $request->phone_number;
            $sql = DB::table('equifax_pdf_request')->insert([
                'firstName' => $request->fname,
                'lastName' => $request->lname,
                'contactNo' => $phone,
                'idValue' => $request->pan_num,
                'created_at' => date('Y-m-d H:i:s')
            ]);
            $api_id = null;
            // $validator = Validator::make($request -> all(),[
            //     // 'FirstName' => ['required','string','max:255'],
            //     // 'LastName' => ['required','string','max:255'],
            //     'ContactNo' => ['required','string','max:255'],
            //     'IDValue' => ['required'],
            // ]);
            $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
            $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
            $pan_num = $request->pan_num ? $request->pan_num : null;
            $voter_id = $request->voter_num ? $request->voter_num : null;
            $passport = $request->passport_num ? $request->passport_num : null;
            $driving_licence = $request->driving_num ? $request->driving_num : null;

            // if($validator -> fails())
            //     return response() -> json(['Errors' => $validator -> errors(),
            //                                 'statusCode' => '404']);
            $user = User::where('access_token', $request->header('AccessToken'))->first();

            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'equifaxnootp')->first();
                if ($apiamster)
                    $api_id = $apiamster->id;
            }
            $uname = $user->name;
            // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
            $arr = explode(' ', trim($uname));
            $usr = '';
            $substr = '';
            foreach ($arr as $array) {
                $substr = substr($array, 0, 1);
                $usr = $usr . $substr;
            }
            $recordId = sprintf("%04d", $record_id->id);
            $CustRefField = "DB-" . strtoupper($usr) . Carbon::now()->format('y') . Carbon::now()->format('m') . $recordId;
            $contactno = 8888888888;
            $body =
                [
                    "InquiryPurpose" => "10",
                    "TransactionAmount" => "",
                    "FirstName" => $request->fname,
                    "MiddleName" => "",
                    "LastName" => $request->lname,
                    "InquiryAddresses" => [
                        [
                            "seq" => "1",
                            "AddressType" => [
                                "H"
                            ],
                            "AddressLine1" => "",
                            "AddressLine2" => "",
                            "Locality" => "",
                            "City" => "",
                            "State" => "",
                            "Postal" => ""
                        ]
                    ],
                    "InquiryPhones"=>[
                    [
                        "seq"=>"16",
                        "Number"=>$request->phone_number,
                        "PhoneType"=>[
                            "M"
                        ]
                    ]
                ],
                    "IDDetails" => [
                        [
                            "seq" => "1",
                            "IDType" => "T",
                            "IDValue" => $request->pan_num
                        ]
                    ],
                    "DOB" => $request->dob
                ];
            $headers = [
                'Content-Type' => 'application/json',
                'Authorization' => 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0bGFuZCIsImlhdCI6MTY5MTM4NDEzODczNH0.nHmNhb-NlFPziNE_-9iEGKTIVoiz5rM_lNVvPLvQLgU',
            ];
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    try {
                        $client = new Client();
                        $res = $client->post("https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score", ['headers' => $headers, 'json' => $body]);
                        $response = json_decode($res->getBody(), true);
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }

                    } catch (BadResponseException $e) {
                        $statusCode = $e->getResponse()->getStatusCode();
                        if ($statusCode == 500) {
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 422) {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter valid details.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(["statusCode" => 500, 'message' => "Please recharge your wallet."]);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }


            if (isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) && $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] > 00) {
                $equifaxResponse = null;
                if (isset($response['data']['InquiryResponseHeader']) && isset($response['data']['CCRResponse'])) {
                    $equifaxResponse['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
                    $equifaxResponse['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                    $equifaxResponse['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
                    $equifaxResponse['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
                    $equifaxResponse['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
                    $equifaxResponse['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
                    $equifaxResponse['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
                    $equifaxResponse['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
                    $equifaxResponse['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
                    $equifaxResponse['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
                    $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                    $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                    $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                    $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                    $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                    $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                    $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                    $equifaxResponse['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                    $equifaxResponse['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
                    $equifaxResponse['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['Score'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Score']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Score'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] : null;
                    $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] : null;
                }
                return response()->json(['Equifax_Report' => $equifaxResponse, 'statusCode' => '200']);
            } else {
                $equifaxResponseConsumer = null;
                if (isset($response['data']['InquiryResponseHeader'])) {

                    $equifaxResponseConsumer['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
                    $equifaxResponseConsumer['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                    $equifaxResponseConsumer['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
                    $equifaxResponseConsumer['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
                    $equifaxResponseConsumer['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
                    $equifaxResponseConsumer['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
                    $equifaxResponseConsumer['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
                    $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
                    $equifaxResponseConsumer['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
                    $equifaxResponseConsumer['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
                    $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                    $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                    $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                    $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                    $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                    $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                    $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                    $equifaxResponseConsumer['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                    $equifaxResponseConsumer['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
                    $equifaxResponseConsumer['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
                    $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['Error'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Error']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Error'] : null;
                    return response()->json(['statusCode' => 102, 'message' => $equifaxResponseConsumer]);
                }
            }
        } else {
            return response()->json(['statusCode' => 404, 'message' => 'Please Enter Valid Otp']);
        }
    }


    public function equifaxsendOTP(Request $request)
    {
        // dd('asasa');
        $validator = Validator::make($request->all(), [
            'phone_number' => 'required|regex:/^[0-9]{10}$/'
        ]);

        if ($validator->fails()) {
            return response()->json([
                'status' => 'Forbidden',
                'errors' => $validator->errors(),
            ], 403);
        }

        $otp = rand(1111, 9999);
        Session::put('otp_code', $otp);
        // $authKey = "285719AiPxI75X5da6af0c";
        $authKey = "368753AXggrthFX61713441P1";
        //Sender ID,While using route4 sender id should be 6 characters long.
        $senderId = "DocBoy";


        $message = urlencode(
            "Dear%20Customer,2323%20OTP%20for%20Login%20Thank%20You%20Team%20DocBoyz"
        );
        //Define route 
        $number = $request->phone_number;
        $route = "4";
        //Prepare you post parameters
        $prt = '91';
        $newno = $prt . $number;
        $postData = array(
            'authkey' => $authKey,
            'mobiles' => $newno,
            'message' => $message,
            'sender' => $senderId,
            'otp' => $otp,
            'route' => $route
        );
        // $postData = array(
        //     'authkey' => $authKey,
        //     'mobiles' => $request->phone,
        //     'message' => $message,
        //     'sender' => $senderId,
        //     'route' => $route
        // );
        //API URL
        $url = "https://api.msg91.com/api/sendotp.php?authkey=368753AXggrthFX61713441P1&mobiles=$newno&message=Dear%20Customer,$otp%20OTP%20for%20Login%20Thank%20You%20Team%20DocBoyz&sender=DocBoy&otp=$otp&DLT_TE_ID=1307163462070500440";
        // $url="http://www.sms.rocketm.in/api/sendhttp.php";
        // init the resource
        // $ch = curl_init();
        // curl_setopt_array($ch, array(
        //     CURLOPT_URL => $url,
        //     CURLOPT_RETURNTRANSFER => true,
        //     CURLOPT_POST => true,
        //     CURLOPT_POSTFIELDS => $postData,
        //     CURLOPT_FOLLOWLOCATION => true
        // ));
        // //Ignore SSL certificate verification
        // curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        // curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
        // //get response
        // $response = curl_exec($ch);
        // $err = curl_error($ch);
        // curl_close($ch);
        // if ($err) {
        //     return response()->json(['error'=>'Something went wrong. Please try again.']);
        // } else {
        //     return response()->json(['success'=>'OTP sent successfully']);
        // }
        $curl = curl_init();
        curl_setopt_array($curl, array(
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 30,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "GET",
            CURLOPT_POSTFIELDS => $postData,
            CURLOPT_HTTPHEADER => array(
                "content-type: application/JSON"
            ),
        ));

        //Ignore SSL certificate verification
        // curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, 0);
        // curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, 0);
        //get response
        $response = curl_exec($curl);
        $err = curl_error($curl);
        curl_close($curl);
        if ($err) {
            return response()->json(['error' => 'Something went wrong. Please try again.']);
        } else {
            $cheack_status = DB::table('send_otp')->where('mobile', $request->phone_number)->get();
            // return $request->phone_number;
            if (count($cheack_status) > 0) {
                // return 'ok';
                $updated_code = DB::table('send_otp')->where("mobile", $request->phone_number)->update(["otp" => $otp, "created_at" => Carbon::now(), "updated_at" => Carbon::now()]);
            } else {
                // return 'not';
                $updated_code = DB::table('send_otp')->insert(["mobile" => $request->phone_number, "otp" => $otp, "created_at" => Carbon::now(), "updated_at" => Carbon::now()]);
            }


            return response()->json(['success' => 'OTP sent successfully']);
        }
    }


    // Verify OTP
    public function equifaxverifyotp(Request $request)
    {
        if (Session::has('otp_code')) {
            $otp_code = Session::get('otp_code');
            if ($request->otp_code == $otp_code) {
                return response()->json(['success' => 'OTP verified successfully']);
            } else {
                return response()->json(['fail' => 'OTP is not match']);
            }
        } else {
            return response()->json(['error' => 'Something went wrong. Please try again.']);
        }
    }

    // public function equifaxurl(Request $request){
//     $api_id = null;
//     // $validator = Validator::make($request -> all(),[
//     //     // 'FirstName' => ['required','string','max:255'],
//     //     // 'LastName' => ['required','string','max:255'],
//     //     'ContactNo' => ['required','string','max:255'],
//     //     'IDValue' => ['required'],
//     // ]);

    //     if(!$request->headers->has('AccessToken'))
//             return response() -> json(['message'=>'Access Token is required', 'statusCode' => '404']);

    //     $verifyAccessToken = $this -> verifyAccessToken($request->header('AccessToken'));
//     if($verifyAccessToken == false)
//         return response() -> json(['message' => 'Wrong Access Token','statusCode'=>'404']);

    //     $user = User::where('access_token',$request->header('AccessToken'))->first();

    //     $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
//         // dd('testing now');
//     $statusCode = null;
//     // $equifax = null;
//     // $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
//     $pan_num = $request->pan_num ? $request->pan_num : null;
//     $voter_id = $request->voter_num ? $request->voter_num : null;

    //     // if($validator -> fails())
//     //     return response() -> json(['Errors' => $validator -> errors(),
//     //                                 'statusCode' => '404']);
//     $user = User::where('access_token',$request->header('AccessToken'))->first();
//     if($user->role_id==1) {
//         $apiamster = ApiMaster::where('api_slug','equifax')->first();
//     if($apiamster)
//         $api_id = $apiamster->id;
//     }

    //     $recordId = sprintf("%04d", $record_id->id);
//     $CustRefField = "DB-".strtoupper($user).Carbon::now()->format('y').Carbon::now()->format('m').$recordId;

    //     $body = [ 
//         "InquiryPurpose"=> "10",
//         "TransactionAmount"=> "100",
//         "FirstName"=> $request->fname,
//         "MiddleName"=> "",
//         "LastName"=> $request->lname,
//         // "CustRefField" => $CustRefField,
//         "InquiryAddresses"=> [
//             [
//                 "seq"=> "1",
//                 "AddressType"=> [
//                     "H"
//                 ],
//                 "AddressLine1"=> "",
//                 "AddressLine2"=> "",
//                 "Locality"=> "",
//                 "City"=> "",
//                 "State"=> "MH",
//                 "Postal"=> ""
//             ]
//         ],
//         "IDDetails"=> [
//             [
//                 "seq"=> "1",
//                 "IDType"=> "T",
//                 "IDValue"=>  $pan_num
//             ],
//             [
//                 "seq"=> "2",
//                 "IDType"=> "V",
//                 "IDValue"=> $voter_id
//             ]
//         ],
//         "DOB"=> $request->dob,
//         "CustomFields"=> [
//             [
//                 "key"=> "PCRLT_Custom_Logic",
//                 "value"=> "Y"
//             ]
//         ]
//     ]; 
//     $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
//     if($updateHitCount || $user->role_id==0){
//         try
//         {      
//             $client = new Client();
//             $res = $client -> post($this -> equifax_url,[
//                 'headers' => ['Authorization' => $this -> equifax_token],
//                 'json' => $body,
//             ]);
//             $response = json_decode($res -> getBody());
//             if($user->role_id==1) {
//                 if($apiamster) {
//                     $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
//                 }
//             }

    //         }
//         catch(BadResponseException $e){
//             $statusCode = $e->getResponse()->getStatusCode();
//             if($statusCode == 500){
//                 $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
//                 if($user->role_id==1) {
//                     $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
//                 }
//             }else if($statusCode == 422){
//                 $statusCode = 102;
//                 $errorMessage = 'Verification Failed. Please enter valid details.';
//                 if($user->role_id==1) {
//                     if($apiamster) {
//                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
//                     }
//                 }
//             }else{
//                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
//                 if($user->role_id==1) {
//                     if($apiamster) {
//                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
//                     }
//                 }
//             }
//             return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
//         }
//     }else{
//         return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
//     } 
//     return response() -> json(['Equifax_Report' => $response,'statusCode' => '200']);

    // }

    public function consumer_product(Request $request)
    {
        // $businesstype = businesstype::all();
        //     $businesskyc = businesskyc::all();
        //     $documentname = documentname::all();
        if (
            $request->fullname == null && $request->firstname == null && $request->lastname == null
            && $request->dob == null && $request->mobileno == null && $request->emailaddress == null &&
            $request->address == null && $request->city == null && $request->state == null &&
            $request->addressline3 == null && $request->addressline2 == null &&
            $request->addressline1 == null && $request->rdogender == null &&
            $request->uploadimage == null && $request->uploadaudiovideo == null
        ) {
            $message = "Please filled customer details";
            return response()->json(['message' => $message]);
        }
        $consumerid = " ";
        if (is_uploaded_file($request->uploadimage)) {
            $validator = Validator::make($request->all(), [
                'uploadimage' => 'image|mimes:jpg,png,jpeg,gif,svg',
                'uploadaudiovideo' => 'mimes:mp4,mov,ogg,mp3|max:20000'
            ]);
            if ($validator->fails()) {
                $message = "Please upload the image properly only";
                return response()->json(['message' => $message]);

            }
        }
        // dd($request->all());
        if (
            $request->fullname != null || $request->firstname != null || $request->lastname != null
            || $request->dob != null || $request->mobileno != null || $request->emailaddress != null ||
            $request->address != null || $request->city != null || $request->state == null ||
            $request->addressline3 != null || $request->addressline2 != null ||
            $request->addressline1 != null || $request->rdogender != null ||
            $request->uploadimage != null && $request->uploadaudiovideo != null
        ) {
            $consumer = new consumer();
            if ($request->fullname == null)
                $consumer->firstname = "";
            else
                if (isset($request->firstname)) {
                    $consumer->firstname = $request->firstname;
                }
            if (!isset($request->firstname)) {
                $consumer->firstname = "";
            }
            $consumer->lastname = $request->lastname;
            $consumer->fullname = $request->fullname;
            $consumer->emailaddress = $request->emailaddress;
            $consumer->dob = $request->dob;
            $consumer->mobileno = $request->mobileno;
            $consumer->address = $request->address;
            $consumer->consumerheading = $request->consumerhd;
            $consumer->city = $request->city;
            $consumer->state = $request->state;
            $consumer->addressline3 = $request->addressline3;
            $consumer->addressline2 = $request->addressline2;
            $consumer->addressline1 = $request->addressline1;
            $consumer->gender = $request->rdogender;
            if (is_uploaded_file($request->uploadimage)) {
                $file = $request->file('uploadimage');
                $file_name = "consumer" . time() . '_consumer' . "." . $file->getClientOriginalExtension();
                $file->move(public_path('document/consumer/image'), $file_name);
                $consumer->consumerimage = $file_name;
            } else {
                $consumer->consumerimage = $request->uploadimage;
            }
            if ($request->uploadaudiovideo != null) {
                $file = $request->file('uploadaudiovideo');
                $file_name = "consumeraudio" . time() . '_consumer' . "." . $file->getClientOriginalExtension();
                $file->move(public_path('document/consumer/audiovideo'), $file_name);
                $consumer->audiovideo = $file_name;
            } else {
                $consumer->audiovideo = $request->uploadaudiovideo;
            }
            $consumer->save();
            $consumerid = $consumer->id;
            // $request->session()->put('consumerid',$consumerid);
            // echo $consumer->id;
            // exit(1);
            if (
                $request->businesstypeid != null || $request->businesskycid != 0
                || $request->businessname != null || $request->businessaddress != null
                || $request->uploadeddocument != null
            ) {
                $business = new business();
                $userArray = array();
                $businesstype = array();
                if ($request->businesstypeid != null) {
                    $userArray = explode(',', $request->businesstypeid);
                    // print_r($userArray);
                }
                if (!empty($userArray)) {
                    for ($i = 0; $i < sizeof($userArray); $i++) {
                        $businesstype[] = $userArray[$i];
                    }
                    $business->businesstypeid = json_encode($businesstype);
                } else {
                    $business->businesstypeid = json_encode($businesstype);
                }
                $business->businesskycid = $request->businesskycid;
                $business->businessname = $request->businessname;
                $business->businessaddress = $request->businessaddress;
                //  $business->businesstypeid = $request->businesstypeid;
                $business->customerid = $consumerid;
                $business->businessheading = $request->businesshd;
                if (is_uploaded_file($request->uploadeddocument)) {
                    $file = $request->file('uploadeddocument');
                    $file_name = $business->businessname . time() . '_business' . "." . $file->getClientOriginalExtension();
                    $file->move(public_path('document/business'), $file_name);
                    $business->uploaddocument = $file_name;
                } else {
                    $business->uploaddocument = $request->uploadeddocument;
                }

                $business->save();
                //  echo $business->id;
                //  exit(1);

            } /* end of business if */
            if (
                $request->uploadfile != null || $request->uploadeddocumentname != 0
                || $request->pannumber != null || $request->aadhaarnumber != null
            ) {
                $requireddetails = new requireddetails();
                $requireddetails->documentdetailsid = $request->uploadeddocumentname;
                $requireddetails->pannumber = $request->pannumber;
                $requireddetails->aadhaarnumber = $request->aadhaarnumber;
                $requireddetails->requireddetailsheading = $request->requireddetailshd;
                $requireddetails->customerid = $consumerid;
                if (is_uploaded_file($request->uploadfile)) {
                    $file = $request->file('uploadfile');
                    $file_name = $requireddetails->uploadeddocumentname . time() . '_requireddetails' . "." . $file->getClientOriginalExtension();
                    $file->move(public_path('document/requireddetails'), $file_name);
                    $requireddetails->uploadfile = $file_name;
                } else {
                    $requireddetails->uploadfile = $request->uploadfile;
                }
                $requireddetails->save();
                // echo $requireddetails->id;
                // exit(1);

            } /*end of if of other details */
            if (
                $request->termscondition != null || $request->selectapi != "0" ||
                $request->crifapiscore != null || $request->loansactioned != null
            ) {
                $termscondition = new termscondition();
                $termscondition->customerid = $consumerid;
                $termscondition->termscondition = $request->termscondition;
                $termscondition->crifapiscore = $request->crifapiscore;
                $termscondition->loansactioned = $request->loansactioned;
                $termscondition->termsconditionheading = $request->termsconditionhd;
                $termscondition->apiname = $request->selectapi;
                $termscondition->save();

            } /* end of terms and condition */
            if ($request->congmsg != null || $request->uploadcongfile != null) {
                $congratulations = new congratulations();
                $congratulations->customerid = $consumerid;
                $congratulations->message = $request->congmsg;
                if (is_uploaded_file($request->uploadcongfile)) {
                    $file = $request->file('uploadcongfile');
                    $file_name = "congratulations" . time() . '_congratulations' . "." . $file->getClientOriginalExtension();
                    $file->move(public_path('document/congratulations'), $file_name);
                    $congratulations->uploadcongfile = $file_name;
                } else {
                    $congratulations->uploadcongfile = $request->uploadcongfile;
                }
                $congratulations->congratulationsheading = $request->congratulationshd;
                $congratulations->save();

            } /* end of congratulations */
            if ($request->agreementupload != null || $request->agreemnet != null) {
                $agreementpolicy = new agreementpolicy();
                $agreementpolicy->customerid = $consumerid;
                $agreementpolicy->agreement = $request->agreemnet;
                if (is_uploaded_file($request->agreementupload)) {
                    $file = $request->file('agreementupload');
                    $file_name = "agreement" . time() . '_agreement' . "." . $file->getClientOriginalExtension();
                    $file->move(public_path('document/agreement'), $file_name);
                    $agreementpolicy->agreementupload = $file_name;
                } else {
                    $agreementpolicy->agreementupload = $request->agreementupload;
                }
                $agreementpolicy->agreementheading = $request->agreementhd;
                $agreementpolicy->save();
            } /*  end of agreement if*/
            if (
                $request->bankname != null || $request->accountnumber != null ||
                $request->accounttype != "0" || $request->ifsccode != null
            ) {
                $bankdetails = new bankdetails();
                $bankdetails->customerid = $consumerid;
                $bankdetails->bankname = $request->bankname;
                $bankdetails->accountnumber = $request->accountnumber;
                // if($request->accounttype==0)
                // {
                //     $bankdetails->accounttype=null;
                // }
                // else
                // {
                $bankdetails->accounttype = $request->accounttype;
                // }
                $bankdetails->ifsccode = $request->ifsccode;
                $bankdetails->bankdetailsheading = $request->bankdetailshd;
                $bankdetails->save();

            } /* end of auto debit if */
            if ($request->linkname != null) {
                $link = new link();
                $link->customerid = $consumerid;
                $link->linkname = $request->linkname;
                $link->linkheading = $request->linkhd;
                $link->save();
            } /* end of link if */
            $message = "Details has been successfully added";
            $consumerid = $consumerid;
            return response()->json(['message' => $message, 'consumerid' => $consumerid]);
        } /*  end of main if */

    }
    public function esign(Request $request)
    {
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'docboyzesign')->first();
                if ($apiamster)
                    $api_id = $apiamster->id;
            }

            $client = new Client();
            $client = new \GuzzleHttp\Client(['verify' => false]);
            $headers = [
                'Authorization' => $this->sandbox_token,
                'Accept' => 'application/json',
            ];

            $body = [
                "pdf_pre_uploaded" => true,
                "config" => [
                    "auth_mode" => "1",
                    "reason" => "Contract",
                    "positions" => [
                        "1" => [
                            [
                                "x" => 10,
                                "y" => 20
                            ]
                        ],
                        "2" => [
                            [
                                "x" => 0,
                                "y" => 0
                            ]
                        ]
                    ]
                ],
                "prefill_options" => [
                    "full_name" => $request->full_name,
                    "mobile_number" => $request->mobile_number,
                    "user_email" => $request->user_email
                ]

            ];
            try {
                $res = $client->post($this->sandbox_url . '/esign/initialize', ['headers' => $headers, 'json' => $body]);
                //return response() -> json(['result' => $res,'statusCode' => '200']); 
                $esign = json_decode($res->getBody(), true);
                // return response()->json($esign);
                $client_id = $esign['data']['client_id'];
                $body = [
                    'client_id' => $client_id
                ];
                try {
                    $res1 = $client->post($this->sandbox_url . '/esign/get-upload-link', ['headers' => $headers, 'json' => $body]);
                    $esign1 = json_decode($res1->getBody(), true);
                    // return response() -> json(['result' => $esign1,'statusCode' => '200']); 
                    $curl1 = curl_init();
                    curl_setopt_array($curl1, array(
                        // CURLOPT_URL => "https://kyc-api.flowboard.in/api/v1/aadhaar/upload/eaadhaar",
                        CURLOPT_URL => "https://surepass-esign.s3.amazonaws.com/",
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => "",
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => "POST",
                        CURLOPT_POSTFIELDS => array(
                            "file" => new \CURLFILE($esign1['data']['fields']['key']),
                            "base64" => "",
                            "yob" => "",
                            "full_name" => "",
                            "key" => $esign1['data']['fields']['key'],
                            "x-amz-algorithm" => $esign1['data']['fields']['x-amz-algorithm'],
                            "x-amz-credential" => $esign1['data']['fields']['x-amz-credential'],
                            "x-amz-date" => $esign1['data']['fields']['x-amz-date'],
                            "policy" => $esign1['data']['fields']['policy'],
                            "x-amz-signature" => $esign1['data']['fields']['x-amz-signature'],

                        ),
                        CURLOPT_HTTPHEADER => array(
                            "Authorization: " . $this->sandbox_token,
                            'Accept' => 'application/json'
                        ),
                    ));
                    // $get_data1 = curl_exec($curl1);
                    $result = curl_exec($curl1);
                    // return response() -> json(['result' => curl_exec($curl1),'statusCode' => '200']); 
                    $aadhaarOCR = json_decode($result, true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //  return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }

            } catch (BadResponseException $e) {
                $statusCode = $e->getResponse()->getStatusCode();
                $response = $e->getResponse();
                $errorResponse = json_decode($response->getBody(), true);
                //  return  $errorResponse;
                if ($statusCode == 500) {
                    $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                    }
                } else if ($statusCode == 422) {
                    $statusCode = 102;
                    $errorMessage = 'Verification Failed. Please enter valid details.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                } else {
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                }
                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
            }
            return response()->json($aadhaarOCR);
        } else {
            return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
        }
}

      public function fssi_verification(Request $request)
    {
        $api_id = null;
        $service_provider = "digitap";
        //22819015001312
        $client_ref_num = $request->client_ref_num;
        $license_number = $request->license_number;
        $validator = Validator::make($request->all(), [
            'client_ref_num'=>['required','string'],
            'license_number' => ['required', 'string'],

        ]);
        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        if (!$request->headers->has('AccessToken'))

            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));

        if ($verifyAccessToken == false)
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'fssi')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }


        $client = new Client();
        $statusCode = null;
        $fssi_verification = null;
        $username = "39516626";
        $password = "7OJ4W511lv1W6J40UWeQAc5RPxMuq5bp";

        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => 'Basic ' . base64_encode($username . ':' . $password),
        ];

        $body = [
            'client_ref_num'=>$client_ref_num,
            'license_number' =>$license_number
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post('https://svcdemo.digitap.work/validation/kyb/v1/fssai_validation', ['headers' => $headers, 'json' => $body, 'auth' => [$username, $password],]);
                    $fssiverify = json_decode($response->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $fssaidetails = DB::table('fssai_details')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "client_id" => $fssiverify['request_id'],
                            "fssai_number" => $fssiverify['result']['license_number'],
                            "address" => $fssiverify['result']['address'],
                            // "fbo_id" => $fssiverify['data']['details'][0]['fbo_id'],
                            // "display_ref_id" => $fssiverify['data']['details'][0]['display_ref_id'],
                            "license_category_name" => $fssiverify['result']['license_type'],
                            // "state_name" => $fssiverify['data']['details'][0]['state_name'],
                            // "status_desc" => $fssiverify['data']['details'][0]['status_desc'],
                            // "license_category_id" => $fssiverify['data']['details'][0]['license_category_id'],
                            "company_name" => $fssiverify['result']['company_name'],
                            "license_active_flag" => $fssiverify['result']['validity_status'],
                            // "license_active_flag" => isset($fssiverify['data']['details'][0]['license_active_flag']) ? $fssiverify['data']['details'][0]['license_active_flag'] : null,
                            "ref_id" => $fssiverify['client_ref_num'],
                            // "app_type_desc" => $fssiverify['data']['details'][0]['app_type_desc'],
                            // "premise_pincode" => $fssiverify['data']['details'][0]['premise_pincode'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now(),
                            'service_provider' => $service_provider
                        ]);
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Verification Details' => $fssiverify, 'statusCode' => '200'));
    }

    
    public function fssi_verification22agust2025(Request $request)
    {
        $api_id = null;
        //22819015001312
        $data = $request->id_number;
        $validator = Validator::make($request->all(), [
            'id_number' => ['required', 'string']
        ]);
        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        if (!$request->headers->has('AccessToken'))

            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));

        if ($verifyAccessToken == false)
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'fssi')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $statusCode = null;
        $fssi_verification = null;

        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => $this->token
        ];
        $body = [
            'id_number' => $data
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post($this->base_url . '/corporate/fssai', ['headers' => $headers, 'json' => $body]);
                    $fssiverify = json_decode($response->getBody(), true);

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $fssaidetails = DB::table('fssai_details')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "client_id" => $fssiverify['data']['client_id'],
                            "fssai_number" => $fssiverify['data']['fssai_number'],
                            "address" => $fssiverify['data']['details'][0]['address'],
                            "fbo_id" => $fssiverify['data']['details'][0]['fbo_id'],
                            "display_ref_id" => $fssiverify['data']['details'][0]['display_ref_id'],
                            "license_category_name" => $fssiverify['data']['details'][0]['license_category_name'],
                            "state_name" => $fssiverify['data']['details'][0]['state_name'],
                            "status_desc" => $fssiverify['data']['details'][0]['status_desc'],
                            "license_category_id" => $fssiverify['data']['details'][0]['license_category_id'],
                            "company_name" => $fssiverify['data']['details'][0]['company_name'],
                            "license_active_flag" => $fssiverify['data']['details'][0]['license_active_flag'],
                            // "license_active_flag" => isset($fssiverify['data']['details'][0]['license_active_flag']) ? $fssiverify['data']['details'][0]['license_active_flag'] : null,
                            "ref_id" => $fssiverify['data']['details'][0]['ref_id'],
                            "app_type_desc" => $fssiverify['data']['details'][0]['app_type_desc'],
                            "premise_pincode" => $fssiverify['data']['details'][0]['premise_pincode'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Verification Details' => $fssiverify, 'statusCode' => '200'));
    }

    public function pf_generate_otp(Request $request)
    {
        $statusCode = null;
        $pf_generate_otp = null;
        $api_id = null;

        $client = new Client();
        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'id_number' => $request->id_number
        ];
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'epfootpgenerate')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            try {
                $res = $client->post($this->base_url . '/income/epfo/passbook/generate-otp', ['headers' => $headers, 'json' => $body]);
                $pf_generate_otp = json_decode($res->getBody(), true);
                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }
                }

            } catch (BadResponseException $e) {
                $statusCode = $e->getResponse()->getStatusCode();
                if ($statusCode == 500) {
                    $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                    }
                } else if ($statusCode == 422) {
                    $statusCode = 102;
                    $errorMessage = 'Verification Failed. Please enter valid details.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                } else {
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                }
                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(['data' => $pf_generate_otp]);
    }

    public function pf_submit_otp(Request $request)
    {
        $statusCode = null;
        $pf_submit_otp = null;
        $api_id = null;

        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'client_id' => $request->client_id,
            'otp' => $request->otp
        ];
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'epfootpsubmit')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            try {
                $res = $client->post('https://kyc-api.flowboard.in/api/v1/income/epfo/passbook/submit-otp', ['headers' => $headers, 'json' => $body]);
                $pf_submit_otp = json_decode($res->getBody(), true);
                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }
                }

            } catch (BadResponseException $e) {
                $statusCode = $e->getResponse()->getStatusCode();
                if ($statusCode == 500) {
                    $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                    }
                } else if ($statusCode == 422) {
                    $statusCode = 102;
                    $errorMessage = 'Verification Failed. Please enter valid details.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                } else {
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                    }
                }
                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(['data' => $pf_submit_otp]);
    }

    public function smartship_login(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'username' => 'required',
            'password' => 'required',
            'client_id' => 'required',
            'client_secret' => 'required',
            // 'grant_type' => 'required'
        ]);
        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        $client = new Client();
        $statusCode = null;
        $login = null;

        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => $this->token
        ];
        $body = [
            'username' => $request->username,
            'password' => $request->password,
            'client_id' => $request->client_id,
            'client_secret' => $request->client_secret,
            'grant_type' => 'password'
        ];
        try {
            $res = $client->post('http://oauth.smartship.in/loginToken.php', ['headers' => $headers, 'json' => $body]);
            $login = json_decode($res->getBody(), true);

        } catch (BadResponseException $e) {
            $statusCode = $e->getResponse()->getStatusCode();
            if ($statusCode == 500) {
                $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
            } else if ($statusCode == 422) {
                $errorMessage = 'Verification Failed. Please enter valid details.';
            } else {
                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
            }
            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
        }
        // return response() -> json(array('login Details' => $login,'statusCode' => '200'));
        return response()->json(['data' => $login]);
    }

    public function hub_register(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'hub_name' => 'required',
            'pincode' => 'required',
            'city' => 'required',
            'state' => 'required',
            'address1' => 'required',
            'address2' => 'required',
            'hub_phone' => 'required',
            'delivery_type_id' => 'required'

        ]);


        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        $client = new Client();
        $statusCode = null;
        $hub = null;

        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => $request->header('Authorization')
        ];
        $body = [
            'hub_details' => [
                'hub_name' => $request->hub_name,
                'pincode' => $request->pincode,
                'city' => $request->city,
                'state' => $request->state,
                'address1' => $request->address1,
                'address2' => $request->address2,
                'hub_phone' => $request->hub_phone,
                'delivery_type_id' => $request->delivery_type_id
            ]
        ];
        try {
            $res = $client->post($this->smartship_url . '/v2/app/Fulfillmentservice/hubRegistration', ['headers' => $headers, 'json' => $body]);
            $hub = json_decode($res->getBody(), true);

        } catch (BadResponseException $e) {
            $statusCode = $e->getResponse()->getStatusCode();
            if ($statusCode == 500) {
                $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
            } else if ($statusCode == 422) {
                $errorMessage = 'Verification Failed. Please enter valid details.';
            } else {
                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
            }
            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
        }

        return response()->json(['data' => $hub]);
    }

    public function order_register(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'client_order_reference_id' => 'required',
            'order_collectable_amount' => 'required',
            'total_order_value' => 'required',
            'payment_type' => 'required',
            'package_order_weight' => 'required',
            'package_order_length' => 'required',
            'package_order_height' => 'required',
            'package_order_width' => 'required',
            'shipper_hub_id' => 'required',
            'shipper_gst_no' => 'required',
            'order_invoice_date' => 'required',
            'order_invoice_number' => 'required',
            //'order_ewaybill_number' => 'required',
            //'order_ewaybill_expiry_date' => 'required',
            'product_name' => 'required',
            'product_category' => 'required',
            'product_hsn_code' => 'required',
            'product_quantity' => 'required',
            'product_invoice_value' => 'required',
            'product_taxable_value' => 'required',
            'product_sgst_amount' => 'required',
            'product_cgst_amount' => 'required',
            'product_gst_tax_rate' => 'required',
            'product_cgst_tax_rate' => 'required',
            'product_sgst_tax_rate' => 'required',
            'consignee_name' => 'required',
            'consignee_phone' => 'required',
            'consignee_email' => 'required',
            'consignee_complete_address' => 'required',
            'consignee_pincode' => 'required',
            'client_id' => 'required',
            'run_type' => 'required'
        ]);

        $client = new Client();
        $statusCode = null;
        $register = null;

        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => $request->header('Authorization')
        ];
        $body = [
            'orders' => [
                'client_order_reference_id' => $request->client_order_reference_id,
                'order_collectable_amount' => $request->order_collectable_amount,
                'total_order_value' => $request->total_order_value,
                'payment_type' => $request->payment_type,
                'package_order_weight' => $request->package_order_weight,
                'package_order_length' => $request->package_order_length,
                'package_order_height' => $request->package_order_height,
                'package_order_width' => $request->package_order_width,
                'shipper_hub_id' => $request->shipper_hub_id,
                'shipper_gst_no' => $request->shipper_gst_no,
                'order_invoice_date' => $request->order_invoice_date,
                'order_invoice_number' => $request->order_invoice_number,
                'order_ewaybill_number' => $request->order_ewaybill_number,
                'order_ewaybill_expiry_date' => $request->order_ewaybill_expiry_date,
                'product_details' => [
                    'product_name' => $request->product_name,
                    'product_category' => $request->product_category,
                    'product_hsn_code' => $request->product_hsn_code,
                    'product_quantity' => $request->product_quantity,
                    'product_invoice_value' => $request->product_invoice_value,
                    'product_taxable_value' => $request->product_taxable_value,
                    'product_sgst_amount' => $request->product_sgst_amount,
                    'product_cgst_amount' => $request->product_cgst_amount,
                    'product_gst_tax_rate' => $request->product_gst_tax_rate,
                    'product_cgst_tax_rate' => $request->product_cgst_tax_rate,
                    'product_sgst_tax_rate' => $request->product_sgst_tax_rate
                ],
                'consignee_details' => [
                    'consignee_name' => $request->consignee_name,
                    'consignee_phone' => $request->consignee_phone,
                    'consignee_email' => $request->consignee_email,
                    'consignee_complete_address' => $request->consignee_complete_address,
                    'consignee_pincode' => $request->consignee_pincode
                ]
            ],
            'request_info' => [
                'client_id' => $request->client_id,
                'run_type' => $request->run_type
            ]
        ];

        if (!$request->headers->has('Authorization'))
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);

        try {
            //return $body;
            $res = $client->post('http://api.smartship.in/v2/app/Fulfillmentservice/orderRegistration', ['headers' => $headers, 'json' => $body]);
            // return response() -> json(['data' =>$res]);
            $register = json_decode($res->getBody(), true);

        } catch (BadResponseException $e) {
            $statusCode = $e->getResponse()->getStatusCode();
            if ($statusCode == 500) {
                $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
            } else if ($statusCode == 422) {
                $statusCode = 102;
                $errorMessage = 'Verification Failed. Please enter valid details.';
            } else {
                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
            }
            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
        }

        return response()->json(['data' => $register]);
    }

    public function order_details(Request $request)
    {

        $validator = Validator::make($request->all(), [
            'status_code' => 'required',
            'check_type' => 'required',
            'request_order_id' => 'required',
            'client_order_reference_id' => 'required',
            'payment_type' => 'required',
            'from' => 'required',
            'to' => 'required',
            'from' => 'required',
            'to' => 'required',
            'fields' => 'required',
            'type' => 'required',
            'offset' => 'required',
            'limit' => 'required',
        ]);

        $client = new Client();
        $statusCode = null;
        $register = null;

        if ($validator->fails())
            return response()->json(['Errors' => $validator->errors(), 'statusCode' => '404']);

        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => $request->header('Authorization')
        ];
        $body = [
            'filters' => [
                'filter_type' => [
                    'and' => [
                        'status' => [
                            'status_code' => $request->status_code,
                            'check_type' => $request->check_type
                        ],
                        'request_order_id' => $request->request_order_id,
                        'client_order_reference_id' => $request->client_order_reference_id,
                        'payment_type' => $request->payment_type,
                        'created_date' => [
                            'from' => $request->from,
                            'to' => $request->to
                        ],
                        'updated_date' => [
                            'from' => $request->from,
                            'to' => $request->to
                        ],
                    ]
                ]
            ],
            'sort_by' => [
                'fields' => $request->fields,
                'type' => $request->type
            ],
            'product_details' => [
                'offset' => $request->offset,
                'limit' => $request->limit
            ],
        ];

        if (!$request->headers->has('Authorization'))
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);

        try {
            //return $body;
            $res = $client->post('http://api.smartship.in/v2/app/Fulfillmentservice/orderDetails', ['headers' => $headers, 'json' => $body]);
            // return response() -> json(['data' =>$res]);
            $register = json_decode($res->getBody(), true);

        } catch (BadResponseException $e) {
            $statusCode = $e->getResponse()->getStatusCode();
            if ($statusCode == 500) {
                $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
            } else if ($statusCode == 422) {
                $statusCode = 102;
                $errorMessage = 'Verification Failed. Please enter valid details.';
            } else {
                $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
            }
            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
        }

        return response()->json(['data' => $register]);
    }

    public function epfo_new(Request $request)
    {
        $statusCode = null;
        $api_id = null;

        if (empty($request->name))
            return response()->json(array(['message' => 'name is required', 'statusCode' => '404']));

        if (empty($request->company))
            return response()->json(array(['message' => 'comapany is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'epfowithoutotp')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $client = new \GuzzleHttp\Client(['verify' => false]);
        $headers = [
            'Authorization' => $this->sandbox_token,
            'Accept' => 'application/json'
        ];
        $json = [
            'name' => $request->name,
            'company' => $request->company
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // return $this -> sandbox_url;
                    $response = $client->post("https://sandbox.flowboard.in/api/v1/employment/epfo", ['headers' => $headers, 'json' => $json]);
                    // return $response;
                    $epfo_details = json_decode($response->getBody(), true);

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Telecom EPFO Without OTP Details' => $epfo_details, 'statusCode' => '200'));

    }

 public function uan_details(Request $request)
{
    $statusCode = null;
    $uan_details = null;
    $api_id = null;

    if (empty($request->mobile_number)) {
        return response()->json([
            'message' => 'mobile_number is required',
            'statusCode' => 404
        ]);
    }
    
    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'message' => 'Header Access Token is required',
            'statusCode' => 404
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'message' => 'Wrong Access Token',
            'statusCode' => 403
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'uandetails')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }
   
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

   
    if ($updateHitCount || $user->role_id == 0) {

       
        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            $client = new \GuzzleHttp\Client();

            
            try {

                $response = $client->post(
                    'https://kyc-api.flowboard.in/api/v1/income/epfo/find-uan',
                    [
                        'headers' => [
                            'Authorization' => $this->token,
                            'Accept' => 'application/json'
                        ],
                        'json' => [
                            'mobile_number' => $request->mobile_number
                        ]
                    ]
                );

                $uan_details = json_decode($response->getBody(), true);
               
                if ($user->role_id == 1 && isset($apiamster)) {
                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                    DB::table('uan_details')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'mobile_number' => $request->mobile_number,
                        'client_id' => $uan_details['data']['client_id'] ?? null,
                        'pf_uan' => $uan_details['data']['pf_uan'] ?? null,
                        'service_provider' => 'FLOWBOARD',
                        'created_at' => now(),
                        'updated_at' => now()
                    ]);
                }

                return response()->json([
                    'statusCode' => 200,
                    'uan_details' => $uan_details
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

              
                if ($statusCode == 500) {

                    try {

                        $digitapClient = new Client();

                        $digitapResponse = $digitapClient->post(
                            'https://svcdemo.digitap.work/cv/uan_lookup',
                            [
                                'headers' => [
                                    'Content-Type'  => 'application/json',
                                    'Accept'        => 'application/json',
                                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                                ],
                                'json' => [
                                    'client_ref_num' => uniqid('uan_'),
                                    'mobile' => $request->mobile_number
                                ]
                            ]
                        );

                        $digitapData = json_decode($digitapResponse->getBody(), true);

                        if (($digitapData['result_code'] ?? 0) == 101) {

                            if ($user->role_id == 1 && isset($apiamster)) {
                                $this->saveHitCount(
                                    $user->id,
                                    $api_id,
                                    'Transaction Successful (Digitap)',
                                    200
                                );

                                DB::table('uan_details')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'mobile_number' => $request->mobile_number,
                                    'pf_uan' => implode(',', $digitapData['result'] ?? []),
                                    'service_provider' => 'DIGITAP',
                                    'created_at' => now(),
                                    'updated_at' => now()
                                ]);
                            }

                            return response()->json([
                                'statusCode' => 200,
                                'uan_details' => $digitapData
                            ]);
                        }

                    } catch (\Exception $ex) {
                        
                    }
                }

                if ($statusCode == 422) {
                    return response()->json([
                        'statusCode' => 102,
                        'message' => 'Verification Failed. Please enter valid details.'
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Error. Please contact techsupport@docboyz.in. for more details'
                ]);
            }

        } else {
           
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please Recharge your wallet.'
            ]);
        }

    } else {
       
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}



    public function company_search(Request $request)
    {
        $statusCode = null;
        $company_search = null;
        $api_id = null;
        
        if (empty($request->company))
            return response()->json(array(['message' => 'Company name is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $client = new Client();
        $client = new \GuzzleHttp\Client(['verify' => false]);
        
        $headers = [
            'Authorization' => $this->sandbox_token,
            'Accept' => 'application/json'
        ];
        $json = [
            'company' => $request->company,
            'search_size' => $request->search_size
        ];
        
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'companysearch')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // return $this -> sandbox_url;
                    $response = $client->post("https://sandbox.flowboard.in/api/v1/employment/company-search", ['headers' => $headers, 'json' => $json]);
                    // return $response;
                    $company_search = json_decode($response->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        foreach ($company_search['data']['search_data'] as $data) {
                            $companysearch = DB::table('company_search')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "client_id" => $company_search['data']['client_id'],
                                "searched_name" => $company_search['data']['search_company_name'],
                                "confidence" => $data['confidence'],
                                "company" => $data['company'],
                                "company_code" => $data['company_code'],
                                "address" => $data['addres'],
                                "office" => $data['office'],
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //    return  $errorResponse;
                    if ($statusCode == 500) {
                      
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;

                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Company Search' => $company_search, 'statusCode' => '200'));
    }

    public function company_details(Request $request)
    {
        $statusCode = null;
        $company_details = null;
        $api_id = null;

        if (empty($request->company_code))
            return response()->json(array(['message' => 'Company code is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $client = new Client();
        $client = new \GuzzleHttp\Client(['verify' => false]);

        $headers = [
            'Authorization' => $this->sandbox_token,
            'Accept' => 'application/json'
        ];
        $json = [
            'company_code' => $request->company_code,
            'filling_data_size' => $request->filling_data_size
        ];

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'companydetails')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // return $this -> sandbox_url;
                    $response = $client->post("https://sandbox.flowboard.in/api/v1/employment/company-details", ['headers' => $headers, 'json' => $json]);
                    // return $response;
                    $company_details = json_decode($response->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        $companydetails = DB::table('company_details')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            "client_id" => $company_details['data']['client_id'],
                            "company_code" => $company_details['data']['search_company_code'],
                            "company_name" => $company_details['data']['search_data']['company'],
                            "address" => $company_details['data']['search_data']['addres'],
                            "pan_status" => $company_details['data']['search_data']['pan_status'],
                            "section_applicable" => $company_details['data']['search_data']['section_applicable'],
                            "primary_business_activity" => $company_details['data']['search_data']['primary_business_activity'],
                            "esic_code" => $company_details['data']['search_data']['esic_code'],
                            "ownership_type" => $company_details['data']['search_data']['ownership_type'],
                            "date_of_establishment" => $company_details['data']['search_data']['date_of_setup_of_establishment'],
                            "pincode" => $company_details['data']['search_data']['pin_code'],
                            "city" => $company_details['data']['search_data']['city'],
                            "state" => $company_details['data']['search_data']['state'],
                            "district" => $company_details['data']['search_data']['district'],
                            "epfo_office_name" => $company_details['data']['search_data']['epfo_office_name'],
                            "epfo_office_address" => $company_details['data']['search_data']['epfo_office_address'],
                            "zone" => $company_details['data']['search_data']['zone'],
                            "region" => $company_details['data']['search_data']['region'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }


                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //  return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('Company Details' => $company_details, 'statusCode' => '200'));

    }

    public function electricity(Request $request)
    {
        $statusCode = null;
        $electricity = null;
        $states = null;
        $api_id = null;
        $hit_limits_exceeded = 0;

        $data = explode('/', $request->id_number);
        if (empty($request->id_number)) {
            return response()->json(array(['message' => 'Comsumer Number with Billing Unit is required', 'statusCode' => '404']));
        } else {
            if (strlen($data[0]) > 4) {
                return response()->json(array(['message' => 'Billing unit is required', 'statusCode' => '404']));
            }
            if (isset($data[1]) && strlen($data[1]) != 12) {
                return response()->json(array(['message' => 'Please enter 12 digit Comsumer Number', 'statusCode' => '404']));
            }
        }

        // if(empty($request->code))
        //     return response()->json(array(['message'=>'Operator code is required','statusCode'=>'404']));  

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $client = new Client();
        $client = new \GuzzleHttp\Client(['verify' => false]);

        $headers = [
            'API-KEY' => $this->api_club_key,
            'Referer' => $this->site_url
        ];

        $body = [
            'consumer_no' => $data[1],
            'operator' => 'MSEM',
            'params' => $data[0]
        ];

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'electricity')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // try{
                //     $res = $client->get($this->api_club.'/fetch_bill', ['headers' => $headers]);
                //     $states = json_decode($res->getBody(), true);
                //     $statusCode = 200;
                // } catch(BadResponseException $e) {
                //     $statusCode = $e->getResponse()->getStatusCode();
                //     if($statusCode == 500){
                //         $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                //     }else if($statusCode == 422){
                //         $statusCode = 102;
                //         $errorMessage = 'Verification Failed. Please enter valid details.';
                //     }else{
                //         $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                //     }
                //     return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
                // }
                // $client = new Client();
                // $headers = [
                //     'Authorization' => $this->sandbox_token,        
                //     'Accept'        => 'application/json',
                // ];

                try {
                    $res = $client->post($this->api_club . '/v1/fetch_bill', ['headers' => $headers, 'json' => $body]);
                    $electricity = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('electricity' => $electricity, 'statusCode' => '200'));
    }

    public function shopestablishment(Request $request)
    {
        $statusCode = null;
        $electricity = null;
        $states = null;
        $api_id = null;
        $hit_limits_exceeded = 0;
        if (empty($request->id_number))
            return response()->json(array(['message' => 'Consumer number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $client = new Client();
        $client = new \GuzzleHttp\Client(['verify' => false]);

        $headers = [
            'Authorization' => $this->sandbox_token,
            'Accept' => 'application/json',
        ];
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'shop_establishment')->first();
            if ($apiamster) {
                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->get($this->sandbox_url . '/se/state-code-list', ['headers' => $headers]);
                    $states = json_decode($res->getBody(), true);
                    $statusCode = 200;
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }

                $client = new Client();
                $headers = [
                    'Authorization' => $this->sandbox_token,
                    'Accept' => 'application/json',
                ];

                $body = [
                    'id_number' => $request->id_number,
                    'operator_code' => $request->code
                ];


                if ($user->role_id == 1) {
                    $apiamster = ApiMaster::where('api_slug', 'shop_establishment')->first();
                    if ($apiamster)
                        $api_id = $apiamster->id;
                }

                try {
                    $res = $client->post($this->sandbox_url . '/se/', ['headers' => $headers, 'json' => $body]);
                    $electricity = json_decode($res->getBody(), true);

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('shopestablishment' => $shopestablishment, 'statusCode' => '200'));
    }

    public function passport_create_client(Request $request)
    {
        $statusCode = null;
        $passport = null;
        $api_id = null;
        $hit_limits_exceeded = 0;
        if (empty($request->id_number)) {
            return response()->json(['message' => 'Id Number is required', 'statusCode' => 404]);
        }
        $client = new Client();
        $headers = [
            'Authorization' => $this->token,
            'Accept' => 'application/json',
        ];

        $body = [
            'id_number' => $request->id_number
        ];

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'passportcreateclient')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post($this->base_url . '/passport/passport/create', ['headers' => $headers, 'json' => $body]);
                    $passport = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //  return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('passport' => $passport, 'statusCode' => 200));
    }

    public function passport_verify(Request $request)
    {
        $statusCode = null;
        $passport = null;
        $api_id = null;
        $hit_limits_exceeded = 0;

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'passportverify')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => $this->token
        ];

        $body = [
            'client_id' => $request->client_id
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {

                    $res = $client->post($this->base_url . '/passport/passport/verify', ['headers' => $headers, 'json' => $body]);
                    $passport = json_decode($res->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    //  return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        return response()->json(array('passport' => $passport, 'statusCode' => '200'));
    }

    public function upi_validation(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->upi_id))
            return response()->json(array(['message' => 'UPI ID is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

         $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));

        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'x-api-key' => $this->api_club_key,
            'Referer' => $this->site_url,
            'Accept' => 'application/json',
        ];

        $body =  [
            'name' => $request->name,
            'upi_id' => $request->upi_id,
            'order_id' => $request->order_id,
            // 'is_test' => $request->is_test,
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->post('https://prod.apiclub.in/api/v1/validate/upi', ['headers' => $headers, 'json' => $body]);
                    // $bank_verification = json_decode($res->getBody(), true);


                    // $res = $client->request('POST', 'https://prod.apiclub.in/api/v1/validate/upi', [
                    //     'body' => '{ "name":"' . $request->name . '","upi_id":"' . $request->upi_id . '", "order_id":"' . $request->order_id . '"}',
                    //     'headers' => [
                    //         'x-api-key' => $this->api_club_key,
                    //         'Accept' => 'application/json',
                    //         'Referer' => $this->site_url,
                    //     ],
                    // ]);
                    // // $res = $client->post($this->base_url.'/passport/passport/create', ['headers' => $headers, 'json' => $body]);
                    // // $res = $client->post($this->api_club.'/v2/validate/upi', ['headers' => $headers, 'json' => $body]);
                    $upidetails = json_decode($res->getBody(), true);
                    // return $upidetails;
                    if ($upidetails['code'] == 200) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        return response()->json(array('upidetails' => $upidetails, 'statusCode' => '200'));
                    } elseif ($upidetails['code'] == 404) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                            }
                        }
                        return response()->json(array('upidetails' => $upidetails, 'statusCode' => '404'));
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                            }
                        }
                        return response()->json(array('upidetails' => $upidetails, 'statusCode' => '500'));
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }



















    public function upi_validation18agust2025(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->upi_id))
            return response()->json(array(['message' => 'UPI ID is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $client = new Client();
        $headers = [
            'API-KEY' => $this->api_club_key,
            'Referer' => $this->site_url,
            'Accept' => 'application/json',
        ];

        // $body =  [
        //     'name' => $request->name,
        //     'upi_id' => $request->upi_id,
        //     'order_id' => $request->order_id,
        //     'is_test' => $request->is_test,
        // ];
// return $body;
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'upi')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $res = $client->request('POST', 'https://api.apiclub.in/api/v2/validate/upi', [
                        'body' => '{"is_test":"TRUE", "name":"' . $request->name . '","upi_id":"' . $request->upi_id . '", "order_id":"' . $request->order_id . '"}',
                        'headers' => [
                            'API-KEY' => $this->api_club_key,
                            'Accept' => 'application/json',
                            'Content-Type' => 'application/json',
                            'Referer' => $this->site_url,
                        ],
                    ]);
                    // $res = $client->post($this->base_url.'/passport/passport/create', ['headers' => $headers, 'json' => $body]);
                    // $res = $client->post($this->api_club.'/v2/validate/upi', ['headers' => $headers, 'json' => $body]);
                    $upidetails = json_decode($res->getBody(), true);
                    if ($upidetails['code'] == 200) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        return response()->json(array('upidetails' => $upidetails, 'statusCode' => '200'));
                    } elseif ($upidetails['code'] == 404) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                            }
                        }
                        return response()->json(array('upidetails' => $upidetails, 'statusCode' => '404'));
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                            }
                        }
                        return response()->json(array('upidetails' => $upidetails, 'statusCode' => '500'));
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }


    public function rc_test(Request $request)
    {

        $statusCode = null;
        $rc_validation = [];

        $client = new Client();


        $headers = [
            'AccessToken' => '11c1aa0a8436518ee16fcbb2a78265550b',
        ];

        $rc_numbers = DB::table('rcvalidation')->select('rc_number')->where('status_code', 200)->get();
        foreach ($rc_numbers as $rc) {
            $body = [
                'rc_number' => $rc->rc_number
            ];
            try {
                //$res = $client->post($this->base_url.'/rc/rc-full', ['headers' => $headers, 'json' => $body]);
                $res = $client->post('http://regtechapi.in/api/rc_validation', ['headers' => $headers, 'json' => $body]);
                $rc_validation[] = json_decode($res->getBody(), true);


            } catch (BadResponseException $e) {
                $statusCode = $e->getResponse()->getStatusCode();
                if ($statusCode == 500) {
                    $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                } else if ($statusCode == 404) {
                    $statusCode = 102;
                    $errorMessage = 'Verification Failed. Please enter valid details.';
                } else {
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                }
                return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
            }
        }
        return response()->json(array('rc_validation' => $rc_validation, 'statusCode' => '200'));
    }

    public function face_match(Request $request)
    {
        $statusCode = null;
        $face_match = [];
        $api_id = null;
        if (empty($request->doc_img))
            return response()->json(array(['message' => 'Document Image is required', 'statusCode' => '404']));

        if (empty($request->selfie))
            return response()->json(array(['message' => 'Selfie Image is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'facematch')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        if ($request->hasFile('doc_img') && $request->hasFile('selfie')) {
            $doc_img = base64_encode(file_get_contents($request->file('doc_img')->path()));
            $selfie = base64_encode(file_get_contents($request->file('selfie')->path()));
        } else {
            return response()->json(array(['message' => 'Please check the uploaded image formats', 'statusCode' => '404']));
        }
        $client = new Client();
        $headers = [
            'API-KEY' => $this->api_club_key,
            'Referer' => $this->site_url
        ];

        $body = [
            'doc_img' => $doc_img,
            'selfie' => $selfie
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

                try {
                    $res = $client->post($this->api_club . '/v1/face_match', ['headers' => $headers, 'json' => $body]);
                    $face_match = json_decode($res->getBody(), true);
                    if ($face_match['code'] == 200) {
                        $face_match['response']['confidence'] = $face_match['response']['match_score'];
                        unset($face_match['response']['match_score']);
                        if ((float) $face_match['response']['confidence'] > 80 && (float) $face_match['response']['confidence'] <= 90) {
                            $face_match['response']['confidence'] = "98.00";
                        } else if ((float) $face_match['response']['confidence'] > 70 && (float) $face_match['response']['confidence'] <= 80) {
                            $face_match['response']['confidence'] = "88.00";
                        } else if ((float) $face_match['response']['confidence'] > 60 && (float) $face_match['response']['confidence'] <= 70) {
                            $face_match['response']['confidence'] = "78.00";
                        } else if ((float) $face_match['response']['confidence'] < 50) {
                            $face_match['response']['confidence'] = "60.00";
                        }
                        $statusCode = $face_match['code'];
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Success', $statusCode);
                            }
                        }
                    } else {
                        $statusCode = 404;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $face_match['response']]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404) {
                        $statusCode = 102;
                        $errorMessage = 'Document Image and Selfie Image is required in base64 format';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['face_match' => $face_match, 'statusCode' => $statusCode]));
    }



    public function face_match1(Request $request)
    {
        $statusCode = null;
        $face_match = [];
        $api_id = null;
        if (empty($request->doc_img))
            return response()->json(array(['message' => 'Document Image is required', 'statusCode' => '404']));

        if (empty($request->selfie))
            return response()->json(array(['message' => 'Selfie Image is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'facematch')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'API-KEY' => $this->api_club_key,
            'Referer' => $this->site_url
        ];

        $body = [
            'doc_img' => $request->doc_img,
            'selfie' => $request->selfie
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                try {
                    $res = $client->post($this->api_club . '/v1/face_match', ['headers' => $headers, 'json' => $body]);
                    $face_match = json_decode($res->getBody(), true);
                    if ($face_match['code'] == 200) {
                        $face_match['response']['confidence'] = $face_match['response']['match_score'];
                        unset($face_match['response']['match_score']);
                        if ((float) $face_match['response']['confidence'] > 80 && (float) $face_match['response']['confidence'] <= 90) {
                            $face_match['response']['confidence'] = "98.00";
                        } else if ((float) $face_match['response']['confidence'] > 70 && (float) $face_match['response']['confidence'] <= 80) {
                            $face_match['response']['confidence'] = "88.00";
                        } else if ((float) $face_match['response']['confidence'] < 50) {
                            $face_match['response']['confidence'] = "10.00";
                        }
                        $statusCode = $face_match['code'];
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Success', 200);
                            }
                        }
                    } else {
                        $statusCode = 404;
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $face_match['response']]);
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404) {
                        $statusCode = 102;
                        $errorMessage = 'Document Image and Selfie Image is required in base64 format';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['face_match' => $face_match, 'statusCode' => $statusCode]));
    }

    // public function UpdateKYCStatus(Request $request){
    //     $statusCode = null;
    //     $kyc_status = [];
    //     $api_id = null;
    //     if(empty($request->outletErpId))
    //         return response()->json(array(['statusCode'=>'404', 'message'=>'ERP ID is required']));

    //     if(empty($request->isKYCVerified))
    //         return response()->json(array(['statusCode'=>'404', 'message'=>'KYC verification status is required']));

    //     if(!$request->headers->has('AccessToken'))
    //         return response()->json(array(['statusCode'=>'404', 'message'=>'Header Access Token is required']));

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken==false)
    //         return response()->json(array(['statusCode'=>'403', 'message'=>'Wrong Access Token']));

    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     if($user->role_id==1) {
    //         $apiamster = ApiMaster::where('api_slug','kycStatus')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //     }

    //     $client = new Client();
    //     $headers = [
    //         'content-type' => 'application/json'
    //     ];

    //     $body =  [
    //         'OutletErpId' => $request->outletErpId,
    //         'IsKYCVerified' => $request->isKYCVerified
    //     ];

    //     $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //     if($updateHitCount || $user->role_id==0){
    //         try{
    //             $res = $client->post('https://api.fieldassist.in/api/V3/Outlet/UpdateKYCStatus', ['headers' => $headers, 'json' => $body]);
    //             $kyc_status = json_decode($res->getBody(), true);
    //             return $kyc_status;
    //         } catch(BadResponseException $e) {
    //             $statusCode = $e->getResponse()->getStatusCode();
    //             if($statusCode == 500){
    //                 $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                 }
    //             }else if($statusCode == 404){
    //                 $statusCode = 102;
    //                 $errorMessage = 'Document Image and Selfie Image is required in base64 format';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }else{
    //                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                 if($user->role_id==1) {
    //                     if($apiamster) {
    //                         $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                     }
    //                 }
    //             }
    //             return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //         }
    //     }else{
    //         return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //     }
    //     return response()->json(array(['kyc_status'=>$kyc_status,'statusCode'=>$statusCode]));
    // }

    public function signyzytoken(Request $request)
    {
        // return 'test udyam';
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;
        $client = new Client();
        $body = [
            'username' => "Docboyz_prod",
            'password' => "0s4PB6hr4E7u5J58oYGq",
        ];

        $response = $client->post('https://sandbox.signzy.tech/api/v2/patrons/login', [
            'json' => $body
        ]);
        $tokenresponse = json_decode($response->getBody(), true);
        if (isset($tokenresponse)) {
            // return $tokenresponse['id'];
            $insertdata = DB::table('udyamtoken')->insert(['token' => $tokenresponse['id'], 'userid' => $tokenresponse['userId'], 'created_at' => Carbon::now(), 'updated_at' => Carbon::now()]);
            return response()->json(['statuscode' => 200, 'data' => $tokenresponse]);
        } else {
            return response()->json(['statusCode' => 500, 'message' => 'There is some error in token api']);
        }
    }

    public function udyamsearch(Request $request)
    {
        // return 'searcapi';
        $apimaster = null;
        $udyamNumber = $request->udyamNumber;
        // return $gstno;
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;

        if (empty($request->udyamNumber))
            return response()->json(array(['message' => 'Udyam number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'udyamsearch')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
            'Authorization'=>'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
        ];
        $randomInt = strval(rand(100, 999));

        $body = [
            'client_ref_num' => $randomInt,
            'udyam_reg_no' => $udyamNumber
        ];


        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {

                    $response = $client->post('https://svcdemo.digitap.work/validation/kyb/v1/udyam_authentication/basic', [
                        'headers' => $headers,
                        'json' => $body
                    ]);
                    $udyamresponse = json_decode($response->getBody(), true);
                    if (isset($udyamresponse['http_response_code']) && $udyamresponse['http_response_code'] == 200) {
                        if (isset($udyamresponse['result_code']) && $udyamresponse['result_code'] == 101 && !empty($udyamresponse['result'])) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }

                    return response()->json([
                            'status_code' => 200,
                            'message_code' => 'success',
                            'success' => true,
                            'response' => $udyamresponse['result']  
                        ]);
                        } else {
                      
                        $statusCode = 102;
                        $errorMessage = 'No data found.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404 || $statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Udyam Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }


    public function udyamsearch22agust2025(Request $request)
    {
        // return 'searcapi';

        $udyamNumber = $request->udyamNumber;
        // return $gstno;
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;

        if (empty($request->udyamNumber))
            return response()->json(array(['message' => 'Udyam number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'udyamsearch')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $token = DB::table('udyamtoken')->get();
        $autorizationtoken = $token[0]->token;
        $patron_id = $token[0]->userid;
        $headers = [
            'Authorization' => $autorizationtoken,
            'Accept' => 'application/json',
        ];

        $body = [
            "essentials" => [
                "udyamNumber" => $udyamNumber
            ]
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {

                    $response = $client->post('https://sandbox.signzy.tech/api/v2/patrons/' . $patron_id . '/udyamregistrations', [
                        'headers' => $headers,
                        'json' => $body
                    ]);
                    $udyamresponse = json_decode($response->getBody(), true);
                    // return $udyamresponse;
                    $udyamresponsedata = [];
                    $udyamresponsedata['essentials'] = $udyamresponse['essentials'];
                    $udyamresponsedata['id'] = $udyamresponse['id'];
                    $udyamresponsedata['patronId'] = $udyamresponse['patronId'];
                    $udyamresponsedata['result']['generalInfo'] = $udyamresponse['result']['generalInfo'];
                    $udyamresponsedata['result']['enterpriseType'] = $udyamresponse['result']['enterpriseType'];
                    $udyamresponsedata['result']['unitsDetails'] = $udyamresponse['result']['unitsDetails'];
                    $udyamresponsedata['result']['officialAddressOfEnterprise'] = $udyamresponse['result']['officialAddressOfEnterprise'];
                    $udyamresponsedata['result']['nationalIndustryClassificationCodes'] = $udyamresponse['result']['nationalIndustryClassificationCodes'];
                    // return $udyamresponsedata;

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                    return response()->json(['statusCode' => 200, 'response' => $udyamresponsedata]);


                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return  $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 404 || $statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Udyam Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function udyogaadhaars(Request $request)
    {
        // return 'searcapi';

        $uamnumber = $request->uamnumber;
        // return $gstno;
        $statusCode = null;
        $corporate_gstin = null;
        $api_id = null;
        if (empty($request->uamnumber))
            return response()->json(array(['message' => 'Udyog Adhar number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'udyamadhar')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $token = DB::table('udyamtoken')->get();
        $autorizationtoken = $token[0]->token;
        $patron_id = $token[0]->userid;
        $headers = [
            'Authorization' => $autorizationtoken,
            'Accept' => 'application/json',
        ];

        $body = [
            "type" => "uam",
            "essentials" => [
                "uamNumber" => $uamnumber
            ]
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {

                    $response = $client->post('https://sandbox.signzy.tech/api/v2/patrons/' . $patron_id . '/udyogaadhaars', [
                        'headers' => $headers,
                        'json' => $body
                    ]);
                    $udyamresponse = json_decode($response->getBody(), true);
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                    return response()->json(['statusCode' => 200, 'response' => $udyamresponse]);


                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 400 || $statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Udyog adhar Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function initiateEquifaxold(Request $request)
    {
        return 'test ok';
        $validator = \Validator::make(
            $request->all(),
            [
                'FirstName' => 'required',
                'LastName' => 'required',
                'DOB' => 'required',
                'MobileNumber' => 'required|regex:/^[0-9]{10}+$/',
                'IdValue' => 'required',
            ],
            [
                'FirstName.required' => 'First Name  is required',
                'LastName.required' => 'Last Name  is required',
                'DOB.required' => 'Date of birth  is required',
                'MobileNumber.required' => 'Mobile Number is required',
                'MobileNumber.regex' => 'Mobile Number should be 10 digits',
                'IdValue.required' => 'Pan card value is required'
            ]
        );

        if ($validator->fails()) {
            return response()->json(['message' => $validator->errors(), 'statusCode' => 401]);
        }
        $body = [
            'InquiryPurpose' => "10",
            'FirstName' => $request->FirstName,
            'MiddleName' => '',
            'LastName' => $request->LastName,
            'DOB' => $request->DOB,
            'InquiryPhones' => [
                [
                    'seq' => '1',
                    'Number' => $request->MobileNumber,
                    'PhoneType' => ['M'],
                ],
            ],
            'IDDetails' => [
                [
                    'seq' => '1',
                    'IDType' => 't',
                    'IDValue' => $request->IdValue,
                ],
            ],
        ];

        $headers = [
            'Authorization' => 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0bGFuZCIsImlhdCI6MTY5MTM4NDEzODczNH0.nHmNhb-NlFPziNE_-9iEGKTIVoiz5rM_lNVvPLvQLgU',
            'Content-Type' => 'application/json',
        ];
        $client = new Client();
        $response = $client->post('https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score', [
            'headers' => $headers,
            'json' => $body,
        ]);
        $responseData = json_decode($response->getBody(), true);
        if (isset($responseData['data']['CCRResponse']['CIRReportDataLst']['0']['CIRReportData']['ScoreDetails']['0']['Value'])) {
            $score_value = $responseData['data']['CCRResponse']['CIRReportDataLst']['0']['CIRReportData']['ScoreDetails']['0']['Value'];
            return response()->json(['statusCode' => 200, 'success' => $responseData['success'], 'ScoreValue ' => $score_value]);
        }
        if (isset($responseData['data']['Error']['ErrorDesc'])) {
            return response()->json(['statusCode' => 401, 'ErrorDesc' => $responseData['data']['Error']['ErrorDesc']]);
        }
        if (isset($responseData['data']['CCRResponse']['CIRReportDataLst']['0']['Error']['ErrorDesc'])) {
            return response()->json(['statusCode' => 102, 'Error' => $responseData['data']['CCRResponse']['CIRReportDataLst']['0']['Error']['ErrorDesc']]);
        } else {
            return response()->json(['statusCode' => 201, 'ErrorDesc' => 'Invalid Input']);
        }
    }

    public function initiateEquifax(Request $request)
    {

        $api_id = null;
        $validator = \Validator::make(
            $request->all(),
            [
                'FirstName' => 'required',
                'LastName' => 'required',
                'DOB' => 'required',
                'MobileNumber' => 'required|regex:/^[0-9]{10}+$/',
                'IdValue' => 'required',
            ],
            [
                'FirstName.required' => 'First Name  is required',
                'LastName.required' => 'Last Name  is required',
                'DOB.required' => 'Date of birth  is required',
                'MobileNumber.required' => 'Mobile Number is required',
                'MobileNumber.regex' => 'Mobile Number should be 10 digits',
                'IdValue.required' => 'Pan card value is required'
            ]
        );

        if ($validator->fails()) {
            return response()->json(['message' => $validator->errors(), 'statusCode' => 401]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'equifax_score')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $body = [
                    'InquiryPurpose' => "10",
                    'FirstName' => $request->FirstName,
                    'MiddleName' => '',
                    'LastName' => $request->LastName,
                    'DOB' => $request->DOB,
                    'InquiryPhones' => [
                        [
                            'seq' => '1',
                            'Number' => $request->MobileNumber,
                            'PhoneType' => ['M'],
                        ],
                    ],
                    'IDDetails' => [
                        [
                            'seq' => '1',
                            'IDType' => 't',
                            'IDValue' => $request->IdValue,
                        ],
                    ],
                ];

                $headers = [
                    'Authorization' => 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0bGFuZCIsImlhdCI6MTY5MTM4NDEzODczNH0.nHmNhb-NlFPziNE_-9iEGKTIVoiz5rM_lNVvPLvQLgU',
                    'Content-Type' => 'application/json',
                ];
                $client = new Client();
                $response = $client->post('https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score', [
                    'headers' => $headers,
                    'json' => $body,
                ]);
                $responseData = json_decode($response->getBody(), true);
                if (isset($responseData['data']['CCRResponse']['CIRReportDataLst']['0']['CIRReportData']['ScoreDetails']['0']['Value'])) {
                    $score_value = $responseData['data']['CCRResponse']['CIRReportDataLst']['0']['CIRReportData']['ScoreDetails']['0']['Value'];
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                    return response()->json(['statusCode' => 200, 'success' => $responseData['success'], 'ScoreValue ' => $score_value]);
                }
                if (isset($responseData['data']['Error']['ErrorDesc'])) {
                    return response()->json(['statusCode' => 401, 'ErrorDesc' => $responseData['data']['Error']['ErrorDesc']]);
                }
                if (isset($responseData['data']['CCRResponse']['CIRReportDataLst']['0']['Error']['ErrorDesc'])) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                        }
                    }
                    return response()->json(['statusCode' => 102, 'Error' => $responseData['data']['CCRResponse']['CIRReportDataLst']['0']['Error']['ErrorDesc']]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 201);
                        }
                    }
                    return response()->json(['statusCode' => 201, 'ErrorDesc' => 'Invalid Input']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function pan_new_details_check(Request $request)
    {
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        $apimaster = null;
        $pandetailsinfo = [];
        if (empty($request->pan_no)) {
            return response()->json(['message' => 'Pancard number is required', 'statusCode' => '404']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Header Access Token is required', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '403']);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apimaster = ApiMaster::where('api_slug', 'pandetails1')->first();
            if ($apimaster) {
                $api_id = $apimaster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        $client = new Client();
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);
        $headers = [
            'Accept' => 'application/json',
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
        ];
        $body = [
            'panNumber' => $request->pan_no,
            'groupId' => $groupId,
            'checkId' => $checkId,
        ];
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post('https://api.kyckart.com/api/panCard/panDetailedContactV4', [
                        'headers' => $headers,
                        'json' => $body,
                    ]);
                    $pancard_details = json_decode($response->getBody(), true);
                    if ($pancard_details['response']['code'] == 200 && $pancard_details['status']['statusCode'] == 200) {
                        $pancard['data']['client_id'] = null;
                        $pancard['data']['transactionId'] = isset($pancard_details['status']['transactionId']) ? $pancard_details['status']['transactionId'] : null;
                        $pancard['data']['panNumber'] = isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null;
                        $pancard['data']['maskedAadhar'] = isset($pancard_details['response']['maskedAadhaar']) ? $pancard_details['response']['maskedAadhaar'] : null;
                        $pancard['data']['lastFourDigitAadhar'] = isset($pancard_details['response']['lastFourDigit']) ? $pancard_details['response']['lastFourDigit'] : null;
                        $pancard['data']['typeOfHolder'] = isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null;
                        $pancard['data']['name'] = isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null;
                        $pancard['data']['firstName'] = isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null;
                        $pancard['data']['middleName'] = isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null;
                        $pancard['data']['lastName'] = isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null;
                        $pancard['data']['gender'] = isset($pancard_details['response']['gender']) ? $pancard_details['response']['gender'] : null;
                        $pancard['data']['dob'] = isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null;
                        $pancard['data']['address'] = isset($pancard_details['response']['address']) ? $pancard_details['response']['address'] : null;
                        $pancard['data']['city'] = isset($pancard_details['response']['city']) ? $pancard_details['response']['city'] : null;
                        $pancard['data']['state'] = isset($pancard_details['response']['state']) ? $pancard_details['response']['state'] : null;
                        $pancard['data']['country'] = isset($pancard_details['response']['country']) ? $pancard_details['response']['country'] : null;
                        $pancard['data']['pincode'] = isset($pancard_details['response']['pincode']) ? $pancard_details['response']['pincode'] : null;
                        $pancard['data']['mobile_no'] = isset($pancard_details['response']['mobile_no']) ? $pancard_details['response']['mobile_no'] : null;
                        $pancard['data']['email'] = isset($pancard_details['response']['email']) ? $pancard_details['response']['email'] : null;
                        $pancard['data']['isValid'] = isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null;
                        $pancard['data']['aadhaarSeedingStatus'] = isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null;
                        $pancard['data']['serviceCode'] = isset($pancard_details['response']['serviceCode']) ? $pancard_details['response']['serviceCode'] : null;
                        $data_user = UserSchemeMaster::where('user_id', $user->id)
                            ->where('api_id', '')
                            ->orderBy('id', 'desc')
                            ->pluck('permission');
                        if (count($data_user) > 0) {
                            $pandetails_data = explode(',', $data_user[0]);
                        }
                        if (isset($pandetails_data) && $pandetails_data != null) {
                            $pancard['data']['pandetails1'] = null;
                            foreach ($pandetails_data as $pan_data) {
                                $pandetailsinfo['data'][$pan_data] = $pancard['data'][$pan_data];
                            }
                            if ($user->role_id == 1) {
                                if ($apimaster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                    $paninfo = DB::table('pan_info')->insert([
                                        'user_id' => $user->id,
                                        'api_id' => $api_id,
                                        'client_id' => null,
                                        'status_code' => 200,
                                        'groupId' => isset($groupId) ? $groupId : null,
                                        'checkId' => isset($checkId) ? $checkId : null,
                                        'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                        'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                        'transaction_id' => isset($pancard_details['status']['transactionId']) ? $pancard_details['status']['transactionId'] : null,
                                        'pan_no' => isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null,
                                        'masked_aadhar' => isset($pancard_details['response']['maskedAadhaar']) ? $pancard_details['response']['maskedAadhaar'] : null,
                                        'last_four_digit_aadhar' => isset($pancard_details['response']['lastFourDigit']) ? $pancard_details['response']['lastFourDigit'] : null,
                                        'type_of_holder' => isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null,
                                        'name' => isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null,
                                        'firstname' => isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null,
                                        'middlename' => isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null,
                                        'lastname' => isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null,
                                        'gender' => isset($pancard_details['response']['gender']) ? $pancard_details['response']['gender'] : null,
                                        'dob' => isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null,
                                        'city' => isset($pancard_details['response']['city']) ? $pancard_details['response']['city'] : null,
                                        'state' => isset($pancard_details['response']['state']) ? $pancard_details['response']['state'] : null,
                                        'country' => isset($pancard_details['response']['country']) ? $pancard_details['response']['country'] : null,
                                        'pincode' => isset($pancard_details['response']['pincode']) ? $pancard_details['response']['pincode'] : null,
                                        'mobile_no' => isset($pancard_details['response']['mobile_no']) ? $pancard_details['response']['mobile_no'] : null,
                                        'email' => isset($pancard_details['response']['email']) ? $pancard_details['response']['email'] : null,
                                        'is_valid' => isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null,
                                        'aadhar_seeding_status' => isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null,
                                        'service_code' => isset($pancard_details['response']['serviceCode']) ? $pancard_details['response']['serviceCode'] : null,
                                        'message_code' => 'success',
                                        'created_at' => Carbon::now(),
                                        'updated_at' => Carbon::now(),
                                    ]);
                                }
                            }
                            return response()->json(['pancard' => $pandetailsinfo, 'status_code' => 200, 'success' => true, 'message_code' => 'success']);
                        } else {
                            if ($user->role_id == 1) {

                                if ($apimaster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                    $paninfo = DB::table('pan_info')->insert([
                                        'user_id' => $user->id,
                                        'api_id' => $api_id,
                                        'client_id' => null,
                                        'status_code' => 200,
                                        'groupId' => isset($groupId) ? $groupId : null,
                                        'checkId' => isset($checkId) ? $checkId : null,
                                        'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                        'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                        'transaction_id' => isset($pancard_details['status']['transactionId']) ? $pancard_details['status']['transactionId'] : null,
                                        'pan_no' => isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null,
                                        'masked_aadhar' => isset($pancard_details['response']['maskedAadhaar']) ? $pancard_details['response']['maskedAadhaar'] : null,
                                        'last_four_digit_aadhar' => isset($pancard_details['response']['lastFourDigit']) ? $pancard_details['response']['lastFourDigit'] : null,
                                        'type_of_holder' => isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null,
                                        'name' => isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null,
                                        'firstname' => isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null,
                                        'middlename' => isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null,
                                        'lastname' => isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null,
                                        'gender' => isset($pancard_details['response']['gender']) ? $pancard_details['response']['gender'] : null,
                                        'dob' => isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null,
                                        'city' => isset($pancard_details['response']['city']) ? $pancard_details['response']['city'] : null,
                                        'state' => isset($pancard_details['response']['state']) ? $pancard_details['response']['state'] : null,
                                        'country' => isset($pancard_details['response']['country']) ? $pancard_details['response']['country'] : null,
                                        'pincode' => isset($pancard_details['response']['pincode']) ? $pancard_details['response']['pincode'] : null,
                                        'mobile_no' => isset($pancard_details['response']['mobile_no']) ? $pancard_details['response']['mobile_no'] : null,
                                        'email' => isset($pancard_details['response']['email']) ? $pancard_details['response']['email'] : null,
                                        'is_valid' => isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null,
                                        'aadhar_seeding_status' => isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null,
                                        'service_code' => isset($pancard_details['response']['serviceCode']) ? $pancard_details['response']['serviceCode'] : null,
                                        'message_code' => 'success',
                                        'created_at' => Carbon::now(),
                                        'updated_at' => Carbon::now(),
                                    ]);
                                }
                            }
                            return response()->json(['pancard' => $pancard, 'status_code' => 200, 'success' => true, 'message_code' => 'success']);
                        }
                    } elseif ($pancard_details['status']['statusCode'] == 200 && $pancard_details['response']['code'] == 400) {
                        $statusCode = 102;
                        $errorMessage = 'No Records found!.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.Please contact techsupport@docboyz.in';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'PAN Number InValid Please Enter Correct PanNumber.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'client_id' => null,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => "Please recharge your wallet."]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }

    public function pancard_new_details(Request $request)
    {
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        $apimaster = null;
        if (empty($request->pan_no)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apimaster = ApiMaster::where('api_slug', 'paninfo')->first();
            if ($apimaster) {
                $api_id = $apimaster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        $client = new Client();
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);
        $headers = [
            'Accept' => 'application/json',
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
        ];
        $body = [
            'panNumber' => $request->pan_no,
            'groupId' => $groupId,
            'checkId' => $checkId,
        ];
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post('https://api.kyckart.com/api/panCard/panDetailedContactV4', [
                        'headers' => $headers,
                        'json' => $body,
                    ]);
                    $pancard_details = json_decode($response->getBody(), true);
                    if ($pancard_details['response']['code'] == 200 && $pancard_details['status']['statusCode'] == 200) {
                        $pancard['data']['client_id'] = null;
                        $pancard['data']['transactionId'] = isset($pancard_details['status']['transactionId']) ? $pancard_details['status']['transactionId'] : null;
                        $pancard['data']['panNumber'] = isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null;
                        $pancard['data']['maskedAadhar'] = isset($pancard_details['response']['maskedAadhaar']) ? $pancard_details['response']['maskedAadhaar'] : null;
                        $pancard['data']['lastFourDigitAadhar'] = isset($pancard_details['response']['lastFourDigit']) ? $pancard_details['response']['lastFourDigit'] : null;
                        $pancard['data']['typeOfHolder'] = isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null;
                        $pancard['data']['name'] = isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null;
                        $pancard['data']['firstName'] = isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null;
                        $pancard['data']['middleName'] = isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null;
                        $pancard['data']['lastName'] = isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null;
                        $pancard['data']['gender'] = isset($pancard_details['response']['gender']) ? $pancard_details['response']['gender'] : null;
                        $pancard['data']['dob'] = isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null;
                        $pancard['data']['address'] = isset($pancard_details['response']['address']) ? $pancard_details['response']['address'] : null;
                        $pancard['data']['city'] = isset($pancard_details['response']['city']) ? $pancard_details['response']['city'] : null;
                        $pancard['data']['state'] = isset($pancard_details['response']['state']) ? $pancard_details['response']['state'] : null;
                        $pancard['data']['country'] = isset($pancard_details['response']['country']) ? $pancard_details['response']['country'] : null;
                        $pancard['data']['pincode'] = isset($pancard_details['response']['pincode']) ? $pancard_details['response']['pincode'] : null;
                        $pancard['data']['mobile_no'] = isset($pancard_details['response']['mobile_no']) ? $pancard_details['response']['mobile_no'] : null;
                        $pancard['data']['email'] = isset($pancard_details['response']['email']) ? $pancard_details['response']['email'] : null;
                        $pancard['data']['isValid'] = isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null;
                        $pancard['data']['aadhaarSeedingStatus'] = isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null;
                        $pancard['data']['serviceCode'] = isset($pancard_details['response']['serviceCode']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null;
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'client_id' => null,
                                    'status_code' => 200,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'transaction_id' => isset($pancard_details['status']['transactionId']) ? $pancard_details['status']['transactionId'] : null,
                                    'pan_no' => isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null,
                                    'masked_aadhar' => isset($pancard_details['response']['maskedAadhaar']) ? $pancard_details['response']['maskedAadhaar'] : null,
                                    'last_four_digit_aadhar' => isset($pancard_details['response']['lastFourDigit']) ? $pancard_details['response']['lastFourDigit'] : null,
                                    'type_of_holder' => isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null,
                                    'name' => isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null,
                                    'firstname' => isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null,
                                    'middlename' => isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null,
                                    'lastname' => isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null,
                                    'gender' => isset($pancard_details['response']['gender']) ? $pancard_details['response']['gender'] : null,
                                    'dob' => isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null,
                                    'city' => isset($pancard_details['response']['city']) ? $pancard_details['response']['city'] : null,
                                    'state' => isset($pancard_details['response']['state']) ? $pancard_details['response']['state'] : null,
                                    'country' => isset($pancard_details['response']['country']) ? $pancard_details['response']['country'] : null,
                                    'pincode' => isset($pancard_details['response']['pincode']) ? $pancard_details['response']['pincode'] : null,
                                    'mobile_no' => isset($pancard_details['response']['mobile_no']) ? $pancard_details['response']['mobile_no'] : null,
                                    'email' => isset($pancard_details['response']['email']) ? $pancard_details['response']['email'] : null,
                                    'is_valid' => isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null,
                                    'aadhar_seeding_status' => isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null,
                                    'service_code' => isset($pancard_details['response']['serviceCode']) ? $pancard_details['response']['serviceCode'] : null,
                                    'message_code' => 'success',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['pancard' => $pancard, 'status_code' => 200, 'success' => true, 'message_code' => 'success']);
                    } elseif ($pancard_details['status']['statusCode'] == 200 && $pancard_details['response']['code'] == 400) {
                        $statusCode = 102;
                        $errorMessage = 'No Records found!.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'client_id' => null,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'PAN Number InValid Please Enter Correct PanNumber.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);

                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        //  return response()->json([['pancard' => $pancard, 'statusCode' => $statusCode]]);
    }

    public function ckycSearchlite_check(Request $request)
    {

        // return 'test3';
        $statusCode = null;
        $pancard = null;
        $pancard_response = null;
        $api_id = null;
        $api_slug = 'searchkyclite';
        if (empty($request->pano)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        // if (empty($request->dob)) {
        //     return response()->json([['message' => 'Date of birth is required', 'statusCode' => '404']]);
        // }
        //  $validator = Validator::make($request->all(), [
        //     'dob' => ['required', 'date_format:Y-m-d'],
        // ]);

        // if ($validator->fails()) {
        //     return response()->json(['error' => $validator->errors(), 'statusCode' => '404']);
        // }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        //return $user->id;
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', $api_slug)->first();
            // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $panno = $request->pano;
        $dob = $request->dob;
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $headers = [
                        'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
                    ];
                    $body = [
                        'panNumber' => $request->pano,
                        'groupId' => $groupId,
                        'checkId' => $checkId,
                    ];
                    $client = new Client();
                    $res = $client->post('https://api.kyckart.com/api/panCard/panDetailedContactV4', ['headers' => $headers, 'json' => $body]);
                    $allpandata = json_decode($res->getBody(), true);
                    // return  $allpandata;

                    $data = [
                        'document_type' => 'PAN',
                        'id_number' => $panno,
                        'consent' => true,
                        'consent_purpose' => 'this is the consent_purpose can be passed any string value',
                    ];
                    $searchkyc = [];
                    $searchkycupdate = [];
                    if (isset($allpandata['status']['statusCode']) && $allpandata['status']['statusCode'] == 200) {
                        if ($allpandata['response']['code'] == 400) {
                            $searchkyc['statusCode'] = $allpandata['response']['code'];
                            $searchkyc['message'] = $allpandata['response']['message'];
                            if ($user->role_id == 1) {
                                $apiamster = ApiMaster::where('api_slug', $api_slug)->first();
                                if ($apiamster) {
                                    $api_id = $apiamster->id;
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                                }
                                $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'dob' => $dob,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($allpandata['status']['statusCode']) ? $allpandata['status']['statusCode'] : null,
                                    'vender_code' => isset($allpandata['response']['code']) ? $allpandata['response']['code'] : null,
                                    'status' => 102,
                                    'pan_no' => $request->pano,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                            return response()->json(['statusCode' => 102, 'response' => $allpandata['response']['message']]);
                        }
                        $searchkyc['statusCode'] = $allpandata['status']['statusCode'];
                        $searchkyc['message'] = 'Details downloaded successfully';
                        $searchkyc['success'] = true;

                        //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan']= $allpandata['response']['pan'];
                        //$searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maskedAadhaar']= $allpandata['response']['maskedAadhaar'];
                        //$searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastFourDigit'] = $allpandata['response']['lastFourDigit'];
                        // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['typeOfHolder'] = $allpandata['response']['typeOfHolder'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = isset($allpandata['response']['name']) ? $allpandata['response']['name'] : null;
                        // $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['response']['firstName'];
                        //$searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['response']['lastName'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = isset($allpandata['response']['mobile_no']) ? $allpandata['response']['mobile_no'] : null;
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = isset($allpandata['response']['email']) ? $allpandata['response']['email'] : null;
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = isset($allpandata['response']['dob']) ? $allpandata['response']['dob'] : null;
                        //$searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender']= $allpandata['response']['gender'];
                        //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['address'] = $allpandata['response']['address'];
                        //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['city']= $allpandata['response']['city'];
                        //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['state']= $allpandata['response']['state'];
                        //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['country']= $allpandata['response']['country'];
                        //  $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pincode']= $allpandata['response']['pincode'];
                        // return $searchkyc;
                        $api_masterInfo = ApiMaster::where('api_slug', 'searchkyclite')->first();
                        $searchkyclite1 = UserSchemeMaster::where('user_id', $user->id)
                            ->where('api_id', $api_masterInfo->id)
                            ->pluck('permission');

                        // return $api_masterInfo->id;
                        //  return $searchkyclite1;
                        if (count($searchkyclite1) > 0 && $searchkyclite1[0] != NULL) {
                            //   return  $searchkyclite1;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['pan'] = isset($allpandata['response']['pan']) ? $allpandata['response']['pan'] : null;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['maskedAadhaar'] = isset($allpandata['response']['maskedAadhaar']) ? $allpandata['response']['maskedAadhaar'] : null;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['lastFourDigit'] = isset($allpandata['response']['lastFourDigit']) ? $allpandata['response']['lastFourDigit'] : null;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['typeOfHolder'] = isset($allpandata['response']['typeOfHolder']) ? $allpandata['response']['typeOfHolder'] : null;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = isset($allpandata['response']['name']) ? $allpandata['response']['name'] : null;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = isset($allpandata['response']['firstName']) ? $allpandata['response']['firstName'] : null;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['middleName'] = isset($allpandata['response']['middleName']) ? $allpandata['response']['middleName'] : null;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['isValid'] = isset($allpandata['response']['isValid']) ? $allpandata['response']['isValid'] : null;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['aadhaarSeedingStatus'] = $allpandata['response']['aadhaarSeedingStatus'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['serviceCode'] = $allpandata['response']['serviceCode'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['response']['lastName'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = $allpandata['response']['mobile_no'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['response']['email'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['response']['dob'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['gender'] = $allpandata['response']['gender'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['address'] = $allpandata['response']['address'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['city'] = $allpandata['response']['city'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['state'] = $allpandata['response']['state'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['country'] = $allpandata['response']['country'];
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['pincode'] = $allpandata['response']['pincode'];
                            $searchkyclite_info = explode(',', $searchkyclite1[0]);

                            $pancard_response['statusCode'] = $allpandata['status']['statusCode'];
                            $pancard_response['message'] = 'Details downloaded successfully';
                            $pancard_response['success'] = true;
                            $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails']['searchkyclite'] = null;
                            foreach ($searchkyclite_info as $searchkyclite) {
                                $pancard_response['kycDetails']['personalIdentifiableData']['personalDetails'][$searchkyclite] = $searchkycupdate['kycDetails']['personalIdentifiableData']['personalDetails'][$searchkyclite];

                            }
                            if ($user->role_id == 1) {
                                $apiamster = ApiMaster::where('api_slug', $api_slug)->first();
                                $api_id = $apiamster->id;
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($allpandata['status']['statusCode']) ? $allpandata['status']['statusCode'] : null,
                                    'vender_code' => isset($allpandata['response']['code']) ? $allpandata['response']['code'] : null,
                                    'status' => 200,
                                    'pan_no' => $allpandata['response']['pan'],
                                    'ckycid' => null,
                                    'firstname' => $allpandata['response']['firstName'],
                                    'fullname' => $allpandata['response']['name'],
                                    'mobilenum' => $allpandata['response']['mobile_no'],
                                    'email' => $allpandata['response']['email'],
                                    'dob' => $allpandata['response']['dob'],
                                    'paddress' => $allpandata['response']['address'],
                                    'pstate' => $allpandata['response']['state'],
                                    'pcity' => $allpandata['response']['city'],
                                    'caddress' => null,
                                    'cstate' => null,
                                    'ccity' => null,
                                    'currentpincode' => null,
                                    'permanantpincode' => $allpandata['response']['pincode'],
                                    // "pancard_id"=> $pancard['response']['pan_no'],
                                    // "name"=> $pancard['response']['registered_name'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                            return response()->json(['statusCode' => 200, 'response' => $pancard_response]);
                        } else {
                            //   return 'not ok';
                            if ($user->role_id == 1) {
                                $apiamster = ApiMaster::where('api_slug', $api_slug)->first();
                                $api_id = $apiamster->id;
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $panvalidation = DB::table('search')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status' => 200,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($allpandata['status']['statusCode']) ? $allpandata['status']['statusCode'] : null,
                                    'vender_code' => isset($allpandata['response']['code']) ? $allpandata['response']['code'] : null,
                                    'pan_no' => $allpandata['response']['pan'],
                                    'ckycid' => null,
                                    'firstname' => $allpandata['response']['firstName'],
                                    'fullname' => $allpandata['response']['name'],
                                    'mobilenum' => $allpandata['response']['mobile_no'],
                                    'email' => $allpandata['response']['email'],
                                    'dob' => $allpandata['response']['dob'],
                                    'paddress' => $allpandata['response']['address'],
                                    'pstate' => $allpandata['response']['state'],
                                    'pcity' => $allpandata['response']['city'],
                                    'caddress' => null,
                                    'cstate' => null,
                                    'ccity' => null,
                                    'currentpincode' => null,
                                    'permanantpincode' => $allpandata['response']['pincode'],
                                    // "pancard_id"=> $pancard['response']['pan_no'],
                                    // "name"=> $pancard['response']['registered_name'],
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                    } else {
                        if ($user->role_id == 1) {
                            $apiamster = ApiMaster::where('api_slug', $api_slug)->first();
                            $api_id = $apiamster->id;
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 202);
                            }
                            $panvalidation = DB::table('search')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'groupId' => isset($groupId) ? $groupId : null,
                                'checkId' => isset($checkId) ? $checkId : null,
                                'vender_status_code' => isset($allpandata['status']['statusCode']) ? $allpandata['status']['statusCode'] : null,
                                'vender_code' => isset($allpandata['response']['code']) ? $allpandata['response']['code'] : null,
                                'dob' => $dob,
                                'status' => 202,
                                'pan_no' => $request->pano,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                            return response()->json(['statusCode' => 202, 'response' => $allpandata]);
                        }
                    }
                } catch (ClientException $e) {
                    $response = $e->getResponse();
                    $statusCode = $response->getStatusCode();
                    $errorResponse = json_decode($response->getBody(), true);
                    $errorResponse['error']['message'];
                    $kyccarderror = null;
                    $kyccarderror['error']['name'] = null;
                    $kyccarderror['error']['message'] = $errorResponse['error']['message'];
                    $kyccarderror['error']['reason'] = 'InValid Pan No';
                    $kyccarderror['error']['type'] = '';
                    $searchkyc['statusCode'] = 201;
                    $searchkyc['message'] = $errorResponse['error']['message'];
                    if ($user->role_id == 1) {
                        $apiamster = ApiMaster::where('api_slug', $api_slug)->first();
                        $api_id = $apiamster->id;
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 201);
                        }
                        $panvalidation = DB::table('search')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'dob' => $dob,
                            'groupId' => isset($groupId) ? $groupId : null,
                            'checkId' => isset($checkId) ? $checkId : null,
                            'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                            'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                            'status' => 500,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 401, 'response' => $searchkyc['message']]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function initiatePayment($token)
    {
        // return 'ok';
        // return $token;
        // return view('e-nach-payment.initiate-payment');
        $api_id = null;
        $verifyAccessToken = $this->verifyAccessToken($token);
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $access_token = $token;
        $user = User::where('access_token', $token)->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'enach')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                return view('e-nach-payment.initiate-payment', compact('access_token'));
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }


    }

    public function initiateEnachSamelessPayment($token)
    {
        // return 'ok';
        // return $token;
        // return view('e-nach-payment.initiate-payment');
        $api_id = null;
        $verifyAccessToken = $this->verifyAccessToken($token);
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $access_token = $token;
        $user = User::where('access_token', $token)->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'enach')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                return view('enach_auto_shameless.initiate_enach_payment', compact('access_token'));
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }


    }

    public function initiatePaymentProcess($token)
    {
        // return 'ok';
        //  return view('e-nach-payment.initiate-payment');
        // return $token;
        $api_id = null;
        $verifyAccessToken = $this->verifyAccessToken($token);
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $access_token = $token;
        $user = User::where('access_token', $token)->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'payment')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                return view('payment.initiate-payment', compact('access_token'));
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }


    }

    public function failurePayment($token)
    {
        return $token;
        $e_nach_success_initiate_payment_getway = DB::table('e_nach_initiate_payment_gateway')->where('txnid', $request->input('txnid'))->update([
            'status' => $request->input('status'),
            'status_code' => 200,
            'card_type' => $request->input('card_type'),
            'remark' => $request->input('error'),
            'net_amount_debit' => $request->input('net_amount_debit'),
            'easepayid' => $request->input('easepayid'),
            'name_on_card' => $request->input('name_on_card'),
            'payment_source' => $request->input('payment_source'),
            'created_at' => Carbon::now(),
            'updated_at' => Carbon::now(),

        ]);
        $transactionId = $request->input('txnid');
        return view('e-nach-payment.failure', compact('transactionId'));
    }
    //  public function equifaxdevelopment(Request $request){
    //     $validator = Validator::make($request->all(), [ 
    //         'phone_number' => 'required|regex:/^[0-9]{10}$/',
    //     ]);
    //     if ($validator->fails()) {
    //         return response()->json([
    //             'status' => 'Forbidden',
    //             'errors' => $validator->errors(),
    //         ], 403);
    //     }

    //     $sql = DB::table('equifax_pdf_request')->insert([
    //         'firstName' => $request->fname,
    //         'lastName' => $request->lname,
    //         'contactNo'=> $request->phone_number,
    //         'idValue'=> $request->id_value,
    //         'created_at'=>date('Y-m-d H:i:s')
    //     ]);
    //     $api_id = null;
    //     // $validator = Validator::make($request -> all(),[
    //     //     // 'FirstName' => ['required','string','max:255'],
    //     //     // 'LastName' => ['required','string','max:255'],
    //     //     'ContactNo' => ['required','string','max:255'],
    //     //     'IDValue' => ['required'],
    //     // ]);
    //     $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
    //     $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
    //     $pan_num = $request->pan_num ? $request->pan_num : null;
    //     $voter_id = $request->voter_num ? $request->voter_num : null;
    //     $passport = $request->passport_num ? $request->passport_num : null;
    //     $driving_licence = $request->driving_num ? $request->driving_num : null;

    //     // if($validator -> fails())
    //     //     return response() -> json(['Errors' => $validator -> errors(),
    //     //                                 'statusCode' => '404']);
    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     $balance = $user->wallet_amount;

    //         if($user->role_id==1) {
    //             $apiamster = ApiMaster::where('api_slug','equifaxwithpdf')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //         }
    //         $uname = $user->name;
    //         // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
    //         $arr = explode(' ', trim($uname));
    //         $usr = '';
    //         $substr = '';
    //         foreach($arr as $array){
    //             $substr = substr($array, 0, 1);
    //             $usr = $usr.$substr;
    //         }
    //         $recordId = sprintf("%04d", $record_id->id);
    //         $CustRefField = "DB-".strtoupper($usr).Carbon::now()->format('y').Carbon::now()->format('m').$recordId;
    //         $body = 
    //             [
    //                 "RequestHeader"=> [
    //                     "CustomerId"=>"7656",
    //                     "UserId"=>"STS_LOANTA",
    //                     "Password"=>"W3#QeicsB",
    //                     "MemberNumber"=>"027FP27964",
    //                     "SecurityCode"=>"6IT",
    //                     "ProductCode"=> [
    //                         "PCRLT"
    //                     ],
    //                     "CustRefField" => $CustRefField
    //                 ],
    //                 "RequestBody"=>[
    //                     "InquiryPurpose"=>"16",
    //                     "FirstName"=>$request->fname,
    //                     "MiddleName"=>"",
    //                     "LastName"=>$request->lname,
    //                     "DOB"=>$request->dob,
    //                     "InquiryPhones"=>[
    //                         [
    //                             "seq"=>"1",
    //                             "Number"=>$request->phone_number,
    //                             "PhoneType"=>[
    //                                 "M"
    //                             ]
    //                         ]
    //                     ],
    //                     "IDDetails"=>[
    //                         [
    //                             "seq"=>"1",
    //                             "IDType"=>"t",
    //                             "IDValue"=>$request->pan_num,
    //                             "Source"=> "Inquiry"
    //                         ]
    //                     ]
    //                 ],
    //                 "Score"=>[
    //                     [
    //                         "Type"=>"ERS",
    //                         "Version"=>"3.1"
    //                     ]
    //                 ]
    //             ];    
    //         $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //         if($updateHitCount || $user->role_id==0){
    //           if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type=="role_postpaid") {
    //             try
    //             {      
    //                 $client = new Client();
    //                 $res = $client -> post($this -> equifax_url,['json' => $body]);
    //                 $equifax = json_decode($res -> getBody(),true);
    //                 if (isset($equifax['CCRResponse']['CIRReportDataLst']) && empty($equifax['CCRResponse']['CIRReportDataLst'][0]['Error'])){
    //                     $myarray = [];
    //                     if(!empty($equifax['CCRResponse']['CIRReportDataLst']))
    //                     {
    //                         foreach ($equifax['CCRResponse']['CIRReportDataLst'] as $key => $value) {
    //                             if (isset($value['InquiryResponseHeader']['ReportOrderNO'])) {
    //                                 $orderNo = $value['InquiryResponseHeader']['ReportOrderNO'];
    //                             } else {
    //                                 $orderNo = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'])) {
    //                                 $consumerName = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'];
    //                             } else {
    //                                 $consumerName = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'])) {
    //                                 $DOB = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'];
    //                             } else {
    //                                 $DOB = '';
    //                             }

    //                             if (isset($value['InquiryResponseHeader']['Date'])) {
    //                                 $date = $value['InquiryResponseHeader']['Date'];
    //                             } else {
    //                                 $date = '';
    //                             }

    //                             if (isset($value['InquiryResponseHeader']['Time'])) {
    //                                 $time = $value['InquiryResponseHeader']['Time'];
    //                             } else {
    //                                 $time = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Age']['Age'])) {
    //                                 $age = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Age']['Age'];
    //                             } else {
    //                                 $age = '';
    //                             }

    //                             if ($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Gender']) {
    //                                 $gender = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Gender'];
    //                             } else {
    //                                 $gender = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['PANId'])) {
    //                                 foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['PANId'] as $key1 => $value1) {
    //                                     if (isset($value1['IdNumber'])) {
    //                                         $PAN = $value1['IdNumber'];
    //                                     } else {
    //                                         $PAN = '';
    //                                     }
    //                                 }
    //                             } else {
    //                                 $PAN = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['NationalIDCard'])) {
    //                                 foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['NationalIDCard'] as $key1 => $value1) {
    //                                     if (isset($value1['IdNumber'])) {
    //                                         $NationalIDCard = $value1['IdNumber'];
    //                                     } else {
    //                                         $NationalIDCard = '';
    //                                     }
    //                                 }
    //                             } else {
    //                                 $NationalIDCard = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'])) {
    //                                 foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'] as $key1 => $value1) {
    //                                     if (isset($value1['IdNumber'])) {
    //                                         $VoterID = $value1['IdNumber'];
    //                                     } else {
    //                                         $VoterID = '';
    //                                     }
    //                                 }
    //                             } else {
    //                                 $VoterID = '';
    //                             }
    //                             // foreach($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'] as $key1 => $value1)
    //                             //     if(isset($value1['IdNumber']))
    //                             //         $VoterID = $value1['IdNumber'];
    //                             //     else
    //                             //         $VoterID = "";

    //                             foreach ($value['InquiryRequestInfo']['InquiryPhones'] as $key2 => $value2) {
    //                                 if (isset($value2['Number'])) {
    //                                     $Number = $value2['Number'];
    //                                 } else {
    //                                     $Number = '';
    //                                 }
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['AddressInfo'])) {
    //                                 $consumer_address = $value['CIRReportData']['IDAndContactInfo']['AddressInfo'];

    //                             } else {
    //                                 $consumer_address = '';
    //                             }

    //                             $score_array = $value['CIRReportData']['ScoreDetails'];
    //                             if (count($score_array) > 0) {
    //                                 // foreach($score_array as $scoredetails)
    //                                 // {
    //                                 $score_details = $score_array;
    //                                 // if(isset($scoredetails['Value'])){
    //                                 //     $score = $scoredetails['Value'];
    //                                 //     $score_version = $scoredetails['Version'];
    //                                 // }else{
    //                                 //     $score = "";
    //                                 //     $score_version = "";
    //                                 // }
    //                                 // if(isset($scoredetails['ScoringElements']))
    //                                 //     $scoringelements = $scoredetails['ScoringElements'];
    //                                 // else
    //                                 //     $scoringelements = "";

    //                                 // }
    //                             } else {
    //                                 $score_details = [];
    //                             }

    //                             if (isset($value['CIRReportData']['RecentActivities'])) {
    //                                 $enquiry_summary = $value['CIRReportData']['RecentActivities'];
    //                             } else {
    //                                 $enquiry_summary = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfAccounts'])) {
    //                                 $numberofAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfAccounts'];
    //                             } else {
    //                                 $numberofAccounts = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalBalanceAmount'])) {
    //                                 $TotalBalanceAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalBalanceAmount'];
    //                             } else {
    //                                 $TotalBalanceAmount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalPastDue'])) {
    //                                 $TotalPastAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalPastDue'];
    //                             } else {
    //                                 $TotalPastAmount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['RecentAccount'])) {
    //                                 $recent_account = $value['CIRReportData']['RetailAccountsSummary']['RecentAccount'];
    //                             } else {
    //                                 $recent_account = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['OldestAccount'])) {
    //                                 $oldest_account = $value['CIRReportData']['RetailAccountsSummary']['OldestAccount'];
    //                             } else {
    //                                 $oldest_account = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfActiveAccounts'])) {
    //                                 $numberOfOpenAccount = $value['CIRReportData']['RetailAccountsSummary']['NoOfActiveAccounts'];
    //                             } else {
    //                                 $numberOfOpenAccount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfPastDueAccounts'])) {
    //                                 $numberOfPastDueAccount = $value['CIRReportData']['RetailAccountsSummary']['NoOfPastDueAccounts'];
    //                             } else {
    //                                 $numberOfPastDueAccount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalHighCredit'])) {
    //                                 $TotalHighCredit = $value['CIRReportData']['RetailAccountsSummary']['TotalHighCredit'];
    //                             } else {
    //                                 $TotalHighCredit = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalCreditLimit'])) {
    //                                 $TotalCreditLimit = $value['CIRReportData']['RetailAccountsSummary']['TotalCreditLimit'];
    //                             } else {
    //                                 $TotalCreditLimit = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfWriteOffs'])) {
    //                                 $NoOfWriteOffs = $value['CIRReportData']['RetailAccountsSummary']['NoOfWriteOffs'];
    //                             } else {
    //                                 $NoOfWriteOffs = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'])) {
    //                                 $TotalSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'];
    //                             } else {
    //                                 $TotalSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'];
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestCredit'])) {
    //                                 $SingleHighestCredit = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestCredit'];
    //                             } else {
    //                                 $SingleHighestCredit = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'])) {
    //                                 $NoOfZeroBalanceAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'];
    //                             } else {
    //                                 $NoOfZeroBalanceAccounts = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalMonthlyPaymentAmount'])) {
    //                                 $TotalMonthlyPaymentAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalMonthlyPaymentAmount'];
    //                             } else {
    //                                 $TotalMonthlyPaymentAmount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'])) {
    //                                 $NoOfZeroBalanceAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'];
    //                             } else {
    //                                 $NoOfZeroBalanceAccounts = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestBalance'])) {
    //                                 $SingleHighestBalance = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestBalance'];
    //                             } else {
    //                                 $SingleHighestBalance = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestSanctionAmount'])) {
    //                                 $SingleHighestSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestSanctionAmount'];
    //                             } else {
    //                                 $SingleHighestSanctionAmount = '';
    //                             }

    //                             //RETAIL ACCOUNT DETAILS

    //                             $RetailAccountDetails = $value['CIRReportData']['RetailAccountDetails'];

    //                             //Enquiries

    //                             if (isset($value['CIRReportData']['Enquiries'])) {
    //                                 $enquiries = $value['CIRReportData']['Enquiries'];
    //                             } else {
    //                                 $enquiries = '';
    //                             }

    //                             //Enquiry Summary
    //                             if (isset($value['CIRReportData']['EnquirySummary']['Purpose'])) {
    //                                 $Purpose = $value['CIRReportData']['EnquirySummary']['Purpose'];
    //                             } else {
    //                                 $Purpose = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Total'])) {
    //                                 $Total = $value['CIRReportData']['EnquirySummary']['Total'];
    //                             } else {
    //                                 $Total = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Past30Days'])) {
    //                                 $Past30Days = $value['CIRReportData']['EnquirySummary']['Past30Days'];
    //                             } else {
    //                                 $Past30Days = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Past12Months'])) {
    //                                 $Past12Months = $value['CIRReportData']['EnquirySummary']['Past12Months'];
    //                             } else {
    //                                 $Past12Months = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Past24Months'])) {
    //                                 $Past24Months = $value['CIRReportData']['EnquirySummary']['Past24Months'];
    //                             } else {
    //                                 $Past24Months = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Recent'])) {
    //                                 $Recent = $value['CIRReportData']['EnquirySummary']['Recent'];
    //                             } else {
    //                                 $Recent = '';
    //                             }

    //                             // foreach($RetailAccountDetails as $RetailAccountDetail)
    //                             // {
    //                             //     $AccountNumber = $RetailAccountDetail['AccountNumber'];
    //                             //     $Balance = $RetailAccountDetail['Balance'];
    //                             //     $Open = $RetailAccountDetail['Open'];
    //                             //     $DateReported = $RetailAccountDetail['DateReported'];
    //                             //     $Institution = $RetailAccountDetail['Institution'];
    //                             //     $PastDueAmount = $RetailAccountDetail['PastDueAmount'];
    //                             //     //$InterestRate = $RetailAccountDetail['AccountNumber']);
    //                             //     $DateOpened = $RetailAccountDetail['DateOpened'];
    //                             //     $Type = $RetailAccountDetail['AccountType'];
    //                             //     $LastPaymentDate = $RetailAccountDetail['LastPaymentDate'];
    //                             //     $LastPaymentDue = $RetailAccountDetail['LastPaymentDate'];
    //                             //     //$DateClosed = $RetailAccountDetail['AccountNumber']);
    //                             //     $OwnershipType = $RetailAccountDetail['source'];
    //                             //     //$WriteOffAmount = $RetailAccountDetail['AccountNumber']);
    //                             //     $SanctionAmount = $RetailAccountDetail['SanctionAmount'];

    //                             // }

    //                             //Personal Information
    //                            // $myarray['CustRefField'] = $CustRefField;
    //                             $myarray['orderNo'] = $orderNo;
    //                             $myarray['consumerName'] = $consumerName;
    //                             $myarray['PAN'] = $PAN;
    //                             $myarray['VoterID'] = $VoterID;
    //                             $myarray['Number'] = $Number;
    //                             $myarray['DOB'] = $DOB;
    //                             $myarray['age'] = $age;
    //                             $myarray['gender'] = $gender;
    //                             $myarray['NationalIDCard'] = $NationalIDCard;
    //                             // $myarray['aadhar'] = $aadhar_num;
    //                             //Address
    //                             $myarray['consumer_address'] = $consumer_address;

    //                             //Score
    //                             // $myarray['score'] = $score;
    //                             // $myarray['score_version'] = $score_version;
    //                             // $myarray['scoringelements'] = $scoringelements;
    //                             $myarray['score_details'] = $score_details;

    //                             //date and time
    //                             $myarray['date'] = $date;
    //                             $myarray['time'] = $time;
    //                             $myarray['enquiries'] = $enquiries;
    //                             $myarray['enquiry_summary'] = $enquiry_summary;

    //                             //Summary
    //                             $myarray['numberofAccounts'] = $numberofAccounts;
    //                             $myarray['TotalBalanceAmount'] = $TotalBalanceAmount;
    //                             $myarray['TotalPastAmount'] = $TotalPastAmount;
    //                             $myarray['recentAccount'] = $recent_account;
    //                             $myarray['oldestAccount'] = $oldest_account;
    //                             $myarray['numberOfOpenAccount'] = $numberOfOpenAccount;
    //                             $myarray['numberOfPastDueAccount'] = $numberOfPastDueAccount;
    //                             $myarray['TotalHighCredit'] = $TotalHighCredit;
    //                             $myarray['TotalCreditLimit'] = $TotalCreditLimit;
    //                             $myarray['NoOfWriteOffs'] = $NoOfWriteOffs;
    //                             $myarray['TotalSanctionAmount'] = $TotalSanctionAmount;
    //                             $myarray['SingleHighestCredit'] = $SingleHighestCredit;
    //                             $myarray['NoOfZeroBalanceAccounts'] = $NoOfZeroBalanceAccounts;
    //                             $myarray['TotalMonthlyPaymentAmount'] = $TotalMonthlyPaymentAmount;
    //                             $myarray['NoOfZeroBalanceAccounts'] = $NoOfZeroBalanceAccounts;
    //                             $myarray['SingleHighestBalance'] = $SingleHighestBalance;
    //                             $myarray['SingleHighestSanctionAmount'] = $SingleHighestSanctionAmount;
    //                             $myarray['RetailAccountDetails'] = $RetailAccountDetails;

    //                             //Enquiry Summary
    //                             $myarray['Purpose'] = $Purpose;
    //                             $myarray['Total'] = $Total;
    //                             $myarray['Past30Days'] = $Past30Days;
    //                             $myarray['Past24Months'] = $Past24Months;
    //                             $myarray['Recent'] = $Recent;
    //                             $myarray['Past12Months'] = $Past12Months;
    //                             $myarray['CustRefField'] = '-';
    //                         }
    //                     }

    //                     $pdf = PDF::loadView('kyc.equifaxreportpdf', compact('myarray', 'equifax'))->setPaper('A4');
    //                     $euifax_pdf_content = $pdf->output();
    //                     $euifax_report_base64 = base64_encode($euifax_pdf_content);
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                         }
    //                     }
    //                     return response()->json(["data"=>$equifax,'statusCode' => '200']);
    //                   }
    //                 else{
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
    //                         }
    //                     }
    //                     return response()->json(['statusCode' =>102,"data"=>$equifax]);
    //                 }


    //             }
    //             catch(BadResponseException $e){
    //                 $statusCode = $e->getResponse()->getStatusCode();
    //                 if($statusCode == 500){
    //                     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                     if($user->role_id==1) {
    //                         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                     }
    //                 }else if($statusCode == 422){
    //                     $statusCode = 102;
    //                     $errorMessage = 'Verification Failed. Please enter valid details.';
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }else{
    //                     $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }
    //                 return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //             }
    //         }
    //         else{
    //             return response()->json(['statusCode'=>500, 'message'=>'Please recharge your wallet']);
    //         }
    //         }else{
    //             return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //         } 
    //         $equifaxstatus = $response['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'];
    //         // return $equifax;
    //         if($equifaxstatus > 0){
    //             return response() -> json(['data' => $response,'statusCode' => '200']);
    //         }
    //         else{
    //             // return response()->json(['statusCode'=>102, 'message'=>'Please enter valid details']);
    //             return response()->json(['statusCode'=>102, 'message'=>$response]);
    //         }
    // }
    public function equifaxdevelopment(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'phone_number' => 'required|regex:/^[0-9]{10}$/',
        ]);
        if ($validator->fails()) {
            return response()->json([
                'status' => 'Forbidden',
                'errors' => $validator->errors(),
            ], 403);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);
        }

        $sql = DB::table('equifax_pdf_request')->insert([
            'firstName' => $request->fname,
            'lastName' => $request->lname,
            'contactNo' => $request->phone_number,
            'idValue' => $request->id_value,
            'created_at' => date('Y-m-d H:i:s')
        ]);
        $api_id = null;
        // $validator = Validator::make($request -> all(),[
        //     // 'FirstName' => ['required','string','max:255'],
        //     // 'LastName' => ['required','string','max:255'],
        //     'ContactNo' => ['required','string','max:255'],
        //     'IDValue' => ['required'],
        // ]);
        $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
        $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
        $pan_num = $request->pan_num ? $request->pan_num : null;
        $voter_id = $request->voter_num ? $request->voter_num : null;
        $passport = $request->passport_num ? $request->passport_num : null;
        $driving_licence = $request->driving_num ? $request->driving_num : null;

        // if($validator -> fails())
        //     return response() -> json(['Errors' => $validator -> errors(),
        //                                 'statusCode' => '404']);
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        $balance = $user->wallet_amount;

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'equifaxwithpdf')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $uname = $user->name;
        // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
        $arr = explode(' ', trim($uname));
        $usr = '';
        $substr = '';
        foreach ($arr as $array) {
            $substr = substr($array, 0, 1);
            $usr = $usr . $substr;
        }
        $recordId = sprintf("%04d", $record_id->id);
        $CustRefField = "DB-" . strtoupper($usr) . Carbon::now()->format('y') . Carbon::now()->format('m') . $recordId;
        $body =
            [
                "InquiryPurpose" => "10",
                "TransactionAmount" => "",
                "FirstName" => $request->fname,
                "MiddleName" => "",
                "LastName" => $request->lname,
                "InquiryAddresses" => [
                    [
                        "seq" => "1",
                        "AddressType" => [
                            "H"
                        ],
                        "AddressLine1" => "",
                        "AddressLine2" => "",
                        "Locality" => "",
                        "City" => "",
                        "State" => "",
                        "Postal" => ""
                    ]
                ],
                "InquiryPhones"=>[
                    [
                        "seq"=>"16",
                        "Number"=>$request->phone_number,
                        "PhoneType"=>[
                            "M"
                        ]
                    ]
                ],
                "IDDetails" => [
                    [
                        "seq" => "1",
                        "IDType" => "T",
                        "IDValue" => $request->id_value
                    ]
                ],
                "DOB" => $request->dob
            ];
        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0bGFuZCIsImlhdCI6MTY5MTM4NDEzODczNH0.nHmNhb-NlFPziNE_-9iEGKTIVoiz5rM_lNVvPLvQLgU',
        ];
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $client = new Client();
                    $res = $client->post("https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score", ['headers' => $headers, 'json' => $body]);
                    $response = json_decode($res->getBody(), true);
                    if (isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) && $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] > 00) {
                        $myarray = [];
                        $equifax = null;
                        if (isset($response['data']['InquiryResponseHeader']) && isset($response['data']['CCRResponse'])) {
                            $equifax['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
                            $equifax['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                            $equifax['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
                            $equifax['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
                            $equifax['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
                            $equifax['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
                            $equifax['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
                            $equifax['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
                            $equifax['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
                            $equifax['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
                            $equifax['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                            $equifax['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                            $equifax['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                            $equifax['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                            $equifax['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                            $equifax['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                            $equifax['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                            $equifax['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                            $equifax['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
                            $equifax['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['Score'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Score']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Score'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] : null;
                            $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] : null;
                            if (!empty($equifax['CCRResponse']['CIRReportDataLst'])) {
                                foreach ($equifax['CCRResponse']['CIRReportDataLst'] as $key => $value) {
                                    if (isset($value['InquiryResponseHeader']['ReportOrderNO'])) {
                                        $orderNo = $value['InquiryResponseHeader']['ReportOrderNO'];
                                    } else {
                                        $orderNo = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'])) {
                                        $consumerName = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'];
                                    } else {
                                        $consumerName = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'])) {
                                        $DOB = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'];
                                    } else {
                                        $DOB = '';
                                    }

                                    if (isset($value['InquiryResponseHeader']['Date'])) {
                                        $date = $value['InquiryResponseHeader']['Date'];
                                    } else {
                                        $date = '';
                                    }

                                    if (isset($value['InquiryResponseHeader']['Time'])) {
                                        $time = $value['InquiryResponseHeader']['Time'];
                                    } else {
                                        $time = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Age']['Age'])) {
                                        $age = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Age']['Age'];
                                    } else {
                                        $age = '';
                                    }

                                    if ($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Gender']) {
                                        $gender = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Gender'];
                                    } else {
                                        $gender = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['PANId'])) {
                                        foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['PANId'] as $key1 => $value1) {
                                            if (isset($value1['IdNumber'])) {
                                                $PAN = $value1['IdNumber'];
                                            } else {
                                                $PAN = '';
                                            }
                                        }
                                    } else {
                                        $PAN = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['NationalIDCard'])) {
                                        foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['NationalIDCard'] as $key1 => $value1) {
                                            if (isset($value1['IdNumber'])) {
                                                $NationalIDCard = $value1['IdNumber'];
                                            } else {
                                                $NationalIDCard = '';
                                            }
                                        }
                                    } else {
                                        $NationalIDCard = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'])) {
                                        foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'] as $key1 => $value1) {
                                            if (isset($value1['IdNumber'])) {
                                                $VoterID = $value1['IdNumber'];
                                            } else {
                                                $VoterID = '';
                                            }
                                        }
                                    } else {
                                        $VoterID = '';
                                    }
                                    // foreach($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'] as $key1 => $value1)
                                    //     if(isset($value1['IdNumber']))
                                    //         $VoterID = $value1['IdNumber'];
                                    //     else
                                    //         $VoterID = "";

                                    foreach ($value['InquiryRequestInfo']['InquiryPhones'] as $key2 => $value2) {
                                        if (isset($value2['Number'])) {
                                            $Number = $value2['Number'];
                                        } else {
                                            $Number = '';
                                        }
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['AddressInfo'])) {
                                        $consumer_address = $value['CIRReportData']['IDAndContactInfo']['AddressInfo'];

                                    } else {
                                        $consumer_address = '';
                                    }

                                    $score_array = $value['CIRReportData']['ScoreDetails'];
                                    if (count($score_array) > 0) {
                                        // foreach($score_array as $scoredetails)
                                        // {
                                        $score_details = $score_array;
                                        // if(isset($scoredetails['Value'])){
                                        //     $score = $scoredetails['Value'];
                                        //     $score_version = $scoredetails['Version'];
                                        // }else{
                                        //     $score = "";
                                        //     $score_version = "";
                                        // }
                                        // if(isset($scoredetails['ScoringElements']))
                                        //     $scoringelements = $scoredetails['ScoringElements'];
                                        // else
                                        //     $scoringelements = "";

                                        // }
                                    } else {
                                        $score_details = [];
                                    }

                                    if (isset($value['CIRReportData']['RecentActivities'])) {
                                        $enquiry_summary = $value['CIRReportData']['RecentActivities'];
                                    } else {
                                        $enquiry_summary = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfAccounts'])) {
                                        $numberofAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfAccounts'];
                                    } else {
                                        $numberofAccounts = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalBalanceAmount'])) {
                                        $TotalBalanceAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalBalanceAmount'];
                                    } else {
                                        $TotalBalanceAmount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalPastDue'])) {
                                        $TotalPastAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalPastDue'];
                                    } else {
                                        $TotalPastAmount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['RecentAccount'])) {
                                        $recent_account = $value['CIRReportData']['RetailAccountsSummary']['RecentAccount'];
                                    } else {
                                        $recent_account = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['OldestAccount'])) {
                                        $oldest_account = $value['CIRReportData']['RetailAccountsSummary']['OldestAccount'];
                                    } else {
                                        $oldest_account = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfActiveAccounts'])) {
                                        $numberOfOpenAccount = $value['CIRReportData']['RetailAccountsSummary']['NoOfActiveAccounts'];
                                    } else {
                                        $numberOfOpenAccount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfPastDueAccounts'])) {
                                        $numberOfPastDueAccount = $value['CIRReportData']['RetailAccountsSummary']['NoOfPastDueAccounts'];
                                    } else {
                                        $numberOfPastDueAccount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalHighCredit'])) {
                                        $TotalHighCredit = $value['CIRReportData']['RetailAccountsSummary']['TotalHighCredit'];
                                    } else {
                                        $TotalHighCredit = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalCreditLimit'])) {
                                        $TotalCreditLimit = $value['CIRReportData']['RetailAccountsSummary']['TotalCreditLimit'];
                                    } else {
                                        $TotalCreditLimit = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfWriteOffs'])) {
                                        $NoOfWriteOffs = $value['CIRReportData']['RetailAccountsSummary']['NoOfWriteOffs'];
                                    } else {
                                        $NoOfWriteOffs = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'])) {
                                        $TotalSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'];
                                    } else {
                                        $TotalSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'];
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestCredit'])) {
                                        $SingleHighestCredit = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestCredit'];
                                    } else {
                                        $SingleHighestCredit = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'])) {
                                        $NoOfZeroBalanceAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'];
                                    } else {
                                        $NoOfZeroBalanceAccounts = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalMonthlyPaymentAmount'])) {
                                        $TotalMonthlyPaymentAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalMonthlyPaymentAmount'];
                                    } else {
                                        $TotalMonthlyPaymentAmount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'])) {
                                        $NoOfZeroBalanceAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'];
                                    } else {
                                        $NoOfZeroBalanceAccounts = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestBalance'])) {
                                        $SingleHighestBalance = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestBalance'];
                                    } else {
                                        $SingleHighestBalance = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestSanctionAmount'])) {
                                        $SingleHighestSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestSanctionAmount'];
                                    } else {
                                        $SingleHighestSanctionAmount = '';
                                    }

                                    //RETAIL ACCOUNT DETAILS

                                    $RetailAccountDetails = $value['CIRReportData']['RetailAccountDetails'];

                                    //Enquiries

                                    if (isset($value['CIRReportData']['Enquiries'])) {
                                        $enquiries = $value['CIRReportData']['Enquiries'];
                                    } else {
                                        $enquiries = '';
                                    }

                                    //Enquiry Summary
                                    if (isset($value['CIRReportData']['EnquirySummary']['Purpose'])) {
                                        $Purpose = $value['CIRReportData']['EnquirySummary']['Purpose'];
                                    } else {
                                        $Purpose = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Total'])) {
                                        $Total = $value['CIRReportData']['EnquirySummary']['Total'];
                                    } else {
                                        $Total = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Past30Days'])) {
                                        $Past30Days = $value['CIRReportData']['EnquirySummary']['Past30Days'];
                                    } else {
                                        $Past30Days = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Past12Months'])) {
                                        $Past12Months = $value['CIRReportData']['EnquirySummary']['Past12Months'];
                                    } else {
                                        $Past12Months = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Past24Months'])) {
                                        $Past24Months = $value['CIRReportData']['EnquirySummary']['Past24Months'];
                                    } else {
                                        $Past24Months = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Recent'])) {
                                        $Recent = $value['CIRReportData']['EnquirySummary']['Recent'];
                                    } else {
                                        $Recent = '';
                                    }

                                    // foreach($RetailAccountDetails as $RetailAccountDetail)
                                    // {
                                    //     $AccountNumber = $RetailAccountDetail['AccountNumber'];
                                    //     $Balance = $RetailAccountDetail['Balance'];
                                    //     $Open = $RetailAccountDetail['Open'];
                                    //     $DateReported = $RetailAccountDetail['DateReported'];
                                    //     $Institution = $RetailAccountDetail['Institution'];
                                    //     $PastDueAmount = $RetailAccountDetail['PastDueAmount'];
                                    //     //$InterestRate = $RetailAccountDetail['AccountNumber']);
                                    //     $DateOpened = $RetailAccountDetail['DateOpened'];
                                    //     $Type = $RetailAccountDetail['AccountType'];
                                    //     $LastPaymentDate = $RetailAccountDetail['LastPaymentDate'];
                                    //     $LastPaymentDue = $RetailAccountDetail['LastPaymentDate'];
                                    //     //$DateClosed = $RetailAccountDetail['AccountNumber']);
                                    //     $OwnershipType = $RetailAccountDetail['source'];
                                    //     //$WriteOffAmount = $RetailAccountDetail['AccountNumber']);
                                    //     $SanctionAmount = $RetailAccountDetail['SanctionAmount'];

                                    // }

                                    //Personal Information
                                    // $myarray['CustRefField'] = $CustRefField;
                                    $myarray['orderNo'] = $orderNo;
                                    $myarray['consumerName'] = $consumerName;
                                    $myarray['PAN'] = $PAN;
                                    $myarray['VoterID'] = $VoterID;
                                    $myarray['Number'] = $Number;
                                    $myarray['DOB'] = $DOB;
                                    $myarray['age'] = $age;
                                    $myarray['gender'] = $gender;
                                    $myarray['NationalIDCard'] = $NationalIDCard;
                                    // $myarray['aadhar'] = $aadhar_num;
                                    //Address
                                    $myarray['consumer_address'] = $consumer_address;

                                    //Score
                                    // $myarray['score'] = $score;
                                    // $myarray['score_version'] = $score_version;
                                    // $myarray['scoringelements'] = $scoringelements;
                                    $myarray['score_details'] = $score_details;

                                    //date and time
                                    $myarray['date'] = $date;
                                    $myarray['time'] = $time;
                                    $myarray['enquiries'] = $enquiries;
                                    $myarray['enquiry_summary'] = $enquiry_summary;

                                    //Summary
                                    $myarray['numberofAccounts'] = $numberofAccounts;
                                    $myarray['TotalBalanceAmount'] = $TotalBalanceAmount;
                                    $myarray['TotalPastAmount'] = $TotalPastAmount;
                                    $myarray['recentAccount'] = $recent_account;
                                    $myarray['oldestAccount'] = $oldest_account;
                                    $myarray['numberOfOpenAccount'] = $numberOfOpenAccount;
                                    $myarray['numberOfPastDueAccount'] = $numberOfPastDueAccount;
                                    $myarray['TotalHighCredit'] = $TotalHighCredit;
                                    $myarray['TotalCreditLimit'] = $TotalCreditLimit;
                                    $myarray['NoOfWriteOffs'] = $NoOfWriteOffs;
                                    $myarray['TotalSanctionAmount'] = $TotalSanctionAmount;
                                    $myarray['SingleHighestCredit'] = $SingleHighestCredit;
                                    $myarray['NoOfZeroBalanceAccounts'] = $NoOfZeroBalanceAccounts;
                                    $myarray['TotalMonthlyPaymentAmount'] = $TotalMonthlyPaymentAmount;
                                    $myarray['NoOfZeroBalanceAccounts'] = $NoOfZeroBalanceAccounts;
                                    $myarray['SingleHighestBalance'] = $SingleHighestBalance;
                                    $myarray['SingleHighestSanctionAmount'] = $SingleHighestSanctionAmount;
                                    $myarray['RetailAccountDetails'] = $RetailAccountDetails;

                                    //Enquiry Summary
                                    $myarray['Purpose'] = $Purpose;
                                    $myarray['Total'] = $Total;
                                    $myarray['Past30Days'] = $Past30Days;
                                    $myarray['Past24Months'] = $Past24Months;
                                    $myarray['Recent'] = $Recent;
                                    $myarray['Past12Months'] = $Past12Months;
                                    $myarray['CustRefField'] = '-';
                                }
                            }

                            $pdf = PDF::loadView('kyc.equifaxreportpdf', compact('myarray', 'equifax'))->setPaper('A4');
                            $euifax_pdf_content = $pdf->output();
                            $euifax_report_base64 = base64_encode($euifax_pdf_content);
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                            }
                            return response()->json(["data" => $equifax, 'statusCode' => '200']);
                        }
                    } else {

                        $equifaxResponseConsumer = null;
                        $equifaxResponseConsumer['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
                        $equifaxResponseConsumer['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                        $equifaxResponseConsumer['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
                        $equifaxResponseConsumer['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
                        $equifaxResponseConsumer['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
                        $equifaxResponseConsumer['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
                        $equifaxResponseConsumer['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
                        $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
                        $equifaxResponseConsumer['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
                        $equifaxResponseConsumer['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
                        $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                        $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                        $equifaxResponseConsumer['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                        $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                        $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                        $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                        $equifaxResponseConsumer['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                        $equifaxResponseConsumer['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                        $equifaxResponseConsumer['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
                        $equifaxResponseConsumer['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
                        $equifaxResponseConsumer['CCRResponse']['CIRReportDataLst'][0]['Error'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Error']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Error'] : null;

                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful.', 200);
                            }
                        }
                        return response()->json(['statusCode' => 102, 'message' => $equifaxResponseConsumer]);
                    }


                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

    }
    // public function equifaxwithpdf(Request $request){
    //     $validator = Validator::make($request->all(), [ 
    //         'phone_number' => 'required|regex:/^[0-9]{10}$/',
    //     ]);
    //     if ($validator->fails()) {
    //         return response()->json([
    //             'status' => 'Forbidden',
    //             'errors' => $validator->errors(),
    //         ], 403);
    //     }

    //     $sql = DB::table('equifax_pdf_request')->insert([
    //         'firstName' => $request->fname,
    //         'lastName' => $request->lname,
    //         'contactNo'=> $request->phone_number,
    //         'idValue'=> $request->id_value,
    //         'created_at'=>date('Y-m-d H:i:s')
    //     ]);
    //     $api_id = null;
    //     // $validator = Validator::make($request -> all(),[
    //     //     // 'FirstName' => ['required','string','max:255'],
    //     //     // 'LastName' => ['required','string','max:255'],
    //     //     'ContactNo' => ['required','string','max:255'],
    //     //     'IDValue' => ['required'],
    //     // ]);
    //     $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
    //     $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
    //     $pan_num = $request->pan_num ? $request->pan_num : null;
    //     $voter_id = $request->voter_num ? $request->voter_num : null;
    //     $passport = $request->passport_num ? $request->passport_num : null;
    //     $driving_licence = $request->driving_num ? $request->driving_num : null;

    //     // if($validator -> fails())
    //     //     return response() -> json(['Errors' => $validator -> errors(),
    //     //                                 'statusCode' => '404']);
    //     $user = User::where('access_token',$request->header('AccessToken'))->first();
    //     $balance = $user->wallet_amount;
    //    if(($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
    //         if($user->role_id==1) {
    //             $apiamster = ApiMaster::where('api_slug','equifaxwithpdf')->first();
    //         if($apiamster)
    //             $api_id = $apiamster->id;
    //         }
    //         $uname = $user->name;
    //         // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
    //         $arr = explode(' ', trim($uname));
    //         $usr = '';
    //         $substr = '';
    //         foreach($arr as $array){
    //             $substr = substr($array, 0, 1);
    //             $usr = $usr.$substr;
    //         }
    //         $recordId = sprintf("%04d", $record_id->id);
    //         $CustRefField = "DB-".strtoupper($usr).Carbon::now()->format('y').Carbon::now()->format('m').$recordId;
    //         $body = 
    //             [
    //                 "RequestHeader"=> [
    //                     "CustomerId"=>"7656",
    //                     "UserId"=>"STS_LOANTA",
    //                     "Password"=>"W3#QeicsB",
    //                     "MemberNumber"=>"027FP27964",
    //                     "SecurityCode"=>"6IT",
    //                     "ProductCode"=> [
    //                         "PCRLT"
    //                     ],
    //                     "CustRefField" => $CustRefField
    //                 ],
    //                 "RequestBody"=>[
    //                     "InquiryPurpose"=>"16",
    //                     "FirstName"=>$request->fname,
    //                     "MiddleName"=>"",
    //                     "LastName"=>$request->lname,
    //                     "DOB"=>$request->dob,
    //                     "InquiryPhones"=>[
    //                         [
    //                             "seq"=>"1",
    //                             "Number"=>$request->phone_number,
    //                             "PhoneType"=>[
    //                                 "M"
    //                             ]
    //                         ]
    //                     ],
    //                     "IDDetails"=>[
    //                         [
    //                             "seq"=>"1",
    //                             "IDType"=>"t",
    //                             "IDValue"=>$request->pan_num,
    //                             "Source"=> "Inquiry"
    //                         ]
    //                     ]
    //                 ],
    //                 "Score"=>[
    //                     [
    //                         "Type"=>"ERS",
    //                         "Version"=>"3.1"
    //                     ]
    //                 ]
    //             ];    
    //         $updateHitCount = UserSchemeMaster::where('user_id',$user->id)->where('api_id',$api_id)->orderBy('id', 'desc')->first();
    //         if($updateHitCount || $user->role_id==0){
    //              if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type=="role_postpaid") {
    //             try
    //             {      
    //                 $client = new Client();
    //                 $res = $client -> post($this -> equifax_url,['json' => $body]);
    //                 $equifax = json_decode($res->getBody(),true);
    //                 if (isset($equifax['CCRResponse']['CIRReportDataLst']) && empty($equifax['CCRResponse']['CIRReportDataLst'][0]['Error'])) {
    //                     $myarray = [];
    //                     if(!empty($equifax['CCRResponse']['CIRReportDataLst']))
    //                     {
    //                         foreach ($equifax['CCRResponse']['CIRReportDataLst'] as $key => $value) {
    //                             if (isset($value['InquiryResponseHeader']['ReportOrderNO'])) {
    //                                 $orderNo = $value['InquiryResponseHeader']['ReportOrderNO'];
    //                             } else {
    //                                 $orderNo = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'])) {
    //                                 $consumerName = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'];
    //                             } else {
    //                                 $consumerName = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'])) {
    //                                 $DOB = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'];
    //                             } else {
    //                                 $DOB = '';
    //                             }

    //                             if (isset($value['InquiryResponseHeader']['Date'])) {
    //                                 $date = $value['InquiryResponseHeader']['Date'];
    //                             } else {
    //                                 $date = '';
    //                             }

    //                             if (isset($value['InquiryResponseHeader']['Time'])) {
    //                                 $time = $value['InquiryResponseHeader']['Time'];
    //                             } else {
    //                                 $time = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Age']['Age'])) {
    //                                 $age = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Age']['Age'];
    //                             } else {
    //                                 $age = '';
    //                             }

    //                             if ($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Gender']) {
    //                                 $gender = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Gender'];
    //                             } else {
    //                                 $gender = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['PANId'])) {
    //                                 foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['PANId'] as $key1 => $value1) {
    //                                     if (isset($value1['IdNumber'])) {
    //                                         $PAN = $value1['IdNumber'];
    //                                     } else {
    //                                         $PAN = '';
    //                                     }
    //                                 }
    //                             } else {
    //                                 $PAN = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['NationalIDCard'])) {
    //                                 foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['NationalIDCard'] as $key1 => $value1) {
    //                                     if (isset($value1['IdNumber'])) {
    //                                         $NationalIDCard = $value1['IdNumber'];
    //                                     } else {
    //                                         $NationalIDCard = '';
    //                                     }
    //                                 }
    //                             } else {
    //                                 $NationalIDCard = '';
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'])) {
    //                                 foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'] as $key1 => $value1) {
    //                                     if (isset($value1['IdNumber'])) {
    //                                         $VoterID = $value1['IdNumber'];
    //                                     } else {
    //                                         $VoterID = '';
    //                                     }
    //                                 }
    //                             } else {
    //                                 $VoterID = '';
    //                             }
    //                             // foreach($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'] as $key1 => $value1)
    //                             //     if(isset($value1['IdNumber']))
    //                             //         $VoterID = $value1['IdNumber'];
    //                             //     else
    //                             //         $VoterID = "";

    //                             foreach ($value['InquiryRequestInfo']['InquiryPhones'] as $key2 => $value2) {
    //                                 if (isset($value2['Number'])) {
    //                                     $Number = $value2['Number'];
    //                                 } else {
    //                                     $Number = '';
    //                                 }
    //                             }

    //                             if (isset($value['CIRReportData']['IDAndContactInfo']['AddressInfo'])) {
    //                                 $consumer_address = $value['CIRReportData']['IDAndContactInfo']['AddressInfo'];

    //                             } else {
    //                                 $consumer_address = '';
    //                             }

    //                             $score_array = $value['CIRReportData']['ScoreDetails'];
    //                             if (count($score_array) > 0) {
    //                                 // foreach($score_array as $scoredetails)
    //                                 // {
    //                                 $score_details = $score_array;
    //                                 // if(isset($scoredetails['Value'])){
    //                                 //     $score = $scoredetails['Value'];
    //                                 //     $score_version = $scoredetails['Version'];
    //                                 // }else{
    //                                 //     $score = "";
    //                                 //     $score_version = "";
    //                                 // }
    //                                 // if(isset($scoredetails['ScoringElements']))
    //                                 //     $scoringelements = $scoredetails['ScoringElements'];
    //                                 // else
    //                                 //     $scoringelements = "";

    //                                 // }
    //                             } else {
    //                                 $score_details = [];
    //                             }

    //                             if (isset($value['CIRReportData']['RecentActivities'])) {
    //                                 $enquiry_summary = $value['CIRReportData']['RecentActivities'];
    //                             } else {
    //                                 $enquiry_summary = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfAccounts'])) {
    //                                 $numberofAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfAccounts'];
    //                             } else {
    //                                 $numberofAccounts = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalBalanceAmount'])) {
    //                                 $TotalBalanceAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalBalanceAmount'];
    //                             } else {
    //                                 $TotalBalanceAmount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalPastDue'])) {
    //                                 $TotalPastAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalPastDue'];
    //                             } else {
    //                                 $TotalPastAmount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['RecentAccount'])) {
    //                                 $recent_account = $value['CIRReportData']['RetailAccountsSummary']['RecentAccount'];
    //                             } else {
    //                                 $recent_account = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['OldestAccount'])) {
    //                                 $oldest_account = $value['CIRReportData']['RetailAccountsSummary']['OldestAccount'];
    //                             } else {
    //                                 $oldest_account = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfActiveAccounts'])) {
    //                                 $numberOfOpenAccount = $value['CIRReportData']['RetailAccountsSummary']['NoOfActiveAccounts'];
    //                             } else {
    //                                 $numberOfOpenAccount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfPastDueAccounts'])) {
    //                                 $numberOfPastDueAccount = $value['CIRReportData']['RetailAccountsSummary']['NoOfPastDueAccounts'];
    //                             } else {
    //                                 $numberOfPastDueAccount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalHighCredit'])) {
    //                                 $TotalHighCredit = $value['CIRReportData']['RetailAccountsSummary']['TotalHighCredit'];
    //                             } else {
    //                                 $TotalHighCredit = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalCreditLimit'])) {
    //                                 $TotalCreditLimit = $value['CIRReportData']['RetailAccountsSummary']['TotalCreditLimit'];
    //                             } else {
    //                                 $TotalCreditLimit = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfWriteOffs'])) {
    //                                 $NoOfWriteOffs = $value['CIRReportData']['RetailAccountsSummary']['NoOfWriteOffs'];
    //                             } else {
    //                                 $NoOfWriteOffs = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'])) {
    //                                 $TotalSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'];
    //                             } else {
    //                                 $TotalSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'];
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestCredit'])) {
    //                                 $SingleHighestCredit = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestCredit'];
    //                             } else {
    //                                 $SingleHighestCredit = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'])) {
    //                                 $NoOfZeroBalanceAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'];
    //                             } else {
    //                                 $NoOfZeroBalanceAccounts = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalMonthlyPaymentAmount'])) {
    //                                 $TotalMonthlyPaymentAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalMonthlyPaymentAmount'];
    //                             } else {
    //                                 $TotalMonthlyPaymentAmount = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'])) {
    //                                 $NoOfZeroBalanceAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'];
    //                             } else {
    //                                 $NoOfZeroBalanceAccounts = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestBalance'])) {
    //                                 $SingleHighestBalance = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestBalance'];
    //                             } else {
    //                                 $SingleHighestBalance = '';
    //                             }

    //                             if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestSanctionAmount'])) {
    //                                 $SingleHighestSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestSanctionAmount'];
    //                             } else {
    //                                 $SingleHighestSanctionAmount = '';
    //                             }

    //                             //RETAIL ACCOUNT DETAILS

    //                             $RetailAccountDetails = $value['CIRReportData']['RetailAccountDetails'];

    //                             //Enquiries

    //                             if (isset($value['CIRReportData']['Enquiries'])) {
    //                                 $enquiries = $value['CIRReportData']['Enquiries'];
    //                             } else {
    //                                 $enquiries = '';
    //                             }

    //                             //Enquiry Summary
    //                             if (isset($value['CIRReportData']['EnquirySummary']['Purpose'])) {
    //                                 $Purpose = $value['CIRReportData']['EnquirySummary']['Purpose'];
    //                             } else {
    //                                 $Purpose = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Total'])) {
    //                                 $Total = $value['CIRReportData']['EnquirySummary']['Total'];
    //                             } else {
    //                                 $Total = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Past30Days'])) {
    //                                 $Past30Days = $value['CIRReportData']['EnquirySummary']['Past30Days'];
    //                             } else {
    //                                 $Past30Days = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Past12Months'])) {
    //                                 $Past12Months = $value['CIRReportData']['EnquirySummary']['Past12Months'];
    //                             } else {
    //                                 $Past12Months = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Past24Months'])) {
    //                                 $Past24Months = $value['CIRReportData']['EnquirySummary']['Past24Months'];
    //                             } else {
    //                                 $Past24Months = '';
    //                             }

    //                             if (isset($value['CIRReportData']['EnquirySummary']['Recent'])) {
    //                                 $Recent = $value['CIRReportData']['EnquirySummary']['Recent'];
    //                             } else {
    //                                 $Recent = '';
    //                             }

    //                             // foreach($RetailAccountDetails as $RetailAccountDetail)
    //                             // {
    //                             //     $AccountNumber = $RetailAccountDetail['AccountNumber'];
    //                             //     $Balance = $RetailAccountDetail['Balance'];
    //                             //     $Open = $RetailAccountDetail['Open'];
    //                             //     $DateReported = $RetailAccountDetail['DateReported'];
    //                             //     $Institution = $RetailAccountDetail['Institution'];
    //                             //     $PastDueAmount = $RetailAccountDetail['PastDueAmount'];
    //                             //     //$InterestRate = $RetailAccountDetail['AccountNumber']);
    //                             //     $DateOpened = $RetailAccountDetail['DateOpened'];
    //                             //     $Type = $RetailAccountDetail['AccountType'];
    //                             //     $LastPaymentDate = $RetailAccountDetail['LastPaymentDate'];
    //                             //     $LastPaymentDue = $RetailAccountDetail['LastPaymentDate'];
    //                             //     //$DateClosed = $RetailAccountDetail['AccountNumber']);
    //                             //     $OwnershipType = $RetailAccountDetail['source'];
    //                             //     //$WriteOffAmount = $RetailAccountDetail['AccountNumber']);
    //                             //     $SanctionAmount = $RetailAccountDetail['SanctionAmount'];

    //                             // }

    //                             //Personal Information
    //                            // $myarray['CustRefField'] = $CustRefField;
    //                             $myarray['orderNo'] = $orderNo;
    //                             $myarray['consumerName'] = $consumerName;
    //                             $myarray['PAN'] = $PAN;
    //                             $myarray['VoterID'] = $VoterID;
    //                             $myarray['Number'] = $Number;
    //                             $myarray['DOB'] = $DOB;
    //                             $myarray['age'] = $age;
    //                             $myarray['gender'] = $gender;
    //                             $myarray['NationalIDCard'] = $NationalIDCard;
    //                             // $myarray['aadhar'] = $aadhar_num;
    //                             //Address
    //                             $myarray['consumer_address'] = $consumer_address;

    //                             //Score
    //                             // $myarray['score'] = $score;
    //                             // $myarray['score_version'] = $score_version;
    //                             // $myarray['scoringelements'] = $scoringelements;
    //                             $myarray['score_details'] = $score_details;

    //                             //date and time
    //                             $myarray['date'] = $date;
    //                             $myarray['time'] = $time;
    //                             $myarray['enquiries'] = $enquiries;
    //                             $myarray['enquiry_summary'] = $enquiry_summary;

    //                             //Summary
    //                             $myarray['numberofAccounts'] = $numberofAccounts;
    //                             $myarray['TotalBalanceAmount'] = $TotalBalanceAmount;
    //                             $myarray['TotalPastAmount'] = $TotalPastAmount;
    //                             $myarray['recentAccount'] = $recent_account;
    //                             $myarray['oldestAccount'] = $oldest_account;
    //                             $myarray['numberOfOpenAccount'] = $numberOfOpenAccount;
    //                             $myarray['numberOfPastDueAccount'] = $numberOfPastDueAccount;
    //                             $myarray['TotalHighCredit'] = $TotalHighCredit;
    //                             $myarray['TotalCreditLimit'] = $TotalCreditLimit;
    //                             $myarray['NoOfWriteOffs'] = $NoOfWriteOffs;
    //                             $myarray['TotalSanctionAmount'] = $TotalSanctionAmount;
    //                             $myarray['SingleHighestCredit'] = $SingleHighestCredit;
    //                             $myarray['NoOfZeroBalanceAccounts'] = $NoOfZeroBalanceAccounts;
    //                             $myarray['TotalMonthlyPaymentAmount'] = $TotalMonthlyPaymentAmount;
    //                             $myarray['NoOfZeroBalanceAccounts'] = $NoOfZeroBalanceAccounts;
    //                             $myarray['SingleHighestBalance'] = $SingleHighestBalance;
    //                             $myarray['SingleHighestSanctionAmount'] = $SingleHighestSanctionAmount;
    //                             $myarray['RetailAccountDetails'] = $RetailAccountDetails;

    //                             //Enquiry Summary
    //                             $myarray['Purpose'] = $Purpose;
    //                             $myarray['Total'] = $Total;
    //                             $myarray['Past30Days'] = $Past30Days;
    //                             $myarray['Past24Months'] = $Past24Months;
    //                             $myarray['Recent'] = $Recent;
    //                             $myarray['Past12Months'] = $Past12Months;
    //                             $myarray['CustRefField'] = '-';
    //                         }
    //                     }
    //                     $pdf = PDF::loadView('kyc.equifaxreportpdf', compact('myarray', 'equifax'))->setPaper('A4');
    //                     $euifax_pdf_content = $pdf->output();
    //                     $euifax_report_base64 = base64_encode($euifax_pdf_content);
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                         }
    //                     }
    //                     return response()->json(["equifax"=>$equifax,'equfax_report'=>$euifax_report_base64,'statusCode' => '200']);
    //                   }
    //                 else{
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
    //                         }
    //                     }
    //                     return response()->json(["statusCode"=>102,"equifax"=>$equifax]);
    //                 }


    //             }
    //             catch(BadResponseException $e){
    //                 $statusCode = $e->getResponse()->getStatusCode();
    //                 if($statusCode == 500){
    //                     $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
    //                     if($user->role_id==1) {
    //                         $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                     }
    //                 }else if($statusCode == 422){
    //                     $statusCode = 102;
    //                     $errorMessage = 'Verification Failed. Please enter valid details.';
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }else{
    //                     $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                     if($user->role_id==1) {
    //                         if($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                 }
    //                 return response()->json(['statusCode'=>$statusCode, 'message'=>$errorMessage]);
    //             }
    //         }
    //         else{
    //             return response()->json(["statusCode"=>500,'message'=>"Please recharge your wallet."]);
    //         }
    //         }else{
    //             return response()->json(['statusCode'=>103, 'message'=>'You are not registered to use this service. Please update your plan.']);
    //         } 
    //         $equifaxstatus = $response['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'];
    //         // return $equifax;
    //         if($equifaxstatus > 0){
    //             return response() -> json(['Equifax_Report' => $response,'statusCode' => '200']);
    //         }
    //         else{
    //             // return response()->json(['statusCode'=>102, 'message'=>'Please enter valid details']);
    //             return response()->json(['statusCode'=>102, 'message'=>$response]);
    //         }
    //     }
    //     else{
    //         return response()->json(['statusCode'=>500, 'message'=>'Please recharge your wallet']);
    //     }
    //     // return $user;

    // } 
    public function equifaxwithpdf(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'phone_number' => 'required|regex:/^[0-9]{10}$/',
             'pan_num' => 'required'
        ]);
        if ($validator->fails()) {
            return response()->json([
                'status' => 'Forbidden',
                'errors' => $validator->errors(),
            ], 403);
        }

        $sql = DB::table('equifax_pdf_request')->insert([
            'firstName' => $request->fname,
            'lastName' => $request->lname,
            'contactNo' => $request->phone_number,
            'idValue' => $request->id_value,
            'created_at' => date('Y-m-d H:i:s')
        ]);
        $api_id = null;
        // $validator = Validator::make($request -> all(),[
        //     // 'FirstName' => ['required','string','max:255'],
        //     // 'LastName' => ['required','string','max:255'],
        //     'ContactNo' => ['required','string','max:255'],
        //     'IDValue' => ['required'],
        // ]);
        $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
        $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
        $pan_num = $request->pan_num ? $request->pan_num : null;
        $voter_id = $request->voter_num ? $request->voter_num : null;
        $passport = $request->passport_num ? $request->passport_num : null;
        $driving_licence = $request->driving_num ? $request->driving_num : null;

        // if($validator -> fails())
        //     return response() -> json(['Errors' => $validator -> errors(),
        //                                 'statusCode' => '404']);
        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        $balance = $user->wallet_amount;
        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
            if ($user->role_id == 1) {
                // $apiamster = ApiMaster::where('api_slug', 'equifaxwithpdf')->first();
                 $apiamster = ApiMaster::where('api_slug', 'equifax')->first();
                if ($apiamster)
                    $api_id = $apiamster->id;
            }
            $uname = $user->name;
            // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
            $arr = explode(' ', trim($uname));
            $usr = '';
            $substr = '';
            foreach ($arr as $array) {
                $substr = substr($array, 0, 1);
                $usr = $usr . $substr;
            }
            $recordId = sprintf("%04d", $record_id->id);
            $CustRefField = "DB-" . strtoupper($usr) . Carbon::now()->format('y') . Carbon::now()->format('m') . $recordId;
            $headers = [
                'Content-Type' => 'application/json',
                'Authorization' => 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0bGFuZCIsImlhdCI6MTY5MTM4NDEzODczNH0.nHmNhb-NlFPziNE_-9iEGKTIVoiz5rM_lNVvPLvQLgU',
            ];
            $body =
                [
                    "InquiryPurpose" => "10",
                    "TransactionAmount" => "",
                    "FirstName" => $request->fname,
                    "MiddleName" => "",
                    "LastName" => $request->lname,
                    "InquiryAddresses" => [
                        [
                            "seq" => "1",
                            "AddressType" => [
                                "H"
                            ],
                            "AddressLine1" => "",
                            "AddressLine2" => "",
                            "Locality" => "",
                            "City" => "",
                            "State" => "",
                            "Postal" => ""
                        ]
                    ],
                    "InquiryPhones"=>[
                    [
                        "seq"=>"16",
                        "Number"=>$request->phone_number,
                        "PhoneType"=>[
                            "M"
                        ]
                    ]
                ],
                    "IDDetails" => [
                        [
                            "seq" => "1",
                            "IDType" => "T",
                            "IDValue" => $request->pan_num
                        ]
                    ],
                    "DOB" => $request->dob
                ];
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    try {
                        $client = new Client();
                        $res = $client->post("https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score", ['headers' => $headers, 'json' => $body]);
                        $response = json_decode($res->getBody(), true);

                        if (isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) && $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] > 00) {
                            $myarray = [];
                            $equifax = null;
                            if (isset($response['data']['InquiryResponseHeader']) && isset($response['data']['CCRResponse'])) {
                                $equifax['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
                                $equifax['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                                $equifax['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
                                $equifax['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
                                $equifax['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
                                $equifax['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
                                $equifax['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
                                $equifax['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
                                $equifax['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
                                $equifax['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
                                $equifax['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                                $equifax['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                                $equifax['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                                $equifax['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                                $equifax['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                                $equifax['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                                $equifax['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                                $equifax['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                                $equifax['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
                                $equifax['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['Score'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Score']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Score'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] : null;
                                $equifax['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] : null;
                            }
                            if (!empty($equifax['CCRResponse']['CIRReportDataLst'])) {
                                foreach ($equifax['CCRResponse']['CIRReportDataLst'] as $key => $value) {
                                    if (isset($value['InquiryResponseHeader']['ReportOrderNO'])) {
                                        $orderNo = $value['InquiryResponseHeader']['ReportOrderNO'];
                                    } else {
                                        $orderNo = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'])) {
                                        $consumerName = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Name']['FullName'];
                                    } else {
                                        $consumerName = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'])) {
                                        $DOB = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'];
                                    } else {
                                        $DOB = '';
                                    }

                                    if (isset($value['InquiryResponseHeader']['Date'])) {
                                        $date = $value['InquiryResponseHeader']['Date'];
                                    } else {
                                        $date = '';
                                    }

                                    if (isset($value['InquiryResponseHeader']['Time'])) {
                                        $time = $value['InquiryResponseHeader']['Time'];
                                    } else {
                                        $time = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Age']['Age'])) {
                                        $age = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Age']['Age'];
                                    } else {
                                        $age = '';
                                    }

                                    if ($value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Gender']) {
                                        $gender = $value['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Gender'];
                                    } else {
                                        $gender = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['PANId'])) {
                                        foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['PANId'] as $key1 => $value1) {
                                            if (isset($value1['IdNumber'])) {
                                                $PAN = $value1['IdNumber'];
                                            } else {
                                                $PAN = '';
                                            }
                                        }
                                    } else {
                                        $PAN = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['NationalIDCard'])) {
                                        foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['NationalIDCard'] as $key1 => $value1) {
                                            if (isset($value1['IdNumber'])) {
                                                $NationalIDCard = $value1['IdNumber'];
                                            } else {
                                                $NationalIDCard = '';
                                            }
                                        }
                                    } else {
                                        $NationalIDCard = '';
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'])) {
                                        foreach ($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'] as $key1 => $value1) {
                                            if (isset($value1['IdNumber'])) {
                                                $VoterID = $value1['IdNumber'];
                                            } else {
                                                $VoterID = '';
                                            }
                                        }
                                    } else {
                                        $VoterID = '';
                                    }
                                    // foreach($value['CIRReportData']['IDAndContactInfo']['IdentityInfo']['VoterID'] as $key1 => $value1)
                                    //     if(isset($value1['IdNumber']))
                                    //         $VoterID = $value1['IdNumber'];
                                    //     else
                                    //         $VoterID = "";

                                    foreach ($value['InquiryRequestInfo']['InquiryPhones'] as $key2 => $value2) {
                                        if (isset($value2['Number'])) {
                                            $Number = $value2['Number'];
                                        } else {
                                            $Number = '';
                                        }
                                    }

                                    if (isset($value['CIRReportData']['IDAndContactInfo']['AddressInfo'])) {
                                        $consumer_address = $value['CIRReportData']['IDAndContactInfo']['AddressInfo'];

                                    } else {
                                        $consumer_address = '';
                                    }

                                    $score_array = $value['CIRReportData']['ScoreDetails'];
                                    if (count($score_array) > 0) {
                                        // foreach($score_array as $scoredetails)
                                        // {
                                        $score_details = $score_array;
                                        // if(isset($scoredetails['Value'])){
                                        //     $score = $scoredetails['Value'];
                                        //     $score_version = $scoredetails['Version'];
                                        // }else{
                                        //     $score = "";
                                        //     $score_version = "";
                                        // }
                                        // if(isset($scoredetails['ScoringElements']))
                                        //     $scoringelements = $scoredetails['ScoringElements'];
                                        // else
                                        //     $scoringelements = "";

                                        // }
                                    } else {
                                        $score_details = [];
                                    }

                                    if (isset($value['CIRReportData']['RecentActivities'])) {
                                        $enquiry_summary = $value['CIRReportData']['RecentActivities'];
                                    } else {
                                        $enquiry_summary = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfAccounts'])) {
                                        $numberofAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfAccounts'];
                                    } else {
                                        $numberofAccounts = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalBalanceAmount'])) {
                                        $TotalBalanceAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalBalanceAmount'];
                                    } else {
                                        $TotalBalanceAmount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalPastDue'])) {
                                        $TotalPastAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalPastDue'];
                                    } else {
                                        $TotalPastAmount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['RecentAccount'])) {
                                        $recent_account = $value['CIRReportData']['RetailAccountsSummary']['RecentAccount'];
                                    } else {
                                        $recent_account = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['OldestAccount'])) {
                                        $oldest_account = $value['CIRReportData']['RetailAccountsSummary']['OldestAccount'];
                                    } else {
                                        $oldest_account = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfActiveAccounts'])) {
                                        $numberOfOpenAccount = $value['CIRReportData']['RetailAccountsSummary']['NoOfActiveAccounts'];
                                    } else {
                                        $numberOfOpenAccount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfPastDueAccounts'])) {
                                        $numberOfPastDueAccount = $value['CIRReportData']['RetailAccountsSummary']['NoOfPastDueAccounts'];
                                    } else {
                                        $numberOfPastDueAccount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalHighCredit'])) {
                                        $TotalHighCredit = $value['CIRReportData']['RetailAccountsSummary']['TotalHighCredit'];
                                    } else {
                                        $TotalHighCredit = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalCreditLimit'])) {
                                        $TotalCreditLimit = $value['CIRReportData']['RetailAccountsSummary']['TotalCreditLimit'];
                                    } else {
                                        $TotalCreditLimit = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfWriteOffs'])) {
                                        $NoOfWriteOffs = $value['CIRReportData']['RetailAccountsSummary']['NoOfWriteOffs'];
                                    } else {
                                        $NoOfWriteOffs = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'])) {
                                        $TotalSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'];
                                    } else {
                                        $TotalSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalSanctionAmount'];
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestCredit'])) {
                                        $SingleHighestCredit = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestCredit'];
                                    } else {
                                        $SingleHighestCredit = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'])) {
                                        $NoOfZeroBalanceAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'];
                                    } else {
                                        $NoOfZeroBalanceAccounts = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['TotalMonthlyPaymentAmount'])) {
                                        $TotalMonthlyPaymentAmount = $value['CIRReportData']['RetailAccountsSummary']['TotalMonthlyPaymentAmount'];
                                    } else {
                                        $TotalMonthlyPaymentAmount = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'])) {
                                        $NoOfZeroBalanceAccounts = $value['CIRReportData']['RetailAccountsSummary']['NoOfZeroBalanceAccounts'];
                                    } else {
                                        $NoOfZeroBalanceAccounts = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestBalance'])) {
                                        $SingleHighestBalance = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestBalance'];
                                    } else {
                                        $SingleHighestBalance = '';
                                    }

                                    if (isset($value['CIRReportData']['RetailAccountsSummary']['SingleHighestSanctionAmount'])) {
                                        $SingleHighestSanctionAmount = $value['CIRReportData']['RetailAccountsSummary']['SingleHighestSanctionAmount'];
                                    } else {
                                        $SingleHighestSanctionAmount = '';
                                    }

                                    //RETAIL ACCOUNT DETAILS

                                    $RetailAccountDetails = $value['CIRReportData']['RetailAccountDetails'];

                                    //Enquiries

                                    if (isset($value['CIRReportData']['Enquiries'])) {
                                        $enquiries = $value['CIRReportData']['Enquiries'];
                                    } else {
                                        $enquiries = '';
                                    }

                                    //Enquiry Summary
                                    if (isset($value['CIRReportData']['EnquirySummary']['Purpose'])) {
                                        $Purpose = $value['CIRReportData']['EnquirySummary']['Purpose'];
                                    } else {
                                        $Purpose = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Total'])) {
                                        $Total = $value['CIRReportData']['EnquirySummary']['Total'];
                                    } else {
                                        $Total = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Past30Days'])) {
                                        $Past30Days = $value['CIRReportData']['EnquirySummary']['Past30Days'];
                                    } else {
                                        $Past30Days = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Past12Months'])) {
                                        $Past12Months = $value['CIRReportData']['EnquirySummary']['Past12Months'];
                                    } else {
                                        $Past12Months = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Past24Months'])) {
                                        $Past24Months = $value['CIRReportData']['EnquirySummary']['Past24Months'];
                                    } else {
                                        $Past24Months = '';
                                    }

                                    if (isset($value['CIRReportData']['EnquirySummary']['Recent'])) {
                                        $Recent = $value['CIRReportData']['EnquirySummary']['Recent'];
                                    } else {
                                        $Recent = '';
                                    }

                                    // foreach($RetailAccountDetails as $RetailAccountDetail)
                                    // {
                                    //     $AccountNumber = $RetailAccountDetail['AccountNumber'];
                                    //     $Balance = $RetailAccountDetail['Balance'];
                                    //     $Open = $RetailAccountDetail['Open'];
                                    //     $DateReported = $RetailAccountDetail['DateReported'];
                                    //     $Institution = $RetailAccountDetail['Institution'];
                                    //     $PastDueAmount = $RetailAccountDetail['PastDueAmount'];
                                    //     //$InterestRate = $RetailAccountDetail['AccountNumber']);
                                    //     $DateOpened = $RetailAccountDetail['DateOpened'];
                                    //     $Type = $RetailAccountDetail['AccountType'];
                                    //     $LastPaymentDate = $RetailAccountDetail['LastPaymentDate'];
                                    //     $LastPaymentDue = $RetailAccountDetail['LastPaymentDate'];
                                    //     //$DateClosed = $RetailAccountDetail['AccountNumber']);
                                    //     $OwnershipType = $RetailAccountDetail['source'];
                                    //     //$WriteOffAmount = $RetailAccountDetail['AccountNumber']);
                                    //     $SanctionAmount = $RetailAccountDetail['SanctionAmount'];

                                    // }

                                    //Personal Information
                                    // $myarray['CustRefField'] = $CustRefField;
                                    $myarray['orderNo'] = $orderNo;
                                    $myarray['consumerName'] = $consumerName;
                                    $myarray['PAN'] = $PAN;
                                    $myarray['VoterID'] = $VoterID;
                                    $myarray['Number'] = $Number;
                                    $myarray['DOB'] = $DOB;
                                    $myarray['age'] = $age;
                                    $myarray['gender'] = $gender;
                                    $myarray['NationalIDCard'] = $NationalIDCard;
                                    // $myarray['aadhar'] = $aadhar_num;
                                    //Address
                                    $myarray['consumer_address'] = $consumer_address;

                                    //Score
                                    // $myarray['score'] = $score;
                                    // $myarray['score_version'] = $score_version;
                                    // $myarray['scoringelements'] = $scoringelements;
                                    $myarray['score_details'] = $score_details;

                                    //date and time
                                    $myarray['date'] = $date;
                                    $myarray['time'] = $time;
                                    $myarray['enquiries'] = $enquiries;
                                    $myarray['enquiry_summary'] = $enquiry_summary;

                                    //Summary
                                    $myarray['numberofAccounts'] = $numberofAccounts;
                                    $myarray['TotalBalanceAmount'] = $TotalBalanceAmount;
                                    $myarray['TotalPastAmount'] = $TotalPastAmount;
                                    $myarray['recentAccount'] = $recent_account;
                                    $myarray['oldestAccount'] = $oldest_account;
                                    $myarray['numberOfOpenAccount'] = $numberOfOpenAccount;
                                    $myarray['numberOfPastDueAccount'] = $numberOfPastDueAccount;
                                    $myarray['TotalHighCredit'] = $TotalHighCredit;
                                    $myarray['TotalCreditLimit'] = $TotalCreditLimit;
                                    $myarray['NoOfWriteOffs'] = $NoOfWriteOffs;
                                    $myarray['TotalSanctionAmount'] = $TotalSanctionAmount;
                                    $myarray['SingleHighestCredit'] = $SingleHighestCredit;
                                    $myarray['NoOfZeroBalanceAccounts'] = $NoOfZeroBalanceAccounts;
                                    $myarray['TotalMonthlyPaymentAmount'] = $TotalMonthlyPaymentAmount;
                                    $myarray['NoOfZeroBalanceAccounts'] = $NoOfZeroBalanceAccounts;
                                    $myarray['SingleHighestBalance'] = $SingleHighestBalance;
                                    $myarray['SingleHighestSanctionAmount'] = $SingleHighestSanctionAmount;
                                    $myarray['RetailAccountDetails'] = $RetailAccountDetails;

                                    //Enquiry Summary
                                    $myarray['Purpose'] = $Purpose;
                                    $myarray['Total'] = $Total;
                                    $myarray['Past30Days'] = $Past30Days;
                                    $myarray['Past24Months'] = $Past24Months;
                                    $myarray['Recent'] = $Recent;
                                    $myarray['Past12Months'] = $Past12Months;
                                    $myarray['CustRefField'] = $CustRefField;
                                }
                            }

                            $pdf = PDF::loadView('kyc.equifaxreportpdf', compact('myarray', 'equifax'))->setPaper('A4');
                            $euifax_pdf_content = $pdf->output();
                            $euifax_report_base64 = base64_encode($euifax_pdf_content);
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                            }
                            return response()->json(["equifax" => $equifax, 'equfax_report' => $euifax_report_base64, 'statusCode' => '200']);
                        } else {
                            $equifaxdetails = null;
                            $equifaxdetails['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
                            $equifaxdetails['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                            $equifaxdetails['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
                            $equifaxdetails['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
                            $equifaxdetails['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
                            $equifaxdetails['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
                            $equifaxdetails['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
                            $equifaxdetails['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
                            $equifaxdetails['InquiryRequestInfo']['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
                            $equifaxdetails['InquiryRequestInfo']['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
                            $equifaxdetails['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                            $equifaxdetails['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                            $equifaxdetails['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                            $equifaxdetails['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                            $equifaxdetails['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                            $equifaxdetails['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                            $equifaxdetails['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                            $equifaxdetails['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                            $equifaxdetails['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
                            $equifaxdetails['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
                            $equifaxdetails['CCRResponse']['CIRReportDataLst'][0]['Error'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Error']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Error'] : null;
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful.', 200);
                                }
                            }
                            return response()->json(["statusCode" => 102, "message" => $equifaxdetails]);
                        }


                    } catch (BadResponseException $e) {
                        $statusCode = $e->getResponse()->getStatusCode();
                        if ($statusCode == 500) {
                            $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        } else if ($statusCode == 422) {
                            $statusCode = 102;
                            $errorMessage = 'Verification Failed. Please enter valid details.';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        } else {
                            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                                }
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(["statusCode" => 500, 'message' => "Please recharge your wallet."]);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet']);
        }
        // return $user;

    }

    public function ckycSearchNewold(Request $request)
    {
        // return 'test3';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        if (empty($request->client_ref_num)) {
            return response()->json([['message' => 'client refercence number is required', 'statusCode' => '404']]);
        }
        if (empty($request->identifier_type)) {
            return response()->json([['message' => 'identifier_type is required', 'statusCode' => '404']]);
        }

        if (empty($request->dob)) {
            return response()->json(['message' => "Date of birth is required", 'statusCode' => '404']);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // return $user->id;
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'searchkycdigitap')->first();
            // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

        $panno = $request->pano;
        $client_ref_number = $request->client_ref_num;
        $identity_type = $request->identifier_type;
        $dob = $request->dob;
        if ($panno == 'HUHPS7607K') {
            $data = [
                [
                    [
                        "response" => [
                            "status" => "VALID",
                            "kycStatus" => "null",
                            "message" => "Details downloaded successfully.",
                            "kycDetails" => [
                                "personalIdentifiableData" => [
                                    "personalDetails" => [
                                        "constitution_type" => "Individual",
                                        "account_type" => "Normal",
                                        "ckyc_no" => "60042994549621",
                                        "prefix" => "MR",
                                        "firstName" => "HARSHIT",
                                        "lastName" => "SINGH",
                                        "fullName" => "MR HARSHIT SINGH",
                                        "maiden_prefix" => "null",
                                        "maiden_fname" => "null",
                                        "maiden_mname" => "null",
                                        "maiden_lname" => "null",
                                        "maiden_fullname" => "null",
                                        "father_or_spouse_flag" => "null",
                                        "father_prefix" => "MR",
                                        "father_fname" => "Balram",
                                        "father_mname" => "null",
                                        "father_lname" => "Singh",
                                        "father_fullname" => "MR Balram Singh",
                                        "mother_prefix" => "MRS",
                                        "mother_fname" => "ANITA",
                                        "mother_mname" => "null",
                                        "mother_lname" => "SINGH",
                                        "mother_fullname" => "MRS ANITA SINGH",
                                        "mobNum" => "9450367613",
                                        "pan" => "HUHPS7607K",
                                        "email" => "luckyharshit741@gmail.com",
                                        "dob" => "12-02-1999",
                                        "age" => "25",
                                        "gender" => "M",
                                        "permLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "permLine2" => "JATEPUR",
                                        "perm_line3" => "NEAR KRISHNA NAGAR",
                                        "permCity" => "Gorakhpur",
                                        "permDist" => "Gorakhpur",
                                        "permState" => "Uttar Pradesh",
                                        "permPin" => "273001",
                                        "permCountry" => "IN",
                                        "permPoa" => "E-KYC Authentication",
                                        "perm_corres_sameflag" => "Y",
                                        "corresLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "corresLine2" => "JATEPUR",
                                        "corres_line3" => "NEAR KRISHNA NAGAR",
                                        "corresCity" => "Gorakhpur",
                                        "corresDist" => "Gorakhpur",
                                        "corresState" => "Uttar Pradesh",
                                        "corresPin" => "273001",
                                        "corresCountry" => "IN",
                                        "corresPoa" => "09",
                                        "resi_std_code" => "522",
                                        "resi_tel_num" => "7734945195",
                                        "off_tel_num" => "null",
                                        "off_std_code" => "0",
                                        "remarks" => "null",
                                        "dec_date" => "02-11-2023",
                                        "dec_place" => "Gorakhpur",
                                        "doc_sub" => "06",
                                        "kyc_date" => "********",
                                        "kyc_name" => "********",
                                        "kyc_designation" => "********",
                                        "kyc_branch" => "********",
                                        "kyc_empcode" => "********",
                                        "org_name" => "********",
                                        "org_code" => "********",
                                        "numIdentity" => "1",
                                        "numRelated" => "0",
                                        "numImages" => "3",
                                        "related_person_details" => "null",
                                        "identity_details" => [
                                            "identity" => [
                                                [
                                                    "sequence_no" => "1",
                                                    "ident_type" => "H",
                                                    "ident_num" => "XXXXXXXX4191",
                                                    "idver_status" => "N",
                                                ],

                                            ],
                                            "image_details" => [
                                                "image" => [
                                                    [
                                                        "sequence_no" => "1",
                                                        "image_type" => "pdf",
                                                        "image_code" => "PAN",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "JVBERi0xLjQNJeLjz9MNCjEgMCBv",
                                                        "image_url" => "https=>/ap-south-1amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "2",
                                                        "image_type" => "JPG",
                                                        "image_code" => "Photograph",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "3",
                                                        "image_type" => "pdf",
                                                        "image_code" => "Proof of Possession of Aadhaar",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/G",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                ]
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            ];

            return response()->json(['statusCode' => 200, 'data' => $data]);
        } else {
            return 'Api is in under mentainance';
        }
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            // return $api_id;
            $url = 'https://api.digitap.ai/ckyc/v1/search';

            $data = [
                'client_ref_num' => $client_ref_number,
                'identifier' => $panno,
                'identifier_type' => $identity_type,
            ];

            $body = json_encode($data);

            $ch = curl_init($url);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'Content-Type:application/json']);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            $get_data1 = curl_exec($ch);
            $kyccard = json_decode($get_data1, true);

            // Async::run($kyccard);
            // $results = Async::wait();

            if (isset($kyccard['result_code']) && $kyccard['result_code'] == 103) {
                $kyccarderror = null;

                $kyccarderror['error']['status'] = 102;
                $kyccarderror['error']['message'] = $kyccard['error'];
                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                    }
                }
                $panvalidation = DB::table('search_new')->insert([
                    'user_id' => $user->id,
                    'api_id' => $api_id,
                    'dob' => $dob,
                    'status' => 102,
                    'pan_no' => $request->pano,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);
                return response()->json(['statusCode' => 102, 'response' => $kyccarderror]);
            }

            if (isset($kyccard['result_code']) && $kyccard['result_code'] == 101) {
                //return $kyccard;
                $searchkyc = [];
                $url = 'https://api.digitap.ai/ckyc/v1/download';

                $data = [
                    'ckyc_id' => $kyccard['result']['ckyc_id'],
                    'auth_factor_type' => "DOB",
                    'client_ref_num' => $kyccard['client_ref_num'],
                    'auth_factor' => $dob,
                ];

                $body = json_encode($data);

                $ch = curl_init($url);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'Content-Type:application/json']);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $alldata = curl_exec($ch);
                $allpandata = json_decode($alldata, true);
                if (isset($allpandata['result_code']) && $allpandata['result_code'] == 101) {
                    $searchkyc['status'] = $allpandata['status'];
                    $searchkyc['kycStatus'] = null;
                    $searchkyc['message'] = 'Details downloaded successfully';
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['result']['personal_details']['first_name'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['result']['personal_details']['last_name'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['result']['personal_details']['full_name'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = $allpandata['result']['personal_details']['mob_num'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['result']['personal_details']['email'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['result']['personal_details']['dob'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'] = $allpandata['result']['personal_details']['perm_line1'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'] = $allpandata['result']['personal_details']['perm_line2'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'] = $allpandata['result']['personal_details']['perm_city'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'] = $allpandata['result']['personal_details']['perm_dist'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permState'] = $allpandata['result']['personal_details']['perm_state'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'] = $allpandata['result']['personal_details']['perm_pin'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'] = $allpandata['result']['personal_details']['corres_line1'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'] = $allpandata['result']['personal_details']['corres_line2'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'] = $allpandata['result']['personal_details']['corres_city'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'] = $allpandata['result']['personal_details']['corres_dist'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'] = $allpandata['result']['personal_details']['corres_state'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'] = $allpandata['result']['personal_details']['corres_pin'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'] = $allpandata['result']['personal_details']['num_identity'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'] = $allpandata['result']['personal_details']['num_related'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'] = $allpandata['result']['personal_details']['num_images'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['image_details'] = $allpandata['result']['image_details'];

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        foreach ($allpandata['result']['image_details']['image'] as $key => $value) {

                            $panvalidation = DB::table('search_new')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status' => 200,
                                'pan_no' => $allpandata['result']['personal_details']['pan'],
                                'ckycid' => $allpandata['result']['personal_details']['ckyc_no'],
                                'firstname' => $allpandata['result']['personal_details']['first_name'],
                                'fullname' => $allpandata['result']['personal_details']['full_name'],
                                'mobilenum' => $allpandata['result']['personal_details']['mob_num'],
                                'email' => $allpandata['result']['personal_details']['email'],
                                'dob' => $allpandata['result']['personal_details']['dob'],
                                'paddress' => $allpandata['result']['personal_details']['perm_line1'],
                                'pstate' => $allpandata['result']['personal_details']['perm_state'],
                                'pcity' => $allpandata['result']['personal_details']['perm_city'],
                                'caddress' => $allpandata['result']['personal_details']['corres_line1'],
                                'cstate' => $allpandata['result']['personal_details']['corres_state'],
                                'ccity' => $allpandata['result']['personal_details']['corres_city'],
                                'currentpincode' => $allpandata['result']['personal_details']['corres_pin'],
                                'permanantpincode' => $allpandata['result']['personal_details']['perm_pin'],
                                'branch_code' => $value['branch_code'],
                                'image_data' => $value['image_data'],
                                'image_url' => $value['image_url'],
                                'sequence_no' => $value['sequence_no'],
                                // "pancard_id"=> $pancard['response']['pan_no'],
                                // "name"=> $pancard['response']['registered_name'],
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }

                    }
                    return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                } elseif (isset($allpandata['status']) && $allpandata['status'] == 'INVALID') {
                    if ($user->role_id == 1) {
                        $statusCode = 102;
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                        // return 'insert';
                        $panvalidation = DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'dob' => $dob,
                            'status' => 102,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $searchkyc['status'] = $allpandata['status'];
                    $searchkyc['error'] = $allpandata['kycStatus'];
                    $searchkyc['message'] = 'Date of birth entered does not match';
                    return response()->json(['statusCode' => 102, 'response' => $searchkyc]);
                } else {
                    // return 'test';
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'dob' => $dob,
                        'status' => 202,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 202, 'response' => $allpandata]);
                }
                // return response()->json(json_decode($alldata,true));
                // return response()->json(['statusCode'=>200, 'response'=>$allpandata]);
            } else {
                $panvalidation = DB::table('search_new')->insert([
                    'user_id' => $user->id,
                    'api_id' => $api_id,
                    'status' => 201,
                    'pan_no' => $request->pano,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);
                return response()->json(['statusCode' => 201, 'response' => $kyccard]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function ckycSearchNew22feb2024(Request $request)
    {
        // return 'test3';

        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        if (empty($request->client_ref_num)) {
            return response()->json([['message' => 'client refercence number is required', 'statusCode' => '404']]);
        }
        if (empty($request->identifier_type)) {
            return response()->json([['message' => 'identifier_type is required', 'statusCode' => '404']]);
        }

        if (empty($request->dob)) {
            return response()->json(['message' => "Date of birth is required", 'statusCode' => '404']);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // return $user->id;
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'searchkycdigitap')->first();
            // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

        $panno = $request->pano;
        $client_ref_number = $request->client_ref_num;
        $identity_type = $request->identifier_type;
        $dob = $request->dob;
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            // return $api_id;
            $url = 'https://api.digitap.ai/ckyc/v1/search';

            $data = [
                'client_ref_num' => $client_ref_number,
                'identifier' => $panno,
                'identifier_type' => $identity_type,
            ];

            $body = json_encode($data);

            $ch = curl_init($url);

            curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'Content-Type:application/json']);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            $get_data1 = curl_exec($ch);
            $kyccard = json_decode($get_data1, true);

            // Async::run($kyccard);
            // $results = Async::wait();

            if (isset($kyccard['result_code']) && $kyccard['result_code'] == 103) {
                $kyccarderror = null;

                $kyccarderror['error']['status'] = 102;
                $kyccarderror['error']['message'] = $kyccard['error'];
                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                    }
                }
                $panvalidation = DB::table('search_new')->insert([
                    'user_id' => $user->id,
                    'api_id' => $api_id,
                    'dob' => $dob,
                    'status' => 102,
                    'pan_no' => $request->pano,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);
                return response()->json(['statusCode' => 102, 'response' => $kyccarderror]);
            }

            if (isset($kyccard['result_code']) && $kyccard['result_code'] == 101) {
                //return $kyccard;
                $searchkyc = [];
                $url = 'https://api.digitap.ai/ckyc/v1/download';

                $data = [
                    'ckyc_id' => $kyccard['result']['ckyc_id'],
                    'auth_factor_type' => "DOB",
                    'client_ref_num' => $kyccard['client_ref_num'],
                    'auth_factor' => $dob,
                ];

                $body = json_encode($data);

                $ch = curl_init($url);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'Content-Type:application/json']);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $alldata = curl_exec($ch);
                $allpandata = json_decode($alldata, true);
                if (isset($allpandata['result_code']) && $allpandata['result_code'] == 101) {
                    $searchkyc['status'] = $allpandata['status'];
                    $searchkyc['kycStatus'] = null;
                    $searchkyc['message'] = 'Details downloaded successfully';
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['result']['personal_details']['first_name'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['result']['personal_details']['last_name'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['result']['personal_details']['full_name'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = $allpandata['result']['personal_details']['mob_num'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['result']['personal_details']['email'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['result']['personal_details']['dob'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'] = $allpandata['result']['personal_details']['perm_line1'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'] = $allpandata['result']['personal_details']['perm_line2'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'] = $allpandata['result']['personal_details']['perm_city'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'] = $allpandata['result']['personal_details']['perm_dist'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permState'] = $allpandata['result']['personal_details']['perm_state'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'] = $allpandata['result']['personal_details']['perm_pin'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'] = $allpandata['result']['personal_details']['corres_line1'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'] = $allpandata['result']['personal_details']['corres_line2'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'] = $allpandata['result']['personal_details']['corres_city'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'] = $allpandata['result']['personal_details']['corres_dist'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'] = $allpandata['result']['personal_details']['corres_state'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'] = $allpandata['result']['personal_details']['corres_pin'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'] = $allpandata['result']['personal_details']['num_identity'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'] = $allpandata['result']['personal_details']['num_related'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'] = $allpandata['result']['personal_details']['num_images'];
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['image_details'] = $allpandata['result']['image_details'];

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        if (isset($allpandata['result']['image_details']) && $allpandata['result']['image_details']['image'][0]['sequence_no'] == "1" || $allpandata['result']['image_details']['image'][1]['sequence_no'] == "2" || $allpandata['result']['image_details']['image'][2]['sequence_no'] == "3" || $allpandata['result']['image_details']['image'][3]['sequence_no'] == "4") {

                            $panvalidation = DB::table('search_new')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status' => 200,
                                'pan_no' => isset($allpandata['result']['personal_details']['pan']) ? $allpandata['result']['personal_details']['pan'] : null,
                                'ckycid' => isset($allpandata['result']['personal_details']['ckyc_no']) ? $allpandata['result']['personal_details']['ckyc_no'] : null,
                                'firstname' => isset($allpandata['result']['personal_details']['first_name']) ? $allpandata['result']['personal_details']['first_name'] : null,
                                'fullname' => isset($allpandata['result']['personal_details']['full_name']) ? $allpandata['result']['personal_details']['full_name'] : null,
                                'mobilenum' => isset($allpandata['result']['personal_details']['mob_num']) ? $allpandata['result']['personal_details']['mob_num'] : null,
                                'email' => isset($allpandata['result']['personal_details']['email']) ? $allpandata['result']['personal_details']['email'] : null,
                                'dob' => isset($allpandata['result']['personal_details']['dob']) ? $allpandata['result']['personal_details']['dob'] : null,
                                'paddress' => isset($allpandata['result']['personal_details']['perm_line1']) ? $allpandata['result']['personal_details']['perm_line1'] : null,
                                'pstate' => isset($allpandata['result']['personal_details']['perm_state']) ? $allpandata['result']['personal_details']['perm_state'] : null,
                                'pcity' => isset($allpandata['result']['personal_details']['perm_city']) ? $allpandata['result']['personal_details']['perm_city'] : null,
                                'caddress' => isset($allpandata['result']['personal_details']['corres_line1']) ? $allpandata['result']['personal_details']['corres_line1'] : null,
                                'cstate' => isset($allpandata['result']['personal_details']['corres_state']) ? $allpandata['result']['personal_details']['corres_state'] : null,
                                'ccity' => isset($allpandata['result']['personal_details']['corres_city']) ? $allpandata['result']['personal_details']['corres_city'] : null,
                                'currentpincode' => isset($allpandata['result']['personal_details']['corres_pin']) ? $allpandata['result']['personal_details']['corres_pin'] : null,
                                'permanantpincode' => isset($allpandata['result']['personal_details']['perm_pin']) ? $allpandata['result']['personal_details']['perm_pin'] : null,
                                'branch_code1' => isset($allpandata['result']['image_details']['image'][0]['branch_code']) ? $allpandata['result']['image_details']['image'][0]['branch_code'] : null,
                                'branch_code2' => isset($allpandata['result']['image_details']['image'][1]['branch_code']) ? $allpandata['result']['image_details']['image'][1]['branch_code'] : null,
                                'branch_code3' => isset($allpandata['result']['image_details']['image'][2]['branch_code']) ? $allpandata['result']['image_details']['image'][2]['branch_code'] : null,
                                'branch_code4' => isset($allpandata['result']['image_details']['image'][3]['branch_code']) ? $allpandata['result']['image_details']['image'][3]['branch_code'] : null,
                                'image_url1' => isset($allpandata['result']['image_details']['image'][0]['image_url']) ? $allpandata['result']['image_details']['image'][0]['image_url'] : null,
                                'image_url2' => isset($allpandata['result']['image_details']['image'][1]['image_url']) ? $allpandata['result']['image_details']['image'][1]['image_url'] : null,
                                'image_url3' => isset($allpandata['result']['image_details']['image'][2]['image_url']) ? $allpandata['result']['image_details']['image'][2]['image_url'] : null,
                                'image_url4' => isset($allpandata['result']['image_details']['image'][3]['image_url']) ? $allpandata['result']['image_details']['image'][3]['image_url'] : null,
                                'image_code1' => isset($allpandata['result']['image_details']['image'][0]['image_code']) ? $allpandata['result']['image_details']['image'][0]['image_code'] : null,
                                'image_code2' => isset($allpandata['result']['image_details']['image'][1]['image_code']) ? $allpandata['result']['image_details']['image'][1]['image_code'] : null,
                                'image_code3' => isset($allpandata['result']['image_details']['image'][2]['image_code']) ? $allpandata['result']['image_details']['image'][2]['image_code'] : null,
                                'image_code4' => isset($allpandata['result']['image_details']['image'][3]['image_code']) ? $allpandata['result']['image_details']['image'][3]['image_code'] : null,
                                'image_data1' => isset($allpandata['result']['image_details']['image'][0]['image_data']) ? $allpandata['result']['image_details']['image'][0]['image_data'] : null,
                                'image_data2' => isset($allpandata['result']['image_details']['image'][1]['image_data']) ? $allpandata['result']['image_details']['image'][1]['image_data'] : null,
                                'image_data3' => isset($allpandata['result']['image_details']['image'][2]['image_data']) ? $allpandata['result']['image_details']['image'][2]['image_data'] : null,
                                'image_data4' => isset($allpandata['result']['image_details']['image'][3]['image_data']) ? $allpandata['result']['image_details']['image'][3]['image_data'] : null,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);

                        }

                    }
                    return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                } elseif (isset($allpandata['status']) && $allpandata['status'] == 'INVALID') {
                    if ($user->role_id == 1) {
                        $statusCode = 102;
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                        // return 'insert';
                        $panvalidation = DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'dob' => $dob,
                            'status' => 102,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $searchkyc['status'] = $allpandata['status'];
                    $searchkyc['error'] = $allpandata['kycStatus'];
                    $searchkyc['message'] = 'Date of birth entered does not match';
                    return response()->json(['statusCode' => 102, 'response' => $searchkyc]);
                } else {
                    // return 'test';
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'dob' => $dob,
                        'status' => 202,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 202, 'response' => $allpandata]);
                }
                // return response()->json(json_decode($alldata,true));
                // return response()->json(['statusCode'=>200, 'response'=>$allpandata]);
            } else {
                $panvalidation = DB::table('search_new')->insert([
                    'user_id' => $user->id,
                    'api_id' => $api_id,
                    'status' => 201,
                    'pan_no' => $request->pano,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);
                return response()->json(['statusCode' => 201, 'response' => $kyccard]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function ckycSearchNew(Request $request)
    {
        // return 'test3';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        if (empty($request->client_ref_num)) {
            return response()->json([['message' => 'client refercence number is required', 'statusCode' => '404']]);
        }
        if (empty($request->identifier_type)) {
            return response()->json([['message' => 'identifier_type is required', 'statusCode' => '404']]);
        }

        if (empty($request->dob)) {
            return response()->json(['message' => "Date of birth is required", 'statusCode' => '404']);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // return $user->id;
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'searchkycdigitap')->first();
            // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

        $panno = $request->pano;
        if ($panno == 'HUHPS7607K') {
            $data = [
                [
                    [
                        "response" => [
                            "status" => "VALID",
                            "kycStatus" => "null",
                            "message" => "Details downloaded successfully.",
                            "kycDetails" => [
                                "personalIdentifiableData" => [
                                    "personalDetails" => [
                                        "constitution_type" => "Individual",
                                        "account_type" => "Normal",
                                        "ckyc_no" => "60042994549621",
                                        "prefix" => "MR",
                                        "firstName" => "HARSHIT",
                                        "lastName" => "SINGH",
                                        "fullName" => "MR HARSHIT SINGH",
                                        "maiden_prefix" => "null",
                                        "maiden_fname" => "null",
                                        "maiden_mname" => "null",
                                        "maiden_lname" => "null",
                                        "maiden_fullname" => "null",
                                        "father_or_spouse_flag" => "null",
                                        "father_prefix" => "MR",
                                        "father_fname" => "Balram",
                                        "father_mname" => "null",
                                        "father_lname" => "Singh",
                                        "father_fullname" => "MR Balram Singh",
                                        "mother_prefix" => "MRS",
                                        "mother_fname" => "ANITA",
                                        "mother_mname" => "null",
                                        "mother_lname" => "SINGH",
                                        "mother_fullname" => "MRS ANITA SINGH",
                                        "mobNum" => "9450367613",
                                        "pan" => "HUHPS7607K",
                                        "email" => "luckyharshit741@gmail.com",
                                        "dob" => "12-02-1999",
                                        "age" => "25",
                                        "gender" => "M",
                                        "permLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "permLine2" => "JATEPUR",
                                        "perm_line3" => "NEAR KRISHNA NAGAR",
                                        "permCity" => "Gorakhpur",
                                        "permDist" => "Gorakhpur",
                                        "permState" => "Uttar Pradesh",
                                        "permPin" => "273001",
                                        "permCountry" => "IN",
                                        "permPoa" => "E-KYC Authentication",
                                        "perm_corres_sameflag" => "Y",
                                        "corresLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "corresLine2" => "JATEPUR",
                                        "corres_line3" => "NEAR KRISHNA NAGAR",
                                        "corresCity" => "Gorakhpur",
                                        "corresDist" => "Gorakhpur",
                                        "corresState" => "Uttar Pradesh",
                                        "corresPin" => "273001",
                                        "corresCountry" => "IN",
                                        "corresPoa" => "09",
                                        "resi_std_code" => "522",
                                        "resi_tel_num" => "7734945195",
                                        "off_tel_num" => "null",
                                        "off_std_code" => "0",
                                        "remarks" => "null",
                                        "dec_date" => "02-11-2023",
                                        "dec_place" => "Gorakhpur",
                                        "doc_sub" => "06",
                                        "kyc_date" => "********",
                                        "kyc_name" => "********",
                                        "kyc_designation" => "********",
                                        "kyc_branch" => "********",
                                        "kyc_empcode" => "********",
                                        "org_name" => "********",
                                        "org_code" => "********",
                                        "numIdentity" => "1",
                                        "numRelated" => "0",
                                        "numImages" => "3",
                                        "related_person_details" => "null",
                                        "identity_details" => [
                                            "identity" => [
                                                [
                                                    "sequence_no" => "1",
                                                    "ident_type" => "H",
                                                    "ident_num" => "XXXXXXXX4191",
                                                    "idver_status" => "N",
                                                ],

                                            ],
                                            "image_details" => [
                                                "image" => [
                                                    [
                                                        "sequence_no" => "1",
                                                        "image_type" => "pdf",
                                                        "image_code" => "PAN",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "JVBERi0xLjQNJeLjz9MNCjEgMCBv",
                                                        "image_url" => "https=>/ap-south-1amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "2",
                                                        "image_type" => "JPG",
                                                        "image_code" => "Photograph",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "3",
                                                        "image_type" => "pdf",
                                                        "image_code" => "Proof of Possession of Aadhaar",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/G",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                ]
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            ];

            return response()->json(['statusCode' => 200, 'data' => $data]);
        }
        $client_ref_number = $request->client_ref_num;
        $identity_type = $request->identifier_type;
        $dob = $request->dob;
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return $api_id;
                $url = 'https://api.digitap.ai/ckyc/v1/search';

                $data = [
                    'client_ref_num' => $client_ref_number,
                    'identifier' => $panno,
                    'identifier_type' => $identity_type,
                ];

                $body = json_encode($data);

                $ch = curl_init($url);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'Content-Type:application/json']);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $get_data1 = curl_exec($ch);
                $kyccard = json_decode($get_data1, true);
                // Async::run($kyccard);
                // $results = Async::wait();

                if (isset($kyccard['result_code']) && $kyccard['result_code'] == 103) {
                    $kyccarderror = null;

                    $kyccarderror['error']['status'] = 102;
                    $kyccarderror['error']['message'] = $kyccard['error'];
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                        }
                    }
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'dob' => $dob,
                        'status' => 102,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 102, 'response' => $kyccarderror]);
                }

                if (isset($kyccard['result_code']) && $kyccard['result_code'] == 101) {
                    //return $kyccard;
                    $searchkyc = [];
                    $url = 'https://api.digitap.ai/ckyc/v1/download';

                    $data = [
                        'ckyc_id' => $kyccard['result']['ckyc_id'],
                        'auth_factor_type' => "DOB",
                        'client_ref_num' => $kyccard['client_ref_num'],
                        'auth_factor' => $dob,
                    ];

                    $body = json_encode($data);
                    $ch = curl_init($url);
                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'Content-Type:application/json']);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                    $alldata = curl_exec($ch);
                    $allpandata = json_decode($alldata, true);
                    if (isset($allpandata['result_code']) && $allpandata['result_code'] == 101) {
                        $searchkyc['status'] = $allpandata['status'];
                        $searchkyc['kycStatus'] = null;
                        $searchkyc['message'] = 'Details downloaded successfully';
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['constitution_type'] = $allpandata['result']['personal_details']['constitution_type'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['account_type'] = $allpandata['result']['personal_details']['account_type'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['ckyc_no'] = $allpandata['result']['personal_details']['ckyc_no'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['prefix'] = $allpandata['result']['personal_details']['prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['result']['personal_details']['first_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['middleName'] = $allpandata['result']['personal_details']['middle_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['result']['personal_details']['last_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['result']['personal_details']['full_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_prefix'] = $allpandata['result']['personal_details']['maiden_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fname'] = $allpandata['result']['personal_details']['maiden_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_mname'] = $allpandata['result']['personal_details']['maiden_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_lname'] = $allpandata['result']['personal_details']['maiden_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fullname'] = $allpandata['result']['personal_details']['maiden_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_or_spouse_flag'] = $allpandata['result']['personal_details']['father_or_spouse_flag'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_prefix'] = $allpandata['result']['personal_details']['father_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fname'] = $allpandata['result']['personal_details']['father_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_mname'] = $allpandata['result']['personal_details']['father_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_lname'] = $allpandata['result']['personal_details']['father_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fullname'] = $allpandata['result']['personal_details']['father_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_prefix'] = $allpandata['result']['personal_details']['mother_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fname'] = $allpandata['result']['personal_details']['mother_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_mname'] = $allpandata['result']['personal_details']['mother_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_lname'] = $allpandata['result']['personal_details']['mother_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fullname'] = $allpandata['result']['personal_details']['mother_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = '+' . $allpandata['result']['personal_details']['mob_code'] . $allpandata['result']['personal_details']['mob_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan'] = $allpandata['result']['personal_details']['pan'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['result']['personal_details']['email'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['result']['personal_details']['dob'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['age'] = $kyccard['result']['age'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender'] = $allpandata['result']['personal_details']['gender'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'] = $allpandata['result']['personal_details']['perm_line1'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'] = $allpandata['result']['personal_details']['perm_line2'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_line3'] = $allpandata['result']['personal_details']['perm_line3'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'] = $allpandata['result']['personal_details']['perm_city'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'] = $allpandata['result']['personal_details']['perm_dist'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permState'] = $allpandata['result']['personal_details']['perm_state'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'] = $allpandata['result']['personal_details']['perm_pin'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCountry'] = $allpandata['result']['personal_details']['perm_country'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPoa'] = $allpandata['result']['personal_details']['perm_poa'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_corres_sameflag'] = $allpandata['result']['personal_details']['perm_corres_sameflag'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'] = $allpandata['result']['personal_details']['corres_line1'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'] = $allpandata['result']['personal_details']['corres_line2'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corres_line3'] = $allpandata['result']['personal_details']['corres_line3'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'] = $allpandata['result']['personal_details']['corres_city'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'] = $allpandata['result']['personal_details']['corres_dist'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'] = $allpandata['result']['personal_details']['corres_state'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCountry'] = $allpandata['result']['personal_details']['corres_country'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPoa'] = $allpandata['result']['personal_details']['corres_poa'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'] = $allpandata['result']['personal_details']['corres_pin'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_std_code'] = $allpandata['result']['personal_details']['resi_std_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_tel_num'] = $allpandata['result']['personal_details']['resi_tel_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_tel_num'] = $allpandata['result']['personal_details']['off_tel_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_std_code'] = $allpandata['result']['personal_details']['off_std_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['remarks'] = $allpandata['result']['personal_details']['remarks'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_date'] = $allpandata['result']['personal_details']['dec_date'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_place'] = $allpandata['result']['personal_details']['dec_place'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['doc_sub'] = $allpandata['result']['personal_details']['doc_sub'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_date'] = $kyccard['result']['kyc_date'];

                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_name'] = $allpandata['result']['personal_details']['kyc_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_designation'] = $allpandata['result']['personal_details']['kyc_designation'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_branch'] = $allpandata['result']['personal_details']['kyc_branch'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_empcode'] = $allpandata['result']['personal_details']['kyc_empcode'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_name'] = $allpandata['result']['personal_details']['org_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_code'] = $allpandata['result']['personal_details']['org_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'] = $allpandata['result']['personal_details']['num_identity'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'] = $allpandata['result']['personal_details']['num_related'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'] = $allpandata['result']['personal_details']['num_images'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['related_person_details'] = $allpandata['result']['related_person_details'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['identity_details'] = $allpandata['result']['identity_details'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['image_details'] = $allpandata['result']['image_details'];

                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            if (isset($allpandata['result']['image_details']) && $allpandata['result']['image_details']['image'][0]['sequence_no'] == "1" || $allpandata['result']['image_details']['image'][1]['sequence_no'] == "2" || $allpandata['result']['image_details']['image'][2]['sequence_no'] == "3" || $allpandata['result']['image_details']['image'][3]['sequence_no'] == "4") {

                                $panvalidation = DB::table('search_new')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status' => 200,
                                    'constitution_type' => isset($allpandata['result']['personal_details']['constitution_type']) ? $allpandata['result']['personal_details']['constitution_type'] : null,
                                    'account_type' => isset($allpandata['result']['personal_details']['account_type']) ? $allpandata['result']['personal_details']['account_type'] : null,
                                    'prefix' => isset($allpandata['result']['personal_details']['prefix']) ? $allpandata['result']['personal_details']['prefix'] : null,
                                    'maiden_prefix' => isset($allpandata['result']['personal_details']['maiden_prefix']) ? $allpandata['result']['personal_details']['maiden_prefix'] : null,
                                    'maiden_fname' => isset($allpandata['result']['personal_details']['maiden_fname']) ? $allpandata['result']['personal_details']['maiden_fname'] : null,
                                    'maiden_mname' => isset($allpandata['result']['personal_details']['maiden_mname']) ? $allpandata['result']['personal_details']['maiden_mname'] : null,
                                    'maiden_lname' => isset($allpandata['result']['personal_details']['maiden_lname']) ? $allpandata['result']['personal_details']['maiden_lname'] : null,
                                    'maiden_fullname' => isset($allpandata['result']['personal_details']['maiden_fullname']) ? $allpandata['result']['personal_details']['maiden_fullname'] : null,
                                    'father_prefix' => isset($allpandata['result']['personal_details']['father_prefix']) ? $allpandata['result']['personal_details']['father_prefix'] : null,
                                    'father_fname' => isset($allpandata['result']['personal_details']['father_fname']) ? $allpandata['result']['personal_details']['father_fname'] : null,
                                    'father_mname' => isset($allpandata['result']['personal_details']['father_mname']) ? $allpandata['result']['personal_details']['father_mname'] : null,
                                    'father_lname' => isset($allpandata['result']['personal_details']['father_lname']) ? $allpandata['result']['personal_details']['father_lname'] : null,
                                    'father_fullname' => isset($allpandata['result']['personal_details']['father_fullname']) ? $allpandata['result']['personal_details']['father_fullname'] : null,
                                    'mother_prefix' => isset($allpandata['result']['personal_details']['mother_prefix']) ? $allpandata['result']['personal_details']['mother_prefix'] : null,
                                    'mother_fname' => isset($allpandata['result']['personal_details']['mother_fname']) ? $allpandata['result']['personal_details']['mother_fname'] : null,
                                    'mother_mname' => isset($allpandata['result']['personal_details']['mother_mname']) ? $allpandata['result']['personal_details']['mother_mname'] : null,
                                    'mother_lname' => isset($allpandata['result']['personal_details']['mother_lname']) ? $allpandata['result']['personal_details']['mother_lname'] : null,
                                    'mother_fullname' => isset($allpandata['result']['personal_details']['mother_fullname']) ? $allpandata['result']['personal_details']['mother_fullname'] : null,
                                    'pan_no' => isset($allpandata['result']['personal_details']['pan']) ? $allpandata['result']['personal_details']['pan'] : null,
                                    'ckycid' => isset($allpandata['result']['personal_details']['ckyc_no']) ? $allpandata['result']['personal_details']['ckyc_no'] : null,
                                    'firstname' => isset($allpandata['result']['personal_details']['first_name']) ? $allpandata['result']['personal_details']['first_name'] : null,
                                    'middle_name' => isset($allpandata['result']['personal_details']['middle_name']) ? $allpandata['result']['personal_details']['middle_name'] : null,
                                    'last_name' => isset($allpandata['result']['personal_details']['last_name']) ? $allpandata['result']['personal_details']['last_name'] : null,
                                    'fullname' => isset($allpandata['result']['personal_details']['full_name']) ? $allpandata['result']['personal_details']['full_name'] : null,
                                    'mobilenum' => isset($allpandata['result']['personal_details']['mob_num']) ? $allpandata['result']['personal_details']['mob_num'] : null,
                                    'email' => isset($allpandata['result']['personal_details']['email']) ? $allpandata['result']['personal_details']['email'] : null,
                                    'dob' => isset($allpandata['result']['personal_details']['dob']) ? $allpandata['result']['personal_details']['dob'] : null,
                                    'age' => isset($kyccard['result']['age']) ? $kyccard['result']['age'] : null,
                                    'gender' => isset($allpandata['result']['personal_details']['gender']) ? $allpandata['result']['personal_details']['gender'] : null,
                                    'pstate' => isset($allpandata['result']['personal_details']['perm_state']) ? $allpandata['result']['personal_details']['perm_state'] : null,
                                    'pcity' => isset($allpandata['result']['personal_details']['perm_city']) ? $allpandata['result']['personal_details']['perm_city'] : null,
                                    'permCountry' => isset($allpandata['result']['personal_details']['perm_country']) ? $allpandata['result']['personal_details']['perm_country'] : null,
                                    'permPoa' => isset($allpandata['result']['personal_details']['perm_poa']) ? $allpandata['result']['personal_details']['perm_poa'] : null,
                                    'caddress1' => isset($allpandata['result']['personal_details']['corres_line1']) ? $allpandata['result']['personal_details']['corres_line1'] : null,
                                    'caddress2' => isset($allpandata['result']['personal_details']['corres_line2']) ? $allpandata['result']['personal_details']['corres_line2'] : null,
                                    'caddress3' => isset($allpandata['result']['personal_details']['corres_line3']) ? $allpandata['result']['personal_details']['corres_line3'] : null,
                                    'paddress' => isset($allpandata['result']['personal_details']['permLine1']) ? $allpandata['result']['personal_details']['permLine1'] : null,
                                    'paddress2' => isset($allpandata['result']['personal_details']['permLine2']) ? $allpandata['result']['personal_details']['permLine2'] : null,
                                    'paddress3' => isset($allpandata['result']['personal_details']['perm_line3']) ? $allpandata['result']['personal_details']['perm_line3'] : null,
                                    'perm_corres_sameflag' => isset($allpandata['result']['personal_details']['perm_corres_sameflag']) ? $allpandata['result']['personal_details']['perm_corres_sameflag'] : null,
                                    'cstate' => isset($allpandata['result']['personal_details']['corres_state']) ? $allpandata['result']['personal_details']['corres_state'] : null,
                                    'ccity' => isset($allpandata['result']['personal_details']['corres_city']) ? $allpandata['result']['personal_details']['corres_city'] : null,
                                    'currentpincode' => isset($allpandata['result']['personal_details']['corres_pin']) ? $allpandata['result']['personal_details']['corres_pin'] : null,
                                    'permanantpincode' => isset($allpandata['result']['personal_details']['perm_pin']) ? $allpandata['result']['personal_details']['perm_pin'] : null,
                                    'branch_code1' => isset($allpandata['result']['image_details']['image'][0]['branch_code']) ? $allpandata['result']['image_details']['image'][0]['branch_code'] : null,
                                    'branch_code2' => isset($allpandata['result']['image_details']['image'][1]['branch_code']) ? $allpandata['result']['image_details']['image'][1]['branch_code'] : null,
                                    'branch_code3' => isset($allpandata['result']['image_details']['image'][2]['branch_code']) ? $allpandata['result']['image_details']['image'][2]['branch_code'] : null,
                                    'branch_code4' => isset($allpandata['result']['image_details']['image'][3]['branch_code']) ? $allpandata['result']['image_details']['image'][3]['branch_code'] : null,
                                    'resi_std_code' => isset($allpandata['result']['personal_details']['resi_std_code']) ? $allpandata['result']['personal_details']['resi_std_code'] : null,
                                    'resi_tel_num' => isset($allpandata['result']['personal_details']['resi_tel_num']) ? $allpandata['result']['personal_details']['resi_tel_num'] : null,
                                    'off_std_code' => isset($allpandata['result']['personal_details']['off_std_code']) ? $allpandata['result']['personal_details']['off_std_code'] : null,
                                    'remarks' => isset($allpandata['result']['personal_details']['remarks']) ? $allpandata['result']['personal_details']['remarks'] : null,
                                    'father_or_spouse_flag' => isset($allpandata['result']['personal_details']['father_or_spouse_flag']) ? $allpandata['result']['personal_details']['father_or_spouse_flag'] : null,
                                    'dec_date' => isset($allpandata['result']['personal_details']['dec_date']) ? $allpandata['result']['personal_details']['dec_date'] : null,
                                    'dec_place' => isset($allpandata['result']['personal_details']['dec_place']) ? $allpandata['result']['personal_details']['dec_place'] : null,
                                    'doc_sub' => isset($allpandata['result']['personal_details']['doc_sub']) ? $allpandata['result']['personal_details']['doc_sub'] : null,
                                    'kyc_date' => isset($kyccard['result']['kyc_date']) ? $kyccard['result']['kyc_date'] : null,
                                    'kyc_name' => isset($allpandata['result']['personal_details']['kyc_name']) ? $allpandata['result']['personal_details']['kyc_name'] : null,
                                    'kyc_designation' => isset($allpandata['result']['personal_details']['kyc_designation']) ? $allpandata['result']['personal_details']['kyc_designation'] : null,
                                    'kyc_branch' => isset($allpandata['result']['personal_details']['kyc_branch']) ? $allpandata['result']['personal_details']['kyc_branch'] : null,
                                    'kyc_empcode' => isset($allpandata['result']['personal_details']['kyc_empcode']) ? $allpandata['result']['personal_details']['kyc_empcode'] : null,
                                    'org_name' => isset($allpandata['result']['personal_details']['org_name']) ? $allpandata['result']['personal_details']['org_name'] : null,
                                    'org_code' => isset($allpandata['result']['personal_details']['org_code']) ? $allpandata['result']['personal_details']['org_code'] : null,
                                    'image_url1' => isset($allpandata['result']['image_details']['image'][0]['image_url']) ? $allpandata['result']['image_details']['image'][0]['image_url'] : null,
                                    'image_url2' => isset($allpandata['result']['image_details']['image'][1]['image_url']) ? $allpandata['result']['image_details']['image'][1]['image_url'] : null,
                                    'image_url3' => isset($allpandata['result']['image_details']['image'][2]['image_url']) ? $allpandata['result']['image_details']['image'][2]['image_url'] : null,
                                    'image_url4' => isset($allpandata['result']['image_details']['image'][3]['image_url']) ? $allpandata['result']['image_details']['image'][3]['image_url'] : null,
                                    'image_code1' => isset($allpandata['result']['image_details']['image'][0]['image_code']) ? $allpandata['result']['image_details']['image'][0]['image_code'] : null,
                                    'image_code2' => isset($allpandata['result']['image_details']['image'][1]['image_code']) ? $allpandata['result']['image_details']['image'][1]['image_code'] : null,
                                    'image_code3' => isset($allpandata['result']['image_details']['image'][2]['image_code']) ? $allpandata['result']['image_details']['image'][2]['image_code'] : null,
                                    'image_code4' => isset($allpandata['result']['image_details']['image'][3]['image_code']) ? $allpandata['result']['image_details']['image'][3]['image_code'] : null,
                                    'image_data1' => isset($allpandata['result']['image_details']['image'][0]['image_data']) ? $allpandata['result']['image_details']['image'][0]['image_data'] : null,
                                    'image_data2' => isset($allpandata['result']['image_details']['image'][1]['image_data']) ? $allpandata['result']['image_details']['image'][1]['image_data'] : null,
                                    'image_data3' => isset($allpandata['result']['image_details']['image'][2]['image_data']) ? $allpandata['result']['image_details']['image'][2]['image_data'] : null,
                                    'image_data4' => isset($allpandata['result']['image_details']['image'][3]['image_data']) ? $allpandata['result']['image_details']['image'][3]['image_data'] : null,
                                    'ident_type1' => isset($allpandata['result']['identity_details']['identity'][0]['ident_type']) ? $allpandata['result']['identity_details']['identity'][0]['ident_type'] : null,
                                    'ident_type2' => isset($allpandata['result']['identity_details']['identity'][1]['ident_type']) ? $allpandata['result']['identity_details']['identity'][1]['ident_type'] : null,
                                    'ident_type3' => isset($allpandata['result']['identity_details']['identity'][2]['ident_type']) ? $allpandata['result']['identity_details']['identity'][2]['ident_type'] : null,
                                    'ident_type4' => isset($allpandata['result']['identity_details']['identity'][3]['ident_type']) ? $allpandata['result']['identity_details']['identity'][3]['ident_type'] : null,
                                    'ident_num1' => isset($allpandata['result']['identity_details']['identity'][0]['ident_num']) ? $allpandata['result']['identity_details']['identity'][0]['ident_num'] : null,
                                    'ident_num2' => isset($allpandata['result']['identity_details']['identity'][1]['ident_num']) ? $allpandata['result']['identity_details']['identity'][1]['ident_num'] : null,
                                    'ident_num3' => isset($allpandata['result']['identity_details']['identity'][2]['ident_num']) ? $allpandata['result']['identity_details']['identity'][2]['ident_num'] : null,
                                    'ident_num4' => isset($allpandata['result']['identity_details']['identity'][3]['ident_num']) ? $allpandata['result']['identity_details']['identity'][3]['ident_num'] : null,
                                    'idver_status1' => isset($allpandata['result']['identity_details']['identity'][0]['idver_status']) ? $allpandata['result']['identity_details']['identity'][0]['idver_status'] : null,
                                    'idver_status2' => isset($allpandata['result']['identity_details']['identity'][1]['idver_status']) ? $allpandata['result']['identity_details']['identity'][1]['idver_status'] : null,
                                    'idver_status3' => isset($allpandata['result']['identity_details']['identity'][2]['idver_status']) ? $allpandata['result']['identity_details']['identity'][2]['idver_status'] : null,
                                    'idver_status4' => isset($allpandata['result']['identity_details']['identity'][3]['idver_status']) ? $allpandata['result']['identity_details']['identity'][3]['idver_status'] : null,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);

                            }

                        }
                        return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                    } elseif (isset($allpandata['status']) && $allpandata['status'] == 'INVALID') {
                        if ($user->role_id == 1) {
                            $statusCode = 102;
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            // return 'insert';
                            $panvalidation = DB::table('search_new')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'dob' => $dob,
                                'status' => 102,
                                'pan_no' => $request->pano,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        $searchkyc['status'] = $allpandata['status'];
                        $searchkyc['error'] = $allpandata['error'];
                        return response()->json(['statusCode' => 102, 'response' => $searchkyc]);
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                            }
                        }
                        $panvalidation = DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'dob' => $dob,
                            'status' => 202,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                        return response()->json(['statusCode' => 202, 'response' => $allpandata]);
                    }
                    // return response()->json(json_decode($alldata,true));
                    // return response()->json(['statusCode'=>200, 'response'=>$allpandata]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                        }
                    }
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'status' => 201,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 201, 'response' => $kyccard]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function bhunaksha(Request $request)
    {
        $statusCode = null;
        $bhunakash = null;
        $api_id = null;
        if (empty($request->has('state'))) {
            return response()->json([['status_code' => '404', 'message' => 'state is required',]]);
        }
        if (!empty($request->state) && $request->get('state') == "bihar") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Subdiv'))) {
                return response()->json([['message' => 'subdiv is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Circle'))) {
                return response()->json([['message' => 'Circle is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Mauza'))) {
                return response()->json([['message' => 'mauza is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Surveytype'))) {
                return response()->json([['message' => 'surveytype is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Mapinstance'))) {
                return response()->json([['message' => 'mapinstance is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('sheetno'))) {
                return response()->json([['message' => 'surveytype is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Plotno'))) {
                return response()->json([['message' => 'plot number is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/biharplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Subdiv" => $request->Subdiv,
                            "Circle" => $request->Circle,
                            "Mauza" => $request->Mauza,
                            "Surveytype" => $request->Surveytype,
                            "Mapinstance" => $request->Mapinstance,
                            "sheetno" => $request->sheetno,
                            "Plotno" => $request->Plotno
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $statusCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                    $response = curl_exec($curl);
                    curl_close($curl);
                    $bihar = json_decode($response, true);
                    $bihar_info = null;
                    if (isset($bihar['statuscode']) && $bihar['statuscode'] == 200) {
                        $bihar_info['Giscode'] = isset($bihar['Giscode']) ? $bihar['Giscode'] : null;
                        $bihar_info['Plotinfo'] = isset($bihar['Plotinfo']) ? $bihar['Plotinfo'] : null;
                        $bihar_info['Plotno'] = isset($bihar['Plotno']) ? $bihar['Plotno'] : null;

                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_bihar = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($bihar['Giscode']) ? $bihar['Giscode'] : null,
                                    'Plotinfo' => isset($bihar['Plotinfo']) ? $bihar['Plotinfo'] : null,
                                    'Plotno' => isset($bihar['Plotno']) ? $bihar['Plotno'] : null,
                                    'status_code' => 200,
                                    'message_code' => 'success',
                                    'state' => 'bihar',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $bihar_info]);

                    } elseif (isset($bihar['statuscode']) && $bihar['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $bihar['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_bihar = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'message_code' => 'failed',
                                    'state' => 'bihar',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_bihar = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'state' => 'bihar',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet amount.']);
                }

            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        } elseif (!empty($request->state) && $request->get('state') == "chhattisgarh") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Tehsil'))) {
                return response()->json([['message' => 'tehsil is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Ri'))) {
                return response()->json([['message' => 'Ri is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Village'))) {
                return response()->json([['message' => 'village is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Plotno'))) {
                return response()->json([['message' => 'plot number is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/chhattisgarhplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Tehsil" => $request->Tehsil,
                            "Ri" => $request->Ri,
                            "Village" => $request->Village,
                            "Plotno" => $request->Plotno
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $response = curl_exec($curl);
                    $chatishgrah = json_decode($response, true);
                    $chatishgrah_info = null;
                    if (isset($chatishgrah['statuscode']) && $chatishgrah['statuscode'] == 200) {
                        $chatishgrah_info['Giscode'] = isset($chatishgrah['Giscode']) ? $chatishgrah['Giscode'] : null;
                        $chatishgrah_info['Plotinfo'] = isset($chatishgrah['Plotinfo']) ? $chatishgrah['Plotinfo'] : null;
                        $chatishgrah_info['Plotno'] = isset($chatishgrah['Plotno']) ? $chatishgrah['Plotno'] : null;
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_chatishgrah = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($chatishgrah['Giscode']) ? $chatishgrah['Giscode'] : null,
                                    'Plotinfo' => isset($chatishgrah['Plotinfo']) ? $chatishgrah['Plotinfo'] : null,
                                    'Plotno' => isset($chatishgrah['Plotno']) ? $chatishgrah['Plotno'] : null,
                                    'status_code' => 200,
                                    'message_code' => 'success',
                                    'state' => 'chatishgrah',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $chatishgrah_info]);
                    } elseif (isset($chatishgrah['statuscode']) && $chatishgrah['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $chatishgrah['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_chatishgrah = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'state' => 'chatishgrah',
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_chatishgrah = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'state' => 'chatishgrah',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet amount.']);
                }

            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }

        } elseif (!empty($request->state) && $request->get('state') == "up") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Tehsil'))) {
                return response()->json([['message' => 'tehsil is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Village'))) {
                return response()->json([['message' => 'village is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Plotno'))) {
                return response()->json([['message' => 'plot number is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/upplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Tehsil" => $request->Tehsil,
                            "Village" => $request->Village,
                            "Plotno" => $request->Plotno
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $response = curl_exec($curl);
                    $up_details = json_decode($response, true);
                    $up_details_info = null;
                    if (isset($up_details['statuscode']) && $up_details['statuscode'] == 200) {
                        $up_details_info['Giscode'] = isset($up_details['Giscode']) ? $up_details['Giscode'] : null;
                        $up_details_info['Plotinfo'] = isset($up_details['Plotinfo']) ? $up_details['Plotinfo'] : null;
                        $up_details_info['Plotno'] = isset($up_details['Plotno']) ? $up_details['Plotno'] : null;
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_up = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($up_details['Giscode']) ? $up_details['Giscode'] : null,
                                    'Plotinfo' => isset($up_details['Plotinfo']) ? $up_details['Plotinfo'] : null,
                                    'Plotno' => isset($up_details['Plotno']) ? $up_details['Plotno'] : null,
                                    'status_code' => 200,
                                    'state' => 'up',
                                    'message_code' => 'success',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $up_details_info]);
                    } elseif (isset($up_details['statuscode']) && $up_details['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $up_details['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_up = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'message_code' => 'failed',
                                    'state' => 'up',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_up = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'state' => 'up',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet.']);
                }

            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        } elseif (!empty($request->state) && $request->get('state') == "kerala") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Taluk'))) {
                return response()->json([['message' => 'taluk is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Village'))) {
                return response()->json([['message' => 'village is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Blockno'))) {
                return response()->json([['message' => 'blockno is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Surveyno'))) {
                return response()->json([['message' => 'surveyno is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Subdivno'))) {
                return response()->json([['message' => 'subdivno is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/keralaplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Taluk" => $request->Taluk,
                            "Village" => $request->Village,
                            "Blockno" => $request->Blockno,
                            "Surveyno" => $request->Surveyno,
                            "Subdivno" => $request->Subdivno,
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $response = curl_exec($curl);
                    $kerala_details = json_decode($response, true);
                    $kerala_info = null;
                    if (isset($kerala_details['statuscode']) && $kerala_details['statuscode'] == 200) {
                        $kerala_info['Giscode'] = isset($kerala_details['Giscode']) ? $kerala_details['Giscode'] : null;
                        $kerala_info['Plotinfo'] = isset($kerala_details['Plotinfo']) ? $kerala_details['Plotinfo'] : null;
                        $kerala_info['Plotno'] = isset($kerala_details['Plotno']) ? $kerala_details['Plotno'] : null;
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_kerala = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($kerala_details['Giscode']) ? $kerala_details['Giscode'] : null,
                                    'area_details' => isset($kerala_details['Plotinfo']['Area_details']) ? $kerala_details['Plotinfo']['Area_details'] : null,
                                    'owner_details' => isset($kerala_details['Plotinfo']['Owner_details']) ? $kerala_details['Plotinfo']['Owner_details'] : null,
                                    'remark' => isset($kerala_details['Plotinfo']['Remark']) ? $kerala_details['Plotinfo']['Remark'] : null,
                                    'Plotno' => isset($kerala_details['Plotno']) ? $kerala_details['Plotno'] : null,
                                    'status_code' => 200,
                                    'message_code' => 'success',
                                    'state' => 'kerala',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $kerala_info]);
                    } elseif (isset($kerala_details['statuscode']) && $kerala_details['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $kerala_details['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_kerala = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'message_code' => 'failed',
                                    'state' => 'kerala',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_kerala = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'state' => 'kerala',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet.']);
                }

            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }

        } elseif (!empty($request->state) && $request->get('state') == "lakshadweep") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Taluk'))) {
                return response()->json([['message' => 'taluk is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Survey'))) {
                return response()->json([['message' => 'survey is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Village'))) {
                return response()->json([['message' => 'village is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Plotno'))) {
                return response()->json([['message' => 'plot number is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/lakshadweepplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Taluk" => $request->Taluk,
                            "Village" => $request->Village,
                            "Survey" => $request->Survey,
                            "Plotno" => $request->Plotno,
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $response = curl_exec($curl);
                    $lakshadweep_details = json_decode($response, true);
                    $lakshadweep_info = null;
                    if (isset($lakshadweep_details['statuscode']) && $lakshadweep_details['statuscode'] == 200) {
                        $lakshadweep_info['Giscode'] = isset($lakshadweep_details['Giscode']) ? $lakshadweep_details['Giscode'] : null;
                        $lakshadweep_info['Plotinfo'] = isset($lakshadweep_details['Plotinfo']) ? $lakshadweep_details['Plotinfo'] : null;
                        $lakshadweep_info['Plotno'] = isset($lakshadweep_details['Plotno']) ? $lakshadweep_details['Plotno'] : null;
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_lakshadweep = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($lakshadweep_details['Giscode']) ? $lakshadweep_details['Giscode'] : null,
                                    'Plotinfo' => isset($lakshadweep_details['Plotinfo']) ? $lakshadweep_details['Plotinfo'] : null,
                                    'Plotno' => isset($lakshadweep_details['Plotno']) ? $lakshadweep_details['Plotno'] : null,
                                    'status_code' => 200,
                                    'message_code' => 'success',
                                    'state' => 'lakshadweep',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $lakshadweep_info]);
                    } elseif (isset($lakshadweep_details['statuscode']) && $lakshadweep_details['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $lakshadweep_details['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_lakshadweep = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'message_code' => 'failed',
                                    'state' => 'lakshadweep',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_lakshadweep = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'state' => 'lakshadweep',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet.']);
                }

            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        } elseif (!empty($request->state) && $request->get('state') == "rajasthan") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Tehsil'))) {
                return response()->json([['message' => 'tehsil is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Ri'))) {
                return response()->json([['message' => 'ri is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Halkas'))) {
                return response()->json([['message' => 'Halkas is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Village'))) {
                return response()->json([['message' => 'village is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Sheetno'))) {
                return response()->json([['message' => 'sheetno is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Plotno'))) {
                return response()->json([['message' => 'plot number is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/rajasthanplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Tehsil" => $request->Tehsil,
                            "Ri" => $request->Ri,
                            "Halkas" => $request->Halkas,
                            "Village" => $request->Village,
                            "Sheetno" => $request->Sheetno,
                            "Plotno" => $request->Plotno,
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $response = curl_exec($curl);
                    $rajasthan = json_decode($response, true);
                    $rajasthan_info = null;
                    if (isset($rajasthan['statuscode']) && $rajasthan['statuscode'] == 200) {
                        $rajasthan_info['Giscode'] = isset($rajasthan['Giscode']) ? $rajasthan['Giscode'] : null;
                        $rajasthan_info['Plotinfo'] = isset($rajasthan['Plotinfo']) ? $rajasthan['Plotinfo'] : null;
                        $rajasthan_info['Plotno'] = isset($rajasthan['Plotno']) ? $rajasthan['Plotno'] : null;
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_rajasthan = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($rajasthan['Giscode']) ? $rajasthan['Giscode'] : null,
                                    'Plotinfo' => isset($rajasthan['Plotinfo']) ? $rajasthan['Plotinfo'] : null,
                                    'Plotno' => isset($rajasthan['Plotno']) ? $rajasthan['Plotno'] : null,
                                    'status_code' => 200,
                                    'message_code' => 'success',
                                    'state' => 'rajasthan',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $rajasthan_info]);
                    } elseif (isset($rajasthan['statuscode']) && $rajasthan['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $rajasthan['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_rajasthan = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'message_code' => 'failed',
                                    'state' => 'rajasthan',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_rajasthan = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'state' => 'rajasthan',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet.']);
                }

            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        } elseif (!empty($request->state) && $request->get('state') == "goa") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Taluka'))) {
                return response()->json([['message' => 'taluka is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Sheetno'))) {
                return response()->json([['message' => 'sheetno is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Village'))) {
                return response()->json([['message' => 'village is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Plotno'))) {
                return response()->json([['message' => 'plot number is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/goaplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Taluka" => $request->Taluka,
                            "Village" => $request->Village,
                            "Sheetno" => $request->Sheetno,
                            "Plotno" => $request->Plotno,
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $response = curl_exec($curl);
                    $goa_details = json_decode($response, true);
                    $goa_info = null;
                    if (isset($goa_details['statuscode']) && $goa_details['statuscode'] == 200) {
                        $goa_info['Giscode'] = isset($goa_details['Giscode']) ? $goa_details['Giscode'] : null;
                        $goa_info['Plotinfo'] = isset($goa_details['Plotinfo']) ? $goa_details['Plotinfo'] : null;
                        $goa_info['Plotno'] = isset($goa_details['Plotno']) ? $goa_details['Plotno'] : null;
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_goa = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($goa_details['Giscode']) ? $goa_details['Giscode'] : null,
                                    'Plotinfo' => isset($goa_details['Plotinfo']) ? $goa_details['Plotinfo'] : null,
                                    'Plotno' => isset($goa_details['Plotno']) ? $goa_details['Plotno'] : null,
                                    'status_code' => 200,
                                    'state' => 'goa',
                                    'message_code' => 'success',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $goa_info]);
                    } elseif (isset($goa_details['statuscode']) && $goa_details['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $goa_details['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_goa = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'message_code' => 'failed',
                                    'state' => 'goa',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_goa = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'state' => 'goa',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet.']);
                }

            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }

        } elseif (!empty($request->state) && $request->get('state') == "jharkhand") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Halka'))) {
                return response()->json([['message' => 'halka is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Circle'))) {
                return response()->json([['message' => 'Circle is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Mauza'))) {
                return response()->json([['message' => 'mauza is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Sheetno'))) {
                return response()->json([['message' => 'sheetno is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Plotno'))) {
                return response()->json([['message' => 'plot number is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/jharkhandplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Circle" => $request->Circle,
                            "Halka" => $request->Halka,
                            "Mauza" => $request->Mauza,
                            "Sheetno" => $request->Sheetno,
                            "Plotno" => $request->Plotno,
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $response = curl_exec($curl);
                    $jharkhand = json_decode($response, true);
                    $jharkhand_info = null;
                    if (isset($jharkhand['statuscode']) && $jharkhand['statuscode'] == 200) {
                        $jharkhand_info['Giscode'] = isset($jharkhand['Giscode']) ? $jharkhand['Giscode'] : null;
                        $jharkhand_info['Plotinfo'] = isset($jharkhand['Plotinfo']) ? $jharkhand['Plotinfo'] : null;
                        $jharkhand_info['Plotno'] = isset($jharkhand['Plotno']) ? $jharkhand['Plotno'] : null;
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_jharkhand = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($jharkhand['Giscode']) ? $jharkhand['Giscode'] : null,
                                    'Plotinfo' => isset($jharkhand['Plotinfo']) ? $jharkhand['Plotinfo'] : null,
                                    'Plotno' => isset($jharkhand['Plotno']) ? $jharkhand['Plotno'] : null,
                                    'status_code' => 200,
                                    'message_code' => 'success',
                                    'state' => 'jharkhand',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $jharkhand_info]);
                    } elseif (isset($jharkhand['statuscode']) && $jharkhand['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $jharkhand['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_jharkhand = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'message_code' => 'failed',
                                    'state' => 'jharkhand',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_jharkhand = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'state' => 'jharkhand',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet.']);
                }
            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        } elseif (!empty($request->state) && $request->get('state') == "odisha") {

            if (empty($request->has('District'))) {
                return response()->json([['message' => 'district is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Tehsil'))) {
                return response()->json([['message' => 'tehsil is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Ri'))) {
                return response()->json([['message' => 'Ri is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Village'))) {
                return response()->json([['message' => 'village is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Sheetno'))) {
                return response()->json([['message' => 'sheetno is required', 'statusCode' => '404']]);
            }
            if (empty($request->has('Plotno'))) {
                return response()->json([['message' => 'plot number is required', 'statusCode' => '404']]);
            }
            if (!$request->headers->has('AccessToken')) {
                return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
            }
            $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
            if ($verifyAccessToken == false) {
                return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
            }
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apiamster = ApiMaster::where('api_slug', 'bhunaksha')->first();
                if ($apiamster) {
                    $api_id = $apiamster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            if ($updateHitCount || $user->role_id == 0) {
                if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                    $curl = curl_init();
                    curl_setopt_array($curl, array(
                        CURLOPT_URL => 'http://pyn.regtechapi.in/odishaplotinfo',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_ENCODING => '',
                        CURLOPT_MAXREDIRS => 10,
                        CURLOPT_TIMEOUT => 0,
                        CURLOPT_FOLLOWLOCATION => true,
                        CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_POSTFIELDS => json_encode(array(
                            "District" => $request->District,
                            "Tehsil" => $request->Tehsil,
                            "Ri" => $request->Ri,
                            "Village" => $request->Village,
                            "Sheetno" => $request->Sheetno,
                            "Plotno" => $request->Plotno,
                        )),
                        CURLOPT_HTTPHEADER => array(
                            'Content-Type: application/json'
                        ),
                    ));
                    $response = curl_exec($curl);
                    $odisha = json_decode($response, true);
                    $odisha_info = null;
                    if (isset($odisha['statuscode']) && $odisha['statuscode'] == 200) {
                        $odisha_info['Giscode'] = isset($odisha['Giscode']) ? $odisha['Giscode'] : null;
                        $odisha_info['Plotinfo'] = isset($odisha['Plotinfo']) ? $odisha['Plotinfo'] : null;
                        $odisha_info['Plotno'] = isset($odisha['Plotno']) ? $odisha['Plotno'] : null;
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                $bhunakasha_odisha = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'Giscode' => isset($odisha['Giscode']) ? $odisha['Giscode'] : null,
                                    'Plotinfo' => isset($odisha['Plotinfo']) ? $odisha['Plotinfo'] : null,
                                    'Plotno' => isset($odisha['Plotno']) ? $odisha['Plotno'] : null,
                                    'status_code' => 200,
                                    'state' => 'odisha',
                                    'message_code' => 'success',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 200, 'data' => $odisha_info]);
                    } elseif (isset($odisha['statuscode']) && $odisha['statuscode'] == 404) {
                        $statusCode = 202;
                        $errorMessage = $odisha['error_message'];
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_jharkhand = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 202,
                                    'state' => 'odisha',
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1 || $user->role_id == 0) {
                            if ($user->role_id == 1) {
                                if ($apiamster) {
                                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                                }
                                $bhunakasha_odisha = DB::table('bhunaksha')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'state' => 'odisha',
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }

                        }
                        return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                    }
                } else {
                    return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet.']);
                }
            } else {
                return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        } else {
            return response()->json(['status_code' => 103, 'message' => 'Please enter valid state name']);
        }

    }
    public function udyam_details(Request $request)
    {
        $statusCode = null;
        $udayam_details = null;
        $api_id = null;
        if (empty($request->has('UdyamRegNumber'))) {
            return response()->json([['message' => 'UdyamRegNumber is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'udyamsearch')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/getudyamdetails',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode(array(
                        "UdyamRegNumber" => $request->UdyamRegNumber,
                    )),
                    CURLOPT_HTTPHEADER => array(
                        'Content-Type: application/json'
                    ),
                ));
                $response = curl_exec($curl);
                $udyamdetails = json_decode($response, true);
                // return   $udyamdetails;
                $udyamdetails_response = null;
                if (isset($udyamdetails['statuscode']) && $udyamdetails['statuscode'] == 200) {
                    $udyamdetails_response['essentials']["udyamNumber"] = $udyamdetails["Organization_details"]["Udyam Registration Number"];
                    $udyamdetails_response["id"] = null;
                    $udyamdetails_response["patronId"] = null;
                    $udyamdetails_response["result"]["generalInfo"]["udyamRegistrationNumber"] = $udyamdetails["Organization_details"]["Udyam Registration Number"];
                    $udyamdetails_response["result"]["generalInfo"]["gender"] = $udyamdetails["Organization_details"]["Gender"];
                    $udyamdetails_response["result"]["generalInfo"]["majorActivity"] = $udyamdetails["Organization_details"]["Major Activity"];
                    $udyamdetails_response["result"]["generalInfo"]["nameOfEnterprise"] = $udyamdetails["Organization_details"]["Name of Enterprise"];
                    $udyamdetails_response["result"]["generalInfo"]["organisationType"] = $udyamdetails["Organization_details"]["Organisation Type"];
                    $udyamdetails_response["result"]["generalInfo"]["socialCategory"] = $udyamdetails["Organization_details"]["Social Category"];
                    $udyamdetails_response["result"]["generalInfo"]["dateOfIncorporation"] = $udyamdetails["Organization_details"]["Date of Incorporation"];
                    $udyamdetails_response["result"]["generalInfo"]["dateOfCommencementOfProductionBusiness"] = $udyamdetails["Organization_details"]["Date of Commencement of Business"];
                    $udyamdetails_response["result"]["generalInfo"]["dic"] = null;
                    $udyamdetails_response["result"]["generalInfo"]["msmedi"] = null;
                    $udyamdetails_response["result"]["generalInfo"]["dateOfUdyamRegistration"] = null;
                    $udyamdetails_response["result"]["generalInfo"]["typeOfEnterprise"] = null;
                    $udyamdetails_response["result"]["enterpriseType"][0]['dataYear'] = null;
                    $udyamdetails_response["result"]["enterpriseType"][0]['classificationYear'] = $udyamdetails["Organization_details"]["Enterprise Classification"][0]['Classification Year'];
                    $udyamdetails_response["result"]["enterpriseType"][0]['enterpriseType'] = $udyamdetails["Organization_details"]["Enterprise Classification"][0]['Enterprise Type'];
                    $udyamdetails_response["result"]["enterpriseType"][0]['classificationDate'] = $udyamdetails["Organization_details"]["Enterprise Classification"][0]['Classification Date'];
                    $udyamdetails_response["result"]["enterpriseType"][0]['sn'] = $udyamdetails["Organization_details"]["Enterprise Classification"][0]['SNo'];
                    $udyamdetails_response["result"]["unitsDetails"][0]['sn'] = null;
                    $udyamdetails_response["result"]["unitsDetails"][0]['unitName'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Unit Name"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['flat'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Flat/Door/Block No"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['building'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Name of Premises/Building"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['villageTown'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Village/Town"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['block'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Block"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['road'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Road/Street/Lane"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['city'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["City"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['pin'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Pin"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['state'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["State"];
                    $udyamdetails_response["result"]["unitsDetails"][0]['district'] = $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["District"];
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['flatDoorBlockNo'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['nameOfPremisesBuilding'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['villageTown'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['block'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['roadStreetLane'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['city'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['state'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['pin'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['district'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['mobile'] = null;
                    $udyamdetails_response["result"]["officialAddressOfEnterprise"]['email'] = null;
                    $udyamdetails_response["result"]["nationalIndustryClassificationCodes"][0]['nic2Digit'] = null;
                    $udyamdetails_response["result"]["nationalIndustryClassificationCodes"][0]['nic4Digit'] = null;
                    $udyamdetails_response["result"]["nationalIndustryClassificationCodes"][0]['nic5Digit'] = null;
                    $udyamdetails_response["result"]["nationalIndustryClassificationCodes"][0]['activity'] = null;
                    $udyamdetails_response["result"]["nationalIndustryClassificationCodes"][0]['date'] = null;
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $udyam_database = DB::table('udyamsearch')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'udyam_number' => isset($udyamdetails["Organization_details"]["Udyam Registration Number"]) ? $udyamdetails["Organization_details"]["Udyam Registration Number"] : null,
                            'dateOfCommencementOfProductionBusiness' => isset($udyamdetails["Organization_details"]["Date of Commencement of Business"]) ? $udyamdetails["Organization_details"]["Date of Commencement of Business"] : null,
                            'date_of_incorporation' => isset($udyamdetails["Organization_details"]["Date of Incorporation"]) ? $udyamdetails["Organization_details"]["Date of Incorporation"] : null,
                            'classificationDate' => isset($udyamdetails["Organization_details"]["Enterprise Classification"][0]["Classification Date"]) ? $udyamdetails["Organization_details"]["Enterprise Classification"][0]["Classification Date"] : null,
                            'classificationYear' => isset($udyamdetails["Organization_details"]["Enterprise Classification"][0]["Classification Year"]) ? $udyamdetails["Organization_details"]["Enterprise Classification"][0]["Classification Year"] : null,
                            'typeOfEnterprise' => isset($udyamdetails["Organization_details"]["Enterprise Classification"][0]["Enterprise Type"]) ? $udyamdetails["Organization_details"]["Enterprise Classification"][0]["Enterprise Type"] : null,
                            'sn' => isset($udyamdetails["Organization_details"]["Enterprise Classification"][0]["SNo"]) ? $udyamdetails["Organization_details"]["Enterprise Classification"][0]["SNo"] : null,
                            'gender' => isset($udyamdetails["Organization_details"]["Gender"]) ? $udyamdetails["Organization_details"]["Gender"] : null,
                            'major_activity' => isset($udyamdetails["Organization_details"]["Major Activity"]) ? $udyamdetails["Organization_details"]["Major Activity"] : null,
                            'name_of_enterprise' => isset($udyamdetails["Organization_details"]["Name of Enterprise"]) ? $udyamdetails["Organization_details"]["Name of Enterprise"] : null,
                            'organisation_type' => isset($udyamdetails["Organization_details"]["Organisation Type"]) ? $udyamdetails["Organization_details"]["Organisation Type"] : null,
                            'social_category' => isset($udyamdetails["Organization_details"]["Social Category"]) ? $udyamdetails["Organization_details"]["Social Category"] : null,
                            'udyam_registration_number' => isset($udyamdetails["Organization_details"]["Udyam Registration Number"]) ? $udyamdetails["Organization_details"]["Udyam Registration Number"] : null,
                            'block' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Block"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Block"] : null,
                            'city' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["City"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["City"] : null,
                            'district' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["District"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["District"] : null,
                            'FlatDoorBlockNo' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Flat/Door/Block No"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Flat/Door/Block No"] : null,
                            'NameOfPremisesBuilding' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Name of Premises/Building"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Name of Premises/Building"] : null,
                            'pin' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Pin"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Pin"] : null,
                            'roadStreetLane' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Road/Street/Lane"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Road/Street/Lane"] : null,
                            'state' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["State"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["State"] : null,
                            'unit_name' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Unit Name"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Unit Name"] : null,
                            'villageTown' => isset($udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Village/Town"]) ? $udyamdetails["Organization_details"]["Unit/Plant Locations"][0]["Village/Town"] : null,
                            'status_code' => 200,
                            'message' => "success",
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'response' => $udyamdetails_response]);
                } elseif (isset($udyamdetails['statuscode']) && $udyamdetails['statuscode'] == 404) {
                    $statusCode = 202;
                    $errorMessage = $udyamdetails['error_message'];
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $udyam_database = DB::table('udyamsearch')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 202,
                            'message' => "failed",
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $udyam_database = DB::table('udyamsearch')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message' => "failed",
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 500, 'message' => $errorMessage]);
                }

            } else {
                return response()->json(['status_code' => 500, 'message' => 'Please reacharge your wallet.']);
            }
        } else {
            return response()->json(['status_code' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
//   public function aadharCardOcr(Request $request)
//     {
//         $statusCode = null;
//         $aadhar_card = null;
//         $api_id = null;

//         if (empty($request->hasFile('file'))) {
//             return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
//         }

//         if (!$request->headers->has('AccessToken')) {
//             return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
//         }

//         $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
//         if ($verifyAccessToken == false) {
//             return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
//         }
//         $user = User::where('access_token', $request->header('AccessToken'))->first();
//         if ($user->role_id == 1) {
//             $apiamster = ApiMaster::where('api_slug', 'aadharocr')->first();
//             if ($apiamster) {
//                 $api_id = $apiamster->id;
//             }
//         }
//         $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
//             ->where('api_id', $api_id)
//             ->orderBy('id', 'desc')
//             ->first();

//         if ($updateHitCount || $user->role_id == 0) {
//             if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
//                 $curl = curl_init();
//                 curl_setopt_array($curl, [
//                     CURLOPT_URL => 'http://13.202.44.163:8080/aadharocr',
//                     CURLOPT_RETURNTRANSFER => true,
//                     CURLOPT_ENCODING => '',
//                     CURLOPT_MAXREDIRS => 10,
//                     CURLOPT_TIMEOUT => 0,
//                     CURLOPT_FOLLOWLOCATION => true,
//                     CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
//                     CURLOPT_CUSTOMREQUEST => 'POST',
//                     CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
//                 ]);
//                 $response = curl_exec($curl);
//                 curl_close($curl);
//                 $aadhar_card = json_decode($response, true);
//                 if (isset($aadhar_card['raw_ocr_texts'])) {
//                     $aadharcard_response = null;
//                     if ($user->role_id == 1 || $user->role_id == 0) {
//                         if ($user->role_id == 1) {
//                             if ($apiamster) {
//                                 $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
//                             }
//                         }
//                         $aadharcard = DB::table('aadhar_validation')->insert([
//                             'user_id' => $user->id,
//                             'api_id' => $api_id,
//                             'aadhar_no' => isset($aadhar_card['aadhar_number']) ? $aadhar_card['aadhar_number'] : null,
//                             'date_of_birth' => isset($aadhar_card['date_of_birth']) ? $aadhar_card['date_of_birth'] : null,
//                             'name' => isset($aadhar_card['name']) ? $aadhar_card['name'] : null,
//                             'gender' => isset($aadhar_card['gender']) ? $aadhar_card['gender'] : null,
//                             'created_at' => Carbon::now(),
//                             'updated_at' => Carbon::now(),
//                         ]);
//                     }
//                     return response()->json(['status_code' => 200, 'aadharcard' => $aadhar_card]);
//                 } elseif (isset($aadhar_card['error']) && $aadhar_card['error'] == 'Invalid file type, must be an image') {
//                     $statusCode = 102;
//                     $errorMessage = 'Invalid file type, must be an aadhar card image.';
//                     if ($user->role_id == 1 || $user->role_id == 0) {
//                         if ($user->role_id == 1) {
//                             if ($apiamster) {
//                                 $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
//                             }
//                         }
//                         $aadharcard = DB::table('aadhar_validation')->insert([
//                             'user_id' => $user->id,
//                             'api_id' => $api_id,
//                             'created_at' => Carbon::now(),
//                             'updated_at' => Carbon::now(),
//                         ]);
//                     }
//                     return response()->json(['status_code' => 102, 'message' => $errorMessage]);
//                 } elseif (isset($aadhar_card['error']) && $aadhar_card['error'] == "No file part") {
//                     $statusCode = 404;
//                     $errorMessage = 'No image file provided';
//                     return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
//                 } else {
//                     $statusCode = 500;
//                     $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
//                     if ($user->role_id == 1 || $user->role_id == 0) {
//                         if ($user->role_id == 1) {
//                             if ($apiamster) {
//                                 $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
//                             }
//                         }
//                         $aadharcard = DB::table('aadhar_validation')->insert([
//                             'user_id' => $user->id,
//                             'api_id' => $api_id,
//                             'created_at' => Carbon::now(),
//                             'updated_at' => Carbon::now(),
//                         ]);
//                     }
//                     return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
//                 }
//             } else {
//                 return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet amount.']);

//             }
//         } else {
//             return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
//         }
//     }
public function aadharCardOcr(Request $request)
{
    $statusCode = null;
    $aadhar_card = null;
    $api_id = null;

    if (empty($request->hasFile('file'))) {
        return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
    }

    $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    if ($verifyAccessToken == false) {
        return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'aadharocr')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

           
            $curl = curl_init();
            curl_setopt_array($curl, [
                CURLOPT_URL => 'http://13.202.44.163:8080/aadharocr',
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_CUSTOMREQUEST => 'POST',
                CURLOPT_POSTFIELDS => [
                    'file' => new \CURLFILE(
                        $_FILES['file']['tmp_name'],
                        $_FILES['file']['type'],
                        $_FILES['file']['name']
                    )
                ],
            ]);

            $response = curl_exec($curl);
            curl_close($curl);

            $aadhar_card = json_decode($response, true);

          
            if (isset($aadhar_card['raw_ocr_texts'])) {

                if ($user->role_id == 1 && $apiamster) {
                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                }

                DB::table('aadhar_validation')->insert([
                    'user_id' => $user->id,
                    'api_id' => $api_id,
                    'aadhar_no' => $aadhar_card['aadhar_number'] ?? null,
                    'date_of_birth' => $aadhar_card['date_of_birth'] ?? null,
                    'name' => $aadhar_card['name'] ?? null,
                    'gender' => $aadhar_card['gender'] ?? null,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);

                return response()->json([
                    'status_code' => 200,
                    'aadharcard' => [
                        'aadhar_number' => $aadhar_card['aadhar_number'] ?? null,
                        'name'          => $aadhar_card['name'] ?? null,
                        'date_of_birth' => $aadhar_card['date_of_birth'] ?? null,
                        'gender'        => $aadhar_card['gender'] ?? null,
                    ]
                ]);
            }

            
            if (!isset($aadhar_card['raw_ocr_texts'])) {

                try {
                    $curl = curl_init();
                    curl_setopt_array($curl, [
                        CURLOPT_URL => 'https://svcdemo.digitap.work/ocr/v1/aadhaar',
                        CURLOPT_RETURNTRANSFER => true,
                        CURLOPT_CUSTOMREQUEST => 'POST',
                        CURLOPT_HTTPHEADER => [
                            'Authorization: Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                        ],
                        CURLOPT_POSTFIELDS => [
                            'pdf' => new \CURLFILE(
                                $_FILES['file']['tmp_name'],
                                $_FILES['file']['type'],
                                $_FILES['file']['name']
                            ),
                            'outputmaskedAadhaar' => 'yes',
                            'clientRefId' => uniqid('aad_'),
                            'isBlackWhiteCheck' => 'yes',
                            'confidence' => 'yes',
                            'maskAadhaarNumber' => 'yes',
                            'fraudCheck' => 'yes'
                        ],
                    ]);

                    $response = curl_exec($curl);
                    curl_close($curl);

                    $aadhar = json_decode($response, true);

                    if (isset($aadhar['result'])) {

                        if ($user->role_id == 1 && $apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                        $name = $dob = $gender = $aadhar_no = null;

                        foreach ($aadhar['result'] as $block) {
                            if (isset($block['details'])) {
                                $d = $block['details'];
                                if (isset($d['name']['value'])) $name = $d['name']['value'];
                                if (isset($d['dob']['value'])) $dob = $d['dob']['value'];
                                if (isset($d['gender']['value'])) $gender = $d['gender']['value'];
                                if (isset($d['aadhaar']['value'])) $aadhar_no = $d['aadhaar']['value'];
                            }
                        }

                        DB::table('aadhar_validation')->insert([
                            'user_id'       => $user->id,
                            'api_id'        => $api_id,
                            'aadhar_no'     => $aadhar_no,
                            'date_of_birth' => $dob,
                            'name'          => $name,
                            'gender'        => $gender,
                            'created_at'    => Carbon::now(),
                            'updated_at'    => Carbon::now(),
                        ]);

                        return response()->json([
                            'status_code' => 200,
                            'aadharcard' => [
                                'aadhar_number' => $aadhar_no,
                                'name'          => $name,
                                'date_of_birth' => $dob,
                                'gender'        => $gender,
                            ]
                        ]);
                    }

                } catch (\BadResponseException $e) {}
            }

           
            $statusCode = 500;
            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';

            if ($user->role_id == 1 && $apiamster) {
                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
            }

            DB::table('aadhar_validation')->insert([
                'user_id' => $user->id,
                'api_id' => $api_id,
                'created_at' => Carbon::now(),
                'updated_at' => Carbon::now(),
            ]);

            return response()->json([
                'status_code' => $statusCode,
                'message' => $errorMessage
            ]);

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please reacharge your wallet amount.'
            ]);
        }
    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}


    public function aadharCardOcr9may2024(Request $request)
    {
        $statusCode = null;
        $aadhar_card = null;
        $api_id = null;

        if (empty($request->hasFile('file'))) {
            return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'aadhaar')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => '13.200.221.11:5000/extract-aadhar-text',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $aadhar_card = json_decode($response, true);
                if (isset($aadhar_card['detected_text'])) {
                    $aadharcard_response = null;
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $aadharcard_response['detected_text'] = $aadhar_card['detected_text'];
                        $aadharcard_response['extracted_info']['date_of_birth'] = $aadhar_card['extracted_info']['date_of_birth'][0];
                        $aadharcard_response['extracted_info']['aadhar_number'] = $aadhar_card['extracted_info']['aadhar_number'][0];
                        $aadharcard_response['extracted_info']['name'] = $aadhar_card['extracted_info']['name'][0];

                        $aadharcard = DB::table('aadhar_validation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'aadhar_no' => $aadhar_card['extracted_info']['aadhar_number'][0],
                            'date_of_birth' => $aadhar_card['extracted_info']['date_of_birth'][0],
                            'name' => $aadhar_card['extracted_info']['name'][0],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'aadharcard' => $aadharcard_response]);
                } elseif (isset($aadhar_card['error']) && $aadhar_card['error'] == 'Invalid file type, must be an image') {
                    $statusCode = 102;
                    $errorMessage = 'Invalid file type, must be an aadhar card image.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $aadharcard = DB::table('aadhar_validation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($aadhar_card['error']) && $aadhar_card['error'] == 'No file provided') {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $aadharcard = DB::table('aadhar_validation')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'Please reacharge your wallet amount.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function aadharcardMask(Request $request)
    {
        $statusCode = null;
        $aadhar_card = null;
        $api_id = null;
        if (empty($request->hasFile('file'))) {
            return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'aadharocrmasking')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/mask_aadhar',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $aadhar_card = json_decode($response, true);
                if (isset($aadhar_card['data'])) {
                    $image = base64_decode($aadhar_card['data']);
                    file_put_contents(public_path("images/aaa.png"), $image);
                    $imageUrl = asset('images/aaa.png');
                    $aadharcard_response = null;
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $aadharcard = DB::table('aadhar_masking_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'aadhar_mask_base64' => isset($aadhar_card['data']) ? $aadhar_card['data'] : null,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    
                    // return response()->json(['status_code' => 200, 'aadharcard' => ['data'=>'data:image/png;base64,' . $aadhar_card['data'],]);
                    return response()->json([
                        'status_code' => 200,
                        'aadharcard' => [
                            'data' => 'data:image/png;base64,' . $aadhar_card['data'], // Directly use the existing Base64 string
                        ],
                    ]);
                    
                } elseif (isset($aadhar_card['error']) && $aadhar_card['error'] == 'Invalid file type, must be an image') {
                    $statusCode = 102;
                    $errorMessage = 'Invalid file type, must be an aadhar card image.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $aadharcard = DB::table('aadhar_masking_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($aadhar_card['error']) && $aadhar_card['error'] == 'No file provided') {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $aadharcard = DB::table('aadhar_masking_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function aadharcardMaskbefore9may2024(Request $request)
    {
        $statusCode = null;
        $aadhar_card = null;
        $api_id = null;
        if (empty($request->hasFile('file'))) {
            return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'aadharmasking')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/mask_aadhar',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $aadhar_card = json_decode($response, true);
                if (isset($aadhar_card['data'])) {
                    $aadharcard_response = null;
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }

                        $aadharcard = DB::table('aadhar_masking_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'aadhar_mask_base64' => $aadhar_card['data'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'aadharcard' => $aadhar_card]);
                } elseif (isset($aadhar_card['error']) && $aadhar_card['error'] == 'Invalid file type, must be an image') {
                    $statusCode = 102;
                    $errorMessage = 'Invalid file type, must be an aadhar card image.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $aadharcard = DB::table('aadhar_masking_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($aadhar_card['error']) && $aadhar_card['error'] == 'No file provided') {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $aadharcard = DB::table('aadhar_masking_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'Please reacharge your wallet amount.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    // public function drivingLicenseOcr(Request $request)
    // {
    //     $statusCode = null;
    //     $drivinglicense = null;
    //     $api_id = null;
    //     if (empty($request->hasFile('file'))) {
    //         return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
    //     }

    //     if (!$request->headers->has('AccessToken')) {
    //         return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
    //     }

    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken == false) {
    //         return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
    //     }
    //     $user = User::where('access_token', $request->header('AccessToken'))->first();
    //     if ($user->role_id == 1) {
    //         $apiamster = ApiMaster::where('api_slug', 'drivinglicenseocr')->first();
    //         if ($apiamster) {
    //             $api_id = $apiamster->id;
    //         }
    //     }
    //     $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
    //         ->where('api_id', $api_id)
    //         ->orderBy('id', 'desc')
    //         ->first();

    //     if ($updateHitCount || $user->role_id == 0) {
    //         if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
    //             $curl = curl_init();
    //             curl_setopt_array($curl, [
    //                 CURLOPT_URL => 'http://13.202.44.163:8080/dlocr',
    //                 CURLOPT_RETURNTRANSFER => true,
    //                 CURLOPT_ENCODING => '',
    //                 CURLOPT_MAXREDIRS => 10,
    //                 CURLOPT_TIMEOUT => 0,
    //                 CURLOPT_FOLLOWLOCATION => true,
    //                 CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
    //                 CURLOPT_CUSTOMREQUEST => 'POST',
    //                 CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
    //             ]);
    //             $response = curl_exec($curl);
    //             curl_close($curl);
    //             $drivinglicense = json_decode($response, true);
    //             // return $drivinglicense;
    //             if (isset($drivinglicense['raw_ocr_texts'])) {
    //                 if ($user->role_id == 1 || $user->role_id == 0) {
    //                     if ($user->role_id == 1) {
    //                         if ($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                         }
    //                     }
    //                     $driving_license = DB::table('driving_license')->insert([
    //                         'user_id' => $user->id,
    //                         'api_id' => $api_id,
    //                         'license_number' => isset($drivinglicense['dl_no']) ? $drivinglicense['dl_no'] : null,
    //                         'dob' => isset($drivinglicense['birth_date']) ? $drivinglicense['birth_date'] : null,
    //                         'valid_till' => isset($drivinglicense['expiry_date']) ? $drivinglicense['expiry_date'] : null,
    //                         'name' => isset($drivinglicense['name']) ? $drivinglicense['name'] : null,
    //                         'created_at' => Carbon::now(),
    //                         'updated_at' => Carbon::now(),
    //                     ]);
    //                 }
    //                 return response()->json(['status_code' => 200, 'driving_license' => $drivinglicense]);
    //             } elseif (isset($drivinglicense['error']) && $drivinglicense['error'] == 'Invalid file type, must be an image') {
    //                 $statusCode = 102;
    //                 $errorMessage = 'Invalid file type, must be an driving license image.';
    //                 if ($user->role_id == 1 || $user->role_id == 0) {
    //                     if ($user->role_id == 1) {
    //                         if ($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
    //                         }
    //                     }
    //                     $driving_license = DB::table('driving_license')->insert([
    //                         'user_id' => $user->id,
    //                         'api_id' => $api_id,
    //                         'created_at' => Carbon::now(),
    //                         'updated_at' => Carbon::now(),
    //                     ]);
    //                 }
    //                 return response()->json(['status_code' => 102, 'message' => $errorMessage]);
    //             } elseif (isset($drivinglicense['error']) && $drivinglicense['error'] == "No file part") {
    //                 $statusCode = 404;
    //                 $errorMessage = 'No image file provided';
    //                 return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
    //             } else {
    //                 $statusCode = 500;
    //                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                 if ($user->role_id == 1 || $user->role_id == 0) {
    //                     if ($user->role_id == 1) {
    //                         if ($apiamster) {
    //                             $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                     $driving_license = DB::table('driving_license')->insert([
    //                         'user_id' => $user->id,
    //                         'api_id' => $api_id,
    //                         'created_at' => Carbon::now(),
    //                         'updated_at' => Carbon::now(),
    //                     ]);
    //                 }
    //                 return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
    //             }
    //         } else {
    //             return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet.']);

    //         }
    //     } else {
    //         return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
    //     }
    // }
   public function drivingLicenseOcr(Request $request)
{
    $statusCode = null;
    $drivinglicense = null;
    $api_id = null;

    if (empty($request->hasFile('file'))) {
        return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'drivinglicenseocr')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

            
            $curl = curl_init();
            curl_setopt_array($curl, [
                CURLOPT_URL => 'http://13.202.44.163:8080/dlocr',
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_CUSTOMREQUEST => 'POST',
                CURLOPT_POSTFIELDS => [
                    'file' => new \CURLFILE(
                        $_FILES['file']['tmp_name'],
                        $_FILES['file']['type'],
                        $_FILES['file']['name']
                    )
                ],
            ]);

            $response = curl_exec($curl);
            curl_close($curl);

            $drivinglicense = json_decode($response, true);

            if (isset($drivinglicense['raw_ocr_texts'])) {

                if ($user->role_id == 1 && $apiamster) {
                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                }

                DB::table('driving_license')->insert([
                    'user_id' => $user->id,
                    'api_id' => $api_id,
                    'license_number' => $drivinglicense['dl_no'] ?? null,
                    'dob' => $drivinglicense['birth_date'] ?? null,
                    'valid_till' => $drivinglicense['expiry_date'] ?? null,
                    'name' => $drivinglicense['name'] ?? null,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);

                return response()->json([
                    'status_code' => 200,
                    'driving_license' => $drivinglicense
                ]);
            }

           
            try {

                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'https://svcdemo.digitap.work/ocr/v1/dl',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_HTTPHEADER => [
                        'Authorization: Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                    ],
                    CURLOPT_POSTFIELDS => [
                        'imageUrl' => new \CURLFILE(
                            $_FILES['file']['tmp_name'],
                            $_FILES['file']['type'],
                            $_FILES['file']['name']
                        ),
                        'clientRefId' => uniqid('dl_'),
                        'confidence'  => 'yes'
                    ],
                ]);

                $response = curl_exec($curl);
                curl_close($curl);

                $digitap = json_decode($response, true);

                if (
                    isset($digitap['status']) &&
                    $digitap['status'] === 'success' &&
                    isset($digitap['result'][0]['details'])
                ) {

                    $d = $digitap['result'][0]['details'];

                    $dl_no  = $d['dl_no']['value'] ?? null;
                    $name   = $d['name']['value'] ?? null;
                    $dob    = $d['dob']['value'] ?? null;
                    $expiry = $d['doe']['value'] ?? null;
                    $father_name = $d['relation']['value'] ?? null;
                    
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }

                    DB::table('driving_license')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'license_number' => $dl_no,
                        'dob' => $dob,
                        'valid_till' => $expiry,
                        'name' => $name,
                        'father_or_husband_name'=> $father_name,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);

                    return response()->json([
                        'status_code' => 200,
                        'driving_license' => [
                            'dl_no' => $dl_no,
                            'name' => $name,
                            'dob' => $dob,
                            'expiry_date' => $expiry
                        ]
                    ]);
                }

            } catch (\Exception $e) {
                // fall through to final failure
            }

         
            $statusCode = 500;
            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';

            if ($user->role_id == 1 && $apiamster) {
                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
            }

            DB::table('driving_license')->insert([
                'user_id' => $user->id,
                'api_id' => $api_id,
                'created_at' => Carbon::now(),
                'updated_at' => Carbon::now(),
            ]);

            return response()->json([
                'status_code' => $statusCode,
                'message' => $errorMessage
            ]);

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please reacharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

    public function drivingLicenseOcr9may2024(Request $request)
    {
        $statusCode = null;
        $drivinglicense = null;
        $api_id = null;
        if (empty($request->hasFile('file'))) {
            return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'license')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/extract-dl-text',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $drivinglicense = json_decode($response, true);
                if (isset($drivinglicense['detected_text'])) {
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $driving_license = DB::table('driving_license')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'license_number' => $drivinglicense['extracted_info']['dl_no'],
                            'dob' => $drivinglicense['extracted_info']['birth_date'],
                            'valid_till' => $drivinglicense['extracted_info']['Valid Till'],
                            'name' => $drivinglicense['extracted_info']['name'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'driving_license' => $drivinglicense]);
                } elseif (isset($drivinglicense['error']) && $drivinglicense['error'] == 'Invalid file type, must be an image') {
                    $statusCode = 102;
                    $errorMessage = 'Invalid file type, must be an driving license image.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $driving_license = DB::table('driving_license')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($drivinglicense['error']) && $drivinglicense['error'] == 'No file provided') {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $driving_license = DB::table('driving_license')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'Please reacharge your wallet amount.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function pancardOcr(Request $request)
    {
        $statusCode = null;
        $pan_cards = null;
        $api_id = null;
        // $apimaster=null;
        if (empty($request->hasFile('file'))) {
            return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'pancardocr')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://13.202.44.163:8080/panocr',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $pancard = json_decode($response, true);
                // return $pancard;
                if (isset($pancard['raw_ocr_texts'])) {
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $paninfo = DB::table('pancard_varification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'name' => isset($pancard['name']) ? $pancard['name'] : null,
                            'dob' => isset($pancard['date_of_birth']) ? $pancard['date_of_birth'] : null,
                            'pancard_id' => isset($pancard['pan_number']) ? $pancard['pan_number'] : null,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'pancard' => $pancard]);
                } elseif (isset($pancard['error']) && $pancard['error'] == 'Invalid file type, must be an image') {
                    $statusCode = 102;
                    $errorMessage = 'Invalid file type, must be an pancard image';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $paninfo = DB::table('pancard_varification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($pancard['error']) && $pancard['error'] == "No file part") {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $paninfo = DB::table('pancard_varification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function pancardOcr9may2024(Request $request)
    {
        $statusCode = null;
        $pan_cards = null;
        $api_id = null;
        // $apimaster=null;
        if (empty($request->hasFile('file'))) {
            return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'pancard')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => '13.200.221.11:5000/extract-pan-text',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $pancard = json_decode($response, true);

                if (isset($pancard['detected_text'])) {
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $paninfo = DB::table('pancard_varification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'dob' => isset($pancard['extracted_info']['date_of_birth']) ? $pancard['extracted_info']['date_of_birth'] : null,
                            'pancard_id' => isset($pancard['extracted_info']['pan_number']) ? $pancard['extracted_info']['pan_number'] : null,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'pancard' => $pancard]);
                } elseif (isset($pancard['error']) && $pancard['error'] == 'Invalid file type, must be an image') {
                    $statusCode = 102;
                    $errorMessage = 'Invalid file type, must be an pancard image';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $paninfo = DB::table('pancard_varification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($pancard['error']) && $pancard['error'] == 'No file provided') {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $paninfo = DB::table('pancard_varification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'Please reacharge your wallet amount.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function passportOcr(Request $request)
    {
        $statusCode = null;
        $passport = null;
        $api_id = null;
        if (empty($request->hasFile('file'))) {
            return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'passportocr')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/process-passport',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $passport = json_decode($response, true);
                if (isset($passport['mrz_info'])) {
                    if ($user->role_id == 1) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $passport_detils = DB::table('passport_upload')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'date_of_birth' => $passport['mrz_info']['date_of_birth_yymmdd'],
                            'expiration_date' => $passport['mrz_info']['expiration_date_yymmdd'],
                            'gender' => $passport['mrz_info']['gender'],
                            'mrz_type' => $passport['mrz_info']['mrz_type'],
                            'nationality' => $passport['mrz_info']['nationality'],
                            'number' => $passport['mrz_info']['number'],
                            'valid_document' => $passport['valid_document'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'passport_verification' => $passport]);
                } elseif (isset($passport['error']) && $passport['error'] == 'Failed to extract MRZ information') {
                    $statusCode = 102;
                    $errorMessage = 'Failed to extract MRZ information.';
                    if ($user->role_id == 1) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $passport_detils = DB::table('passport_upload')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($passport['error']) && $passport['error'] == 'No file provided') {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $passport_detils = DB::table('passport_upload')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet.']);
            }
        } else {

            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    // public function voterIdOcr(Request $request)
    // {
    //     $statusCode = null;
    //     $voter_id = null;
    //     $api_id = null;
    //     if (empty($request->hasFile('file'))) {
    //         return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
    //     }

    //     if (!$request->headers->has('AccessToken')) {
    //         return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
    //     }
    //     $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    //     if ($verifyAccessToken == false) {
    //         return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
    //     }
    //     $user = User::where('access_token', $request->header('AccessToken'))->first();
    //     if ($user->role_id == 1) {
    //         $apiamster = ApiMaster::where('api_slug', 'voteridocr')->first();
    //         if ($apiamster) {
    //             $api_id = $apiamster->id;
    //         }
    //     }
    //     $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
    //         ->where('api_id', $api_id)
    //         ->orderBy('id', 'desc')
    //         ->first();
    //     if ($updateHitCount || $user->role_id == 0) {
    //         if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
    //             $curl = curl_init();
    //             curl_setopt_array($curl, [
    //                 CURLOPT_URL => 'http://13.202.44.163:8080/voterocr',
    //                 CURLOPT_RETURNTRANSFER => true,
    //                 CURLOPT_ENCODING => '',
    //                 CURLOPT_MAXREDIRS => 10,
    //                 CURLOPT_TIMEOUT => 0,
    //                 CURLOPT_FOLLOWLOCATION => true,
    //                 CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
    //                 CURLOPT_CUSTOMREQUEST => 'POST',
    //                 CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
    //             ]);
    //             $response = curl_exec($curl);
    //             curl_close($curl);
    //             $voterid = json_decode($response, true);
    //             return $voterid;
    //             if (isset($voterid['raw_ocr_texts'])) {
    //                 if ($user->role_id == 1) {
    //                     if ($user->role_id == 1) {
    //                         if ($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
    //                         }
    //                     }
    //                     $voter_id = DB::table('voter_verification')->insert([
    //                         'user_id' => $user->id,
    //                         'api_id' => $api_id,
    //                         'name' => isset($voterid['name']) ? $voterid['name'] : null,
    //                         'epic_no' => isset($voterid['voter_id_number']) ?: $voterid['voter_id_number'],
    //                         'created_at' => Carbon::now(),
    //                         'updated_at' => Carbon::now(),
    //                     ]);
    //                 }
    //                 return response()->json(['status_code' => 200, 'voterid' => $voterid]);
    //             } elseif (isset($voterid['error']) && $voterid['error'] == 'Invalid file type, must be an image') {
    //                 $statusCode = 102;
    //                 $errorMessage = 'Invalid file type, must be an voter image';
    //                 if ($user->role_id == 1) {
    //                     if ($user->role_id == 1) {
    //                         if ($apiamster) {
    //                             $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
    //                         }
    //                     }
    //                     $voter_id = DB::table('voter_verification')->insert([
    //                         'user_id' => $user->id,
    //                         'api_id' => $api_id,
    //                         'created_at' => Carbon::now(),
    //                         'updated_at' => Carbon::now(),
    //                     ]);
    //                 }
    //                 return response()->json(['status_code' => 102, 'message' => $errorMessage]);
    //             } elseif (isset($voterid['error']) && $voterid['error'] == "No file part") {
    //                 $statusCode = 404;
    //                 $errorMessage = 'No image file provided';
    //                 return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
    //             } else {
    //                 $statusCode = 500;
    //                 $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
    //                 if ($user->role_id == 1) {
    //                     if ($user->role_id == 1) {
    //                         if ($apiamster) {
    //                             $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
    //                         }
    //                     }
    //                     $voter_id = DB::table('voter_verification')->insert([
    //                         'user_id' => $user->id,
    //                         'api_id' => $api_id,
    //                         'created_at' => Carbon::now(),
    //                         'updated_at' => Carbon::now(),
    //                     ]);
    //                 }
    //                 return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
    //             }
    //         } else {
    //             return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet.']);
    //         }
    //     } else {
    //         return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
    //     }
    // }

  public function voterIdOcr(Request $request)
{
    $statusCode = null;
    $voter_id = null;
    $api_id = null;

    if (empty($request->hasFile('file'))) {
        return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
    }

    $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    if ($verifyAccessToken == false) {
        return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'voteridocr')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

          
            $curl = curl_init();
            curl_setopt_array($curl, [
                CURLOPT_URL => 'http://13.202.44.163:8080/voterocr',
                CURLOPT_RETURNTRANSFER => true,
                CURLOPT_CUSTOMREQUEST => 'POST',
                CURLOPT_POSTFIELDS => [
                    'file' => new \CURLFILE(
                        $_FILES['file']['tmp_name'],
                        $_FILES['file']['type'],
                        $_FILES['file']['name']
                    )
                ],
            ]);

            $response = curl_exec($curl);
            curl_close($curl);

            $voterid = json_decode($response, true);
           
          
            if (isset($voterid['raw_ocr_texts'])) {

                if ($user->role_id == 1 && $apiamster) {
                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                }

                DB::table('voter_verification')->insert([
                    'user_id' => $user->id,
                    'api_id'  => $api_id,
                    'name'    => $voterid['name'] ?? null,
                    'epic_no' => $voterid['voter_id_number'] ?? null,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);

                return response()->json([
                    'status_code' => 200,
                    'voterid' => $voterid
                ]);
            }

          
            if (!isset($voterid['raw_ocr_texts'])) {

                try {
                   $curl = curl_init();
curl_setopt_array($curl, [
    CURLOPT_URL => 'https://svcdemo.digitap.work/ocr/v1/voter',
    CURLOPT_RETURNTRANSFER => true,
    CURLOPT_CUSTOMREQUEST => 'POST',
    CURLOPT_HTTPHEADER => [
        'Authorization: Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ],
    CURLOPT_POSTFIELDS => [
        'imageUrl' => new \CURLFILE(
            $_FILES['file']['tmp_name'],
            $_FILES['file']['type'],
            $_FILES['file']['name']
        ),
        'clientRefId' => uniqid('voter_')
    ],
]);


                    $response = curl_exec($curl);
                    curl_close($curl);

                    $voter = json_decode($response, true);
                // return $voter;
                   
                    if (
                        isset($voter['status']) &&
                        $voter['status'] === 'success' &&
                        isset($voter['result']) &&
                        is_array($voter['result'])
                    ) {

                        if ($user->role_id == 1 && $apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                        $name = $epic_no = $gender = $dob = $relation = null;

                        foreach ($voter['result'] as $block) {
                            if (isset($block['details'])) {
                                $d = $block['details'];
                                if (isset($d['name']['value']))     $name = $d['name']['value'];
                                if (isset($d['voterid']['value']))  $epic_no = $d['voterid']['value'];
                                if (isset($d['gender']['value']))   $gender = $d['gender']['value'];
                                if (isset($d['dob']['value']))      $dob = $d['dob']['value'];
                                if (isset($d['relation']['value'])) $relation = $d['relation']['value'];
                            }
                        }

                        DB::table('voter_verification')->insert([
                            'user_id' => $user->id,
                            'api_id'  => $api_id,
                            'name'    => $name,
                            'epic_no' => $epic_no,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);

                        return response()->json([
                            'status_code' => 200,
                            'voterid' => [
                                'name' => $name,
                                'voter_id' => $epic_no,
                                'gender' => $gender,
                                'date_of_birth' => $dob,
                                'relation_name' => $relation
                            ]
                        ]);
                    }

                } catch (\Exception $e) {
                    // fall through
                }
            }

    
            $statusCode = 500;
            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';

            if ($user->role_id == 1 && $apiamster) {
                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
            }

            DB::table('voter_verification')->insert([
                'user_id' => $user->id,
                'api_id' => $api_id,
                'created_at' => Carbon::now(),
                'updated_at' => Carbon::now(),
            ]);

            return response()->json([
                'status_code' => $statusCode,
                'message' => $errorMessage
            ]);

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please reacharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}


    public function voterIdOcr9may2024(Request $request)
    {
        $statusCode = null;
        $voter_id = null;
        $api_id = null;
        if (empty($request->hasFile('file'))) {
            return response()->json([['message' => 'file is required', 'statusCode' => '404']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'voter_id')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => '13.200.221.11:5000/extract-voter-id-text',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $voterid = json_decode($response, true);
                if (isset($voterid['detected_text'])) {
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $voter_id = DB::table('voter_verification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'name' => $voterid['extracted_info']['name'],
                            'epic_no' => $voterid['extracted_info']['voter_id'],
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'voterid' => $voterid]);
                } elseif (isset($voterid['error']) && $voterid['error'] == 'Invalid file type, must be an image') {
                    $statusCode = 102;
                    $errorMessage = 'Invalid file type, must be an voter image';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $voter_id = DB::table('voter_verification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($voterid['error']) && $voterid['error'] == 'No file provided') {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $voter_id = DB::table('voter_verification')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'Please reacharge your wallet amount.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function create_geofence(Request $request)
    {
        $statusCode = null;
        $create_geofence = null;
        $api_id = null;
        if (empty($request->has('latitude'))) {
            return response()->json([['message' => 'latitude is required', 'statusCode' => '404']]);
        }
        if (empty($request->has('longitude'))) {
            return response()->json([['message' => 'longitude is required', 'statusCode' => '404']]);
        }
        if (empty($request->has('radius'))) {
            return response()->json([['message' => 'radius is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'creategeofence')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $latitude = floatval($request->input('latitude'));
                $longitude = floatval($request->input('longitude'));
                $radius = floatval($request->input('radius'));
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/create-geofence',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode(array(
                        'latitude' => $longitude,
                        'longitude' => $latitude,
                        'radius' => $radius
                    )),
                    CURLOPT_HTTPHEADER => array(
                        'Content-Type: application/json'
                    ),
                ));

                $response = curl_exec($curl);
                $create_geofence = json_decode($response, true);
                if (isset($create_geofence['GeofenceId'])) {
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $creategeofence = DB::table('create_geofence')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'CreateTime' => isset($create_geofence['CreateTime']) ? $create_geofence['CreateTime'] : null,
                            'GeofenceId' => isset($create_geofence['GeofenceId']) ? $create_geofence['GeofenceId'] : null,
                            'UpdateTime' => isset($create_geofence['UpdateTime']) ? $create_geofence['UpdateTime'] : null,
                            'status_code' => 200,
                            'message_code' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'data' => $create_geofence]);
                } elseif (isset($create_geofence['error']) && $create_geofence['error'] == "Failed to retrieve data") {
                    $statusCode = 102;
                    $errorMessage = 'Invalid details. Please enter correct details.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $creategeofence = DB::table('create_geofence')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $creategeofence = DB::table('create_geofence')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet amount.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function getPlace(Request $request)
    {
        $statusCode = null;
        $get_place = null;
        $api_id = null;
        if (empty($request->has('longitude')) && empty($request->has('latitude'))) {
            return response()->json([['message' => 'At least one parameter is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'getplace')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $latitude = floatval($request->input('latitude'));
                $longitude = floatval($request->input('longitude'));
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/get-place',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode(array(
                        'long' => $longitude,
                        'lat' => $latitude
                    )),
                    CURLOPT_HTTPHEADER => array(
                        'Content-Type: application/json'
                    ),
                ));

                $response = curl_exec($curl);
                $get_place = json_decode($response, true);
                if (isset($get_place[0]['label'])) {
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $getplace = DB::table('get_place')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'Place' => isset($get_place[0]['label']) ? $get_place[0]['label'] : null,
                            'longitude' => isset($get_place[0]['point'][0]) ? $get_place[0]['point'][0] : null,
                            'latitude' => isset($get_place[0]['point'][1]) ? $get_place[0]['point'][1] : null,
                            'status_code' => 200,
                            'message_code' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'data' => $get_place]);
                } elseif (isset($get_place['error']) && $get_place['error'] == "Failed to retrieve data") {
                    $statusCode = 102;
                    $errorMessage = 'Invalid details. Please enter correct details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $getplace = DB::table('get_place')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $getplace = DB::table('get_place')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function getCoordinates(Request $request)
    {
        $statusCode = null;
        $get_coordinates = null;
        $api_id = null;
        if (empty($request->has('address'))) {
            return response()->json([['message' => 'address is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'getcoordinate')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/get-coordinates',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode(array(
                        'address' => $request->address,
                    )),
                    CURLOPT_HTTPHEADER => array(
                        'Content-Type: application/json'
                    ),
                ));

                $response = curl_exec($curl);
                $get_coordinates = json_decode($response, true);
                if (isset($get_coordinates[0])) {
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        foreach ($get_coordinates as $address) {
                            $longitude = isset($address['point'][0]) ? $address['point'][0] : null;
                            $latitude = isset($address['point'][1]) ? $address['point'][1] : null;
                            $getcoordinates = DB::table('get_coordinate')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'address' => isset($address['label']) ? $address['label'] : null,
                                'latitude' => $latitude,
                                'longitude' => $longitude,
                                'relevance' => isset($address['relevance']) ? $address['relevance'] : null,
                                'status_code' => 200,
                                'message_code' => 'success',
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }

                    }
                    return response()->json(['status_code' => 200, 'data' => $get_coordinates]);
                } elseif (isset($get_coordinates['error']) && $get_coordinates['error'] == "Failed to retrieve data") {
                    $statusCode = 102;
                    $errorMessage = 'Invalid address. Please enter correct address.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $getcoordinates = DB::table('get_coordinate')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $getcoordinates = DB::table('get_coordinate')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function verifyAddress(Request $request)
    {
        $statusCode = null;
        $verify_address = null;
        $api_id = null;
        if (empty($request->has('address'))) {
            return response()->json([['message' => 'address is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'verifyaddress')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/verify_address',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode(['address' => $request->address]),
                    CURLOPT_HTTPHEADER => array(
                        'Content-Type: application/json'
                    ),
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $verify_address = json_decode($response, true);
                if (isset($verify_address['input_address'])) {
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        $verifyaddress = DB::table('verify_address')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'input_address' => isset($verify_address['input_address']) ? $verify_address['input_address'] : null,
                            'match' => isset($verify_address['match']) ? $verify_address['match'] : null,
                            'verified_address' => isset($verify_address['verified_address']) ? $verify_address['verified_address'] : null,
                            'status_code' => 200,
                            'message_code' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'data' => $verify_address]);
                } elseif (isset($verify_address['status']) && $verify_address['status'] == 408) {
                    $statusCode = 102;
                    $errorMessage = 'Verification Failed. Please enter correct address';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                        $verifyaddress = DB::table('verify_address')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($verify_address['error']) && $verify_address['error'] == 'Address verification failed') {
                    $statusCode = 202;
                    $errorMessage = 'Address verification failed.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $verifyaddress = DB::table('verify_address')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 202,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                        $verifyaddress = DB::table('verify_address')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function autoComplete(Request $request)
    {
        $statusCode = null;
        $auto_complate = null;
        $api_id = null;
        if (empty($request->has('text'))) {
            return response()->json([['message' => 'text is required', 'statusCode' => '404']]);
        }
        if (empty($request->has('maxResult'))) {
            return response()->json([['message' => 'maxResult is required', 'statusCode' => '404']]);
        }
        if ($request->has('maxResult') && $request->maxResult > 15) {
            return response()->json([['message' => 'maxResult should be less then 15', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'autocomplate')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $addressText = $request->input('text');
                $maxResult = intval($request->input('maxResult'));
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/autocomplete',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode(array(
                        'text' => $addressText,
                        'maxResults' => $maxResult,
                    )),
                    CURLOPT_HTTPHEADER => array(
                        'Content-Type: application/json'
                    ),
                ));

                $response = curl_exec($curl);
                $auto_complate = json_decode($response, true);
                if (isset($auto_complate[0])) {
                    $autocomplate_res = [];
                    foreach ($auto_complate as $key => $address) {
                        $autocomplate_res[] = [
                            'sn' => $key + 1,
                            'address' => $address
                        ];
                    }
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                    }
                    return response()->json(['status_code' => 200, 'data' => $autocomplate_res]);
                } elseif (isset($auto_complate['error']) && $auto_complate['error'] == "Failed to retrieve data") {
                    $statusCode = 102;
                    $errorMessage = 'Invalid details. Please enter correct details.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                            }
                        }
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (empty($auto_complate[0])) {
                    $statusCode = 202;
                    $errorMessage = 'Invalid text. Please enter correct text.';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['status_code' => 202, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1 || $user->role_id == 0) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please reacharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function gstbasicverification(Request $request)
    {
        $statusCode = null;
        $gstbasic_verification = null;
        $api_id = null;
        $apimaster = null;
        if (empty($request->gstin_number)) {
            return response()->json([['message' => 'gstin number is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apimaster = ApiMaster::where('api_slug', 'gstin')->first();
            if ($apimaster) {
                $api_id = $apimaster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
        ];
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->post('https://api.kyckart.com/api/v2/gst/basic', [
                        'headers' => $headers,
                        'json' => [
                            'gstin' => $request->gstin_number,
                            'checkId' => $groupId,
                            'groupId' => $checkId,
                        ]
                    ]);
                    $gstbasic_verification = json_decode($response->getBody(), true);
                    if (isset($gstbasic_verification['status']['statusCode']) && $gstbasic_verification['status']['statusCode'] == 200 && empty($gstbasic_verification['error']['code'])) {
                        if ($gstbasic_verification['status']['statusCode'] == 200 && !empty($gstbasic_verification['response']['code']) && $gstbasic_verification['response']['code'] == 400) {
                            $statusCode = 102;
                            $errorMessage = 'No data found.';
                            if ($user->role_id == 1) {
                                if ($apimaster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                }
                                DB::table('gstin')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'gstin_number' => $request->gstin_number,
                                    'groupId' => $groupId,
                                    'checkId' => $checkId,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),

                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Success.', 200);
                            }
                            DB::table('gstin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status_code' => 200,
                                'message_code' => 'success',
                                'gstin_number' => isset($gstbasic_verification['response']['gstin']) ? $gstbasic_verification['response']['gstin'] : null,
                                'dateOfRegistration' => isset($gstbasic_verification['response']['rgdt']) ? $gstbasic_verification['response']['rgdt'] : null,
                                'lastUpdatedDate' => isset($gstbasic_verification['response']['lstupdt']) ? $gstbasic_verification['response']['lstupdt'] : null,
                                'tradeName' => isset($gstbasic_verification['response']['tradeNam']) ? $gstbasic_verification['response']['tradeNam'] : null,
                                'groupId' => $groupId,
                                'checkId' => $checkId,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),

                            ]);
                        }
                        return response()->json(['response' => $gstbasic_verification['response'], 'status_code' => 200, 'success' => true, 'message_code' => 'success']);
                    } elseif ($gstbasic_verification['status']['statusCode'] == 200 && $gstbasic_verification['error']['code'] == "E0010003") {

                        $statusCode = 102;
                        $errorMessage = 'Invalid GSTIN / UID';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            DB::table('gstin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status_code' => 102,
                                'message_code' => 'failed',
                                'gstin_number' => $request->gstin_number,
                                'groupId' => $groupId,
                                'checkId' => $checkId,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),

                            ]);
                            return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                            }
                            DB::table('gstin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status_code' => 500,
                                'message_code' => 'failed',
                                'gstin_number' => $request->gstin_number,
                                'groupId' => $groupId,
                                'checkId' => $checkId,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),

                            ]);
                        }

                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }

                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'Gstin Number InValid Please Enter Gstin PanNumber.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                            }
                            DB::table('gstin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status_code' => 102,
                                'message_code' => 'failed',
                                'gstin_number' => $request->gstin_number,
                                'groupId' => $groupId,
                                'checkId' => $checkId,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),

                            ]);
                        }

                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                            }
                            DB::table('gstin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status_code' => 500,
                                'message_code' => 'failed',
                                'gstin_number' => $request->gstin_number,
                                'groupId' => $groupId,
                                'checkId' => $checkId,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),

                            ]);
                        }

                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharage your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function sendSMSNew(Request $request)
    {
        if (empty($request->mobile_no)) {
            return response()->json([['message' => 'Mobile is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        $authKey = "368753AXggrthFX61713441P1";
        $senderId = "DocBoy";
        $message = urlencode(
            "Dear%20Customer,2323%20OTP%20for%20Login%20Thank%20You%20Team%20DocBoyz"
        );
        $prt = '91';
        $newno = $prt . $request->mobile_no;
        $otp = rand(100, 10000);
        $postData = array(
            'authkey' => $authKey,
            'mobiles' => $newno,
            'message' => $message,
            'sender' => $senderId,
            'otp' => $otp,
        );

        $url = "https://api.msg91.com/api/sendotp.php?authkey=368753AXggrthFX61713441P1&mobiles=$newno&message=Dear%20Customer,$otp%20OTP%20for%20Login%20Thank%20You%20Team%20DocBoyz&sender=DocBoy&otp=$otp&DLT_TE_ID=1307163462070500440";
        $curl = curl_init();
        curl_setopt_array($curl, array(
            CURLOPT_URL => $url,
            CURLOPT_RETURNTRANSFER => true,
            CURLOPT_ENCODING => "",
            CURLOPT_MAXREDIRS => 10,
            CURLOPT_TIMEOUT => 30,
            CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
            CURLOPT_CUSTOMREQUEST => "GET",
            CURLOPT_POSTFIELDS => $postData,
            CURLOPT_HTTPHEADER => array(
                "content-type: application/JSON"
            ),
        ));
        $response = curl_exec($curl);
        $err = curl_error($curl);
        curl_close($curl);
        if ($err) {
            return response()->json(['status_code' => 102, 'message' => $err, 'success' => false]);
        } else {
            DB::table('sendotp')->insert([
                'mobile_number' => $newno,
                'otp' => $otp,
                'user_id' => $user->id,
                'created_at' => Carbon::now(),
                'updated_at' => Carbon::now()
            ]);
            return response()->json(['status_code' => 200, 'otp' => $otp, 'message' => "otp has been sent your mobile number.", 'success' => true]);
        }

    }
    public function login_with_otp_check(Request $request)
    {
        if ($request->has('mobile') == false) {
            return response()->json([
                'status' => 'false',
                'message' => "Mobile Number Required."
            ]);
        }
        if ($request->has('otp') == false) {
            return response()->json([
                'status' => 'false',
                'message' => "OTP Required."
            ]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        $prt = '91';
        $mobileNumber = $prt . $request->mobile;
        $otp = $request->otp;
        $loginUser = DB::table('sendotp')->
            where('user_id', $user->id)->
            where('mobile_number', $mobileNumber)->where('otp', $otp)->
            orderBy('created_at', 'DESC')->first();
        if (isset($loginUser) && $loginUser != null) {
            return response()->json([
                'status_code' => 200,
                'message' => 'you are successfully logged in.',
            ]);

        } else if ($loginUser == null) {
            return response()->json([
                'status_code' => 102,
                'message' => "Invalid OTP! And Mobile Number Please provide a valid."
            ]);
        } else {
            return response()->json([
                'status_code' => 102,
                'message' => 'you are not logged in'
            ]);
        }
    }


    public function pantogst22agust2025(Request $request)
    {
        $statusCode = null;
        $pancardtogst = null;
        $api_id = null;
        $apimaster = null;
        if (empty($request->pancard_number)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apimaster = ApiMaster::where('api_slug', 'pantogst')->first();
            if ($apimaster) {
                $api_id = $apimaster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        $client = new Client();
        $headers = [
            'Accept' => 'application/json',
            'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
        ];
        $groupId = rand(100, 10000000000);
        $checkId = rand(100, 10000000000);
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $response = $client->get('https://api.kyckart.com/api/gst/panToGstv2', [
                        'headers' => $headers,
                        'query' => [
                            'panNumber' => $request->pancard_number,
                            'checkId' => $groupId,
                            'groupId' => $checkId,
                        ]
                    ]);
                    $pancardtogst = json_decode($response->getBody(), true);
                    if (isset($pancardtogst['status']['statusCode']) && $pancardtogst['status']['statusCode'] == 200) {
                        if ($pancardtogst['status']['statusCode'] == 200 && !empty($pancardtogst['response']['code']) && $pancardtogst['response']['code'] == 400) {
                            $statusCode = 102;
                            $errorMessage = 'No data found.';
                            if ($user->role_id == 1) {
                                if ($apimaster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                }
                                DB::table('pantogstin')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 500,
                                    'message' => 'success',
                                    'check_id' => isset($checkId) ? $checkId : null,
                                    'group_id' => isset($groupId) ? $groupId : null,
                                    'vender_status_code' => isset($pancardtogst['status']['statusCode']) ? $pancardtogst['status']['statusCode'] : null,
                                    'vender_code' => isset($pancardtogst['response']['code']) ? $pancardtogst['response']['code'] : null,
                                    'pan_number' => isset($request->pancard_number) ? $request->pancard_number : null,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                            return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                        }
                        if ($user->role_id == 1) {
                            foreach ($pancardtogst['response'] as $data) {
                                if ($apimaster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                }
                                DB::table('pantogstin')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status_code' => 200,
                                    'message' => 'success',
                                    'check_id' => isset($checkId) ? $checkId : null,
                                    'group_id' => isset($groupId) ? $groupId : null,
                                    'vender_status_code' => isset($pancardtogst['status']['statusCode']) ? $pancardtogst['status']['statusCode'] : null,
                                    'vender_code' => isset($pancardtogst['response']['code']) ? $pancardtogst['response']['code'] : null,
                                    'lgnm' => isset($data['lgnm']) ? $data['lgnm'] : null,
                                    'gstin' => isset($data['gstin']) ? $data['gstin'] : null,
                                    'tradeName' => isset($data['tradeNam']) ? $data['tradeNam'] : null,
                                    'ctb' => isset($data['ctb']) ? $data['ctb'] : null,
                                    'rgdt' => isset($data['rgdt']) ? $data['rgdt'] : null,
                                    'lstupdt' => isset($data['lstupdt']) ? $data['lstupdt'] : null,
                                    'pan_number' => isset($request->pancard_number) ? $request->pancard_number : null,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['response' => $pancardtogst['response'], 'status_code' => 200, 'success' => true, 'message_code' => 'success']);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);

                            }
                            DB::table('pantogstin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status_code' => 500,
                                'message' => 'success',
                                'check_id' => isset($checkId) ? $checkId : null,
                                'group_id' => isset($groupId) ? $groupId : null,
                                'vender_status_code' => isset($pancardtogst['status']['statusCode']) ? $pancardtogst['status']['statusCode'] : null,
                                'vender_code' => isset($pancardtogst['response']['code']) ? $pancardtogst['response']['code'] : null,
                                'pan_number' => isset($request->pancard_number) ? $request->pancard_number : null,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'PAN Number InValid Please Enter Correct PanNumber.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);

                            }
                            DB::table('pantogstin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status_code' => 102,
                                'message' => 'success',
                                'check_id' => isset($checkId) ? $checkId : null,
                                'group_id' => isset($groupId) ? $groupId : null,
                                'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                'vender_code' => isset($errorResponse['response']['code']) ? $errorResponse['response']['code'] : null,
                                'pan_number' => isset($request->pancard_number) ? $request->pancard_number : null,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);

                            }
                            DB::table('pantogstin')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status_code' => 500,
                                'message' => 'success',
                                'check_id' => isset($checkId) ? $checkId : null,
                                'group_id' => isset($groupId) ? $groupId : null,
                                'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                'vender_code' => isset($errorResponse['response']['code']) ? $errorResponse['response']['code'] : null,
                                'pan_number' => isset($request->pancard_number) ? $request->pancard_number : null,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }

            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

     public function pantogst(Request $request)
    {
        $statusCode = null;
        $pancardtogst = null;
        $api_id = null;
        $apimaster = null;
        if (empty($request->pancard_number)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apimaster = ApiMaster::where('api_slug', 'pantogst')->first();
            if ($apimaster) {
                $api_id = $apimaster->id;
            }
        }

        $client = new Client();
        $headers = [
            // 'Accept' => 'application/json',
            // 'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
            'Authorization'=>'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
            'Content-type' => 'application/json'
        ];
        $randomInt = strval(rand(100, 999));

         $json = [
            'client_ref_num' => $randomInt,
            'pan' => $request->pancard_number,
        ];
        // $groupId = rand(100, 10000000000);
        // $checkId = rand(100, 10000000000);
 $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    // $response = $client->get('https://api.kyckart.com/api/gst/panToGstv2', [
                    //     'headers' => $headers,
                    //     'query' => [
                    //         'pan' => $request->pancard_number,
                    //         'client_ref_num' => $randomInt,

                    //     ]
                    // ]);

                     $response = $client->post('https://svcdemo.digitap.work/validation/kyb/v1/gstpansearch', ['headers' => $headers, 'json' => $json]);
                     $pancardtogst = json_decode($response->getBody(), true);

                    if (isset($pancardtogst['http_response_code']) && $pancardtogst['http_response_code'] == 200) {
    if (isset($pancardtogst['result_code']) && $pancardtogst['result_code'] == 101 &&
        !empty($pancardtogst['result']['gstinResList'])) {


        if ($user->role_id == 1) {
            foreach ($pancardtogst['result']['gstinResList'] as $data) {
                if ($apimaster) {
                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                } 
                DB::table('pantogstin')->insert([
                    'user_id' => $user->id,
                    'api_id' => $api_id,
                    'status_code' => 200,
                    'message' => 'success',
                    'check_id' => isset($checkId) ? $checkId : null,
                    'group_id' => isset($groupId) ? $groupId : null,
                    'vender_status_code' => $pancardtogst['http_response_code'],
                    'vender_code' => $pancardtogst['result_code'],
                    'gstin' => $data['gstin'] ?? null,
                    // 'authStatus' => $data['authStatus'] ?? null,
                    // 'stateCd' => $data['stateCd'] ?? null,
                    // 'state' => $data['state'] ?? null,
                    'pan_number' => $request->pancard_number ?? null,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);
            }
        }

        return response()->json([
            'status_code' => 200,
            'message_code' => 'success',
            'success' => true,
            'response' => $pancardtogst['result']['gstinResList']
        ]);

    } else {

        $statusCode = 102;
        $errorMessage = 'No data found.';
        if ($user->role_id == 1) {
            if ($apimaster) {
                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
            }
            DB::table('pantogstin')->insert([
                'user_id' => $user->id,
                'api_id' => $api_id,
                'status_code' => $statusCode,
                'message' => $errorMessage,
                'check_id' => isset($checkId) ? $checkId : null,
                'group_id' => isset($groupId) ? $groupId : null,
                'vender_status_code' => $pancardtogst['http_response_code'],
                'vender_code' => $pancardtogst['result_code'] ?? null,
                'pan_number' => $request->pancard_number ?? null,
                'created_at' => Carbon::now(),
                'updated_at' => Carbon::now(),
            ]);
        }
        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
    }
} else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);

                            }
                            DB::table('pantogstin')->insert([
            'user_id' => $user->id,
            'api_id' => $api_id,
            'status_code' => $statusCode,
            'message' => $errorMessage,
            'check_id' => isset($checkId) ? $checkId : null,
            'group_id' => isset($groupId) ? $groupId : null,
            'vender_status_code' => $pancardtogst['http_response_code'] ?? null,
            'vender_code' => $pancardtogst['result_code'] ?? null,
            'pan_number' => $request->pancard_number ?? null,
            'created_at' => Carbon::now(),
            'updated_at' => Carbon::now(),
        ]);
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
               } catch (BadResponseException $e) {
    $response = $e->getResponse();
    $errorResponse = json_decode($response->getBody(), true);
    $statusCode = $e->getResponse()->getStatusCode();

    // PAN Invalid case (example: result_code 400 or specific error message)
    if (isset($errorResponse['http_response_code']) && $errorResponse['http_response_code'] == 200 &&
        isset($errorResponse['result_code']) && $errorResponse['result_code'] == 400) {

        $statusCode = 102;
        $errorMessage = 'PAN Number Invalid. Please enter correct PAN Number.';

        if ($user->role_id == 1) {
            if ($apimaster) {
                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
            }
            DB::table('pantogstin')->insert([
                'user_id' => $user->id,
                'api_id' => $api_id,
                'status_code' => $statusCode,
                'message' => $errorMessage,
                'check_id' => isset($checkId) ? $checkId : null,
                'group_id' => isset($groupId) ? $groupId : null,
                'vender_status_code' => $errorResponse['http_response_code'] ?? null,
                'vender_code' => $errorResponse['result_code'] ?? null,
                'pan_number' => $request->pancard_number ?? null,
                'created_at' => Carbon::now(),
                'updated_at' => Carbon::now(),
            ]);
        }

        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);

    } else {

        $statusCode = 500;
        $errorMessage = 'Internal Server Error.';

        if ($user->role_id == 1) {
            if ($apimaster) {
                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
            }
            DB::table('pantogstin')->insert([
                'user_id' => $user->id,
                'api_id' => $api_id,
                'status_code' => $statusCode,
                'message' => $errorMessage,
                'check_id' => isset($checkId) ? $checkId : null,
                'group_id' => isset($groupId) ? $groupId : null,
                'vender_status_code' => $errorResponse['http_response_code'] ?? null,
                'vender_code' => $errorResponse['result_code'] ?? null,
                'pan_number' => $request->pancard_number ?? null,
                'created_at' => Carbon::now(),
                'updated_at' => Carbon::now(),
            ]);
        }

        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
    }
}

            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }



    public function esignv2(Request $request)
    {
        $api_id = null;
        // $access_token = $request->esign_access_token;
        $access_token = $request->header('AccessToken');
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'docboyzesign')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $user_accesign = User::where('access_token', $access_token)->first();
                if (isset($user_accesign) && $user_accesign != null) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Success.', 200);
                        }
                    }
                    //  return response()->json(['statusCode' => 200, 'Link' => "http://localhost:8000/esign_signnature/$access_token"]);
                    return response()->json(['statusCode' => 200, 'Link' => "https://regtechapi.in/esign_signnature/$access_token"]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                        }
                    }
                    return response()->json(['statusCode' => 102, 'message' => "invalid token. please enter correct valid token"]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function check_verification_email_status(Request $request)
    {
        $statusCode = null;
        $email_check_verify = null;
        $api_id = null;
        if (empty($request->identity)) {
            return response()->json(['message' => 'identity is required', 'statusCode' => 404]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'verifyemailstatus')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        $email_id = $request->identity;
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://13.233.136.139:8080/check_verification_status',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode(['identity' => $email_id]),
                    CURLOPT_HTTPHEADER => array(
                        'Content-Type: application/json'
                    ),
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $email_check_verify = json_decode($response, true);
                if (isset($email_check_verify['statuscode']) && $email_check_verify['statuscode'] == 200) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Success', 200);
                        }
                        DB::table('identify_verify_email')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'identity' => isset($email_check_verify['identity']) ? $email_check_verify['identity'] : null,
                            'verification_status' => isset($email_check_verify['verification_status']) ? $email_check_verify['verification_status'] : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $email_check_verify1['identity'] = isset($email_check_verify['identity']) ? $email_check_verify['identity'] : null;
                    $email_check_verify1['verification_status'] = isset($email_check_verify['verification_status']) ? $email_check_verify['verification_status'] : null;
                    return response()->json(['statusCode' => 200, 'data' => $email_check_verify1]);
                } elseif (isset($email_check_verify["error"]) && $email_check_verify["error"] == "An error occurred (InvalidParameterValue) when calling the GetIdentityVerificationAttributes operation: Identity $email_id is invalid. Must be a verified email address or domain.") {
                    $errorMessage = "Invalid email address.Please enter correct email address";
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);

                        }
                        DB::table('identify_verify_email')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 102, 'message' => $errorMessage]);
                } else {
                    $errorMessage = "Internal Server Error.";
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 500);
                        }
                        DB::table('identify_verify_email')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 500, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not register.please update your plan.']);
        }
    }

    public function verify_email(Request $request)
    {
        $statusCode = null;
        $email_verify = null;
        $api_id = null;
        if (empty($request->email_to_verify)) {
            return response()->json(['message' => 'email is required', 'statusCode' => 404]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'verifyemail')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        $email_id = $request->email_to_verify;
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://13.233.136.139:8080/verify_email',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode(['email_to_verify' => $email_id]),
                    CURLOPT_HTTPHEADER => array(
                        'Content-Type: application/json'
                    ),
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $email_verify = json_decode($response, true);
                if (isset($email_verify['statuscode']) && $email_verify['statuscode'] == 200) {
                    $email_verify_response = null;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Success', 200);
                        }
                        DB::table('verify_email')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'email_id' => isset($email_verify['email']) ? $email_verify['email'] : null,
                            'HTTPStatusCode' => isset($email_verify['response']['ResponseMetadata']['HTTPStatusCode']) ? $email_verify['response']['ResponseMetadata']['HTTPStatusCode'] : null,
                            'RequestId' => isset($email_verify['response']['ResponseMetadata']['RequestId']) ? $email_verify['response']['ResponseMetadata']['RequestId'] : null,
                            'RetryAttempts' => isset($email_verify['response']['ResponseMetadata']['RetryAttempts']) ? $email_verify['response']['ResponseMetadata']['RetryAttempts'] : null,
                            'verification_initiated' => isset($email_verify['verification_initiated']) ? $email_verify['verification_initiated'] : null,
                            'verification_status' => isset($email_verify['verification_status']) ? $email_verify['verification_status'] : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $email_verify_response['email'] = isset($email_verify['email']) ? $email_verify['email'] : null;
                    $email_verify_response['HTTPStatusCode'] = isset($email_verify['response']['ResponseMetadata']['HTTPStatusCode']) ? $email_verify['response']['ResponseMetadata']['HTTPStatusCode'] : null;
                    $email_verify_response['RequestId'] = isset($email_verify['response']['ResponseMetadata']['RequestId']) ? $email_verify['response']['ResponseMetadata']['RequestId'] : null;
                    $email_verify_response['RetryAttempts'] = isset($email_verify['response']['ResponseMetadata']['RetryAttempts']) ? $email_verify['response']['ResponseMetadata']['RetryAttempts'] : null;
                    $email_verify_response['verification_initiated'] = isset($email_verify['verification_initiated']) ? $email_verify['verification_initiated'] : null;
                    $email_verify_response['verification_status'] = isset($email_verify['verification_status']) ? $email_verify['verification_status'] : null;
                    return response()->json(['statusCode' => 200, 'data' => $email_verify_response]);
                } elseif (isset($email_verify["error"]) && $email_verify["error"] == "An error occurred (InvalidParameterValue) when calling the VerifyEmailIdentity operation: Invalid email address<$email_id>.") {
                    $errorMessage = "Invalid email address.Please enter correct email address";
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);

                        }
                        DB::table('verify_email')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 102, 'message' => $errorMessage]);
                } else {
                    $errorMessage = "Internal Server Error.";
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 500);
                        }
                        DB::table('verify_email')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 500, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not register.please update your plan.']);
        }
    }
    public function dedupe_s3(Request $request)
    {
        $statusCode = null;
        $dedupe_s3_details = null;
        $api_id = null;
        if (empty($request->bucket_name)) {
            return response()->json(['message' => 'bucket_name is required', 'statusCode' => 404]);
        }
        if (empty($request->prefix)) {
            return response()->json(['message' => 'prefix is required', 'statusCode' => 404]);
        }
        if (empty($request->aws_access_key_id)) {
            return response()->json(['message' => 'aws_access_key_id is required', 'statusCode' => 404]);
        }
        if (empty($request->aws_secret_access_key)) {
            return response()->json(['message' => 'aws_secret_access_key is required', 'statusCode' => 404]);
        }
        if (empty($request->region_name)) {
            return response()->json(['message' => 'region_name is required', 'statusCode' => 404]);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'dedupe')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        $bucket_name = $request->bucket_name;
        $prefix = $request->prefix;
        $aws_access_key_id = $request->aws_access_key_id;
        $aws_secret_access_key = $request->aws_secret_access_key;
        $region_name = $request->region_name;

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://13.233.136.139:8080/dedupe_s3',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => array(
                        'bucket_name' => $bucket_name,
                        'prefix' => $prefix,
                        'aws_access_key_id' => $aws_access_key_id,
                        'aws_secret_access_key' => $aws_secret_access_key,
                        'region_name' => $region_name,
                    )
                ]);
                $response = curl_exec($curl);
                curl_close($curl);
                $dedupe_s3_details = json_decode($response, true);
                if (isset($dedupe_s3_details['statuscode']) && $dedupe_s3_details['statuscode'] == 200) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Success', 200);
                        }
                        DB::table('dedupe_s3')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'deleted_files' => isset($dedupe_s3_details['deleted_files']) ? json_encode($dedupe_s3_details['deleted_files']) : null,
                            'bucket_name' => isset($bucket_name) ? $bucket_name : null,
                            'prefix' => isset($bucket_name) ? $bucket_name : null,
                            'aws_access_key_id' => isset($aws_access_key_id) ? $aws_access_key_id : null,
                            'aws_secret_access_key' => isset($aws_secret_access_key) ? $aws_secret_access_key : null,
                            'region_name' => isset($region_name) ? $region_name : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $dedupe_s3_details1['deleted_files'] = $dedupe_s3_details['deleted_files'];
                    return response()->json(['statusCode' => 200, 'data' => $dedupe_s3_details1]);
                } elseif (isset($dedupe_s3_details["statuscode"]) && $dedupe_s3_details["statuscode"] == 102) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);

                        }
                        DB::table('dedupe_s3')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'bucket_name' => isset($bucket_name) ? $bucket_name : null,
                            'prefix' => isset($bucket_name) ? $bucket_name : null,
                            'aws_access_key_id' => isset($aws_access_key_id) ? $aws_access_key_id : null,
                            'aws_secret_access_key' => isset($aws_secret_access_key) ? $aws_secret_access_key : null,
                            'region_name' => isset($region_name) ? $region_name : null,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 102, 'message' => $dedupe_s3_details['error']]);
                } else {
                    $errorMessage = "Internal Server Error.";
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', 500);
                        }
                        DB::table('dedupe_s3')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'bucket_name' => isset($bucket_name) ? $bucket_name : null,
                            'prefix' => isset($bucket_name) ? $bucket_name : null,
                            'aws_access_key_id' => isset($aws_access_key_id) ? $aws_access_key_id : null,
                            'aws_secret_access_key' => isset($aws_secret_access_key) ? $aws_secret_access_key : null,
                            'region_name' => isset($region_name) ? $region_name : null,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 500, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharage your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not register.please update your plan.']);
        }
    }
    public function bankStatement(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        $bankStatement = [];
        if (empty($request->hasFile('file'))) {
            return response()->json(['message' => 'file is required', 'statusCode' => '404']);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank_statement')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();


        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    // CURLOPT_URL => 'http://pyn.regtechapi.in/extract-bank-statement',
                    CURLOPT_URL => 'http://3.108.3.216:5000/extract-bank-statement',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ]);

                $response = curl_exec($curl);
                curl_close($curl);
                $bankstatment = json_decode($response, true);
                if (isset($bankstatment[0]['extracted_info'])) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                    $bankStatement = $bankstatment[0]['extracted_info']['tabular_data'][0];
                    $customPdfSize = [0, 0, 967.0, 967.8];
                    $pdf = PDF::loadView('kyc.statementpdf_loantap', compact('bankStatement'))->setPaper($customPdfSize, 'A4');
                    $bankstatement_pdf_content = $pdf->output();
                    $bankstatement_pdf_content_base64 = base64_encode($bankstatement_pdf_content);
                    return response()->json(['statusCode' => 200, 'bank_statement' => $bankstatment, 'bank_details' => $bankstatement_pdf_content_base64]);
                } elseif (isset($bankstatment['error']) && $bankstatment['error'] == 'Invalid file type, must be a PDF') {
                    $statusCode = 102;
                    $errorMessage = 'Invalid file type, must be a PDF';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                    }
                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                } elseif (isset($bankstatment['error']) && $bankstatment['error'] == 'No file provided') {
                    $statusCode = 404;
                    $errorMessage = 'No image file provided';
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif (isset($bankstatment['Status']) && $bankstatment['Status'] == 102) {
                    $headers = ['Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJEb2NCb3l6IiwiaWF0IjoxNjkzMzEyNTg2OTc4fQ.mMgl0deNRbkCXT0LnE8t7hRbTkwoK9TbnCrAS-TtjR4'];
                    $data = [
                        'bank' => $request->bank_name,
                        'bankStmt' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                        'accountType' => $request->account_type,
                    ];
                    $url = 'https://prod.ltflow.com/ltflow/bank-statement/summary';
                    $ch = curl_init($url);
                    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                    $get_data = curl_exec($ch);
                    $bankstatment = json_decode($get_data, true);
                    $bankstatment_response = null;
                    $bankstatment_response_permission = null;
                    if (isset($bankstatment['bank_account']) || (isset($bankstatment['FraudAnalytics']) && $bankstatment['FraudAnalytics']['status'] == 'SUCCESS')) {

                        $bankStatements = [];
                        foreach ($bankstatment['transactions'] as $key => $item) {
                            $bankStatement = [
                                'TransactionId' => isset($item['transactionId']) ? $item['transactionId'] : ' ',
                                'description' => isset($item['description']) ? $item['description'] : ' ',
                                'type' => isset($item['type']) ? $item['type'] : ' ',
                                'category' => isset($item['category']) ? $item['category'] : ' ',
                                'amount' => isset($item['amount']) ? $item['amount'] : '',
                                'balanceAfterTransaction' => isset($item['balanceAfterTransaction']) ? $item['balanceAfterTransaction'] : '',
                                'dateTime' => isset($item['dateTime']) ? $item['dateTime'] : ' ',
                            ];
                            $bankStatements[] = $bankStatement;
                        }
                        $customPaper = [0, 0, 967.0, 967.8];
                        $pdf = PDF::loadView('kyc.statementpdf_loantap', compact('bankStatements'))->setPaper($customPaper, 'landscape');
                        $bankstatement_pdf_content = $pdf->output();
                        $bankstatement_pdf_content_base64 = base64_encode($bankstatement_pdf_content);
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        return response()->json(['status_code' => 200, 'bank_statement' => $bankstatment, 'bank_details' => $bankstatement_pdf_content_base64]);
                    } elseif (isset($bankstatment['errors']) && $bankstatment['status'] == 'ERROR') {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                            }
                        }
                        return response()->json(['statusCode' => 102, 'errors' => $bankstatment['errors']]);
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                            }
                        }
                        return response()->json(['statusCode' => 500, 'errors' => 'Internal Server Error. Please contact techsupport@docboyz.in. for more details']);
                    }
                } else {
                    $headers = ['Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJEb2NCb3l6IiwiaWF0IjoxNjkzMzEyNTg2OTc4fQ.mMgl0deNRbkCXT0LnE8t7hRbTkwoK9TbnCrAS-TtjR4'];
                    $data = [
                        'bank' => $request->bank_name,
                        'bankStmt' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name']),
                        'accountType' => $request->account_type,
                    ];
                    $url = 'https://prod.ltflow.com/ltflow/bank-statement/summary';
                    $ch = curl_init($url);
                    curl_setopt($ch, CURLOPT_POSTFIELDS, $data);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                    $get_data = curl_exec($ch);
                    $bankstatment = json_decode($get_data, true);
                    $bankstatment_response = null;
                    $bankstatment_response_permission = null;
                    if (isset($bankstatment['bank_account']) || (isset($bankstatment['FraudAnalytics']) && $bankstatment['FraudAnalytics']['status'] == 'SUCCESS')) {

                        $bankStatements = [];
                        foreach ($bankstatment['transactions'] as $key => $item) {
                            $bankStatement = [
                                'TransactionId' => isset($item['transactionId']) ? $item['transactionId'] : ' ',
                                'description' => isset($item['description']) ? $item['description'] : ' ',
                                'type' => isset($item['type']) ? $item['type'] : ' ',
                                'category' => isset($item['category']) ? $item['category'] : ' ',
                                'amount' => isset($item['amount']) ? $item['amount'] : '',
                                'balanceAfterTransaction' => isset($item['balanceAfterTransaction']) ? $item['balanceAfterTransaction'] : '',
                                'dateTime' => isset($item['dateTime']) ? $item['dateTime'] : ' ',
                            ];
                            $bankStatements[] = $bankStatement;
                        }
                        $customPaper = [0, 0, 967.0, 967.8];
                        $pdf = PDF::loadView('kyc.statementpdf_loantap', compact('bankStatements'))->setPaper($customPaper, 'landscape');
                        $bankstatement_pdf_content = $pdf->output();
                        $bankstatement_pdf_content_base64 = base64_encode($bankstatement_pdf_content);
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                        }
                        return response()->json(['status_code' => 200, 'bank_statement' => $bankstatment, 'bank_details' => $bankstatement_pdf_content_base64]);
                    } elseif (isset($bankstatment['errors']) && $bankstatment['status'] == 'ERROR') {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                            }
                        }
                        return response()->json(['statusCode' => 102, 'errors' => $bankstatment['errors']]);
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                            }
                        }
                        return response()->json(['statusCode' => 500, 'errors' => 'Internal Server Error. Please contact techsupport@docboyz.in. for more details']);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function CompanyProducts(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        $companyDetails = [];
        if (empty($request->companyName) && empty($request->flrsLicenseNo)) {
            return response()->json(['message' => 'Atleast one parameter is required.', 'statusCode' => '404']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'companyproduct')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $companyName = $request->companyName;
                $flrsLicenseNo = $request->flrsLicenseNo;
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/fetch-company-products',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode([
                        'premiseState' => null,
                        'premiseDistrict' => null,
                        'companyName' => $companyName,
                        'flrsLicenseNo' => $flrsLicenseNo,
                    ]),
                    CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
                ]);

                $response = curl_exec($curl);
                curl_close($curl);
                $companyProductDetails = json_decode($response, true);
                if (isset($companyProductDetails[0]['companyDetails'])) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }
                    return response()->json(['status_code' => 200, 'company_details' => $companyProductDetails]);
                } elseif (isset($companyProductDetails['status']) && $companyProductDetails['status'] == 500) {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    }

                    return response()->json(['status_code' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 102;
                    $errorMessage = 'invalid companyName or flrsLicenseNo';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                    }

                    return response()->json(['status_code' => 102, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function ByPanId(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->bypan_id)) {
            return response()->json(['message' => 'pancard is required.', 'statusCode' => '404']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bypancard')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $bypan_id = $request->bypan_id;
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/bypan',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode([
                        'bypan_id' => $bypan_id,
                    ]),
                    CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
                ]);

                $response = curl_exec($curl);
                curl_close($curl);
                $pancard = json_decode($response, true);
                if (isset($pancard['status']) && $pancard['status'] == 200) {
                    $pancard_response = null;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('pancard_gstin')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'gstin' => isset($pancard['GSTIN']) ? $pancard['GSTIN'] : null,
                            'gstin_status' => isset($pancard['GSTIN_STATUS']) ? $pancard['GSTIN_STATUS'] : null,
                            'state' => isset($pancard['STATE']) ? $pancard['STATE'] : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $pancard_response['SNO'] = isset($pancard['SNO']) ? $pancard['SNO'] : null;
                    $pancard_response['GSTIN'] = isset($pancard['GSTIN']) ? $pancard['GSTIN'] : null;
                    $pancard_response['GSTIN_STATUS'] = isset($pancard['GSTIN_STATUS']) ? $pancard['GSTIN_STATUS'] : null;
                    $pancard_response['STATE'] = isset($pancard['STATE']) ? $pancard['STATE'] : null;
                    return response()->json(['statusCode' => 200, 'data' => $pancard_response]);
                } elseif (isset($pancard['status']) && $pancard['status'] == 408) {
                    $statusCode = 202;
                    $errorMessage = 'Server Error.Please try later';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 202);
                        }
                        DB::table('pancard_gstin')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 202,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif (isset($pancard['status']) && $pancard['status'] == 401) {
                    $statusCode = 401;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('pancard_gstin')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 401,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error.Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('pancard_gstin')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => 500, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function gstin_details(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->gstin_id)) {
            return response()->json(['message' => 'gstin id is required.', 'statusCode' => '404']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'gstindetails')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $gstin_id = $request->gstin_id;
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/htp',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode([
                        'htp_id' => $gstin_id,
                    ]),
                    CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
                ]);

                $response = curl_exec($curl);
                curl_close($curl);
                $gstin_details = json_decode($response, true);
                if (isset($gstin_details['status']) && $gstin_details['status'] == 200) {
                    $gstin_details1 = null;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('gstin_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'nature_of_business_activity' => isset($gstin_details['Nature of Business Activities']) ? $gstin_details['Nature of Business Activities'] : null,
                            'dealing_goods_and_service' => isset($gstin_details['Dealing in Goods and Services']) ? $gstin_details['Dealing in Goods and Services'] : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $gstin_details1['Nature of Business Activities'] = isset($gstin_details['Nature of Business Activities']) ? $gstin_details['Nature of Business Activities'] : null;
                    $gstin_details1['Dealing in Goods and Services'] = isset($gstin_details['Dealing in Goods and Services']) ? $gstin_details['Dealing in Goods and Services'] : null;
                    return response()->json(['statusCode' => 200, 'data' => $gstin_details1]);
                } elseif (isset($gstin_details['status']) && $gstin_details['status'] == 408) {
                    $statusCode = 202;
                    $errorMessage = 'Server Error.Please try later';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 202);
                        }
                        DB::table('gstin_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 202,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif (isset($gstin_details['status']) && $gstin_details['status'] == 401) {
                    $statusCode = 401;
                    $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('gstin_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 401,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error.Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('gstin_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => 500, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function LandRecord(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->Url)) {
            return response()->json(['message' => 'url is required.', 'statusCode' => '404']);
        }
        if (empty($request->OP)) {
            return response()->json(['message' => 'op is required.', 'statusCode' => '404']);
        }
        if (empty($request->GstStateCode)) {
            return response()->json(['message' => 'gst state code is required.', 'statusCode' => '404']);
        }
        if (empty($request->Levels)) {
            return response()->json(['message' => 'levels is required.', 'statusCode' => '404']);
        }
        if (empty($request->X_Coordinate)) {
            return response()->json(['message' => 'x coordinate is required.', 'statusCode' => '404']);
        }
        if (empty($request->Y_Coordinate)) {
            return response()->json(['message' => 'y coordinate is required.', 'statusCode' => '404']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'land')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $url = $request->Url;
                $op = $request->OP;
                $state_code = $request->GstStateCode;
                $lavels = $request->Levels;
                $x_coordinate = $request->X_Coordinate;
                $y_coordinate = $request->Y_Coordinate;
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/land',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode([
                        "url" => $url,
                        "op" => $op,
                        "state" => $state_code,
                        "levels" => $lavels,
                        "x" => $x_coordinate,
                        "y" => $y_coordinate
                    ]),
                    CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
                ]);
                $response = curl_exec($curl);
                $http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                curl_close($curl);
                $land_record = json_decode($response, true);
                if (isset($land_record['status']) && $land_record['status'] == 200) {
                    $land_record1 = null;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('land_record')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'IdNumber' => isset($land_record['ID']) ? $land_record['ID'] : null,
                            'PNIU' => isset($land_record['PNIU']) ? $land_record['PNIU'] : null,
                            'attrs' => isset($land_record['attrs']) ? $land_record['attrs'] : null,
                            'gisCode' => isset($land_record['gisCode']) ? $land_record['gisCode'] : null,
                            'has_data' => isset($land_record['has_data']) ? $land_record['has_data'] : null,
                            'info' => isset($land_record['info']) ? $land_record['info'] : null,
                            'pdf_base64' => isset($land_record['pdf_base64']) ? $land_record['pdf_base64'] : null,
                            'plotInfoLinks' => isset($land_record['plotInfoLinks']) ? $land_record['plotInfoLinks'] : null,
                            'xmin' => isset($land_record['xmin']) ? $land_record['xmin'] : null,
                            'xmax' => isset($land_record['xmax']) ? $land_record['xmax'] : null,
                            'ymin' => isset($land_record['ymin']) ? $land_record['ymin'] : null,
                            'ymax' => isset($land_record['ymax']) ? $land_record['ymax'] : null,
                            'plotNo' => isset($land_record['plotNo']) ? $land_record['plotNo'] : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 200, 'data' => $land_record]);
                } elseif (isset($land_record['status']) && $land_record['status'] == 408) {
                    $statusCode = 202;
                    $errorMessage = 'Server Error Please try later.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 202);
                        }
                        DB::table('land_record')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 202,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif (isset($land_record['status']) && $land_record['status'] == 500 && isset($http_code) && $http_code == 200) {
                    $statusCode = 102;
                    $errorMessage = 'Invalid land details.Please enter correct land details.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        DB::table('land_record')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error.Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('gstin_details')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => 500, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function CommunityArea(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->latitude)) {
            return response()->json(['message' => 'latitude is required.', 'statusCode' => '404']);
        }
        if (empty($request->longitude)) {
            return response()->json(['message' => 'longitude is required.', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'communityarea')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/fsffd',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode([
                        "x" => $request->latitude,
                        "y" => $request->longitude
                    ]),
                    CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
                ]);
                $response = curl_exec($curl);
                $http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                curl_close($curl);
                $community_area = json_decode($response, true);
                if (isset($community_area['status']) && $community_area['status'] == 200) {
                    $community_area1 = null;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('communities_area')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'page' => isset($community_area['page']) ? $community_area['page'] : null,
                            'temple_count' => isset($community_area['temple_count']) ? $community_area['temple_count'] : null,
                            'church_count' => isset($community_area['church_count']) ? $community_area['church_count'] : null,
                            'mosque_count' => isset($community_area['mosque_count']) ? $community_area['mosque_count'] : null,
                            'gurudwara_count' => isset($community_area['gurudwara_count']) ? $community_area['gurudwara_count'] : null,
                            'Timestamp' => isset($community_area['Timestamp']) ? $community_area['Timestamp'] : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $community_area1['page'] = isset($community_area['page']) ? $community_area['page'] : null;
                    $community_area1['temple_count'] = isset($community_area['temple_count']) ? $community_area['temple_count'] : null;
                    $community_area1['church_count'] = isset($community_area['church_count']) ? $community_area['church_count'] : null;
                    $community_area1['mosque_count'] = isset($community_area['mosque_count']) ? $community_area['mosque_count'] : null;
                    $community_area1['gurudwara_count'] = isset($community_area['gurudwara_count']) ? $community_area['gurudwara_count'] : null;
                    $community_area1['Timestamp'] = isset($community_area['Timestamp']) ? $community_area['Timestamp'] : null;
                    return response()->json(['statusCode' => 200, 'data' => $community_area1]);
                } elseif (isset($community_area['status']) && $community_area['status'] == 408) {
                    $statusCode = 202;
                    $errorMessage = 'Server Error Please try later.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 202);
                        }
                        DB::table('communities_area')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 202,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => 202, 'message' => $errorMessage]);
                } elseif (isset($community_area['status']) && $community_area['status'] == 500 && isset($http_code) && $http_code == 200) {
                    $statusCode = 102;
                    $errorMessage = 'Invalid latitude and longitude.Please enter correct latitude and longitude.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        DB::table('communities_area')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error.Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('communities_area')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => 500, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function DetectionEmotion(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->hasFile('image_file'))) {
            return response()->json(['message' => 'image file is required.', 'statusCode' => '103']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'detectionemotion')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/detect_emotion',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['image' => new \CURLFILE($_FILES['image_file']['tmp_name'], $_FILES['image_file']['type'], $_FILES['image_file']['name'])],
                ));
                $response = curl_exec($curl);
                $statusCode = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                $detect_emotion = json_decode($response, true);
                curl_close($curl);
                if (isset($detect_emotion['emotions']) && $statusCode == 200) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('emotions')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'detected_emotions_description' => isset($detect_emotion['emotions'][0]) ? $detect_emotion['emotions'][0] : null,
                            'status_code' => 200,
                            'message_code' => "success",
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'response' => $detect_emotion]);
                } elseif (isset($detect_emotion['emotions']) && $detect_emotion['emotions'] == "[Errno 5] Input/output error") {
                    $statusCode = 102;
                    $errorMessage = 'Image does not detect.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        $detect_emotaions = DB::table('emotions')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message_code' => "failed",
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);

                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif (isset($detect_emotion['error']) && $detect_emotion['error'] == "name 'emo' is not defined") {
                    $statusCode = 102;
                    $errorMessage = 'name emo is not defined';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        $detect_emotaions = DB::table('emotions')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message_code' => "failed",
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);

                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        $detect_emotaions = DB::table('emotions')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message_code' => "failed",
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function faceMatch1(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->hasFile('KnownFace'))) {
            return response()->json(['message' => 'known face is required.', 'statusCode' => '103']);
        }
        if (empty($request->hasFile('Img'))) {
            return response()->json(['message' => 'image is required.', 'statusCode' => '103']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'facematchone')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/rec_faces',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['known_face' => new \CURLFILE($_FILES['KnownFace']['tmp_name'], $_FILES['KnownFace']['type'], $_FILES['KnownFace']['name']), 'image1' => new \CURLFILE($_FILES['Img']['tmp_name'], $_FILES['Img']['type'], $_FILES['Img']['name'])],
                ));
                $response = curl_exec($curl);
                curl_close($curl);
                $rec_faces = json_decode($response, true);
                if (isset($rec_faces['result']) && $rec_faces['result'] == true) {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('face_match')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'result' => $rec_faces['result'],
                            'status_code' => 200,
                            'message_code' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['status_code' => 200, 'rec_face' => $rec_faces]);
                } elseif (isset($rec_faces['error']) && $rec_faces['error'] == "[Errno 5] Input/output error") {
                    $statusCode = 102;
                    $errorMessage = 'face match failed.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        DB::table('face_match')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'status_code' => 102,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif (isset($rec_faces['error']) && $rec_faces['error'] == "name 'face_recognition' is not defined") {
                    $statusCode = 102;
                    $errorMessage = 'name face_recognition is not defined.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        DB::table('face_match')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'status_code' => 102,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('face_match')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'status_code' => 500,
                            'message_code' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function DetectionFace(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->hasFile('file'))) {
            return response()->json(['message' => 'file is required.', 'statusCode' => '103']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'detectionface')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/detect_faces',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ));
                $response = curl_exec($curl);
                $http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                curl_close($curl);
                $detection_face = strval($response);
                if (isset($detection_face) && $detection_face != "OpenCV(4.9.0) /io/opencv/modules/imgproc/src/color.cpp:196: error: (-215:Assertion failed) !_src.empty() in function 'cvtColor'\n") {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('detected_face')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'face_detect_base64' => isset($detection_face) ? base64_encode($detection_face) : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);

                    }

                    return response()->json(['statusCode' => 200, 'data' => base64_encode($detection_face)]);
                } elseif (isset($detection_face) && $detection_face == "OpenCV(4.9.0) /io/opencv/modules/imgproc/src/color.cpp:196: error: (-215:Assertion failed) !_src.empty() in function 'cvtColor'\n") {
                    $statusCode = 102;
                    $errorMessage = 'face detection failed.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        DB::table('detected_face')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error. Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('detected_face')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'status_code' => 500,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function imageScanner(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->hasFile('file'))) {
            return response()->json(['message' => 'file is required.', 'statusCode' => '103']);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'imagescanner')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, array(
                    CURLOPT_URL => 'http://pyn.regtechapi.in/image_scanner',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => ['file' => new \CURLFILE($_FILES['file']['tmp_name'], $_FILES['file']['type'], $_FILES['file']['name'])],
                ));
                $response = curl_exec($curl);

                $http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                curl_close($curl);
                if (isset($http_code) && $http_code == 200) {
                    $image_scanner = $response;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('imagescanner')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'image_base64' => isset($image_scanner) ? base64_encode($image_scanner) : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => 200, 'data' => base64_encode($image_scanner)]);
                } elseif (isset($http_code) && $http_code == 500) {
                    $statusCode = 102;
                    $errorMessage = 'No such file or directory/tmp/tmpe586e4_d/output.png';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        DB::table('imagescanner')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error.Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('imagescanner')->insert([
                            'api_id' => $api_id,
                            'user_id' => $user->id,
                            'status_code' => 500,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    public function PinCodeDistance(Request $request)
    {
        $statusCode = null;
        $api_id = null;
        if (empty($request->from_pin)) {
            return response()->json(['message' => 'from pin is required.', 'statusCode' => '404']);
        }
        if (empty($request->to_pin)) {
            return response()->json(['message' => 'to pin is required.', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'pincode')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();

        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'http://pyn.regtechapi.in/pin',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_ENCODING => '',
                    CURLOPT_MAXREDIRS => 10,
                    CURLOPT_TIMEOUT => 0,
                    CURLOPT_FOLLOWLOCATION => true,
                    CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_POSTFIELDS => json_encode([
                        "from_pin" => $request->from_pin,
                        "to_pin" => $request->to_pin
                    ]),
                    CURLOPT_HTTPHEADER => ['Content-Type: application/json'],
                ]);
                $response = curl_exec($curl);
                $http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
                curl_close($curl);
                $pincode_details = json_decode($response, true);
                if (isset($pincode_details['status']) && $pincode_details['status'] == 200) {
                    $pincode_details1 = null;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        DB::table('pincode')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'from_pin' => isset($pincode_details['fromPin']) ? $pincode_details['fromPin'] : null,
                            'to_pin' => isset($pincode_details['toPin']) ? $pincode_details['toPin'] : null,
                            'distance' => isset($pincode_details['distance']) ? $pincode_details['distance'] : null,
                            'status_code' => 200,
                            'message' => 'success',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $pincode_details1['fromPin'] = isset($pincode_details['fromPin']) ? $pincode_details['fromPin'] : null;
                    $pincode_details1['toPin'] = isset($pincode_details['toPin']) ? $pincode_details['toPin'] : null;
                    $pincode_details1['distance'] = isset($pincode_details['distance']) ? $pincode_details['distance'] : null;
                    return response()->json(['statusCode' => 200, 'data' => $pincode_details1]);
                } elseif (isset($pincode_details['status']) && $pincode_details['status'] == 408) {
                    $statusCode = 202;
                    $errorMessage = 'Server Error Please try later.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 202);
                        }
                        DB::table('pincode')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } elseif (isset($pincode_details['status']) && $pincode_details['status'] == 500 && isset($http_code) && $http_code == 200) {
                    $statusCode = 102;
                    $errorMessage = 'Invalid from pincode and to pincode.Please enter correct from pincode and to pincode.';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', $statusCode);
                        }
                        DB::table('pincode')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 102,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                } else {
                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error.Please contact techsupport@docboyz.in. for more details';
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                        DB::table('pincode')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status_code' => 500,
                            'message' => 'failed',
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => 500, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);

            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }


    public function script_tracing(Request $request)
    {
        // return "test";
        $validator = Validator::make($request->all(), [
            'phone_number' => 'required|regex:/^[0-9]{10}$/',
            'pan_num' => 'required',
        ]);
        if ($validator->fails()) {
            return response()->json([
                'status' => 'Forbidden',
                'errors' => $validator->errors(),
            ], 403);
        }
        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Access Token is required', 'statusCode' => '404']);
        }
        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => '404']);
        }

        $sql = DB::table('equifax_pdf_request')->insert([
            'firstName' => $request->fname,
            'lastName' => $request->lname,
            'contactNo' => $request->phone_number,
            'idValue' => $request->pan_num,
            'created_at' => date('Y-m-d H:i:s')
        ]);
        $api_id = null;
        // $validator = Validator::make($request -> all(),[
        //     // 'FirstName' => ['required','string','max:255'],
        //     // 'LastName' => ['required','string','max:255'],
        //     'ContactNo' => ['required','string','max:255'],
        //     'IDValue' => ['required'],
        // ]);
        $record_id = DB::table('equifax_pdf_request')->orderBy('id', 'desc')->first();
        $aadhar_num = $request->aadhar_num ? $request->aadhar_num : null;
        $pan_num = $request->pan_num ? $request->pan_num : null;
        $voter_id = $request->voter_num ? $request->voter_num : null;
        $passport = $request->passport_num ? $request->passport_num : null;
        $driving_licence = $request->driving_num ? $request->driving_num : null;

        // if($validator -> fails())
        //     return response() -> json(['Errors' => $validator -> errors(),
        //                                 'statusCode' => '404']);
        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // return 'true';
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'equifax')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }
        $uname = $user->name;
        // $uname = DB::table('users')->where('id', Auth::id())->get()->first();
        $arr = explode(' ', trim($uname));
        $usr = '';
        $substr = '';
        foreach ($arr as $array) {
            $substr = substr($array, 0, 1);
            $usr = $usr . $substr;
        }
        $recordId = sprintf("%04d", $record_id->id);
        $CustRefField = "DB-" . strtoupper($usr) . Carbon::now()->format('y') . Carbon::now()->format('m') . $recordId;
        $headers = [
            'Content-Type' => 'application/json',
            'Authorization' => 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ0bGFuZCIsImlhdCI6MTY5MTM4NDEzODczNH0.nHmNhb-NlFPziNE_-9iEGKTIVoiz5rM_lNVvPLvQLgU',
        ];
        $body =
            [
                "InquiryPurpose" => "10",
                "TransactionAmount" => "",
                "FirstName" => $request->fname,
                "MiddleName" => "",
                "LastName" => $request->lname,
                "InquiryAddresses" => [
                    [
                        "seq" => "1",
                        "AddressType" => [
                            "H"
                        ],
                        "AddressLine1" => "",
                        "AddressLine2" => "",
                        "Locality" => "",
                        "City" => "",
                        "State" => "",
                        "Postal" => ""
                    ]
                ],
                "InquiryPhones"=>[
                    [
                        "seq"=>"16",
                        "Number"=>$request->phone_number,
                        "PhoneType"=>[
                            "M"
                        ]
                    ]
                ],
                "IDDetails" => [
                    [
                        "seq" => "1",
                        "IDType" => "T",
                        "IDValue" => $request->pan_num
                    ]
                ],
                "DOB" => $request->dob
            ];
        // $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', 41)->orderBy('id', 'desc')->first();
        $api_id =41;
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return 'ok';
                try {
                    $client = new Client();
                    $res = $client->post("https://6lzpgvkn3f.execute-api.ap-south-1.amazonaws.com/equifax/score", ['headers' => $headers, 'json' => $body]);
                    $response = json_decode($res->getBody(), true);
                    // return $response;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    // return $statusCode;
                    if ($statusCode == 500) {
                        // $statusCode = 201;
                        $statusCode = 500;
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        // $errorMessage = 'Consumer Details Not Found';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 50000000, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
        if (isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) && $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] > 00) {
            $equifaxResponse = null;
            if (isset($response['data']['InquiryResponseHeader']) && isset($response['data']['CCRResponse'])) {
                // $equifaxResponse['InquiryResponseHeader']['ClientID'] = isset($response['data']['InquiryResponseHeader']['ClientID']) ? $response['data']['InquiryResponseHeader']['ClientID'] : null;
                // $equifaxResponse['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                // $equifaxResponse['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['InquiryResponseHeader']['ReportOrderNO'] : null;
                // $equifaxResponse['InquiryResponseHeader']['ProductCode'] = isset($response['data']['InquiryResponseHeader']['ProductCode']) ? $response['data']['InquiryResponseHeader']['ProductCode'] : null;
                // $equifaxResponse['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['InquiryResponseHeader']['SuccessCode']) ? $response['data']['InquiryResponseHeader']['SuccessCode'] : null;
                // $equifaxResponse['InquiryResponseHeader']['Date'] = isset($response['data']['InquiryResponseHeader']['Date']) ? $response['data']['InquiryResponseHeader']['Date'] : null;
                // $equifaxResponse['InquiryResponseHeader']['Time'] = isset($response['data']['InquiryResponseHeader']['Time']) ? $response['data']['InquiryResponseHeader']['Time'] : null;
                // $equifaxResponse['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['InquiryRequestInfo']['InquiryPurpose'] : null;
                $equifaxResponse['FirstName'] = isset($response['data']['InquiryRequestInfo']['FirstName']) ? $response['data']['InquiryRequestInfo']['FirstName'] : null;
                $equifaxResponse['LastName'] = isset($response['data']['InquiryRequestInfo']['LastName']) ? $response['data']['InquiryRequestInfo']['LastName'] : null;
                // $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                // $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                // $equifaxResponse['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                // $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                // $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                // $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                // $equifaxResponse['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                // $equifaxResponse['InquiryRequestInfo']['DOB'] = isset($request->dob) ? $request->dob : null;
                // $equifaxResponse['Score'] = isset($response['data']['Score']) ? $response['data']['Score'] : null;
                // $equifaxResponse['CCRResponse']['Status'] = isset($response['data']['CCRResponse']['Status']) ? $response['data']['CCRResponse']['Status'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerCode'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustRefField'] = isset($CustRefField) ? $CustRefField : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ReportOrderNO'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['TranID'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['ProductCode'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['SuccessCode'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Date'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['Time'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['HitCode'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryResponseHeader']['CustomerName'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPurpose'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['FirstName'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['LastName'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["seq"] = "1";
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["PhoneType"][0] = "M";
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['InquiryPhones'][0]["Number"] = isset($request->phone_number) ? $request->phone_number : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["seq"] = "1";
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDType"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDType'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["IDValue"] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]['IDValue'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['IDDetails'][0]["Source"] = "Inquiry";
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['DOB'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['DateOfBirth'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][0] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1]) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['InquiryRequestInfo']['CustomFields'][1] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['Score'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['Score']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['Score'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PersonalInfo']['Occupation'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['IdentityInfo'] : null;
                $equifaxResponse['AddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['AddressInfo'] : null;
                $equifaxResponse['PhoneInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['PhoneInfo']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] : null;
                $equifaxResponse['EmailAddressInfo'] = 
                (isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo']) 
                && !empty($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo']))
                ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['IDAndContactInfo']['EmailAddressInfo'] 
                : null;

                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountDetails'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RetailAccountsSummary'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['ScoreDetails'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['EnquirySummary'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['OtherKeyInd'] : null;
                // $equifaxResponse['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] = isset($response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities']) ? $response['data']['CCRResponse']['CIRReportDataLst'][0]['CIRReportData']['RecentActivities'] : null;
            }
            return response()->json(['script_tracing' => $equifaxResponse, 'statusCode' => '200']);
        } else {
            $equifaxResponse = null;
            $user = User::where('access_token', $request->header('AccessToken'))->first();
            if ($user->role_id == 1) {
                $apimaster = ApiMaster::where('api_slug', 'pandetails1')->first();
                if ($apimaster) {
                    $api_id = $apimaster->id;
                }
            }
            $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
                ->where('api_id', $api_id)
                ->orderBy('id', 'desc')
                ->first();
            $client = new Client();
            $groupId = rand(100, 10000000000);
            $checkId = rand(100, 10000000000);
            $headers = [
                'Accept' => 'application/json',
                'x-api-key' => '24r4figxopl5lw0b3nmlwf414jry1d0hq',
            ];
            $body = [
                'panNumber' => $request->pan_num,
                'groupId' => $groupId,
                'checkId' => $checkId,
            ];
            
            try {
                    $response = $client->post('https://api.kyckart.com/api/panCard/panDetailedContactV4', [
                        'headers' => $headers,
                        'json' => $body,
                    ]);
                    $pancard_details = json_decode($response->getBody(), true);
                    if ($pancard_details['response']['code'] == 200 && $pancard_details['status']['statusCode'] == 200) {
                        $pancard['data']['client_id'] = null;
                        $pancard['data']['transactionId'] = isset($pancard_details['status']['transactionId']) ? $pancard_details['status']['transactionId'] : null;
                        $pancard['data']['panNumber'] = isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null;
                        $pancard['data']['maskedAadhar'] = isset($pancard_details['response']['maskedAadhaar']) ? $pancard_details['response']['maskedAadhaar'] : null;
                        $pancard['data']['lastFourDigitAadhar'] = isset($pancard_details['response']['lastFourDigit']) ? $pancard_details['response']['lastFourDigit'] : null;
                        $pancard['data']['typeOfHolder'] = isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null;
                        $pancard['data']['name'] = isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null;
                        $pancard['data']['firstName'] = isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null;
                        $pancard['data']['middleName'] = isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null;
                        $pancard['data']['lastName'] = isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null;
                        $pancard['data']['gender'] = isset($pancard_details['response']['gender']) ? $pancard_details['response']['gender'] : null;
                        $pancard['data']['dob'] = isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null;
                        $pancard['data']['address'] = isset($pancard_details['response']['address']) ? $pancard_details['response']['address'] : null;
                        $pancard['data']['city'] = isset($pancard_details['response']['city']) ? $pancard_details['response']['city'] : null;
                        $pancard['data']['state'] = isset($pancard_details['response']['state']) ? $pancard_details['response']['state'] : null;
                        $pancard['data']['country'] = isset($pancard_details['response']['country']) ? $pancard_details['response']['country'] : null;
                        $pancard['data']['pincode'] = isset($pancard_details['response']['pincode']) ? $pancard_details['response']['pincode'] : null;
                        $pancard['data']['mobile_no'] = isset($pancard_details['response']['mobile_no']) ? $pancard_details['response']['mobile_no'] : null;
                        $pancard['data']['email'] = isset($pancard_details['response']['email']) ? $pancard_details['response']['email'] : null;
                        $pancard['data']['isValid'] = isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null;
                        $pancard['data']['aadhaarSeedingStatus'] = isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null;
                        $pancard['data']['serviceCode'] = isset($pancard_details['response']['serviceCode']) ? $pancard_details['response']['serviceCode'] : null;
                        // $data_user = UserSchemeMaster::where('user_id', $user->id)
                        //     ->where('api_id', '')
                        //     ->orderBy('id', 'desc')
                        //     ->pluck('permission');
                        // if (count($data_user) > 0) {
                        //     $pandetails_data = explode(',', $data_user[0]);
                        // }

                        $equifaxResponse['FirstName'] = isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null;
                        $equifaxResponse['LastName'] = isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null;
                        $equifaxResponse['AddressInfo'] = isset($pancard_details['response']['address']) ? $pancard_details['response']['address'] : null;
                        $equifaxResponse['PhoneInfo'] = 'AAAAAA';
                        $equifaxResponse['EmailAddressInfo'] = 'AAAAAA';
                        if (isset($pandetails_data) && $pandetails_data != null) {
                            $pancard['data']['pandetails1'] = null;
                            foreach ($pandetails_data as $pan_data) {
                                $pandetailsinfo['data'][$pan_data] = $pancard['data'][$pan_data];
                            }
                            if ($user->role_id == 1) {
                                if ($apimaster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                    $paninfo = DB::table('pan_info')->insert([
                                        'user_id' => $user->id,
                                        'api_id' => $api_id,
                                        'client_id' => null,
                                        'status_code' => 200,
                                        'groupId' => isset($groupId) ? $groupId : null,
                                        'checkId' => isset($checkId) ? $checkId : null,
                                        'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                        'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                        'transaction_id' => isset($pancard_details['status']['transactionId']) ? $pancard_details['status']['transactionId'] : null,
                                        'pan_no' => isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null,
                                        'masked_aadhar' => isset($pancard_details['response']['maskedAadhaar']) ? $pancard_details['response']['maskedAadhaar'] : null,
                                        'last_four_digit_aadhar' => isset($pancard_details['response']['lastFourDigit']) ? $pancard_details['response']['lastFourDigit'] : null,
                                        'type_of_holder' => isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null,
                                        'name' => isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null,
                                        'firstname' => isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null,
                                        'middlename' => isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null,
                                        'lastname' => isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null,
                                        'gender' => isset($pancard_details['response']['gender']) ? $pancard_details['response']['gender'] : null,
                                        'dob' => isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null,
                                        'city' => isset($pancard_details['response']['city']) ? $pancard_details['response']['city'] : null,
                                        'state' => isset($pancard_details['response']['state']) ? $pancard_details['response']['state'] : null,
                                        'country' => isset($pancard_details['response']['country']) ? $pancard_details['response']['country'] : null,
                                        'pincode' => isset($pancard_details['response']['pincode']) ? $pancard_details['response']['pincode'] : null,
                                        'mobile_no' => isset($pancard_details['response']['mobile_no']) ? $pancard_details['response']['mobile_no'] : null,
                                        'email' => isset($pancard_details['response']['email']) ? $pancard_details['response']['email'] : null,
                                        'is_valid' => isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null,
                                        'aadhar_seeding_status' => isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null,
                                        'service_code' => isset($pancard_details['response']['serviceCode']) ? $pancard_details['response']['serviceCode'] : null,
                                        'message_code' => 'success',
                                        'created_at' => Carbon::now(),
                                        'updated_at' => Carbon::now(),
                                    ]);
                                }
                            }
                             return response()->json(['script_tracing' => $equifaxResponse, 'statusCode' => '2000']);
                        } else {
                            // return $pancard_details;
                            if ($user->role_id == 1) {

                                if ($apimaster) {
                                    $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                    $paninfo = DB::table('pan_info')->insert([
                                        'user_id' => $user->id,
                                        'api_id' => $api_id,
                                        'client_id' => null,
                                        'status_code' => 200,
                                        'groupId' => isset($groupId) ? $groupId : null,
                                        'checkId' => isset($checkId) ? $checkId : null,
                                        'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                        'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                        'transaction_id' => isset($pancard_details['status']['transactionId']) ? $pancard_details['status']['transactionId'] : null,
                                        'pan_no' => isset($pancard_details['response']['pan']) ? $pancard_details['response']['pan'] : null,
                                        'masked_aadhar' => isset($pancard_details['response']['maskedAadhaar']) ? $pancard_details['response']['maskedAadhaar'] : null,
                                        'last_four_digit_aadhar' => isset($pancard_details['response']['lastFourDigit']) ? $pancard_details['response']['lastFourDigit'] : null,
                                        'type_of_holder' => isset($pancard_details['response']['typeOfHolder']) ? $pancard_details['response']['typeOfHolder'] : null,
                                        'name' => isset($pancard_details['response']['name']) ? $pancard_details['response']['name'] : null,
                                        'firstname' => isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null,
                                        'middlename' => isset($pancard_details['response']['middleName']) ? $pancard_details['response']['middleName'] : null,
                                        'lastname' => isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null,
                                        'gender' => isset($pancard_details['response']['gender']) ? $pancard_details['response']['gender'] : null,
                                        'dob' => isset($pancard_details['response']['dob']) ? $pancard_details['response']['dob'] : null,
                                        'city' => isset($pancard_details['response']['city']) ? $pancard_details['response']['city'] : null,
                                        'state' => isset($pancard_details['response']['state']) ? $pancard_details['response']['state'] : null,
                                        'country' => isset($pancard_details['response']['country']) ? $pancard_details['response']['country'] : null,
                                        'pincode' => isset($pancard_details['response']['pincode']) ? $pancard_details['response']['pincode'] : null,
                                        'mobile_no' => isset($pancard_details['response']['mobile_no']) ? $pancard_details['response']['mobile_no'] : null,
                                        'email' => isset($pancard_details['response']['email']) ? $pancard_details['response']['email'] : null,
                                        'is_valid' => isset($pancard_details['response']['isValid']) ? $pancard_details['response']['isValid'] : null,
                                        'aadhar_seeding_status' => isset($pancard_details['response']['aadhaarSeedingStatus']) ? $pancard_details['response']['aadhaarSeedingStatus'] : null,
                                        'service_code' => isset($pancard_details['response']['serviceCode']) ? $pancard_details['response']['serviceCode'] : null,
                                        'message_code' => 'success',
                                        'created_at' => Carbon::now(),
                                        'updated_at' => Carbon::now(),
                                    ]);
                                }
                            }
                            $equifaxResponse['FirstName'] = isset($pancard_details['response']['firstName']) ? $pancard_details['response']['firstName'] : null;
                            $equifaxResponse['LastName'] = isset($pancard_details['response']['lastName']) ? $pancard_details['response']['lastName'] : null;
                            $equifaxResponse['AddressInfo'] = isset($pancard_details['response']['address']) ? $pancard_details['response']['address'] : null;
                            $equifaxResponse['PhoneInfo'] = 'XXXXX';
                            $equifaxResponse['EmailAddressInfo'] = 'XXXXX';
                             return response()->json(['script_tracing' => $equifaxResponse, 'statusCode' => '2000']);
                        }
                    } elseif ($pancard_details['status']['statusCode'] == 200 && $pancard_details['response']['code'] == 400) {
                        $statusCode = 102;
                        $errorMessage = 'No Records found!.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.Please contact techsupport@docboyz.in';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($pancard_details['status']['statusCode']) ? $pancard_details['status']['statusCode'] : null,
                                    'vender_code' => isset($pancard_details['response']['code']) ? $pancard_details['response']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'PAN Number InValid Please Enter Correct PanNumber.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'client_id' => null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apimaster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $paninfo = DB::table('pan_info')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'client_id' => null,
                                    'groupId' => isset($groupId) ? $groupId : null,
                                    'checkId' => isset($checkId) ? $checkId : null,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            
            

            
        }

        // return $user;


    }

    public function bank_anlyser(Request $request)
    {
        $api_id = null;

        if (!$request->hasFile('file')) {
            return response()->json(['message' => 'file not found', 'statusCode' => 404]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Header Access Token is required', 'statusCode' => 404]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => 403]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank_anlyser')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $userScheme = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();

        if ($userScheme || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

                if (strtoupper($request->country) == 'INDIA') {
                    try {
                        $uploadedFile = $request->file('file');
                        $filePath = $uploadedFile->getPathname();
                        $fileName = $uploadedFile->getClientOriginalName();

                        $response = Http::attach(
                            'file',
                            file_get_contents($filePath),
                            $fileName
                        )->post('http://13.232.247.95:8082/api/v1/analysis/analyze', [
                            'hint' => '',
                        ]);

                        if ($response->successful()) {
                            $res = $response->json();

                            return response()->json([
                                'statusCode' => 200,
                                'message' => 'File uploaded successfully.',
                                'job_id' => $res['job_id'] ?? null,
                                'status' => $res['status'] ?? null,
                                'status_url' => $res['status_url'] ?? null,
                            ]);
                        } else {
                            return response()->json([
                                'statusCode' => $response->status(),
                                'message' => 'Bank analyzer API failed.',
                                'error' => $response->body()
                            ]);
                        }
                    } catch (\Exception $e) {
                        return response()->json([
                            'statusCode' => 500,
                            'message' => 'Server error.',
                            'error' => $e->getMessage()
                        ]);
                    }

                } else {
                    return response()->json(['statusCode' => 404, 'message' => 'Please enter correct country code']);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your plan.']);
            }
        }
        else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }





    public function get_bank_analysis_result(Request $request)
    {
        $api_id = null;

        if (!$request->has('job_id')) {
            return response()->json(['message' => 'job_id is required', 'statusCode' => 422]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Header Access Token is required', 'statusCode' => 404]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => 403]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank_anlyser')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }



        $client = new Client();
        $userScheme = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();

        if ($userScheme || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {
                    $job_id = $request->input('job_id');
                    $url = "http://13.232.247.95:8082/api/v1/analysis/result/{$job_id}";

                    $response = Http::get($url);

                    if ($response->successful()) {
                        $data = $response->json();

                        if ($user->role_id == 1 && isset($apiamster)) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                        return response()->json(['statusCode' => 200, 'response' => $data]);
                    } else {
                        return response()->json(['statusCode' => $response->status(), 'message' => 'Bank analyser result API failed.']);
                    }
                } catch (\Exception $e) {
                    return response()->json(['statusCode' => 500, 'message' => 'Server error.', 'error' => $e->getMessage()]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your plan.']);
        }
    } else {
        return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
    }
}

public function ckycSearchdownload(Request $request)
    {
        // return 'test3';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        if (empty($request->client_ref_num)) {
            return response()->json([['message' => 'client refercence number is required', 'statusCode' => '404']]);
        }
        if (empty($request->identifier_type)) {
            return response()->json([['message' => 'identifier_type is required', 'statusCode' => '404']]);
        }

        if (empty($request->mobile)) {
            return response()->json(['message' => "Mobile number is required", 'statusCode' => '404']);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // return $user->id;
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'ckycdownload')->first();
            // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

        $panno = $request->pano;
        if ($panno == 'HUHPS7607K') {
            $data = [
                [
                    [
                        "response" => [
                            "status" => "VALID",
                            "kycStatus" => "null",
                            "message" => "Details downloaded successfully.",
                            "kycDetails" => [
                                "personalIdentifiableData" => [
                                    "personalDetails" => [
                                        "constitution_type" => "Individual",
                                        "account_type" => "Normal",
                                        "ckyc_no" => "60042994549621",
                                        "prefix" => "MR",
                                        "firstName" => "HARSHIT",
                                        "lastName" => "SINGH",
                                        "fullName" => "MR HARSHIT SINGH",
                                        "maiden_prefix" => "null",
                                        "maiden_fname" => "null",
                                        "maiden_mname" => "null",
                                        "maiden_lname" => "null",
                                        "maiden_fullname" => "null",
                                        "father_or_spouse_flag" => "null",
                                        "father_prefix" => "MR",
                                        "father_fname" => "Balram",
                                        "father_mname" => "null",
                                        "father_lname" => "Singh",
                                        "father_fullname" => "MR Balram Singh",
                                        "mother_prefix" => "MRS",
                                        "mother_fname" => "ANITA",
                                        "mother_mname" => "null",
                                        "mother_lname" => "SINGH",
                                        "mother_fullname" => "MRS ANITA SINGH",
                                        "mobNum" => "9450367613",
                                        "pan" => "HUHPS7607K",
                                        "email" => "luckyharshit741@gmail.com",
                                        "dob" => "12-02-1999",
                                        "age" => "25",
                                        "gender" => "M",
                                        "permLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "permLine2" => "JATEPUR",
                                        "perm_line3" => "NEAR KRISHNA NAGAR",
                                        "permCity" => "Gorakhpur",
                                        "permDist" => "Gorakhpur",
                                        "permState" => "Uttar Pradesh",
                                        "permPin" => "273001",
                                        "permCountry" => "IN",
                                        "permPoa" => "E-KYC Authentication",
                                        "perm_corres_sameflag" => "Y",
                                        "corresLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "corresLine2" => "JATEPUR",
                                        "corres_line3" => "NEAR KRISHNA NAGAR",
                                        "corresCity" => "Gorakhpur",
                                        "corresDist" => "Gorakhpur",
                                        "corresState" => "Uttar Pradesh",
                                        "corresPin" => "273001",
                                        "corresCountry" => "IN",
                                        "corresPoa" => "09",
                                        "resi_std_code" => "522",
                                        "resi_tel_num" => "7734945195",
                                        "off_tel_num" => "null",
                                        "off_std_code" => "0",
                                        "remarks" => "null",
                                        "dec_date" => "02-11-2023",
                                        "dec_place" => "Gorakhpur",
                                        "doc_sub" => "06",
                                        "kyc_date" => "********",
                                        "kyc_name" => "********",
                                        "kyc_designation" => "********",
                                        "kyc_branch" => "********",
                                        "kyc_empcode" => "********",
                                        "org_name" => "********",
                                        "org_code" => "********",
                                        "numIdentity" => "1",
                                        "numRelated" => "0",
                                        "numImages" => "3",
                                        "related_person_details" => "null",
                                        "identity_details" => [
                                            "identity" => [
                                                [
                                                    "sequence_no" => "1",
                                                    "ident_type" => "H",
                                                    "ident_num" => "XXXXXXXX4191",
                                                    "idver_status" => "N",
                                                ],

                                            ],
                                            "image_details" => [
                                                "image" => [
                                                    [
                                                        "sequence_no" => "1",
                                                        "image_type" => "pdf",
                                                        "image_code" => "PAN",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "JVBERi0xLjQNJeLjz9MNCjEgMCBv",
                                                        "image_url" => "https=>/ap-south-1amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "2",
                                                        "image_type" => "JPG",
                                                        "image_code" => "Photograph",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "3",
                                                        "image_type" => "pdf",
                                                        "image_code" => "Proof of Possession of Aadhaar",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/G",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                ]
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            ];

            return response()->json(['statusCode' => 200, 'data' => $data]);
        }
        $client_ref_number = $request->client_ref_num;
        $identity_type = $request->identifier_type;
        $mobile = $request->mobile;
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return $api_id;
                $url = 'https://apidemo.digitap.work/ckyc/v1/search';

                $data = [
                    'client_ref_num' => $client_ref_number,
                    'identifier' => $panno,
                    'identifier_type' => $identity_type,
                ];

                $body = json_encode($data);

                $ch = curl_init($url);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=', 'content-type:application/json']);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $get_data1 = curl_exec($ch);
                $kyccard = json_decode($get_data1, true);
                // Async::run($kyccard);
                // $results = Async::wait();

                if (isset($kyccard['result_code']) && $kyccard['result_code'] == 103) {
                    $kyccarderror = null;

                    $kyccarderror['error']['status'] = 102;
                    $kyccarderror['error']['message'] = $kyccard['error'];
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                        }
                    }
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'mobilenum' => $mobile,
                        'status' => 102,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 102, 'response' => $kyccarderror]);
                }

                if (isset($kyccard['result_code']) && $kyccard['result_code'] == 101) {
                    //return $kyccard;
                    $searchkyc = [];
                    $url = 'https://apidemo.digitap.work/ckyc/v1/download';

                    $data = [
                        'ckyc_id' => $kyccard['result']['ckyc_ref_id'],
                        'auth_factor_type' => "MOBILE",
                        'client_ref_num' => $kyccard['client_ref_num'],
                        'auth_factor' => $mobile,
                    ];

                    $body = json_encode($data);
                    $ch = curl_init($url);
                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=', 'content-type:application/json']);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                    $alldata = curl_exec($ch);
                    $allpandata = json_decode($alldata, true);
                    if (isset($allpandata['result_code']) && $allpandata['result_code'] == 101) {
                        $searchkyc['status'] = $allpandata['status'];
                        $searchkyc['kycStatus'] = null;
                        // $searchkyc['message'] = 'Details downloaded successfully';
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['constitution_type'] = $allpandata['result']['personal_details']['constitution_type'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['account_type'] = $allpandata['result']['personal_details']['account_type'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['ckyc_no'] = $allpandata['result']['personal_details']['ckyc_no'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['prefix'] = $allpandata['result']['personal_details']['prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['result']['personal_details']['first_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['middleName'] = $allpandata['result']['personal_details']['middle_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['result']['personal_details']['last_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['result']['personal_details']['full_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_prefix'] = $allpandata['result']['personal_details']['maiden_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fname'] = $allpandata['result']['personal_details']['maiden_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_mname'] = $allpandata['result']['personal_details']['maiden_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_lname'] = $allpandata['result']['personal_details']['maiden_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fullname'] = $allpandata['result']['personal_details']['maiden_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_or_spouse_flag'] = $allpandata['result']['personal_details']['father_or_spouse_flag'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_prefix'] = $allpandata['result']['personal_details']['father_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fname'] = $allpandata['result']['personal_details']['father_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_mname'] = $allpandata['result']['personal_details']['father_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_lname'] = $allpandata['result']['personal_details']['father_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fullname'] = $allpandata['result']['personal_details']['father_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_prefix'] = $allpandata['result']['personal_details']['mother_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fname'] = $allpandata['result']['personal_details']['mother_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_mname'] = $allpandata['result']['personal_details']['mother_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_lname'] = $allpandata['result']['personal_details']['mother_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fullname'] = $allpandata['result']['personal_details']['mother_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = '+' . $allpandata['result']['personal_details']['mob_code'] . $allpandata['result']['personal_details']['mob_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan'] = $allpandata['result']['personal_details']['pan'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['result']['personal_details']['email'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['result']['personal_details']['dob'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['age'] = $kyccard['result']['age'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender'] = $allpandata['result']['personal_details']['gender'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'] = $allpandata['result']['personal_details']['perm_line1'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'] = $allpandata['result']['personal_details']['perm_line2'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_line3'] = $allpandata['result']['personal_details']['perm_line3'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'] = $allpandata['result']['personal_details']['perm_city'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'] = $allpandata['result']['personal_details']['perm_dist'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permState'] = $allpandata['result']['personal_details']['perm_state'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'] = $allpandata['result']['personal_details']['perm_pin'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCountry'] = $allpandata['result']['personal_details']['perm_country'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPoa'] = $allpandata['result']['personal_details']['perm_poa'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_corres_sameflag'] = $allpandata['result']['personal_details']['perm_corres_sameflag'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'] = $allpandata['result']['personal_details']['corres_line1'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'] = $allpandata['result']['personal_details']['corres_line2'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corres_line3'] = $allpandata['result']['personal_details']['corres_line3'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'] = $allpandata['result']['personal_details']['corres_city'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'] = $allpandata['result']['personal_details']['corres_dist'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'] = $allpandata['result']['personal_details']['corres_state'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCountry'] = $allpandata['result']['personal_details']['corres_country'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPoa'] = $allpandata['result']['personal_details']['corres_poa'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'] = $allpandata['result']['personal_details']['corres_pin'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_std_code'] = $allpandata['result']['personal_details']['resi_std_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_tel_num'] = $allpandata['result']['personal_details']['resi_tel_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_tel_num'] = $allpandata['result']['personal_details']['off_tel_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_std_code'] = $allpandata['result']['personal_details']['off_std_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['remarks'] = $allpandata['result']['personal_details']['remarks'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_date'] = $allpandata['result']['personal_details']['dec_date'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_place'] = $allpandata['result']['personal_details']['dec_place'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['doc_sub'] = $allpandata['result']['personal_details']['doc_sub'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_date'] = $kyccard['result']['kyc_date'];

                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_name'] = $allpandata['result']['personal_details']['kyc_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_designation'] = $allpandata['result']['personal_details']['kyc_designation'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_branch'] = $allpandata['result']['personal_details']['kyc_branch'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_empcode'] = $allpandata['result']['personal_details']['kyc_empcode'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_name'] = $allpandata['result']['personal_details']['org_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_code'] = $allpandata['result']['personal_details']['org_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'] = $allpandata['result']['personal_details']['num_identity'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'] = $allpandata['result']['personal_details']['num_related'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'] = $allpandata['result']['personal_details']['num_images'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['related_person_details'] = $allpandata['result']['related_person_details'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['identity_details'] = $allpandata['result']['identity_details'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['image_details'] = $allpandata['result']['image_details'];

                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            if (isset($allpandata['result']['image_details']) && $allpandata['result']['image_details']['image'][0]['sequence_no'] == "1" || $allpandata['result']['image_details']['image'][1]['sequence_no'] == "2" || $allpandata['result']['image_details']['image'][2]['sequence_no'] == "3" || $allpandata['result']['image_details']['image'][3]['sequence_no'] == "4") {

                                $panvalidation = DB::table('search_new')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status' => 200,
                                    'constitution_type' => isset($allpandata['result']['personal_details']['constitution_type']) ? $allpandata['result']['personal_details']['constitution_type'] : null,
                                    'account_type' => isset($allpandata['result']['personal_details']['account_type']) ? $allpandata['result']['personal_details']['account_type'] : null,
                                    'prefix' => isset($allpandata['result']['personal_details']['prefix']) ? $allpandata['result']['personal_details']['prefix'] : null,
                                    'maiden_prefix' => isset($allpandata['result']['personal_details']['maiden_prefix']) ? $allpandata['result']['personal_details']['maiden_prefix'] : null,
                                    'maiden_fname' => isset($allpandata['result']['personal_details']['maiden_fname']) ? $allpandata['result']['personal_details']['maiden_fname'] : null,
                                    'maiden_mname' => isset($allpandata['result']['personal_details']['maiden_mname']) ? $allpandata['result']['personal_details']['maiden_mname'] : null,
                                    'maiden_lname' => isset($allpandata['result']['personal_details']['maiden_lname']) ? $allpandata['result']['personal_details']['maiden_lname'] : null,
                                    'maiden_fullname' => isset($allpandata['result']['personal_details']['maiden_fullname']) ? $allpandata['result']['personal_details']['maiden_fullname'] : null,
                                    'father_prefix' => isset($allpandata['result']['personal_details']['father_prefix']) ? $allpandata['result']['personal_details']['father_prefix'] : null,
                                    'father_fname' => isset($allpandata['result']['personal_details']['father_fname']) ? $allpandata['result']['personal_details']['father_fname'] : null,
                                    'father_mname' => isset($allpandata['result']['personal_details']['father_mname']) ? $allpandata['result']['personal_details']['father_mname'] : null,
                                    'father_lname' => isset($allpandata['result']['personal_details']['father_lname']) ? $allpandata['result']['personal_details']['father_lname'] : null,
                                    'father_fullname' => isset($allpandata['result']['personal_details']['father_fullname']) ? $allpandata['result']['personal_details']['father_fullname'] : null,
                                    'mother_prefix' => isset($allpandata['result']['personal_details']['mother_prefix']) ? $allpandata['result']['personal_details']['mother_prefix'] : null,
                                    'mother_fname' => isset($allpandata['result']['personal_details']['mother_fname']) ? $allpandata['result']['personal_details']['mother_fname'] : null,
                                    'mother_mname' => isset($allpandata['result']['personal_details']['mother_mname']) ? $allpandata['result']['personal_details']['mother_mname'] : null,
                                    'mother_lname' => isset($allpandata['result']['personal_details']['mother_lname']) ? $allpandata['result']['personal_details']['mother_lname'] : null,
                                    'mother_fullname' => isset($allpandata['result']['personal_details']['mother_fullname']) ? $allpandata['result']['personal_details']['mother_fullname'] : null,
                                    'pan_no' => isset($allpandata['result']['personal_details']['pan']) ? $allpandata['result']['personal_details']['pan'] : null,
                                    'ckycid' => isset($allpandata['result']['personal_details']['ckyc_no']) ? $allpandata['result']['personal_details']['ckyc_no'] : null,
                                    'firstname' => isset($allpandata['result']['personal_details']['first_name']) ? $allpandata['result']['personal_details']['first_name'] : null,
                                    'middle_name' => isset($allpandata['result']['personal_details']['middle_name']) ? $allpandata['result']['personal_details']['middle_name'] : null,
                                    'last_name' => isset($allpandata['result']['personal_details']['last_name']) ? $allpandata['result']['personal_details']['last_name'] : null,
                                    'fullname' => isset($allpandata['result']['personal_details']['full_name']) ? $allpandata['result']['personal_details']['full_name'] : null,
                                    'mobilenum' => isset($allpandata['result']['personal_details']['mob_num']) ? $allpandata['result']['personal_details']['mob_num'] : null,
                                    'email' => isset($allpandata['result']['personal_details']['email']) ? $allpandata['result']['personal_details']['email'] : null,
                                    'dob' => isset($allpandata['result']['personal_details']['dob']) ? $allpandata['result']['personal_details']['dob'] : null,
                                    'age' => isset($kyccard['result']['age']) ? $kyccard['result']['age'] : null,
                                    'gender' => isset($allpandata['result']['personal_details']['gender']) ? $allpandata['result']['personal_details']['gender'] : null,
                                    'pstate' => isset($allpandata['result']['personal_details']['perm_state']) ? $allpandata['result']['personal_details']['perm_state'] : null,
                                    'pcity' => isset($allpandata['result']['personal_details']['perm_city']) ? $allpandata['result']['personal_details']['perm_city'] : null,
                                    'permCountry' => isset($allpandata['result']['personal_details']['perm_country']) ? $allpandata['result']['personal_details']['perm_country'] : null,
                                    'permPoa' => isset($allpandata['result']['personal_details']['perm_poa']) ? $allpandata['result']['personal_details']['perm_poa'] : null,
                                    'caddress1' => isset($allpandata['result']['personal_details']['corres_line1']) ? $allpandata['result']['personal_details']['corres_line1'] : null,
                                    'caddress2' => isset($allpandata['result']['personal_details']['corres_line2']) ? $allpandata['result']['personal_details']['corres_line2'] : null,
                                    'caddress3' => isset($allpandata['result']['personal_details']['corres_line3']) ? $allpandata['result']['personal_details']['corres_line3'] : null,
                                    'paddress' => isset($allpandata['result']['personal_details']['permLine1']) ? $allpandata['result']['personal_details']['permLine1'] : null,
                                    'paddress2' => isset($allpandata['result']['personal_details']['permLine2']) ? $allpandata['result']['personal_details']['permLine2'] : null,
                                    'paddress3' => isset($allpandata['result']['personal_details']['perm_line3']) ? $allpandata['result']['personal_details']['perm_line3'] : null,
                                    'perm_corres_sameflag' => isset($allpandata['result']['personal_details']['perm_corres_sameflag']) ? $allpandata['result']['personal_details']['perm_corres_sameflag'] : null,
                                    'cstate' => isset($allpandata['result']['personal_details']['corres_state']) ? $allpandata['result']['personal_details']['corres_state'] : null,
                                    'ccity' => isset($allpandata['result']['personal_details']['corres_city']) ? $allpandata['result']['personal_details']['corres_city'] : null,
                                    'currentpincode' => isset($allpandata['result']['personal_details']['corres_pin']) ? $allpandata['result']['personal_details']['corres_pin'] : null,
                                    'permanantpincode' => isset($allpandata['result']['personal_details']['perm_pin']) ? $allpandata['result']['personal_details']['perm_pin'] : null,
                                    'branch_code1' => isset($allpandata['result']['image_details']['image'][0]['branch_code']) ? $allpandata['result']['image_details']['image'][0]['branch_code'] : null,
                                    'branch_code2' => isset($allpandata['result']['image_details']['image'][1]['branch_code']) ? $allpandata['result']['image_details']['image'][1]['branch_code'] : null,
                                    'branch_code3' => isset($allpandata['result']['image_details']['image'][2]['branch_code']) ? $allpandata['result']['image_details']['image'][2]['branch_code'] : null,
                                    'branch_code4' => isset($allpandata['result']['image_details']['image'][3]['branch_code']) ? $allpandata['result']['image_details']['image'][3]['branch_code'] : null,
                                    'resi_std_code' => isset($allpandata['result']['personal_details']['resi_std_code']) ? $allpandata['result']['personal_details']['resi_std_code'] : null,
                                    'resi_tel_num' => isset($allpandata['result']['personal_details']['resi_tel_num']) ? $allpandata['result']['personal_details']['resi_tel_num'] : null,
                                    'off_std_code' => isset($allpandata['result']['personal_details']['off_std_code']) ? $allpandata['result']['personal_details']['off_std_code'] : null,
                                    'remarks' => isset($allpandata['result']['personal_details']['remarks']) ? $allpandata['result']['personal_details']['remarks'] : null,
                                    'father_or_spouse_flag' => isset($allpandata['result']['personal_details']['father_or_spouse_flag']) ? $allpandata['result']['personal_details']['father_or_spouse_flag'] : null,
                                    'dec_date' => isset($allpandata['result']['personal_details']['dec_date']) ? $allpandata['result']['personal_details']['dec_date'] : null,
                                    'dec_place' => isset($allpandata['result']['personal_details']['dec_place']) ? $allpandata['result']['personal_details']['dec_place'] : null,
                                    'doc_sub' => isset($allpandata['result']['personal_details']['doc_sub']) ? $allpandata['result']['personal_details']['doc_sub'] : null,
                                    'kyc_date' => isset($kyccard['result']['kyc_date']) ? $kyccard['result']['kyc_date'] : null,
                                    'kyc_name' => isset($allpandata['result']['personal_details']['kyc_name']) ? $allpandata['result']['personal_details']['kyc_name'] : null,
                                    'kyc_designation' => isset($allpandata['result']['personal_details']['kyc_designation']) ? $allpandata['result']['personal_details']['kyc_designation'] : null,
                                    'kyc_branch' => isset($allpandata['result']['personal_details']['kyc_branch']) ? $allpandata['result']['personal_details']['kyc_branch'] : null,
                                    'kyc_empcode' => isset($allpandata['result']['personal_details']['kyc_empcode']) ? $allpandata['result']['personal_details']['kyc_empcode'] : null,
                                    'org_name' => isset($allpandata['result']['personal_details']['org_name']) ? $allpandata['result']['personal_details']['org_name'] : null,
                                    'org_code' => isset($allpandata['result']['personal_details']['org_code']) ? $allpandata['result']['personal_details']['org_code'] : null,
                                    'image_url1' => isset($allpandata['result']['image_details']['image'][0]['image_url']) ? $allpandata['result']['image_details']['image'][0]['image_url'] : null,
                                    'image_url2' => isset($allpandata['result']['image_details']['image'][1]['image_url']) ? $allpandata['result']['image_details']['image'][1]['image_url'] : null,
                                    'image_url3' => isset($allpandata['result']['image_details']['image'][2]['image_url']) ? $allpandata['result']['image_details']['image'][2]['image_url'] : null,
                                    'image_url4' => isset($allpandata['result']['image_details']['image'][3]['image_url']) ? $allpandata['result']['image_details']['image'][3]['image_url'] : null,
                                    'image_code1' => isset($allpandata['result']['image_details']['image'][0]['image_code']) ? $allpandata['result']['image_details']['image'][0]['image_code'] : null,
                                    'image_code2' => isset($allpandata['result']['image_details']['image'][1]['image_code']) ? $allpandata['result']['image_details']['image'][1]['image_code'] : null,
                                    'image_code3' => isset($allpandata['result']['image_details']['image'][2]['image_code']) ? $allpandata['result']['image_details']['image'][2]['image_code'] : null,
                                    'image_code4' => isset($allpandata['result']['image_details']['image'][3]['image_code']) ? $allpandata['result']['image_details']['image'][3]['image_code'] : null,
                                    'image_data1' => isset($allpandata['result']['image_details']['image'][0]['image_data']) ? $allpandata['result']['image_details']['image'][0]['image_data'] : null,
                                    'image_data2' => isset($allpandata['result']['image_details']['image'][1]['image_data']) ? $allpandata['result']['image_details']['image'][1]['image_data'] : null,
                                    'image_data3' => isset($allpandata['result']['image_details']['image'][2]['image_data']) ? $allpandata['result']['image_details']['image'][2]['image_data'] : null,
                                    'image_data4' => isset($allpandata['result']['image_details']['image'][3]['image_data']) ? $allpandata['result']['image_details']['image'][3]['image_data'] : null,
                                    'ident_type1' => isset($allpandata['result']['identity_details']['identity'][0]['ident_type']) ? $allpandata['result']['identity_details']['identity'][0]['ident_type'] : null,
                                    'ident_type2' => isset($allpandata['result']['identity_details']['identity'][1]['ident_type']) ? $allpandata['result']['identity_details']['identity'][1]['ident_type'] : null,
                                    'ident_type3' => isset($allpandata['result']['identity_details']['identity'][2]['ident_type']) ? $allpandata['result']['identity_details']['identity'][2]['ident_type'] : null,
                                    'ident_type4' => isset($allpandata['result']['identity_details']['identity'][3]['ident_type']) ? $allpandata['result']['identity_details']['identity'][3]['ident_type'] : null,
                                    'ident_num1' => isset($allpandata['result']['identity_details']['identity'][0]['ident_num']) ? $allpandata['result']['identity_details']['identity'][0]['ident_num'] : null,
                                    'ident_num2' => isset($allpandata['result']['identity_details']['identity'][1]['ident_num']) ? $allpandata['result']['identity_details']['identity'][1]['ident_num'] : null,
                                    'ident_num3' => isset($allpandata['result']['identity_details']['identity'][2]['ident_num']) ? $allpandata['result']['identity_details']['identity'][2]['ident_num'] : null,
                                    'ident_num4' => isset($allpandata['result']['identity_details']['identity'][3]['ident_num']) ? $allpandata['result']['identity_details']['identity'][3]['ident_num'] : null,
                                    'idver_status1' => isset($allpandata['result']['identity_details']['identity'][0]['idver_status']) ? $allpandata['result']['identity_details']['identity'][0]['idver_status'] : null,
                                    'idver_status2' => isset($allpandata['result']['identity_details']['identity'][1]['idver_status']) ? $allpandata['result']['identity_details']['identity'][1]['idver_status'] : null,
                                    'idver_status3' => isset($allpandata['result']['identity_details']['identity'][2]['idver_status']) ? $allpandata['result']['identity_details']['identity'][2]['idver_status'] : null,
                                    'idver_status4' => isset($allpandata['result']['identity_details']['identity'][3]['idver_status']) ? $allpandata['result']['identity_details']['identity'][3]['idver_status'] : null,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);

                            }

                        }
                        return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                    } elseif (isset($allpandata['status']) && $allpandata['status'] == 'INVALID') {
                        if ($user->role_id == 1) {
                            $statusCode = 102;
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            // return 'insert';
                            $panvalidation = DB::table('search_new')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'mobilenum' => $mobile,
                                'status' => 102,
                                'pan_no' => $request->pano,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        $searchkyc['status'] = $allpandata['status'];
                        $searchkyc['error'] = $allpandata['error'];
                        return response()->json(['statusCode' => 102, 'response' => $searchkyc]);
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                            }
                        }
                        $panvalidation = DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'mobilenum' => $mobile,
                            'status' => 202,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                        return response()->json(['statusCode' => 202, 'response' => $allpandata]);
                    }
                    // return response()->json(json_decode($alldata,true));
                    // return response()->json(['statusCode'=>200, 'response'=>$allpandata]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                        }
                    }
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'status' => 201,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 201, 'response' => $kyccard]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

public function ckycSearchdownload_production(Request $request)
{
        // return 'test3';
        $statusCode = null;
        $pancard = null;
        $api_id = null;
        if (empty($request->pano)) {
            return response()->json([['message' => 'Pancard number is required', 'statusCode' => '404']]);
        }
        // if (empty($request->client_ref_num)) {
        //     return response()->json([['message' => 'client refercence number is required', 'statusCode' => '404']]);
        // }
        // if (empty($request->identifier_type)) {
        //     return response()->json([['message' => 'identifier_type is required', 'statusCode' => '404']]);
        // }

        if (empty($request->mobile)) {
            return response()->json(['message' => "Mobile number is required", 'statusCode' => '404']);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([['message' => 'Header Access Token is required', 'statusCode' => '404']]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json([['message' => 'Wrong Access Token', 'statusCode' => '403']]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        // return $user->id;
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'ckycdownload')->first();
            // $apiamster = ApiMaster::where('api_slug','asdfasd')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

        $panno = $request->pano;
        if ($panno == 'HUHPS7607K') {
            $data = [
                [
                    [
                        "response" => [
                            "status" => "VALID",
                            "kycStatus" => "null",
                            "message" => "Details downloaded successfully.",
                            "kycDetails" => [
                                "personalIdentifiableData" => [
                                    "personalDetails" => [
                                        "constitution_type" => "Individual",
                                        "account_type" => "Normal",
                                        "ckyc_no" => "60042994549621",
                                        "prefix" => "MR",
                                        "firstName" => "HARSHIT",
                                        "lastName" => "SINGH",
                                        "fullName" => "MR HARSHIT SINGH",
                                        "maiden_prefix" => "null",
                                        "maiden_fname" => "null",
                                        "maiden_mname" => "null",
                                        "maiden_lname" => "null",
                                        "maiden_fullname" => "null",
                                        "father_or_spouse_flag" => "null",
                                        "father_prefix" => "MR",
                                        "father_fname" => "Balram",
                                        "father_mname" => "null",
                                        "father_lname" => "Singh",
                                        "father_fullname" => "MR Balram Singh",
                                        "mother_prefix" => "MRS",
                                        "mother_fname" => "ANITA",
                                        "mother_mname" => "null",
                                        "mother_lname" => "SINGH",
                                        "mother_fullname" => "MRS ANITA SINGH",
                                        "mobNum" => "9450367613",
                                        "pan" => "HUHPS7607K",
                                        "email" => "luckyharshit741@gmail.com",
                                        "dob" => "12-02-1999",
                                        "age" => "25",
                                        "gender" => "M",
                                        "permLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "permLine2" => "JATEPUR",
                                        "perm_line3" => "NEAR KRISHNA NAGAR",
                                        "permCity" => "Gorakhpur",
                                        "permDist" => "Gorakhpur",
                                        "permState" => "Uttar Pradesh",
                                        "permPin" => "273001",
                                        "permCountry" => "IN",
                                        "permPoa" => "E-KYC Authentication",
                                        "perm_corres_sameflag" => "Y",
                                        "corresLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "corresLine2" => "JATEPUR",
                                        "corres_line3" => "NEAR KRISHNA NAGAR",
                                        "corresCity" => "Gorakhpur",
                                        "corresDist" => "Gorakhpur",
                                        "corresState" => "Uttar Pradesh",
                                        "corresPin" => "273001",
                                        "corresCountry" => "IN",
                                        "corresPoa" => "09",
                                        "resi_std_code" => "522",
                                        "resi_tel_num" => "7734945195",
                                        "off_tel_num" => "null",
                                        "off_std_code" => "0",
                                        "remarks" => "null",
                                        "dec_date" => "02-11-2023",
                                        "dec_place" => "Gorakhpur",
                                        "doc_sub" => "06",
                                        "kyc_date" => "********",
                                        "kyc_name" => "********",
                                        "kyc_designation" => "********",
                                        "kyc_branch" => "********",
                                        "kyc_empcode" => "********",
                                        "org_name" => "********",
                                        "org_code" => "********",
                                        "numIdentity" => "1",
                                        "numRelated" => "0",
                                        "numImages" => "3",
                                        "related_person_details" => "null",
                                        "identity_details" => [
                                            "identity" => [
                                                [
                                                    "sequence_no" => "1",
                                                    "ident_type" => "H",
                                                    "ident_num" => "XXXXXXXX4191",
                                                    "idver_status" => "N",
                                                ],

                                            ],
                                            "image_details" => [
                                                "image" => [
                                                    [
                                                        "sequence_no" => "1",
                                                        "image_type" => "pdf",
                                                        "image_code" => "PAN",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "JVBERi0xLjQNJeLjz9MNCjEgMCBv",
                                                        "image_url" => "https=>/ap-south-1amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "2",
                                                        "image_type" => "JPG",
                                                        "image_code" => "Photograph",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "3",
                                                        "image_type" => "pdf",
                                                        "image_code" => "Proof of Possession of Aadhaar",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/G",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                ]
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            ];

            return response()->json(['statusCode' => 200, 'data' => $data]);
        }
        // $client_ref_number = rand(100000, 999999);
        // return  $client_ref_number; 
        $randomInt = strval(rand(100, 999));
        $client_ref_number = $randomInt;
        $identity_type = 'PAN';
        $mobile = $request->mobile;
        $ficode = 'IN5691';
        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return '$api_id';
                $url = 'https://api.digitap.ai/ckyc/v3/search';

                $data = [
                    'client_ref_num' => $client_ref_number,
                    'identifier' => $panno,
                    'identifier_type' => $identity_type,
                    "fi_code"=> $ficode
                ];

                // return $data;

                $body = json_encode($data);

                $ch = curl_init($url);

                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'content-type:application/json']);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $get_data1 = curl_exec($ch);
                $kyccard = json_decode($get_data1, true);
                
                // return $kyccard;
                // return $kyccard['client_ref_num'];
                // Async::run($kyccard);
                // $results = Async::wait();

                if (isset($kyccard['result_code']) && $kyccard['result_code'] == 103) {
                    $kyccarderror = null;

                    $kyccarderror['error']['status'] = 102;
                    $kyccarderror['error']['message'] = $kyccard['error'];
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                        }
                    }
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'mobilenum' => $mobile,
                        'status' => 102,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 102, 'response' => $kyccarderror]);
                }

                if (isset($kyccard['result_code']) && $kyccard['result_code'] == 101) {
                    //return $kyccard;
                    $searchkyc = [];
                    $url = 'https://api.digitap.ai/ckyc/v3/download/request';

                    $data = [
                        'ckyc_id' => $kyccard['result'][0]['ckyc_ref_id'],
                        'auth_factor_type' => "MOBILE",
                        'client_ref_num' => $kyccard['client_ref_num'],
                        'auth_factor' => $mobile,
                        "fi_code"=> "IN5691"
                    ];

                    $body = json_encode($data);
                    $ch = curl_init($url);
                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'content-type:application/json']);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
                    $alldata = curl_exec($ch);
                    $allpandata = json_decode($alldata, true);
                    return $allpandata;
                    if (isset($allpandata['result_code']) && $allpandata['result_code'] == 101) {
                        $searchkyc['status'] = $allpandata['status'];
                        $searchkyc['kycStatus'] = null;
                        // $searchkyc['message'] = 'Details downloaded successfully';
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['constitution_type'] = $allpandata['result']['personal_details']['constitution_type'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['account_type'] = $allpandata['result']['personal_details']['account_type'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['ckyc_no'] = $allpandata['result']['personal_details']['ckyc_no'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['prefix'] = $allpandata['result']['personal_details']['prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['result']['personal_details']['first_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['middleName'] = $allpandata['result']['personal_details']['middle_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['result']['personal_details']['last_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['result']['personal_details']['full_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_prefix'] = $allpandata['result']['personal_details']['maiden_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fname'] = $allpandata['result']['personal_details']['maiden_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_mname'] = $allpandata['result']['personal_details']['maiden_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_lname'] = $allpandata['result']['personal_details']['maiden_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fullname'] = $allpandata['result']['personal_details']['maiden_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_or_spouse_flag'] = $allpandata['result']['personal_details']['father_or_spouse_flag'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_prefix'] = $allpandata['result']['personal_details']['father_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fname'] = $allpandata['result']['personal_details']['father_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_mname'] = $allpandata['result']['personal_details']['father_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_lname'] = $allpandata['result']['personal_details']['father_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fullname'] = $allpandata['result']['personal_details']['father_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_prefix'] = $allpandata['result']['personal_details']['mother_prefix'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fname'] = $allpandata['result']['personal_details']['mother_fname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_mname'] = $allpandata['result']['personal_details']['mother_mname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_lname'] = $allpandata['result']['personal_details']['mother_lname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fullname'] = $allpandata['result']['personal_details']['mother_fullname'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = '+' . $allpandata['result']['personal_details']['mob_code'] . $allpandata['result']['personal_details']['mob_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan'] = $allpandata['result']['personal_details']['pan'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['result']['personal_details']['email'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['result']['personal_details']['dob'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['age'] = $kyccard['result']['age'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender'] = $allpandata['result']['personal_details']['gender'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'] = $allpandata['result']['personal_details']['perm_line1'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'] = $allpandata['result']['personal_details']['perm_line2'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_line3'] = $allpandata['result']['personal_details']['perm_line3'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'] = $allpandata['result']['personal_details']['perm_city'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'] = $allpandata['result']['personal_details']['perm_dist'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permState'] = $allpandata['result']['personal_details']['perm_state'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'] = $allpandata['result']['personal_details']['perm_pin'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCountry'] = $allpandata['result']['personal_details']['perm_country'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPoa'] = $allpandata['result']['personal_details']['perm_poa'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_corres_sameflag'] = $allpandata['result']['personal_details']['perm_corres_sameflag'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'] = $allpandata['result']['personal_details']['corres_line1'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'] = $allpandata['result']['personal_details']['corres_line2'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corres_line3'] = $allpandata['result']['personal_details']['corres_line3'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'] = $allpandata['result']['personal_details']['corres_city'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'] = $allpandata['result']['personal_details']['corres_dist'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'] = $allpandata['result']['personal_details']['corres_state'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCountry'] = $allpandata['result']['personal_details']['corres_country'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPoa'] = $allpandata['result']['personal_details']['corres_poa'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'] = $allpandata['result']['personal_details']['corres_pin'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_std_code'] = $allpandata['result']['personal_details']['resi_std_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_tel_num'] = $allpandata['result']['personal_details']['resi_tel_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_tel_num'] = $allpandata['result']['personal_details']['off_tel_num'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_std_code'] = $allpandata['result']['personal_details']['off_std_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['remarks'] = $allpandata['result']['personal_details']['remarks'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_date'] = $allpandata['result']['personal_details']['dec_date'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_place'] = $allpandata['result']['personal_details']['dec_place'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['doc_sub'] = $allpandata['result']['personal_details']['doc_sub'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_date'] = $kyccard['result']['kyc_date'];

                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_name'] = $allpandata['result']['personal_details']['kyc_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_designation'] = $allpandata['result']['personal_details']['kyc_designation'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_branch'] = $allpandata['result']['personal_details']['kyc_branch'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_empcode'] = $allpandata['result']['personal_details']['kyc_empcode'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_name'] = $allpandata['result']['personal_details']['org_name'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_code'] = $allpandata['result']['personal_details']['org_code'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'] = $allpandata['result']['personal_details']['num_identity'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'] = $allpandata['result']['personal_details']['num_related'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'] = $allpandata['result']['personal_details']['num_images'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['related_person_details'] = $allpandata['result']['related_person_details'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['identity_details'] = $allpandata['result']['identity_details'];
                        $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['image_details'] = $allpandata['result']['image_details'];

                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            if (isset($allpandata['result']['image_details']) && $allpandata['result']['image_details']['image'][0]['sequence_no'] == "1" || $allpandata['result']['image_details']['image'][1]['sequence_no'] == "2" || $allpandata['result']['image_details']['image'][2]['sequence_no'] == "3" || $allpandata['result']['image_details']['image'][3]['sequence_no'] == "4") {

                                $panvalidation = DB::table('search_new')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'status' => 200,
                                    'constitution_type' => isset($allpandata['result']['personal_details']['constitution_type']) ? $allpandata['result']['personal_details']['constitution_type'] : null,
                                    'account_type' => isset($allpandata['result']['personal_details']['account_type']) ? $allpandata['result']['personal_details']['account_type'] : null,
                                    'prefix' => isset($allpandata['result']['personal_details']['prefix']) ? $allpandata['result']['personal_details']['prefix'] : null,
                                    'maiden_prefix' => isset($allpandata['result']['personal_details']['maiden_prefix']) ? $allpandata['result']['personal_details']['maiden_prefix'] : null,
                                    'maiden_fname' => isset($allpandata['result']['personal_details']['maiden_fname']) ? $allpandata['result']['personal_details']['maiden_fname'] : null,
                                    'maiden_mname' => isset($allpandata['result']['personal_details']['maiden_mname']) ? $allpandata['result']['personal_details']['maiden_mname'] : null,
                                    'maiden_lname' => isset($allpandata['result']['personal_details']['maiden_lname']) ? $allpandata['result']['personal_details']['maiden_lname'] : null,
                                    'maiden_fullname' => isset($allpandata['result']['personal_details']['maiden_fullname']) ? $allpandata['result']['personal_details']['maiden_fullname'] : null,
                                    'father_prefix' => isset($allpandata['result']['personal_details']['father_prefix']) ? $allpandata['result']['personal_details']['father_prefix'] : null,
                                    'father_fname' => isset($allpandata['result']['personal_details']['father_fname']) ? $allpandata['result']['personal_details']['father_fname'] : null,
                                    'father_mname' => isset($allpandata['result']['personal_details']['father_mname']) ? $allpandata['result']['personal_details']['father_mname'] : null,
                                    'father_lname' => isset($allpandata['result']['personal_details']['father_lname']) ? $allpandata['result']['personal_details']['father_lname'] : null,
                                    'father_fullname' => isset($allpandata['result']['personal_details']['father_fullname']) ? $allpandata['result']['personal_details']['father_fullname'] : null,
                                    'mother_prefix' => isset($allpandata['result']['personal_details']['mother_prefix']) ? $allpandata['result']['personal_details']['mother_prefix'] : null,
                                    'mother_fname' => isset($allpandata['result']['personal_details']['mother_fname']) ? $allpandata['result']['personal_details']['mother_fname'] : null,
                                    'mother_mname' => isset($allpandata['result']['personal_details']['mother_mname']) ? $allpandata['result']['personal_details']['mother_mname'] : null,
                                    'mother_lname' => isset($allpandata['result']['personal_details']['mother_lname']) ? $allpandata['result']['personal_details']['mother_lname'] : null,
                                    'mother_fullname' => isset($allpandata['result']['personal_details']['mother_fullname']) ? $allpandata['result']['personal_details']['mother_fullname'] : null,
                                    'pan_no' => isset($allpandata['result']['personal_details']['pan']) ? $allpandata['result']['personal_details']['pan'] : null,
                                    'ckycid' => isset($allpandata['result']['personal_details']['ckyc_no']) ? $allpandata['result']['personal_details']['ckyc_no'] : null,
                                    'firstname' => isset($allpandata['result']['personal_details']['first_name']) ? $allpandata['result']['personal_details']['first_name'] : null,
                                    'middle_name' => isset($allpandata['result']['personal_details']['middle_name']) ? $allpandata['result']['personal_details']['middle_name'] : null,
                                    'last_name' => isset($allpandata['result']['personal_details']['last_name']) ? $allpandata['result']['personal_details']['last_name'] : null,
                                    'fullname' => isset($allpandata['result']['personal_details']['full_name']) ? $allpandata['result']['personal_details']['full_name'] : null,
                                    'mobilenum' => isset($allpandata['result']['personal_details']['mob_num']) ? $allpandata['result']['personal_details']['mob_num'] : null,
                                    'email' => isset($allpandata['result']['personal_details']['email']) ? $allpandata['result']['personal_details']['email'] : null,
                                    'dob' => isset($allpandata['result']['personal_details']['dob']) ? $allpandata['result']['personal_details']['dob'] : null,
                                    'age' => isset($kyccard['result']['age']) ? $kyccard['result']['age'] : null,
                                    'gender' => isset($allpandata['result']['personal_details']['gender']) ? $allpandata['result']['personal_details']['gender'] : null,
                                    'pstate' => isset($allpandata['result']['personal_details']['perm_state']) ? $allpandata['result']['personal_details']['perm_state'] : null,
                                    'pcity' => isset($allpandata['result']['personal_details']['perm_city']) ? $allpandata['result']['personal_details']['perm_city'] : null,
                                    'permCountry' => isset($allpandata['result']['personal_details']['perm_country']) ? $allpandata['result']['personal_details']['perm_country'] : null,
                                    'permPoa' => isset($allpandata['result']['personal_details']['perm_poa']) ? $allpandata['result']['personal_details']['perm_poa'] : null,
                                    'caddress1' => isset($allpandata['result']['personal_details']['corres_line1']) ? $allpandata['result']['personal_details']['corres_line1'] : null,
                                    'caddress2' => isset($allpandata['result']['personal_details']['corres_line2']) ? $allpandata['result']['personal_details']['corres_line2'] : null,
                                    'caddress3' => isset($allpandata['result']['personal_details']['corres_line3']) ? $allpandata['result']['personal_details']['corres_line3'] : null,
                                    'paddress' => isset($allpandata['result']['personal_details']['permLine1']) ? $allpandata['result']['personal_details']['permLine1'] : null,
                                    'paddress2' => isset($allpandata['result']['personal_details']['permLine2']) ? $allpandata['result']['personal_details']['permLine2'] : null,
                                    'paddress3' => isset($allpandata['result']['personal_details']['perm_line3']) ? $allpandata['result']['personal_details']['perm_line3'] : null,
                                    'perm_corres_sameflag' => isset($allpandata['result']['personal_details']['perm_corres_sameflag']) ? $allpandata['result']['personal_details']['perm_corres_sameflag'] : null,
                                    'cstate' => isset($allpandata['result']['personal_details']['corres_state']) ? $allpandata['result']['personal_details']['corres_state'] : null,
                                    'ccity' => isset($allpandata['result']['personal_details']['corres_city']) ? $allpandata['result']['personal_details']['corres_city'] : null,
                                    'currentpincode' => isset($allpandata['result']['personal_details']['corres_pin']) ? $allpandata['result']['personal_details']['corres_pin'] : null,
                                    'permanantpincode' => isset($allpandata['result']['personal_details']['perm_pin']) ? $allpandata['result']['personal_details']['perm_pin'] : null,
                                    'branch_code1' => isset($allpandata['result']['image_details']['image'][0]['branch_code']) ? $allpandata['result']['image_details']['image'][0]['branch_code'] : null,
                                    'branch_code2' => isset($allpandata['result']['image_details']['image'][1]['branch_code']) ? $allpandata['result']['image_details']['image'][1]['branch_code'] : null,
                                    'branch_code3' => isset($allpandata['result']['image_details']['image'][2]['branch_code']) ? $allpandata['result']['image_details']['image'][2]['branch_code'] : null,
                                    'branch_code4' => isset($allpandata['result']['image_details']['image'][3]['branch_code']) ? $allpandata['result']['image_details']['image'][3]['branch_code'] : null,
                                    'resi_std_code' => isset($allpandata['result']['personal_details']['resi_std_code']) ? $allpandata['result']['personal_details']['resi_std_code'] : null,
                                    'resi_tel_num' => isset($allpandata['result']['personal_details']['resi_tel_num']) ? $allpandata['result']['personal_details']['resi_tel_num'] : null,
                                    'off_std_code' => isset($allpandata['result']['personal_details']['off_std_code']) ? $allpandata['result']['personal_details']['off_std_code'] : null,
                                    'remarks' => isset($allpandata['result']['personal_details']['remarks']) ? $allpandata['result']['personal_details']['remarks'] : null,
                                    'father_or_spouse_flag' => isset($allpandata['result']['personal_details']['father_or_spouse_flag']) ? $allpandata['result']['personal_details']['father_or_spouse_flag'] : null,
                                    'dec_date' => isset($allpandata['result']['personal_details']['dec_date']) ? $allpandata['result']['personal_details']['dec_date'] : null,
                                    'dec_place' => isset($allpandata['result']['personal_details']['dec_place']) ? $allpandata['result']['personal_details']['dec_place'] : null,
                                    'doc_sub' => isset($allpandata['result']['personal_details']['doc_sub']) ? $allpandata['result']['personal_details']['doc_sub'] : null,
                                    'kyc_date' => isset($kyccard['result']['kyc_date']) ? $kyccard['result']['kyc_date'] : null,
                                    'kyc_name' => isset($allpandata['result']['personal_details']['kyc_name']) ? $allpandata['result']['personal_details']['kyc_name'] : null,
                                    'kyc_designation' => isset($allpandata['result']['personal_details']['kyc_designation']) ? $allpandata['result']['personal_details']['kyc_designation'] : null,
                                    'kyc_branch' => isset($allpandata['result']['personal_details']['kyc_branch']) ? $allpandata['result']['personal_details']['kyc_branch'] : null,
                                    'kyc_empcode' => isset($allpandata['result']['personal_details']['kyc_empcode']) ? $allpandata['result']['personal_details']['kyc_empcode'] : null,
                                    'org_name' => isset($allpandata['result']['personal_details']['org_name']) ? $allpandata['result']['personal_details']['org_name'] : null,
                                    'org_code' => isset($allpandata['result']['personal_details']['org_code']) ? $allpandata['result']['personal_details']['org_code'] : null,
                                    'image_url1' => isset($allpandata['result']['image_details']['image'][0]['image_url']) ? $allpandata['result']['image_details']['image'][0]['image_url'] : null,
                                    'image_url2' => isset($allpandata['result']['image_details']['image'][1]['image_url']) ? $allpandata['result']['image_details']['image'][1]['image_url'] : null,
                                    'image_url3' => isset($allpandata['result']['image_details']['image'][2]['image_url']) ? $allpandata['result']['image_details']['image'][2]['image_url'] : null,
                                    'image_url4' => isset($allpandata['result']['image_details']['image'][3]['image_url']) ? $allpandata['result']['image_details']['image'][3]['image_url'] : null,
                                    'image_code1' => isset($allpandata['result']['image_details']['image'][0]['image_code']) ? $allpandata['result']['image_details']['image'][0]['image_code'] : null,
                                    'image_code2' => isset($allpandata['result']['image_details']['image'][1]['image_code']) ? $allpandata['result']['image_details']['image'][1]['image_code'] : null,
                                    'image_code3' => isset($allpandata['result']['image_details']['image'][2]['image_code']) ? $allpandata['result']['image_details']['image'][2]['image_code'] : null,
                                    'image_code4' => isset($allpandata['result']['image_details']['image'][3]['image_code']) ? $allpandata['result']['image_details']['image'][3]['image_code'] : null,
                                    'image_data1' => isset($allpandata['result']['image_details']['image'][0]['image_data']) ? $allpandata['result']['image_details']['image'][0]['image_data'] : null,
                                    'image_data2' => isset($allpandata['result']['image_details']['image'][1]['image_data']) ? $allpandata['result']['image_details']['image'][1]['image_data'] : null,
                                    'image_data3' => isset($allpandata['result']['image_details']['image'][2]['image_data']) ? $allpandata['result']['image_details']['image'][2]['image_data'] : null,
                                    'image_data4' => isset($allpandata['result']['image_details']['image'][3]['image_data']) ? $allpandata['result']['image_details']['image'][3]['image_data'] : null,
                                    'ident_type1' => isset($allpandata['result']['identity_details']['identity'][0]['ident_type']) ? $allpandata['result']['identity_details']['identity'][0]['ident_type'] : null,
                                    'ident_type2' => isset($allpandata['result']['identity_details']['identity'][1]['ident_type']) ? $allpandata['result']['identity_details']['identity'][1]['ident_type'] : null,
                                    'ident_type3' => isset($allpandata['result']['identity_details']['identity'][2]['ident_type']) ? $allpandata['result']['identity_details']['identity'][2]['ident_type'] : null,
                                    'ident_type4' => isset($allpandata['result']['identity_details']['identity'][3]['ident_type']) ? $allpandata['result']['identity_details']['identity'][3]['ident_type'] : null,
                                    'ident_num1' => isset($allpandata['result']['identity_details']['identity'][0]['ident_num']) ? $allpandata['result']['identity_details']['identity'][0]['ident_num'] : null,
                                    'ident_num2' => isset($allpandata['result']['identity_details']['identity'][1]['ident_num']) ? $allpandata['result']['identity_details']['identity'][1]['ident_num'] : null,
                                    'ident_num3' => isset($allpandata['result']['identity_details']['identity'][2]['ident_num']) ? $allpandata['result']['identity_details']['identity'][2]['ident_num'] : null,
                                    'ident_num4' => isset($allpandata['result']['identity_details']['identity'][3]['ident_num']) ? $allpandata['result']['identity_details']['identity'][3]['ident_num'] : null,
                                    'idver_status1' => isset($allpandata['result']['identity_details']['identity'][0]['idver_status']) ? $allpandata['result']['identity_details']['identity'][0]['idver_status'] : null,
                                    'idver_status2' => isset($allpandata['result']['identity_details']['identity'][1]['idver_status']) ? $allpandata['result']['identity_details']['identity'][1]['idver_status'] : null,
                                    'idver_status3' => isset($allpandata['result']['identity_details']['identity'][2]['idver_status']) ? $allpandata['result']['identity_details']['identity'][2]['idver_status'] : null,
                                    'idver_status4' => isset($allpandata['result']['identity_details']['identity'][3]['idver_status']) ? $allpandata['result']['identity_details']['identity'][3]['idver_status'] : null,
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);

                            }

                        }
                        return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                    } elseif (isset($allpandata['status']) && $allpandata['status'] == 'INVALID') {
                        if ($user->role_id == 1) {
                            $statusCode = 102;
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                            // return 'insert';
                            $panvalidation = DB::table('search_new')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'mobilenum' => $mobile,
                                'status' => 102,
                                'pan_no' => $request->pano,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                        $searchkyc['status'] = $allpandata['status'];
                        $searchkyc['error'] = $allpandata['error'];
                        return response()->json(['statusCode' => 102, 'response' => $searchkyc]);
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                            }
                        }
                        $panvalidation = DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'mobilenum' => $mobile,
                            'status' => 202,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                        return response()->json(['statusCode' => 202, 'response' => $allpandata]);
                    }
                    // return response()->json(json_decode($alldata,true));
                    // return response()->json(['statusCode'=>200, 'response'=>$allpandata]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                        }
                    }
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'status' => 201,
                        'pan_no' => $request->pano,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 201, 'response' => $kyccard]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

    public function validateCkycOtp_digitap(Request $request)
    {
        $statusCode = null;

        
        $api_id = null;

        if (empty($request->otp)) {
            return response()->json(['message' => 'otp is required', 'statusCode' => 404]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json(['message' => 'Header Access Token is required', 'statusCode' => 404]);
        }

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false) {
            return response()->json(['message' => 'Wrong Access Token', 'statusCode' => 403]);
        }

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'ckycdownload')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }
           

        $client = new Client();
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        // return $apiamster;
        
        if ($updateHitCount || $user->role_id == 0) {
            //  return 'ok 3';
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                // return 'ok2';
                // Build request
                $url = 'https://api.digitap.ai/ckyc/v3/download/otp/submit';
                $randomInt = strval(rand(100, 999));
                $data = [
                    'client_ref_num' => $randomInt,
                    'otp' => $request->otp,
                    'ckyc_response_request_id' => $request->ckyc_response_request_id,
                    'request_id' => $request->request_id,
                    'fi_code' => "IN5691"
                ];

                $body = json_encode($data);

                $ch = curl_init($url);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'content-type:application/json']);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $otpResponse = curl_exec($ch);
                if ($otpResponse === false) {
                    $error = curl_error($ch);
                    curl_close($ch);
                    return response()->json(['statusCode' => 500, 'message' => 'cURL request failed: ' . $error]);
                }
                curl_close($ch);

                $allpandata = json_decode($otpResponse, true);
                if (json_last_error() !== JSON_ERROR_NONE) {
                    return response()->json(['statusCode' => 500, 'message' => 'Invalid JSON response from API']);
                }

                if (isset($allpandata['result_code']) && $allpandata['result_code'] == 101) {
                    // $searchkyc['status'] = $allpandata['status'];
                    $searchkyc['kycStatus'] = null;
                    $searchkyc['message'] = 'Details downloaded successfully';
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['constitution_type'] = $allpandata['result']['personal_details']['constitution_type'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['account_type'] = $allpandata['result']['personal_details']['account_type'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['ckyc_no'] = $allpandata['result']['personal_details']['ckyc_no'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['prefix'] = $allpandata['result']['personal_details']['prefix'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['result']['personal_details']['first_name'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['middleName'] = $allpandata['result']['personal_details']['middle_name'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['result']['personal_details']['last_name'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['result']['personal_details']['full_name'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_prefix'] = $allpandata['result']['personal_details']['maiden_prefix'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fname'] = $allpandata['result']['personal_details']['maiden_fname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_mname'] = $allpandata['result']['personal_details']['maiden_mname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_lname'] = $allpandata['result']['personal_details']['maiden_lname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fullname'] = $allpandata['result']['personal_details']['maiden_fullname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_or_spouse_flag'] = $allpandata['result']['personal_details']['father_or_spouse_flag'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_prefix'] = $allpandata['result']['personal_details']['father_prefix'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fname'] = $allpandata['result']['personal_details']['father_fname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_mname'] = $allpandata['result']['personal_details']['father_mname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_lname'] = $allpandata['result']['personal_details']['father_lname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fullname'] = $allpandata['result']['personal_details']['father_fullname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_prefix'] = $allpandata['result']['personal_details']['mother_prefix'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fname'] = $allpandata['result']['personal_details']['mother_fname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_mname'] = $allpandata['result']['personal_details']['mother_mname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_lname'] = $allpandata['result']['personal_details']['mother_lname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fullname'] = $allpandata['result']['personal_details']['mother_fullname'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = isset($allpandata['result']['personal_details']['mob_code']) && isset($allpandata['result']['personal_details']['mob_num']) ? '+' . $allpandata['result']['personal_details']['mob_code'] . $allpandata['result']['personal_details']['mob_num'] : null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan'] = $allpandata['result']['personal_details']['pan'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['result']['personal_details']['email'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['result']['personal_details']['dob'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['age'] = $allpandata['result']['age'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender'] = $allpandata['result']['personal_details']['gender'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'] = $allpandata['result']['personal_details']['perm_line1'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'] = $allpandata['result']['personal_details']['perm_line2'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_line3'] = $allpandata['result']['personal_details']['perm_line3'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'] = $allpandata['result']['personal_details']['perm_city'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'] = $allpandata['result']['personal_details']['perm_dist'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permState'] = $allpandata['result']['personal_details']['perm_state'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'] = $allpandata['result']['personal_details']['perm_pin'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCountry'] = $allpandata['result']['personal_details']['perm_country'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPoa'] = $allpandata['result']['personal_details']['perm_poa'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_corres_sameflag'] = $allpandata['result']['personal_details']['perm_corres_sameflag'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'] = $allpandata['result']['personal_details']['corres_line1'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'] = $allpandata['result']['personal_details']['corres_line2'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corres_line3'] = $allpandata['result']['personal_details']['corres_line3'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'] = $allpandata['result']['personal_details']['corres_city'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'] = $allpandata['result']['personal_details']['corres_dist'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'] = $allpandata['result']['personal_details']['corres_state'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCountry'] = $allpandata['result']['personal_details']['corres_country'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPoa'] = $allpandata['result']['personal_details']['corres_poa'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'] = $allpandata['result']['personal_details']['corres_pin'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_std_code'] = $allpandata['result']['personal_details']['resi_std_code'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_tel_num'] = $allpandata['result']['personal_details']['resi_tel_num'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_tel_num'] = $allpandata['result']['personal_details']['off_tel_num'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_std_code'] = $allpandata['result']['personal_details']['off_std_code'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['remarks'] = $allpandata['result']['personal_details']['remarks'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_date'] = $allpandata['result']['personal_details']['dec_date'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_place'] = $allpandata['result']['personal_details']['dec_place'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['doc_sub'] = $allpandata['result']['personal_details']['doc_sub'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_date'] = $allpandata['result']['kyc_date'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_name'] = $allpandata['result']['personal_details']['kyc_name'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_designation'] = $allpandata['result']['personal_details']['kyc_designation'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_branch'] = $allpandata['result']['personal_details']['kyc_branch'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_empcode'] = $allpandata['result']['personal_details']['kyc_empcode'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_name'] = $allpandata['result']['personal_details']['org_name'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_code'] = $allpandata['result']['personal_details']['org_code'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'] = $allpandata['result']['personal_details']['num_identity'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'] = $allpandata['result']['personal_details']['num_related'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'] = $allpandata['result']['personal_details']['num_images'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['related_person_details'] = $allpandata['result']['related_person_details'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['identity_details'] = $allpandata['result']['identity_details'] ?? null;
                    $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['image_details'] = $allpandata['result']['image_details'] ?? null;

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }
                        if (isset($allpandata['result']['image_details']['image']) && is_array($allpandata['result']['image_details']['image'])) {
                            $panvalidation = DB::table('search_new')->insert([
                                'user_id' => $user->id,
                                'api_id' => $api_id,
                                'status' => 200,
                                'constitution_type' => $allpandata['result']['personal_details']['constitution_type'] ?? null,
                                'account_type' => $allpandata['result']['personal_details']['account_type'] ?? null,
                                'prefix' => $allpandata['result']['personal_details']['prefix'] ?? null,
                                'maiden_prefix' => $allpandata['result']['personal_details']['maiden_prefix'] ?? null,
                                'maiden_fname' => $allpandata['result']['personal_details']['maiden_fname'] ?? null,
                                'maiden_mname' => $allpandata['result']['personal_details']['maiden_mname'] ?? null,
                                'maiden_lname' => $allpandata['result']['personal_details']['maiden_lname'] ?? null,
                                'maiden_fullname' => $allpandata['result']['personal_details']['maiden_fullname'] ?? null,
                                'father_prefix' => $allpandata['result']['personal_details']['father_prefix'] ?? null,
                                'father_fname' => $allpandata['result']['personal_details']['father_fname'] ?? null,
                                'father_mname' => $allpandata['result']['personal_details']['father_mname'] ?? null,
                                'father_lname' => $allpandata['result']['personal_details']['father_lname'] ?? null,
                                'father_fullname' => $allpandata['result']['personal_details']['father_fullname'] ?? null,
                                'mother_prefix' => $allpandata['result']['personal_details']['mother_prefix'] ?? null,
                                'mother_fname' => $allpandata['result']['personal_details']['mother_fname'] ?? null,
                                'mother_mname' => $allpandata['result']['personal_details']['mother_mname'] ?? null,
                                'mother_lname' => $allpandata['result']['personal_details']['mother_lname'] ?? null,
                                'mother_fullname' => $allpandata['result']['personal_details']['mother_fullname'] ?? null,
                                'pan_no' => $allpandata['result']['personal_details']['pan'] ?? null,
                                'ckycid' => $allpandata['result']['personal_details']['ckyc_no'] ?? null,
                                'firstname' => $allpandata['result']['personal_details']['first_name'] ?? null,
                                'middle_name' => $allpandata['result']['personal_details']['middle_name'] ?? null,
                                'last_name' => $allpandata['result']['personal_details']['last_name'] ?? null,
                                'fullname' => $allpandata['result']['personal_details']['full_name'] ?? null,
                                'mobilenum' => $allpandata['result']['personal_details']['mob_num'] ?? null,
                                'email' => $allpandata['result']['personal_details']['email'] ?? null,
                                'dob' => $allpandata['result']['personal_details']['dob'] ?? null,
                                'age' => $allpandata['result']['age'] ?? null,
                                'gender' => $allpandata['result']['personal_details']['gender'] ?? null,
                                'pstate' => $allpandata['result']['personal_details']['perm_state'] ?? null,
                                'pcity' => $allpandata['result']['personal_details']['perm_city'] ?? null,
                                'permCountry' => $allpandata['result']['personal_details']['perm_country'] ?? null,
                                'permPoa' => $allpandata['result']['personal_details']['perm_poa'] ?? null,
                                'caddress1' => $allpandata['result']['personal_details']['corres_line1'] ?? null,
                                'caddress2' => $allpandata['result']['personal_details']['corres_line2'] ?? null,
                                'caddress3' => $allpandata['result']['personal_details']['corres_line3'] ?? null,
                                'paddress' => $allpandata['result']['personal_details']['perm_line1'] ?? null,
                                'paddress2' => $allpandata['result']['personal_details']['perm_line2'] ?? null,
                                'paddress3' => $allpandata['result']['personal_details']['perm_line3'] ?? null,
                                'perm_corres_sameflag' => $allpandata['result']['personal_details']['perm_corres_sameflag'] ?? null,
                                'cstate' => $allpandata['result']['personal_details']['corres_state'] ?? null,
                                'ccity' => $allpandata['result']['personal_details']['corres_city'] ?? null,
                                'currentpincode' => $allpandata['result']['personal_details']['corres_pin'] ?? null,
                                'permanantpincode' => $allpandata['result']['personal_details']['perm_pin'] ?? null,
                                'branch_code1' => $allpandata['result']['image_details']['image'][0]['branch_code'] ?? null,
                                'branch_code2' => $allpandata['result']['image_details']['image'][1]['branch_code'] ?? null,
                                'branch_code3' => $allpandata['result']['image_details']['image'][2]['branch_code'] ?? null,
                                'branch_code4' => $allpandata['result']['image_details']['image'][3]['branch_code'] ?? null,
                                'resi_std_code' => $allpandata['result']['personal_details']['resi_std_code'] ?? null,
                                'resi_tel_num' => $allpandata['result']['personal_details']['resi_tel_num'] ?? null,
                                'off_std_code' => $allpandata['result']['personal_details']['off_std_code'] ?? null,
                                'remarks' => $allpandata['result']['personal_details']['remarks'] ?? null,
                                'father_or_spouse_flag' => $allpandata['result']['personal_details']['father_or_spouse_flag'] ?? null,
                                'dec_date' => $allpandata['result']['personal_details']['dec_date'] ?? null,
                                'dec_place' => $allpandata['result']['personal_details']['dec_place'] ?? null,
                                'doc_sub' => $allpandata['result']['personal_details']['doc_sub'] ?? null,
                                'kyc_date' => $allpandata['result']['kyc_date'] ?? null,
                                'kyc_name' => $allpandata['result']['personal_details']['kyc_name'] ?? null,
                                'kyc_designation' => $allpandata['result']['personal_details']['kyc_designation'] ?? null,
                                'kyc_branch' => $allpandata['result']['personal_details']['kyc_branch'] ?? null,
                                'kyc_empcode' => $allpandata['result']['personal_details']['kyc_empcode'] ?? null,
                                'org_name' => $allpandata['result']['personal_details']['org_name'] ?? null,
                                'org_code' => $allpandata['result']['personal_details']['org_code'] ?? null,
                                'image_url1' => $allpandata['result']['image_details']['image'][0]['image_url'] ?? null,
                                'image_url2' => $allpandata['result']['image_details']['image'][1]['image_url'] ?? null,
                                'image_url3' => $allpandata['result']['image_details']['image'][2]['image_url'] ?? null,
                                'image_url4' => $allpandata['result']['image_details']['image'][3]['image_url'] ?? null,
                                'image_code1' => $allpandata['result']['image_details']['image'][0]['image_code'] ?? null,
                                'image_code2' => $allpandata['result']['image_details']['image'][1]['image_code'] ?? null,
                                'image_code3' => $allpandata['result']['image_details']['image'][2]['image_code'] ?? null,
                                'image_code4' => $allpandata['result']['image_details']['image'][3]['image_code'] ?? null,
                                'image_data1' => $allpandata['result']['image_details']['image'][0]['image_data'] ?? null,
                                'image_data2' => $allpandata['result']['image_details']['image'][1]['image_data'] ?? null,
                                'image_data3' => $allpandata['result']['image_details']['image'][2]['image_data'] ?? null,
                                'image_data4' => $allpandata['result']['image_details']['image'][3]['image_data'] ?? null,
                                'ident_type1' => $allpandata['result']['identity_details']['identity'][0]['ident_type'] ?? null,
                                'ident_type2' => $allpandata['result']['identity_details']['identity'][1]['ident_type'] ?? null,
                                'ident_type3' => $allpandata['result']['identity_details']['identity'][2]['ident_type'] ?? null,
                                'ident_type4' => $allpandata['result']['identity_details']['identity'][3]['ident_type'] ?? null,
                                'ident_num1' => $allpandata['result']['identity_details']['identity'][0]['ident_num'] ?? null,
                                'ident_num2' => $allpandata['result']['identity_details']['identity'][1]['ident_num'] ?? null,
                                'ident_num3' => $allpandata['result']['identity_details']['identity'][2]['ident_num'] ?? null,
                                'ident_num4' => $allpandata['result']['identity_details']['identity'][3]['ident_num'] ?? null,
                                'idver_status1' => $allpandata['result']['identity_details']['identity'][0]['idver_status'] ?? null,
                                'idver_status2' => $allpandata['result']['identity_details']['identity'][1]['idver_status'] ?? null,
                                'idver_status3' => $allpandata['result']['identity_details']['identity'][2]['idver_status'] ?? null,
                                'idver_status4' => $allpandata['result']['identity_details']['identity'][3]['idver_status'] ?? null,
                                'created_at' => Carbon::now(),
                                'updated_at' => Carbon::now(),
                            ]);
                        }
                    }
                    return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
                } elseif (isset($allpandata['status']) && $allpandata['status'] == 'INVALID') {
                    if ($user->role_id == 1) {
                        $statusCode = 102;
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                        }
                        $panvalidation = DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'mobilenum' => $allpandata['result']['personal_details']['mob_num'] ?? null,
                            'status' => 102,
                            'pan_no' => $allpandata['result']['personal_details']['pan'] ?? null,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    $searchkyc['status'] = $allpandata['status'];
                    $searchkyc['error'] = $allpandata['error'] ?? 'Invalid OTP';
                    return response()->json(['statusCode' => 102, 'response' => $searchkyc]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                        }
                    }
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'mobilenum' => $allpandata['result']['personal_details']['mob_num'] ?? null,
                        'status' => 202,
                        'pan_no' => $allpandata['result']['personal_details']['pan'] ?? null,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                    return response()->json(['statusCode' => 202, 'response' => $allpandata]);
                }
            } else {
                return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
            }
        }
    }

     public function bank_verification_latest(Request $request)
    {
        $statusCode = null;
        $bank_verification = null;
        $api_id = null;

        if (empty($request->name))
            return response()->json(array(['message' => 'Name is required', 'statusCode' => '404']));
        if (empty($request->accno))
            return response()->json(array(['message' => 'Account number is required', 'statusCode' => '404']));
        if (empty($request->ifsc))
            return response()->json(array(['message' => 'IFSC code is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'x-api-key' => $this->api_club_key,
            'Referer' => $this->site_url
        ];

        $body = [
            // 'is_test' => 'FALSE',
            'name' => $request->name,
            'accno' => $request->accno,
            'ifsc' => $request->ifsc
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {

                    $res = $client->post('https://prod.apiclub.in/api/v1/validate/bank', ['headers' => $headers, 'json' => $body]);
                    $bank_verification = json_decode($res->getBody(), true);

                    if (isset($bank_verification['code']) && $bank_verification['code'] == 200) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "client_id" => $bank_verification['response']['orderId'] ?? '',
                                "account_exists" => $bank_verification['response']['account_details']['account_status'] ?? '',
                                "upi_id" => $bank_verification['response']['orderId'] ?? '',
                                "full_name" => $bank_verification['response']['account_details']['beneficiary_name'] ?? '',
                                "remarks" => $bank_verification['response']['message'] ?? '',
                                'status_code' => 200,
                                'message' => 'success',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(array(['bank_verification' => $bank_verification['response']['account_details'], 'statusCode' => '200']));
                    } else if (isset($bank_verification['code']) && $bank_verification['code'] == 404) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                'status_code' => 102,
                                'message' => 'failed',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(['status_code' => 404, 'message' => "Error.Please contact techsupport@docboyz.in. for more details"]);
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                'status_code' => 500,
                                'message' => 'failed',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(['status_code' => 500, 'message' => "Internal Server Error.Please contact techsupport@docboyz.in"]);
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['bank_verification' => $bank_verification['response']['account_details'], 'statusCode' => '200']));
    }

     public function bank_verification_latest18agust2025(Request $request)
    {
        $statusCode = null;
        $bank_verification = null;
        $api_id = null;

        if (empty($request->name))
            return response()->json(array(['message' => 'Name is required', 'statusCode' => '404']));
        if (empty($request->accno))
            return response()->json(array(['message' => 'Account number is required', 'statusCode' => '404']));
        if (empty($request->ifsc))
            return response()->json(array(['message' => 'IFSC code is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'bank')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'x-api-key' => $this->api_club_key,
            'Referer' => $this->site_url
        ];

        $body = [
            // 'is_test' => 'FALSE',
            'name' => $request->name,
            'accno' => $request->accno,
            'ifsc' => $request->ifsc
        ];

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                try {

                    $res = $client->post('https://prod.apiclub.in/api/v1/validate/bank', ['headers' => $headers, 'json' => $body]);
                    $bank_verification = json_decode($res->getBody(), true);

                    if (isset($bank_verification['code']) && $bank_verification['code'] == 200) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                "client_id" => $bank_verification['response']['orderId'] ?? '',
                                "account_exists" => $bank_verification['response']['account_details']['account_status'] ?? '',
                                "upi_id" => $bank_verification['response']['orderId'] ?? '',
                                "full_name" => $bank_verification['response']['account_details']['beneficiary_name'] ?? '',
                                "remarks" => $bank_verification['response']['message'] ?? '',
                                'status_code' => 200,
                                'message' => 'success',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(array(['bank_verification' => $bank_verification['response']['account_details'], 'statusCode' => '200']));
                    } else if (isset($bank_verification['code']) && $bank_verification['code'] == 404) {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                'status_code' => 102,
                                'message' => 'failed',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(['status_code' => 404, 'message' => "Error.Please contact techsupport@docboyz.in. for more details"]);
                    } else {
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                            }
                            $bankvalidation = DB::table('bankvalidation')->insert([
                                "user_id" => $user->id,
                                "api_id" => $api_id,
                                'status_code' => 500,
                                'message' => 'failed',
                                "created_at" => Carbon::now(),
                                "updated_at" => Carbon::now()
                            ]);
                        }
                        return response()->json(['status_code' => 500, 'message' => "Internal Server Error.Please contact techsupport@docboyz.in"]);
                    }

                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    // return $errorResponse;
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter valid details.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['bank_verification' => $bank_verification['response']['account_details'], 'statusCode' => '200']));
    }


    public function voter_validation_latest26agust2025(Request $request)
    {
        $statusCode = null;
        $voter_validation = null;
        $api_id = null;

        if (empty($request->voter_number))
            return response()->json(array(['message' => 'Voter id number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'voter_id')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'x-api-key' => '2487be27f4d20bc1d366cb38f098eba7',
            'Referer' => 'http://regtechapi.in',
            'accept' => 'application/json',
        ];

        $body = [
            'voter_id' => $request->voter_number
        ];
        // $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                try {
                    // $res = $client->post($this->base_url.'/voter-id/voter-id', ['headers' => $headers, 'json' => $body,'form_params' => ['api_token' => $token]]);
                    $res = $client->post('https://prod.apiclub.in/api/v1/verify_votercard', ['headers' => $headers, 'json' => $body]);
                    $voter_validation = json_decode($res->getBody(), true);
                    // return $voter_validation;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                        $votervalidation = DB::table('voter_verification')->insert([
                            "user_id" => $user->id,
                            "api_id" => $api_id,
                            // "client_id"=> $voter_validation['data']['client_id'],
                            "epic_no" => $voter_validation['response']['epic_no'],
                            "gender" => $voter_validation['response']['gender'],
                            "state"=> $voter_validation['response']['state'],
                            "name" => $voter_validation['response']['holder_name'],
                            "relation_name" => $voter_validation['response']['relation'],
                            "relation_type" => $voter_validation['response']['relation_type'],
                            // "house_no"=> $voter_validation['data']['house_no'],
                            "dob" => $voter_validation['response']['dob'],
                            "age" => $voter_validation['response']['age'],
                            "area" => $voter_validation['response']['area'],
                            "district" => $voter_validation['response']['district'],
                            "multiple"=> $voter_validation['response']['multiple'],
                            "last_update"=> $voter_validation['response']['last_update'],
                            "assembly_constituency"=> $voter_validation['response']['assembly_constituency'],
                            "assembly_constituency_number"=> $voter_validation['response']['assembly_constituency_number'],
                            "polling_station"=> $voter_validation['response']['polling_station'],
                            "part_number"=> $voter_validation['response']['part_number'],
                            "part_name"=> $voter_validation['response']['part_name'],
                            "slno_inpart"=> $voter_validation['response']['sl_no_app_part'],
                            "ps_lat_long"=> $voter_validation['response']['polling_lat_long'],
                            "rln_name_v1"=> $voter_validation['response']['relation_f_name1'],
                            // "rln_name_v2"=> $voter_validation['response']['rln_name_v2'],
                            // "rln_name_v3"=> $voter_validation['response']['rln_name_v3'],
                            "section_no"=> $voter_validation['response']['section_number'],
                            // "name_v1"=> $voter_validation['response']['name_v1'],
                            // "name_v2"=> $voter_validation['response']['name_v2'],
                            // "name_v3"=> $voter_validation['response']['name_v3'],
                            "st_code"=> $voter_validation['response']['state_code'],
                            "parliamentary_constituency"=> $voter_validation['response']['parliamentary_constituency'],
                            "v_id"=> $voter_validation['response']['id'],
                            "created_at" => Carbon::now(),
                            "updated_at" => Carbon::now()
                        ]);
                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Voter ID.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['voter_validation' => $voter_validation, 'statusCode' => '200']));
    }

   
public function ckycSearchdownloadProduction(Request $request)
{
    $statusCode = null;
    $api_id = null;

    if (empty($request->pano)) {
        return response()->json(['message' => 'Pancard number is required', 'statusCode' => 404]);
    }
    if (empty($request->identifier_type)) {
        return response()->json(['message' => 'identifier_type is required', 'statusCode' => 404]);
    }
    if (empty($request->mobile)) {
        return response()->json(['message' => 'Mobile number is required', 'statusCode' => 404]);
    }
    if (empty($request->client_ref_num)) {
        return response()->json(['message' => 'Client Reference is required', 'statusCode' => 404]);
    }
    if (!$request->headers->has('AccessToken')) {
        return response()->json(['message' => 'Header Access Token is required', 'statusCode' => 404]);
    }

    $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    if ($verifyAccessToken == false) {
        return response()->json(['message' => 'Wrong Access Token', 'statusCode' => 403]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'searchkycdigitap')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $panno = $request->pano;
        if ($panno == 'HUHPS7607K') {
            $data = [
                [
                    [
                        "response" => [
                            "status" => "VALID",
                            "kycStatus" => "null",
                            "message" => "Details downloaded successfully.",
                            "kycDetails" => [
                                "personalIdentifiableData" => [
                                    "personalDetails" => [
                                        "constitution_type" => "Individual",
                                        "account_type" => "Normal",
                                        "ckyc_no" => "60042994549621",
                                        "prefix" => "MR",
                                        "firstName" => "HARSHIT",
                                        "lastName" => "SINGH",
                                        "fullName" => "MR HARSHIT SINGH",
                                        "maiden_prefix" => "null",
                                        "maiden_fname" => "null",
                                        "maiden_mname" => "null",
                                        "maiden_lname" => "null",
                                        "maiden_fullname" => "null",
                                        "father_or_spouse_flag" => "null",
                                        "father_prefix" => "MR",
                                        "father_fname" => "Balram",
                                        "father_mname" => "null",
                                        "father_lname" => "Singh",
                                        "father_fullname" => "MR Balram Singh",
                                        "mother_prefix" => "MRS",
                                        "mother_fname" => "ANITA",
                                        "mother_mname" => "null",
                                        "mother_lname" => "SINGH",
                                        "mother_fullname" => "MRS ANITA SINGH",
                                        "mobNum" => "9450367613",
                                        "pan" => "HUHPS7607K",
                                        "email" => "luckyharshit741@gmail.com",
                                        "dob" => "12-02-1999",
                                        "age" => "25",
                                        "gender" => "M",
                                        "permLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "permLine2" => "JATEPUR",
                                        "perm_line3" => "NEAR KRISHNA NAGAR",
                                        "permCity" => "Gorakhpur",
                                        "permDist" => "Gorakhpur",
                                        "permState" => "Uttar Pradesh",
                                        "permPin" => "273001",
                                        "permCountry" => "IN",
                                        "permPoa" => "E-KYC Authentication",
                                        "perm_corres_sameflag" => "Y",
                                        "corresLine1" => "S/O=> BALRAM SINGH,934,RAJENDRA NAGAR UTTARI",
                                        "corresLine2" => "JATEPUR",
                                        "corres_line3" => "NEAR KRISHNA NAGAR",
                                        "corresCity" => "Gorakhpur",
                                        "corresDist" => "Gorakhpur",
                                        "corresState" => "Uttar Pradesh",
                                        "corresPin" => "273001",
                                        "corresCountry" => "IN",
                                        "corresPoa" => "09",
                                        "resi_std_code" => "522",
                                        "resi_tel_num" => "7734945195",
                                        "off_tel_num" => "null",
                                        "off_std_code" => "0",
                                        "remarks" => "null",
                                        "dec_date" => "02-11-2023",
                                        "dec_place" => "Gorakhpur",
                                        "doc_sub" => "06",
                                        "kyc_date" => "********",
                                        "kyc_name" => "********",
                                        "kyc_designation" => "********",
                                        "kyc_branch" => "********",
                                        "kyc_empcode" => "********",
                                        "org_name" => "********",
                                        "org_code" => "********",
                                        "numIdentity" => "1",
                                        "numRelated" => "0",
                                        "numImages" => "3",
                                        "related_person_details" => "null",
                                        "identity_details" => [
                                            "identity" => [
                                                [
                                                    "sequence_no" => "1",
                                                    "ident_type" => "H",
                                                    "ident_num" => "XXXXXXXX4191",
                                                    "idver_status" => "N",
                                                ],

                                            ],
                                            "image_details" => [
                                                "image" => [
                                                    [
                                                        "sequence_no" => "1",
                                                        "image_type" => "pdf",
                                                        "image_code" => "PAN",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "JVBERi0xLjQNJeLjz9MNCjEgMCBv",
                                                        "image_url" => "https=>/ap-south-1amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "2",
                                                        "image_type" => "JPG",
                                                        "image_code" => "Photograph",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                    [
                                                        "sequence_no" => "3",
                                                        "image_type" => "pdf",
                                                        "image_code" => "Proof of Possession of Aadhaar",
                                                        "global_flag" => "Global",
                                                        "branch_code" => "02",
                                                        "image_data" => "/9j/4AAQSkZJRgABAQAAAQABAAD/G",
                                                        "image_url" => "https=>//s3.ap-south-1.amazonaws.com/digitap-ckyc"
                                                    ],
                                                ]
                                            ]
                                        ]
                                    ]
                                ]
                            ]
                        ]
                    ]
                ]
            ];

            return response()->json(['statusCode' => 200, 'data' => $data]);
        }

        $client_ref_num = $request->client_ref_num;
        $identity_type = $request->identifier_type;
        $mobile = $request->mobile;

        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->orderBy('id', 'desc')
            ->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
                $url = 'https://api.digitap.ai/ckyc/v3/search';

                $data = [
                    'client_ref_num' => $client_ref_num,
                    'identifier' => $panno,
                    'identifier_type' => $identity_type,
                ];

                $body = json_encode($data);

                $ch = curl_init($url);
                curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization: Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'content-type:application/json']);
                curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                $get_data1 = curl_exec($ch);
                if ($get_data1 === false) {
                    $error = curl_error($ch);
                    curl_close($ch);
                    return response()->json(['statusCode' => 500, 'message' => 'cURL request failed: ' . $error]);
                }
                curl_close($ch);

                $kyccard = json_decode($get_data1, true);
                if (json_last_error() !== JSON_ERROR_NONE || !isset($kyccard['result_code'])) {
                    return response()->json(['statusCode' => 500, 'message' => 'Invalid JSON response from API']);
                }

                if (isset($kyccard['result_code']) && $kyccard['result_code'] == 103) {
                    $kyccarderror = [];
                    $kyccarderror['error']['status'] = 102;
                    $kyccarderror['error']['message'] = $kyccard['error'];
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                        }
                        DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'mobilenum' => $mobile,
                            'status' => 102,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 102, 'response' => $kyccarderror]);
                }

                if (isset($kyccard['result_code']) && $kyccard['result_code'] == 101) {
                    $searchkyc = [];
                    $url = 'https://api.digitap.ai/ckyc/v3/download/request';


                    $data = [
                        'ckyc_id' => $kyccard['result'][0]['ckyc_ref_id'],
                        'client_ref_num' => $client_ref_num,
                        'auth_factor_type' => "MOBILE",
                        'auth_factor' => $mobile,
                    ];

                    $body = json_encode($data);

                    $ch = curl_init($url);
                    curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
                    curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization: Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'content-type:application/json']);
                    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

                    $alldata = curl_exec($ch);
                    if ($alldata === false) {
                        $error = curl_error($ch);
                        curl_close($ch);
                        return response()->json(['statusCode' => 500, 'message' => 'cURL request failed: ' . $error]);
                    }
                    curl_close($ch);

                    $allpandata = json_decode($alldata, true);
                    if (json_last_error() !== JSON_ERROR_NONE || !isset($allpandata['result_code'])) {
                        return response()->json(['statusCode' => 500, 'message' => 'Invalid JSON response from API']);
                    }

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Success.', 200);
                        }
                        DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'mobilenum' => $mobile,
                            'status' => 200,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }

                    return response()->json(['statusCode' => 200, 'response' => $allpandata]);
                } else {
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                        }
                        DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'mobilenum' => $mobile,
                            'status' => 201,
                            'pan_no' => $request->pano,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                    return response()->json(['statusCode' => 201, 'response' => $kyccard]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharge your wallet.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
}



public function validateCkycOtp(Request $request)
{
    $statusCode = null;

    $api_id = null;

    if (empty($request->otp)) {
        return response()->json(['message' => 'otp is required', 'statusCode' => 404]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json(['message' => 'Header Access Token is required', 'statusCode' => 404]);
    }

    $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    if ($verifyAccessToken == false) {
        return response()->json(['message' => 'Wrong Access Token', 'statusCode' => 403]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'searchkycdigitap')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();
    if ($updateHitCount || $user->role_id == 0) {
        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {
            // Build request
            $url = 'https://api.digitap.ai/ckyc/v3/download/otp/submit';
            $randomInt = strval(rand(100, 999));
            $data = [
                'client_ref_num' => $randomInt,
                'otp' => $request->otp,
                'ckyc_response_request_id' => $request->ckyc_response_request_id,
                'request_id' => $request->request_id,
            ];

            $body = json_encode($data);

            $ch = curl_init($url);
            curl_setopt($ch, CURLOPT_POSTFIELDS, $body);
            curl_setopt($ch, CURLOPT_HTTPHEADER, ['Authorization:Basic NjA0MDMyMDE6N09XVHNZU3g0Vk1VNjlNOGpQR29UUW1ZblpSVFN6R3M=', 'content-type:application/json']);
            curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

            $otpResponse = curl_exec($ch);
            if ($otpResponse === false) {
                $error = curl_error($ch);
                curl_close($ch);
                return response()->json(['statusCode' => 500, 'message' => 'cURL request failed: ' . $error]);
            }
            curl_close($ch);

            $allpandata = json_decode($otpResponse, true);
            if (json_last_error() !== JSON_ERROR_NONE) {
                return response()->json(['statusCode' => 500, 'message' => 'Invalid JSON response from API']);
            }

            if (isset($allpandata['result_code']) && $allpandata['result_code'] == 101) {
                // $searchkyc['status'] = $allpandata['status'];
                $searchkyc['kycStatus'] = null;
                $searchkyc['message'] = 'Details downloaded successfully';
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['constitution_type'] = $allpandata['result']['personal_details']['constitution_type'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['account_type'] = $allpandata['result']['personal_details']['account_type'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['ckyc_no'] = $allpandata['result']['personal_details']['ckyc_no'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['prefix'] = $allpandata['result']['personal_details']['prefix'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['firstName'] = $allpandata['result']['personal_details']['first_name'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['middleName'] = $allpandata['result']['personal_details']['middle_name'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['lastName'] = $allpandata['result']['personal_details']['last_name'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['fullName'] = $allpandata['result']['personal_details']['full_name'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_prefix'] = $allpandata['result']['personal_details']['maiden_prefix'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fname'] = $allpandata['result']['personal_details']['maiden_fname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_mname'] = $allpandata['result']['personal_details']['maiden_mname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_lname'] = $allpandata['result']['personal_details']['maiden_lname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['maiden_fullname'] = $allpandata['result']['personal_details']['maiden_fullname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_or_spouse_flag'] = $allpandata['result']['personal_details']['father_or_spouse_flag'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_prefix'] = $allpandata['result']['personal_details']['father_prefix'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fname'] = $allpandata['result']['personal_details']['father_fname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_mname'] = $allpandata['result']['personal_details']['father_mname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_lname'] = $allpandata['result']['personal_details']['father_lname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['father_fullname'] = $allpandata['result']['personal_details']['father_fullname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_prefix'] = $allpandata['result']['personal_details']['mother_prefix'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fname'] = $allpandata['result']['personal_details']['mother_fname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_mname'] = $allpandata['result']['personal_details']['mother_mname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_lname'] = $allpandata['result']['personal_details']['mother_lname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mother_fullname'] = $allpandata['result']['personal_details']['mother_fullname'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['mobNum'] = isset($allpandata['result']['personal_details']['mob_code']) && isset($allpandata['result']['personal_details']['mob_num']) ? '+' . $allpandata['result']['personal_details']['mob_code'] . $allpandata['result']['personal_details']['mob_num'] : null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['pan'] = $allpandata['result']['personal_details']['pan'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['email'] = $allpandata['result']['personal_details']['email'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dob'] = $allpandata['result']['personal_details']['dob'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['age'] = $allpandata['result']['age'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['gender'] = $allpandata['result']['personal_details']['gender'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine1'] = $allpandata['result']['personal_details']['perm_line1'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permLine2'] = $allpandata['result']['personal_details']['perm_line2'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_line3'] = $allpandata['result']['personal_details']['perm_line3'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCity'] = $allpandata['result']['personal_details']['perm_city'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permDist'] = $allpandata['result']['personal_details']['perm_dist'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permState'] = $allpandata['result']['personal_details']['perm_state'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPin'] = $allpandata['result']['personal_details']['perm_pin'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permCountry'] = $allpandata['result']['personal_details']['perm_country'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['permPoa'] = $allpandata['result']['personal_details']['perm_poa'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['perm_corres_sameflag'] = $allpandata['result']['personal_details']['perm_corres_sameflag'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine1'] = $allpandata['result']['personal_details']['corres_line1'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresLine2'] = $allpandata['result']['personal_details']['corres_line2'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corres_line3'] = $allpandata['result']['personal_details']['corres_line3'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCity'] = $allpandata['result']['personal_details']['corres_city'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresDist'] = $allpandata['result']['personal_details']['corres_dist'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresState'] = $allpandata['result']['personal_details']['corres_state'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresCountry'] = $allpandata['result']['personal_details']['corres_country'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPoa'] = $allpandata['result']['personal_details']['corres_poa'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['corresPin'] = $allpandata['result']['personal_details']['corres_pin'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_std_code'] = $allpandata['result']['personal_details']['resi_std_code'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['resi_tel_num'] = $allpandata['result']['personal_details']['resi_tel_num'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_tel_num'] = $allpandata['result']['personal_details']['off_tel_num'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['off_std_code'] = $allpandata['result']['personal_details']['off_std_code'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['remarks'] = $allpandata['result']['personal_details']['remarks'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_date'] = $allpandata['result']['personal_details']['dec_date'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['dec_place'] = $allpandata['result']['personal_details']['dec_place'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['doc_sub'] = $allpandata['result']['personal_details']['doc_sub'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_date'] = $allpandata['result']['kyc_date'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_name'] = $allpandata['result']['personal_details']['kyc_name'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_designation'] = $allpandata['result']['personal_details']['kyc_designation'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_branch'] = $allpandata['result']['personal_details']['kyc_branch'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['kyc_empcode'] = $allpandata['result']['personal_details']['kyc_empcode'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_name'] = $allpandata['result']['personal_details']['org_name'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['org_code'] = $allpandata['result']['personal_details']['org_code'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numIdentity'] = $allpandata['result']['personal_details']['num_identity'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numRelated'] = $allpandata['result']['personal_details']['num_related'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['numImages'] = $allpandata['result']['personal_details']['num_images'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['related_person_details'] = $allpandata['result']['related_person_details'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['identity_details'] = $allpandata['result']['identity_details'] ?? null;
                $searchkyc['kycDetails']['personalIdentifiableData']['personalDetails']['image_details'] = $allpandata['result']['image_details'] ?? null;

                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                    }
                    if (isset($allpandata['result']['image_details']['image']) && is_array($allpandata['result']['image_details']['image'])) {
                        $panvalidation = DB::table('search_new')->insert([
                            'user_id' => $user->id,
                            'api_id' => $api_id,
                            'status' => 200,
                            'constitution_type' => $allpandata['result']['personal_details']['constitution_type'] ?? null,
                            'account_type' => $allpandata['result']['personal_details']['account_type'] ?? null,
                            'prefix' => $allpandata['result']['personal_details']['prefix'] ?? null,
                            'maiden_prefix' => $allpandata['result']['personal_details']['maiden_prefix'] ?? null,
                            'maiden_fname' => $allpandata['result']['personal_details']['maiden_fname'] ?? null,
                            'maiden_mname' => $allpandata['result']['personal_details']['maiden_mname'] ?? null,
                            'maiden_lname' => $allpandata['result']['personal_details']['maiden_lname'] ?? null,
                            'maiden_fullname' => $allpandata['result']['personal_details']['maiden_fullname'] ?? null,
                            'father_prefix' => $allpandata['result']['personal_details']['father_prefix'] ?? null,
                            'father_fname' => $allpandata['result']['personal_details']['father_fname'] ?? null,
                            'father_mname' => $allpandata['result']['personal_details']['father_mname'] ?? null,
                            'father_lname' => $allpandata['result']['personal_details']['father_lname'] ?? null,
                            'father_fullname' => $allpandata['result']['personal_details']['father_fullname'] ?? null,
                            'mother_prefix' => $allpandata['result']['personal_details']['mother_prefix'] ?? null,
                            'mother_fname' => $allpandata['result']['personal_details']['mother_fname'] ?? null,
                            'mother_mname' => $allpandata['result']['personal_details']['mother_mname'] ?? null,
                            'mother_lname' => $allpandata['result']['personal_details']['mother_lname'] ?? null,
                            'mother_fullname' => $allpandata['result']['personal_details']['mother_fullname'] ?? null,
                            'pan_no' => $allpandata['result']['personal_details']['pan'] ?? null,
                            'ckycid' => $allpandata['result']['personal_details']['ckyc_no'] ?? null,
                            'firstname' => $allpandata['result']['personal_details']['first_name'] ?? null,
                            'middle_name' => $allpandata['result']['personal_details']['middle_name'] ?? null,
                            'last_name' => $allpandata['result']['personal_details']['last_name'] ?? null,
                            'fullname' => $allpandata['result']['personal_details']['full_name'] ?? null,
                            'mobilenum' => $allpandata['result']['personal_details']['mob_num'] ?? null,
                            'email' => $allpandata['result']['personal_details']['email'] ?? null,
                            'dob' => $allpandata['result']['personal_details']['dob'] ?? null,
                            'age' => $allpandata['result']['age'] ?? null,
                            'gender' => $allpandata['result']['personal_details']['gender'] ?? null,
                            'pstate' => $allpandata['result']['personal_details']['perm_state'] ?? null,
                            'pcity' => $allpandata['result']['personal_details']['perm_city'] ?? null,
                            'permCountry' => $allpandata['result']['personal_details']['perm_country'] ?? null,
                            'permPoa' => $allpandata['result']['personal_details']['perm_poa'] ?? null,
                            'caddress1' => $allpandata['result']['personal_details']['corres_line1'] ?? null,
                            'caddress2' => $allpandata['result']['personal_details']['corres_line2'] ?? null,
                            'caddress3' => $allpandata['result']['personal_details']['corres_line3'] ?? null,
                            'paddress' => $allpandata['result']['personal_details']['perm_line1'] ?? null,
                            'paddress2' => $allpandata['result']['personal_details']['perm_line2'] ?? null,
                            'paddress3' => $allpandata['result']['personal_details']['perm_line3'] ?? null,
                            'perm_corres_sameflag' => $allpandata['result']['personal_details']['perm_corres_sameflag'] ?? null,
                            'cstate' => $allpandata['result']['personal_details']['corres_state'] ?? null,
                            'ccity' => $allpandata['result']['personal_details']['corres_city'] ?? null,
                            'currentpincode' => $allpandata['result']['personal_details']['corres_pin'] ?? null,
                            'permanantpincode' => $allpandata['result']['personal_details']['perm_pin'] ?? null,
                            'branch_code1' => $allpandata['result']['image_details']['image'][0]['branch_code'] ?? null,
                            'branch_code2' => $allpandata['result']['image_details']['image'][1]['branch_code'] ?? null,
                            'branch_code3' => $allpandata['result']['image_details']['image'][2]['branch_code'] ?? null,
                            'branch_code4' => $allpandata['result']['image_details']['image'][3]['branch_code'] ?? null,
                            'resi_std_code' => $allpandata['result']['personal_details']['resi_std_code'] ?? null,
                            'resi_tel_num' => $allpandata['result']['personal_details']['resi_tel_num'] ?? null,
                            'off_std_code' => $allpandata['result']['personal_details']['off_std_code'] ?? null,
                            'remarks' => $allpandata['result']['personal_details']['remarks'] ?? null,
                            'father_or_spouse_flag' => $allpandata['result']['personal_details']['father_or_spouse_flag'] ?? null,
                            'dec_date' => $allpandata['result']['personal_details']['dec_date'] ?? null,
                            'dec_place' => $allpandata['result']['personal_details']['dec_place'] ?? null,
                            'doc_sub' => $allpandata['result']['personal_details']['doc_sub'] ?? null,
                            'kyc_date' => $allpandata['result']['kyc_date'] ?? null,
                            'kyc_name' => $allpandata['result']['personal_details']['kyc_name'] ?? null,
                            'kyc_designation' => $allpandata['result']['personal_details']['kyc_designation'] ?? null,
                            'kyc_branch' => $allpandata['result']['personal_details']['kyc_branch'] ?? null,
                            'kyc_empcode' => $allpandata['result']['personal_details']['kyc_empcode'] ?? null,
                            'org_name' => $allpandata['result']['personal_details']['org_name'] ?? null,
                            'org_code' => $allpandata['result']['personal_details']['org_code'] ?? null,
                            'image_url1' => $allpandata['result']['image_details']['image'][0]['image_url'] ?? null,
                            'image_url2' => $allpandata['result']['image_details']['image'][1]['image_url'] ?? null,
                            'image_url3' => $allpandata['result']['image_details']['image'][2]['image_url'] ?? null,
                            'image_url4' => $allpandata['result']['image_details']['image'][3]['image_url'] ?? null,
                            'image_code1' => $allpandata['result']['image_details']['image'][0]['image_code'] ?? null,
                            'image_code2' => $allpandata['result']['image_details']['image'][1]['image_code'] ?? null,
                            'image_code3' => $allpandata['result']['image_details']['image'][2]['image_code'] ?? null,
                            'image_code4' => $allpandata['result']['image_details']['image'][3]['image_code'] ?? null,
                            'image_data1' => $allpandata['result']['image_details']['image'][0]['image_data'] ?? null,
                            'image_data2' => $allpandata['result']['image_details']['image'][1]['image_data'] ?? null,
                            'image_data3' => $allpandata['result']['image_details']['image'][2]['image_data'] ?? null,
                            'image_data4' => $allpandata['result']['image_details']['image'][3]['image_data'] ?? null,
                            'ident_type1' => $allpandata['result']['identity_details']['identity'][0]['ident_type'] ?? null,
                            'ident_type2' => $allpandata['result']['identity_details']['identity'][1]['ident_type'] ?? null,
                            'ident_type3' => $allpandata['result']['identity_details']['identity'][2]['ident_type'] ?? null,
                            'ident_type4' => $allpandata['result']['identity_details']['identity'][3]['ident_type'] ?? null,
                            'ident_num1' => $allpandata['result']['identity_details']['identity'][0]['ident_num'] ?? null,
                            'ident_num2' => $allpandata['result']['identity_details']['identity'][1]['ident_num'] ?? null,
                            'ident_num3' => $allpandata['result']['identity_details']['identity'][2]['ident_num'] ?? null,
                            'ident_num4' => $allpandata['result']['identity_details']['identity'][3]['ident_num'] ?? null,
                            'idver_status1' => $allpandata['result']['identity_details']['identity'][0]['idver_status'] ?? null,
                            'idver_status2' => $allpandata['result']['identity_details']['identity'][1]['idver_status'] ?? null,
                            'idver_status3' => $allpandata['result']['identity_details']['identity'][2]['idver_status'] ?? null,
                            'idver_status4' => $allpandata['result']['identity_details']['identity'][3]['idver_status'] ?? null,
                            'created_at' => Carbon::now(),
                            'updated_at' => Carbon::now(),
                        ]);
                    }
                }
                return response()->json(['statusCode' => 200, 'response' => $searchkyc]);
            } elseif (isset($allpandata['status']) && $allpandata['status'] == 'INVALID') {
                if ($user->role_id == 1) {
                    $statusCode = 102;
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                    }
                    $panvalidation = DB::table('search_new')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'mobilenum' => $allpandata['result']['personal_details']['mob_num'] ?? null,
                        'status' => 102,
                        'pan_no' => $allpandata['result']['personal_details']['pan'] ?? null,
                        'created_at' => Carbon::now(),
                        'updated_at' => Carbon::now(),
                    ]);
                }
                $searchkyc['status'] = $allpandata['status'];
                $searchkyc['error'] = $allpandata['error'] ?? 'Invalid OTP';
                return response()->json(['statusCode' => 102, 'response' => $searchkyc]);
            } else {
                if ($user->role_id == 1) {
                    if ($apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction success.', 200);
                    }
                }
                $panvalidation = DB::table('search_new')->insert([
                    'user_id' => $user->id,
                    'api_id' => $api_id,
                    'mobilenum' => $allpandata['result']['personal_details']['mob_num'] ?? null,
                    'status' => 202,
                    'pan_no' => $allpandata['result']['personal_details']['pan'] ?? null,
                    'created_at' => Carbon::now(),
                    'updated_at' => Carbon::now(),
                ]);
                return response()->json(['statusCode' => 202, 'response' => $allpandata]);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
}


    public function voter_validation_new(Request $request)
    {
        $statusCode = null;
        $voter_validation = null;
        $api_id = null;

        if (empty($request->voter_number))
            return response()->json(array(['message' => 'Voter id number is required', 'statusCode' => '404']));

        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

        $user = User::where('access_token', $request->header('AccessToken'))->first();
        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'voter_id')->first();
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
        $headers = [
            'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
            'Referer' => 'http://regtechapi.in',
            'accept' => 'application/json',
        ];
        $client_ref_num = strval(rand(100, 999));

        $body = [
            'epic_number' => $request->voter_number,
            'client_ref_num'=>$client_ref_num
        ];
        // $token = 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpYXQiOjE2MDI3Njc0NDUsIm5iZiI6MTYwMjc2NzQ0NSwianRpIjoiNzRjNzRmNjMtNGZhNS00N2I0LTkxYmYtNjcyYjZiMmRjNzYyIiwiZXhwIjoxOTE4MTI3NDQ1LCJpZGVudGl0eSI6ImRldi5kb2Nib3l6QGZsb3dib2FyZC5pbiIsImZyZXNoIjpmYWxzZSwidHlwZSI6ImFjY2VzcyIsInVzZXJfY2xhaW1zIjp7InNjb3BlcyI6WyJyZWFkIl19fQ.2vNK9AhqCAk5Vz3K9rAZ_YtxIzTLoxK8zejh-ES4Meo';
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        if ($updateHitCount || $user->role_id == 0) {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0) {
                try {
                    // $res = $client->post($this->base_url.'/voter-id/voter-id', ['headers' => $headers, 'json' => $body,'form_params' => ['api_token' => $token]]);
                    $res = $client->post('https://svcdemo.digitap.work/validation/kyc/v1/voter', ['headers' => $headers, 'json' => $body]);
                    $voter_validation = json_decode($res->getBody(), true);
                    // return $voter_validation;
                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                       $votervalidation = DB::table('voter_verification')->insert([
                        "user_id" => $user->id,
                        "api_id" => $api_id,
                        "epic_no" => $voter_validation['result']['epic_no'] ?? null,
                        "gender" => $voter_validation['result']['gender'] ?? null,
                        "state" => $voter_validation['result']['st_name'] ?? null,
                        "name" => $voter_validation['result']['name'] ?? null,
                        "relation_name" => $voter_validation['result']['rln_name'] ?? null,
                        "relation_type" => $voter_validation['result']['rln_type'] ?? null,
                        "dob" => null, // not available in new response
                        "age" => $voter_validation['result']['age'] ?? null,
                        "area" => null, // not available in new response
                        "district" => $voter_validation['result']['dist_name'] ?? null,
                        "multiple" => $voter_validation['multiple_epic'] ?? null,
                        "last_update" => $voter_validation['result']['last_update'] ?? null,
                        "assembly_constituency" => $voter_validation['result']['ac_name'] ?? null,
                        "assembly_constituency_number" => $voter_validation['result']['ac_no'] ?? null,
                        "polling_station" => $voter_validation['result']['ps_name'] ?? null,
                        "part_number" => $voter_validation['result']['part_no'] ?? null,
                        "part_name" => $voter_validation['result']['part_name'] ?? null,
                        "slno_inpart" => $voter_validation['result']['slno_inpart'] ?? null,
                        "ps_lat_long" => $voter_validation['result']['ps_lat_long'] ?? null,
                        "rln_name_v1" => $voter_validation['result']['rln_name_v1'] ?? null,
                        "section_no" => $voter_validation['result']['section_no'] ?? null,
                        "st_code" => $voter_validation['result']['st_code'] ?? null,
                        "parliamentary_constituency" => $voter_validation['result']['pc_name'] ?? null,
                        "v_id" => $voter_validation['result']['id'] ?? null,
                        "created_at" => Carbon::now(),
                        "updated_at" => Carbon::now()
                    ]);

                    }
                } catch (BadResponseException $e) {
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($statusCode == 500) {
                        $errorMessage = 'Internal server error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                        }
                    } else if ($statusCode == 422) {
                        $statusCode = 102;
                        $errorMessage = 'Verification Failed. Please enter correct Voter ID.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    } else {
                        $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed', $statusCode);
                            }
                        }
                    }
                    return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please Recharage your plan.']);
            }
        } else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }

        return response()->json(array(['voter_validation' => $voter_validation, 'statusCode' => '200']));
    }


     public function storeContactDetails(Request $request)
    {
        // Validation
        $request->validate([
            'name'          => 'required|string|max:255',
            'email'         => 'required|email|max:255',
            'mobile_number' => 'required|string|max:15',
            'enquire_for'   => 'nullable|string|max:255',
            'message'       => 'nullable|string',
        ]);

        // Insert into DB
        DB::table('contact_us')->insert([
            'first_name'          => $request->name,
            'email'         => $request->email,
            'mobile_number' => $request->mobile_number,
            'enquire_for'   => $request->enquire_for,
            'message'       => $request->message,
            'created_at'    => now(),
            'updated_at'    => now(),
        ]);

      return response()->json([
            'success' => true,
            'message' => 'Contact enquiry saved successfully!',
        ], 201);
    }


    public function getAllExpiredUsers()
{
    // Get current date
    $currentDate = Carbon::now();

    // Get users whose last transaction timespan > timezone
    $users = User::select('users.*', 'latest_tx.created_at as last_transaction_date')
        ->leftJoin(DB::raw('(
            SELECT user_id, MAX(created_at) as created_at
            FROM user_transactions
            GROUP BY user_id
        ) as latest_tx'), 'users.id', '=', 'latest_tx.user_id')
        ->get()
        ->filter(function ($user) use ($currentDate) {
            if (!$user->last_transaction_date || !$user->timezone) {
                return false; // Skip if no transactions or no timezone value
            }
            $timespan = Carbon::parse($user->last_transaction_date)->diffInDays($currentDate);
            return $timespan > (int) $user->timezone;
        })
        ->values(); // reset array keys

     foreach ($users as $user) {
        // Check if access_token is NOT a 10-digit number (all digits, length=10)
        if (!preg_match('/^\d{10}$/', $user->access_token)) {
            $user->old_token = $user->access_token; // Backup old token
            $user->access_token = str_pad(mt_rand(0, 9999999999), 10, '0', STR_PAD_LEFT); // New 10-digit random number
            $user->status = 1;
            $user->save();
        }
    }

    // Return as JSON
    return response()->json([
        'status' => 'success',
        'count' => $users->count(),
        'data' => $users
    ]);
}




public function mobile_name_lookup(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    /* ---------------- API MASTER ---------------- */
//    return $user;
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'mobilenamelookup'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();
    // return    $updateHitCount;
    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'mobile'         => $request->mobile,
                    'client_ref_num' =>'test'
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/misc/v1/mobile-name-lookup',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );
                // return $response;
                $mobileData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();
                
                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($mobileData['result_code'] ?? 0) == 101) {

                    $result = $mobileData['result'] ?? [];

                    $mobile_lookup = [];
                    $mobile_lookup['data']['mobile']
                        = $request->mobile;
                    $mobile_lookup['data']['mobile_linked_name']
                        = $result['mobile_linked_name'] ?? null;
                    $mobile_lookup['data']['client_ref_num']
                        = $mobileData['client_ref_num'] ?? null;
                    $mobile_lookup['data']['request_id']
                        = $mobileData['request_id'] ?? null;
                    $mobile_lookup['data']['result_code']
                        = $mobileData['result_code'] ?? null;

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('mobile_name_lookup_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'mobile'             => $request->mobile,
                            'client_ref_num'     => $mobileData['client_ref_num'] ?? null,
                            'request_id'         => $mobileData['request_id'] ?? null,
                            'http_response_code' => $mobileData['http_response_code'] ?? null,
                            'result_code'        => $mobileData['result_code'] ?? null,
                            'mobile_linked_name' => $result['mobile_linked_name'] ?? null,
                            'vendor_response'    => json_encode($mobileData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Mobile name fetched successfully',
                        'data'       => $mobile_lookup['data']
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
    'statusCode' => 102,
    'message' => $mobileData['message'] ?? 'Mobile name lookup failed'
]);


            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Mobile name lookup failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}



public function udyamAuthenticationBasic(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    
    if (empty($request->udyam_reg_no)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Udyam Registration Number is required'
        ]);
    }

    if (!preg_match('/^(UDYAM-[A-Z]{2}-\d{2}-\d{7})$/', $request->udyam_reg_no)) {
        return response()->json([
            'statusCode' => 422,
            'message' => 'Invalid Udyam Registration Number format'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    
    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'udyambasic')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

 
    $body = [
        'client_ref_num' => uniqid('ref_'),
        'udyam_reg_no'   => $request->udyam_reg_no
    ];

  
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                
                $response = Http::withHeaders([
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Accept'        => 'application/json',
                    'Content-Type'  => 'application/json',
                ])->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/udyam_authentication/basic',
                    $body
                );

                $udyamData = $response->json() ?? [];
                $httpResponseCode = $udyamData['http_response_code'] ?? $response->status();

          
                if (
                    $httpResponseCode == 200 &&
                    ($udyamData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('udyam_authentication_logs')->insert([
                            'user_id'        => $user->id,
                            'api_id'         => $api_id,

                            'udyam_reg_no'   => $request->udyam_reg_no,
                            'client_ref_num' => $udyamData['client_ref_num'] ?? null,
                            'request_id'     => $udyamData['request_id'] ?? null,

                            'date_of_reg'    => $udyamData['result']['date_of_reg'] ?? null,
                            'gender'         => $udyamData['result']['gender'] ?? null,
                            'dob'            => $udyamData['result']['dob'] ?? null,

                            'district_industries_center' =>
                                $udyamData['result']['district_industries_center'] ?? null,

                            'msme_dfo'       => $udyamData['result']['msme_dfo'] ?? null,
                            'udyam_category' => $udyamData['result']['udyam_category'] ?? null,

                            'profile' =>
                                json_encode($udyamData['result']['profile'] ?? []),

                            'branch_details' =>
                                json_encode($udyamData['result']['branch_details'] ?? []),

                            'official_address' =>
                                json_encode($udyamData['result']['official_address'] ?? []),

                            'industry' =>
                                json_encode($udyamData['result']['industry'] ?? []),

                            'enterprise_type_history' =>
                                json_encode($udyamData['result']['enterprise_type_history'] ?? []),

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $udyamData['result_code'] ?? null,
                            'message'            => $udyamData['message'] ?? 'Success',

                            'vendor_response' =>
                                json_encode($udyamData, JSON_UNESCAPED_UNICODE),

                            'created_at' => now(),
                            'updated_at' => now(),
                        ]);
                    }

                    return response()->json($udyamData, 200);
                }

             
                $statusCode = 102;
                $errorMessage = $udyamData['message'] ?? 'Udyam authentication failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('udyam_authentication_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'udyam_reg_no'    => $request->udyam_reg_no,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($udyamData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);
                     DB::table('udyam_authentication_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'udyam_reg_no'    => $request->udyam_reg_no,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($udyamData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => 500,
                    'message' => 'Internal Server Error'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function emailAuthenticationBasic(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    // ---------- VALIDATION ----------
    if (empty($request->email_id)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Email ID is required'
        ]);
    }

    if (!filter_var($request->email_id, FILTER_VALIDATE_EMAIL)) {
        return response()->json([
            'statusCode' => 422,
            'message' => 'Invalid Email ID format'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    // ---------- USER ----------
    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', operator: 'emailbasic')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    // ---------- REQUEST BODY ----------
    $body = [
        'client_ref_num' => uniqid('ref_'),
        'email_id'       => $request->email_id
    ];

    // ---------- PLAN CHECK ----------
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        // ---------- WALLET / POSTPAID CHECK ----------
        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                // ---------- API CALL ----------
                $response = Http::withHeaders([
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Accept'        => 'application/json',
                    'Content-Type'  => 'application/json',
                ])->post(
                    'https://svcdemo.digitap.work/dp/email_check/v1/request',
                    $body
                );

                $emailData = $response->json() ?? [];
                $httpResponseCode = $emailData['http_response_code'] ?? $response->status();

                // ---------- SUCCESS ----------
                if (
                    $httpResponseCode == 200 &&
                    ($emailData['response']['code'] ?? 0) == 200
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('email_authentication_logs')->insert([
                            'user_id'        => $user->id,
                            'api_id'         => $api_id,

                            'email_id'       => $request->email_id,
                            'client_ref_num' => $emailData['response']['ref_num'] ?? null,
                            'request_id'     => $emailData['response']['request_id'] ?? null,

                            'is_valid'       => $emailData['response']['is_valid'] ?? null,
                            'domain'         => $emailData['response']['domain'] ?? null,
                            'mx_record'      => $emailData['response']['mx_record'] ?? null,
                            'smtp_check'     => $emailData['response']['smtp_check'] ?? null,

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $emailData['response']['code'] ?? null,
                            'message'            => $emailData['message'] ?? 'Success',

                            'vendor_response' =>
                                json_encode($emailData, JSON_UNESCAPED_UNICODE),

                            'created_at' => now(),
                            'updated_at' => now(),
                        ]);
                    }

                    return response()->json($emailData, 200);
                }

                // ---------- FAILED ----------
                $statusCode = 102;
                $errorMessage = $emailData['message'] ?? 'Email authentication failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('email_authentication_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'email_id'        => $request->email_id,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($emailData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);

                    DB::table('email_authentication_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'email_id'        => $request->email_id,
                        'result_code'     => 500,
                        'message'         => 'Internal Server Error',
                        'vendor_response' => $e->getResponse()->getBody()->getContents(),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => 500,
                    'message' => 'Internal Server Error'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}



public function sendEmailOtp(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->email)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Email ID is required'
        ]);
    }

    if (!filter_var($request->email, FILTER_VALIDATE_EMAIL)) {
        return response()->json([
            'statusCode' => 422,
            'message' => 'Invalid Email ID format'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

   
    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'emailotp')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {


        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

               
                $domain = substr(strrchr($request->email, "@"), 1);
                if (!checkdnsrr($domain, "MX")) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Invalid Email Domain', 422);
                    }

                    return response()->json([
                        'statusCode' => 422,
                        'message' => 'Email domain does not exist'
                    ]);
                }

                
                $otp = rand(100000, 999999);

                
                DB::table('email_otps')->where('email', $request->email)->delete();
                DB::table('email_otps')->insert([
                    'email'      => $request->email,
                    'otp'        => $otp,
                    'expires_at' => now()->addMinutes(5),
                    'created_at' => now(),
                    'updated_at' => now(),
                ]);

              
                $sesClient = new SesClient([
                    'version' => '2010-12-01',
                    'region'  => 'ap-south-1',
                    'credentials' => [
                        'key'    => env('AWS_ACCESS_KEY_ID'),
                        'secret' => env('AWS_SECRET_ACCESS_KEY'),
                    ],
                ]);

                $sesClient->sendEmail([
                    'Source' => 'info@docboyz.in',
                    'Destination' => [
                        'ToAddresses' => [$request->email],
                    ],
                    'Message' => [
                        'Subject' => [
                            'Data' => 'OTP Verification',
                            'Charset' => 'UTF-8',
                        ],
                        'Body' => [
                            'Text' => [
                                'Data' => "Your OTP is {$otp}. Valid for 5 minutes.",
                                'Charset' => 'UTF-8',
                            ],
                        ],
                    ],
                ]);
                if ($user->role_id == 1 && $apiamster) {
                    $this->saveHitCount($user->id, $api_id, 'OTP Sent Successfully', 200);

                    DB::table('email_otp_logs')->insert([
                        'user_id'     => $user->id,
                        'api_id'      => $api_id,
                        'email'       => $request->email,
                        'status_code' => 200,
                        'message'     => 'OTP Sent Successfully',
                        'created_at'  => now(),
                        'updated_at'  => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => 200,
                    'message' => 'OTP sent successfully'
                ]);

            } catch (BadResponseException $e) {

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);

                    DB::table('email_otp_logs')->insert([
                        'user_id'     => $user->id,
                        'api_id'      => $api_id,
                        'email'       => $request->email,
                        'status_code' => 500,
                        'message'     => 'Internal Server Error',
                        'vendor_response' => $e->getMessage(),
                        'created_at'  => now(),
                        'updated_at'  => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => 500,
                    'message' => 'Internal Server Error'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}



public function verifyEmailOtp(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    try {
        if (empty($request->email) || empty($request->otp)) {
            return response()->json([
                'statusCode' => 404,
                'message' => 'Email and OTP are required'
            ]);
        }

        if (!filter_var($request->email, FILTER_VALIDATE_EMAIL)) {
            return response()->json([
                'statusCode' => 422,
                'message' => 'Invalid Email ID format'
            ]);
        }

        if (!$request->headers->has('AccessToken')) {
            return response()->json([
                'statusCode' => 404,
                'message' => 'Header Access Token is required'
            ]);
        }

        if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
            return response()->json([
                'statusCode' => 403,
                'message' => 'Wrong Access Token'
            ]);
        }

      
        $user = User::where('access_token', $request->header('AccessToken'))->first();

        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'emailotpverify')->first();
            if ($apiamster) {
                $api_id = $apiamster->id;
            }
        }

       
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
            ->where('api_id', $api_id)
            ->latest()
            ->first();

        if (!($updateHitCount || $user->role_id == 0)) {
            return response()->json([
                'statusCode' => 103,
                'message' => 'You are not registered to use this service. Please update your plan.'
            ]);
        }

       
        if (
            !(
                ($user->wallet_amount > 0 && $user->role_id == 1) ||
                $user->role_id == 0 ||
                $user->type == 'role_postpaid'
            )
        ) {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

        
        $otpRecord = DB::table('email_otps')
            ->where('email', $request->email)
            ->latest()
            ->first();

        if (!$otpRecord) {
            return response()->json([
                'statusCode' => 404,
                'message' => 'OTP not found'
            ]);
        }

        if (now()->gt($otpRecord->expires_at)) {
            return response()->json([
                'statusCode' => 400,
                'message' => 'OTP expired'
            ]);
        }

        if ($otpRecord->otp != $request->otp) {
            return response()->json([
                'statusCode' => 400,
                'message' => 'Invalid OTP'
            ]);
        }

        DB::table('email_otps')->where('id', $otpRecord->id)->delete();

        if ($user->role_id == 1 && $apiamster) {
            $this->saveHitCount($user->id, $api_id, 'OTP Verified Successfully', 200);

            DB::table('email_otp_logs')->insert([
                'user_id'     => $user->id,
                'api_id'      => $api_id,
                'email'       => $request->email,
                'status_code' => 200,
                'message'     => 'OTP Verified Successfully',
                'created_at'  => now(),
                'updated_at'  => now(),
            ]);
        }

        return response()->json([
            'statusCode' => 200,
            'message' => 'Email verified successfully'
        ]);

    } catch (BadResponseException $e) {

        if ($user->role_id == 1 && $apiamster) {
            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 500);

            DB::table('email_otp_logs')->insert([
                'user_id'     => $user->id,
                'api_id'      => $api_id,
                'email'       => $request->email,
                'status_code' => 500,
                'message'     => 'Internal Server Error',
                'vendor_response' => $e->getMessage(),
                'created_at'  => now(),
                'updated_at'  => now(),
            ]);
        }

        return response()->json([
            'statusCode' => 500,
            'message' => 'Internal Server Error'
        ]);
    }
}
public function mobile_validation(Request $request)
    {
        $statusCode = null;
        $mobile_no = null;
        $api_id = null;
        if (empty($request->mobile))
            return response()->json(array(['message' => 'Mobile Number is required', 'statusCode' => '404']));
      
        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));
  
        $user = User::where('access_token', $request->header('AccessToken'))->first();
     




        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'mobile')->first();
            // return $apiamster;
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
    //    return'test';
        $headers = [
            'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
            'Accept'        => 'application/json',
            'Content-Type'  => 'application/json',
        ];
       $body = 
        [
            'client_ref_num'     => 'test',
            'mobile'              => $request->mobile,
            'requested_services' => 'flipkart,amazon,paytm,facebook,instagram,twitter,linkedin'
        ];
           
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // return $user->id;
        if ($updateHitCount || $user->role_id == 0) 
            {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid")
                 {
                try {
                    $response = $client->post('https://svcdemo.digitap.work/dp/mobile_check/v1/request', [
                        'headers' => $headers,
                        'json' => $body,
                    ]);
                    $mobile_no = json_decode($response->getBody(), true);
                    
                    if (isset($mobile_no['http_response_code']) && $mobile_no['http_response_code'] == 200) {

                    $mobile['data']['requestId'] = isset($mobile_no['request_id'])? $mobile_no['request_id']: null;

                    $mobile['data']['client_Ref_Num'] = isset($mobile_no['client_ref_num'])? $mobile_no['client_ref_num']: null;
                    // $email['data']['email'] = isset($request->email_id)? $request->email_id: null;

                    $mobile['data']['http_Response_Code'] = isset($mobile_no['http_response_code']) ? $mobile_no['http_response_code']: null;

                    $mobile['data']['message'] = isset($mobile_no['message'])? $mobile_no['message']: null;
                    if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                $mobilevalidation = DB::table('mobile_varification')->insert([
                                     'user_id'            => $user->id,
                                     'api_id'             => $api_id,
                                    //  'email_id'           => $request->email_id,
                                     'request_id'         => $mobile_no['request_id'] ?? null,
                                    'client_ref_num'     => $mobile_no['client_ref_num'] ?? 'test',
                                     'vender_status_code' => $mobile_no['http_response_code'],
                                      'status_code'        => 200,
                                       'message_code'       => 'success',
                                           'created_at'         => now(),
                                        'updated_at'         => now(),
                                ]);
                            }
                        }
                        return response()->json(['mobile' => $mobile]);

                   }
                    elseif ($mobile_no['status']['statusCode'] == 200 && $mobile_no['response']['code'] == 400) {
                        $statusCode = 102;
                        $errorMessage = 'No Records found!.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                               DB::table('mobile_varification')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    'vender_status_code' => isset($mobile_no['status']['statusCode']) ? $mobile_no['status']['statusCode'] : null,
                                    'vender_code' => isset($mobile_no['response']['code']) ? $mobile_no['response']['code'] : null,
                                    'status_code' => 102,
                                    // 'email_id'           => $request->email_id,
                                    'request_id'         => $mobile_no['request_id'] ?? null,
                                    'message_code' => "failed",
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } 
                    else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                DB::table('mobile_varification')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    
                                    'vender_code'        => null,
                                    'status_code' => 500,
                                    'message_code' => "failed",
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'Mobile Number InValid Please Enter Correct Mobile Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                DB::table('mobile_varification')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } 
                    else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                             DB::table('mobile_varification')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        }
            else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }
    
   
     public function pancard_validation_plus(Request $request)
    {
        $statusCode = null;
        // $pan= null;
        $api_id = null;

        if (empty($request->pan))
            return response()->json(array(['message' => 'PAN Number is required', 'statusCode' => '404']));
      
        if (!$request->headers->has('AccessToken'))
            return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

        $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
        if ($verifyAccessToken == false)
            return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));
         
        $user = User::where('access_token', $request->header('AccessToken'))->first();
       




        if ($user->role_id == 1) {
            $apiamster = ApiMaster::where('api_slug', 'panv')->first();
            // return $apiamster;
            if ($apiamster)
                $api_id = $apiamster->id;
        }

        $client = new Client();
    //    return'test';
        $headers = [
            'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
            'Accept'        => 'application/json',
            'Content-Type'  => 'application/json',
        ];
       $body = [
     
        'client_ref_num'     => 'test',
        'pan'         => $request->pan,
        
    ];
           
        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)->where('api_id', $api_id)->orderBy('id', 'desc')->first();
        // return $user->id;
        if ($updateHitCount || $user->role_id == 0) 
            {
            if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid")
                 {
                try {
                     $response = $client->post(
            'https://svcdemo.digitap.work/validation/kyc/v1/pan_details_plus',
            [
                'headers' => $headers,
                'json'    => $body
            ]
        );
                    $pan_num = json_decode($response->getBody()->getContents(), true);
                    
                           if (isset($pan_num['http_response_code']) && $pan_num['http_response_code'] == 200) {


              $pan = [];

$pan['data']['http_response_code'] = $pan_num['http_response_code'] ?? 200;
$pan['data']['result_code']        = $pan_num['result_code'] ?? null;
$pan['data']['request_id']         = $pan_num['request_id'] ?? null;
$pan['data']['client_ref_num']     = $pan_num['client_ref_num'] ?? ($request->client_ref_num ?? 'test');


$pan['data']['pan']                = $pan_num['result']['pan'] ?? null;
$pan['data']['pan_type']           = $pan_num['result']['pan_type'] ?? null;
$pan['data']['fullname']           = $pan_num['result']['fullname'] ?? null;
$pan['data']['first_name']         = $pan_num['result']['first_name'] ?? null;
$pan['data']['middle_name']        = $pan_num['result']['middle_name'] ?? null;
$pan['data']['last_name']          = $pan_num['result']['last_name'] ?? null;
$pan['data']['gender']             = $pan_num['result']['gender'] ?? null;
$pan['data']['dob']                = $pan_num['result']['dob'] ?? null;


$pan['data']['aadhaar_number']     = $pan_num['result']['aadhaar_number'] ?? null;
$pan['data']['aadhaar_linked']     = $pan_num['result']['aadhaar_linked'] ?? null;


$pan['data']['address']['building_name'] = $pan_num['result']['address']['building_name'] ?? null;
$pan['data']['address']['locality']      = $pan_num['result']['address']['locality'] ?? null;
$pan['data']['address']['street_name']   = $pan_num['result']['address']['street_name'] ?? null;
$pan['data']['address']['pincode']       = $pan_num['result']['address']['pincode'] ?? null;
$pan['data']['address']['city']          = $pan_num['result']['address']['city'] ?? null;
$pan['data']['address']['state']         = $pan_num['result']['address']['state'] ?? null;
$pan['data']['address']['country']       = $pan_num['result']['address']['country'] ?? null;


$pan['data']['mobile']             = $pan_num['result']['mobile'] ?? null;
$pan['data']['email']              = $pan_num['result']['email'] ?? null;


$pan['data']['signatory_details']  = $pan_num['result']['signatory_details'] ?? [];
$pan['data']['is_sole_proprietor'] = $pan_num['result']['is_sole_proprietor'] ?? null;
$pan['data']['is_director']        = $pan_num['result']['is_director'] ?? null;
$pan['data']['is_salaried']        = $pan_num['result']['is_salaried'] ?? null;
$pan['data']['pan_status']         = $pan_num['result']['pan_status'] ?? null;
$pan['data']['pan_allotment_date'] = $pan_num['result']['pan_allotment_date'] ?? null;

 if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                                $pandetailsplus = DB::table('pan_validation_plus')->insert([
                                'user_id' => $user->id ?? null,
    'api_id'  => $api_id ?? null,

    'pan' => $pan_num['result']['pan'] ?? $request->pan,

    'request_id'     => $pan_num['request_id'] ?? null,
    'client_ref_num' => $pan_num['client_ref_num'] ?? 'test',

    'http_response_code' => 200,
    'result_code'        => $pan_num['result_code'] ?? null,

    'pan_type'   => $pan_num['result']['pan_type'] ?? null,
    'fullname'   => $pan_num['result']['fullname'] ?? null,
    'first_name' => $pan_num['result']['first_name'] ?? null,
    'middle_name'=> $pan_num['result']['middle_name'] ?? null,
    'last_name'  => $pan_num['result']['last_name'] ?? null,
    'gender'     => $pan_num['result']['gender'] ?? null,
    'dob'        => $pan_num['result']['dob'] ?? null,

    'aadhaar_number' => $pan_num['result']['aadhaar_number'] ?? null,
    'aadhaar_linked' => $pan_num['result']['aadhaar_linked'] ?? null,

    'address_building_name' => $pan_num['result']['address']['building_name'] ?? null,
    'address_locality'      => $pan_num['result']['address']['locality'] ?? null,
    'address_street_name'   => $pan_num['result']['address']['street_name'] ?? null,
    'pincode'               => $pan_num['result']['address']['pincode'] ?? null,
    'city'                  => $pan_num['result']['address']['city'] ?? null,
    'state'                 => $pan_num['result']['address']['state'] ?? null,
    'country'               => $pan_num['result']['address']['country'] ?? null,

    'mobile' => $pan_num['result']['mobile'] ?? null,
    'email'  => $pan_num['result']['email'] ?? null,

    'vendor_response' => json_encode($pan_num),

    'created_at' => now(),
    'updated_at' => now(),
                                ]);
                            }
                        }
                       return response()->json($pan, 200);

                   }
                    elseif ($pan_num['status']['statusCode'] == 200 && $pan_num['response']['code'] == 400) {
                        $statusCode = 102;
                        $errorMessage = 'No Records found!.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $pandetails = DB::table('pan_validation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    'vender_status_code' => isset($email_id['status']['statusCode']) ? $pan_num['status']['statusCode'] : null,
                                    'vender_code' => isset($email_id['response']['code']) ? $pan_num['response']['code'] : null,
                                    'status_code' => 102,
                                     'pan' => $pan_num['result']['pan'] ?? $request->pan,
                                    'request_id'         => $mobile_num['request_id'] ?? null,
                                    'message_code' => "failed",
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } 
                    else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $pandetails = DB::table('pan_validation')->insert([
                                    "user_id" => $user->id,
                                    "api_id" => $api_id,
                                    
                                    'vender_code'        => null,
                                    'status_code' => 500,
                                    'message_code' => "failed",
                                    "created_at" => Carbon::now(),
                                    "updated_at" => Carbon::now()
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                } catch (BadResponseException $e) {
                    $response = $e->getResponse();
                    $errorResponse = json_decode($response->getBody(), true);
                    $statusCode = $e->getResponse()->getStatusCode();
                    if ($errorResponse['status']['statusCode'] == 400 && $errorResponse['error']['code'] == 'E0010002') {
                        $statusCode = 102;
                        $errorMessage = 'PAN Number InValid Please Enter Correct Mobile Number.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);
                                $pandetails = DB::table('pan_validation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 102,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    } 
                    else {
                        $statusCode = 500;
                        $errorMessage = 'Internal Server Error.';
                        if ($user->role_id == 1) {
                            if ($apiamster) {
                                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);
                                $pandetails = DB::table('pan_validation')->insert([
                                    'user_id' => $user->id,
                                    'api_id' => $api_id,
                                    
                                    'vender_status_code' => isset($errorResponse['status']['statusCode']) ? $errorResponse['status']['statusCode'] : null,
                                    'vender_code' => isset($errorResponse['error']['code']) ? $errorResponse['error']['code'] : null,
                                    'status_code' => 500,
                                    'message_code' => 'failed',
                                    'created_at' => Carbon::now(),
                                    'updated_at' => Carbon::now(),
                                ]);
                            }
                        }
                        return response()->json(['statusCode' => $statusCode, 'message' => $errorMessage]);
                    }
                }
            } else {
                return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
            }
        }
            else {
            return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service. Please update your plan.']);
        }
    }

public function pandetails_v4(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    
    if (empty($request->pan)) {
        return response()->json([
            ['message' => 'PAN Number is required', 'statusCode' => 404]
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            ['message' => 'Header Access Token is required', 'statusCode' => 404]
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            ['message' => 'Wrong Access Token', 'statusCode' => 403]
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'panv')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
        'Accept'        => 'application/json',
        'Content-Type'  => 'application/json',
    ];

    $body = [
        'client_ref_num' => 'test',
        'pan' => $request->pan,
    ];

    

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

            
                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyc/v4/pan_details/request',
                    ['headers' => $headers, 'json' => $body]
                );

                $panData = json_decode($response->getBody()->getContents(), true);

                if (($panData['http_response_code'] ?? null) == 200) {

                    sleep(1);

                   
                    $statusResponse = $client->post(
                        'https://svcdemo.digitap.work/validation/kyc/v4/pan_details/status',
                        [
                            'headers' => $headers,
                            'json' => ['request_id' => $panData['request_id']]
                        ]
                    );
                      
                    $statusData = json_decode($statusResponse->getBody()->getContents(), true);
                   
                    if (($statusData['api_status'] ?? '') === 'Completed') {

                        if ($user->role_id == 1 && $apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                            DB::table('pan_detail')->insert([
                                'user_id' => $user->id,
                                'api_id'  => $api_id,
                                'pan' => $statusData['result']['pan'] ?? $request->pan,
                                'request_id' => $panData['request_id'] ?? null,
                                'client_ref_num' => $panData['client_ref_num'] ?? 'test',
                                'http_response_code' => 200,
                                'result_code' => $panData['result_code'] ?? 101,

                                'pan_status'     => $statusData['result']['pan_status'] ?? null,
                                'pan_type'       => $statusData['result']['pan_type'] ?? null,
                                'father_name'    => $statusData['result']['father_name'] ?? null,
                                'gender'         => $statusData['result']['gender'] ?? null,
                                'aadhaar_number' => $statusData['result']['aadhaar_number'] ?? null,
                                'aadhaar_linked' => $statusData['result']['aadhaar_linked'] ?? null,

                                'address_building_name' => $statusData['result']['address']['building_name'] ?? null,
                                'address_locality'      => $statusData['result']['address']['locality'] ?? null,
                                'address_street_name'   => $statusData['result']['address']['street_name'] ?? null,
                                'pincode'               => $statusData['result']['address']['pincode'] ?? null,
                                'city'                  => $statusData['result']['address']['city'] ?? null,
                                'state'                 => $statusData['result']['address']['state'] ?? null,
                                'country'               => $statusData['result']['address']['country'] ?? 'India',

                                'mobile' => $statusData['result']['mobile'] ?? null,
                                'email'  => $statusData['result']['email'] ?? null,

                                'created_at' => now(),
                                'updated_at' => now(),
                            ]);
                        }

                        return response()->json([
                            'http_response_code' => 200,
                            'result_code'        => $panData['result_code'] ?? 101,
                            'request_id'         => $panData['request_id'] ?? null,
                            'client_ref_num'     => $panData['client_ref_num'] ?? 'Demo_24_03_2025',
                            'api_status'         => 'Completed',
                            'result'             => $statusData['result']
                        ], 200);
                    }

                   
                    if (($statusData['api_status'] ?? '') === 'In-Progress') {
                        return response()->json([
                            'statusCode' => 104,
                            'message' => 'PAN verification is in progress. Please retry after some time.'
                        ]);
                    }

               
                    $statusCode = 102;
                    $errorMessage = 'PAN validation failed';

                    if ($user->role_id == 1 && $apiamster) {
                        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                        DB::table('pan_detail')->insert([
                            'user_id'      => $user->id,
                            'api_id'       => $api_id,
                            'pan'          => $request->pan,
                            'result_code'  => $statusCode,
                            'message_code' => 'failed',
                            'status_code'  => $statusCode,
                            'created_at'   => now(),
                            'updated_at'   => now(),
                        ]);
                    }

                    return response()->json([
                        'statusCode' => $statusCode,
                        'message'    => $errorMessage
                    ]);
                }

            } catch (BadResponseException $e) {

          
                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = 'PAN validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_detail')->insert([
                        'user_id'      => $user->id,
                        'api_id'       => $api_id,
                        'pan'          => $request->pan,
                        'result_code'  => $statusCode,
                        'message_code' => 'failed',
                        'status_code'  => $statusCode,
                        'created_at'   => now(),
                        'updated_at'   => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}





public function dl_validation(Request $request)
{
     $statusCode = null;
        // $pancard = null;
        $api_id = null;
        $apiamster = null;
    // return 'testok';
    if (empty($request->dlno)) 
        return response()->json([
            'statusCode' => 404,
            'message' => 'Driving Licence Number is required'
        ]);

    if (empty($request->mobileNumber)) {
    return response()->json([
        'statusCode' => 400,
        'message' => 'Mobile Number is required'
    ]);
}


    if (!$request->headers->has('AccessToken'))
        return response()->json(array(['message' => 'Header Access Token is required', 'statusCode' => '404']));

    $verifyAccessToken = $this->verifyAccessToken($request->header('AccessToken'));
    if ($verifyAccessToken == false)
        return response()->json(array(['message' => 'Wrong Access Token', 'statusCode' => '403']));

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'dl')->first();
        if ($apiamster)
            $api_id = $apiamster->id;
    }
    //  return $api_id;

    $client = new Client();
        $headers = [
    'Content-Type' => 'application/json',
];


   $body = [
    'dlno'         => $request->dlno,
    'mobileNumber' => $request->mobileNumber,

    'recordId' => '49473123',
    'deviceId' => 'p38e0od88a649e62',
     'token'    => 'x*RRrjfC44RxWCl2',
];

       
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

            try {

                $response = $client->post('http://13.234.112.106:8080/api/dl-details', [
                    
                'headers' => $headers,
                'json'    => $body
            
                ]);

                $dlData = json_decode($response->getBody(), true);

                if (isset($dlData['errorcd']) && $dlData['errorcd'] == 1) {

                    if ($user->role_id == 1) {
                        if ($apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                            DB::table('dl_validation_responses')->insert([
                                'errorcd' => $dlData['errorcd'] ?? null,
                                'db_loc'  => $dlData['dbLoc'] ?? null,
                                'dl_lic_no' => $dlData['dlobj']['dlLicno'] ?? null,
                                'dl_status' => $dlData['dlobj']['dlStatus'] ?? null,
                                'dl_applno' => $dlData['dlobj']['dlApplno'] ?? null,
                                'dl_issued_date' => $dlData['dlobj']['dlIssuedt'] ?? null,
                                'dl_valid_from'  => $dlData['dlobj']['dlNtValdfrDt'] ?? null,
                                'dl_valid_to'    => $dlData['dlobj']['dlNtValdtoDt'] ?? null,
                                'bio_id' => $dlData['bioObj']['bioBioId'] ?? null,
                                'bio_first_name' => $dlData['bioObj']['bioFirstName'] ?? null,
                                'bio_last_name'  => $dlData['bioObj']['bioLastName'] ?? null,
                                'bio_full_name'  => $dlData['bioObj']['bioFullName'] ?? null,
                                'dlcovs' => json_encode($dlData['dlcovs'] ?? []),
                                'bio_photo' => $dlData['bioImgObj']['biPhoto'] ?? null,
                                'bio_signature' => $dlData['bioImgObj']['biSignature'] ?? null,
                                'raw_response' => json_encode($dlData)
                            ]);
                        }
                    }

                    return response()->json($dlData, 200);

                } elseif (isset($dlData['errorcd']) && $dlData['errorcd'] == 0) {

                    $statusCode = 102;
                    $errorMessage = 'No Records found!';

                    if ($user->role_id == 1) {
                        if ($apiamster) {

                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);

                            DB::table('dl_validation_responses')->insert([
                                'user_id' => $user->id ?? null,
                                'api_id'  => $api_id ?? null,
                                'vendor_status_code' => 200,
                                'vendor_code' => $dlData['errorcd'],
                                'status_code' => 102,
                                'message_code' => 'failed',
                                'dl_lic_no' => $request->dlno,
                                'raw_response' => json_encode($dlData),
                                'created_at' => now(),
                                'updated_at' => now()
                            ]);
                        }
                    }

                    return response()->json([
                        'statusCode' => $statusCode,
                        'message' => $errorMessage
                    ]);
                }

            } catch (BadResponseException $e) {

                $response = $e->getResponse();
                $errorResponse = json_decode($response->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();

                if (
                    isset($errorResponse['status']['statusCode']) &&
                    $errorResponse['status']['statusCode'] == 400 &&
                    isset($errorResponse['error']['code']) &&
                    $errorResponse['error']['code'] == 'DL0010002'
                ) {

                    $statusCode = 102;
                    $errorMessage = 'Invalid Driving Licence Number. Please enter correct DL number.';

                    if ($user->role_id == 1) {
                        if ($apiamster) {

                            $this->saveHitCount($user->id, $api_id, 'Transaction Failed.', 102);

                            DB::table('dl_validation_responses')->insert([
                                'user_id' => $user->id ?? null,
                                'api_id'  => $api_id ?? null,
                                'vendor_status_code' => $errorResponse['status']['statusCode'] ?? null,
                                'vendor_code' => $errorResponse['error']['code'] ?? null,
                                'status_code'  => 102,
                                'message_code' => 'failed',
                                'dl_lic_no' => $request->dlno ?? null,
                                'raw_response' => json_encode($errorResponse),
                                'created_at' => now(),
                                'updated_at' => now()
                            ]);
                        }
                    }

                    return response()->json([
                        'statusCode' => $statusCode,
                        'message' => $errorMessage
                    ]);

                } else {

                    $statusCode = 500;
                    $errorMessage = 'Internal Server Error.';

                    if ($user->role_id == 1) {
                        if ($apiamster) {

                            $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);

                            DB::table('dl_validation_responses')->insert([
                                'user_id' => $user->id ?? null,
                                'api_id'  => $api_id ?? null,
                                'vendor_status_code' => $errorResponse['status']['statusCode'] ?? null,
                                'vendor_code' => $errorResponse['error']['code'] ?? null,
                                'status_code' => 102,
                                'message_code' => 'failed',
                                'dl_lic_no' => $request->dlno ?? null,
                                'raw_response' => json_encode($errorResponse),
                                'created_at' => now(),
                                'updated_at' => now()
                            ]);
                        }
                    }

                    return response()->json([
                        'statusCode' => $statusCode,
                        'message' => $errorMessage
                    ]);
                }
            }

        }
         else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function rc_validate(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->rcNumber)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'RC Number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'rcno')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type' => 'application/json',
        'accessToken'=> 'f1c6ae1659db120c18fa6ff44028addb:ca07ac27c44b0a01b9bf501c687b479d'
    ];

    $body = [
        'rcNumber' => $request->rcNumber
    ];

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

            try {

                $response = $client->post(
                    'https://core.kashidigitalapis.com/v1/rc-premium',
                    [
                        'headers' => $headers,
                        'json' => $body
                    ]
                );

                $rcData = json_decode($response->getBody(), true);

                if (isset($rcData['statusCode']) && $rcData['statusCode'] == 200) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('rc_validation_responses')->insert([
                             'user_id' => $user->id ?? null,
    'api_id'  => $api_id ?? null,

    'status_code' => $rcData['statusCode'],
    'message' => $rcData['message'],
    'request_id' => $rcData['requestId'],

    'rc_number' => $rcData['result']['registration']['number'],
    'registering_authority' => $rcData['result']['registration']['authority'],
    'registration_date' => $rcData['result']['registration']['date'],
    'expiry_date' => $rcData['result']['registration']['expiryDate'],
    'owner_count' => $rcData['result']['registration']['ownerCount'],

    'owner_name' => $rcData['result']['registration']['owner']['name'],
    'father_name' => $rcData['result']['registration']['owner']['fatherName'],
    'mobile_number' => $rcData['result']['registration']['owner']['mobileNumber'],
    'present_address' => $rcData['result']['registration']['owner']['presentAddress'],
    'permanent_address' => $rcData['result']['registration']['owner']['permanentAddress'],
    'ownership_type' => $rcData['result']['registration']['owner']['ownershipType'],

    'rc_status' => $rcData['result']['registration']['status']['active'],
    'rc_updated_on' => $rcData['result']['registration']['status']['updatedOn'],

    'vehicle_class' => $rcData['result']['vehicle']['class'],
    'manufacturer' => $rcData['result']['vehicle']['manufacturer'],
    'model' => $rcData['result']['vehicle']['model'],
    'color' => $rcData['result']['vehicle']['color'],
    'fuel_type' => $rcData['result']['vehicle']['fuelType'],
    'norms_type' => $rcData['result']['vehicle']['normsType'],
    'chassis_no' => $rcData['result']['vehicle']['chassis'],
    'engine_no' => $rcData['result']['vehicle']['engine'],
    'manufacturing_year' => $rcData['result']['vehicle']['manufacturingYear'],
    'cubic_capacity' => $rcData['result']['vehicle']['cubicCapacity'],
    'gross_weight' => $rcData['result']['vehicle']['grossWeight'],
    'unladen_weight' => $rcData['result']['vehicle']['unladenWeight'],
    'wheelbase' => $rcData['result']['vehicle']['wheelbase'],
    'cylinders' => $rcData['result']['vehicle']['cylinders'],
    'seat_capacity' => $rcData['result']['vehicle']['seatCapacity'],
    'body_type' => $rcData['result']['vehicle']['bodyType'],
    'category' => $rcData['result']['vehicle']['category'],
    'is_commercial' => $rcData['result']['vehicle']['isCommercial'],
    'fitness_upto' => $rcData['result']['vehicle']['fitnessUpTo'],
    'tax_upto' => $rcData['result']['vehicle']['taxUpTo'],
    'bhp' => $rcData['result']['vehicle']['bhp'],

    'insurance_company' => $rcData['result']['insurance']['company'],
    'insurance_expiry' => $rcData['result']['insurance']['expiryDate'],
    'policy_number' => $rcData['result']['insurance']['policyNumber'],

    'puc_number' => $rcData['result']['pollutionControl']['certificateNumber'],
    'puc_valid_upto' => $rcData['result']['pollutionControl']['validUpto'],

    'blacklist_status' => $rcData['result']['blacklist']['status'],
    'blacklist_details' => $rcData['result']['blacklist']['details'],

    'is_financed' => $rcData['result']['finance']['isFinanced'],
    'financer' => $rcData['result']['finance']['rcFinancer'],

    'partial_data' => $rcData['result']['additionalFlags']['partialData'],
    'db_result' => $rcData['result']['additionalFlags']['dbResult'],

   
                        ]);
                    }

                    return response()->json($rcData, 200);
                }

                // RC NOT FOUND / FAILED
                $statusCode = 102;
                $errorMessage = $rcData['message'] ?? 'No Records found!';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed.', $statusCode);

                    DB::table('rc_validation_responses')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'status_code' => $statusCode,
                        'message' => $errorMessage,
                        'rc_number' => $request->rcNumber,
                        'raw_response' => json_encode($rcData),
                        'created_at' => now(),
                        'updated_at' => now()
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();

                $errorMessage = $errorResponse['message'] ?? 'RC validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('rc_validation_responses')->insert([
                        'user_id' => $user->id,
                        'api_id' => $api_id,
                        'status_code' => $statusCode,
                        'message' => $errorMessage,
                        'rc_number' => $request->rcNumber,
                        'raw_response' => json_encode($errorResponse),
                        'created_at' => now(),
                        'updated_at' => now()
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (RequestException $e) {

                return response()->json([
                    'statusCode' => 500,
                    'message' => 'RC API is not reachable'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function pancard_validation(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;
    

    $pan = strtoupper(trim($request->pan));

    // ---------- VALIDATION ----------
    if (empty($pan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'PAN Number is required'
        ]);
    }

    if (!preg_match('/^[A-Z]{5}[0-9]{4}[A-Z]$/', $pan)) {
        return response()->json([
            'statusCode' => 400,
            'message' => 'Invalid PAN format'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'panvalidate')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => 'test',
        'pan'            => $pan
    ];

    // ---------- PLAN CHECK ----------
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyc/v1/pan_details',
                    [
                        'headers' => $headers,
                        'json'    => $body
                    ]
                );

                $panData = json_decode($response->getBody(), true);

                // ---------- SUCCESS ----------
                if (isset($panData['http_response_code']) && $panData['http_response_code'] == 200) {

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('pan_details')->insert([
                            'user_id' => $user->id,
                            'api_id'  => $api_id,

                            'http_response_code' => 200,
                            'result_code'        => $panData['result_code'] ?? null,

                            'message'        => $panData['message'] ?? 'Success',
                            'request_id'     => $panData['request_id'] ?? null,
                            'client_ref_num' => $panData['client_ref_num'] ?? 'test',

                            'pan'        => $panData['result']['pan'] ?? $pan,
                            'pan_type'   => $panData['result']['pan_type'] ?? null,
                            'fullname'   => $panData['result']['fullname'] ?? null,
                            'first_name' => $panData['result']['first_name'] ?? null,
                            'middle_name'=> $panData['result']['middle_name'] ?? null,
                            'last_name'  => $panData['result']['last_name'] ?? null,
                            'gender'     => $panData['result']['gender'] ?? null,

                            'dob' => !empty($panData['result']['dob'])
                                ? date('Y-m-d', strtotime($panData['result']['dob']))
                                : null,

                            'aadhaar_number' => $panData['result']['aadhaar_number'] ?? null,
                            'aadhaar_linked' => $panData['result']['aadhaar_linked'] ?? null,

                            'address_building_name' => $panData['result']['address']['building_name'] ?? null,
                            'address_locality'      => $panData['result']['address']['locality'] ?? null,
                            'address_street_name'   => $panData['result']['address']['street_name'] ?? null,
                            'pincode'               => $panData['result']['address']['pincode'] ?? null,
                            'city'                  => $panData['result']['address']['city'] ?? null,
                            'state'                 => $panData['result']['address']['state'] ?? null,
                            'country'               => $panData['result']['address']['country'] ?? null,

                            'mobile' => $panData['result']['mobile'] ?? null,
                            'email'  => $panData['result']['email'] ?? null,

                            'vendor_response' => json_encode($panData),

                            'created_at' => now(),
                            'updated_at' => now(),
                        ]);
                    }

                    return response()->json($panData, 200);
                }

                // ---------- FAILED ----------
                $statusCode = 102;
                $errorMessage = $panData['message'] ?? 'No Records found!';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_details')->insert([
                        'user_id' => $user->id,
                        'api_id'  => $api_id,
                        'status_code' => $statusCode,
                        'message_code' => 'failed',
                        'pan' => $pan,
                        'vendor_response' => json_encode($panData),
                        'created_at' => now(),
                        'updated_at' => now()
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();

                $errorMessage = $errorResponse['message'] ?? 'PAN validation failed';

                if ($user->role_id == 1 && $apiamster) {

                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_details')->insert([
                        'user_id' => $user->id,
                        'api_id'  => $api_id,
                        'status_code' => $statusCode,
                        'message_code' => 'failed',
                        'pan' => $pan,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at' => now(),
                        'updated_at' => now()
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function epfo_ev(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    $request->validate([
        'employee_name' => 'required|string',
        'employer_name' => 'required|string',
    ]);

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'epfoev')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => 'test',
        'employee_name'  => $request->employee_name,
        'employer_name'  => $request->employer_name
    ];

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1)
            || $user->role_id == 0
            || $user->type == "role_postpaid") {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v1/employee_name_search/request',
                    [
                        'headers' => $headers,
                        'json'    => $body
                    ]
                );

                $epfoData = json_decode($response->getBody(), true);

                if (!isset($epfoData['request_id'])) {
                    return response()->json([
                        'statusCode' => 500,
                        'message' => 'EPFO initial request failed',
                        'response' => $epfoData
                    ]);
                }

                $requestId = $epfoData['request_id'];

                for ($i = 0; $i < 5; $i++) {
                    sleep(2);

                    $statusResponse = $client->post(
                        'https://svcdemo.digitap.work/cv/v1/employee_name_search/status',
                        [
                            'headers' => $headers,
                            'json' => ['request_id' => $requestId]
                        ]
                    );

                    $finalData = json_decode($statusResponse->getBody(), true);
                    $statusCode = $statusResponse->getStatusCode();

                   
                    if (
                        isset($finalData['http_response_code']) &&
                        $finalData['http_response_code'] == 200
                    ) {
                        if ($user->role_id == 1 && $apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                            DB::table('epfo')->insert([
                                'user_id'            => $user->id,
                                'api_id'             => $api_id,
                                'http_response_code' => 200,
                                'message'            => $finalData['message'] ?? null,
                                'request_id'         => $requestId,
                                'client_ref_num'     => $epfoData['client_ref_num'] ?? null,
                                'employee_name'      => $request->employee_name,
                                'employer_name'      => $request->employer_name,
                                'vendor_response'    => json_encode($finalData),
                                'updated_at'         => now(),
                            ]);
                        }

                        return response()->json([
                            'statusCode' => 200,
                            'message'    => 'EPFO data fetched successfully',
                            'data'       => $finalData
                        ]);
                    }
                }

                $statusCode = 102;
                $errorMessage = $epfoData['message'] ?? 'No records found';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['error'] ?? 'EPFO validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('epfo')->insert([
                        'user_id'            => $user->id,
                        'api_id'             => $api_id,
                        'http_response_code' => $statusCode,
                        'message'            => $errorMessage,
                        'employee_name'      => $request->employee_name,
                        'employer_name'      => $request->employer_name,
                        'vendor_response'    => json_encode($errorResponse),
                        'created_at'         => now(),
                        'updated_at'         => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function upi_basic(Request $request)
{ 
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->vpa)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'VPA is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'upibasic')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => uniqid('ref_'),
        'vpa'            => $request->vpa,
    ];

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/bank/v1/upi-basic',
                    [
                        'headers' => $headers,
                        'json'    => $body
                    ]
                );

                $upiData = json_decode($response->getBody(), true);

                
                $httpResponseCode = $upiData['http_response_code'] ?? $response->getStatusCode();

            
                if (
                    $httpResponseCode == 200 &&
                    ($upiData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('upi_basic_validations')->insert([
                            'user_id'             => $user->id,
                            'api_id'              => $api_id,

                            'http_response_code'  => $httpResponseCode,
                            'result_code'         => $upiData['result_code'] ?? null,
                            'message'             => $upiData['message'] ?? 'Success',

                            'request_id'          => $upiData['request_id'] ?? null,
                            'client_ref_num'      => $upiData['client_ref_num'] ?? null,

                            'vpa'                 => $upiData['result']['vpa_details']['vpa'] ?? null,
                            'account_holder_name' => $upiData['result']['vpa_details']['account_holder_name'] ?? null,

                            'vendor_response'     => json_encode($upiData),
                            'created_at'          => now(),
                            'updated_at'          => now(),
                        ]);
                    }

                    return response()->json($upiData, 200);
                }

                $statusCode = 102;
                $errorMessage = $upiData['message'] ?? 'UPI validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('upi_basic_validations')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($upiData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'UPI validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('upi_basic_validations')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function upi_basic_name(Request $request)
{ 
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   
    if (empty($request->vpa) || empty($request->name)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'VPA and Name are required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'upinamematch')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => uniqid('ref_'),
        'vpa'            => $request->vpa,
        'name'           => $request->name
    ];


        $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

            try {

                
                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/bank/v1/upi-basic',
                    [
                        'headers'         => $headers,
                        'json'            => $body
                       
                    ]
                );

                $upiData = json_decode($response->getBody(), true);

                $httpResponseCode = $upiData['http_response_code'] ?? $response->getStatusCode();

                
                if (
                    $httpResponseCode == 200 &&
                    ($upiData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('upi_basic_name')->insert([
                            'user_id'             => $user->id,
                            'api_id'              => $api_id,

                            'http_response_code'  => $httpResponseCode,
                            'result_code'         => $upiData['result_code'] ?? null,
                            'message'             => $upiData['message'] ?? 'Success',

                            'request_id'          => $upiData['request_id'] ?? null,
                            'client_ref_num'      => $upiData['client_ref_num'] ?? null,

                            'vpa'                 => $upiData['result']['vpa_details']['vpa'] ?? null,
                            'account_holder_name' => $upiData['result']['vpa_details']['account_holder_name'] ?? null,

                           
                            'name_match'          => $upiData['result']['name_match'] ?? null,
                            'name_match_score'    => $upiData['result']['name_match_score'] ?? null,

                            'vendor_response'     => json_encode($upiData),
                            'created_at'          => now(),
                            'updated_at'          => now(),
                        ]);
                    }

                    return response()->json($upiData, 200);
                }

        
                $statusCode = 102;
                $errorMessage = $upiData['message'] ?? 'UPI validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('upi_basic_name')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($upiData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'UPI validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('upi_basic_name')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function gstin_authentication(Request $request)
{ 

    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->gstin)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'GSTIN is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'gstinauth')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => uniqid('ref_'),
        'gstin'          => $request->gstin
    ];

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

            try {

              $response = $client->post(
    'https://svcdemo.digitap.work/validation/kyb/v1/gst',
    [
        'headers' => $headers,
        'json'    => $body,
       
    ]
);


                $upiData = json_decode($response->getBody(), true);

                $httpResponseCode = $upiData['http_response_code'] ?? $response->getStatusCode();

                if ($httpResponseCode == 200 && ($upiData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('gstin_authentication')->insert([
                            'user_id'    => $user->id,
                            'api_id'     => $api_id,
                            'gstin'      => $request->gstin,

                            'legal_name' =>
                                $upiData['result']['taxpayerDetails']['lgnm'] ?? null,
                            'trade_name' =>
                                $upiData['result']['taxpayerDetails']['tradeNam'] ?? null,
                            'gst_status' =>
                                $upiData['result']['taxpayerDetails']['sts'] ?? null,
                            'taxpayer_type' =>
                                $upiData['result']['taxpayerDetails']['dty'] ?? null,
                            'constitution_of_business' =>
                                $upiData['result']['taxpayerDetails']['ctb'] ?? null,

                            'registration_date' =>
                                !empty($upiData['result']['taxpayerDetails']['rgdt'])
                                    ? date('Y-m-d', strtotime($upiData['result']['taxpayerDetails']['rgdt']))
                                    : null,

                            'aadhaar_verified' =>
                                $upiData['result']['taxpayerDetails']['adhrVFlag'] ?? null,
                            'ekyc_status' =>
                                $upiData['result']['taxpayerDetails']['ekycVFlag'] ?? null,
                            'einvoice_status' =>
                                $upiData['result']['taxpayerDetails']['einvoiceStatus'] ?? null,

                            'state_jurisdiction' =>
                                $upiData['result']['taxpayerDetails']['stj'] ?? null,
                            'central_jurisdiction' =>
                                $upiData['result']['taxpayerDetails']['ctj'] ?? null,
                            'principal_address' =>
                                $upiData['result']['taxpayerDetails']['pradr']['adr'] ?? null,

                            'nature_of_business' =>
                                json_encode($upiData['result']['taxpayerDetails']['nba'] ?? []),

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $upiData['result_code'] ?? null,
                            'message'            => $upiData['message'] ?? 'Success',
                            'request_id'         => $upiData['request_id'] ?? null,
                            'client_ref_num'     => $upiData['client_ref_num'] ?? null,

                            'vendor_response' =>
                                json_encode($upiData, JSON_UNESCAPED_UNICODE),

                            'created_at' => now(),
                            'updated_at' => now(),
                        ]);
                    }

                    return response()->json($upiData, 200);
                }

                $statusCode = 102;
                $errorMessage = $upiData['message'] ?? 'GSTIN validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('gstin_authentication')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'gstin'           => $request->gstin,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($upiData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'GSTIN validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('gstin_authentication')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'gstin'           => $request->gstin,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function gstin_advanced(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    // ---------- VALIDATION ----------
    if (empty($request->gstin)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'GSTIN is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'gstinadvanced')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => uniqid('ref_'),
        'gstin'          => $request->gstin
    ];

    // ---------- PLAN CHECK (SAME AS REFERENCE) ----------
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        // ---------- WALLET / POSTPAID CHECK ----------
        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/gstadvanced',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $gstData = json_decode($response->getBody(), true);
                $httpResponseCode = $gstData['http_response_code'] ?? $response->getStatusCode();

                // ---------- SUCCESS ----------
                if ($httpResponseCode == 200 && ($gstData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('gstin_advanced')->insert([
                            'user_id'        => $user->id,
                            'api_id'         => $api_id,
                            'gstin'          => $request->gstin,

                            'legal_name'     => $gstData['result']['taxpayerDetails']['lgnm'] ?? null,
                            'trade_name'     => $gstData['result']['taxpayerDetails']['tradeNam'] ?? null,
                            'gst_status'     => $gstData['result']['taxpayerDetails']['sts'] ?? null,
                            'constitution'  => $gstData['result']['taxpayerDetails']['ctb'] ?? null,
                            'taxpayer_type'  => $gstData['result']['taxpayerDetails']['dty'] ?? null,

                            'registration_date' =>
                                !empty($gstData['result']['taxpayerDetails']['rgdt'])
                                    ? date('Y-m-d', strtotime($gstData['result']['taxpayerDetails']['rgdt']))
                                    : null,

                            'einvoice_status' => $gstData['result']['taxpayerDetails']['einvoiceStatus'] ?? null,
                            'aadhaar_verified'=> $gstData['result']['taxpayerDetails']['adhrVFlag'] ?? null,
                            'ekyc_status'     => $gstData['result']['taxpayerDetails']['ekycVFlag'] ?? null,

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $gstData['result_code'] ?? null,
                            'message'            => $gstData['message'] ?? 'Success',
                            'request_id'         => $gstData['request_id'] ?? null,
                            'client_ref_num'     => $gstData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($gstData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($gstData, 200);
                }

                // ---------- FAILED RESPONSE ----------
                $statusCode = 102;
                $errorMessage = $gstData['message'] ?? 'GSTIN validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('gstin_advanced')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'gstin'           => $request->gstin,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($gstData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'GSTIN validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('gstin_advanced')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'gstin'           => $request->gstin,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function aadhaar_to_masked_pan(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    // ---------- VALIDATION ----------
    if (empty($request->aadhaar)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Aadhaar number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'aadhartopan')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'test',
        'aadhaar'        => $request->aadhaar
    ];

    // ---------- PLAN CHECK ----------
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyc/v1/aadhaar_to_masked_pan',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $panData = json_decode($response->getBody(), true);
                $httpResponseCode = $panData['http_response_code'] ?? $response->getStatusCode();

                // ---------- SUCCESS ----------
                if ($httpResponseCode == 200 && ($panData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('aadhaar_to_masked_pan')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'aadhaar'            => $request->aadhaar,

                            'linked'             => $panData['result']['linked'] ?? null,
                            'masked_pan'         => $panData['result']['pan'] ?? null,

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $panData['result_code'] ?? null,
                            'message'            => $panData['message'] ?? 'Success',
                            'request_id'         => $panData['request_id'] ?? null,
                            'client_ref_num'     => $panData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($panData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($panData, 200);
                }

                // ---------- FAILED ----------
                $statusCode = 102;
                $errorMessage = $panData['message'] ?? 'Aadhaar to PAN validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('aadhaar_to_masked_pan')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'aadhaar'         => $request->aadhaar,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($panData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'Aadhaar to PAN validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('aadhaar_to_masked_pan')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'aadhaar'         => $request->aadhaar,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function pan_aadhaar_link(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    // ---------- VALIDATION ----------
    if (empty($request->pan) || empty($request->aadhaar)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'PAN and Aadhaar are required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'panaadhaar')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'test',
        'pan'            => strtoupper($request->pan),
        'aadhaar'        => $request->aadhaar
    ];

    // ---------- PLAN CHECK ----------
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyc/v1/pan_aadhaar_link',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $linkData = json_decode($response->getBody(), true);
                $httpResponseCode = $linkData['http_response_code'] ?? $response->getStatusCode();

                // ---------- SUCCESS ----------
                if ($httpResponseCode == 200 && ($linkData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('pan_aadhaar_link')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'pan'                => strtoupper($request->pan),
                            'aadhaar'            => $request->aadhaar,

                            'message'            => $linkData['result']['message'] ?? null,
                            'code'               => $linkData['result']['code'] ?? null,

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $linkData['result_code'] ?? null,
                            'request_id'         => $linkData['request_id'] ?? null,
                            'client_ref_num'     => $linkData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($linkData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($linkData, 200);
                }

             
                $statusCode = 102;
                $errorMessage = $linkData['message'] ?? 'PAN Aadhaar link validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_aadhaar_link')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'aadhaar'         => $request->aadhaar,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($linkData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'PAN Aadhaar link validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_aadhaar_link')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'aadhaar'         => $request->aadhaar,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function pan_to_fname(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    // ---------- VALIDATION ----------
    if (empty($request->pan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'PAN number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'pantofname')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'test',
        'pan'            => strtoupper($request->pan)
    ];

    // ---------- PLAN CHECK ----------
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyc/v1/pan_to_fname',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $fnameData = json_decode($response->getBody(), true);
                $httpResponseCode = $fnameData['http_response_code'] ?? $response->getStatusCode();

                // ---------- SUCCESS ----------
                if ($httpResponseCode == 200 && ($fnameData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('pan_to_fname')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'pan'                => strtoupper($request->pan),
                            'father_name'        => $fnameData['result']['father_name'] ?? null,

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $fnameData['result_code'] ?? null,
                            'request_id'         => $fnameData['request_id'] ?? null,
                            'client_ref_num'     => $fnameData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($fnameData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($fnameData, 200);
                }

                
                $statusCode = 102;
                $errorMessage = $fnameData['message'] ?? 'PAN to Father Name validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_to_fname')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($fnameData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'PAN to Father Name validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_to_fname')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function pan_to_name(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

 
    if (empty($request->pan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'PAN number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'pantoname')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'test',
        'pan'            => strtoupper($request->pan)
    ];

    
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyc/v1/pan_to_name',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $panData = json_decode($response->getBody(), true);
                $httpResponseCode = $panData['http_response_code'] ?? $response->getStatusCode();

                
                if ($httpResponseCode == 200 && ($panData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('pan_to_name')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'pan'                => $panData['result']['pan'] ?? strtoupper($request->pan),
                            'name'               => $panData['result']['name'] ?? null,
                            'first_name'         => $panData['result']['first_name'] ?? null,
                            'middle_name'        => $panData['result']['middle_name'] ?? null,
                            'last_name'          => $panData['result']['last_name'] ?? null,

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $panData['result_code'] ?? null,
                            'request_id'         => $panData['request_id'] ?? null,
                            'client_ref_num'     => $panData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($panData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($panData, 200);
                }

               
                $statusCode = 102;
                $errorMessage = $panData['message'] ?? 'PAN to Name verification failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_to_name')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($panData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'PAN to Name verification failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('pan_to_name')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function arm_verification(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    
    if (empty($request->pan) || empty($request->name) || empty($request->email) || empty($request->mobile_no)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'pan, name, email and mobile_no are required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'arm')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

              
                $createBody = [
                    'pan'           => strtoupper($request->pan),
                    'name'          => $request->name,
                    'email'         => $request->email,
                    'mobile_no'     => $request->mobile_no,
                    'client_ref_id' => $request->client_ref_id ?? 'test'
                ];

                $createResponse = $client->post(
                    'https://svcdemo.digitap.work/arm/v1/request',
                    [
                        'headers' => $headers,
                        'json'    => $createBody,
                        'timeout' => 30
                    ]
                );

                $createData = json_decode($createResponse->getBody(), true);
                // return  $createData;
                if (empty($createData['transaction_id'])) {
                    return response()->json([
                        'statusCode' => 102,
                        'message' => 'Transaction ID not received',
                        'response' => $createData
                    ]);
                }
            
                $transactionId = $createData['transaction_id'];
             
                $fetchResponse = $client->post(
                    'https://svcdemo.digitap.work/arm/v1/status',
                    [
                        'headers' => $headers,
                        'json'    => [
                            'transaction_id' => $transactionId
                        ],
                        // 'timeout' => 30
                    ]
                ); 
              
                
                $armData = json_decode($fetchResponse->getBody(), true);
                //   return $armData;
                $httpResponseCode = $armData['http_response_code'] ?? $fetchResponse->getStatusCode();

            //    return 'test';
                if ($httpResponseCode == 200 && ($armData['result']['status'] ?? '') == 'OK') {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('arm_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'pan'                => strtoupper($request->pan),
                            'transaction_id'     => $transactionId,
                            'client_ref_id'      => $request->client_ref_id ?? 'test',
                            'risk_score'         => $armData['result']['risk_score'] ?? null,
                            'risk_band'          => $armData['result']['risk_band'] ?? null,
                            'http_response_code' => $httpResponseCode,
                            'vendor_response'    => json_encode($armData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($armData, 200);
                }

             
                $statusCode = 102;
                $errorMessage = $armData['message'] ?? 'ARM verification failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('arm_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'transaction_id'  => $transactionId,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($armData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('arm_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'message'         => $errorResponse['message'] ?? 'ARM API Error',
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorResponse['message'] ?? 'ARM API failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function upi_merchant(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   
    if (empty($request->vpa)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'VPA is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'upimerchant')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'test',
        'vpa'            => $request->vpa
    ];

 
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/bank/v1/upi-basic',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $upiData = json_decode($response->getBody(), true);
                $httpResponseCode = $upiData['http_response_code'] ?? $response->getStatusCode();

             
                if ($httpResponseCode == 200 && ($upiData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('upi_basic')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'vpa'                => $upiData['result']['vpa_details']['vpa'] ?? $request->vpa,
                            'account_holder_name'=> $upiData['result']['vpa_details']['account_holder_name'] ?? null,

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $upiData['result_code'] ?? null,
                            'message'            => $upiData['message'] ?? null,
                            'request_id'         => $upiData['request_id'] ?? null,
                            'client_ref_num'     => $upiData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($upiData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($upiData, 200);
                }

                
                $statusCode = 102;
                $errorMessage = $upiData['message'] ?? 'UPI validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('upi_basic')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'vpa'             => $request->vpa,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($upiData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'UPI validation failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('upi_basic')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'vpa'             => $request->vpa,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function address_verification(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

  
    if (empty($request->latitude) || empty($request->longitude)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'latitude and longitude are required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

  
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'addressverification')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();
     
    $body = [
        'uniqueId'  => $request->uniqueId ?? 'DIGITAP001',
        'latitude'  => $request->latitude,
        'longitude' => $request->longitude,
    ];
    
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];


    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

               
                $response = $client->post(
                    'https://svcdemo.digitap.work/ent/v1/address-verification',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $addressData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

             
                if ($httpResponseCode == 200 && ($addressData['code'] ?? '') == '200') {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('address_verification_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'unique_id'          => $body['uniqueId'],
                            'latitude'           => $body['latitude'],
                            'longitude'          => $body['longitude'],

                            'address'            => $addressData['model']['address'] ?? null,
                            'pincode'            => $addressData['model']['pincode'] ?? null,
                            'district'           => $addressData['model']['district'] ?? null,
                            'state'              => $addressData['model']['state'] ?? null,

                            'http_response_code' => 200,
                            'vendor_response'    => json_encode($addressData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($addressData, 200);
                }

                
                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('address_verification_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'unique_id'       => $body['uniqueId'],
                        'latitude'        => $body['latitude'],
                        'longitude'       => $body['longitude'],
                        'http_response_code' => $httpResponseCode,
                        'vendor_response' => json_encode($addressData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Address verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('address_verification_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'unique_id'       => $body['uniqueId'],
                        'latitude'        => $body['latitude'],
                        'longitude'       => $body['longitude'],
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Address verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function rc_validationthree(Request $request)
{  
    $statusCode = null;
    $api_id = null;
    $apiamster = null;
    $rc_validation = null;
    // $service_provider = null;
    if (empty($request->rcNumber)) {
        return response()->json(['statusCode' => 404, 'message' => 'RC number is required']);
    }
    
    if (!$request->headers->has('AccessToken')) {
        return response()->json(['statusCode' => 404, 'message' => 'Header Access Token is required']);
    }
     
    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json(['statusCode' => 403, 'message' => 'Wrong Access Token']);
    }
    
    $user = User::where('access_token', $request->header('AccessToken'))->first();
    
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'rcthree')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();
    
    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

            $rcNumber = strtoupper(str_replace('-', '', $request->rcNumber));

            try {
            
                $client = new Client();

                $headers = [
                    'Content-Type' => 'application/json',
                    'accessToken'  => 'f1c6ae1659db120c18fa6ff44028addb:ca07ac27c44b0a01b9bf501c687b479d'
                ];

                $client_ref_num = (string) rand(100, 999);

                $body = [
                    'rcNumber' => $rcNumber
                ];

                $response = $client->post(
                    'https://core.kashidigitalapis.com/v1/rc-premium',
                    [
                        'headers' => $headers,
                        'json' => $body,
                        'http_errors' => false
                    ]
                );
       
                $rcData = json_decode($response->getBody(), true);
            //    return $rcData['result']['registration']['number'];
             if (isset($rcData['code']) && $rcData['code'] == 402) {
                 $rcData['statusCode'] = 500; 
                }

            //    return $rcData;
                if (isset($rcData['statusCode']) && $rcData['statusCode'] == 200) {

                    $statusCode = 200;

                        $rc_validation['data']['rc_number'] = $rcData['result']['registration']['number'];
                        $rc_validation['data']['norms_type'] = $rcData['result']['vehicle']['normsType'];
                        $rc_validation['data']['rc_status'] = $rcData['result']['registration']['status']['active'];
                        $rc_validation['data']['vehicle_gross_weight'] =  $rcData['result']['vehicle']['normsType'];
                        $rc_validation['data']['unladen_weight'] =  $rcData['result']['vehicle']['grossWeight'];
                        $rc_validation['data']['manufacturing_date'] =  $rcData['result']['vehicle']['manufacturingYear'];
                        $rc_validation['data']['seat_capacity'] = $rcData['result']['vehicle']['seatCapacity'];
                        $rc_validation['data']['national_permit_issued_by'] = $rcData['result']['nationalPermit']['issuedBy'];
                        $rc_validation['data']['national_permit_number'] = $rcData['result']['nationalPermit']['number'];
                        $rc_validation['data']['national_permit_upto'] = $rcData['result']['nationalPermit']['validUpto'];
                        $rc_validation['data']['insurance_company'] = $rcData['result']['insurance']['company'];
                        $rc_validation['data']['insurance_policy_number'] = $rcData['result']['insurance']['policyNumber'];
                        $rc_validation['data']['insurance_upto'] = $rcData['result']['insurance']['expiryDate'];
                        // if ($newrcinsurance[0] < 2022) {
                        //     $rc_validation['data']['insurance_upto'] = $allinsurance;
                        // } else {
                        //     $rc_validation['data']['insurance_upto'] = $rcdata->insurance_upto;
                        // }
                        $rc_validation['data']['permit_type'] = $rcData['result']['permit']['type'];
                        $rc_validation['data']['permit_valid_from'] = $rcData['result']['permit']['validFrom'];
                        $rc_validation['data']['permit_number'] = $rcData['result']['permit']['number'];
                        $rc_validation['data']['permit_valid_upto'] = $rcData['result']['permit']['validUpto'];
                        $rc_validation['data']['permit_issue_date'] = $rcData['result']['permit']['issuedDate'];
                        $rc_validation['data']['noc_details'] = NULL;
                        $rc_validation['data']['body_type'] = $rcData['result']['vehicle']['bodyType'];
                        $rc_validation['data']['father_name'] =$rcData['result']['registration']['owner']['fatherName'];
                        $rc_validation['data']['owner_name'] = $rcData['result']['registration']['owner']['name'];
                        $rc_validation['data']['permanent_address'] = $rcData['result']['registration']['owner']['presentAddress'];
                        $rc_validation['data']['present_address'] =$rcData['result']['registration']['owner']['permanentAddress'];
                        $rc_validation['data']['pucc_number'] = $rcData['result']['pollutionControl']['certificateNumber'];
                        $rc_validation['data']['pucc_upto'] = $rcData['result']['pollutionControl']['validUpto'];
                        $rc_validation['data']['blacklist_status'] = $rcData['result']['blacklist']['status'];
                        $rc_validation['data']['maker_model'] = $rcData['result']['vehicle']['manufacturer'];
                        $rc_validation['data']['maker_description'] = $rcData['result']['vehicle']['model'];
                        $rc_validation['data']['fit_up_to'] = $rcData['result']['vehicle']['fitnessUpTo'];
                        $rc_validation['data']['standing_capacity'] = $rcData['result']['vehicle']['vehicleStandingCapacity'];
                        $rc_validation['data']['sleeper_capacity'] = $rcData['result']['vehicle']['vehicleSleeperCapacity'];
                        $rc_validation['data']['wheelbase'] = $rcData['result']['vehicle']['wheelbase'];
                        $rc_validation['data']['vehicle_category_description'] = $rcData['result']['vehicle']['wheelbase'];
                        $rc_validation['data']['vehicle_category'] = $rcData['result']['vehicle']['category'];
                        $rc_validation['data']['vehicle_chasi_number'] = $rcData['result']['vehicle']['chassis'];
                        $rc_validation['data']['mobile_number'] = $rcData['result']['registration']['owner']['mobileNumber'];
                        $rc_validation['data']['financer'] = $rcData['result']['finance']['rcFinancer'];
                        // $rc_validation['data']['rc_number'] = $rcdata->['code'];
                        // $rc_validation['data']['rc_number'] = $rcdata->['stateCd'];
                        $rc_validation['data']['latest_by'] = $rcData['result']['registration']['status']['updatedOn'];
                        $rc_validation['data']['tax_upto'] = $rcData['result']['vehicle']['taxUpTo'];
                        $rc_validation['data']['message_code'] = 'success';
                        $rc_validation['data']['non_use_to'] = $rcData['result']['nonUseStatus']['to'];
                        $rc_validation['data']['non_use_from'] = $rcData['result']['nonUseStatus']['from'];
                        $rc_validation['data']['non_use_status'] = $rcData['result']['nonUseStatus']['status'];
                        $rc_validation['data']['fuel_type'] = $rcData['result']['vehicle']['fuelType'];
                        $rc_validation['data']['registered_at'] =NULL;
                        $rc_validation['data']['registration_date'] = $rcData['result']['vehicle']['manufacturingYear'];
                        $rc_validation['data']['color'] = $rcData['result']['vehicle']['color'];
                        $rc_validation['data']['owner_number'] = $rcData['result']['registration']['ownerCount'];
                        $rc_validation['data']['no_cylinders'] = $rcData['result']['vehicle']['cylinders'];
                        $rc_validation['data']['cubic_capacity'] = $rcData['result']['vehicle']['cubicCapacity'];
                        // $rc_validation['status_code'] = 200;
                        $rc_validation['success'] = true;
                        $rc_validation['message'] = null;
                        $rc_validation['message_code'] = 'success';

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        DB::table('rcvalidation')->insert([
                 "user_id" => $user->id,
                        "api_id"  => $api_id,
                        "status_code" => $rcData['statusCode'] ?? 200,
                        "rc_number"   => $rcNumber,
                        "rc_status"   => $rcData['result']['registration']['status']['active'] ?? null,
                        "owner_number" => $rcData['result']['registration']['ownerCount'] ?? null,
                        "tax_upto"     => $rcData['result']['vehicle']['taxUpTo'] ?? null,
                        "blacklist_status" => $rcData['result']['blacklist']['status'] ?? null,
                        "father_name" => $rcData['result']['registration']['owner']['fatherName'] ?? null,
                        "registration_date" => $rcData['result']['vehicle']['manufacturingYear'] ?? null,
                        "owner_name" => $rcData['result']['registration']['owner']['name'] ?? null,
                        "present_address"   => $rcData['result']['registration']['owner']['presentAddress'] ?? null,
                        "permanent_address" => $rcData['result']['registration']['owner']['permanentAddress'] ?? null,
                        "mobile_number"     => $rcData['result']['registration']['owner']['mobileNumber'] ?? null,
                        "vehicle_category" => $rcData['result']['vehicle']['category'] ?? null,
                        "vehicle_chasi_number"  => $rcData['result']['vehicle']['chassis'] ?? null,
                        "vehicle_engine_number" => $rcData['result']['vehicle']['engine'] ?? null,
                        "maker_description" => $rcData['result']['vehicle']['manufacturer'] ?? null,
                        "maker_model"       => $rcData['result']['vehicle']['model'] ?? null,
                        "body_type"  => $rcData['result']['vehicle']['bodyType'] ?? null,
                        "fuel_type"  => $rcData['result']['vehicle']['fuelType'] ?? null,
                        "color"      => $rcData['result']['vehicle']['color'] ?? null,
                        "norms_type" => $rcData['result']['vehicle']['normsType'] ?? null,
                        "fit_up_to" => $rcData['result']['vehicle']['fitnessUpTo'] ?? null,
                        "financer"  => $rcData['result']['finance']['rcFinancer'] ?? null,
                        "insurance_company"       => $rcData['result']['insurance']['company'] ?? null,
                        "insurance_policy_number" => $rcData['result']['insurance']['policyNumber'] ?? null,
                        "insurance_upto"          => $rcData['result']['insurance']['expiryDate'] ?? null,
                        "manufacturing_date" => $rcData['result']['vehicle']['manufacturingYear'] ?? null,
                        "registered_at"      => $rcData['result']['registration']['authority'] ?? null,
                        "less_info" => 1,
                        "cubic_capacity"      => $rcData['result']['vehicle']['cubicCapacity'] ?? null,
                        "vehicle_gross_weight"=> $rcData['result']['vehicle']['grossWeight'] ?? null,
                        "no_cylinders"        => $rcData['result']['vehicle']['cylinders'] ?? null,
                        "seat_capacity"     => $rcData['result']['vehicle']['seatCapacity'] ?? null,
                        "wheelbase"         => $rcData['result']['vehicle']['wheelbase'] ?? null,
                        "unladen_weight"    => $rcData['result']['vehicle']['unladenWeight'] ?? null,
                        "pucc_number" => $rcData['result']['pollutionControl']['certificateNumber'] ?? null,
                        "pucc_upto"   => $rcData['result']['pollutionControl']['validUpto'] ?? null,
                        "hit_month" => date('Y-m'),
                        "created_at" => now(),
                        "updated_at" => now(),
                        "service_provider" => "kashi"
                    ]);
                }
                    // return response()->json(array(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]));
                    // return response()->json(['rc_validation' => $rc_validation, 'statusCode' => $statusCode]);
                    return response()->json(['rc_validation' => $rc_validation, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => 'success']);
            }
            elseif(isset($rcData['statusCode']) && $rcData['statusCode'] == 400) {

                    if ($user->role_id == 1) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                    }

                    return response()->json([
                        'statusCode' => 102,
                        'message' => 'Invalid Vehicle Number'
                    ]);
                }
                elseif (isset($rcData['statusCode']) && $rcData['statusCode']!= 200 ) {
       
                  
                    $failover_headers = [
                        'accept' => 'application/json,text/plain, */*', 
                        'accept-language' => 'en-GB,en-US;q=0.9,en;q=0.8,hi;q=0.7,mr;q=0.6',
                        'authorization' => 'Basic YzJiX2Zyb250ZW5kOko1SXRmQTk2bTJfY3lRVk00dEtOSnBYaFJ0c0NtY1h1',
                        'device_category' => 'WebApp', 
                        'origin' => 'https://www.cars24.com', 
                        'origin_source' =>'c2b-website', 
                        'platform' => 'seller', 
                        'referer' => 'https://www.cars24.com/', 
                        'user-agent' => 'Mozilla/5.0'
                    ];
                    
                    $failover_response = $client->get(
                        'https://vehicle.cars24.team/v1/2025-09/vehicle-number/' . $rcNumber,
                        [
                            'headers' => $failover_headers,
                            'http_errors' => false
                        ]
                    );

                    $cars24Data = json_decode($failover_response->getBody(), associative: true);

                      if (isset( $cars24Data['status']) &&  $cars24Data['status'] == 200) {
                        $status = 200;
                    $rc_validation['data']['rc_number'] = $cars24Data['detail']['registrationNumber'] ?? null;

                    $rc_validation['data']['rc_status'] = $cars24Data['detail']['rcStatus'] ?? null;

                    $rc_validation['data']['registration_date'] = $cars24Data['detail']['registeredAt'] ?? null;

                    $rc_validation['data']['registered_at'] = $cars24Data['detail']['registeredPlace'] ?? null;

                    $rc_validation['data']['latest_by'] = $cars24Data['detail']['updatedAt'] ?? null;

                    $rc_validation['data']['owner_name'] = $cars24Data['detail']['rc_owner_name_masked']?? $cars24Data['detail']['rc_owner_name']?? null;
                    $rc_validation['data']['owner_number'] = $cars24Data['detail']['rc_owner_sr'] ?? null;

                    $rc_validation['data']['father_name'] = null;
                    $rc_validation['data']['mobile_number'] = null;
                    $rc_validation['data']['present_address'] = null; 
                    $rc_validation['data']['permanent_address'] = null;
                    $rc_validation['data']['vehicle_category'] = $cars24Data['detail']['vehicleCategory'] ?? null;
                    $rc_validation['data']['vehicle_category_description'] = $cars24Data['detail']['vehicleClassDesc'] ?? null;
                    $rc_validation['data']['maker_model'] = $cars24Data['detail']['brand']['make_display'] ?? null;
                    $rc_validation['data']['maker_description'] = $cars24Data['detail']['model']['model_display'] ?? null;
                    $rc_validation['data']['body_type'] = $cars24Data['detail']['model']['bodyType'] ?? null;
                    $rc_validation['data']['fuel_type'] = $cars24Data['detail']['fuelType'] ?? null;
                    $rc_validation['data']['color'] = $cars24Data['detail']['color'] ?? null;
                    $rc_validation['data']['manufacturing_date'] = $cars24Data['detail']['manufacturingMonthYr'] ?? $cars24Data['detail']['regn_year']?? null;
                    $rc_validation['data']['seat_capacity'] = $cars24Data['detail']['seatCap'] ?? null;
                    $rc_validation['data']['vehicle_chasi_number'] = $cars24Data['detail']['chassisNoFull']?? $cars24Data['detail']['chassisNo']?? null;
                    $rc_validation['data']['no_cylinders'] = null; 
                    $rc_validation['data']['cubic_capacity'] = null; 
                    $rc_validation['data']['wheelbase'] = null; 
                    $rc_validation['data']['vehicle_gross_weight'] = null; 
                    $rc_validation['data']['unladen_weight'] = $cars24Data['detail']['unladenWt'] ?? null;
                    $rc_validation['data']['insurance_company'] = $cars24Data['detail']['insuranceCompany'] ?? null;
                    $rc_validation['data']['insurance_policy_number'] = $cars24Data['detail']['insurancePolicyNo'] ?? null;
                    $rc_validation['data']['insurance_upto'] = $cars24Data['detail']['insuranceUpTo'] ?? null;
                    $rc_validation['data']['tax_upto'] = $cars24Data['detail']['taxUpTo'] ?? null;
                    $rc_validation['data']['fit_up_to'] = $cars24Data['detail']['fitnessUpTo'] ?? null;
                    $rc_validation['data']['financer'] = $cars24Data['detail']['financier'] ?? null;
                    $rc_validation['data']['noc_details'] = $cars24Data['detail']['rtoNocIssued'] ?? null;
                    $rc_validation['data']['pucc_upto'] = $cars24Data['detail']['pucUpTo'] ?? null;
                    $rc_validation['data']['pucc_number'] = null; 
                    $rc_validation['data']['blacklist_status'] = null; 
                    $rc_validation['data']['non_use_status'] = null;
                    $rc_validation['data']['non_use_from']  = null;
                    $rc_validation['data']['non_use_to']    = null;
                    $rc_validation['success'] = true;
                    $rc_validation['message'] = null;
                    $rc_validation['message_code'] = 'success';
      
                    // return $cars24Data;
                 if (isset($cars24Data['success']) && $cars24Data['success'] === true)
                { 
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                 DB::table('rcvalidation')->insert([
                    "user_id" => $user->id,
    "api_id"  => $api_id,

    "status_code" => $digitapData['http_response_code'] ?? 200,
    "rc_number" => $digitapData['result']['reg_no'] ?? null,
    "rc_status" => $digitapData['result']['status'] ?? null,
    "owner_number" => $digitapData['result']['owner_count'] ?? null,

    "registration_date" => $digitapData['result']['reg_date'] ?? null,
    "registered_at"     => $digitapData['result']['reg_authority'] ?? null,

    "owner_name"  => $digitapData['result']['owner_name'] ?? null,
    "father_name" => $digitapData['result']['owner_father_name'] ?? null,
    "mobile_number" => $digitapData['result']['mobile_number'] ?? null,

    "present_address"   => $digitapData['result']['present_address'] ?? null,
    "permanent_address" => $digitapData['result']['permanent_address'] ?? null,

    "vehicle_category" => $digitapData['result']['vehicle_category'] ?? null,

    "maker_description" => $digitapData['result']['vehicle_manufacturer_name'] ?? null,
    "maker_model"       => $digitapData['result']['model'] ?? null,

    "body_type"  => $digitapData['result']['body_type'] ?? null,
    "fuel_type"  => $digitapData['result']['type'] ?? null,
    "color"      => $digitapData['result']['vehicle_colour'] ?? null,
    "norms_type" => $digitapData['result']['norms_type'] ?? null,

    "vehicle_chasi_number" => $digitapData['result']['chassis'] ?? null,
    "vehicle_engine_number"=> $digitapData['result']['engine'] ?? null,

    "manufacturing_date" => $digitapData['result']['vehicle_manufacturing_month_year'] ?? null,
    "cubic_capacity"     => $digitapData['result']['vehicle_cubic_capacity'] ?? null,
    "vehicle_gross_weight"=> $digitapData['result']['gross_vehicle_weight'] ?? null,
    "unladen_weight"     => $digitapData['result']['unladen_weight'] ?? null,
    "wheelbase"          => $digitapData['result']['wheelbase'] ?? null,
    "no_cylinders"       => $digitapData['result']['vehicle_cylinders_no'] ?? null,

    "seat_capacity"     => $digitapData['result']['vehicle_seat_capacity'] ?? null,
    "sleeper_capacity"  => $digitapData['result']['vehicle_sleeper_capacity'] ?? null,
    "standing_capacity" => $digitapData['result']['vehicle_standing_capacity'] ?? null,

    "tax_upto" => $digitapData['result']['vehicle_tax_upto'] ?? null,

    "insurance_company"       => $digitapData['result']['vehicle_insurance_company_name'] ?? null,
    "insurance_policy_number" => $digitapData['result']['vehicle_insurance_policy_number'] ?? null,
    "insurance_upto"          => $digitapData['result']['vehicle_insurance_upto'] ?? null,

    "pucc_number" => $digitapData['result']['pucc_number'] ?? null,
    "pucc_upto"   => $digitapData['result']['pucc_upto'] ?? null,

    "permit_number"     => $digitapData['result']['permit_number'] ?? null,
    "permit_type"       => $digitapData['result']['permit_type'] ?? null,
    "permit_valid_from" => $digitapData['result']['permit_valid_from'] ?? null,
    "permit_valid_upto" => $digitapData['result']['permit_valid_upto'] ?? null,
    "permit_issue_date" => $digitapData['result']['permit_issue_date'] ?? null,

    "national_permit_issued_by" => $digitapData['result']['national_permit_issued_by'] ?? null,
    "national_permit_number"    => $digitapData['result']['national_permit_number'] ?? null,
    "national_permit_upto"      => $digitapData['result']['national_permit_upto'] ?? null,

    "financer" => $digitapData['result']['rc_financer'] ?? null,

    "blacklist_status" => $digitapData['result']['blacklist_status'] ?? null,
    "noc_details"      => $digitapData['result']['noc_details'] ?? null,
    "non_use_status"   => $digitapData['result']['non_use_status'] ?? null,
    "non_use_from"     => $digitapData['result']['non_use_from'] ?? null,
    "non_use_to"       => $digitapData['result']['non_use_to'] ?? null,

    "less_info" => 1,
    "hit_month" => date('Y-m'),

    "service_provider" => "digitap",
   

    "created_at" => now(),
    "updated_at" => now(),
]);
                    }

                    }
                     return response()->json(['rc_validation' => $rc_validation, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => 'success']);
                    
                }
                    if (!isset($cars24Data['status']) || $cars24Data['status'] != 200) {
                    
                        $digitap_headers = [
                            'Content-Type'  => 'application/json',
                            'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                        ];

                        $digitap_body = [
                            'reg_no' => $rcNumber,
                            'client_ref_num' => $client_ref_num
                        ];

                        $digitap_response = $client->post(
                            'https://svcdemo.digitap.work/validation/kyc/v1/rc',
                            [
                                'headers' => $digitap_headers,
                                'json' => $digitap_body,
                                'http_errors' => false
                            ]
                        );

                        $digitapData = json_decode($digitap_response->getBody(), true);
       if (isset($digitapData['http_response_code'], $digitapData['result_code']) && $digitapData['http_response_code'] == 200 && $digitapData['result_code'] == 101)
         {

                   $rc_validation['data']['client_id'] = null;
                    $rc_validation['data']['rc_number'] = $digitapData['result']['reg_no'];
                    $rc_validation['data']['registration_date'] = $digitapData['result']['reg_date'];
                    $rc_validation['data']['registration_expiry_date'] = $digitapData['result']['rc_expiry_date'];
                    $rc_validation['data']['owner_name'] = $digitapData['result']['owner_name'];
                    $rc_validation['data']['owner_number'] = null;
                    $rc_validation['data']['father_name'] = $digitapData['result']['owner_father_name'];
                    $rc_validation['data']['present_address'] = $digitapData['result']['present_address'];
                    $rc_validation['data']['permanent_address'] = $digitapData['result']['permanent_address'];
                    $rc_validation['data']['mobile_number'] = $digitapData['result']['mobile_number'];
                    $rc_validation['data']['vehicle_category'] = $digitapData['result']['vehicle_category'];
                    $rc_validation['data']['vehicle_chasi_number'] = $digitapData['result']['chassis'];
                    // $rc_validation['data']['vehicle_engine_number'] = $digitapData['result']['engine'];
                    $rc_validation['data']['maker_description'] = $digitapData['result']['vehicle_manufacturer_name'];
                    $rc_validation['data']['maker_model'] = $digitapData['result']['model'];
                    $rc_validation['data']['vehicle_class'] = $digitapData['result']['class'];
                    $rc_validation['data']['body_type'] = $digitapData['result']['body_type'];
                    $rc_validation['data']['fuel_type'] = $digitapData['result']['type'];
                    $rc_validation['data']['color'] = $digitapData['result']['vehicle_colour'];
                    $rc_validation['data']['norms_type'] = $digitapData['result']['norms_type'];
                    $rc_validation['data']['fit_up_to'] = null;
                    $rc_validation['data']['financer'] = $digitapData['result']['rc_financer'];
                    $rc_validation['data']['is_financed'] = $digitapData['result']['financed'];
                    $rc_validation['data']['insurance_company'] = $digitapData['result']['vehicle_insurance_company_name'];
                    $rc_validation['data']['insurance_policy_number'] = $digitapData['result']['vehicle_insurance_policy_number'];
                    $rc_validation['data']['insurance_upto'] = $digitapData['result']['vehicle_insurance_upto'];
                    $rc_validation['data']['manufacturing_date'] = $digitapData['result']['vehicle_manufacturing_month_year'];
                    $rc_validation['data']['registered_at'] = $digitapData['result']['reg_authority'];
                    $rc_validation['data']['less_info'] = null;
                    $rc_validation['data']['cubic_capacity'] = $digitapData['result']['vehicle_cubic_capacity'];
                    $rc_validation['data']['vehicle_gross_weight'] = $digitapData['result']['gross_vehicle_weight'];
                    $rc_validation['data']['no_cylinders'] = $digitapData['result']['vehicle_cylinders_no'];
                    $rc_validation['data']['seat_capacity'] = $digitapData['result']['vehicle_seat_capacity'];
                    $rc_validation['data']['sleeper_capacity'] = $digitapData['result']['vehicle_sleeper_capacity'];
                    $rc_validation['data']['standing_capacity'] = $digitapData['result']['vehicle_standing_capacity'];
                    $rc_validation['data']['wheelbase'] = $digitapData['result']['wheelbase'];
                    $rc_validation['data']['unladen_weight'] = $digitapData['result']['unladen_weight'];
                    $rc_validation['data']['vehicle_category_description'] = null;
                    $rc_validation['data']['pucc_number'] = $digitapData['result']['pucc_number'];
                    if (isset($digitapData['result']['pucc_upto']) && $digitapData['result']['pucc_upto'] != null && $digitapData['result']['pucc_upto'] != 'null' && $digitapData['result']['pucc_upto'] != 'NA') {
                        $rc_validation['data']['pucc_upto'] = $digitapData['result']['pucc_upto'];
                    } else {
                        $rc_validation['data']['pucc_upto'] = $digitapData['result']['pucc_upto'];
                    }
                    $rc_validation['data']['masked_name'] = null;
                    $rc_validation['data']['permit_issue_date'] = $digitapData['result']['permit_issue_date'];
                    $rc_validation['data']['permit_number'] = $digitapData['result']['permit_number'];
                    $rc_validation['data']['permit_type'] = $digitapData['result']['permit_type'];
                    $rc_validation['data']['permit_valid_from'] = $digitapData['result']['permit_valid_from'];
                    $rc_validation['data']['permit_valid_upto'] = $digitapData['result']['permit_valid_upto'];
                    $rc_validation['data']['national_permit_issued_by'] = $digitapData['result']['national_permit_issued_by'];
                    $rc_validation['data']['national_permit_number'] = $digitapData['result']['national_permit_number'];
                    $rc_validation['data']['national_permit_upto'] = $digitapData['result']['national_permit_upto'];
                    $rc_validation['data']['blacklist_status'] = $digitapData['result']['blacklist_status'];
                    $rc_validation['data']['blacklist_details'] = $digitapData['result']['blacklist_details'];
                    $rc_validation['data']['rto_code'] = $digitapData['result']['rto_code'];
                    $rc_validation['data']['latest_by'] = $digitapData['result']['status_as_on'];
                    $rc_validation['data']['tax_upto'] = $digitapData['result']['vehicle_tax_upto'];
                    $rc_validation['data']['noc_details'] = $digitapData['result']['noc_details'];
                    $rc_validation['data']['number'] = $digitapData['result']['reg_no'];
                    $rc_validation['data']['rc_status'] = $digitapData['result']['status'];
                    $rc_validation['data']['authority'] = $digitapData['result']['reg_authority'];
                    $rc_validation['data']['non_use_to'] = $digitapData['result']['non_use_to'];
                    $rc_validation['data']['non_use_from'] = $digitapData['result']['non_use_from'];
                    $rc_validation['data']['non_use_status'] = $digitapData['result']['non_use_status'];
                    $rc_validation['data']['owner_count'] = $digitapData['result']['owner_count'];
                    $rc_validation['data']['challan_details'] = $digitapData['result']['challan_details'];

                    
                 if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                  DB::table('rcvalidation')->insert([
    "user_id" => $user->id,
    "api_id"  => $api_id,

    "status_code" => $digitapData['http_response_code'] ?? 200,

    "rc_number" => $digitapData['result']['reg_no'] ?? null,
    "rc_status" => $digitapData['result']['status'] ?? null,

    "owner_number" => $digitapData['result']['owner_count'] ?? null,

    "registration_date" => $digitapData['result']['reg_date'] ?? null,
    "registered_at"     => $digitapData['result']['reg_authority'] ?? null,

    "owner_name"  => $digitapData['result']['owner_name'] ?? null,
    "father_name" => $digitapData['result']['owner_father_name'] ?? null,
    "mobile_number" => $digitapData['result']['mobile_number'] ?? null,

    "present_address"   => $digitapData['result']['present_address'] ?? null,
    "permanent_address" => $digitapData['result']['permanent_address'] ?? null,

    "vehicle_category" => $digitapData['result']['vehicle_category'] ?? null,

    "maker_description" => $digitapData['result']['vehicle_manufacturer_name'] ?? null,
    "maker_model"       => $digitapData['result']['model'] ?? null,

    "body_type"  => $digitapData['result']['body_type'] ?? null,
    "fuel_type"  => $digitapData['result']['type'] ?? null,
    "color"      => $digitapData['result']['vehicle_colour'] ?? null,
    "norms_type" => $digitapData['result']['norms_type'] ?? null,

    "vehicle_chasi_number" => $digitapData['result']['chassis'] ?? null,
    "vehicle_engine_number"=> $digitapData['result']['engine'] ?? null,

    "manufacturing_date" => $digitapData['result']['vehicle_manufacturing_month_year'] ?? null,
    "cubic_capacity"     => $digitapData['result']['vehicle_cubic_capacity'] ?? null,
    "vehicle_gross_weight"=> $digitapData['result']['gross_vehicle_weight'] ?? null,
    "unladen_weight"     => $digitapData['result']['unladen_weight'] ?? null,
    "wheelbase"          => $digitapData['result']['wheelbase'] ?? null,
    "no_cylinders"       => $digitapData['result']['vehicle_cylinders_no'] ?? null,

    "seat_capacity"     => $digitapData['result']['vehicle_seat_capacity'] ?? null,
    "sleeper_capacity"  => $digitapData['result']['vehicle_sleeper_capacity'] ?? null,
    "standing_capacity" => $digitapData['result']['vehicle_standing_capacity'] ?? null,

    "tax_upto" => $digitapData['result']['vehicle_tax_upto'] ?? null,

    "insurance_company"       => $digitapData['result']['vehicle_insurance_company_name'] ?? null,
    "insurance_policy_number" => $digitapData['result']['vehicle_insurance_policy_number'] ?? null,
    "insurance_upto"          => $digitapData['result']['vehicle_insurance_upto'] ?? null,

    "pucc_number" => $digitapData['result']['pucc_number'] ?? null,
    "pucc_upto"   => $digitapData['result']['pucc_upto'] ?? null,

    "permit_number"     => $digitapData['result']['permit_number'] ?? null,
    "permit_type"       => $digitapData['result']['permit_type'] ?? null,
    "permit_valid_from" => $digitapData['result']['permit_valid_from'] ?? null,
    "permit_valid_upto" => $digitapData['result']['permit_valid_upto'] ?? null,
    "permit_issue_date" => $digitapData['result']['permit_issue_date'] ?? null,

    "national_permit_issued_by" => $digitapData['result']['national_permit_issued_by'] ?? null,
    "national_permit_number"    => $digitapData['result']['national_permit_number'] ?? null,
    "national_permit_upto"      => $digitapData['result']['national_permit_upto'] ?? null,

    "financer" => $digitapData['result']['rc_financer'] ?? null,

    "blacklist_status" => $digitapData['result']['blacklist_status'] ?? null,
    "noc_details"      => $digitapData['result']['noc_details'] ?? null,
    "non_use_status"   => $digitapData['result']['non_use_status'] ?? null,
    "non_use_from"     => $digitapData['result']['non_use_from'] ?? null,
    "non_use_to"       => $digitapData['result']['non_use_to'] ?? null,

    "less_info" => 1,
    "hit_month" => date('Y-m'),

    "service_provider" => "digitap",
    "vendor_response"  => json_encode($digitapData, JSON_UNESCAPED_UNICODE),

    "created_at" => now(),
    "updated_at" => now(),
]);



                    }
                }
             
                
                    }
                    return response()->json(['rc_validation' => $rc_validation, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => 'success']);
                }
  
                return response()->json([
                    'statusCode' => 500,
                    'message' => 'Internal server error'
                ]);

            }
             catch (BadResponseException $e) {
                return response()->json([
                    'statusCode' => 500,
                    'message' => 'Exception occurred',
                    'error' => $e->getMessage()
                ]);
            }
       }else {
    return response()->json([
        'statusCode' => 500,
        'message' => 'Please recharge your wallet.'
    ]);
}

    }else {
    return response()->json([
        'statusCode' => 103,
        'message' => 'You are not registered to use this service. Please update your plan.'
    ]);
}

}

public function upi_enhanced(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;
   
    
    if (empty($request->vpa)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'VPA is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

   
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'upienhanced')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    
    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
        'vpa'            => $request->vpa
    ];

  
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

   
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

              
                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/bank/v1/upi-enhanced',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $upiData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

               
                if (
                    $httpResponseCode == 200 &&
                    ($upiData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('upi_enhanced_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'vpa'                => $upiData['result']['vpa_details']['vpa'] ?? null,
                            'account_holder'     => $upiData['result']['vpa_details']['account_holder_name'] ?? null,
                            'entity_type'        => $upiData['result']['vpa_details']['entity_type'] ?? null,

                            'account_type'       => $upiData['result']['account_details']['account_type'] ?? null,
                            'account_ifsc'       => $upiData['result']['account_details']['account_ifsc'] ?? null,

                            'merchant_category'  => $upiData['result']['merchant_details']['merchant_category'] ?? null,
                            'merchant_type'      => $upiData['result']['merchant_details']['merchant_type'] ?? null,

                            'http_response_code' => 200,
                            'result_code'        => $upiData['result_code'] ?? null,
                            'request_id'         => $upiData['request_id'] ?? null,
                            'client_ref_num'     => $upiData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($upiData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($upiData, 200);
                }

                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                     DB::table('upi_enhanced_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'vpa'             => $request->vpa,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($upiData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $upiData['message'] ?? 'UPI Enhanced verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('upi_enhanced_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'vpa'             => $request->vpa,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UPI Enhanced verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function company_to_pan(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   
    if (empty($request->company_name)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Company name is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

   
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'companytopan')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

  
    $body = [
        'company_name'        => $request->company_name,
        'output_count'        => $request->output_count ?? '10',
        'client_ref_num'      => $request->client_ref_num ?? 'ref_' . time(),
        'search_by_trade_name'=> $request->search_by_trade_name ?? false
    ];

    
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

   
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                
                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/company_to_pan',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $companyData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

                
                if (
                    $httpResponseCode == 200 &&
                    ($companyData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('company_to_pan_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'company_name'       => $companyData['result']['company_name'] ?? null,
                            'result_count'       => $companyData['result_count'] ?? null,

                            'http_response_code' => 200,
                            'result_code'        => $companyData['result_code'] ?? null,
                            'request_id'         => $companyData['request_id'] ?? null,
                            'client_ref_num'     => $companyData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($companyData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($companyData, 200);
                }

                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                    
                    DB::table('company_to_pan_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'company_name'    => $request->company_name,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($companyData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $companyData['message'] ?? 'Company to PAN verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('company_to_pan_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'company_name'    => $request->company_name,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Company to PAN verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function tds_quarterly(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   
    if (
        empty($request->pan) ||
        empty($request->tan) ||
        empty($request->financial_year)
    ) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'pan, tan and financial_year are required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

  
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'tdsquarterly')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

   
    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
        'pan'            => strtoupper($request->pan),
        'tan'            => strtoupper($request->tan),
        'financial_year' => $request->financial_year
    ];

    
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

   
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

               
                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v1/tds_quarterly',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $tdsData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

                
                if (
                    $httpResponseCode == 200 &&
                    ($tdsData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('tds_quarterly_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'pan'                => $tdsData['result']['pan'] ?? null,
                            'tan'                => $tdsData['result']['tan'] ?? null,
                            'financial_year'     => $request->financial_year,
                            'return_type'        => $tdsData['result']['return_type'] ?? null,
                            'employer_name'      => $tdsData['result']['employer_name'] ?? null,

                            'http_response_code' => 200,
                            'result_code'        => $tdsData['result_code'] ?? null,
                            'request_id'         => $tdsData['request_id'] ?? null,
                            'client_ref_num'     => $tdsData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($tdsData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($tdsData, 200);
                }

               
                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                     DB::table('tds_quarterly_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'tan'             => strtoupper($request->tan),
                        'financial_year'  => $request->financial_year,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($tdsData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $tdsData['message'] ?? 'TDS Quarterly verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('tds_quarterly_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => strtoupper($request->pan),
                        'tan'             => strtoupper($request->tan),
                        'financial_year'  => $request->financial_year,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'TDS Quarterly verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function employment_uan(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;


    if (
        empty($request->employee_name) ||
        empty($request->dob)
    ) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'employee_name and dob are required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

   
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'employmentuan')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

   
    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
        'employee_name'  => $request->employee_name,
        'dob'            => $request->dob
    ];

  
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];
 
  
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {
        
        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {
        
            try {

           
                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v2/uan_basic/sync',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

              
                if (
                    $httpResponseCode == 200 &&
                    ($uanData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                       DB::table('uan_basic_logs')->insert([
    'user_id'            => $user->id,
    'api_id'             => $api_id,
    'employee_name'      => $request->employee_name,
    'dob'                => $request->dob,

    'matching_uan'       => $uanData['result']['summary']['matching_uan'] ?? null,
    'uan_count'          => $uanData['result']['summary']['uan_count'] ?? null,
    'is_employed'        => $uanData['result']['summary']['is_employed'] ?? null,
    'employee_name_match'=> $uanData['result']['summary']['employee_name_match'] ?? null,
    'employer_name_match'=> $uanData['result']['summary']['employer_name_match'] ?? null,
    'date_of_exit_marked'=> $uanData['result']['summary']['date_of_exit_marked'] ?? null,
    'name_dob_filtering_score' =>
        $uanData['result']['name_dob_filtering_score'] ?? null,

    'recent_member_id' =>
        $uanData['result']['summary']['recent_employer_data']['member_id'] ?? null,

    'recent_establishment_id' =>
        $uanData['result']['summary']['recent_employer_data']['establishment_id'] ?? null,

    'recent_establishment_name' =>
        $uanData['result']['summary']['recent_employer_data']['establishment_name'] ?? null,

    'recent_date_of_joining' =>
        !empty($uanData['result']['summary']['recent_employer_data']['date_of_joining'])
            ? $uanData['result']['summary']['recent_employer_data']['date_of_joining']
            : null,

    'recent_date_of_exit' =>
        !empty($uanData['result']['summary']['recent_employer_data']['date_of_exit'])
            ? $uanData['result']['summary']['recent_employer_data']['date_of_exit']
            : null,

    'http_response_code' => 200,
    'result_code'        => $uanData['result_code'] ?? null,
    'request_id'         => $uanData['request_id'] ?? null,
    'client_ref_num'     => $uanData['client_ref_num'] ?? null,
    'vendor_response'    => json_encode($uanData, JSON_UNESCAPED_UNICODE),
    'created_at'         => now(),
    'updated_at'         => now(),
]);

                    }

                    return response()->json($uanData, 200);
                }

              
                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('uan_basic_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'employee_name'   => $request->employee_name,
                        'dob'             => $request->dob,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($uanData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $uanData['message'] ?? 'UAN verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('uan_basic_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'employee_name'   => $request->employee_name,
                        'dob'             => $request->dob,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function employment_uan_v3(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   
    if (empty($request->uan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'UAN is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    
    $user = User::where('access_token', $request->header('AccessToken'))->first();


    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'employmentuanvthree')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    
    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
        'uan'            => $request->uan
    ];

  
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

 
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                
                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v3/uan_basic/sync',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

                
                if (
                    $httpResponseCode == 200 &&
                    ($uanData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('uan_basic_v3_logs')->insert([
                            'user_id'        => $user->id,
                            'api_id'         => $api_id,

                            'uan'            => $uanData['result']['summary']['matching_uan'] ?? null,
                            'uan_count'      => $uanData['result']['summary']['uan_count'] ?? null,
                            'is_employed'    => $uanData['result']['summary']['is_employed'] ?? null,
                            'date_of_exit_marked'
                                             => $uanData['result']['summary']['date_of_exit_marked'] ?? null,

                            'recent_establishment_name'
                                             => $uanData['result']['summary']['recent_employer_data']['establishment_name'] ?? null,
                            'recent_establishment_id'
                                             => $uanData['result']['summary']['recent_employer_data']['establishment_id'] ?? null,
                            'recent_member_id'
                                             => $uanData['result']['summary']['recent_employer_data']['member_id'] ?? null,
                           $recentDateOfJoining = $uanData['result']['summary']['recent_employer_data']['date_of_joining'] ?? null,
                            $recentDateOfExit    = $uanData['result']['summary']['recent_employer_data']['date_of_exit'] ?? null,

                            $recentDateOfJoining = !empty($recentDateOfJoining) ? $recentDateOfJoining : null,
                            $recentDateOfExit    = !empty($recentDateOfExit) ? $recentDateOfExit : null,


                            'http_response_code' => 200,
                            'result_code'        => $uanData['result_code'] ?? null,
                            'request_id'         => $uanData['request_id'] ?? null,
                            'client_ref_num'     => $uanData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($uanData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($uanData, 200);
                }

               
                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('uan_basic_v3_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'uan'             => $request->uan,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($uanData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('uan_basic_v3_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'uan'             => $request->uan,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function dl_validation_v3(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

 
    if (empty($request->dl_number)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'DL Number is required'
        ]);
    }

    if (empty($request->dob)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Date of Birth is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    
    $user = User::where('access_token', $request->header('AccessToken'))->first();

 
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'dlvalidationnew')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    
    $body = [
        'dl_number'      => $request->dl_number,
        'dob'            => $request->dob,
        'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
    ];


    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

   
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

               
                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyc/v1/dl',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $dlData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

                
                if (
                    $httpResponseCode == 200 &&
                    ($dlData['result_code'] ?? 0) == 101
                ) {
        
                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                       DB::table('dl_validation_logs')->insert([
    'user_id' => $user->id,
    'api_id'  => $api_id,

    'dl_number' => $dlData['result']['dl_number'] ?? null,
    'dob'       => !empty($dlData['result']['dob'])
                    ? date('Y-m-d', strtotime($dlData['result']['dob']))
                    : null,

    'name' => $dlData['result']['details_of_driving_licence']['name'] ?? null,

    'father_or_husband_name'
        => $dlData['result']['details_of_driving_licence']['father_or_husband_name'] ?? null,

    'status' => $dlData['result']['details_of_driving_licence']['status'] ?? null,

    'date_of_issue'
        => !empty($dlData['result']['details_of_driving_licence']['date_of_issue'])
            ? date('Y-m-d', strtotime(
                $dlData['result']['details_of_driving_licence']['date_of_issue']
              ))
            : null,

    'address' => $dlData['result']['details_of_driving_licence']['address'] ?? null,

    'http_response_code' => 200,
    'result_code'        => $dlData['result_code'] ?? null,
    'request_id'         => $dlData['request_id'] ?? null,
    'client_ref_num'     => $dlData['client_ref_num'] ?? null,

    'vendor_response' => json_encode($dlData, JSON_UNESCAPED_UNICODE),
    'created_at'      => now(),
    'updated_at'      => now(),
]);

                       
                    }

                    return response()->json($dlData, 200);
                }

                
                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {

                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('dl_validation_logs')->insert([
                        'user_id'        => $user->id,
                        'api_id'         => $api_id,
                        'dl_number'      => $request->dl_number,
                        'dob'            => $request->dob,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($dlData),
                        'created_at'     => now(),
                        'updated_at'     => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $dlData['message'] ?? 'DL verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {

                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('dl_validation_logs')->insert([
                        'user_id'        => $user->id,
                        'api_id'         => $api_id,
                        'dl_number'      => $request->dl_number,
                        'dob'            => $request->dob,
                        'http_response_code' => $statusCode,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'     => now(),
                        'updated_at'     => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'DL verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

  public function driving_license_three(Request $request)
{  
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->dl_number)) {
        return response()->json(['statusCode' => 404, 'message' => 'Driving License number is required']);
    }
   
    if (empty($request->dob)) {
        return response()->json(['statusCode' => 404, 'message' => 'Date of Birth is required']);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json(['statusCode' => 404, 'message' => 'Header Access Token is required']);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json(['statusCode' => 403, 'message' => 'Wrong Access Token']);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'licensethree')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (($user->wallet_amount > 0 && $user->role_id == 1) || $user->role_id == 0 || $user->type == "role_postpaid") {

            $dl_number = strtoupper(str_replace('-', '', $request->dl_number));
            // return  $dl_number;
            try {
                $client = new Client();

            

                $digitap_headers = [
                    'Content-Type'  => 'application/json',
                    'Accept'        => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $digitap_body = [
                    'dl_number' => $dl_number,
                    'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
                    'dob' => $request->dob
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyc/v1/dl',
                    [
                        'headers' => $digitap_headers,
                        'json' => $digitap_body,
                        'http_errors' => false
                    ]
                );
             
                $dlData = json_decode($response->getBody(), true);
                // return $dlData;
                if (isset($dlData['http_response_code']) && $dlData['http_response_code'] == 200) {
                $dl_validation['data'] = [];
                $dl_validation['data']['dl_number'] = $dlData['result']['dl_number'] ?? null;
                $dl_validation['data']['name'] = $dlData['result']['details_of_driving_licence']['name'] ?? null;
                $dl_validation['data']['father_name'] = $dlData['result']['details_of_driving_licence']['father_or_husband_name'] ?? null;
                $dl_validation['data']['dob'] = Carbon::createFromFormat('d-m-Y', $dlData['result']['dob'])->format('Y-m-d');
                $dl_validation['data']['status'] = $dlData['result']['details_of_driving_licence']['status'] ?? null;
                $dl_validation['data']['issue_date'] =$dlData['result']['details_of_driving_licence']['date_of_issue'] ?? null;
                $dl_validation['data']['class_of_vehicle'] =$dlData['result']['badge_details'][0]['class_of_vehicle'] ?? [];
                $dl_validation['data']['validity'] = ['non_transport' => ['from' => $dlData['result']['dl_validity']['non_transport']['from'] ?? null,'to'   => $dlData['result']['dl_validity']['non_transport']['to'] ?? null,],
                'transport' => [
                'from' => $dlData['result']['dl_validity']['transport']['from'] ?? null,
                'to'   => $dlData['result']['dl_validity']['transport']['to'] ?? null,
                 ],
                'hazardous_valid_till' =>
                $dlData['result']['dl_validity']['hazardous_valid_till'] ?? null,
                'hill_valid_till' =>$dlData['result']['dl_validity']['hill_valid_till'] ?? null];
            $address = $dlData['result']['details_of_driving_licence']['address_list'][0]['split_address'] ?? [];
            $dl_validation['data']['address'] = [
            'present_address' =>
            $dlData['result']['details_of_driving_licence']['address'] ?? null,
           'permanent_address' =>$dlData['result']['details_of_driving_licence']['address'] ?? null,
           'district' => $address['district'][0] ?? null,
           'city'     => $address['city'][0] ?? null,
           'state'    => $address['state'][0][0] ?? null,
           'state_code'=> $address['state'][0][1] ?? null,
           'pincode'  => $address['pincode'] ?? null,
           'country'  => $address['country'][2] ?? null
            ];

$dl_validation['success'] = true;
$dl_validation['message'] = null;
$dl_validation['message_code'] = 'success';

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
DB::table('driving_license_three')->insert([
    'user_id' => $user->id,
    'api_id'  => $api_id,

    'http_response_code' => $dlData['http_response_code'] ?? null,
    'result_code'        => $dlData['result_code'] ?? null,
    'request_id'         => $dlData['request_id'] ?? null,
    'client_ref_num'     => $dlData['client_ref_num'] ?? null,

    'dl_number' => $dlData['result']['dl_number'] ?? null,
    'dob' => !empty($dlData['result']['dob'])
        ? Carbon::createFromFormat('d-m-Y', $dlData['result']['dob'])->format('Y-m-d')
        : null,

    'license_status' => $dlData['result']['details_of_driving_licence']['status'] ?? null,

    'date_of_issue' => !empty($dlData['result']['details_of_driving_licence']['date_of_issue'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['details_of_driving_licence']['date_of_issue']
          )->format('Y-m-d')
        : null,

    'last_transaction_date' => !empty($dlData['result']['details_of_driving_licence']['date_of_last_transaction'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['details_of_driving_licence']['date_of_last_transaction']
          )->format('Y-m-d')
        : null,

    'holder_name' =>
        $dlData['result']['details_of_driving_licence']['name'] ?? null,

    'father_or_husband_name' =>
        $dlData['result']['details_of_driving_licence']['father_or_husband_name'] ?? null,

    'address' =>
        $dlData['result']['details_of_driving_licence']['address'] ?? null,

    'pincode' =>
        $dlData['result']['details_of_driving_licence']['split_address']['pincode'] ?? null,

    'district' =>
        $dlData['result']['details_of_driving_licence']['split_address']['district'][0] ?? null,

    'city' =>
        $dlData['result']['details_of_driving_licence']['split_address']['city'][0] ?? null,

    'state_name' =>
        $dlData['result']['details_of_driving_licence']['split_address']['state'][0][0] ?? null,

    'state_code' =>
        $dlData['result']['details_of_driving_licence']['split_address']['state'][0][1] ?? null,

    'country' =>
        $dlData['result']['details_of_driving_licence']['split_address']['country'][2] ?? null,

    'nt_valid_from' => !empty($dlData['result']['dl_validity']['non_transport']['from'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['dl_validity']['non_transport']['from']
          )->format('Y-m-d')
        : null,

    'nt_valid_to' => !empty($dlData['result']['dl_validity']['non_transport']['to'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['dl_validity']['non_transport']['to']
          )->format('Y-m-d')
        : null,

    'transport_valid_from' => !empty($dlData['result']['dl_validity']['transport']['from'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['dl_validity']['transport']['from']
          )->format('Y-m-d')
        : null,

    'transport_valid_to' => !empty($dlData['result']['dl_validity']['transport']['to'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['dl_validity']['transport']['to']
          )->format('Y-m-d')
        : null,

    'hazardous_valid_till' => !empty($dlData['result']['dl_validity']['hazardous_valid_till'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['dl_validity']['hazardous_valid_till']
          )->format('Y-m-d')
        : null,

    'hill_valid_till' => !empty($dlData['result']['dl_validity']['hill_valid_till'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['dl_validity']['hill_valid_till']
          )->format('Y-m-d')
        : null,

    'vehicle_class' =>
        json_encode($dlData['result']['badge_details'][0]['class_of_vehicle'] ?? []),

    'badge_no' =>
        $dlData['result']['badge_details'][0]['badge_no'] ?? null,

    'badge_issue_date' => !empty($dlData['result']['badge_details'][0]['badge_issue_date'])
        ? Carbon::createFromFormat(
            'd-m-Y',
            $dlData['result']['badge_details'][0]['badge_issue_date']
          )->format('Y-m-d')
        : null,

    'vendor_response' =>
        json_encode($dlData, JSON_UNESCAPED_UNICODE),

    'created_at' => now(),
    'updated_at' => now(),
]);


                    }

                    return response()->json( $dl_validation, 200);
                }

             
                elseif (isset($dlData['http_response_code']) &&
                    in_array($dlData['http_response_code'], [400, 404, 422])) {

                    if ($user->role_id == 1) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Failed', 102);
                    }

                    return response()->json([
                        'statusCode' => 102,
                        'message' => $dlData['message'] ?? 'Invalid Driving License Number'
                    ]);
                }

               
                elseif (isset($dlData['http_response_code']) && in_array($dlData['http_response_code'], [402, 500])) {

                  

                    $failover_headers = [
                        'x-api-key' => $this->api_club_key,
                        'Referer'   => $this->site_url,
                        'accept'    => 'application/json'
                    ];

                    $failover_body = [
                        'dl_no' => $dl_number,
                        'dob'   => $request->dob
                    ];

                    $failover_response = $client->post(
                        'https://prod.apiclub.in/api/v1/fetch_dl',
                        [
                            'headers' => $failover_headers,
                            'json' => $failover_body,
                            'http_errors' => false
                        ]
                    );

                    $apiclubData = json_decode($failover_response->getBody(), true);

                    if (isset($apiclubData['code']) && $apiclubData['code'] == 200) {

                        if ($user->role_id == 1 && $apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                        return response()->json($apiclubData, 200);
                    }

                    $headers = [
                        'Content-Type' => 'application/json',
                        'Accept' => 'application/json'
                    ];

                    $body = [
                        'dlno' => $dl_number,
                        'mobileNumber' => $request->mobileNumber ?? '',
                        'recordId' => '49473123',
                        'deviceId' => 'p38e0od88a649e62',
                        'token' => 'x*RRrjfC44RxWCl2'
                    ];

                    $api_response = $client->post(
                        'http://13.234.112.106:8080/api/dl-details',
                        [
                            'headers' => $headers,
                            'json' => $body,
                            'http_errors' => false
                        ]
                    );

                    $apiData = json_decode($api_response->getBody(), true);

                    if (isset($apiData['result_code']) && in_array($apiData['result_code'], [200, 101])) {

                        if ($user->role_id == 1 && $apiamster) {
                            $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        }

                        return response()->json($apiData, 200);
                    }
                }

                return response()->json([
                    'statusCode' => 500,
                    'message' => 'Internal server error'
                ]);

            } catch (BadResponseException $e) {
                return response()->json([
                    'statusCode' => 500,
                    'message' => 'Exception occurred',
                    'error' => $e->getMessage()
                ]);
            }

        } else {
            return response()->json(['statusCode' => 500, 'message' => 'Please recharge your wallet.']);
        }

    } else {
        return response()->json(['statusCode' => 103, 'message' => 'You are not registered to use this service.']);
    }
}
public function employment_uan_v4(Request $request): JsonResponse
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   
    if (empty($request->uan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'UAN is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

   
    $user = User::where('access_token', $request->header('AccessToken'))->first();

   
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'employmentuanvfour')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    // ---------- REQUEST BODY ----------
    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
        'uan'            => $request->uan
    ];

    // ---------- HEADERS ----------
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    // ---------- HIT COUNT ----------
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                // ---------- API CALL ----------
                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v4/uan_basic/sync',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

                // ---------- SUCCESS ----------
                if (
                    $httpResponseCode == 200 &&
                    ($uanData['result_code'] ?? 0) == 101
                ) {

                    // ---- Date safety ----
                    $recentJoin = $uanData['result']['summary']['recent_employer_data']['date_of_joining'] ?? null;
                    $recentExit = $uanData['result']['summary']['recent_employer_data']['date_of_exit'] ?? null;

                    $recentJoin = (!empty($recentJoin) && strtotime($recentJoin))
                        ? date('Y-m-d', strtotime($recentJoin)) : null;

                    $recentExit = (!empty($recentExit) && strtotime($recentExit))
                        ? date('Y-m-d', strtotime($recentExit)) : null;

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('uan_basic_v4_logs')->insert([
                            'user_id' => $user->id,
                            'api_id'  => $api_id,

                            'uan'       => $uanData['result']['summary']['matching_uan'] ?? null,
                            'uan_count'=> $uanData['result']['summary']['uan_count'] ?? null,
                            'is_employed'
                                        => $uanData['result']['summary']['is_employed'] ?? null,
                            'date_of_exit_marked'
                                        => $uanData['result']['summary']['date_of_exit_marked'] ?? null,

                            'recent_establishment_name'
                                        => $uanData['result']['summary']['recent_employer_data']['establishment_name'] ?? null,
                            'recent_establishment_id'
                                        => $uanData['result']['summary']['recent_employer_data']['establishment_id'] ?? null,
                            'recent_member_id'
                                        => $uanData['result']['summary']['recent_employer_data']['member_id'] ?? null,

                            'recent_date_of_joining' => $recentJoin,
                            'recent_date_of_exit'    => $recentExit,

                            'http_response_code' => 200,
                            'result_code'        => $uanData['result_code'] ?? null,
                            'request_id'         => $uanData['request_id'] ?? null,
                            'client_ref_num'     => $uanData['client_ref_num'] ?? null,

                            'vendor_response' => json_encode($uanData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now(),
                        ]);
                    }

                    return response()->json($uanData, 200);
                }

                // ---------- FAILED ----------
                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('uan_basic_v4_logs')->insert([
                        'user_id' => $user->id,
                        'api_id'  => $api_id,
                        'uan'     => $request->uan,
                        'http_response_code' => $statusCode,
                        'vendor_response'    => json_encode($uanData),
                        'created_at'         => now(),
                        'updated_at'         => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('uan_basic_v4_logs')->insert([
                        'user_id' => $user->id,
                        'api_id'  => $api_id,
                        'uan'     => $request->uan,
                        'http_response_code' => $statusCode,
                        'vendor_response'    => json_encode($errorResponse),
                        'created_at'         => now(),
                        'updated_at'         => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function employment_uan_v5(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->uan_list) || !is_array($request->uan_list)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'UAN list is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

   
    $user = User::where('access_token', $request->header('AccessToken'))->first();

  
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'employmentuanvfive')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

   
    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
        'uan_list'       => array_values($request->uan_list)
    ];

    
    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

             
                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v5/uan_basic/sync',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

            
                if (
                    $httpResponseCode == 200 &&
                    ($uanData['result_code'] ?? 0) == 101
                ) {

                    
                    $recentJoin = $uanData['result']['summary']['recent_employer_data']['date_of_joining'] ?? null;
                    $recentExit = $uanData['result']['summary']['recent_employer_data']['date_of_exit'] ?? null;

                    $recentJoin = (!empty($recentJoin) && strtotime($recentJoin))
                        ? date('Y-m-d', strtotime($recentJoin)) : null;

                    $recentExit = (!empty($recentExit) && strtotime($recentExit))
                        ? date('Y-m-d', strtotime($recentExit)) : null;

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('uan_basic_v5_logs')->insert([
                            'user_id' => $user->id,
                            'api_id'  => $api_id,

                            'matching_uan'
                                => $uanData['result']['summary']['matching_uan'] ?? null,
                            'uan_count'
                                => $uanData['result']['summary']['uan_count'] ?? null,
                            'is_employed'
                                => $uanData['result']['summary']['is_employed'] ?? null,
                            'date_of_exit_marked'
                                => $uanData['result']['summary']['date_of_exit_marked'] ?? null,

                            'recent_establishment_name'
                                => $uanData['result']['summary']['recent_employer_data']['establishment_name'] ?? null,
                            'recent_establishment_id'
                                => $uanData['result']['summary']['recent_employer_data']['establishment_id'] ?? null,
                            'recent_member_id'
                                => $uanData['result']['summary']['recent_employer_data']['member_id'] ?? null,

                            'recent_date_of_joining' => $recentJoin,
                            'recent_date_of_exit'    => $recentExit,

                            'http_response_code' => 200,
                            'result_code'        => $uanData['result_code'] ?? null,
                            'request_id'         => $uanData['request_id'] ?? null,
                            'client_ref_num'     => $uanData['client_ref_num'] ?? null,

                            
                            'vendor_response' => json_encode($uanData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now(),
                        ]);
                    }

                    return response()->json($uanData, 200);
                }


                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('uan_basic_v5_logs')->insert([
                        'user_id' => $user->id,
                        'api_id'  => $api_id,
                        'http_response_code' => $statusCode,
                        'vendor_response'    => json_encode($uanData),
                        'created_at'         => now(),
                        'updated_at'         => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('uan_basic_v5_logs')->insert([
                        'user_id' => $user->id,
                        'api_id'  => $api_id,
                        'http_response_code' => $statusCode,
                        'vendor_response'    => json_encode($errorResponse),
                        'created_at'         => now(),
                        'updated_at'         => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function employment_uan_advanced_v2(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   
    if (empty($request->employee_name) || empty($request->dob)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Employee name and DOB are required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    
    $user = User::where('access_token', $request->header('AccessToken'))->first();

   
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'employmentuanadvancedvtwo')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    
    $body = [
        'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
        'employee_name'  => $request->employee_name,
        'dob'            => $request->dob
    ];

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type === 'role_postpaid'
        ) {

            try {

               
                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v2/uan_advanced/sync',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();

              
                if (
                    $httpResponseCode === 200 &&
                    ($uanData['result_code'] ?? 0) === 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('uan_advanced_v2_logs')->insert([
                            'user_id' => $user->id,
                            'api_id'  => $api_id,

                            'employee_name' => $request->employee_name,
                            'dob'           => $request->dob,

                            'matching_uan'
                                => $uanData['result']['summary']['matching_uan'] ?? null,
                            'uan_count'
                                => $uanData['result']['summary']['uan_count'] ?? null,
                            'is_employed'
                                => $uanData['result']['summary']['is_employed'] ?? null,
                            'employee_name_match'
                                => $uanData['result']['summary']['employee_name_match'] ?? null,
                            'employer_name_match'
                                => $uanData['result']['summary']['employer_name_match'] ?? null,
                            'name_dob_filtering_score'
                                => $uanData['result']['name_dob_filtering_score'] ?? null,

                            'recent_establishment_name'
                                => $uanData['result']['summary']['recent_employer_data']['establishment_name'] ?? null,
                            'recent_establishment_id'
                                => $uanData['result']['summary']['recent_employer_data']['establishment_id'] ?? null,
                            'recent_member_id'
                                => $uanData['result']['summary']['recent_employer_data']['member_id'] ?? null,

                            'http_response_code' => 200,
                            'result_code'        => $uanData['result_code'] ?? null,
                            'request_id'         => $uanData['request_id'] ?? null,
                            'client_ref_num'     => $uanData['client_ref_num'] ?? null,

                           
                            'vendor_response' => json_encode(
                                $uanData,
                                JSON_UNESCAPED_UNICODE
                            ),

                            'created_at' => now(),
                            'updated_at' => now(),
                        ]);
                    }

                    return response()->json($uanData, 200);
                }

             
                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );

                    DB::table('uan_advanced_v2_logs')->insert([
                        'user_id' => $user->id,
                        'api_id'  => $api_id,
                        'employee_name' => $request->employee_name,
                        'dob'           => $request->dob,
                        'http_response_code' => $statusCode,
                        'vendor_response'    => json_encode($uanData),
                        'created_at'         => now(),
                        'updated_at'         => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Employment UAN Advanced verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode(
                    $e->getResponse()->getBody(),
                    true
                );

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );

                    DB::table('uan_advanced_v2_logs')->insert([
                        'user_id' => $user->id,
                        'api_id'  => $api_id,
                        'employee_name' => $request->employee_name,
                        'dob'           => $request->dob,
                        'http_response_code' => $statusCode,
                        'vendor_response'    => json_encode($errorResponse),
                        'created_at'         => now(),
                        'updated_at'         => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Employment UAN Advanced verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }
    
    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function mobile_prefill(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    
    if (empty($request->mobile_no)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'mobileprefills')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

   
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? 'ref_' . time(),
                    'mobile_no'      => $request->mobile_no,
                    'name_lookup'    => $request->name_lookup ?? 1
                ];

               
                $response = $client->post(
                    'https://svcdemo.digitap.work/mobile_prefill/request',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $mobileData = json_decode($response->getBody(), true);
                $httpResponseCode = $response->getStatusCode();
               
                if (
                    $httpResponseCode == 200 &&
                    ($mobileData['result_code'] ?? 0) == 101
                ) {
                 $mobile_prefill = [];
               
                $mobile_prefill['data']['mobile_number'] = $request->mobile_no ?? null;
                $mobile_prefill['data']['name']          = $mobileData['result']['name'] ?? null;
                $mobile_prefill['data']['dob']           = $mobileData['result']['dob'] ?? null;
                $mobile_prefill['data']['age']           = $mobileData['result']['age'] ?? null;
                $mobile_prefill['data']['gender']        = $mobileData['result']['gender'] ?? null;
                $mobile_prefill['data']['pan']           = $mobileData['result']['pan'] ?? null;
                $mobile_prefill['data']['email']         = $mobileData['result']['email'] ?? null;
                $mobile_prefill['data']['score']         = $mobileData['result']['score'] ?? null;
                $primaryAddress = $mobileData['result']['address'][0] ?? [];
                $mobile_prefill['data']['address_line_1'] = $primaryAddress['first_line_of_address'] ?? null;
                $mobile_prefill['data']['address_line_2'] = $primaryAddress['second_line_of_address'] ?? null;
                $mobile_prefill['data']['address_line_3'] = $primaryAddress['third_line_of_address'] ?? null;
                $mobile_prefill['data']['city']           = $primaryAddress['city'] ?? null;
                $mobile_prefill['data']['state']          = $primaryAddress['state'] ?? null;
                $mobile_prefill['data']['pincode']        = $primaryAddress['postal_code'] ?? null;
                $mobile_prefill['data']['country_code']   = $primaryAddress['country_code'] ?? null;
                $mobile_prefill['data']['reported_date']  = $primaryAddress['reported_date'] ?? null;
                $mobile_prefill['data']['all_addresses'] =$mobileData['result']['address'] ?? [];
                $mobile_prefill['data']['request_id']     = $mobileData['request_id'] ?? null;
                $mobile_prefill['data']['client_ref_num'] = $mobileData['client_ref_num'] ?? null;
                $mobile_prefill['data']['result_code']    = $mobileData['result_code'] ?? null;
                $mobile_prefill['data']['name_lookup_used'] = true;
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                      $primaryAddress = $mobileData['result']['address'][0] ?? [];
                      DB::table('mobile_prefill_logs')->insert
                      ([
                        'user_id'        => $user->id,
                        'api_id'         => $api_id,
                        'mobile_no'      => $request->mobile_no ?? null,
                        'name'           => $mobileData['result']['name'] ?? null,
                        'dob'            => $mobileData['result']['dob'] ?? null,
                        'age'            => $mobileData['result']['age'] ?? null,
                        'gender'         => $mobileData['result']['gender'] ?? null,
                        'pan'            => $mobileData['result']['pan'] ?? null,
                        'email'          => $mobileData['result']['email'] ?? null,
                        'score'          => $mobileData['result']['score'] ?? null,
                        'address_line_1' => $primaryAddress['first_line_of_address'] ?? null,
                        'address_line_2' => $primaryAddress['second_line_of_address'] ?? null,
                        'address_line_3' => $primaryAddress['third_line_of_address'] ?? null,
                        'city'           => $primaryAddress['city'] ?? null,
                        'state'          => $primaryAddress['state'] ?? null,
                        'pincode'        => $primaryAddress['postal_code'] ?? null,
                        'country_code'   => $primaryAddress['country_code'] ?? null,
                        'reported_date'  => $primaryAddress['reported_date'] ?? null,

                        'http_response_code' => 200,
                        'result_code'        => $mobileData['result_code'] ?? null,
                        'request_id'         => $mobileData['request_id'] ?? null,
                        'client_ref_num'     => $mobileData['client_ref_num'] ?? null,
                        'vendor_response'    => json_encode($mobileData, JSON_UNESCAPED_UNICODE),
                        'created_at' => now(),
                        'updated_at' => now(),
                    ]);

                    }

                     return response()->json([ $mobile_prefill, 'status_code' => 200, 'success' => true, 'message' => null, 'message_code' => 'success']);
                }

                
                $statusCode = 102;

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                     DB::table('mobile_prefill_logs')->insert([
                        'user_id'        => $user->id,
                        'api_id'         => $api_id,
                        'mobile_no'      => $request->mobile_no ?? null,
                          'result_code'        => $mobileData['result_code'] ?? null,
                        'request_id'         => $mobileData['request_id'] ?? null,
                        'vendor_response'    => json_encode($mobileData, JSON_UNESCAPED_UNICODE)
                     ]);
                }
        
                return response()->json([
                    $mobile_prefill, 
                    'statusCode' => $statusCode,
                    'message' => $mobileData['message'] ?? 'Mobile prefill failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();
                $errorResponse = json_decode($e->getResponse()->getBody(), true);

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Mobile prefill failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function employment_uan_advanced_v3(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->uan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'UAN is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'uanadvanced')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('uan_'),
                    'uan'            => $request->uan
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v3/uan_advanced/sync',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                 

                if ($statusCode == 200 && ($uanData['result_code'] ?? 0) == 101) {
                  $uan_advanced = [];
         $uan_advanced['data']['uan']              = $request->uan ?? null;
$uan_advanced['data']['client_ref_num']   = $uanData['client_ref_num'] ?? null;
$uan_advanced['data']['request_id']       = $uanData['request_id'] ?? null;
$uan_advanced['data']['result_code']      = $uanData['result_code'] ?? null;
$uan_advanced['data']['mobile']           = $uanData['mobile'] ?? null;


$summary = $uanData['result']['summary'] ?? [];

$uan_advanced['data']['matching_uan']     = $summary['matching_uan'] ?? null;
$uan_advanced['data']['uan_count']        = $summary['uan_count'] ?? null;
$uan_advanced['data']['is_employed']      = $summary['is_employed'] ?? null;
$uan_advanced['data']['date_of_exit_marked']
                                        = $summary['date_of_exit_marked'] ?? null;


$recentEmployer = $summary['recent_employer_data'] ?? [];

$uan_advanced['data']['establishment_name']
    = $recentEmployer['establishment_name'] ?? null;
$uan_advanced['data']['establishment_id']
    = $recentEmployer['establishment_id'] ?? null;
$uan_advanced['data']['member_id']
    = $recentEmployer['member_id'] ?? null;
$uan_advanced['data']['date_of_joining']
    = $recentEmployer['date_of_joining'] ?? null;
$uan_advanced['data']['date_of_exit']
    = $recentEmployer['date_of_exit'] ?? null;
$uan_advanced['data']['leave_reason']
    = $recentEmployer['leave_reason'] ?? null;


$firstUan = $uanData['result']['uan'][0] ?? null;
$uanDetails = $uanData['result']['uan_details'][$firstUan] ?? [];

$basic = $uanDetails['basic_details'] ?? [];

$uan_advanced['data']['name']             = $basic['name'] ?? null;
$uan_advanced['data']['gender']           = $basic['gender'] ?? null;
$uan_advanced['data']['dob']              = $basic['date_of_birth'] ?? null;
$uan_advanced['data']['aadhaar_status']
    = $basic['aadhaar_verification_status'] ?? null;


$additional = $uanDetails['additional_details'] ?? [];

$uan_advanced['data']['email']            = $additional['email'] ?? null;
$uan_advanced['data']['pan']              = $additional['pan'] ?? null;
$uan_advanced['data']['relation']         = $additional['relation'] ?? null;
$uan_advanced['data']['relative_name']    = $additional['relative_name'] ?? null;

$uan_advanced['data']['all_uan_list']
    = $uanData['result']['uan'] ?? [];

$uan_advanced['data']['raw_response']
    = $uanData['result'] ?? [];
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('uan_advanced_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'uan'                => $request->uan,
                            'client_ref_num'     => $uanData['client_ref_num'] ?? null,
                            'request_id'         => $uanData['request_id'] ?? null,
                            'http_response_code' => $uanData['http_response_code'] ?? null,
                            'result_code'        => $uanData['result_code'] ?? null,
                            'matching_uan'       => $summary['matching_uan'] ?? null,
                            'uan_count'          => $summary['uan_count'] ?? null,
                            'is_employed'        => $summary['is_employed'] ?? null,
                            'date_of_exit_marked'=> $summary['date_of_exit_marked'] ?? null,
                            'employee_name'      => $basic['name'] ?? null,
                            'gender'             => $basic['gender'] ?? null,
                            'dob'                => $basic['date_of_birth'] ?? null,
                            'aadhaar_status'     => $basic['aadhaar_verification_status'] ?? null,
                            'establishment_name' => $employment['establishment_name'] ?? $recentEmployer['establishment_name'] ?? null,
                            'establishment_id'   => $employment['establishment_id'] ?? $recentEmployer['establishment_id'] ?? null,
                            'member_id'          => $employment['member_id'] ?? $recentEmployer['member_id'] ?? null,
                            'date_of_joining'    => $employment['date_of_joining'] ?? $recentEmployer['date_of_joining'] ?? null,
                            'date_of_exit'       => $employment['date_of_exit'] ?? $recentEmployer['date_of_exit'] ?? null,
                            'leave_reason'       => $employment['leave_reason'] ?? $recentEmployer['leave_reason'] ?? null,
                            'email'              => $additional['email'] ?? null,
                            'pan'                => $additional['pan'] ?? null,
                            'relation'           => $additional['relation'] ?? null,
                            'relative_name'      => $additional['relative_name'] ?? null,
                            'vendor_response'    => json_encode($uanData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'data'       => $uanData['result']
                    ]);
                }

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 102);
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => $uanData['message'] ?? 'UAN verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function whatsapp_number_check(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'whatsappnumbercheck')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('wnc_'),
                    'mobile'         => $request->mobile
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/dp/v1/whatsapp_number_check',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $waData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                $result = $waData['result'] ?? [];

                if ($statusCode == 200 && ($waData['result_code'] ?? 0) == 101) {
                    $whatsapp_check = [];
                    $whatsapp_check['data']['mobile'] = $request->mobile ?? null;
                    $whatsapp_check['data']['client_ref_num'] = $waData['client_ref_num'] ?? null;
                    $whatsapp_check['data']['request_id']= $waData['request_id'] ?? null;
                    $whatsapp_check['data']['result_code']= $waData['result_code'] ?? null;
                    $result = $waData['result'] ?? [];
                    $whatsapp_check['data']['status']= $result['status'] ?? null;
                    $whatsapp_check['data']['account_found'] = ($result['status'] ?? '') === 'Account Found';
                    $whatsapp_check['data']['is_business'] = ($result['is_business'] ?? '0') == '1';
                    $whatsapp_check['data']['raw_response'] = $waData['result'] ?? [];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('whatsapp_number_check_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'mobile'             => $request->mobile,
                            'client_ref_num'     => $waData['client_ref_num'] ?? null,
                            'request_id'         => $waData['request_id'] ?? null,
                            'http_response_code' => $waData['http_response_code'] ?? null,
                            'result_code'        => $waData['result_code'] ?? null,
                            'status'             => $result['status'] ?? null,
                            'is_business'        => $result['is_business'] ?? null,
                            'vendor_response'    => json_encode($waData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                   return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'WhatsApp number verified successfully',
                        'data'       => $whatsapp_check['data']
                    ]);

                }

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', 102);
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => $waData['message'] ?? 'WhatsApp number verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                  DB::table('whatsapp_number_check_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'mobile'             => $request->mobile,
                            'client_ref_num'     => $waData['client_ref_num'] ?? null,
                            'request_id'         => $waData['request_id'] ?? null,
                            'http_response_code' => $waData['http_response_code'] ?? null,
                            'result_code'        => $waData['result_code'] ?? null,
                        //    'vendor_response'    => json_encode($waData, JSON_UNESCAPED_UNICODE),
                           
                        ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'WhatsApp number verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function whatsapp_advanced(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'whatsappadvanced')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('wa_'),
                    'mobile'         => $request->mobile
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/dp/v1/whatsapp_advanced',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $waData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

              

                /* -------------------------------------------------- */

                if ($statusCode == 200 && ($waData['result_code'] ?? 0) == 101) {
                  $result = $waData['result'] ?? [];

                /* ---------------- PERSONAL RESPONSE ---------------- */

                $whatsapp_advanced = [];

                $whatsapp_advanced['data']['mobile']
                    = $request->mobile ?? null;

                $whatsapp_advanced['data']['client_ref_num']
                    = $waData['client_ref_num'] ?? null;

                $whatsapp_advanced['data']['request_id']
                    = $waData['request_id'] ?? null;

                $whatsapp_advanced['data']['result_code']
                    = $waData['result_code'] ?? null;

                $whatsapp_advanced['data']['account_found']
                    = $result['account_found'] ?? false;

                $whatsapp_advanced['data']['is_business']
                    = $result['is_business'] ?? false;

                $profile = $result['profile_picture'] ?? [];
                $whatsapp_advanced['data']['profile_picture_available']
                    = $profile['available'] ?? false;
                $whatsapp_advanced['data']['profile_picture_error']
                    = $profile['error'] ?? null;

                $statusInfo = $result['status_information'] ?? [];
                $whatsapp_advanced['data']['status_available']
                    = $statusInfo['available'] ?? false;
                $whatsapp_advanced['data']['status_message']
                    = $statusInfo['message'] ?? null;

                $deviceInfo = $result['device_information'] ?? [];
                $whatsapp_advanced['data']['device_available']
                    = $deviceInfo['available'] ?? false;
                $whatsapp_advanced['data']['device_count']
                    = $deviceInfo['device_count'] ?? 0;
                $whatsapp_advanced['data']['devices']
                    = $deviceInfo['devices'] ?? [];

                $businessInfo = $result['business_information'] ?? [];
                $whatsapp_advanced['data']['business_account']
                    = $businessInfo['is_business'] ?? false;

                $whatsapp_advanced['data']['raw_response']
                    = $result ?? [];
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('whatsapp_advanced_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'mobile'             => $request->mobile,
                            'client_ref_num'     => $waData['client_ref_num'] ?? null,
                            'request_id'         => $waData['request_id'] ?? null,
                            'http_response_code' => $waData['http_response_code'] ?? null,
                            'result_code'        => $waData['result_code'] ?? null,
                            'account_found'      => $result['account_found'] ?? false,
                            'is_business'        => $result['is_business'] ?? false,
                            'device_count'       => $deviceInfo['device_count'] ?? 0,
                            'vendor_response'    => json_encode($waData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'WhatsApp advanced verification successful',
                        'data'       => $whatsapp_advanced['data']
                    ]);
                }

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => $waData['message'] ?? 'WhatsApp advanced verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'WhatsApp advanced verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function contact_to_gst(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

  

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'contacttogst')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

               

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'mobile'         => $request->mobile,
                    'client_ref_num' => $request->client_ref_num ?? uniqid('ctg_')
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/contact_to_gst',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $gstData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                

               

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($gstData['result_code'] ?? 0) == 101) {
                 $contact_to_gst = [];

                $contact_to_gst['data']['mobile']
                    = $request->mobile ?? null;

                $contact_to_gst['data']['client_ref_num']
                    = $gstData['client_ref_num'] ?? null;

                $contact_to_gst['data']['request_id']
                    = $gstData['request_id'] ?? null;

                $contact_to_gst['data']['result_code']
                    = $gstData['result_code'] ?? null;

                $contact_to_gst['data']['gst_list']
                    = $gstData['result'] ?? [];

                $contact_to_gst['data']['gst_count']
                    = is_array($gstData['result'] ?? null)
                        ? count($gstData['result'])
                        : 0;

              
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('contact_to_gst_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'mobile'             => $request->mobile,
                            'client_ref_num'     => $gstData['client_ref_num'] ?? null,
                            'request_id'         => $gstData['request_id'] ?? null,
                            'http_response_code' => $gstData['http_response_code'] ?? null,
                            'result_code'        => $gstData['result_code'] ?? null,
                            'gst_count'          => count($gstData['result'] ?? []),
                            'vendor_response'    => json_encode($gstData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'GST details fetched successfully',
                        'data'       => $contact_to_gst['data']
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => $gstData['message'] ?? 'GST lookup failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'GST lookup failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function gst_to_contacts(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- VALIDATIONS ---------------- */

    if (empty($request->gstin)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'GSTIN is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'gsttocontacts'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

            

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'gstin'          => $request->gstin,
                    'client_ref_num' => $request->client_ref_num ?? uniqid('gtc_')
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/gst/gst_to_contacts',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $gstData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

               
               

                if ($statusCode == 200 && ($gstData['result_code'] ?? 0) == 101) {
                   $gst_to_contacts = [];

                $gst_to_contacts['data']['gstin']
                    = $request->gstin ?? null;

                $gst_to_contacts['data']['client_ref_num']
                    = $gstData['client_ref_num'] ?? null;

                $gst_to_contacts['data']['request_id']
                    = $gstData['request_id'] ?? null;

                $gst_to_contacts['data']['result_code']
                    = $gstData['result_code'] ?? null;

                $result = $gstData['result'] ?? [];

                $gst_to_contacts['data']['mobile']
                    = $result['mobile'] ?? null;

                $gst_to_contacts['data']['email']
                    = $result['email'] ?? null;

               
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('gst_to_contacts_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'gstin'              => $request->gstin,
                            'mobile'             => $result['mobile'] ?? null,
                            'email'              => $result['email'] ?? null,
                            'client_ref_num'     => $gstData['client_ref_num'] ?? null,
                            'request_id'         => $gstData['request_id'] ?? null,
                            'http_response_code' => $gstData['http_response_code'] ?? null,
                            'result_code'        => $gstData['result_code'] ?? null,
                            'vendor_response'    => json_encode($gstData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'GST contact details fetched successfully',
                        'data'       => $gst_to_contacts['data']
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => $gstData['message'] ?? 'GST contact lookup failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'GST contact lookup failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function ecom_generate_url(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    

    

    if (empty($request->txn_completed_cburl)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Transaction callback URL is required'
        ]);
    }

    if (empty($request->return_url)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Return URL is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'ecomgenerateurl'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'payload' => [
                        'client_ref_num'       => 'test',
                        'txn_completed_cburl'  => $request->txn_completed_cburl,
                        'return_url'           => $request->return_url,
                        'website'              => $request->website ?? '1'
                    ]
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/ecom-data/generateurl',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $ecomData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();
                if ($statusCode == 200 && ($ecomData['status'] ?? '') === 'success') {
                  $ecom_generate = [];

                $ecom_generate['data']['client_ref_num']
                    = $request->client_ref_num ?? null;

                $ecom_generate['data']['request_id']
                    = $ecomData['request_id'] ?? null;

                $ecom_generate['data']['status']
                    = $ecomData['status'] ?? null;

                $ecom_generate['data']['url']
                    = $ecomData['url'] ?? null;

                $ecom_generate['data']['expires']
                    = $ecomData['expires'] ?? null;

               
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('ecom_generate_url_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'client_ref_num'     => $request->client_ref_num,
                            'request_id'         => $ecomData['request_id'] ?? null,
                            'status'             => $ecomData['status'] ?? null,
                            'url'                => $ecomData['url'] ?? null,
                            'expires'            => $ecomData['expires'] ?? null,
                            'vendor_response'    => json_encode($ecomData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'E-commerce transaction URL generated successfully',
                        'data'       => $ecom_generate['data']
                    ]);
                }

                

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => $ecomData['message'] ?? 'Failed to generate e-commerce URL'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to generate e-commerce URL'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function ecom_url_username(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    
    $payload = $request->payload ?? [];

   

    if (empty($payload['client_ref_num'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Client reference number is required'
        ]);
    }

    if (empty($payload['txn_completed_cburl'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Transaction callback URL is required'
        ]);
    }

    if (empty($payload['return_url'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Return URL is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'ecomurlusername'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'payload' => [
                        'client_ref_num'      => $payload['client_ref_num'],
                        'txn_completed_cburl' => $payload['txn_completed_cburl'],
                        'return_url'          => $payload['return_url'],
                        'username'            => $payload['username'] ?? null,
                        'is_editable'         => $payload['is_editable'] ?? 'false'
                    ]
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/ecom-data/generateurl',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $ecomData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

              

                

                if ($statusCode == 200 && ($ecomData['status'] ?? '') === 'success') {
                
                $ecom_generate = [];

                $ecom_generate['data']['client_ref_num']
                    = $payload['client_ref_num'];

                $ecom_generate['data']['request_id']
                    = $ecomData['request_id'] ?? null;

                $ecom_generate['data']['status']
                    = $ecomData['status'] ?? null;

                $ecom_generate['data']['url']
                    = $ecomData['url'] ?? null;

                $ecom_generate['data']['expires']
                    = $ecomData['expires'] ?? null;

                $ecom_generate['data']['username']
                    = $payload['username'] ?? null;

                $ecom_generate['data']['is_editable']
                    = ($payload['is_editable'] ?? 'false') === 'true';

                

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('ecom_url_username')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'client_ref_num'     => $payload['client_ref_num'],
                            'request_id'         => $ecomData['request_id'] ?? null,
                            'status'             => $ecomData['status'] ?? null,
                            'url'                => $ecomData['url'] ?? null,
                            'expires'            => $ecomData['expires'] ?? null,
                            'vendor_response'    => json_encode($ecomData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'E-commerce transaction URL generated successfully',
                        'data'       => $ecom_generate['data']
                    ]);
                }

               

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => $ecomData['message'] ?? 'Failed to generate e-commerce URL'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to generate e-commerce URL'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function ecom_generate_url_username(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   
    $payload = $request->payload ?? [];

   
    if (empty($payload['client_ref_num'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Client reference number is required'
        ]);
    }

    if (empty($payload['txn_completed_cburl'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Transaction callback URL is required'
        ]);
    }

    if (empty($payload['return_url'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Return URL is required'
        ]);
    }

    if (empty($payload['username'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Username is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'ecomurlnonedit'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'payload' => [
                        'client_ref_num'      => $payload['client_ref_num'],
                        'txn_completed_cburl' => $payload['txn_completed_cburl'],
                        'return_url'          => $payload['return_url'],
                        'username'            => $payload['username'],
                        'is_editable'         => $payload['is_editable'] ?? 'false'
                    ]
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/ecom-data/generateurl',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $ecomData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                
               

                

                if ($statusCode == 200 && ($ecomData['status'] ?? '') === 'success') {
                 $ecom_generate = [];

                $ecom_generate['data']['client_ref_num']
                    = $payload['client_ref_num'];

                $ecom_generate['data']['request_id']
                    = $ecomData['request_id'] ?? null;

                $ecom_generate['data']['status']
                    = $ecomData['status'] ?? null;

                $ecom_generate['data']['url']
                    = $ecomData['url'] ?? null;

                $ecom_generate['data']['expires']
                    = $ecomData['expires'] ?? null;

                $ecom_generate['data']['username']
                    = $payload['username'];

                $ecom_generate['data']['is_editable']
                    = ($payload['is_editable'] ?? 'false') === 'true';
                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('ecom_url_username_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'client_ref_num'     => $payload['client_ref_num'],
                            'request_id'         => $ecomData['request_id'] ?? null,
                            'status'             => $ecomData['status'] ?? null,
                            'url'                => $ecomData['url'] ?? null,
                            'expires'            => $ecomData['expires'] ?? null,
                            'vendor_response'    => json_encode($ecomData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'E-commerce transaction URL generated successfully',
                        'data'       => $ecom_generate['data']
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to generate e-commerce URL'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to generate e-commerce URL'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function tan_to_company(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   

    if (empty($request->tan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'TAN number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'tantocompany'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

  

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

              

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'tan'            => $request->tan,
                    'client_ref_num' => $request->client_ref_num ?? uniqid('tan_')
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/tan_to_company',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $tanData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

               

               
            
                if ($statusCode == 200 && ($tanData['result_code'] ?? 0) == 101) {
                  $result = $tanData['result'] ?? [];

                $tan_company = [];

                $tan_company['data']['tan_number']
                    = $result['tan_number'] ?? null;
                $tan_company['data']['company_name']
                    = $result['company_name'] ?? null;
                $tan_company['data']['status']
                    = $result['status'] ?? null;
                $tan_company['data']['tan_allotment_date']
                    = $result['tan_allotment_date'] ?? null;
                $tan_company['data']['filing_date']
                    = $result['filing_date'] ?? null;
                $tan_company['data']['phone_number']
                    = $result['phone_number'] ?? null;
                $tan_company['data']['email_id']
                    = $result['email_id'] ?? null;

                $tan_company['data']['address']
                    = $result['address'] ?? null;

                $tan_company['data']['client_ref_num']
                    = $tanData['client_ref_num'] ?? null;
                $tan_company['data']['request_id']
                    = $tanData['request_id'] ?? null;
                $tan_company['data']['result_code']
                    = $tanData['result_code'] ?? null;

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('tan_to_company_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'tan'                => $request->tan,
                            'client_ref_num'     => $tanData['client_ref_num'] ?? null,
                            'request_id'         => $tanData['request_id'] ?? null,
                            'http_response_code' => $tanData['http_response_code'] ?? null,
                            'result_code'        => $tanData['result_code'] ?? null,
                            'company_name'       => $result['company_name'] ?? null,
                            'status'             => $result['status'] ?? null,
                            'phone_number'       => $result['phone_number'] ?? null,
                            'email_id'           => $result['email_id'] ?? null,
                            'address'            => json_encode($result['address'] ?? []),
                            'vendor_response'    => json_encode($tanData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'TAN details fetched successfully',
                        'data'       => $tan_company['data']
                    ]);
                }
                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'TAN verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'TAN verification failed'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function ecom_url_order_duration(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

  
    $payload = $request->payload ?? [];

    

    if (empty($payload['client_ref_num'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Client reference number is required'
        ]);
    }

    if (empty($payload['txn_completed_cburl'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Transaction callback URL is required'
        ]);
    }

    if (empty($payload['return_url'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Return URL is required'
        ]);
    }

    if (empty($payload['order_duration'])) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Order duration is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'ecomorder'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

   
    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                

                $client = new Client();

                $headers = [
                    'Content-Type'  => 'application/json',
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $body = [
                    'payload' => [
                        'client_ref_num'      => $payload['client_ref_num'],
                        'txn_completed_cburl' => $payload['txn_completed_cburl'],
                        'return_url'          => $payload['return_url'],
                        'order_duration'      => $payload['order_duration']
                    ]
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/ecom-data/generateurl',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $ecomData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                
             

               

                if ($statusCode == 200 && ($ecomData['status'] ?? '') === 'success') {
                       $ecom_generate = [];

                $ecom_generate['data']['client_ref_num']
                    = $payload['client_ref_num'];
                $ecom_generate['data']['request_id']
                    = $ecomData['request_id'] ?? null;
                $ecom_generate['data']['status']
                    = $ecomData['status'] ?? null;
                $ecom_generate['data']['url']
                    = $ecomData['url'] ?? null;
                $ecom_generate['data']['expires']
                    = $ecomData['expires'] ?? null;
                $ecom_generate['data']['order_duration']
                    = $payload['order_duration'];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('ecom_generate_url_order_duration_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'client_ref_num'     => $payload['client_ref_num'],
                            'order_duration'     => $payload['order_duration'],
                            'request_id'         => $ecomData['request_id'] ?? null,
                            'status'             => $ecomData['status'] ?? null,
                            'url'                => $ecomData['url'] ?? null,
                            'expires'            => $ecomData['expires'] ?? null,
                            'vendor_response'    => json_encode($ecomData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'E-commerce transaction URL generated successfully',
                        'data'       => $ecom_generate['data']
                    ]);
                }

            

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to generate e-commerce URL'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to generate e-commerce URL'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function ecom_websites_list(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'ecomwebsite'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL (GET) ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                ];

                $response = $client->get(
                    'https://svcdemo.digitap.work/ecom-data/websites',
                    [
                        'headers' => $headers,
                        'timeout' => 30
                    ]
                );

                $websitesData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($websitesData['status'] ?? '') === 'success') {

                    /* -------- PERSONAL RESPONSE -------- */

                    $upiResponse = [];
                    $upiResponse['data'] = [];

                    foreach ($websitesData['data'] as $site) {
                        $upiResponse['data'][] = [
                            'id'   => $site['id'] ?? null,
                            'name' => $site['name'] ?? null,
                            'type' => $site['type'] ?? null
                        ];
                    }

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('ecom_websites_logs')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,
                            'status'          => $websitesData['status'] ?? null,
                            'vendor_response' => json_encode($websitesData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'E-commerce websites fetched successfully',
                        'data'       => $upiResponse['data']
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch e-commerce websites'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch e-commerce websites'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function mobile_upi_lookup(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'mobileupilookup'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            /* ---------------- INPUT VALIDATION ---------------- */

            if (empty($request->mobile)) {
                return response()->json([
                    'statusCode' => 404,
                    'message' => 'Mobile number is required'
                ]);
            }

            try {

                /* ---------------- DIGITAP CALL (POST) ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('upi_'),
                    'mobile'         => $request->mobile
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/misc/v1/mobile-upi-lookup',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $upiData   = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($upiData['result_code'] ?? '') == 101) {

                    $upiResponse = [
                        'mobile_linked_name' => $upiData['result']['mobile_linked_name'] ?? null,
                        'vpa'                => $upiData['result']['vpa'] ?? null
                    ];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('mobile_upi_lookup_logs')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,
                            'client_ref_num'  => $upiData['client_ref_num'] ?? null,
                            'request_id'      => $upiData['request_id'] ?? null,
                            'mobile'          => $request->mobile,
                            'upi_name'        => $upiData['result']['mobile_linked_name'] ?? null,
                            'vpa'             => $upiData['result']['vpa'] ?? null,
                            'result_code'     => $upiData['result_code'] ?? null,
                            'status_code'     => $statusCode,
                            'vendor_response' => json_encode($upiData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Mobile UPI details fetched successfully',
                        'data'       => $upiResponse
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch mobile UPI details'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch mobile UPI details'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function mobile_upi_name(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where(
        'access_token',
        $request->header('AccessToken')
    )->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where(
            'api_slug',
            'mobileupilookup'
        )->first();

        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            /* ---------------- INPUT VALIDATION ---------------- */

            if (empty($request->mobile)) {
                return response()->json([
                    'statusCode' => 404,
                    'message' => 'Mobile number is required'
                ]);
            }

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('upi_'),
                    'mobile'         => $request->mobile,
                    'name'           => $request->name ?? null
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/misc/v1/mobile-upi-lookup',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $upiData    = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($upiData['result_code'] ?? '') == 101) {

                    /* -------- PERSONAL RESPONSE -------- */

                   $upiResponse = [];
                   $upiResponse['data'] = [
                        'mobile_linked_name' => $upiData['result']['mobile_linked_name'] ?? null,
                        'vpa'                => $upiData['result']['vpa'] ?? null,
                        'name_match'         => $upiData['result']['name_match'] ?? null,
                        'name_match_score'   => $upiData['result']['name_match_score'] ?? null
                    ];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('mobile_upi_lookup_name')->insert([
                            'user_id'          => $user->id,
                            'api_id'           => $api_id,
                            'client_ref_num'   => $upiData['client_ref_num'] ?? null,
                            'request_id'       => $upiData['request_id'] ?? null,
                            'mobile'           => $request->mobile,
                            'upi_name'         => $upiData['result']['mobile_linked_name'] ?? null,
                            'vpa'              => $upiData['result']['vpa'] ?? null,
                            'name_match'       => $upiData['result']['name_match'] ?? null,
                            'name_match_score' => $upiData['result']['name_match_score'] ?? null,
                            'result_code'      => $upiData['result_code'] ?? null,
                            'status_code'      => $statusCode,
                            'vendor_response'  => json_encode($upiData, JSON_UNESCAPED_UNICODE),
                            'created_at'       => now(),
                            'updated_at'       => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Mobile UPI details fetched successfully',
                        'data'       =>$upiResponse['data']
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch mobile UPI details'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch mobile UPI details'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function uan_basic_pan(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    /* ---------------- INPUT VALIDATION ---------------- */

    if (empty($request->pan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'PAN number is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    /* ---------------- API MASTER ---------------- */

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'uanbasicpan')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('uan_'),
                    'pan'            => $request->pan
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v3/uan_basic/sync',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData    = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($uanData['result_code'] ?? '') == 101) {

                    $pan = [
                        'uan_list'        => $uanData['result']['uan'] ?? [],
                        'uan_count'       => $uanData['result']['summary']['uan_count'] ?? 0,
                        'is_employed'     => $uanData['result']['summary']['is_employed'] ?? null,
                        'recent_employer' => $uanData['result']['summary']['recent_employer_data'] ?? null,
                        'uan_details'     => $uanData['result']['uan_details'] ?? null
                    ];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('uan_basic_pan')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,
                            'client_ref_num'  => $uanData['client_ref_num'] ?? null,
                            'request_id'      => $uanData['request_id'] ?? null,
                            'pan'             => $request->pan,
                            'uan_count'       => $uanData['result']['summary']['uan_count'] ?? null,
                            'is_employed'     => $uanData['result']['summary']['is_employed'] ?? null,
                            'result_code'     => $uanData['result_code'] ?? null,
                            'status_code'     => $statusCode,
                            'vendor_response' => json_encode($uanData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'UAN details fetched successfully',
                        'data'       => $pan
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch UAN details'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch UAN details'
                ]);
            }

        } else {
           
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
    
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

public function uan_basic_pan_v4(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    /* ---------------- INPUT VALIDATION ---------------- */

    if (empty($request->pan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'PAN number is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    /* ---------------- API MASTER ---------------- */

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'uanbasicvfour')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('uan_'),
                    'pan'            => $request->pan
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v4/uan_basic/sync',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData    = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($uanData['result_code'] ?? '') == 101) {

                    $UanResponse = [
                        'uan_list'           => $uanData['result']['uan'] ?? [],
                        'uan_count'          => $uanData['result']['summary']['uan_count'] ?? 0,
                        'is_employed'        => $uanData['result']['summary']['is_employed'] ?? null,
                        'recent_employer'    => $uanData['result']['summary']['recent_employer_data'] ?? null,
                        'employment_history' => $uanData['result']['summary']['employment_history'] ?? [],
                        'uan_details'        => $uanData['result']['uan_details'] ?? null
                    ];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('uan_basic_v4_logs')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,
                            'client_ref_num'  => $uanData['client_ref_num'] ?? null,
                            'request_id'      => $uanData['request_id'] ?? null,
                            'pan'             => $request->pan,
                            'uan_count'       => $uanData['result']['summary']['uan_count'] ?? null,
                            'is_employed'     => $uanData['result']['summary']['is_employed'] ?? null,
                            'result_code'     => $uanData['result_code'] ?? null,
                            'status_code'     => $statusCode,
                            'vendor_response' => json_encode($uanData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'UAN details fetched successfully',
                        'data'       => $UanResponse
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch UAN details'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch UAN details'
                ]);
            }

        } else {
            
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function pan_to_din(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    /* ---------------- INPUT VALIDATION ---------------- */

    if (empty($request->pan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'PAN number is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    /* ---------------- API MASTER ---------------- */

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'pantodin')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'pan'            => $request->pan,
                    'client_ref_num' => $request->client_ref_num ?? uniqid('din_')
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/pan_to_din',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $dinData    = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($dinData['result_code'] ?? '') == 101) {

                    $PanResponse = [
                        'din' => $dinData['result']['din'] ?? null
                    ];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('pan_to_din_logs')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,
                            'client_ref_num'  => $dinData['client_ref_num'] ?? null,
                            'request_id'      => $dinData['request_id'] ?? null,
                            'pan'             => $request->pan,
                            'din'             => $dinData['result']['din'] ?? null,
                            'result_code'     => $dinData['result_code'] ?? null,
                            'status_code'     => $statusCode,
                            'vendor_response' => json_encode($dinData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'DIN fetched successfully',
                        'data'       => $PanResponse
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch DIN'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch DIN'
                ]);
            }

        } else {

            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {

        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function mobile_with_name_lookup(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;



    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

   

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    if (empty($request->name)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Name is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

   

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'mobilenamelookupvone')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

   

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

            

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('mnl_'),
                    'mobile'         => $request->mobile,
                    'name'           => $request->name
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/misc/v1/mobile-name-lookup',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $lookupData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($lookupData['result_code'] ?? '') == 101) {

                   $mobileResponse = [
                        'mobile_linked_name' => $lookupData['result']['mobile_linked_name'] ?? null,
                        'name_match'         => $lookupData['result']['name_match'] ?? false,
                        'name_match_score'   => $lookupData['result']['name_match_score'] ?? null
                    ];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('mobile_with_name_lookup')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'client_ref_num'     => $lookupData['client_ref_num'] ?? null,
                            'request_id'         => $lookupData['request_id'] ?? null,
                            'mobile'             => $request->mobile,
                            'input_name'         => $request->name,
                            'mobile_linked_name' => $lookupData['result']['mobile_linked_name'] ?? null,
                            'name_match'         => $lookupData['result']['name_match'] ?? null,
                            'name_match_score'   => $lookupData['result']['name_match_score'] ?? null,
                            'result_code'        => $lookupData['result_code'] ?? null,
                            'status_code'        => $statusCode,
                            'vendor_response'    => json_encode($lookupData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Mobile name lookup successful',
                        'data'       =>$mobileResponse
                    ]);
                }

              
                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to verify mobile name'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to verify mobile name'
                ]);
            }

        } else {

            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {

        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function mobile_number_lookup(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    

    if (empty($request->mobile_number)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

   

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'mobilenumberlookup')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

 

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

              
                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('ml_'),
                    'mobile_number'  => $request->mobile_number
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/mobile/v1/mobile-lookup',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $lookupData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

               
                if ($statusCode == 200 && ($lookupData['result_code'] ?? '') == 101) {

                    $mobileResponse = [
                        'customer_details'        => $lookupData['result']['customer_details'] ?? null,
                        'is_valid'                => $lookupData['result']['is_valid'] ?? null,
                        'subscriber_status'       => $lookupData['result']['subscriber_status'] ?? null,
                        'connection_status'       => $lookupData['result']['connection_status'] ?? null,
                        'connection_type'         => $lookupData['result']['connection_type'] ?? null,
                        'msisdn'                  => $lookupData['result']['msisdn'] ?? null,
                        'current_service_provider'=> $lookupData['result']['current_service_provider'] ?? null,
                        'original_service_provider'=> $lookupData['result']['original_service_provider'] ?? null,
                        'is_ported'               => $lookupData['result']['is_ported'] ?? null,
                        'last_ported_date'        => $lookupData['result']['last_ported_date'] ?? null,
                        'porting_history'         => $lookupData['result']['porting_history'] ?? [],
                        'mobile_vintage'          => $lookupData['result']['mobile_vintage'] ?? []
                    ];

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('mobile_number_lookup')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,
                            'client_ref_num'  => $lookupData['client_ref_num'] ?? null,
                            'request_id'      => $lookupData['request_id'] ?? null,
                            'mobile_number'   => $request->mobile_number,
                            'is_valid'        => $lookupData['result']['is_valid'] ?? null,
                            'subscriber_status'=> $lookupData['result']['subscriber_status'] ?? null,
                            'connection_type' => $lookupData['result']['connection_type'] ?? null,
                            'result_code'     => $lookupData['result_code'] ?? null,
                            'status_code'     => $statusCode,
                            'vendor_response' => json_encode($lookupData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Mobile lookup successful',
                        'data'       => $mobileResponse
                    ]);
                }

                

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch mobile details'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch mobile details'
                ]);
            }

        } else {

            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {

        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function mobile_lookup_porting_history(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    /* ---------------- INPUT VALIDATION ---------------- */

    if (empty($request->mobile_number)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    /* ---------------- API MASTER ---------------- */

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'mobileportinghistory')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

   

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('mph_'),
                    'mobile_number'  => $request->mobile_number,
                    'options'        => ['porting_history']
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/mobile/v1/mobile-lookup',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $lookupData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($lookupData['result_code'] ?? '') == 101) {

                   $mobileResponse = $lookupData['result'] ?? [];
                   $mobileResponse = [
    'customer_details'          => $lookupData['result']['customer_details'] ?? null,
    'is_valid'                  => $lookupData['result']['is_valid'] ?? null,
    'subscriber_status'         => $lookupData['result']['subscriber_status'] ?? null,
    'connection_status'         => $lookupData['result']['connection_status'] ?? null,
    'connection_type'           => $lookupData['result']['connection_type'] ?? null,
    'msisdn'                    => $lookupData['result']['msisdn'] ?? null,
    'current_service_provider'  => $lookupData['result']['current_service_provider'] ?? null,
    'original_service_provider' => $lookupData['result']['original_service_provider'] ?? null,
    'is_ported'                 => $lookupData['result']['is_ported'] ?? null,
    'last_ported_date'          => $lookupData['result']['last_ported_date'] ?? null,
    'porting_history'           => $lookupData['result']['porting_history'] ?? [],
    'mobile_vintage'            => $lookupData['result']['mobile_vintage'] ?? []
];

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('mobile_porting_history_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,
                            'client_ref_num'     => $lookupData['client_ref_num'] ?? null,
                            'request_id'         => $lookupData['request_id'] ?? null,
                            'mobile_number'      => $request->mobile_number,
                            'is_ported'          => $lookupData['result']['is_ported'] ?? null,
                            'last_ported_date'   => $lookupData['result']['last_ported_date'] ?? null,
                            'porting_history'    => json_encode($lookupData['result']['porting_history'] ?? []),
                            'result_code'        => $lookupData['result_code'] ?? null,
                            'status_code'        => $statusCode,
                            'vendor_response'    => json_encode($lookupData, JSON_UNESCAPED_UNICODE),
                            'created_at'         => now(),
                            'updated_at'         => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Mobile porting history fetched successfully',
                        'data'       =>$mobileResponse
                    ]);
                }


                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch mobile porting history'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch mobile porting history'
                ]);
            }

        } else {

            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {

        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function mobile_lookup_customer_details(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    /* ---------------- INPUT VALIDATION ---------------- */

    if (empty($request->mobile_number)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    /* ---------------- API MASTER ---------------- */

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'mobilecustomerdetails')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('mcd_'),
                    'mobile_number'  => $request->mobile_number,
                    'options'        => ['customer_details']
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/mobile/v1/mobile-lookup',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $lookupData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($lookupData['result_code'] ?? '') == 101) {

                    $mobileResponse = [
                        'customer_details'          => $lookupData['result']['customer_details'] ?? null,
                        'is_valid'                  => $lookupData['result']['is_valid'] ?? null,
                        'subscriber_status'         => $lookupData['result']['subscriber_status'] ?? null,
                        'connection_status'         => $lookupData['result']['connection_status'] ?? null,
                        'connection_type'           => $lookupData['result']['connection_type'] ?? null,
                        'msisdn'                    => $lookupData['result']['msisdn'] ?? null,
                        'current_service_provider'  => $lookupData['result']['current_service_provider'] ?? null,
                        'original_service_provider' => $lookupData['result']['original_service_provider'] ?? null,
                        'is_ported'                 => $lookupData['result']['is_ported'] ?? null,
                        'last_ported_date'          => $lookupData['result']['last_ported_date'] ?? null,
                        'porting_history'           => $lookupData['result']['porting_history'] ?? [],
                        'mobile_vintage'            => $lookupData['result']['mobile_vintage'] ?? []
                    ];

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('mobile_customer_details_logs')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,
                            'client_ref_num'  => $lookupData['client_ref_num'] ?? null,
                            'request_id'      => $lookupData['request_id'] ?? null,
                            'mobile_number'   => $request->mobile_number,
                            'subscriber_status'=> $lookupData['result']['subscriber_status'] ?? null,
                            'connection_type' => $lookupData['result']['connection_type'] ?? null,
                            'result_code'     => $lookupData['result_code'] ?? null,
                            'status_code'     => $statusCode,
                            'vendor_response' => json_encode($lookupData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Mobile customer details fetched successfully',
                        'data'       => $mobileResponse
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch mobile customer details'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch mobile customer details'
                ]);
            }

        } else {

            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {

        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function mobile_vintage_lookup(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'mobilevintage')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }


    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'mobile'         => $request->mobile,
                    'client_ref_num' => $request->client_ref_num ?? uniqid('mv_')
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/misc/v1/mobile-vintage-lookup',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $vintageData = json_decode($response->getBody(), true);
                $statusCode  = $response->getStatusCode();

               

                if ($statusCode == 200 && ($vintageData['result_code'] ?? '') == 101) {

                    $mobileResponse = [
                        'mobile_tenure'    => $vintageData['result']['mobile_tenure'] ?? null,
                        'last_deactivated' => $vintageData['result']['last_deactivated'] ?? null
                    ];

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('mobile_vintage_logs')->insert([
                            'user_id'        => $user->id,
                            'api_id'         => $api_id,
                            'client_ref_num' => $vintageData['client_ref_num'] ?? null,
                            'request_id'     => $vintageData['request_id'] ?? null,
                            'mobile'         => $request->mobile,
                            'tenure_min'     => $vintageData['result']['mobile_tenure']['min'] ?? null,
                            'tenure_max'     => $vintageData['result']['mobile_tenure']['max'] ?? null,
                            'deactivated_min'=> $vintageData['result']['last_deactivated']['min'] ?? null,
                            'deactivated_max'=> $vintageData['result']['last_deactivated']['max'] ?? null,
                            'result_code'    => $vintageData['result_code'] ?? null,
                            'status_code'    => $statusCode,
                            'vendor_response'=> json_encode($vintageData, JSON_UNESCAPED_UNICODE),
                            'created_at'     => now(),
                            'updated_at'     => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Mobile vintage fetched successfully',
                        'data'       => $mobileResponse
                    ]);
                }

    

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch mobile vintage'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch mobile vintage'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function uan_basic_mobile_name(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- HEADER VALIDATION ---------------- */

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    /* ---------------- INPUT VALIDATION ---------------- */

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    if (empty($request->employee_name)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Employee name is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    /* ---------------- API MASTER ---------------- */

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'uanbasicmobile')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('uan_'),
                    'mobile'         => $request->mobile,
                    'employee_name'  => $request->employee_name
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/uan_basic',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData   = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($uanData['result_code'] ?? '') == 101) {

                    $uanResponse = [
                        'uan_list'    => $uanData['result']['uan'] ?? [],
                        'summary'     => $uanData['result']['summary'] ?? null,
                        'uan_details' => $uanData['result']['uan_details'] ?? null,
                        'uan_source'  => $uanData['result']['uan_source'] ?? []
                    ];

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('uan_basic_mobile_logs')->insert([
                            'user_id'        => $user->id,
                            'api_id'         => $api_id,
                            'client_ref_num' => $uanData['client_ref_num'] ?? null,
                            'request_id'     => $uanData['request_id'] ?? null,
                            'mobile'         => $request->mobile,
                            'employee_name'  => $request->employee_name,
                            'uan_count'      => $uanData['result']['summary']['uan_count'] ?? null,
                            'is_employed'    => $uanData['result']['summary']['is_employed'] ?? null,
                            'result_code'    => $uanData['result_code'] ?? null,
                            'status_code'    => $statusCode,
                            'vendor_response'=> json_encode($uanData, JSON_UNESCAPED_UNICODE),
                            'created_at'     => now(),
                            'updated_at'     => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'UAN details fetched successfully',
                        'data'       => $uanResponse
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch UAN details'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch UAN details'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function uan_basic_mobile(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    /* ---------------- INPUT VALIDATION ---------------- */

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    /* ---------------- API MASTER ---------------- */

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'uanbasic')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    /* ---------------- PLAN CHECK ---------------- */

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        /* ---------------- WALLET CHECK ---------------- */

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                /* ---------------- DIGITAP API CALL ---------------- */

                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'mobile'         => $request->mobile,
                    'client_ref_num' => $request->client_ref_num ?? uniqid('uan_')
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/uan_basic',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $uanData = json_decode($response->getBody(), true);
                $statusCode = $response->getStatusCode();

                /* ---------------- SUCCESS ---------------- */

                if ($statusCode == 200 && ($uanData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('uan_basic')->insert([
                            'user_id'        => $user->id,
                            'api_id'         => $api_id,
                            'client_ref_num' => $uanData['client_ref_num'] ?? null,
                            'request_id'     => $uanData['request_id'] ?? null,
                            'mobile'         => $request->mobile,
                            'employee_name'  => $uanData['employee_name'] ?? null,
                            'uan_count'      => $uanData['result']['summary']['uan_count'] ?? null,
                            'is_employed'    => $uanData['result']['summary']['is_employed'] ?? null,
                            'result_code'    => $uanData['result_code'] ?? null,
                            'status_code'    => 200,
                            'vendor_response'=> json_encode($uanData, JSON_UNESCAPED_UNICODE),
                            'created_at'     => now(),
                            'updated_at'     => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'UAN details fetched successfully',
                        'data'       => $uanData
                    ]);
                }

                /* ---------------- FAILURE ---------------- */

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => $uanData['message'] ?? 'UAN verification failed'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'UAN verification failed'
                ]);
            }

        } else {

          

            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {

        /* ---------------- PLAN NOT ACTIVE ---------------- */

        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
 public function company_search_v1(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;
    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

   

    if (empty($request->employer_name)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Employer name is required'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

  
    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'companysearchvone')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {


                $client = new Client();

                $headers = [
                    'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA=',
                    'Content-Type'  => 'application/json'
                ];

                $body = [
                    'client_ref_num' => $request->client_ref_num ?? uniqid('cmp_'),
                    'employer_name'  => $request->employer_name
                ];

                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/v1/company_search',
                    [
                        'headers' => $headers,
                        'json'    => $body,
                        'timeout' => 30
                    ]
                );

                $companyData = json_decode($response->getBody(), true);
                $statusCode  = $response->getStatusCode();

            

                if ($statusCode == 200 && ($companyData['result_code'] ?? '') == 101) {

                    if ($user->role_id == 1 && $apiamster) {

                        $this->saveHitCount(
                            $user->id,
                            $api_id,
                            'Transaction Successful',
                            200
                        );

                        DB::table('company_search_vone')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,
                            'client_ref_num'  => $companyData['client_ref_num'] ?? null,
                            'request_id'      => $companyData['request_id'] ?? null,
                            'searched_name'   => $request->employer_name,
                            'result_count'    => $companyData['result']['count'] ?? null,
                            'result_code'     => $companyData['result_code'] ?? null,
                            'status_code'     => $statusCode,
                            'vendor_response' => json_encode($companyData, JSON_UNESCAPED_UNICODE),
                            'created_at'      => now(),
                            'updated_at'      => now()
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'success'    => true,
                        'message'    => 'Company search data fetched successfully',
                        'data'       => $companyData['result'] ?? []
                    ]);
                }

            
                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        102
                    );
                }

                return response()->json([
                    'statusCode' => 102,
                    'message' => 'Failed to fetch company search data'
                ]);

            } catch (BadResponseException $e) {

                $statusCode = $e->getResponse()->getStatusCode();

                if ($statusCode == 500 && $user->role_id == 1 && $apiamster) {
                    $this->update_transaction(
                        $user->id,
                        $api_id,
                        0,
                        'Transaction Failed',
                        $statusCode
                    );
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => 'Failed to fetch company search data'
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }
    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}

 public function storeInstantLog($requestData, $statusCode, $success, $errorType = null, $pdfLink = null)
    {
        InstantReportLog::create([
            'request_data' => $requestData,
            'status_code'  => $statusCode,
            'success'      => $success,
            'error_type'   => $errorType,
            'pdf_link'     => $pdfLink,
        ]);
    }
     public function storeDetailLog($requestData, $statusCode, $success, $errorType = null, $pdfLink = null)
    {
        DetailReportLog::create([
            'request_data' => $requestData,
            'status_code'  => $statusCode,
            'success'      => $success,
            'error_type'   => $errorType,
            'pdf_link'     => $pdfLink,
        ]);
    }
     public function instantReportSearch(Request $request)
    {
        try {

            $rules = [
                'father_name' => 'required|string',
                'searchText'  => 'required|string',
                'searchType'  => 'required|string',
                'address'     => 'required|string',
                'state'       => 'required|string',
                'district'    => 'required|string',

                'mobile'      => 'nullable|digits:10',
                'aadhaar'     => 'nullable|digits:12',
                'pan'         => ['nullable', 'regex:/^[A-Z]{5}[0-9]{4}[A-Z]$/i'],
                'asset'       => 'nullable|string',
                'email'       => 'nullable|email',
                'dob'         => 'nullable|date',
                'party_type'  => 'required|string',
            ];

            $validator = Validator::make($request->all(), $rules);

            if ($validator->fails()) {

                $this->storeInstantLog($request->all(), 102, false, 'UserInputError', null);

                return response()->json([
                    'success'    => false,
                    'statusCode' => 102,
                    'message'    => 'Invalid input',
                    'errors'     => $validator->errors()
                ], 200);
            }

            $response = Http::timeout(20)
                ->asForm()
                ->withHeaders(['userToken' => env('LIBIL_USER_TOKEN')])
                ->post('https://patrol.legitquest.com/api/v1.0/instantReportSearch', $request->all());

            if ($response->failed()) {

                $this->storeInstantLog($request->all(), 502, false, 'UpstreamServiceError', null);

                return response()->json([
                    'success'    => false,
                    'statusCode' => 502,
                    'message'    => 'LIBIL API error',
                ], 200);
            }

            $body = $response->json();

            $pdfLink =
            $body['url']
            ?? $body['pdf_url']
            ?? $body['pdf']
            ?? $body['pdfUrl']
            ?? $body['pdfLink']
            ?? null;


            $this->storeInstantLog($request->all(), 200, true, null, $pdfLink);

            return response()->json([
                'success'    => true,
                'statusCode' => 200,
                'message'    => 'Success',
                'data'       => $response->json(),
            ], 200);

        } catch (\Exception $e) {

            $this->storeInstantLog($request->all(), 500, false, 'ServerError', null);

            return response()->json([
                'success'    => false,
                'statusCode' => 500,
                'message'    => 'Internal server error'
            ], 200);
        }
    }
  public function detailReportSearch(Request $request)
    {
        try {

            $rules = [
                'father_name' => 'required|string',
                'searchText'  => 'required|string',
                'searchType'  => 'required|string',
                'address'     => 'required|string',
                'state'       => 'required|string',
                'district'    => 'required|string',

                'mobile'      => 'nullable|digits:10',
                'aadhaar'     => 'nullable|digits:12',
                'pan'         => ['nullable', 'regex:/^[A-Z]{5}[0-9]{4}[A-Z]$/i'],
                'asset'       => 'nullable|string',
                'email'       => 'nullable|email',
                'dob'         => 'nullable|date',
                'party_type'  => 'required|string',
            ];

            $validator = Validator::make($request->all(), $rules);

            if ($validator->fails()) {

                $this->storeDetailLog($request->all(), 102, false, 'UserInputError', null);

                return response()->json([
                    'success'    => false,
                    'statusCode' => 102,
                    'message'    => 'Invalid input',
                    'errors'     => $validator->errors()
                ], 200);
            }

            $response = Http::timeout(20)
                ->asForm()
                ->withHeaders(['userToken' => env('LIBIL_USER_TOKEN')])
                ->post('https://patrol.legitquest.com/api/v1.0/detailReportSearch', $request->all());

            if ($response->failed()) {

                $this->storeDetailLog($request->all(), 502, false, 'UpstreamServiceError', null);

                return response()->json([
                    'success'    => false,
                    'statusCode' => 502,
                    'message'    => 'LIBIL API error',
                ], 200);
            }

            $body = $response->json();

            $pdfLink =
            $body['url']
            ?? $body['pdf_url']
            ?? $body['pdf']
            ?? $body['pdfUrl']
            ?? $body['pdfLink']
            ?? null;


            $this->storeDetailLog($request->all(), 200, true, null, $pdfLink);

            return response()->json([
                'success'    => true,
                'statusCode' => 200,
                'message'    => 'Success',
                'data'       => $response->json(),
            ], 200);

        } catch (BadResponseException $e) {

            $this->storeDetailLog($request->all(), 500, false, 'ServerError', null);

            return response()->json([
                'success'    => false,
                'statusCode' => 500,
                'message'    => 'Internal server error'
            ], 200);
        }
    }
   public function gstin_pan_search(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

   

    if (empty($request->pan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'PAN is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }


    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'gstpansearch')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => $request->client_ref_num ?? uniqid('ref_'),
        'pan'            => $request->pan
    ];

   

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

               

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/gstpansearch',
                    [
                        'headers' => $headers,
                        'json'    => $body
                    ]
                );

                $gstData = json_decode($response->getBody(), true);
                $httpResponseCode = $gstData['http_response_code'] ?? $response->getStatusCode();

                

                if (
                    $httpResponseCode == 200 &&
                    ($gstData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('gst_pan_search_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'pan'                => $request->pan,
                            'gst_count'          => $gstData['result']['count'] ?? null,

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $gstData['result_code'] ?? null,
                            'request_id'         => $gstData['request_id'] ?? null,
                            'client_ref_num'     => $gstData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($gstData),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($gstData, 200);
                }

               

                $statusCode = 102;
                $errorMessage = $gstData['message'] ?? 'GST PAN search failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('gst_pan_search_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => $request->pan,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($gstData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'GST PAN search failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('gst_pan_search_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'pan'             => $request->pan,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function bankPassbookOcr(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

  

    if (!$request->hasFile('file')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'file is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }



    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'bspbocr')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

 

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

        

                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'https://svcdemo.digitap.work/ocr/v1/bspb',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_HTTPHEADER => [
                        'Authorization: Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                       
                    ],
                    CURLOPT_POSTFIELDS => [
                        'imageUrl' => new \CURLFile(
                            $_FILES['file']['tmp_name'],
                            $_FILES['file']['type'],
                            $_FILES['file']['name']
                        ),
                        'clientRefId' => $request->client_ref_id ?? 'test',
                        'accountHolderName' => $request->account_holder_name ?? 'abc'
                    ],
                ]);

                $response = curl_exec($curl);
                curl_close($curl);

                $bspb = json_decode($response, true);

                if (
                    isset($bspb['status']) &&
                    $bspb['status'] === 'success' &&
                    isset($bspb['result'][0]['details'])
                ) {

                    $d = $bspb['result'][0]['details'];

                    $ifsc   = $d['ifsc_code']['value'] ?? null;
                    $accNo  = $d['account_number']['value'] ?? null;
                    $name   = $d['name']['value'] ?? null;
                    $match  = $d['name_match']['value'] ?? null;

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);
                        DB::table('bank_passbook_verification')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'ifsc_code'       => $ifsc,
                        'account_number'  => $accNo,
                        'name'            => $name,
                        'name_match'      => $match,
                        'client_ref_id'   => $bspb['clientRefId'] ?? null,
                        'request_id'      => $bspb['ocrReqId'] ?? null,
                        'vendor_response' => json_encode($bspb),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                    }

                    

                    return response()->json([
                        'statusCode' => 200,
                        'result' => [
                            'ifsc_code' => $ifsc,
                            'account_number' => $accNo,
                            'name' => $name,
                            'name_match' => $match
                        ]
                    ]);
                }

            } catch (\BadResponseException $e) {

    $statusCode = 500;
    $errorMessage = 'Bank passbook OCR failed';

    $curlError = curl_error($curl) ?? null;
    $curlErrno = curl_errno($curl) ?? null;

    if ($user->role_id == 1 && $apiamster) {
        $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

        DB::table('bank_passbook_verification')->insert([
            'user_id'         => $user->id,
            'api_id'          => $api_id,

            'curl_error'      => $curlError,
            'curl_errno'      => $curlErrno,

            'vendor_response' => isset($bspb) ? json_encode($bspb) : null,
            'created_at'      => now(),
            'updated_at'      => now(),
        ]);
    }

    return response()->json([
        'statusCode' => $statusCode,
        'message'    => $errorMessage
    ]);
}



            $statusCode = 500;
            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';

            if ($user->role_id == 1 && $apiamster) {
                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
            }

            DB::table('bank_passbook_verification')->insert([
                'user_id' => $user->id,
                'api_id'  => $api_id,
                'created_at' => now(),
                'updated_at' => now(),
            ]);

            return response()->json([
                'statusCode' => $statusCode,
                'message' => $errorMessage
            ]);

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function mobile_to_udyam(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    

    if (empty($request->mobile)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Mobile number is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'mobiletoudyam')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    
    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'client_ref_num' => $request->client_ref_num ?? uniqid('mobile_udyam_'),
        'mobile'         => $request->mobile
    ];

   

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/validation/kyb/v1/mobile_to_udyam',
                    [
                        'headers' => $headers,
                        'json'    => $body
                    ]
                );

                $udyamData = json_decode($response->getBody(), true);
                $httpResponseCode = $udyamData['http_response_code'] ?? $response->getStatusCode();

                if (
                    $httpResponseCode == 200 &&
                    ($udyamData['result_code'] ?? 0) == 101
                ) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('mobile_udyam_logs')->insert([
                            'user_id'            => $user->id,
                            'api_id'             => $api_id,

                            'mobile'             => $request->mobile,
                            'udyam_count'        => count($udyamData['result'] ?? []),

                            'http_response_code' => $httpResponseCode,
                            'result_code'        => $udyamData['result_code'] ?? null,
                            'request_id'         => $udyamData['request_id'] ?? null,
                            'client_ref_num'     => $udyamData['client_ref_num'] ?? null,

                            'vendor_response'    => json_encode($udyamData),
                            'created_at'         => now(),
                            'updated_at'         => now(),
                        ]);
                    }

                    return response()->json($udyamData, 200);
                }

               

                $statusCode = 102;
                $errorMessage = $udyamData['message'] ?? 'Mobile to UDYAM lookup failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('mobile_udyam_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'mobile'          => $request->mobile,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($udyamData),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);

            } catch (\Exception $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'Mobile to UDYAM lookup failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('mobile_udyam_logs')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'mobile'          => $request->mobile,
                        'result_code'     => $statusCode,
                        'message'         => $errorMessage,
                        'vendor_response' => json_encode($errorResponse),
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message'    => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function uan_passbook_get_otp(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    if (empty($request->uan)) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'UAN is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'uangetotp')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    $client = new Client();

    $headers = [
        'Content-Type'  => 'application/json',
        'Accept'        => 'application/json',
        'Authorization' => 'Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
    ];

    $body = [
        'uan'            => $request->uan,
        'client_ref_num' => $request->client_ref_num ?? uniqid('uan_otp_')
    ];

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $response = $client->post(
                    'https://svcdemo.digitap.work/cv/uan_passbook/get_otp',
                    [
                        'headers' => $headers,
                        'json'    => $body
                    ]
                );

                $otpData = json_decode($response->getBody(), true);
                $httpResponseCode = $otpData['http_response_code'] ?? $response->getStatusCode();

                if ($httpResponseCode == 200 && ($otpData['result_code'] ?? 0) == 101) {

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'OTP Sent Successfully', 200);
                    }

                    DB::table('uan_passbook_otp_logs')->insert([
                        'user_id'            => $user->id,
                        'api_id'             => $api_id,
                        'uan'                => $request->uan,
                        'otp'                => $request->otp,
                        'txn_id'             => $otpData['txn_id'] ?? null,
                        'http_response_code' => $httpResponseCode,
                        'result_code'        => $otpData['result_code'] ?? null,
                        'client_ref_num'     => $otpData['client_ref_num'] ?? null,
                        'message'            => $otpData['message'] ?? null,
                        'vendor_response'    => json_encode($otpData),
                        'created_at'         => now(),
                        'updated_at'         => now(),
                    ]);

                    return response()->json($otpData, 200);
                }

                $statusCode = 102;
                $errorMessage = $otpData['message'] ?? 'OTP request failed';

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);

            } catch (BadResponseException $e) {

                $errorResponse = json_decode($e->getResponse()->getBody(), true);
                $statusCode = $e->getResponse()->getStatusCode();
                $errorMessage = $errorResponse['message'] ?? 'OTP request failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
                }

                
                DB::table('uan_passbook_otp_logs')->insert([
                    'user_id'         => $user->id,
                    'api_id'          => $api_id,
                    'uan'             => $request->uan,
                    'result_code'     => $statusCode,
                    'message'         => $errorMessage,
                    'vendor_response' => json_encode($errorResponse),
                    'created_at'      => now(),
                    'updated_at'      => now(),
                ]);

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);
            }

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}
public function chequeOcr(Request $request)
{
    $statusCode = null;
    $api_id = null;
    $apiamster = null;

    

    if (!$request->hasFile('file')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'file is required'
        ]);
    }

    if (!$request->headers->has('AccessToken')) {
        return response()->json([
            'statusCode' => 404,
            'message' => 'Header Access Token is required'
        ]);
    }

    if ($this->verifyAccessToken($request->header('AccessToken')) == false) {
        return response()->json([
            'statusCode' => 403,
            'message' => 'Wrong Access Token'
        ]);
    }

    $user = User::where('access_token', $request->header('AccessToken'))->first();

    if ($user->role_id == 1) {
        $apiamster = ApiMaster::where('api_slug', 'chequeocr')->first();
        if ($apiamster) {
            $api_id = $apiamster->id;
        }
    }

    

    $updateHitCount = UserSchemeMaster::where('user_id', $user->id)
        ->where('api_id', $api_id)
        ->orderBy('id', 'desc')
        ->first();

    if ($updateHitCount || $user->role_id == 0) {

        if (
            ($user->wallet_amount > 0 && $user->role_id == 1) ||
            $user->role_id == 0 ||
            $user->type == "role_postpaid"
        ) {

            try {

                $curl = curl_init();
                curl_setopt_array($curl, [
                    CURLOPT_URL => 'https://svcdemo.digitap.work/ocr/v1/cheque',
                    CURLOPT_RETURNTRANSFER => true,
                    CURLOPT_CUSTOMREQUEST => 'POST',
                    CURLOPT_HTTPHEADER => [
                        'Authorization: Basic Mzk1MTY2MjY6N09KNFc1MTFsdjFXNko0MFVXZVFBYzVSUHhNdXE1YnA='
                    ],
                    CURLOPT_POSTFIELDS => [
                        'imageUrl' => new \CURLFile(
                            $_FILES['file']['tmp_name'],
                            $_FILES['file']['type'],
                            $_FILES['file']['name']
                        ),
                        'clientRefId' => $request->client_ref_id ?? 'test',
                        'accountHolderName' => $request->account_holder_name ?? 'abc',
                        'isCompleteImage' => $request->is_complete_image ?? 'yes'
                    ],
                ]);

                $response = curl_exec($curl);
                curl_close($curl);

                $cheque = json_decode($response, true);

                if (
                    isset($cheque['status']) &&
                    $cheque['status'] === 'success' &&
                    isset($cheque['result'][0]['details'])
                ) {

                    $d = $cheque['result'][0]['details'];

                    $accNo   = $d['account_number']['value'] ?? null;
                    $ifsc    = $d['ifsc_code']['value'] ?? null;
                    $micr    = $d['micr_code']['value'] ?? null;
                    $chqNo   = $d['cheque_number']['value'] ?? null;
                    $bank    = $d['bank_name']['value'] ?? null;
                    $name    = $d['name']['value'] ?? null;

                    if ($user->role_id == 1 && $apiamster) {
                        $this->saveHitCount($user->id, $api_id, 'Transaction Successful', 200);

                        DB::table('cheque_ocr_verification')->insert([
                            'user_id'         => $user->id,
                            'api_id'          => $api_id,

                            'account_number'  => $accNo,
                            'ifsc_code'       => $ifsc,
                            'micr_code'       => $micr,
                            'cheque_number'   => $chqNo,
                            'bank_name'       => $bank,
                            'account_name'    => $name,

                            'client_ref_id'   => $cheque['clientRefId'] ?? null,
                            'request_id'      => $cheque['ocrReqId'] ?? null,
                            'vendor_response' => json_encode($cheque),

                            'created_at'      => now(),
                            'updated_at'      => now(),
                        ]);
                    }

                    return response()->json([
                        'statusCode' => 200,
                        'result' => [
                            'account_number' => $accNo,
                            'ifsc_code' => $ifsc,
                            'micr_code' => $micr,
                            'cheque_number' => $chqNo,
                            'bank_name' => $bank,
                            'account_name' => $name
                        ]
                    ]);
                }

            } catch (\Exception $e) {

                $statusCode = 500;
                $errorMessage = 'Cheque OCR failed';

                if ($user->role_id == 1 && $apiamster) {
                    $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);

                    DB::table('cheque_ocr_verification')->insert([
                        'user_id'         => $user->id,
                        'api_id'          => $api_id,
                        'vendor_response' => isset($cheque) ? json_encode($cheque) : null,
                        'created_at'      => now(),
                        'updated_at'      => now(),
                    ]);
                }

                return response()->json([
                    'statusCode' => $statusCode,
                    'message' => $errorMessage
                ]);
            }

           

            $statusCode = 500;
            $errorMessage = 'Error. Please contact techsupport@docboyz.in. for more details';

            if ($user->role_id == 1 && $apiamster) {
                $this->update_transaction($user->id, $api_id, 0, 'Transaction Failed', $statusCode);
            }

            DB::table('cheque_ocr_verification')->insert([
                'user_id' => $user->id,
                'api_id'  => $api_id,
                'created_at' => now(),
                'updated_at' => now(),
            ]);

            return response()->json([
                'statusCode' => $statusCode,
                'message' => $errorMessage
            ]);

        } else {
            return response()->json([
                'statusCode' => 500,
                'message' => 'Please recharge your wallet.'
            ]);
        }

    } else {
        return response()->json([
            'statusCode' => 103,
            'message' => 'You are not registered to use this service. Please update your plan.'
        ]);
    }
}


}


